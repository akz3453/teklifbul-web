<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Loading Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .info-box { background: #e3f2fd; padding: 15px; border-radius: 4px; margin: 10px 0; }
    .error-box { background: #ffebee; padding: 15px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #f44336; }
    .success-box { background: #e8f5e9; padding: 15px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #4caf50; }
    .warning-box { background: #fff3e0; padding: 15px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #ff9800; }
    button { background: #2196f3; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin: 5px; }
    button:hover { background: #1976d2; }
    button:disabled { background: #bbdefb; cursor: not-allowed; }
    pre { background: #f1f1f1; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 300px; }
    .test-section { border: 1px solid #e0e0e0; border-radius: 4px; padding: 15px; margin: 15px 0; }
    .test-result { margin-top: 10px; padding: 10px; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š Veri YÃ¼kleme Testi</h1>
    <p>Bu sayfa sistemdeki veri yÃ¼kleme iÅŸlemlerini test etmek iÃ§in oluÅŸturulmuÅŸtur.</p>
    
    <div class="test-section">
      <h3>1. Auth ve KullanÄ±cÄ± Testi</h3>
      <button id="test-auth">Auth Durumunu Test Et</button>
      <div id="auth-result" class="test-result"></div>
    </div>
    
    <div class="test-section">
      <h3>2. Talep Verileri Testi</h3>
      <button id="test-demands">Talep Verilerini Test Et</button>
      <div id="demands-result" class="test-result"></div>
    </div>
    
    <div class="test-section">
      <h3>3. Åirket Verileri Testi</h3>
      <button id="test-company">Åirket Verilerini Test Et</button>
      <div id="company-result" class="test-result"></div>
    </div>
    
    <div class="test-section">
      <h3>4. Kategori EÅŸleÅŸtirme Testi</h3>
      <button id="test-categories">Kategori EÅŸleÅŸtirmesini Test Et</button>
      <div id="categories-result" class="test-result"></div>
    </div>
    
    <div class="test-section">
      <h3>5. TÃ¼m Testleri Ã‡alÄ±ÅŸtÄ±r</h3>
      <button id="test-all">TÃ¼m Testleri Ã‡alÄ±ÅŸtÄ±r</button>
      <button id="clear-results">SonuÃ§larÄ± Temizle</button>
    </div>
    
    <div style="margin-top: 20px;">
      <h3>DetaylÄ± Loglar</h3>
      <pre id="logs"></pre>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './firebase.js';
    import { 
      doc, 
      getDoc, 
      collection, 
      getDocs, 
      query, 
      where, 
      orderBy, 
      limit 
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    
    const logElement = document.getElementById('logs');
    
    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      logElement.textContent += `[${timestamp}] ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
      console.log(message);
    }
    
    function showResult(elementId, content, type = 'info') {
      const element = document.getElementById(elementId);
      const boxClass = type === 'success' ? 'success-box' : 
                      type === 'error' ? 'error-box' : 
                      type === 'warning' ? 'warning-box' : 'info-box';
      element.innerHTML = `<div class="${boxClass}">${content}</div>`;
    }
    
    async function testAuth() {
      log("=== Auth testi baÅŸlatÄ±lÄ±yor ===");
      const button = document.getElementById('test-auth');
      button.disabled = true;
      
      try {
        if (auth.currentUser) {
          showResult('auth-result', `
            <strong>âœ… Auth Durumu: BaÅŸarÄ±lÄ±</strong><br>
            KullanÄ±cÄ± ID: ${auth.currentUser.uid}<br>
            Email: ${auth.currentUser.email || 'BelirtilmemiÅŸ'}<br>
          `, 'success');
          log("Auth testi baÅŸarÄ±lÄ±: " + auth.currentUser.uid);
        } else {
          showResult('auth-result', `
            <strong>âŒ Auth Durumu: BaÅŸarÄ±sÄ±z</strong><br>
            KullanÄ±cÄ± oturumu aÃ§Ä±k deÄŸil. LÃ¼tfen giriÅŸ yapÄ±n.
          `, 'error');
          log("Auth testi baÅŸarÄ±sÄ±z: KullanÄ±cÄ± oturumu kapalÄ±");
        }
      } catch (error) {
        showResult('auth-result', `
          <strong>âŒ Auth Testi HatasÄ±</strong><br>
          Hata: ${error.message}
        `, 'error');
        log("Auth testi hatasÄ±: " + error.message);
      } finally {
        button.disabled = false;
      }
    }
    
    async function testDemands() {
      log("=== Talep verileri testi baÅŸlatÄ±lÄ±yor ===");
      const button = document.getElementById('test-demands');
      button.disabled = true;
      
      try {
        if (!auth.currentUser) {
          showResult('demands-result', `
            <strong>âŒ Talep Testi BaÅŸarÄ±sÄ±z</strong><br>
            KullanÄ±cÄ± oturumu aÃ§Ä±k deÄŸil. Ã–nce giriÅŸ yapmalÄ±sÄ±nÄ±z.
          `, 'error');
          log("Talep testi baÅŸarÄ±sÄ±z: KullanÄ±cÄ± oturumu kapalÄ±");
          button.disabled = false;
          return;
        }
        
        showResult('demands-result', 'Talep verileri yÃ¼kleniyor...', 'info');
        
        // KullanÄ±cÄ± bilgilerini al
        const userDoc = await getDoc(doc(db, 'users', auth.currentUser.uid));
        const userData = userDoc.exists() ? userDoc.data() : {};
        const userCompanyId = userData.companyId;
        
        if (!userCompanyId) {
          showResult('demands-result', `
            <strong>âš ï¸ UyarÄ±</strong><br>
            KullanÄ±cÄ±ya ÅŸirket atanmamÄ±ÅŸ. Talep verileri ÅŸirket bazÄ±nda filtrelendiÄŸi iÃ§in sonuÃ§ bulunmayabilir.
          `, 'warning');
          log("Talep testi uyarÄ±sÄ±: KullanÄ±cÄ±ya ÅŸirket atanmamÄ±ÅŸ");
        }
        
        // TedarikÃ§i kategorilerini al
        const supplierCategories = Array.isArray(userData.supplierCategoryKeys) 
          ? userData.supplierCategoryKeys 
          : Array.isArray(userData.supplierCategories) 
          ? userData.supplierCategories 
          : [];
        
        // Gelen talepleri test et (published ve kategori eÅŸleÅŸmesi olanlar)
        try {
          let incomingQuery;
          if (supplierCategories.length > 0) {
            incomingQuery = query(
              collection(db, 'demands'),
              where('isPublished', '==', true),
              where('supplierCategoryKeys', 'array-contains-any', supplierCategories.slice(0, 10)),
              orderBy('createdAt', 'desc'),
              limit(5)
            );
          } else {
            // Kategori yoksa sadece published olanlarÄ± getir
            incomingQuery = query(
              collection(db, 'demands'),
              where('isPublished', '==', true),
              orderBy('createdAt', 'desc'),
              limit(5)
            );
          }
          
          const incomingSnapshot = await getDocs(incomingQuery);
          log(`Gelen talepler sorgusu: ${incomingSnapshot.docs.length} kayÄ±t bulundu`);
          
          // Giden talepleri test et (kendi ÅŸirketinin oluÅŸturduÄŸu published talepler)
          let outgoingQuery;
          if (userCompanyId) {
            outgoingQuery = query(
              collection(db, 'demands'),
              where('creatorCompanyId', '==', userCompanyId),
              where('isPublished', '==', true),
              orderBy('createdAt', 'desc'),
              limit(5)
            );
          } else {
            outgoingQuery = query(
              collection(db, 'demands'),
              where('createdBy', '==', auth.currentUser.uid),
              where('isPublished', '==', true),
              orderBy('createdAt', 'desc'),
              limit(5)
            );
          }
          
          const outgoingSnapshot = await getDocs(outgoingQuery);
          log(`Giden talepler sorgusu: ${outgoingSnapshot.docs.length} kayÄ±t bulundu`);
          
          // Taslak talepleri test et
          let draftQuery;
          if (userCompanyId) {
            draftQuery = query(
              collection(db, 'demands'),
              where('creatorCompanyId', '==', userCompanyId),
              where('status', 'in', ['draft', 'withdrawn']),
              orderBy('updatedAt', 'desc'),
              limit(5)
            );
          } else {
            draftQuery = query(
              collection(db, 'demands'),
              where('createdBy', '==', auth.currentUser.uid),
              where('status', 'in', ['draft', 'withdrawn']),
              orderBy('updatedAt', 'desc'),
              limit(5)
            );
          }
          
          const draftSnapshot = await getDocs(draftQuery);
          log(`Taslak talepler sorgusu: ${draftSnapshot.docs.length} kayÄ±t bulundu`);
          
          showResult('demands-result', `
            <strong>âœ… Talep Verileri Testi BaÅŸarÄ±lÄ±</strong><br>
            Gelen talepler: ${incomingSnapshot.docs.length} kayÄ±t<br>
            Giden talepler: ${outgoingSnapshot.docs.length} kayÄ±t<br>
            Taslak talepler: ${draftSnapshot.docs.length} kayÄ±t<br>
            ${supplierCategories.length > 0 ? `TedarikÃ§i kategorileri: ${supplierCategories.length} adet` : 'TedarikÃ§i kategorisi atanmamÄ±ÅŸ'}
          `, 'success');
          
          log("Talep verileri testi baÅŸarÄ±lÄ±");
        } catch (queryError) {
          if (queryError.message.includes('Missing or insufficient permissions')) {
            showResult('demands-result', `
              <strong>âŒ Yetki HatasÄ±</strong><br>
              Firestore gÃ¼venlik kurallarÄ± nedeniyle talep verilerine eriÅŸim reddedildi.<br>
              Hata: ${queryError.message}
            `, 'error');
            log("Talep verileri yetki hatasÄ±: " + queryError.message);
          } else {
            showResult('demands-result', `
              <strong>âŒ Talep Verileri HatasÄ±</strong><br>
              Hata: ${queryError.message}
            `, 'error');
            log("Talep verileri hatasÄ±: " + queryError.message);
          }
        }
      } catch (error) {
        showResult('demands-result', `
          <strong>âŒ Talep Testi HatasÄ±</strong><br>
          Hata: ${error.message}
        `, 'error');
        log("Talep testi genel hatasÄ±: " + error.message);
      } finally {
        button.disabled = false;
      }
    }
    
    async function testCompany() {
      log("=== Åirket verileri testi baÅŸlatÄ±lÄ±yor ===");
      const button = document.getElementById('test-company');
      button.disabled = true;
      
      try {
        if (!auth.currentUser) {
          showResult('company-result', `
            <strong>âŒ Åirket Testi BaÅŸarÄ±sÄ±z</strong><br>
            KullanÄ±cÄ± oturumu aÃ§Ä±k deÄŸil. Ã–nce giriÅŸ yapmalÄ±sÄ±nÄ±z.
          `, 'error');
          log("Åirket testi baÅŸarÄ±sÄ±z: KullanÄ±cÄ± oturumu kapalÄ±");
          button.disabled = false;
          return;
        }
        
        // KullanÄ±cÄ± bilgilerini al
        const userDoc = await getDoc(doc(db, 'users', auth.currentUser.uid));
        const userData = userDoc.exists() ? userDoc.data() : {};
        const userCompanyId = userData.companyId;
        
        if (!userCompanyId) {
          showResult('company-result', `
            <strong>âš ï¸ UyarÄ±</strong><br>
            KullanÄ±cÄ±ya ÅŸirket atanmamÄ±ÅŸ. Åirket ID: BelirtilmemiÅŸ
          `, 'warning');
          log("Åirket testi uyarÄ±sÄ±: KullanÄ±cÄ±ya ÅŸirket atanmamÄ±ÅŸ");
          button.disabled = false;
          return;
        }
        
        // Åirket bilgilerini al
        const companyDoc = await getDoc(doc(db, 'companies', userCompanyId));
        if (companyDoc.exists()) {
          const companyData = companyDoc.data();
          showResult('company-result', `
            <strong>âœ… Åirket Verileri Testi BaÅŸarÄ±lÄ±</strong><br>
            Åirket ID: ${userCompanyId}<br>
            Åirket AdÄ±: ${companyData.name || 'BelirtilmemiÅŸ'}<br>
            Vergi No: ${companyData.taxNumber || 'BelirtilmemiÅŸ'}<br>
            Ä°lÃ§e: ${companyData.district || 'BelirtilmemiÅŸ'}
          `, 'success');
          log("Åirket verileri testi baÅŸarÄ±lÄ±");
        } else {
          showResult('company-result', `
            <strong>âŒ Åirket BulunamadÄ±</strong><br>
            Åirket ID: ${userCompanyId}<br>
            VeritabanÄ±nda bu ID ile ÅŸirket kaydÄ± bulunamadÄ±.
          `, 'error');
          log("Åirket testi baÅŸarÄ±sÄ±z: Åirket bulunamadÄ±");
        }
      } catch (error) {
        showResult('company-result', `
          <strong>âŒ Åirket Testi HatasÄ±</strong><br>
          Hata: ${error.message}
        `, 'error');
        log("Åirket testi hatasÄ±: " + error.message);
      } finally {
        button.disabled = false;
      }
    }
    
    async function testCategories() {
      log("=== Kategori eÅŸleÅŸtirme testi baÅŸlatÄ±lÄ±yor ===");
      const button = document.getElementById('test-categories');
      button.disabled = true;
      
      try {
        if (!auth.currentUser) {
          showResult('categories-result', `
            <strong>âŒ Kategori Testi BaÅŸarÄ±sÄ±z</strong><br>
            KullanÄ±cÄ± oturumu aÃ§Ä±k deÄŸil. Ã–nce giriÅŸ yapmalÄ±sÄ±nÄ±z.
          `, 'error');
          log("Kategori testi baÅŸarÄ±sÄ±z: KullanÄ±cÄ± oturumu kapalÄ±");
          button.disabled = false;
          return;
        }
        
        // KullanÄ±cÄ± bilgilerini al
        const userDoc = await getDoc(doc(db, 'users', auth.currentUser.uid));
        const userData = userDoc.exists() ? userDoc.data() : {};
        
        // TedarikÃ§i kategorilerini kontrol et
        const supplierCategoryKeys = Array.isArray(userData.supplierCategoryKeys) 
          ? userData.supplierCategoryKeys 
          : [];
          
        const supplierCategories = Array.isArray(userData.supplierCategories) 
          ? userData.supplierCategories 
          : [];
        
        if (supplierCategoryKeys.length > 0) {
          showResult('categories-result', `
            <strong>âœ… Kategori EÅŸleÅŸtirme Testi BaÅŸarÄ±lÄ±</strong><br>
            supplierCategoryKeys alanÄ± dolu: ${supplierCategoryKeys.length} kategori<br>
            Kategoriler: ${supplierCategoryKeys.slice(0, 5).join(', ')}${supplierCategoryKeys.length > 5 ? '...' : ''}
          `, 'success');
          log(`Kategori eÅŸleÅŸtirme testi baÅŸarÄ±lÄ±: ${supplierCategoryKeys.length} kategori`);
        } else if (supplierCategories.length > 0) {
          showResult('categories-result', `
            <strong>âœ… Kategori EÅŸleÅŸtirme Testi BaÅŸarÄ±lÄ±</strong><br>
            supplierCategories alanÄ± dolu: ${supplierCategories.length} kategori<br>
            Kategoriler: ${supplierCategories.slice(0, 5).join(', ')}${supplierCategories.length > 5 ? '...' : ''}
          `, 'success');
          log(`Kategori eÅŸleÅŸtirme testi baÅŸarÄ±lÄ±: ${supplierCategories.length} kategori`);
        } else {
          showResult('categories-result', `
            <strong>âš ï¸ UyarÄ±</strong><br>
            KullanÄ±cÄ±ya tedarikÃ§i kategorisi atanmamÄ±ÅŸ.<br>
            Gelen talepler bu kategorilere gÃ¶re filtrelendiÄŸi iÃ§in talep gÃ¶remeyebilirsiniz.<br>
            LÃ¼tfen Ayarlar sayfasÄ±ndan tedarikÃ§i kategorilerinizi seÃ§in.
          `, 'warning');
          log("Kategori eÅŸleÅŸtirme testi uyarÄ±sÄ±: Kategori atanmamÄ±ÅŸ");
        }
      } catch (error) {
        showResult('categories-result', `
          <strong>âŒ Kategori Testi HatasÄ±</strong><br>
          Hata: ${error.message}
        `, 'error');
        log("Kategori testi hatasÄ±: " + error.message);
      } finally {
        button.disabled = false;
      }
    }
    
    async function runAllTests() {
      log("=== TÃ¼m testler baÅŸlatÄ±lÄ±yor ===");
      const button = document.getElementById('test-all');
      button.disabled = true;
      
      try {
        await testAuth();
        await testDemands();
        await testCompany();
        await testCategories();
        log("=== TÃ¼m testler tamamlandÄ± ===");
      } catch (error) {
        log("TÃ¼m testler sÄ±rasÄ±nda hata: " + error.message);
      } finally {
        button.disabled = false;
      }
    }
    
    function clearResults() {
      document.getElementById('auth-result').innerHTML = '';
      document.getElementById('demands-result').innerHTML = '';
      document.getElementById('company-result').innerHTML = '';
      document.getElementById('categories-result').innerHTML = '';
      logElement.textContent = '';
    }
    
    // Event listeners
    document.getElementById('test-auth').addEventListener('click', testAuth);
    document.getElementById('test-demands').addEventListener('click', testDemands);
    document.getElementById('test-company').addEventListener('click', testCompany);
    document.getElementById('test-categories').addEventListener('click', testCategories);
    document.getElementById('test-all').addEventListener('click', runAllTests);
    document.getElementById('clear-results').addEventListener('click', clearResults);
    
    // Sayfa yÃ¼klendiÄŸinde auth durumunu kontrol et
    document.addEventListener('DOMContentLoaded', () => {
      if (auth.currentUser) {
        showResult('auth-result', `
          <strong>âœ… Auth Durumu: BaÅŸarÄ±lÄ±</strong><br>
          KullanÄ±cÄ± oturumu aÃ§Ä±k.<br>
          HazÄ±r testler Ã§alÄ±ÅŸtÄ±rÄ±labilir.
        `, 'success');
      } else {
        showResult('auth-result', `
          <strong>âš ï¸ Auth Durumu: Oturum KapalÄ±</strong><br>
          KullanÄ±cÄ± oturumu kapalÄ±. LÃ¼tfen giriÅŸ yapÄ±n.<br>
          BazÄ± testler Ã§alÄ±ÅŸmayabilir.
        `, 'warning');
      }
    });
  </script>
</body>
</html>