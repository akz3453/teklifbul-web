<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kategori Eşleştirme Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .category-list { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .category-item { padding: 4px 8px; background: #e9ecef; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>
    <h1>🔍 Kategori Eşleştirme Debug</h1>
    
    <div class="debug-section info">
        <h3>📋 Debug Senaryosu</h3>
        <p>Bu sayfa kategori eşleştirmelerini test eder.</p>
        <ol>
            <li>Talep oluştururkenki kategorileri kontrol et</li>
            <li>Üyelik oluştururkenki kategorileri kontrol et</li>
            <li>Kategori eşleştirme mantığını test et</li>
            <li>publishDemandAndMatchSuppliers fonksiyonunu test et</li>
        </ol>
    </div>
    
    <div class="debug-section">
        <h3>🧪 Debug Butonları</h3>
        <button onclick="debugCategories()">Kategorileri Karşılaştır</button>
        <button onclick="debugUserCategories()">Kullanıcı Kategorilerini Kontrol Et</button>
        <button onclick="debugDemandCategories()">Talep Kategorilerini Kontrol Et</button>
        <button onclick="debugMatchingLogic()">Eşleştirme Mantığını Test Et</button>
    </div>
    
    <div id="debug-results"></div>
    
    <script type="module">
        import { db, auth, requireAuth } from "./firebase.js";
        import { CATEGORIES } from "./categories.js";
        import {
          collection, getDocs, query, where, orderBy, limit, doc, getDoc
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        
        let currentUser = null;
        
        // Talep oluştururkenki varsayılan kategoriler
        const demandDefaultGroups = [
          { name: "İnşaat Malzemeleri", categories: ["İnşaat Malzemeleri", "Hırdavat", "Boya"] },
          { name: "Elektrik", categories: ["Elektrik", "Elektronik"] },
          { name: "Makine-İmalat", categories: ["Makine-İmalat", "Sac/Metal", "Otomotiv Yan Sanayi"] },
          { name: "Diğer", categories: ["Ambalaj", "Kimyasal", "Mobilya", "Plastik", "İş Güvenliği", "Temizlik", "Gıda", "Hizmet", "Lojistik"] }
        ];
        
        async function init() {
            try {
                currentUser = await requireAuth();
                console.log('User authenticated:', currentUser.email);
                addResult(`✅ Kullanıcı girişi başarılı: ${currentUser.email}`, 'success');
            } catch (error) {
                console.error('Auth error:', error);
                addResult('❌ Kullanıcı girişi başarısız: ' + error.message, 'error');
            }
        }
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `debug-section ${type}`;
            div.innerHTML = message;
            document.getElementById('debug-results').appendChild(div);
        }
        
        function clearResults() {
            document.getElementById('debug-results').innerHTML = '';
        }
        
        function debugCategories() {
            clearResults();
            addResult('<h3>🔍 Kategori Karşılaştırması</h3>', 'info');
            
            // categories.js'den gelen kategoriler
            addResult(`
                <h4>📋 categories.js Kategorileri (${CATEGORIES.length} adet)</h4>
                <div class="category-list">
                    ${CATEGORIES.map(cat => `<span class="category-item">${cat}</span>`).join('')}
                </div>
            `, 'info');
            
            // Talep oluştururkenki varsayılan kategoriler
            const demandCategories = demandDefaultGroups.flatMap(group => group.categories);
            addResult(`
                <h4>📋 Talep Oluştururkenki Varsayılan Kategoriler (${demandCategories.length} adet)</h4>
                <div class="category-list">
                    ${demandCategories.map(cat => `<span class="category-item">${cat}</span>`).join('')}
                </div>
            `, 'info');
            
            // Eşleşmeyen kategorileri bul
            const unmatchedDemand = demandCategories.filter(cat => !CATEGORIES.includes(cat));
            const unmatchedCategories = CATEGORIES.filter(cat => !demandCategories.includes(cat));
            
            if (unmatchedDemand.length > 0) {
                addResult(`
                    <h4>❌ Talep kategorilerinde eşleşmeyenler</h4>
                    <div class="category-list">
                        ${unmatchedDemand.map(cat => `<span class="category-item" style="background: #f8d7da;">${cat}</span>`).join('')}
                    </div>
                `, 'error');
            }
            
            if (unmatchedCategories.length > 0) {
                addResult(`
                    <h4>⚠️ categories.js'de olan ama talep kategorilerinde olmayanlar</h4>
                    <div class="category-list">
                        ${unmatchedCategories.map(cat => `<span class="category-item" style="background: #fff3cd;">${cat}</span>`).join('')}
                    </div>
                `, 'warning');
            }
            
            if (unmatchedDemand.length === 0 && unmatchedCategories.length === 0) {
                addResult('✅ Tüm kategoriler eşleşiyor!', 'success');
            }
        }
        
        async function debugUserCategories() {
            clearResults();
            addResult('<h3>🔍 Kullanıcı Kategorileri</h3>', 'info');
            
            if (!currentUser) {
                addResult('❌ Kullanıcı girişi gerekli', 'error');
                return;
            }
            
            try {
                // Kullanıcının kategorilerini al
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (!userDoc.exists()) {
                    addResult('❌ Kullanıcı profili bulunamadı', 'error');
                    return;
                }
                
                const userData = userDoc.data();
                const userCategories = userData.categories || [];
                
                addResult(`
                    <h4>👤 Kullanıcı Kategorileri (${userCategories.length} adet)</h4>
                    <div class="category-list">
                        ${userCategories.map(cat => `<span class="category-item">${cat}</span>`).join('')}
                    </div>
                `, 'info');
                
                // Kullanıcının kategorilerinin categories.js'de olup olmadığını kontrol et
                const invalidCategories = userCategories.filter(cat => !CATEGORIES.includes(cat));
                if (invalidCategories.length > 0) {
                    addResult(`
                        <h4>❌ Geçersiz kategoriler</h4>
                        <div class="category-list">
                            ${invalidCategories.map(cat => `<span class="category-item" style="background: #f8d7da;">${cat}</span>`).join('')}
                        </div>
                    `, 'error');
                } else {
                    addResult('✅ Tüm kullanıcı kategorileri geçerli', 'success');
                }
                
            } catch (error) {
                addResult(`❌ Kullanıcı kategorileri yüklenemedi: ${error.message}`, 'error');
            }
        }
        
        async function debugDemandCategories() {
            clearResults();
            addResult('<h3>🔍 Talep Kategorileri</h3>', 'info');
            
            if (!currentUser) {
                addResult('❌ Kullanıcı girişi gerekli', 'error');
                return;
            }
            
            try {
                // Kullanıcının taleplerini al
                const q = query(collection(db, 'demands'), where('createdBy', '==', currentUser.uid), orderBy('createdAt', 'desc'), limit(5));
                const snap = await getDocs(q);
                
                if (snap.empty) {
                    addResult('⚠️ Kullanıcının hiç talebi yok', 'warning');
                    return;
                }
                
                addResult(`📊 Kullanıcının son ${snap.docs.length} talebi:`, 'info');
                
                snap.docs.forEach((doc, index) => {
                    const data = doc.data();
                    const categories = data.categories || [];
                    
                    addResult(`
                        <h4>Talep ${index + 1}: ${data.title || 'Başlıksız'}</h4>
                        <p><strong>Kategoriler:</strong> ${categories.length} adet</p>
                        <div class="category-list">
                            ${categories.map(cat => `<span class="category-item">${cat}</span>`).join('')}
                        </div>
                        <p><strong>Durum:</strong> ${data.published ? 'Yayınlandı' : 'Taslak'}</p>
                    `, 'info');
                    
                    // Kategorilerin geçerliliğini kontrol et
                    const invalidCategories = categories.filter(cat => !CATEGORIES.includes(cat));
                    if (invalidCategories.length > 0) {
                        addResult(`
                            <h4>❌ Geçersiz kategoriler</h4>
                            <div class="category-list">
                                ${invalidCategories.map(cat => `<span class="category-item" style="background: #f8d7da;">${cat}</span>`).join('')}
                            </div>
                        `, 'error');
                    }
                });
                
            } catch (error) {
                addResult(`❌ Talep kategorileri yüklenemedi: ${error.message}`, 'error');
            }
        }
        
        async function debugMatchingLogic() {
            clearResults();
            addResult('<h3>🔍 Eşleştirme Mantığı Testi</h3>', 'info');
            
            if (!currentUser) {
                addResult('❌ Kullanıcı girişi gerekli', 'error');
                return;
            }
            
            try {
                // Test kategorileri
                const testCategories = ['Elektrik', 'Makine-İmalat'];
                
                addResult(`🧪 Test kategorileri: ${testCategories.join(', ')}`, 'info');
                
                // Bu kategorilerdeki tedarikçileri bul
                const q = query(
                    collection(db, 'users'),
                    where('isActive', '==', true),
                    where('categories', 'array-contains-any', testCategories),
                    where('roles.supplier', '==', true)
                );
                
                const snap = await getDocs(q);
                
                addResult(`📊 Bulunan tedarikçi sayısı: ${snap.docs.length}`, 'info');
                
                if (snap.docs.length === 0) {
                    addResult('⚠️ Hiç tedarikçi bulunamadı!', 'warning');
                    
                    // Tüm aktif tedarikçileri kontrol et
                    const allSuppliersQ = query(
                        collection(db, 'users'),
                        where('isActive', '==', true),
                        where('roles.supplier', '==', true)
                    );
                    
                    const allSuppliersSnap = await getDocs(allSuppliersQ);
                    addResult(`📊 Toplam aktif tedarikçi sayısı: ${allSuppliersSnap.docs.length}`, 'info');
                    
                    if (allSuppliersSnap.docs.length > 0) {
                        addResult('🔍 Tedarikçi kategorileri:', 'info');
                        allSuppliersSnap.docs.forEach((doc, index) => {
                            const data = doc.data();
                            const categories = data.categories || [];
                            addResult(`
                                <h4>Tedarikçi ${index + 1}: ${data.companyName || 'İsimsiz'}</h4>
                                <div class="category-list">
                                    ${categories.map(cat => `<span class="category-item">${cat}</span>`).join('')}
                                </div>
                            `, 'info');
                        });
                    }
                } else {
                    snap.docs.forEach((doc, index) => {
                        const data = doc.data();
                        const categories = data.categories || [];
                        addResult(`
                            <h4>Tedarikçi ${index + 1}: ${data.companyName || 'İsimsiz'}</h4>
                            <div class="category-list">
                                ${categories.map(cat => `<span class="category-item">${cat}</span>`).join('')}
                            </div>
                        `, 'success');
                    });
                }
                
            } catch (error) {
                addResult(`❌ Eşleştirme mantığı testi başarısız: ${error.message}`, 'error');
            }
        }
        
        // Initialize
        init();
    </script>
</body>
</html>
