<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Talep Detayƒ±</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%233b82f6' rx='6'/%3E%3Ctext x='16' y='22' font-family='Arial' font-size='18' font-weight='bold' text-anchor='middle' fill='white'%3ET%3C/text%3E%3C/svg%3E" />
  <link rel="stylesheet" href="assets/css/rfq-bid-form.css">
  <link rel="stylesheet" href="./utils.css" />
  <link rel="stylesheet" href="/assets/css/layout.css" />
  <link rel="stylesheet" href="/css/ui-standard.css" />
  
  <!-- PDF & Excel Libraries (Local) -->
  <script type="module">
    import './assets/vendor/jspdf.umd.min.js';
    import './assets/vendor/xlsx.full.min.js';
  </script>
  <!-- ExcelJS for advanced styling -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
  
  <style>
    .summary-card {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      margin: 16px 0;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .summary-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      background:#ffffff;
      border:1px solid #E5E7EB;
      border-radius:10px;
      padding:12px;
      box-shadow:0 1px 2px rgba(0,0,0,0.02);
    }
    .summary-label {
      font-size: 12px;
      color: #6b7280;
      font-weight: 500;
      text-transform: uppercase;
    }
    .summary-value {
      font-size: 14px;
      color: #111827;
      font-weight: 600;
    }
    .items-table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
      font-size: 13px;
    }
    .items-table th,
    .items-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .items-table th {
      background: #f3f4f6;
      font-weight: 600;
    }
    .action-buttons {
      display: flex;
      gap: 12px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    .btn-primary:hover {
      background: #2563eb;
    }
    .btn-success {
      background: #10b981;
      color: white;
    }
    .btn-success:hover {
      background: #059669;
    }
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    .btn-danger:hover {
      background: #dc2626;
    }
    .btn-secondary {
      background: #6b7280;
      color: white;
    }
    .btn-secondary:hover {
      background: #4b5563;
    }
    .file-upload-section {
      background: #f9fafb;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      padding: 20px;
      margin: 16px 0;
    }
    .file-list {
      margin-top: 16px;
    }
    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 8px;
    }
    .file-info {
      flex: 1;
    }
    .file-actions {
      display: flex;
      gap: 8px;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-draft {
      background: #fef3c7;
      color: #92400e;
    }
    .status-published {
      background: #dcfce7;
      color: #166534;
    }
    .visibility-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .visibility-public {
      background: #dbeafe;
      color: #1e40af;
    }
    .visibility-company {
      background: #fef3c7;
      color: #92400e;
    }
    .visibility-private {
      background: #fecaca;
      color: #991b1b;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      background: white;
      margin: 15% auto;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      text-align: center;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 20px;
    }
  </style>
  <style>
    body { font-family: "Inter", "Segoe UI", Roboto, Arial, sans-serif; line-height: 1.55; background-color: #F9FAFB; }
    h2, h3, h4 { margin: 0 0 8px; }
    h2 { font-size: 1.4rem; font-weight: 600; color: #1F2937; border-bottom: 2px solid #2563EB; display: inline-block; padding-bottom: 4px; }
    h3 { font-size: 1.125rem; font-weight: 600; color: #1E3A8A; }
    p, span, div { font-size: 0.95rem; color: #444; }
    .label { font-size: 0.8rem; color: #6B7280; }
    .section-card { background: #fff; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
    .empty-state { text-align: center; color: #6B7280; padding: 40px 20px; background: #F9FAFB; border: 1px dashed #D1D5DB; border-radius: 12px; }
    .empty-state .emoji { font-size: 2rem; display: block; margin-bottom: 8px; }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 18px; font-size: 0.95rem; border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s ease; }
    .btn-primary { background-color: #2563EB; color: #fff; }
    .btn-primary:hover { background-color: #1E40AF; transform: translateY(-1px); }
    .btn-outline { background-color: #fff; color: #2563EB; border: 1px solid #2563EB; }
    .btn-outline:hover { background-color: #EFF6FF; }
    .payment-option-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; margin-top: 12px; }
    .payment-card { border: 1px solid #E5E7EB; border-radius: 10px; padding: 14px 16px; background: #fff; cursor: pointer; transition: all 0.25s ease; }
    .payment-card:hover { border-color: #2563EB; background: #EFF6FF; box-shadow: 0 0 0 2px #DBEAFE; }
    .payment-card.selected { background: #DBEAFE; border-color: #2563EB; }
    .payment-card p { font-size: 0.9rem; color: #374151; margin: 0; line-height: 1.4; }
    /* Hide radios inside pesin-group when cards are present */
    #payment-section #pesin-group input[type="radio"]{ position:absolute; opacity:0; pointer-events:none; }
    /* Section header layout */
    .section-header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .section-header h2{margin:0;flex:1}
    .section-header .actions{display:flex;gap:8px}
    .btn-sm{padding:6px 10px;font-size:.875rem}
    /* Spacing below section titles */
    .section-card .section-header + .row { margin-top: 8px !important; }
    /* Subcards & compact controls */
    .subcard{background:#F9FAFB;border:1px solid #E5E7EB;border-radius:8px;padding:12px}
    .subcard-alt{background:#F0F9FF;border-left:4px solid #3b82f6;border:1px solid #DBEAFE;border-radius:8px;padding:12px}
    #product-bid-forms .control-sm{padding:6px 8px;border:1px solid #d1d5db;border-radius:6px;font-size:0.95rem}
    #product-bid-forms .select-sm{padding:6px 8px;border:1px solid #d1d5db;border-radius:6px;font-size:0.95rem;background:#fff}
    #product-bid-forms .field-label{font-size:13px;color:#1d4ed8;font-weight:700}

    /* Tooltip styles */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: #fff;
      text-align: left;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      line-height: 1.4;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    /* Status and visibility badges */
    .status-badge, .visibility-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.status-draft, .visibility-badge.visibility-private {
      background-color: #fef3c7;
      color: #92400e;
    }

    .status-badge.status-published, .visibility-badge.visibility-public {
      background-color: #d1fae5;
      color: #065f46;
    }

    .status-badge.status-sent, .visibility-badge.visibility-company {
      background-color: #dbeafe;
      color: #1e40af;
    }

    .status-badge.status-completed {
      background-color: #d1fae5;
      color: #065f46;
    }

    .status-badge.status-cancelled {
      background-color: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body>
  <!-- Common Header -->
  <header id="app-header"></header>

  <div class="container--wide" style="padding:20px 0">
    <nav id="breadcrumb" class="tb-breadcrumb"></nav>
  
  <!-- Teklifbul Rol & Onay Sistemi - Uyarƒ± Banner'larƒ± -->
  <div id="approvalWarningBanners" style="margin-bottom: 16px;"></div>
  
  <!-- Summary Card -->
  <div class="summary-card">
    <h1 id="d-title" style="margin:0 0 6px 0;">Talep Detayƒ±</h1>
    <h3 style="margin:0 0 12px 0; color:#1f2937; font-size:16px;">Talep Bilgileri</h3>
    <div class="summary-grid">
      <div class="summary-item">
        <span class="summary-label">SATFK</span>
        <span class="summary-value" id="d-satfk">-</span>
        <button id="copySatfkBtn" class="btn-sm" style="margin-left: 8px; padding: 4px 8px; font-size: 11px;">üìã Kopyala</button>
        <a id="searchBySatfkBtn" href="#" style="margin-left: 8px; padding: 4px 8px; font-size: 11px; background: #10b981; color: white; text-decoration: none; border-radius: 4px;">üîç Bu kodla ara</a>
      </div>
      <div class="summary-item">
        <span class="summary-label">Talep Tarihi</span>
        <span class="summary-value" id="d-demanddate">-</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Termin</span>
        <span class="summary-value" id="d-duedate">-</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">√ñncelik</span>
        <span class="summary-value" id="d-priority">-</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Kalem Sayƒ±sƒ±</span>
        <span class="summary-value" id="d-itemcount">-</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Durum</span>
        <span id="d-status">-</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">G√∂r√ºn√ºrl√ºk</span>
        <span id="d-visibility">-</span>
        <div class="tooltip" style="display: inline-block; margin-left: 5px;">
          <span class="help-icon" style="cursor: help; color: #3b82f6;">‚ìò</span>
          <span class="tooltiptext" style="visibility: hidden; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s; width: 200px; font-size: 12px;">
            Talebin kimler tarafƒ±ndan g√∂r√ºlebileceƒüini belirtir:<br>
            - √ñzel: Sadece belirlenen tedarik√ßiler<br>
            - ≈ûirket: Aynƒ± ≈üirketteki kullanƒ±cƒ±lar<br>
            - Genel: T√ºm kullanƒ±cƒ±lar
          </span>
        </div>
      </div>
      <div class="summary-item">
        <span class="summary-label">Talep Tipi</span>
        <span class="summary-value" id="d-demand-type">-</span>
        <div class="tooltip" style="display: inline-block; margin-left: 5px;">
          <span class="help-icon" style="cursor: help; color: #3b82f6;">‚ìò</span>
          <span class="tooltiptext" style="visibility: hidden; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s; width: 200px; font-size: 12px;">
            <span id="d-demand-type-desc">-</span>
          </span>
        </div>
      </div>
      <div class="summary-item">
        <span class="summary-label">S√ºreli</span>
        <span class="summary-value" id="d-is-urgent">-</span>
      </div>
      <div class="summary-item" id="urgency-container" style="display: none;">
        <span class="summary-label">Acil S√ºre</span>
        <span class="summary-value" id="d-urgency-days">-</span>
      </div>
      <div class="summary-item" id="uploadBidBlock">
          <span class="summary-label">Teklif Y√ºkle (Excel)</span>
          <input type="file" id="excelBidInput" accept=".xlsx,.xls" style="display:none;" />
          <button id="btnUploadBid" class="btn btn-primary" style="padding: 8px 16px; font-size: 12px;">
            üì§ Excel'den Teklif Y√ºkle
          </button>
      </div>
      <div class="summary-item" id="exportSatfkBlock">
        <span class="summary-label">Excel (SATFK)</span>
        <button id="exportSatfkBtn" class="btn btn-outline" style="padding: 8px 16px; font-size: 12px;">‚¨áÔ∏è Excel ƒ∞ndir</button>
      </div>
      <div class="summary-item">
        <span class="summary-label">Olu≈üturma Tarihi</span>
        <span class="summary-value" id="d-createdat">-</span>
      </div>
      <div class="summary-item" id="sentAtContainer" style="display:none;">
        <span class="summary-label">G√∂nderim Tarihi</span>
        <span class="summary-value" id="sentAt">-</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Teslimat Adresi</span>
        <span class="summary-value" id="d-delivery-address">-</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Teslim ≈ûekli</span>
        <span class="summary-value" id="d-delivery-method">-</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Teslim Yeri</span>
        <span class="summary-value" id="d-delivery-location">-</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Alƒ±m Yeri (ƒ∞l)</span>
        <span class="summary-value" id="d-purchase-location">-</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Talep Eden</span>
        <span class="summary-value" id="d-requester">-</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Onaylayan</span>
        <span class="summary-value" id="d-approver">-</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Satƒ±nalma Sorumlusu</span>
        <span class="summary-value" id="d-purchase-manager">-</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Genel M√ºd√ºr</span>
        <span class="summary-value" id="d-general-manager">-</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">√ñdeme ≈ûartlarƒ±</span>
        <span class="summary-value" id="d-payment-terms">-</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Para Birimi</span>
        <span class="summary-value" id="d-currency">-</span>
      </div>
    </div>
    <div style="margin-top:16px;">
      <span class="summary-label">Kategoriler</span>
      <div id="d-cats" style="margin-top:8px;"></div>
    </div>
    
    <!-- Bidding Mode Info -->
    <div style="margin-top:16px; padding-top:16px; border-top:1px solid #e5e7eb;">
      <div class="summary-grid">
        <div class="summary-item">
          <span class="summary-label">Talep Tipi</span>
          <span id="d-biddingmode">-</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Aktif Evre</span>
          <span id="d-phase">-</span>
          <div class="tooltip" style="display: inline-block; margin-left: 5px;">
            <span class="help-icon" style="cursor: help; color: #3b82f6;">‚ìò</span>
            <span class="tooltiptext" style="visibility: hidden; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s; width: 200px; font-size: 12px;">
              Talebin ≈üu anki a≈üamasƒ±nƒ± g√∂sterir:<br>
              - Taslak: Hen√ºz yayƒ±nlanmamƒ±≈ü<br>
              - Yayƒ±nlandƒ±: Tedarik√ßilere a√ßƒ±k<br>
              - 1. Tur: Gizli teklif a≈üamasƒ±<br>
              - 2. Tur: A√ßƒ±k artƒ±rma a≈üamasƒ±
            </span>
          </div>
        </div>
        <div class="summary-item">
          <span class="summary-label">Tur</span>
          <span class="summary-value" id="d-round">-</span>
        </div>
        <div class="summary-item" id="countdownContainer" style="display:none;">
          <span class="summary-label">Kalan S√ºre</span>
          <span class="summary-value" id="d-countdown" style="color:#dc2626; font-weight:700;">-</span>
        </div>
      </div>
      
      <!-- Round 2 Transition Button (Hybrid Only, Owner Only) -->
      <div id="round2BtnContainer" style="margin-top:12px; display:none;">
        <button id="btnRound2" class="btn btn-success">2. Tura Ge√ß</button>
      </div>
    </div>
  </div>

  <!-- Owner Actions -->
  <div id="ownerActions" style="display:none;">
    <div class="action-buttons">
      <button id="btnEdit" class="btn btn-primary" style="display:none;">D√ºzenle</button>
      <button id="btnPublish" class="btn btn-success">Tedarik√ßilere G√∂nder</button>
      <button id="btnUnpublish" class="btn btn-danger" style="display:none;">Geri √áek</button>
      <button id="btnDeleteDraft" class="btn btn-danger" style="display:none;">Taslaƒüƒ± Sil</button>
      <button id="btnExportPDF" class="btn btn-secondary">PDF ƒ∞ndir</button>
    </div>
  </div>

  

  <!-- Description -->
  <div class="section-card">
    <h2>üóíÔ∏è A√ßƒ±klama</h2>
    <p class="label" style="margin:4px 0 8px 0;">Talep sahibi tarafƒ±ndan girilen a√ßƒ±klama metni a≈üaƒüƒ±dadƒ±r.</p>
    <pre id="spec" style="white-space:pre-wrap; background:#fafafa; padding:12px; border:1px solid #eee; border-radius:6px;"></pre>
  </div>

  <!-- Items Table -->
  <div class="section-header"><span class="icon">üìù</span><span>Talep Edilen √úr√ºn Kalemleri</span></div>
  <p class="label" style="margin:4px 0 8px 0;">Talep sahibi tarafƒ±ndan olu≈üturulan √ºr√ºn listesidir.</p>
  <table class="items-table" id="itemsTable">
    <thead>
      <tr>
        <th>Sƒ±ra No</th>
        <th>Malzeme Kodu</th>
        <th>Tanƒ±m</th>
        <th>Marka/Model</th>
        <th>Miktar</th>
        <th>Birim</th>
        <th>ƒ∞stenilen Teslim Tarihi</th>
      </tr>
    </thead>
    <tbody id="itemsBody"></tbody>
  </table>

  <!-- File Attachments (Owner Only) -->
  <div id="filesSection" style="display:none;">
    <h2>Ek Dosyalar</h2>
    
    <div id="fileUploadArea" class="file-upload-section">
      <h4 style="margin-top:0;">Dosya Y√ºkle</h4>
      <input type="file" id="fileInput" multiple 
             accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg" 
             style="margin-bottom:12px;" />
      <button id="btnUpload" class="btn btn-primary">Y√ºkle</button>
      <p style="font-size:12px; color:#6b7280; margin-top:8px;">Maks. 10 MB, desteklenen formatlar: PDF, DOC, DOCX, XLS, XLSX, PNG, JPG</p>
    </div>

    <div class="file-list" id="fileList"></div>
  </div>

  <!-- Fiyat Ge√ßmi≈üi Modal -->
  <div id="priceHistoryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">Fiyat Ge√ßmi≈üi</h3>
        <button onclick="closePriceHistoryModal()" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">‚úï Kapat</button>
      </div>
      <div id="priceHistoryContent"></div>
    </div>
  </div>

  <!-- Teklifler Tablosu -->
  <div id="bids-section" style="margin-top: 30px;">
    <h3 style="margin: 0 0 16px 0; color: #1e293b;">üìã Gelen Teklifler</h3>
    <!-- Teklifler Kart Formatƒ±nda -->
    <div id="bidCardsContainer" style="display: grid; gap: 16px;">
      <!-- Teklifler buraya kart olarak y√ºklenecek -->
    </div>
    
    <!-- Eski tablo formatƒ± (yedek - ge√ßici olarak gizli) -->
    <table id="legacyBidTable" style="width: 100%; border-collapse: collapse; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; display: none;">
      <thead style="background: #f8fafc;">
        <tr>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; font-weight: 600; color: #374151;">Toplam (KDV Hari√ß)</th>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; font-weight: 600; color: #374151;">KDV (%)</th>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; font-weight: 600; color: #374151;">Toplam (KDV Dahil)</th>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; font-weight: 600; color: #374151;">Marka</th>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; font-weight: 600; color: #374151;">√ñdeme</th>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; font-weight: 600; color: #374151;">Not</th>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; font-weight: 600; color: #374151;">Tedarik√ßi</th>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; font-weight: 600; color: #374151;">Fiyat Ge√ßmi≈üi</th>
          <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: left; font-weight: 600; color: #374151;">Durum</th>
        </tr>
      </thead>
      <tbody id="bidRows">
        <!-- Eski format - gizli -->
      </tbody>
    </table>
  </div>

  <!-- Kendi Teklifin (Tedarik√ßi g√∂r√ºn√ºm√º) -->
  <div id="own-bid-section" class="section-card" style="display:none;">
    <div class="section-header"><span class="icon">üì¶</span><span>Kendi Teklifin</span></div>
    <div id="own-bid-content" class="empty-state">
      <span class="emoji">üí°</span>
      <p>Hen√ºz teklif vermediniz.</p>
      <button class="btn btn-primary" onclick="document.getElementById('bid-form-section').scrollIntoView({behavior:'smooth'})">Teklif Ver</button>
    </div>
  </div>

  <div id="bid-form-section">
    <div id="rfq-bid-form-container">
      <!-- RFQ Bid Form will be loaded here -->
    </div>
  </div>

  <!-- Fiyat Kar≈üƒ±la≈ütƒ±rma B√∂l√ºm√º -->
  <div id="price-comparison-section" style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
    <h3 style="margin: 0 0 16px 0; color: #1e293b;">üìä Fiyat Kar≈üƒ±la≈ütƒ±rma</h3>
    <p style="margin: 0 0 16px 0; color: #64748b; font-size: 14px;">
      Gelen teklifleri Excel formatƒ±nda kar≈üƒ±la≈ütƒ±rmak i√ßin a≈üaƒüƒ±daki butona tƒ±klayƒ±n.
    </p>
    <button id="btnPriceComparison" class="btn btn-success" style="background: #059669; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600;">
      üìà Excel Fiyat Kar≈üƒ±la≈ütƒ±rmasƒ± ƒ∞ndir
    </button>
  </div>
  </div><!-- End container -->

  <!-- Modals -->
  <div id="publishModal" class="modal">
    <div class="modal-content">
      <h3>Talebi Yayƒ±nla</h3>
      <p>Bu talep tedarik√ßilerinize a√ßƒ±lacak. Devam edilsin mi?</p>
      <div class="modal-buttons">
        <button id="confirmPublish" class="btn btn-success">Evet, G√∂nder</button>
        <button id="cancelPublish" class="btn btn-secondary">ƒ∞ptal</button>
      </div>
    </div>
  </div>

  <div id="unpublishModal" class="modal">
    <div class="modal-content">
      <h3>Talebi Geri √áek</h3>
      <p>Tedarik√ßiler artƒ±k bu talebi g√∂remeyecek. Devam edilsin mi?</p>
      <div class="modal-buttons">
        <button id="confirmUnpublish" class="btn btn-danger">Evet, Geri √áek</button>
        <button id="cancelUnpublish" class="btn btn-secondary">ƒ∞ptal</button>
      </div>
    </div>
  </div>

  <!-- Header Script -->
  <script type="module">
    import { initGlobalHeader } from './assets/js/ui/header.js';
    import { db, auth, requireAuth, logout } from "./firebase.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    // Teklifbul Rule v1.0 - Structured Logging
    import { logger } from './src/shared/log/logger.js';
    
    // Initialize global header
    initGlobalHeader({ mount: '#app-header', activeRoute: 'demand-detail' });
    
    const headerUser = await requireAuth();
    // Defensive: header elements may not exist on all layouts
    const hdrUserEl = document.getElementById("userLabel");
    if (hdrUserEl) hdrUserEl.textContent = headerUser.email || headerUser.uid.slice(0, 10);
    const clockEl = document.getElementById("clock");
    if (clockEl) {
      function tick(){ clockEl.textContent = new Date().toLocaleString("tr-TR"); }
      tick();
      setInterval(tick, 1000);
    }

    // Company Selector
    const userRef = doc(db, "users", headerUser.uid);
    const userSnap = await getDoc(userRef);
    let userData = userSnap.exists() ? userSnap.data() : {};
    const companySelect = document.getElementById("companySelect");
    
    // Store userData in window for later use
    window.userData = userData;

    // Load companies
    let companies = [];
    try {
      logger.info("Loading companies for user", { uid: headerUser.uid });
      logger.info("User data companies", userData.companies);
      
      if (Array.isArray(userData.companies) && userData.companies.length) {
        logger.info(`Attempting to load ${userData.companies.length} company documents`);
        const companyRefs = userData.companies.map(id => {
          logger.info("Creating ref for company ID", { id });
          return doc(db, "companies", id);
        });
        
        const snaps = await Promise.all(
          companyRefs.map(ref => {
            logger.info("Loading company", { ref });
            return getDoc(ref);
          })
        );
        
        logger.info("Company snapshots", snaps.map(s => ({
          id: s.id, 
          exists: s.exists(), 
          data: s.data()
        })));
        
        companies = snaps
          .filter(s => s.exists())
          .map(s => ({ id: s.id, ...s.data() }));
        logger.info("Loaded companies", companies);
      } else {
        logger.info("No companies in user data, will create default");
      }
    } catch (e) {
      logger.warn("Company data load error (using defaults)", e.message);
      logger.warn("Error details", { code: e.code, name: e.name, stack: e.stack });
      companies = [];
    }
    
    // Default company if none exist
    if (!companies.length) {
      const defaultCompanyId = "solo-" + headerUser.uid;
      const defaultCompany = { 
        name: "≈ûirket Yok",
        ownerId: headerUser.uid,
        createdAt: new Date()
      };
      
      logger.info("Attempting to create default company", { defaultCompanyId, defaultCompany });
      
      // Create the default company document
      try {
        const companyRef = doc(db, "companies", defaultCompanyId);
        logger.info("Company ref created", { ref: companyRef });
        await setDoc(companyRef, defaultCompany);
        logger.info("Default company created successfully");
        
        // Add the company to the user's companies list
        companies = [{ id: defaultCompanyId, ...defaultCompany }];
        await setDoc(userRef, {
          companies: [defaultCompanyId],
          activeCompanyId: defaultCompanyId
        }, { merge: true });
        logger.info("User document updated with company info");
      } catch (e) {
        logger.warn("Could not create default company", e.message);
        logger.warn("Error details", { code: e.code, name: e.name, stack: e.stack });
        logger.warn("Company data", defaultCompany);
        
        // Even if we can't create the company, we should still have a fallback
        companies = [{ id: defaultCompanyId, ...defaultCompany }];
      }
    }

    // Populate dropdown
    if (companySelect) {
      companySelect.innerHTML = companies
        .map(c => `<option value="${c.id}">${c.name}</option>`)
        .join("");

      const activeId = userData.activeCompanyId && companies.length > 0 && companies.find(c => c.id === userData.activeCompanyId)
        ? userData.activeCompanyId
        : companies.length > 0 ? companies[0].id : "";
      
      if (activeId && companySelect) {
        companySelect.value = activeId;
        localStorage.setItem("activeCompanyId", activeId);
      }
    }

    // Handle company change
    if (companySelect) {
      companySelect.onchange = async (e) => {
        try {
          await setDoc(userRef, { activeCompanyId: e.target.value }, { merge: true });
          localStorage.setItem("activeCompanyId", e.target.value);
          location.reload(); // Reload to apply company filter
        } catch (error) {
          logger.error('Company selection error', error);
          toast.error(MESSAGES.ERROR_COMPANY_SELECT_UPDATE + ': ' + (error.message || error));
        }
      };
    }
  </script>

  <!-- Main Demand Detail Script -->
  <script type="module">
    import { requireAuth, db, app } from "./firebase.js";
    import { doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, orderBy, getDocs, serverTimestamp, arrayUnion, deleteDoc, increment, limit } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    // Teklifbul Rule v1.0 - Structured Logging
    import { logger } from './src/shared/log/logger.js';
    // Teklifbul Rule v1.0 - Toast Bildirim Sistemi
    import { toast } from './src/shared/ui/toast.js';
    // Teklifbul Rule v1.1 - MESSAGES constants (i18n hazƒ±rlƒ±ƒüƒ±)
    import { MESSAGES } from './src/shared/constants/messages.js';
    // Teklifbul Rol & Onay Sistemi - Guard fonksiyonlarƒ±
    import { canIssuePO, canESignApprove, createAuditLog, isSingleUserCompany, hasActiveTopApprover } from "./assets/js/services/approval-guards.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";
    import { RFQBidForm } from './assets/js/ui/rfq-bid-form.js';
    
    // CRITICAL: Import new ID-based category system
    import { 
      normalizeToIds, 
      getNameById, 
      getIdByName, 
      getIdBySlug 
    } from "./src/categories/category-service.js";
    // Import address builder utility
    import { buildAddress } from "./utils/build-address.js";
    
    // Legacy imports (for backward compatibility)
    import { CATEGORIES, getCategoryNameById, getCategoryIdByName } from "./categories.js";
    import { slugifyTr } from "./utils/slugify-tr.js";

    const user = await requireAuth();
    
    // Readonly mod kontrol√º - Teklifbul Rule v1.0
    const urlParams = new URLSearchParams(window.location.search);
    const isReadOnly = urlParams.get('readonly') === 'true';
    
    // Kullanƒ±cƒ± durumu kontrol√º
    let userIsPending = false;
    try {
      const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      if (userDoc.exists()) {
        const userData = userDoc.data();
        userIsPending = userData.companyJoinStatus === 'pending' || userData.companyJoinStatus === 'rejected';
      }
    } catch (e) {
      logger.warn('User status check failed', e);
    }
    
    const readonlyMode = isReadOnly || userIsPending;
    
    // Teklifbul Rol & Onay Sistemi - Uyarƒ± banner'larƒ±nƒ± y√ºkle
    async function loadApprovalWarningBanners() {
      try {
        const bannersContainer = document.getElementById('approvalWarningBanners');
        if (!bannersContainer) return;
        
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const currentUserData = userDoc.exists() ? userDoc.data() : {};
        const companyId = currentUserData.companies?.[0] || null;
        
        if (!companyId) return;
        
        bannersContainer.innerHTML = '';
        
        // Tek kullanƒ±cƒ± kontrol√º
        const isSingleUser = await isSingleUserCompany(companyId);
        if (isSingleUser) {
          const singleUserBanner = document.createElement('div');
          singleUserBanner.style.cssText = 'background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin-bottom: 12px;';
          singleUserBanner.innerHTML = `
            <div style="display: flex; align-items: start; gap: 12px;">
              <span style="font-size: 24px;">‚ö†Ô∏è</span>
              <div style="flex: 1;">
                <strong style="color: #92400e; font-size: 15px; display: block; margin-bottom: 4px;">Tek Kullanƒ±cƒ±lƒ± ≈ûirket</strong>
                <p style="color: #92400e; font-size: 13px; margin: 0;">
                  Bu ≈üirkette yalnƒ±zca teklif toplama ve mukayese yapƒ±labilir. Onay/PO i≈ülemleri i√ßin en az 2 aktif kullanƒ±cƒ± ve 1 √ºst onaycƒ± rol√º gereklidir.
                </p>
              </div>
            </div>
          `;
          bannersContainer.appendChild(singleUserBanner);
        }
        
        // √úst onaycƒ± kontrol√º
        const hasTopApprover = await hasActiveTopApprover(companyId);
        if (!hasTopApprover) {
          const noApproverBanner = document.createElement('div');
          noApproverBanner.style.cssText = 'background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; padding: 16px; margin-bottom: 12px;';
          noApproverBanner.innerHTML = `
            <div style="display: flex; align-items: start; gap: 12px;">
              <span style="font-size: 24px;">üö´</span>
              <div style="flex: 1;">
                <strong style="color: #991b1b; font-size: 15px; display: block; margin-bottom: 4px;">√úst Onaycƒ± Bulunamadƒ±</strong>
                <p style="color: #991b1b; font-size: 13px; margin: 0;">
                  ≈ûirkette en az 1 √ºst onaycƒ± rol√ºne sahip aktif kullanƒ±cƒ± gereklidir (Genel M√ºd√ºr, GMY, CEO, ƒ∞≈üveren, YKB, YK √úyesi). 
                  E-imza ile teklif onaylama ve PO olu≈üturma i≈ülemleri yapƒ±lamaz.
                </p>
              </div>
            </div>
          `;
          bannersContainer.appendChild(noApproverBanner);
        }
        
        // PO kontrol√º
        const poCheck = await canIssuePO(companyId);
        if (!poCheck.allowed) {
          const poBanner = document.createElement('div');
          poBanner.style.cssText = 'background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin-bottom: 12px;';
          poBanner.innerHTML = `
            <div style="display: flex; align-items: start; gap: 12px;">
              <span style="font-size: 24px;">üìã</span>
              <div style="flex: 1;">
                <strong style="color: #92400e; font-size: 15px; display: block; margin-bottom: 4px;">PO Olu≈üturma Engellendi</strong>
                <p style="color: #92400e; font-size: 13px; margin: 0;">
                  ${poCheck.reason}
                </p>
              </div>
            </div>
          `;
          bannersContainer.appendChild(poBanner);
        }
      } catch (e) {
        logger.error('Uyarƒ± banner\'larƒ± y√ºklenirken hata', e);
      }
    }
    
    // Sayfa y√ºklendiƒüinde banner'larƒ± y√ºkle
    loadApprovalWarningBanners();
    
    // Readonly modunda uyarƒ± g√∂ster
    if (readonlyMode) {
      const readonlyBanner = document.createElement('div');
      readonlyBanner.style.cssText = 'background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin: 16px 0; text-align: center; position: sticky; top: 80px; z-index: 100;';
      readonlyBanner.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap;">
          <span style="font-size: 24px;">‚è≥</span>
          <div>
            <strong style="color: #92400e; font-size: 16px;">Onay Bekleniyor</strong>
            <p style="color: #92400e; font-size: 14px; margin: 4px 0 0 0;">
              ≈ûirket y√∂neticileri kaydƒ±nƒ±zƒ± onaylayana kadar sadece g√∂r√ºnt√ºleme yapabilirsiniz. Teklif veremez veya d√ºzenleyemezsiniz.
            </p>
            <a href="./company-join-waiting.html" style="color: #92400e; text-decoration: underline; font-size: 13px; margin-top: 8px; display: inline-block;">
              Bekleme durumunu kontrol et ‚Üí
            </a>
          </div>
        </div>
      `;
      const container = document.querySelector('.container--wide') || document.body;
      const firstChild = container.firstElementChild;
      if (firstChild) {
        container.insertBefore(readonlyBanner, firstChild);
      } else {
        container.appendChild(readonlyBanner);
      }
      
      // Readonly modunda teklif verme butonlarƒ±nƒ± ve formunu gizle
      setTimeout(() => {
        // "Teklif Ver" butonlarƒ±nƒ± gizle
        const bidButtons = document.querySelectorAll('button[onclick*="bid-form-section"], button:contains("Teklif Ver")');
        bidButtons.forEach(btn => {
          if (btn.textContent.includes('Teklif Ver')) {
            btn.style.display = 'none';
          }
        });
        
        // Teklif formu b√∂l√ºm√ºn√º gizle
        const bidFormSection = document.getElementById('bid-form-section');
        if (bidFormSection) {
          bidFormSection.style.display = 'none';
        }
        
        // submitBid fonksiyonunu devre dƒ±≈üƒ± bƒ±rak
        window.submitBid = function() {
          toast.warn(MESSAGES.WARN_APPROVAL_PENDING);
          return false;
        };
      }, 100);
    }
    
    // CRITICAL: Category ID system helper functions
    // Convert category ID/slug/name to display name (using new system)
    function categoryToDisplayName(catValue) {
      if (!catValue) return catValue;
      
      // Try new system first (CAT.XXX format)
      if (catValue.startsWith('CAT.')) {
        const name = getNameById(catValue);
        if (name && name !== catValue) return name;
      }
      
      // Try legacy system (cat_xxx format)
      if (catValue.startsWith('cat_')) {
        const name = getCategoryNameById(catValue);
        if (name) return name;
        // Try to convert legacy ID to new ID and get name
        const ids = normalizeToIds([catValue]);
        if (ids.length > 0) {
          const newName = getNameById(ids[0]);
          if (newName && newName !== ids[0]) return newName;
        }
      }
      
      // Try to find by name (new system)
      const id = getIdByName(catValue);
      if (id) {
        const name = getNameById(id);
        if (name && name !== id) return name;
      }
      
      // Try legacy name lookup
      const legacyId = getCategoryIdByName(catValue);
      if (legacyId) {
        const name = getCategoryNameById(legacyId);
        if (name) return name;
      }
      
      // Try slug-based lookup (new system)
      const idBySlug = getIdBySlug(catValue);
      if (idBySlug) {
        const name = getNameById(idBySlug);
        if (name && name !== idBySlug) return name;
      }
      
      // Fallback: return as-is (might be a custom category)
      return catValue;
    }
    const storage = getStorage(app);

    // Get demand ID
    let demandId = new URLSearchParams(location.search).get("id");
    const sourceTab = new URLSearchParams(location.search).get("source");
    if (!demandId && location.hash.startsWith("#")) {
      const hashParams = new URLSearchParams(location.hash.slice(1));
      demandId = hashParams.get("id");
    }

    // Breadcrumbs by source
    function renderBreadcrumb() {
      const bc = document.getElementById('breadcrumb');
      if (!bc) return;
      const parts = [];
      parts.push(`<span class='tb-crumb'><span class='ico'>üè†</span><a href='./index.html'>Ana Sayfa</a></span>`);
      parts.push(`<span class='tb-sep'>‚Ä∫</span>`);
      parts.push(`<span class='tb-crumb'><span class='ico'>üìÑ</span><a href='./demands.html'>Talepler</a></span>`);
      
      // Improved breadcrumb logic based on demand ownership and status
      if (isOwner && isPublished) {
        parts.push(`<span class='tb-sep'>‚Ä∫</span><span class='tb-crumb'><span class='ico'>üì§</span><a href='./demands.html?filter=sent'>Giden Talepler</a></span>`);
      } else if (isOwner && !isPublished) {
        parts.push(`<span class='tb-sep'>‚Ä∫</span><span class='tb-crumb'><span class='ico'>üìù</span><a href='./demands.html?filter=draft'>Taslak Talepler</a></span>`);
      } else if (!isOwner) {
        parts.push(`<span class='tb-sep'>‚Ä∫</span><span class='tb-crumb'><span class='ico'>üì•</span><a href='./demands.html?filter=inbox'>Gelen Talepler</a></span>`);
      }
      
      bc.innerHTML = parts.join(' ');
    }

    if (!demandId) {
      demandId = localStorage.getItem("lastDemandId");
    }
    if (!demandId) {
      toast.error(MESSAGES.ERROR_DEMAND_ID_NOT_FOUND);
      location.href = "./demands.html";
    }

    // State
    let demandData = null;
    let isOwner = false;
    let isPublished = false;
    let itemsData = [];
    let countdownInterval = null;

    // Elements
    const bidsSection = document.getElementById("bids-section");
    const bidFormSection = document.getElementById("bid-form-section");
    const ownBidSection = document.getElementById("own-bid-section");
    const ownBidContent = document.getElementById("own-bid-content");
    const ownerActions = document.getElementById("ownerActions");
    const filesSection = document.getElementById("filesSection");
    const fileList = document.getElementById("fileList");
    const fileInput = document.getElementById("fileInput");
    const btnUpload = document.getElementById("btnUpload");
    const btnEdit = document.getElementById("btnEdit");
    const btnPublish = document.getElementById("btnPublish");
    const btnUnpublish = document.getElementById("btnUnpublish");
    const btnExportPDF = document.getElementById("btnExportPDF");
    const btnExportExcel = document.getElementById("btnExportExcel");
    const btnDeleteDraft = document.getElementById("btnDeleteDraft");
    const publishModal = document.getElementById("publishModal");
    const unpublishModal = document.getElementById("unpublishModal");
    const itemsBody = document.getElementById("itemsBody");
    const bidRows = document.getElementById("bidRows");
    const bidCardsContainer = document.getElementById("bidCardsContainer");

    // ====================
    // Load Demand
    // ====================
    async function loadDemand() {
      const dref = doc(db, "demands", demandId);
      try {
        const d = await getDoc(dref);
        if (!d.exists()) {
          logger.error("Demand not found", { demandId });
          toast.error(MESSAGES.ERROR_DEMAND_NOT_FOUND);
          location.href = "./demands.html";
          return;
        }
        demandData = d.data();
        
        // üîç DEBUG: Log ownership info and data structure
        logger.info("[debug] createdBy", { createdBy: demandData.createdBy, currentUser: user.uid });
        logger.info("[debug] demandData structure", {
          title: demandData.title,
          talep_konusu: demandData.talep_konusu,
          stfNo: demandData.stfNo,
          stf_no: demandData.stf_no,
          demandCode: demandData.demandCode,
          talep_kodu: demandData.talep_kodu,
          items: demandData.items ? demandData.items.length : 0,
          hasItemsArray: Array.isArray(demandData.items),
          categories: demandData.categories,
          categoryTags: demandData.categoryTags
        });
        
        // REFACTORED: Basit yetki kontrol√º - liste zaten eri≈üilebilirleri getiriyor
        isOwner = demandData.createdBy === user.uid;
        
        // Get user's company ID for ownership check
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        const userData = userDoc.exists() ? userDoc.data() : {};
        const userCompanyId = userData.companyId;
        
        // Check if user's company owns this demand
        const isCompanyOwner = userCompanyId && demandData.creatorCompanyId === userCompanyId;
        
        // Status kontrol√º
        // FIX: Accept both 'published' (legacy) and 'approved' (new) status as published
        const demandStatus = demandData.status || 'draft';
        // Check both status field and isPublished field for backward compatibility
        isPublished = demandStatus === 'published' || demandStatus === 'approved' || demandData.isPublished === true;

        // Load creator's company name for "Talep Eden" field
        let creatorCompanyName = demandData.requester || '-';
        if (demandData.creatorCompanyId) {
          try {
            const companyDoc = await getDoc(doc(db, 'companies', demandData.creatorCompanyId));
            if (companyDoc.exists()) {
              creatorCompanyName = companyDoc.data().name || creatorCompanyName;
            }
          } catch (e) {
            logger.warn('Could not load company name', e);
          }
        }
        demandData.creatorCompanyName = creatorCompanyName;

        // Render breadcrumb after we know ownership status
        renderBreadcrumb();
        
        // REFACTORED: Yetki kontrol√º - Firestore rules zaten kontrol ediyor
        // Eƒüer 403 gelirse (rules tarafƒ±ndan engellenmi≈üse), kullanƒ±cƒ±ya g√∂ster
        // Liste zaten eri≈üilebilirleri getirdiƒüi i√ßin burada ekstra kontrol yok
        logger.info("Demand loaded", {
          demandId,
          status: demandStatus,
          isOwner,
          isCompanyOwner,
          creatorCompanyId: demandData.creatorCompanyId,
          userCompanyId
        });

        logger.info("renderDemand() √ßaƒürƒ±lƒ±yor");
        renderDemand();
        
        // Show owner-only sections
        if (isOwner) {
          logger.info("Owner sections g√∂steriliyor");
          ownerActions.style.display = "block";
          filesSection.style.display = "block";
          updatePublishButtons();
          updateEditButton();
        } else {
          logger.info("Non-owner, publish button gizleniyor");
          // üîí Hide publish button if not owner
          if (btnPublish) btnPublish.style.display = "none";
        }
        
        // Visibility logic for bids and bid form
        logger.info("Visibility rules uygulanƒ±yor");
        applyVisibilityRules();

      } catch (e) {
        logger.error("Demand load error", e);
        logger.error("Error details", {
          name: e.name,
          message: e.message,
          code: e.code,
          stack: e.stack
        });
        
        // More detailed error handling
        if (e.code === "permission-denied") {
          logger.warn("Permission denied when loading demand", { demandId });
          toast.error(MESSAGES.ERROR_DEMAND_VIEW_PERMISSION);
        } else if (e.code === "not-found") {
          logger.warn("Demand not found", { demandId });
          toast.error(MESSAGES.ERROR_DEMAND_NOT_FOUND);
        } else {
          logger.error("Unexpected error when loading demand", e);
          toast.error(MESSAGES.ERROR_DEMAND_LOAD);
        }
        
        location.href = "./demands.html";
      }
    }

    function renderDemand() {
      logger.info("renderDemand() ba≈ülatƒ±lƒ±yor");
      logger.info("demandData", demandData);
      logger.info("demandData keys", Object.keys(demandData || {}));
      logger.info("demandData.title", { title: demandData?.title });
      logger.info("demandData.satfk", { satfk: demandData?.satfk });
      
      // Check if SATFK exists and show warning if not
      const satfkEl = document.getElementById("d-satfk");
      if (satfkEl && !demandData.satfk) {
        satfkEl.innerHTML = '<span style="color: #ef4444; font-weight: bold;">‚ö†Ô∏è SATFK Kodu Eksik</span>';
        // Add a button to generate SATFK
        const generateBtn = document.createElement('button');
        generateBtn.textContent = 'Olu≈ütur';
        generateBtn.className = 'btn-sm';
        generateBtn.style.marginLeft = '8px';
        generateBtn.style.padding = '4px 8px';
        generateBtn.style.fontSize = '11px';
        generateBtn.onclick = async () => {
          try {
            // In a real implementation, this would call a backend function
            toast.warn(MESSAGES.WARN_SATFK_ADMIN_ONLY);
          } catch (error) {
            logger.error('Error generating SATFK', error);
            toast.error(MESSAGES.ERROR_SATFK_CREATE);
          }
        };
        satfkEl.appendChild(generateBtn);
      } else {
        setText("#d-satfk", demandData.satfk || "-");
      }
      
      setText("#d-demanddate", demandData.demandDate || demandData.createdAt?.toDate?.()?.toLocaleDateString?.("tr-TR") || "-");
      // Termin tarihi formatlamasƒ± - Firestore Timestamp kontrol√º
      const formatDueDate = (date) => {
        if (!date) return "-";
        if (date.toDate) return date.toDate().toLocaleDateString("tr-TR");
        if (date instanceof Date) return date.toLocaleDateString("tr-TR");
        if (typeof date === "string") return new Date(date).toLocaleDateString("tr-TR");
        return "-";
      };
      const dueDateValue = demandData.dueDate || demandData.termin_tarihi;
      setText("#d-duedate", formatDueDate(dueDateValue));
      
      // √ñncelik T√ºrk√ße √ßevirisi
      const priorityMap = {
        'price': 'Fiyat',
        'speed': 'Hƒ±z', 
        'quality': 'Kalite'
      };
      setText("#d-priority", priorityMap[demandData.priority] || demandData.priority || "-");
      
      setText("#d-createdat", demandData.createdAt?.toDate?.()?.toLocaleDateString?.("tr-TR") || "-");
      
      // Talep Tipi ve S√ºreli alanlarƒ±
      const demandTypeMap = {
        'public': 'Genel Talep',
        'private': '√ñzel Talep'
      };
      setText("#d-demand-type", demandTypeMap[demandData.demandType] || demandData.demandType || "-");
      // Set demand type description
      const demandTypeDescEl = document.getElementById("d-demand-type-desc");
      if (demandTypeDescEl) {
        demandTypeDescEl.textContent = getVisibilityDescription(demandData.visibility) || getVisibilityDescription(demandData.demandType) || "Bilinmeyen talep tipi";
      }
      
      // S√ºreli kontrol√º - isTimeBound veya hybridSettings varsa s√ºreli
      const isTimeBound = demandData.isTimeBound || (demandData.hybridSettings && demandData.hybridSettings.isTimeBound);
      setText("#d-is-urgent", isTimeBound ? "Evet" : "Hayƒ±r");
      
      // Acil s√ºre g√ºnleri
      if (isTimeBound && demandData.hybridSettings?.urgencyDays) {
        setText("#d-urgency-days", `${demandData.hybridSettings.urgencyDays} g√ºn`);
        document.getElementById("urgency-container").style.display = "block";
      } else {
        document.getElementById("urgency-container").style.display = "none";
      }
      
      // G√∂r√ºn√ºrl√ºk ve a√ßƒ±klamasƒ±
      const visibilityMap = {
        'private': 'üîí √ñzel',
        'company': 'üè¢ ≈ûirket',
        'public': 'üåç Genel'
      };
      const visibilityEl = document.getElementById("d-visibility");
      if (visibilityEl) {
        visibilityEl.textContent = visibilityMap[demandData.visibility] || demandData.visibility || "-";
        visibilityEl.className = "visibility-badge visibility-" + (demandData.visibility || "unknown");
      }
      
      // Talep Tipi (biddingMode) ve a√ßƒ±klamasƒ±
      const biddingModeMap = {
        'secret': 'Gizli Teklif',
        'open': 'A√ßƒ±k Teklif',
        'hybrid': 'Hibrit'
      };
      setText("#d-biddingmode", biddingModeMap[demandData.biddingMode] || demandData.biddingMode || "-");
      
      // Set bidding mode description
      const biddingModeDescEl = document.querySelector("#d-demand-type .tooltiptext");
      if (biddingModeDescEl) {
        biddingModeDescEl.textContent = getBiddingModeDescription(demandData.biddingMode);
      }
      
      // Aktif Evre (phase)
      const phaseMap = {
        'draft': 'Taslak',
        'published': 'Yayƒ±nlandƒ±',
        'round1': '1. Tur',
        'round2': '2. Tur'
      };
      setText("#d-phase", phaseMap[demandData.phase] || demandData.phase || "-");
      
      // Tur
      setText("#d-round", demandData.round || "-");
      
      // Kalem Sayƒ±sƒ±
      const itemCount = Array.isArray(demandData.items) ? demandData.items.length : 0;
      setText("#d-itemcount", itemCount > 0 ? `${itemCount} kalem` : "0 kalem");
      
      // Durum - isPublished kontrol√º yap
      const statusMap = {
        'draft': 'Taslak',
        'published': 'Yayƒ±nlandƒ±',
        'approved': 'Onaylandƒ±', // New status equivalent to published
        'sent': 'G√∂nderildi',
        'pending': 'Bekliyor',
        'viewed': 'G√∂r√ºld√º',
        'responded': 'Yanƒ±tlandƒ±',
        'rejected': 'Reddedildi',
        'cancelled': 'ƒ∞ptal Edildi',
        'completed': 'Tamamlandƒ±'
      };
      const statusEl = document.getElementById("d-status");
      if (statusEl) {
        // REFACTORED: Sadece status alanƒ± kullanƒ±lƒ±yor
        const statusToShow = demandData.status || 'draft';
        
        // Normalize: treat 'approved' same as 'published' for display
        const displayStatus = (statusToShow === 'approved') ? 'published' : statusToShow;
        const statusText = statusMap[displayStatus] || statusMap[statusToShow] || statusToShow || "-";
        
        statusEl.textContent = statusText;
        statusEl.className = "status-badge status-" + displayStatus;
        
        // Badge rengini ayarla (both 'published' and 'approved' get same green style)
        if (displayStatus === 'published' || statusToShow === 'approved') {
          statusEl.style.background = '#d1fae5';
          statusEl.style.color = '#065f46';
          statusEl.style.padding = '4px 12px';
          statusEl.style.borderRadius = '6px';
          statusEl.style.fontSize = '13px';
          statusEl.style.fontWeight = '600';
        } else if (statusToShow === 'draft') {
          statusEl.style.background = '#fef3c7';
          statusEl.style.color = '#92400e';
          statusEl.style.padding = '4px 12px';
          statusEl.style.borderRadius = '6px';
          statusEl.style.fontSize = '13px';
          statusEl.style.fontWeight = '600';
        }
      }
      
      // Header-level extra fields
      // CRITICAL: Use buildAddress utility to filter out placeholder text
      let displayDeliveryAddress = "-";
      if (demandData.deliveryAddress) {
        // If deliveryAddress is a string, try to parse it or use as-is
        if (typeof demandData.deliveryAddress === 'string') {
          // Use buildAddress utility to filter placeholders
          displayDeliveryAddress = buildAddress({ sokak: demandData.deliveryAddress });
          // If buildAddress didn't help (returns default), use original but filter common placeholders
          if (displayDeliveryAddress === 'T√ºrkiye' || displayDeliveryAddress.includes('se√ßiniz')) {
            // Manually filter placeholder text
            const filtered = demandData.deliveryAddress
              .replace(/\s*Sokak\/Cadde se√ßiniz\s*/gi, '')
              .replace(/\s*se√ßiniz\s*/gi, '')
              .trim();
            displayDeliveryAddress = filtered || "-";
          }
        } else if (typeof demandData.deliveryAddress === 'object') {
          // If it's an object with address parts, use buildAddress
          displayDeliveryAddress = buildAddress(demandData.deliveryAddress);
        }
      } else if (demandData.deliveryLocation) {
        // Same treatment for deliveryLocation
        if (typeof demandData.deliveryLocation === 'string') {
          const filtered = demandData.deliveryLocation
            .replace(/\s*Sokak\/Cadde se√ßiniz\s*/gi, '')
            .replace(/\s*se√ßiniz\s*/gi, '')
            .trim();
          displayDeliveryAddress = filtered || "-";
        } else if (typeof demandData.deliveryLocation === 'object') {
          displayDeliveryAddress = buildAddress(demandData.deliveryLocation);
        }
      }
      setText("#d-delivery-address", displayDeliveryAddress);
      setText("#d-delivery-method", demandData.deliveryMethod || "-");
      
      // Same for delivery-location
      let displayDeliveryLocation = "-";
      if (demandData.deliveryLocation) {
        if (typeof demandData.deliveryLocation === 'string') {
          const filtered = demandData.deliveryLocation
            .replace(/\s*Sokak\/Cadde se√ßiniz\s*/gi, '')
            .replace(/\s*se√ßiniz\s*/gi, '')
            .trim();
          displayDeliveryLocation = filtered || "-";
        } else if (typeof demandData.deliveryLocation === 'object') {
          displayDeliveryLocation = buildAddress(demandData.deliveryLocation);
        }
      }
      setText("#d-delivery-location", displayDeliveryLocation);
      // Removed ≈üehir field as requested
      setText("#d-purchase-location", demandData.purchaseLocation || "-");
      // Talep Eden: Creator's company name (not personal name)
      setText("#d-requester", demandData.creatorCompanyName || demandData.requester || "-");
      setText("#d-approver", demandData.approver || "-");
      setText("#d-purchase-manager", demandData.purchaseManager || "-");
      setText("#d-general-manager", demandData.generalManager || "-");
      setText("#d-payment-terms", demandData.paymentTerms || "-");
      setText("#d-currency", demandData.currency || "-");

      // Sent date (only if published)
      const sentAtContainer = document.getElementById("sentAtContainer");
      const sentAtEl = document.getElementById("sentAt");
      if (isPublished && demandData.sentAt) {
        sentAtContainer.style.display = "block";
        const sentDate = demandData.sentAt.toDate();
        sentAtEl.textContent = sentDate.toLocaleDateString("tr-TR") + " " + sentDate.toLocaleTimeString("tr-TR");
      } else {
        sentAtContainer.style.display = "none";
      }

      // CRITICAL FIX: Categories - use categoryIds first, then categoryTags, then legacy fields
      const catSet = new Set();
      
      // Priority 1: categoryIds (new ID-based system)
      if (Array.isArray(demandData.categoryIds) && demandData.categoryIds.length > 0) {
        demandData.categoryIds.forEach(catId => {
          if (catId) {
            const displayName = categoryToDisplayName(catId);
            if (displayName) catSet.add(displayName);
          }
        });
      }
      
      // Priority 2: categoryTags (slug format - convert to names)
      if (Array.isArray(demandData.categoryTags) && demandData.categoryTags.length > 0) {
        demandData.categoryTags.forEach(catTag => {
          if (catTag) {
            const displayName = categoryToDisplayName(catTag);
            if (displayName) catSet.add(displayName);
          }
        });
      }
      
      // Priority 3: Legacy fields
      if (demandData.customCategory) {
        const displayName = categoryToDisplayName(demandData.customCategory);
        if (displayName) catSet.add(displayName);
      }
      (Array.isArray(demandData.categories) ? demandData.categories : []).forEach(c => {
        if (c) {
          const displayName = categoryToDisplayName(c);
          if (displayName) catSet.add(displayName);
        }
      });
      if (typeof demandData.category === "string" && demandData.category.trim()) {
        const displayName = categoryToDisplayName(demandData.category.trim());
        if (displayName) catSet.add(displayName);
      }

      const catBox = document.querySelector("#d-cats");
      const cats = [...catSet];
      catBox.innerHTML = cats.length
        ? cats.map(c => `<span class="badge">${c}</span>`).join(" ")
        : "<span class='text-muted'>Kategori belirtilmemi≈ü</span>";

      const specEl = document.getElementById("spec");
      if (specEl) specEl.textContent = demandData.spec || demandData.aciklama || "-";
      
      // Render bidding mode info
      renderBiddingModeInfo();
      
      // Initialize tooltips
      initTooltips();
      
      logger.info("Talep detaylarƒ± render edildi", {
        title: demandData.title || demandData.talep_konusu,
        stfNo: demandData.stfNo || demandData.stf_no,
        demandCode: demandData.demandCode || demandData.talep_kodu,
        itemsCount: demandData.items ? demandData.items.length : 0
      });
    }

    // Create product bid forms
    function createProductBidForms() {
      const container = document.getElementById('product-bid-forms');
      if (!container) return;
      
      container.innerHTML = '';
      
      // Items verisi itemsData'dan geliyor (loadItems'da y√ºklenen)
      if (!itemsData || itemsData.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">Bu talep i√ßin √ºr√ºn bilgisi bulunamadƒ±.</p>';
        return;
      }
      
      logger.info(`üì¶ ${itemsData.length} adet √ºr√ºn i√ßin teklif formu olu≈üturuluyor`);
      
      itemsData.forEach((item, index) => {
        const formDiv = document.createElement('div');
        formDiv.className = 'product-bid-form';
        formDiv.style.cssText = 'margin: 20px 0; padding: 20px; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);';
        
        const featuresHtml = Array.isArray(item.featuresPairs) && item.featuresPairs.length
          ? `<div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;">${item.featuresPairs.map(t=>`<span style=\"background:#f3f4f6;color:#374151;border:1px solid #e5e7eb;padding:2px 8px;border-radius:12px;font-size:12px;\">${t}</span>`).join('')}</div>`
          : '';
        const altGlobal = (document.getElementById('acceptAlternatives')?.value || '') === 'E';

        formDiv.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0;">
                <h4 style="margin: 0; color: #1e293b;">
                  üìù Talep Kalemi ${index + 1}: ${item.name || '√úr√ºn A√ßƒ±klamasƒ±'}
                </h4>
                <div style="font-size: 12px; color: #64748b;">
                  Sƒ±ra No: ${item.lineNo || index + 1} | Malzeme Kodu: ${item.sku || '-'}
                </div>
              </div>
          
          <!-- Talep Bilgisi (sabit, deƒüi≈ütirilemez) -->
          <div style="font-weight:600;color:#1e40af;margin:8px 0 6px 0;display:flex;align-items:center;gap:8px;">
            <span>üìã Talep Bilgisi</span>
            <span style="font-size:12px;color:#6b7280;">(sabit)</span>
          </div>
          <div style="border: 1px solid #d1d5db; border-radius: 8px; overflow: hidden;">
            <div style="background: #f3f4f6; padding: 12px; border-bottom: 1px solid #d1d5db;">
              <div style="display: grid; grid-template-columns: 60px 1fr 100px 100px 120px 120px; gap: 12px; font-weight: 600; font-size: 13px;">
                <div>NO</div>
                <div>√úR√úN ƒ∞SMƒ∞</div>
                <div>Mƒ∞KTAR</div>
                <div>Bƒ∞Rƒ∞M</div>
                <div>Bƒ∞Rƒ∞M Fƒ∞YAT</div>
                <div>TOPLAM (TL)</div>
              </div>
            </div>
            
            <!-- √úr√ºn Bilgileri (talep) -->
            <div style="padding: 16px; background: white;">
              <div style="display: grid; grid-template-columns: 60px 1fr 100px 100px 120px 120px; gap: 12px; align-items: center;">
                <!-- Sƒ±ra No -->
                <div style="font-weight: 600; color: #374151; text-align: center;">
                  ${index + 1}
                </div>
                
                <!-- √úr√ºn ƒ∞smi (talep) -->
                    <div style="padding: 8px; background: #f9fafb; border-radius: 4px; font-size: 14px;">
                      <strong>${item.name || '√úr√ºn A√ßƒ±klamasƒ±'}</strong>
                      ${item.brandModel ? `<br><span style="color: #64748b; font-size: 12px;">Marka: ${item.brandModel}</span>` : ''}
                      ${item.itemDueDate ? `<br><span style=\"color: #64748b; font-size: 12px;\">Teslim: ${item.itemDueDate}</span>` : ''}
                      ${featuresHtml}
                      ${Array.isArray(item.kaliteSertifika) && item.kaliteSertifika.length ? `<div style=\"margin-top:6px\"><span style=\"font-size:12px;color:#1f2937;font-weight:600\">ƒ∞stenen Sertifikalar:</span> <span style=\"font-size:12px;color:#334155\">${item.kaliteSertifika.join(', ')}</span></div>` : ''}
                    </div>
                
                <!-- Miktar (talep) -->
                <div style="text-align:center; font-weight:600; color:#111827;">${item.qty ?? '-'}
                  <div style="font-size:12px;color:#6b7280;margin-top:4px;">Talep edilen</div>
                </div>
                
                <!-- Birim (talep) -->
                <div style="text-transform:capitalize; font-weight:600; color:#111827; text-align:center;">${item.unit || '-'}</div>
                
                <!-- Birim Fiyat (header, teklife g√∂re canlƒ±) -->
                <div style="text-align:center; color:#0f172a;">
                  <span data-product-index="${index}" data-field="hdrUnitPrice">‚Äî</span>
                  <div style="font-size:11px;color:#6b7280">KDV Hari√ß</div>
                  ${item.targetUnitPrice || item.targetPrice ? `<div style=\"font-size:11px;color:#6b7280\">Hedef: ${(item.targetUnitPrice||item.targetPrice)}</div>` : ''}
                </div>
                
                <!-- Toplam (header, teklife g√∂re canlƒ±) -->
                <div style="text-align: center; font-weight: 700; color: #059669; font-size: 16px;">
                  <span data-product-index="${index}" data-field="hdrTotal">‚Äî</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Tek satƒ±rda teklif alanlarƒ± -->
          <div style="padding:12px 16px; background:#fafafa; border:1px solid #e5e7eb; border-radius:8px; margin-top:8px; display:grid; grid-template-columns: minmax(320px,1.6fr) 120px 140px 140px 140px 180px 140px; gap:12px; align-items:center;">
            <div>
              <label style="font-size:13px;color:#1d4ed8;font-weight:700;">Teklif Edilen Malzeme Tanƒ±mƒ±</label>
              <input data-product-index="${index}" data-field="offerDescription" value="${(item.name || '').replace(/"/g,'&quot;')}" 
                     style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;" />
              <div style="font-size:12px;color:#6b7280;margin-top:4px;">Talep edilen: <em>${item.name || '-'}</em></div>
            </div>
            <div>
              <label style="font-size:12px;color:#1d4ed8;font-weight:700;">Miktar</label>
              <input type="number" step="0.01" min="0" placeholder="Miktar" required 
                     data-product-index="${index}" data-field="quantity" 
                     value="${item.qty || ''}" 
                     style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" />
            </div>
            <div>
              <label style="font-size:12px;color:#1d4ed8;font-weight:700;">Birim</label>
              <select required data-product-index="${index}" data-field="unit"
                      style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                <option value="">Se√ßiniz</option>
                <!-- Talep olu≈ütururken se√ßilen birim (default ve g√∂r√ºn√ºr) -->
                ${item.unit ? `<option value="${item.unit}" selected>${item.unit.charAt(0).toUpperCase() + item.unit.slice(1)} (Talep: ${item.unit})</option>` : ''}
                <!-- T√ºm standart birimler (talep olu≈üturma ekranƒ±ndaki t√ºm birimler) -->
                <optgroup label="Standart Birimler">
                  <option value="adet" ${!item.unit || item.unit === 'adet' ? 'selected' : ''}>Adet</option>
                  <option value="paket" ${item.unit === 'paket' ? 'selected' : ''}>Paket</option>
                  <option value="kutu" ${item.unit === 'kutu' ? 'selected' : ''}>Kutu</option>
                  <option value="koli" ${item.unit === 'koli' ? 'selected' : ''}>Koli</option>
                  <option value="set" ${item.unit === 'set' ? 'selected' : ''}>Set</option>
                  <option value="√ßift" ${item.unit === '√ßift' ? 'selected' : ''}>√áift</option>
                  <option value="par√ßa" ${item.unit === 'par√ßa' ? 'selected' : ''}>Par√ßa</option>
                  <option value="takƒ±m" ${item.unit === 'takƒ±m' ? 'selected' : ''}>Takƒ±m</option>
                  <option value="√ßar≈üaf" ${item.unit === '√ßar≈üaf' ? 'selected' : ''}>√áar≈üaf</option>
                  <option value="d√ºzine" ${item.unit === 'd√ºzine' ? 'selected' : ''}>D√ºzine</option>
                  <option value="gros" ${item.unit === 'gros' ? 'selected' : ''}>Gros</option>
                </optgroup>
                <optgroup label="Aƒüƒ±rlƒ±k Birimleri">
                  <option value="kg" ${item.unit === 'kg' ? 'selected' : ''}>Kg</option>
                  <option value="g" ${item.unit === 'g' ? 'selected' : ''}>Gram (g)</option>
                  <option value="ton" ${item.unit === 'ton' ? 'selected' : ''}>Ton</option>
                </optgroup>
                <optgroup label="Uzunluk Birimleri">
                  <option value="metre" ${item.unit === 'metre' ? 'selected' : ''}>Metre (m)</option>
                  <option value="cm" ${item.unit === 'cm' ? 'selected' : ''}>Santimetre (cm)</option>
                  <option value="mm" ${item.unit === 'mm' ? 'selected' : ''}>Milimetre (mm)</option>
                </optgroup>
                <optgroup label="Alan/Hacim Birimleri">
                  <option value="metrekare" ${item.unit === 'metrekare' ? 'selected' : ''}>Metrekare (m¬≤)</option>
                  <option value="m¬≤" ${item.unit === 'm¬≤' ? 'selected' : ''}>m¬≤</option>
                  <option value="metrekup" ${item.unit === 'metrekup' ? 'selected' : ''}>Metrek√ºp (m¬≥)</option>
                  <option value="m¬≥" ${item.unit === 'm¬≥' ? 'selected' : ''}>m¬≥</option>
                </optgroup>
                <optgroup label="Hacim Birimleri (Sƒ±vƒ±)">
                  <option value="litre" ${item.unit === 'litre' ? 'selected' : ''}>Litre (lt)</option>
                  <option value="lt" ${item.unit === 'lt' ? 'selected' : ''}>Litre (lt)</option>
                  <option value="ml" ${item.unit === 'ml' ? 'selected' : ''}>Mililitre (ml)</option>
                </optgroup>
                <optgroup label="√ñzel Birimler">
                  <option value="rulo" ${item.unit === 'rulo' ? 'selected' : ''}>Rulo</option>
                  <option value="sac" ${item.unit === 'sac' ? 'selected' : ''}>Sac</option>
                  <option value="tabaka" ${item.unit === 'tabaka' ? 'selected' : ''}>Tabaka</option>
                  <option value="sheet" ${item.unit === 'sheet' ? 'selected' : ''}>Sheet</option>
                  <option value="kangal" ${item.unit === 'kangal' ? 'selected' : ''}>Kangal</option>
                  <option value="varil" ${item.unit === 'varil' ? 'selected' : ''}>Varil</option>
                  <option value="kova" ${item.unit === 'kova' ? 'selected' : ''}>Kova</option>
                  <option value="bidon" ${item.unit === 'bidon' ? 'selected' : ''}>Bidon</option>
                  <option value="kase" ${item.unit === 'kase' ? 'selected' : ''}>Kase</option>
                  <option value="torba" ${item.unit === 'torba' ? 'selected' : ''}>Torba</option>
                  <option value="palet" ${item.unit === 'palet' ? 'selected' : ''}>Palet</option>
                  <option value="rol" ${item.unit === 'rol' ? 'selected' : ''}>Rol</option>
                  <option value="top" ${item.unit === 'top' ? 'selected' : ''}>Top</option>
                  <option value="yumak" ${item.unit === 'yumak' ? 'selected' : ''}>Yumak</option>
                </optgroup>
              </select>
              ${item.unit ? `<div style="font-size:11px;color:#059669;margin-top:4px;">‚úì Talep edilen birim: <strong>${item.unit}</strong></div>` : ''}
            </div>
            <div>
              <label style="font-size:12px;color:#1d4ed8;font-weight:700;">Birim Fiyat (KDV Hari√ß)</label>
              <input type="text" inputmode="decimal" placeholder="KDV Hari√ß 0,00" required 
                     data-product-index="${index}" data-field="unitPrice" 
                     style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" />
            </div>
            <div style="text-align: right; font-weight: 600; color: #059669; font-size: 14px;">
              <div style="font-size:12px;color:#1d4ed8;font-weight:700;">Toplam (TL)</div>
              <span data-product-index="${index}" data-field="totalPrice">-</span>
            </div>
            <div>
              <label style="font-size:12px;color:#1d4ed8;font-weight:700;">Teslim Tarihi</label>
              <input type="date" data-product-index="${index}" data-field="deliveryDate" style="padding:6px;border:1px solid #d1d5db;border-radius:6px;" />
            </div>
            <div>
              <label style="font-size:12px;color:#1d4ed8;font-weight:700;">Para Birimi</label>
              <select data-product-index="${index}" data-field="currency" style="padding:6px;border:1px solid #d1d5db;border-radius:6px;">
                <option value="TRY">TRY</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="GBP">GBP</option>
              </select>
            </div>
          </div>

          <!-- ƒ∞skontolar ve Net Fiyat -->
          <div class="subcard-alt" style="margin:16px 0;">
            <div style="font-size:14px;font-weight:600;color:#1e40af;margin-bottom:8px;">ƒ∞skontolar (opsiyonel)</div>
            <div style="display:grid; grid-template-columns: repeat(5, 80px) 1fr auto; gap: 8px; align-items:center;">
              <input type="number" step="0.01" min="0" max="100" placeholder="%1" data-product-index="${index}" data-field="discount1" style="width:80px; padding:6px; border:1px solid #d1d5db; border-radius:4px;" />
              <input type="number" step="0.01" min="0" max="100" placeholder="%2" data-product-index="${index}" data-field="discount2" style="width:80px; padding:6px; border:1px solid #d1d5db; border-radius:4px;" />
              <input type="number" step="0.01" min="0" max="100" placeholder="%3" data-product-index="${index}" data-field="discount3" style="width:80px; padding:6px; border:1px solid #d1d5db; border-radius:4px;" />
              <input type="number" step="0.01" min="0" max="100" placeholder="%4" data-product-index="${index}" data-field="discount4" style="width:80px; padding:6px; border:1px solid #d1d5db; border-radius:4px;" />
              <input type="number" step="0.01" min="0" max="100" placeholder="%5" data-product-index="${index}" data-field="discount5" style="width:80px; padding:6px; border:1px solid #d1d5db; border-radius:4px;" />
              <div style="display:flex; align-items:center; gap:8px;">
              <label class="field-label">KDV (%)</label>
                <select required data-product-index="${index}" data-field="vatRate" class="select-sm">
                  <option value="" selected>Se√ßiniz</option>
                  ${[0,1,8,10,18,20].map(v=>`<option value="${v}">${v}</option>`).join('')}
                </select>
              </div>
              <div style="text-align:right; white-space:nowrap;">
                <div><span style="font-size:14px;font-weight:700;margin-right:8px;color:#065f46;">Birim Fiyat (KDV Dahil):</span><strong data-product-index="${index}" data-field="netPrice" style="font-size:18px;color:#059669">-</strong></div>
                <div style="margin-top:6px;"><span style="font-size:13px;color:#1f2937;margin-right:8px;font-weight:700;">KDV Dahil Toplam:</span><strong data-product-index="${index}" data-field="totalWithVat" style="font-size:18px;color:#1d4ed8">-</strong></div>
              </div>
            </div>
          </div>

          <!-- Kalite / Sertifika (kalem bazlƒ±) ve G√∂rsel/Not -->
          <div style="margin-top:12px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div>
              <label class="field-label" style="display:inline-flex;align-items:center;gap:8px;font-weight:600;">
                <input type="checkbox" class="toggle-check" data-product-index="${index}" data-toggle="cert" style="width:14px;height:14px;"> Kalite / Sertifika
              </label>
              <div data-product-index="${index}" data-section="cert" class="subcard-alt" style="display:none; margin-top:6px;">
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                  <input data-product-index="${index}" data-field="certInput" placeholder="√ñrn. ISO 9001" class="control-sm">
                  <button type="button" class="btn btn-outline btn-sm btn-add-cert" data-index="${index}">Ekle</button>
                  <div data-product-index="${index}" data-field="certChips" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
                </div>
              </div>
            </div>
            <div>
              <label class="field-label" style="display:inline-flex;align-items:center;gap:8px;font-weight:600;">
                <input type="checkbox" class="toggle-check" data-product-index="${index}" data-toggle="note" style="width:14px;height:14px;"> √úr√ºn G√∂rseli (URL) & Ek A√ßƒ±klama
              </label>
              <div data-product-index="${index}" data-section="note" class="subcard-alt" style="display:none; margin-top:6px;">
                <div style="display:flex; gap:6px; align-items:center;">
                  <input data-product-index="${index}" data-field="imageUrl" placeholder="https://..." class="control-sm" style="flex:1;margin-top:0;">
                  <button type="button" class="btn btn-outline btn-sm btn-upload-image" data-index="${index}">Y√ºkle</button>
                  <input type="file" accept="image/*" data-product-index="${index}" data-field="imageFile" style="display:none;">
                </div>
                <textarea data-product-index="${index}" data-field="itemNote" rows="4" placeholder="Ek a√ßƒ±klama..." class="control-sm" style="margin-top:8px;resize:vertical;font-size:14px;min-height:96px;"></textarea>
              </div>
            </div>
          </div>
        `;
        
        container.appendChild(formDiv);
      });
      
      // Add event listeners for price calculations
      addProductFormEventListeners();
    }
    
    // Add event listeners for product forms
    function addProductFormEventListeners() {
      const container = document.getElementById('product-bid-forms');
      if (!container) return;
      function updateFxPanelVisibility(){
        const fxPanel = document.getElementById('fxPanel');
        if (!fxPanel) return;
        const hasNonTry = Array.from(container.querySelectorAll('[data-field="currency"]'))
          .some(sel => (sel.value || 'TRY') !== 'TRY');
        fxPanel.style.display = hasNonTry ? '' : 'none';
      }
      
      // Normalize decimal inputs and listen for changes in price-related fields
      container.addEventListener('input', function(e) {
        if (e.target.hasAttribute('data-product-index')) {
          // Normalize Birim Fiyat: accept both comma and dot decimals, strip thousands
          if (e.target.getAttribute('data-field') === 'unitPrice') {
            e.target.value = normalizeDecimalString(e.target.value);
          }
          const productIndex = e.target.getAttribute('data-product-index');
          calculateProductNetPrice(productIndex);
        }
      });
      // Also listen for select changes (e.g. KDV)
      container.addEventListener('change', function(e) {
        if (e.target.classList && e.target.classList.contains('toggle-check')){
          const idx = e.target.getAttribute('data-product-index');
          const which = e.target.getAttribute('data-toggle');
          const section = container.querySelector(`[data-section="${which}"][data-product-index="${idx}"]`);
          if (section) section.style.display = e.target.checked ? 'block' : 'none';
          return;
        }
        if (e.target.hasAttribute('data-product-index')) {
          if (e.target.getAttribute('data-field') === 'currency') {
            updateFxPanelVisibility();
          }
          const productIndex = e.target.getAttribute('data-product-index');
          calculateProductNetPrice(productIndex);
        }
      });

      // initial
      updateFxPanelVisibility();

      // Image upload buttons
      container.addEventListener('click', async function(e){
        const btn = e.target.closest('.btn-upload-image');
        if (!btn) return;
        const idx = btn.getAttribute('data-index');
        const fileInput = container.querySelector(`[data-field="imageFile"][data-product-index="${idx}"]`);
        if (fileInput) fileInput.click();
      });
      container.addEventListener('change', async function(e){
        const fileEl = e.target.closest('input[type="file"][data-field="imageFile"]');
        if (!fileEl) return;
        const idx = fileEl.getAttribute('data-product-index');
        const file = fileEl.files?.[0];
        if (!file) return;
        try{
          const path = `bids-temp/${user.uid}/${demandId}/item-${idx}-${Date.now()}-${file.name}`;
          const r = ref(storage, path);
          await uploadBytes(r, file, { contentType: file.type || 'image/*' });
          const url = await getDownloadURL(r);
          const urlInput = container.querySelector(`[data-field="imageUrl"][data-product-index="${idx}"]`);
          if (urlInput) urlInput.value = url;
          toast.success(MESSAGES.SUCCESS_IMAGE_UPLOADED);
        }catch(err){
          logger.error('image upload error', err);
          toast.error(MESSAGES.ERROR_IMAGE_UPLOAD + ': ' + (err?.message || err));
        }finally{
          fileEl.value = '';
        }
      });

      // Sertifika ekleme/silme (delegation)
      container.addEventListener('click', function(e){
        const addBtn = e.target.closest('.btn-add-cert');
        if (addBtn){
          const idx = addBtn.getAttribute('data-index');
          const formDiv = container.children[idx];
          if (!formDiv) return;
          const input = formDiv.querySelector('[data-field="certInput"]');
          const chips = formDiv.querySelector('[data-field="certChips"]');
          const val = (input?.value || '').trim();
          if (!val) return;
          const chip = document.createElement('span');
          chip.className = 'cert-chip';
          chip.style.cssText = 'display:inline-flex;align-items:center;gap:6px;background:#2563EB;color:#fff;border:1px solid #1E40AF;border-radius:14px;padding:2px 8px;font-size:12px;';
          chip.innerHTML = `${val} <button type=\"button\" class=\"btn-del-cert\" aria-label=\"Sil\" style=\"display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.6);color:#dc2626;cursor:pointer;font-size:14px;line-height:1;font-weight:800;\">√ó</button>`;
          chips?.appendChild(chip);
          input.value = '';
        }
        const delBtn = e.target.closest('.btn-del-cert');
        if (delBtn){ delBtn.parentElement?.remove(); }
      });
    }

    // Accept comma or dot as decimal separator; remove thousands separators
    function normalizeDecimalString(val){
      if (val == null) return '';
      let s = String(val).replace(/\s+/g,'').replace(/[^0-9.,-]/g,'');
      const hasComma = s.includes(',');
      const hasDot = s.includes('.');
      if (hasComma && hasDot) {
        const lastSepIndex = Math.max(s.lastIndexOf(','), s.lastIndexOf('.'));
        const intPart = s.slice(0, lastSepIndex).replace(/[.,]/g, '');
        const fracPart = s.slice(lastSepIndex + 1).replace(/[.,]/g, '');
        return (intPart || '0') + (fracPart ? '.' + fracPart : '');
      } else if (hasComma) {
        return s.replace(/\./g,'').replace(',', '.');
      } else {
        return s.replace(/,/g,'');
      }
    }
    
    // Calculate net price for a specific product
    function calculateProductNetPrice(productIndex) {
      const container = document.getElementById('product-bid-forms');
      if (!container) return;
      
      const formDiv = container.children[productIndex];
      if (!formDiv) return;
      
      const unitPrice = parseFloat(formDiv.querySelector(`[data-field="unitPrice"]`).value) || 0;
      const quantity = parseFloat(formDiv.querySelector(`[data-field="quantity"]`).value) || 0;
      const discount1 = parseFloat(formDiv.querySelector(`[data-field="discount1"]`).value) || 0;
      const discount2 = parseFloat(formDiv.querySelector(`[data-field="discount2"]`).value) || 0;
      const discount3 = parseFloat(formDiv.querySelector(`[data-field="discount3"]`).value) || 0;
      const discount4 = parseFloat(formDiv.querySelector(`[data-field="discount4"]`).value) || 0;
      const discount5 = parseFloat(formDiv.querySelector(`[data-field="discount5"]`).value) || 0;
      
      // Calculate net price with discounts
      let netPrice = unitPrice;
      if (discount1 > 0) netPrice = netPrice * (1 - discount1 / 100);
      if (discount2 > 0) netPrice = netPrice * (1 - discount2 / 100);
      if (discount3 > 0) netPrice = netPrice * (1 - discount3 / 100);
      if (discount4 > 0) netPrice = netPrice * (1 - discount4 / 100);
      if (discount5 > 0) netPrice = netPrice * (1 - discount5 / 100);
      
      // Calculate total price
      const totalPrice = netPrice * quantity;
      const vatRate = parseFloat(formDiv.querySelector(`[data-field="vatRate"]`)?.value) || 0;
      const totalWithVat = totalPrice * (1 + (vatRate / 100));
      
      // Update gross per-unit (KDV dahil) display
      const netPriceElement = formDiv.querySelector(`[data-field="netPrice"]`);
      if (netPriceElement) {
        const grossPerUnit = netPrice * (1 + (vatRate/100));
        netPriceElement.textContent = grossPerUnit.toFixed(2);
      }
      
      // Update total price display
      const totalPriceElement = formDiv.querySelector(`[data-field="totalPrice"]`);
      if (totalPriceElement) {
        totalPriceElement.textContent = totalPrice.toFixed(2);
      }
      const totalWithVatEl = formDiv.querySelector(`[data-field="totalWithVat"]`);
      if (totalWithVatEl) {
        totalWithVatEl.textContent = totalWithVat.toFixed(2);
      }

      // Mirror to header cells (Bƒ∞Rƒ∞M Fƒ∞YAT / TOPLAM)
      try {
        const hdrUnit = document.querySelector(`[data-product-index="${productIndex}"][data-field="hdrUnitPrice"]`);
        const hdrTotal = document.querySelector(`[data-product-index="${productIndex}"][data-field="hdrTotal"]`);
        if (hdrUnit) hdrUnit.textContent = unitPrice ? unitPrice.toFixed(2) : '‚Äî';
        if (hdrTotal) hdrTotal.textContent = totalPrice ? totalPrice.toFixed(2) : '‚Äî';
      } catch(_){}
    }

    // 1) RFQ bid formunu √ºst kƒ±sƒ±mda √ºret (genel alanlar)
    function renderGeneralBidForm() {
      const host = document.getElementById('rfq-bid-form-container');
      if (!host) return;

      host.innerHTML = `
        <div class="section-card">
          <div class="section-header">
            <h2>üßæ Genel Teklif Bilgileri</h2>
            <div class="actions"></div>
          </div>

          <div class="row" style="display:grid; grid-template-columns: repeat(2, minmax(220px,1fr)); gap:12px;">
            <div>
              <label>Nakliye T√ºr√º</label>
              <input id="shippingType" list="shippingTypeList" placeholder="√ñrn. Karayolu" />
              <datalist id="shippingTypeList">
                <option value="Karayolu"></option>
                <option value="Denizyolu"></option>
                <option value="Havayolu"></option>
                <option value="Demiryolu"></option>
              </datalist>
            </div>
            <div>
              <label>Nakliye Modu</label>
              <select id="shippingMode">
                <option value="excluded">Nakliye Hari√ß</option>
                <option value="included">Nakliye Dahil</option>
                <option value="custom">√ñzel/Anla≈ümaya G√∂re</option>
              </select>
            </div>
            <div id="pickupDetails" style="display:none;">
              <label>Alƒ±m Yeri / Adres</label>
              <input id="pickupLocation" placeholder="√ñrn. Fabrika/Depo adresi" />
            </div>
            <div>
              <label>Teslim ≈ûekli/Yeri</label>
              <input id="deliveryMethod" placeholder="√ñrn. ≈ûantiye/Depo teslim" />
            </div>
          </div>
          

          

          <!-- Nakliye Detaylarƒ±: sadece 'Nakliye Dahil' ise g√∂r√ºn√ºr -->
          <div id="shippingDetails" class="subcard-alt" style="display:none; margin-top:12px;">
            <div id="shipIncludedInfo" style="margin-bottom:8px; font-size:13px; color:#1f2937; display:none;"></div>
            <div style="display:grid; grid-template-columns: 180px 180px 180px 1fr; gap:12px; align-items:center;">
              <div>
                <label>Sefer Sayƒ±sƒ±</label>
                <input id="vehicleTrips" type="number" min="1" step="1" placeholder="√ñrn. 2" />
              </div>
              <div>
                <label>Teslim Saat Ba≈ülangƒ±√ß</label>
                <input id="deliveryTimeStart" type="time" />
              </div>
              <div>
                <label>Teslim Saat Biti≈ü</label>
                <input id="deliveryTimeEnd" type="time" />
              </div>
              <div>
                <label>Nakliye Notu</label>
                <input id="shippingNotes" placeholder="Ara√ß tipi, y√∂n, ara aktarma vb." />
              </div>
            </div>
            <div id="shippingLine" style="margin-top:12px; padding-top:12px; border-top:1px dashed #e5e7eb; display:none;">
              <div style="font-weight:600; color:#1e40af; margin-bottom:8px;">Nakliye Kalemi</div>
              <div style="display:grid; grid-template-columns: 1.6fr 120px 140px 140px 160px; gap:12px; align-items:center;">
                <div>
                  <label style="font-size:12px;color:#1d4ed8;font-weight:700;">Malzeme Tanƒ±mƒ±</label>
                  <input id="shipLineDesc" value="Nakliye" disabled style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;background:#f3f4f6;" />
                </div>
                <div>
                  <label style="font-size:12px;color:#1d4ed8;font-weight:700;">Miktar</label>
                  <input id="shipLineQty" type="number" min="0" step="0.01" placeholder="Miktar" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;" />
                </div>
                <div>
                  <label style="font-size:12px;color:#1d4ed8;font-weight:700;">Birim</label>
                  <select id="shipLineUnit" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;">
                    <option value="">Se√ßiniz</option>
                    <option value="sefer">Sefer</option>
                    <option value="km">Km</option>
                    <option value="adet">Adet</option>
                  </select>
                </div>
                <div>
                  <label style="font-size:12px;color:#1d4ed8;font-weight:700;">Birim Fiyat (KDV Hari√ß)</label>
                  <input id="shipLineUnitPrice" type="text" inputmode="decimal" placeholder="0,00" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;" />
                </div>
                <div>
                  <label style="font-size:12px;color:#1d4ed8;font-weight:700;">KDV (%)</label>
                  <select id="shipLineVat" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;">
                    <option value="">Se√ßiniz</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="8">8</option>
                    <option value="10">10</option>
                    <option value="18">18</option>
                    <option value="20">20</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Para Birimi ve FX Se√ßiciler + Toplamlar -->
          <div id="fxPanel" class="subcard-alt" style="margin-top:12px;">
            <div class="row" style="display:grid; grid-template-columns: 160px 1fr 160px 1fr 140px 1fr; gap:12px; align-items:center;">
              <label>Para Birimi</label>
              <select id="fxCur" class="select-sm"><option value="TRY">TRY</option><option value="USD">USD</option><option value="EUR">EUR</option></select>
              <label>Kur Baz Tarihi</label>
              <select id="fxBase" class="select-sm"><option value="quote">Teklif Tarihi</option><option value="invoice">Fatura Tarihi</option></select>
              <label>Kaynak</label>
              <select id="fxSource" class="select-sm"><option value="TCMB">TCMB</option><option value="ECB">ECB</option><option value="manual">manual</option></select>
            </div>
            <div class="row" style="display:grid; grid-template-columns: 160px 1fr 160px 1fr; gap:12px; align-items:center; margin-top:8px;">
              <label>Kur Tarihi</label>
              <input id="fxDate" type="date" class="control-sm">
              <label>Manuel Kur</label>
              <input id="fxManual" type="number" step="0.0001" placeholder="√ñrn. 35.1200" class="control-sm hidden">
            </div>
            <div class="totals" style="margin-top:10px;">
              <div><b id="totalPrimaryLabel">Toplam (TL)</b> <span id="totalPrimaryValue">‚Äî</span></div>
              <div id="totalSecondaryRow" class="label" style="margin-top:4px; display:none;">‚âà TL ‚Ä¶</div>
            </div>
          </div>

          <div style="display:flex;justify-content:flex-end;margin-top:8px;">
            <button id="btnOpenPayment" class="btn btn-primary">üí≥ √ñdeme Se√ßenekleri</button>
          </div>

          <div style="margin-top:12px;">
            <label>Notlar</label>
            <textarea id="notes" rows="3" placeholder="Ek bilgi..."></textarea>
          </div>
        </div>

        <div class="section-card">
          <div class="section-header">
            <h2>üíº Teklif Verenin Fiyat Teklifi (Talep Kalemlerine)</h2>
          </div>
          <p class="label" style="margin:4px 0 0 0;">Talep sahibinin √ºr√ºn kalemleri i√ßin, a≈üaƒüƒ±daki alanlarda kendi miktar/birim/birim fiyat ve KDV bilgilerinizi girerek teklifinizi olu≈üturun.</p>
          <div id="product-bid-forms"></div>
        </div>
      `;

      // √úr√ºn kalemleri i√ßin satƒ±r formlarƒ±nƒ± √ºret
      createProductBidForms();

      // En alta g√∂nder butonu
      const sendBar = document.createElement('div');
      sendBar.style.cssText = 'display:flex;justify-content:flex-end;gap:8px;margin-top:16px;';
      sendBar.innerHTML = `
        <button id="btnSubmitBid" class="btn btn-primary">‚úÖ Teklifi G√∂nder</button>
      `;
      host.appendChild(sendBar);

      // G√∂nder butonu -> submitBid()
      document.getElementById('btnSubmitBid')?.addEventListener('click', submitBid);

      // Para birimi artƒ±k satƒ±r bazlƒ± se√ßiliyor

      // Nakliye modu UI
      const shippingModeEl = document.getElementById('shippingMode');
      const shippingDetails = document.getElementById('shippingDetails');
      function updateShippingUI(){
        const inc = shippingModeEl?.value === 'included';
        if (shippingDetails) shippingDetails.style.display = inc ? 'block' : 'none';
        const pickup = document.getElementById('pickupDetails');
        if (pickup) pickup.style.display = (!inc && shippingModeEl?.value==='excluded') ? 'block' : 'none';
        const info = document.getElementById('shipIncludedInfo');
        if (info) {
          info.style.display = inc ? 'block' : 'none';
          if (inc) {
            const addr = (demandData.deliveryAddress || demandData.deliveryLocation || '-');
            info.innerHTML = `<strong>Teslimat Adresi (Alƒ±cƒ±):</strong> ${addr}`;
          }
        }
        const shipLine = document.getElementById('shippingLine');
        if (shipLine) shipLine.style.display = inc ? 'block' : 'none';
      }
      shippingModeEl?.addEventListener('change', updateShippingUI);
      updateShippingUI();

      // =========== FX / Currency ===========
      const fxState = { currency: 'TRY', base: 'quote', source: 'TCMB', at: new Date().toISOString().slice(0,10), pairs: {} };
      const fxCur = document.getElementById('fxCur');
      const fxBase = document.getElementById('fxBase');
      const fxSource = document.getElementById('fxSource');
      const fxDate = document.getElementById('fxDate');
      const fxManual = document.getElementById('fxManual');
      if (fxDate) fxDate.value = fxState.at;

      function fmt(val, cur){
        try { return new Intl.NumberFormat('tr-TR', { style:'currency', currency: cur }).format(val); } catch(_){ return `${(val||0).toFixed(2)} ${cur}`; }
      }
      function sumTotalIncl(){
        let sum = 0;
        document.querySelectorAll('[data-field="totalWithVat"]').forEach(el=>{
          const raw = (el.textContent||'').toString().trim();
          const v = parseFloat(raw.replace(/[^0-9.,-]/g,'').replace(',','.')) || 0;
          sum += v;
        });
        return sum;
      }
      function toTRY(amountIncl, cur){
        if (cur === 'TRY') return amountIncl;
        const k = fxState.pairs[`${cur}TRY`];
        return k ? amountIncl * k : null;
      }
      function renderFX(){
        const cur = fxState.currency;
        const incl = sumTotalIncl();
        const primaryLabel = document.getElementById('totalPrimaryLabel');
        const primaryVal = document.getElementById('totalPrimaryValue');
        const secondaryRow = document.getElementById('totalSecondaryRow');
        if (primaryLabel) primaryLabel.textContent = `Toplam (${cur})`;
        if (primaryVal) primaryVal.textContent = fmt(incl, cur);
        if (secondaryRow){
          if (cur !== 'TRY'){
            const tl = toTRY(incl, cur);
            secondaryRow.style.display = tl ? '' : 'none';
            if (tl){
              const pair = `${cur}TRY`;
              secondaryRow.textContent = `‚âà ${fmt(tl,'TRY')} (Kur: ${fxState.pairs[pair]} ‚Äî ${new Date(fxState.at).toLocaleDateString('tr-TR')}, ${fxState.source})`;
            }
          } else {
            secondaryRow.style.display = 'none';
          }
        }
      }
      fxCur?.addEventListener('change', e=>{ fxState.currency = e.target.value; renderFX(); });
      fxBase?.addEventListener('change', e=>{ fxState.base = e.target.value; renderFX(); });
      fxSource?.addEventListener('change', e=>{ fxState.source = e.target.value; if (fxManual) fxManual.classList.toggle('hidden', fxState.source !== 'manual'); renderFX(); });
      fxDate?.addEventListener('change', e=>{ fxState.at = e.target.value; renderFX(); });
      fxManual?.addEventListener('input', e=>{ const pair = `${fxState.currency}TRY`; const v = Number(e.target.value) || undefined; fxState.pairs[pair] = v; renderFX(); });
      renderFX();
    }

    // Payment modal
    let selectedPaymentPref = null;
    (function setupPaymentModal(){
      const modal = document.createElement('div');
      modal.id = 'paymentModal';
      modal.style.cssText = 'display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1100;';
      modal.innerHTML = `
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:min(900px,96vw); max-height:90vh; overflow:auto; background:#fff; border-radius:8px; padding:16px;">
          <div style="display:flex;justify-content:space-between;align-items:center; margin-bottom:8px;">
            <h3 style="margin:0;">√ñdeme Se√ßenekleri</h3>
            <button id="closePayment" class="btn btn-outline btn-sm" style="padding:4px 8px;">‚úï</button>
          </div>
          <section id="payment-section" class="payment">
            <style>
              .hidden{display:none!important}
              #payment-section .row{display:grid;grid-template-columns:180px 1fr;gap:12px;align-items:center;margin:8px 0}
              #payment-section fieldset{border:1px solid #e5e7eb;border-radius:8px;padding:8px;margin:10px 0}
              #payment-section fieldset legend{font-weight:600}
              #payment-section #payment-type{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:8px 12px;align-items:center}
              #payment-section label{font-size:14px;color:#111827}
              #payment-section #payment-type label{display:inline-flex;align-items:center;gap:8px;margin:0;font-size:16px;font-weight:600}
              #payment-section input[type="radio"]{width:16px;height:16px;accent-color:#2563eb}
              #payment-section h4{margin:8px 0 6px 0}
              #payment-section .group{padding:10px;border:1px solid #f3f4f6;border-radius:8px;background:#fafafa;margin-top:8px}
              #payment-section #pesin-group label{display:inline-flex;align-items:center;gap:8px;margin:4px 12px 4px 0;font-weight:600;font-size:15px}
              #payment-section .desc{font-size:12.5px;color:#4b5563;margin-top:6px;line-height:1.4}
              #payment-section .hint{font-size:12px;color:#6b7280}
              @media (max-width:640px){#payment-section #payment-type{grid-template-columns:repeat(2,minmax(140px,1fr))}}
            </style>
            <h3>√ñdeme Se√ßenekleri</h3>
            <fieldset id="payment-type"><legend>√ñdeme Tipi</legend><label><input type="radio" name="paymentType" value="pesin" /> Pe≈üin</label><label><input type="radio" name="paymentType" value="krediKarti" /> Kredi Kartƒ±</label><label><input type="radio" name="paymentType" value="acikHesap" /> A√ßƒ±k Hesap</label><label><input type="radio" name="paymentType" value="evrak" /> Evrak (√ßek/senet)</label></fieldset>
            <div class="row"><label>KDV Dahil Toplam</label><span id="ccBaseIncl">‚Äî</span></div>
            <div id="pesin-group" class="group hidden"><h4>Pe≈üin Alt Model</h4><label><input type="radio" name="pesinModel" value="escrow"> (a) Escrow</label><label><input type="radio" name="pesinModel" value="onayli"> (b) Teslim & Onay</label><label><input type="radio" name="pesinModel" value="onodeme"> (c) √ñn √ñdeme</label><div class="payment-option-grid"><div class="payment-card" data-model="escrow"><h3>Escrow (Blokeli √ñdeme)</h3><p>√ñdeme Teklifbul hesabƒ±nda blokelenir, alƒ±cƒ± onaylayƒ±nca satƒ±cƒ±ya aktarƒ±lƒ±r.</p></div><div class="payment-card" data-model="onayli"><h3>Teslim & Onay</h3><p>Satƒ±cƒ± √ºr√ºn√º g√∂nderir, alƒ±cƒ± teslim onayƒ± verir, ardƒ±ndan √∂deme yapƒ±lƒ±r.</p></div><div class="payment-card" data-model="onodeme"><h3>√ñn √ñdeme</h3><p>Satƒ±cƒ± √ºretim √∂ncesi kƒ±smi/tam √∂n √∂deme talep eder, ardƒ±ndan sevkiyat ba≈ülar.</p></div></div><div id="prepayment-config" class="row hidden"><label>√ñn √ñdeme Oranƒ± (%)</label><input type="number" id="prepaymentRate" min="0" max="100" step="1" value="30"></div></div>
            <div id="kk-group" class="group hidden"><h4>Kredi Kartƒ±</h4><div class="row"><label>Taksit Sayƒ±sƒ±</label><input id="installments" type="number" min="1" value="1" style="width:100px"><label>Vade Farkƒ± (%)</label><input type="number" id="financeRate" value="0" min="0" step="0.01"><label>Kampanya / A√ßƒ±klama</label><input id="ccCampaign" placeholder="‚Ä¶"></div><div class="row calc"><div>Vade Tutarƒ±: <span id="ccFinanceAmt">‚Äî</span></div><div>Toplam (KDV Dahil): <span id="ccTotalIncl">‚Äî</span></div><div>Aylƒ±k Taksit: <span id="ccMonthly">‚Äî</span></div></div></div>
            <div id="ah-group" class="group hidden"><h4>A√ßƒ±k Hesap</h4><div class="row"><label>Fatura Tarihi</label><input type="date" id="invoiceDate"><label>Vade (G√ºn)</label><select id="netDays"><option value="7">+7 g√ºn</option><option value="15">+15 g√ºn</option><option value="30">+30 g√ºn</option><option value="45">+45 g√ºn</option><option value="60">+60 g√ºn</option></select><input id="netDaysCustom" type="number" min="1" placeholder="√ñzel vade g√ºn√º (√∂rn. 53)" style="width:160px"><span class="hint" style="font-size:13px;">√ñzel vade g√ºn√º yazƒ±nca tarih otomatik hesaplanƒ±r (hafta sonu Pazartesi).</span></div><div class="row calc"><div>Vade Tarihi: <span id="dueDateHuman">‚Äî</span></div></div></div>
            <div id="evrak-group" class="group hidden"><h4>Evrak (√ßek/senet)</h4><div style="margin-bottom:8px;"><button id="btnAddCheck" class="btn btn-secondary" style="padding:6px 10px;">+ √áek Ekle</button></div><div id="checksBody"></div></div>
            <hr><div id="summary" class="summary"></div><button id="savePayment" class="btn btn-primary" style="margin-top:8px;">Kaydet</button>
          </section>
        </div>`;
      document.body.appendChild(modal);
      const closeBtn = modal.querySelector('#closePayment');
      // Robust open handler (works even if button is re-rendered)
      document.addEventListener('click', async (e)=>{
        const openBtn = e.target.closest && e.target.closest('#btnOpenPayment');
        if (!openBtn) return;
        modal.style.display = 'block';
        // Ensure module is loaded
        if (!window.paymentModule) {
          try { await import('/scripts/payment-module.js'); } catch(_) {}
        }
        // Set role + totals (KDV Dahil)
        if (window.paymentModule) {
          window.paymentModule.setRole('seller');
          try {
            // Toplam (KDV Dahil) yakla≈üƒ±k hesap
            const forms = document.querySelectorAll('#product-bid-forms [data-field="unitPrice"]');
            let totalIncl = 0;
            forms.forEach((inp, idx)=>{
              const row = inp.closest('[data-product-index]');
              const qty = parseFloat(row?.querySelector('[data-field="quantity"]')?.value||'0')||0;
              const unit = parseFloat((row?.querySelector('[data-field="unitPrice"]')?.value||'0').toString().replace(',','.'))||0;
              const vat = parseFloat(row?.querySelector('[data-field="vatRate"]')?.value||'20')||20;
              const excl = qty * unit;
              totalIncl += excl * (1 + (vat/100));
            });
            window.paymentModule.setTotals({ totalIncl });
          } catch(_){}
        }
      });
      closeBtn?.addEventListener('click', ()=>{ modal.style.display = 'none'; });
  document.addEventListener('payment:save', (e)=>{ selectedPaymentPref = e.detail; modal.style.display = 'none'; });
    })();

    function bindPaymentUI(){
      // payment program kaldƒ±rƒ±ldƒ±

      function addRow({method='', amount='', days='', note=''}={}){
        const row = document.createElement('div');
        row.className = '';
        row.style.display = 'contents';
        row.innerHTML = `
          <select class="pay-method" style="padding:6px;border:1px solid #d1d5db;border-radius:6px;">
            <option value="">Se√ßiniz</option>
            <option value="Kredi Kartƒ±">Kredi Kartƒ±</option>
            <option value="Pe≈üin">Pe≈üin</option>
            <option value="A√ßƒ±k Hesap +15">A√ßƒ±k Hesap +15</option>
            <option value="A√ßƒ±k Hesap +30">A√ßƒ±k Hesap +30</option>
            <option value="Evrak">Evrak (√ßek/senet)</option>
          </select>
          <input class="pay-amount" placeholder="0,00" inputmode="decimal" style="padding:6px;border:1px solid #d1d5db;border-radius:6px;" value="${amount}">
          <input class="pay-days" type="number" min="0" placeholder="Vade (g√ºn)" style="padding:6px;border:1px solid #d1d5db;border-radius:6px;" value="${days}">
          <input class="pay-note" placeholder="Not" style="padding:6px;border:1px solid #d1d5db;border-radius:6px;" value="${note}">
          <button type="button" class="btn btn-secondary pay-del" aria-label="Sil" style="padding:6px 8px;">‚úï</button>
        `;
        // set selection after insertion
        const sel = row.querySelector('.pay-method');
        if (sel && method) sel.value = method;
        rowsHost.appendChild(row);
      }

      addBtn?.addEventListener('click', () => addRow());
      quickBtn?.addEventListener('click', () => {
        addRow({method:'Evrak', days:'30'});
        addRow({method:'Evrak', days:'60'});
        addRow({method:'Evrak', days:'90'});
      });
      rowsHost?.addEventListener('click', (e)=>{
        const btn = e.target.closest('.pay-del');
        if (!btn) return;
        const row = btn.parentElement;
        row?.remove();
      });

      templateSel?.addEventListener('change', ()=>{
        const v = templateSel.value;
        if (v === 'Evrak 30/60/90') {
          // clear existing rows
          // removed
          quickBtn.click();
        }
      });
    }

    function renderBiddingModeInfo() {
      // Bidding mode (with backward compatibility)
      const mode = demandData.biddingMode || "secret";
      const modeEl = document.getElementById("d-biddingmode");
      const modeLabels = {
        secret: "Gizli Teklif",
        open: "A√ßƒ±k Artƒ±rma",
        hybrid: "Hibrit"
      };
      modeEl.innerHTML = `<span class="badge">${modeLabels[mode] || "Gizli"}</span>`;

      // Current phase
      const phase = demandData.phase || "secret";
      const phaseEl = document.getElementById("d-phase");
      const phaseBadge = phase === "open" 
        ? '<span class="badge" style="background:#10b981;">A√ßƒ±k</span>'
        : '<span class="badge" style="background:#3b82f6;">Gizli</span>';
      phaseEl.innerHTML = phaseBadge;

      // Current round
      const round = demandData.currentRound || 1;
      setText("#d-round", String(round));

      // Countdown timer
      if (demandData.isTimeBound && demandData.phaseEndAt) {
        startCountdown(demandData.phaseEndAt);
      } else {
        stopCountdown();
      }

      // Round 2 transition button (hybrid mode only)
      const round2BtnContainer = document.getElementById("round2BtnContainer");
      if (isOwner && mode === "hybrid" && phase === "secret" && isPublished) {
        const now = new Date();
        const phaseEnd = demandData.phaseEndAt?.toDate?.() || new Date(demandData.phaseEndAt);
        if (now > phaseEnd) {
          round2BtnContainer.style.display = "";
        } else {
          round2BtnContainer.style.display = "none";
        }
      } else {
        round2BtnContainer.style.display = "none";
      }
    }

    function startCountdown(endTimestamp) {
      stopCountdown(); // Clear any existing interval
      
      const countdownContainer = document.getElementById("countdownContainer");
      const countdownEl = document.getElementById("d-countdown");
      countdownContainer.style.display = "block";

      function updateCountdown() {
        const now = new Date();
        const end = endTimestamp.toDate ? endTimestamp.toDate() : new Date(endTimestamp);
        const diff = end - now;

        if (diff <= 0) {
          countdownEl.textContent = "S√ºre Doldu";
          stopCountdown();
          // Reload to update UI
          setTimeout(() => location.reload(), 2000);
          return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        let timeStr = "";
        if (days > 0) timeStr += `${days}g `;
        timeStr += `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        countdownEl.textContent = timeStr;
      }

      updateCountdown();
      countdownInterval = setInterval(updateCountdown, 1000);
    }

    function stopCountdown() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      const countdownContainer = document.getElementById("countdownContainer");
      countdownContainer.style.display = "none";
    }

    // Round 2 transition
    async function transitionToRound2() {
      if (!isOwner) return;
      if (!confirm("2. tura ge√ßmek istediƒüinizden emin misiniz? 1. tur kapanacak ve a√ßƒ±k artƒ±rma ba≈ülayacak.")) return;

      try {
        const round2Start = demandData.round2Start?.toDate?.() || new Date(demandData.round2Start);
        const round2End = demandData.round2End?.toDate?.() || new Date(demandData.round2End);

        await updateDoc(doc(db, "demands", demandId), {
          phase: "open",
          currentRound: 2,
          phaseStartAt: round2Start,
          phaseEndAt: round2End
        });

        toast.success(MESSAGES.SUCCESS_ROUND2_STARTED);
        location.reload();
      } catch (e) {
        logger.error("2. tur ba≈ülatma hatasƒ±", e);
        toast.error(MESSAGES.ERROR_GENERAL + ": " + (e.message || e));
      }
    }

    function updatePublishButtons() {
      if (!btnPublish || !btnUnpublish) return;
      
      // üîí Hide publish buttons if not owner
      if (!isOwner) {
        btnPublish.style.display = "none";
        btnUnpublish.style.display = "none";
        return;
      }
      
      // Show/hide based on published state
      btnPublish.style.display = isPublished ? "none" : "inline-block";
      btnUnpublish.style.display = isPublished ? "inline-block" : "none";
    }

    function updateEditButton() {
      // Edit/Delete sadece taslak + sahip ise
      const showDraftActions = isOwner && !isPublished;
      btnEdit.style.display = showDraftActions ? "inline-block" : "none";
      if (btnDeleteDraft) btnDeleteDraft.style.display = showDraftActions ? "inline-block" : "none";
    }

    // Taslak silme (sahip + yayƒ±nlanmamƒ±≈ü)
    if (btnDeleteDraft) {
      btnDeleteDraft.addEventListener('click', async () => {
        if (!isOwner || isPublished) return;
        if (!confirm('Bu taslak talebi kalƒ±cƒ± olarak silmek istiyor musunuz? Bu i≈ülem geri alƒ±namaz.')) return;
        try {
          // items
          try {
            const itemsSnap = await getDocs(collection(db, 'demands', demandId, 'items'));
            await Promise.all(itemsSnap.docs.map(d => deleteDoc(doc(db, 'demands', demandId, 'items', d.id))));
          } catch(e){ logger.warn('items cleanup warn', e); }
          // bids
          try {
            const bidsSnap = await getDocs(query(collection(db, 'bids'), where('demandId','==', demandId)));
            await Promise.all(bidsSnap.docs.map(d => deleteDoc(doc(db, 'bids', d.id))));
          } catch(e){ logger.warn('bids cleanup warn', e); }
          // recipients
          try {
            const recSnap = await getDocs(query(collection(db, 'demandRecipients'), where('demandId','==', demandId)));
            await Promise.all(recSnap.docs.map(d => deleteDoc(doc(db, 'demandRecipients', d.id))));
          } catch(e){ logger.warn('recipients cleanup warn', e); }
          // main doc
          await deleteDoc(doc(db, 'demands', demandId));
          toast.success(MESSAGES.SUCCESS_DRAFT_DELETED);
          location.href = './demands.html?filter=draft';
        } catch(err){
          logger.error('deleteDraft detail error', err);
          toast.error(MESSAGES.ERROR_DRAFT_DELETE + ': ' + (err.message || err));
        }
      });
    }

    function applyVisibilityRules() {
      if (!isPublished) {
        // DRAFT: hide both bids section and bid form
        hide(bidsSection);
        hide(bidFormSection);
        hide(ownBidSection);
      } else {
        if (isOwner) {
          // PUBLISHED & OWNER: show bids list, hide bid form
          show(bidsSection);
          hide(bidFormSection);
          hide(ownBidSection);
        } else {
          // PUBLISHED & SUPPLIER: hide bids list, show bid form
          hide(bidsSection);
          show(bidFormSection);
          // Show own bid summary (if any)
          loadOwnBid();
          
          // Initialize RFQ Bid Form
          logger.info("RFQ Bid Form initializing");
          initializeRFQBidForm();
        }
      }
    }

    // ====================
    // Initialize RFQ Bid Form
    // ====================
    let rfqBidForm = null;
    
    function initializeRFQBidForm() {
      try {
        const container = document.getElementById('rfq-bid-form-container');
        if (!container) {
          logger.error('RFQ bid form container not found');
          return;
        }
        
        // Clear existing form and render the generic RFQ form with product rows
        container.innerHTML = '';
        renderGeneralBidForm();
        logger.info('RFQ Bid Form (generic) initialized');
      } catch (error) {
        logger.error('Error initializing RFQ Bid Form', error);
        // Show error message
        const container = document.getElementById('rfq-bid-form-container');
        if (container) {
          container.innerHTML = `
            <div style="padding: 20px; text-align: center; color: #dc2626;">
              <h3>‚ùå Teklif Formu Y√ºklenemedi</h3>
              <p>Teklif formu y√ºklenirken bir hata olu≈ütu. L√ºtfen sayfayƒ± yenileyin.</p>
              <button onclick="location.reload()" class="btn btn-primary">Sayfayƒ± Yenile</button>
            </div>
          `;
        }
      }
    }

    // ====================
    // Load current user's own bid for this demand
    // ====================
    async function loadOwnBid() {
      try {
        if (!ownBidSection || !ownBidContent) return;
        // Default hidden; will show if we find a bid or even when none to inform the user
        show(ownBidSection);
        ownBidContent.textContent = "Y√ºkleniyor...";

        let snap;
        try {
          const q1 = query(
            collection(db, 'bids'),
            where('demandId', '==', demandId),
            where('supplierId', '==', user.uid),
            orderBy('createdAt', 'desc'),
            limit(1)
          );
          snap = await getDocs(q1);
        } catch (e) {
          // Fallback without composite index: query by demand and filter in-memory
          logger.warn('Own-bid composite index missing or query failed, falling back', e?.message || e);
          const q2 = query(
            collection(db, 'bids'),
            where('demandId', '==', demandId),
            orderBy('createdAt', 'desc')
          );
          const s2 = await getDocs(q2);
          const docs = s2.docs.filter(d => (d.data()?.supplierId) === user.uid);
          snap = { docs };
        }

        if (!snap.docs.length) {
          ownBidContent.style.color = '#64748b';
          ownBidContent.innerHTML = '<div class="empty-state"><span class="emoji">üí°</span><p>Hen√ºz teklif vermediniz.</p><button class="btn btn-primary" onclick="document.getElementById(\'bid-form-section\').scrollIntoView({behavior:\'smooth\'})">Teklif Ver</button></div>';
          return;
        }

        const b = snap.docs[0].data();
        const currency = b.currency || 'TRY';
        const fmt = (n)=> new Intl.NumberFormat('tr-TR', { maximumFractionDigits: 2 }).format(n);
        const createdAt = b.createdAt?.toDate?.() || (b.createdAt ? new Date(b.createdAt) : null);

        // Calculate totals from items array (new format) or fallback to old fields
        let net = 0;
        let gross = 0;
        let avgVatRate = 0;
        
        if (Array.isArray(b.items) && b.items.length > 0) {
          // New format: calculate from items array
          let totalNet = 0;
          let totalGross = 0;
          let totalVat = 0;
          let itemCount = 0;
          
          b.items.forEach(item => {
            const itemNet = Number(item.totalPrice || item.netPrice || 0);
            const itemGross = Number(item.totalWithVat || (itemNet * (1 + (Number(item.vatRate || 0) / 100))) || 0);
            const itemVatRate = Number(item.vatRate || 0);
            
            totalNet += itemNet;
            totalGross += itemGross;
            totalVat += itemVatRate;
            itemCount++;
          });
          
          net = totalNet;
          gross = totalGross;
          avgVatRate = itemCount > 0 ? totalVat / itemCount : 0;
        } else {
          // Fallback: old format fields
          const vat = Number(b.vatRate ?? b.vat ?? 0);
          net = Number(b.totalAmount ?? b.netPrice ?? b.price ?? 0);
          gross = Number(b.grossPrice ?? (net * (1 + vat/100)));
          avgVatRate = vat;
        }

        // Get brand from items (first item's brand) or fallback
        let brand = b.brand || '‚Äî';
        if (Array.isArray(b.items) && b.items.length > 0) {
          const firstItem = b.items[0];
          brand = firstItem.brand || brand;
        }

        // Get payment terms
        const paymentTerms = b.paymentTerms || b.paymentMethod || 
                           (b.paymentPreference ? JSON.stringify(b.paymentPreference).substring(0, 50) : '‚Äî');

        // Get lead time (average from items or fallback)
        let leadTime = b.leadTimeDays ?? '‚Äî';
        if (Array.isArray(b.items) && b.items.length > 0) {
          const leadTimes = b.items.map(item => Number(item.leadTimeDays || item.leadTime || 0)).filter(t => t > 0);
          if (leadTimes.length > 0) {
            const avgLeadTime = Math.round(leadTimes.reduce((a, b) => a + b, 0) / leadTimes.length);
            leadTime = avgLeadTime > 0 ? avgLeadTime : '‚Äî';
          }
        }

        ownBidContent.style.color = '#0f172a';
        ownBidContent.innerHTML = `
          <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center;">
            <div><strong>Net:</strong> ${fmt(net)} ${currency}</div>
            <div><strong>KDV:</strong> %${fmt(avgVatRate)}</div>
            <div><strong>Br√ºt:</strong> ${fmt(gross)} ${currency}</div>
            <div><strong>Marka:</strong> ${brand}</div>
            <div><strong>√ñdeme:</strong> ${paymentTerms}</div>
            <div><strong>Termin:</strong> ${leadTime} ${typeof leadTime === 'number' ? 'g√ºn' : ''}</div>
            <div><strong>Tarih:</strong> ${createdAt ? createdAt.toLocaleDateString('tr-TR') : '‚Äî'}</div>
            <div><strong>Durum:</strong> ${(b.status || 'sent')}</div>
          </div>
          ${Array.isArray(b.items) && b.items.length > 0 ? `<div style="margin-top:12px; font-size:12px; color:#64748b;">${b.items.length} kalem √ºr√ºn teklifi</div>` : ''}
        `;
      } catch (err) {
        logger.error('loadOwnBid error', err);
        if (ownBidSection && ownBidContent) {
          show(ownBidSection);
          ownBidContent.style.color = '#b91c1c';
          ownBidContent.textContent = 'Kendi teklif bilgisi y√ºklenemedi.';
        }
      }
    }

    // ====================
    // Load Items
    // ====================
    async function loadItems() {
      try {
        // √ñnce subcollection'dan items'larƒ± √ßekmeyi dene (yeni yapƒ±)
      try {
        const q = query(collection(db, "demands", demandId, "items"), orderBy("lineNo", "asc"));
        const snap = await getDocs(q);
          if (snap.docs.length > 0) {
        itemsData = snap.docs.map(d => {
          const data = { id: d.id, ...d.data() };
          // Map legacy object features ‚Üí pairs
          try {
            const f = data.features || (data.featuresJson ? JSON.parse(data.featuresJson) : null);
            if (f && typeof f === 'object') {
              data.featuresPairs = Object.entries(f).filter(([k,v])=>k && v).map(([k,v])=>`${k}: ${v}`);
            }
          } catch {}
          // Map new ozellikler (array of {key,value}) ‚Üí pairs
          try {
            if (Array.isArray(data.ozellikler)) {
              const clean = data.ozellikler.filter(p => (p?.key||'').trim() || (p?.value||'').trim());
              const pairs = clean.map(p => `${p.key}: ${p.value}`);
              data.featuresPairs = (data.featuresPairs || []).concat(pairs);
            }
          } catch {}
          // Certificates (kaliteSertifika)
          try {
            if (Array.isArray(data.kaliteSertifika)) {
              data.requiredCerts = data.kaliteSertifika.filter(Boolean);
            }
          } catch {}
          return data;
        });
            logger.info(`Subcollection'dan ${itemsData.length} adet √ºr√ºn kalemi y√ºklendi`);
          } else {
            throw new Error("Subcollection empty");
          }
        } catch (subcollectionError) {
          logger.info("Subcollection'dan y√ºklenemedi, main document'teki items array'ini kontrol ediliyor");
          
          // Fallback: main document'teki items array'ini kontrol et
          if (demandData && demandData.items && Array.isArray(demandData.items)) {
            itemsData = demandData.items.map((item, index) => {
              const out = {
                id: `item_${index}`,
                lineNo: item.no || item.lineNo || index + 1,
                sku: item.sku || item.materialCode || "-",
                name: item.name || item.description || "-",
                brandModel: item.brand || item.brandModel || "-",
                qty: item.qty || item.quantity || 0,
                unit: item.unit || "-",
                itemDueDate: item.req_date || item.deliveryDate || item.itemDueDate || "-",
                altAcceptVal: item.altAcceptVal
              };
              try {
                const f = item.features || (item.featuresJson ? JSON.parse(item.featuresJson) : null);
                if (f && typeof f === 'object') {
                  out.featuresPairs = Object.entries(f).filter(([k,v])=>k && v).map(([k,v])=>`${k}: ${v}`);
                }
              } catch {}
              // Map new ozellikler
              try {
                if (Array.isArray(item.ozellikler)) {
                  const clean = item.ozellikler.filter(p => (p?.key||'').trim() || (p?.value||'').trim());
                  const pairs = clean.map(p => `${p.key}: ${p.value}`);
                  out.featuresPairs = (out.featuresPairs || []).concat(pairs);
                }
                if (Array.isArray(item.kaliteSertifika)) {
                  out.requiredCerts = item.kaliteSertifika.filter(Boolean);
                }
              } catch {}
              return out;
            });
            logger.info(`Main document'ten ${itemsData.length} adet √ºr√ºn kalemi y√ºklendi`);
          } else {
            logger.info("Main document'te de items bulunamadƒ±");
            itemsData = [];
          }
        }
        
        setText("#d-itemcount", String(itemsData.length));
        
        itemsBody.innerHTML = "";
        itemsData.forEach(item => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.lineNo || "-"}</td>
            <td>${item.sku || "-"}</td>
            <td>${item.name || "-"}</td>
            <td>${item.brandModel || "-"}</td>
            <td>${item.qty ?? "-"}</td>
            <td>${item.unit || "-"}</td>
            <td>${item.itemDueDate || "-"}</td>
          `;
          itemsBody.appendChild(tr);
        });
        
        logger.info(`Toplam ${itemsData.length} adet √ºr√ºn kalemi render edildi`);
      } catch (e) {
        logger.error("Kalemler y√ºklenemedi", e);
        itemsData = [];
        setText("#d-itemcount", "0");
        itemsBody.innerHTML = "<tr><td colspan='7' style='text-align: center; color: #64748b;'>√úr√ºn kalemleri y√ºklenemedi</td></tr>";
      }
      
      // Supplier form g√∂r√ºn√ºyorsa, items y√ºklendikten sonra yeniden render et
      try {
        if (!isOwner && isPublished) {
          const host = document.getElementById('rfq-bid-form-container');
          if (host) {
            renderGeneralBidForm();
          }
        }
      } catch (e) {
        logger.warn('Bid form re-render skipped', e);
      }
    }

    // ====================
    // Load Bids
    // ====================
    async function loadBids() {
      try {
      const q = query(collection(db, "bids"), where("demandId","==", demandId));
      let snap = await getDocs(q);
      
      // bidCardsContainer kontrol√º
      if (!bidCardsContainer) {
        logger.error("bidCardsContainer element bulunamadƒ±");
        return;
      }
      
      bidCardsContainer.innerHTML = "";
      if (bidRows) bidRows.innerHTML = ""; // Eski tablo i√ßin de temizle
        logger.info("Bids loaded successfully");
      
      const mode = demandData.biddingMode || "secret";
      const phase = demandData.phase || "secret";
      
      // Add status tracking for bids
      // Update bid status to "viewed" when owner views the bids
      if (isOwner) {
        for (const docSnap of snap.docs) {
          const b = docSnap.data();
          const bidId = docSnap.id;
          
          // If bid status is "sent", update it to "viewed"
          if (b.status === "sent") {
            try {
              await updateDoc(doc(db, "bids", bidId), {
                status: "viewed",
                statusHistory: [...(b.statusHistory || []), {
                  status: "viewed",
                  timestamp: Date.now(),
                  userId: user.uid
                }]
              });
              logger.info("Bid status updated to viewed", { bidId });
            } catch (e) {
              logger.warn("Could not update bid status", e);
            }
          }
        }
        // Reload bids after status updates
        snap = await getDocs(q);
      }
      
      // OPTIMIZED: Collect all visible bids first, then batch load supplier names
      const visibleBids = [];
      const supplierIdsToLoad = new Set();
      
      for (const docSnap of snap.docs) {
        const b = docSnap.data();
        const bidId = docSnap.id;
        const isOwnBid = b.supplierId === user.uid;
        
        // Determine visibility based on mode and role
        let showBid = false;
        if (isOwner) {
          showBid = true; // Owner always sees all bids
        } else if (mode === "secret" || (mode === "hybrid" && phase === "secret")) {
          showBid = isOwnBid; // Secret: only own bid
        } else if (mode === "open" || (mode === "hybrid" && phase === "open")) {
          showBid = true; // Open: all bids visible
        }
        
        if (!showBid) continue;
        
        // Collect bid data and supplier IDs
        if ((isOwner || isOwnBid) && b.supplierId) {
          supplierIdsToLoad.add(b.supplierId);
        }
        visibleBids.push({ docSnap, b, bidId, isOwnBid });
      }
      
      // OPTIMIZED: Batch load all supplier names in parallel
      const SUPPLIER_NAME_CACHE = new Map();
      if (supplierIdsToLoad.size > 0) {
        const supplierIdsArray = Array.from(supplierIdsToLoad);
        const collections = ["users", "profiles", "publicProfiles"]; // Reordered: users first (most common)
        
        // Load all supplier names in parallel (Promise.all)
        const namePromises = supplierIdsArray.map(async (uid) => {
            for (const collection of collections) {
              try {
              const p = await getDoc(doc(db, collection, uid));
                if (p.exists()) {
                  const d = p.data();
                const name = d?.displayName || d?.companyName || d?.company?.name;
                if (name) {
                  return { uid, name };
                }
                }
              } catch (_) {
                continue;
              }
            }
          // Default if not found
          return { uid, name: uid?.slice(0, 10) + "..." };
        });
        
        // Wait for all promises and populate cache
        const results = await Promise.all(namePromises);
        results.forEach(({ uid, name }) => {
          SUPPLIER_NAME_CACHE.set(uid, name);
        });
      }
      
      // Now process each bid with cached supplier names
      for (const { docSnap, b, bidId, isOwnBid } of visibleBids) {
        
        // Aggregate totals (excl/incl VAT) and vat label
        const itemsArr = Array.isArray(b.items) ? b.items : [];
        const totalExcl = itemsArr.reduce((s,it)=> s + (Number(it.totalPrice) || (Number(it.netPrice)||0) * (Number(it.quantity)||0)), 0);
        const totalIncl = itemsArr.reduce((s,it)=> {
          const base = (Number(it.totalPrice) || (Number(it.netPrice)||0) * (Number(it.quantity)||0));
          const rate = Number(it.vatRate)||0;
          return s + (base * (1 + rate/100));
        }, 0);
        const vatSet = new Set(itemsArr.map(it => (it.vatRate!=null ? Number(it.vatRate) : null)).filter(v => v!=null));
        const vatDisplay = vatSet.size === 0 ? '-' : (vatSet.size === 1 ? `${[...vatSet][0]}%` : 'Karma');
        
        // Create bid card instead of table row
        const bidCard = document.createElement("div");
        bidCard.className = "bid-card";
        bidCard.setAttribute("data-bid-id", bidId);
        
        // Get supplier name from cache (already loaded in batch)
        let supplierDisplay;
        if (isOwner || isOwnBid) {
          supplierDisplay = SUPPLIER_NAME_CACHE.get(b.supplierId) || (b.supplierId?.slice(0, 10) + "...");
        } else {
          supplierDisplay = "Gizli Tedarik√ßi";
        }
        
        // Status label and badge
          const statusLabel = getStatusLabel(b.status || 'pending');
        const statusBadgeClass = {
          'sent': 'background:#dbeafe;color:#1e40af;',
          'viewed': 'background:#dbeafe;color:#1e40af;',
          'accepted': 'background:#d1fae5;color:#065f46;',
          'rejected': 'background:#fee2e2;color:#991b1b;',
          'revision_requested': 'background:#fef3c7;color:#92400e;',
          'pending': 'background:#f3f4f6;color:#374151;'
        }[b.status || 'pending'] || 'background:#f3f4f6;color:#374151;';
        
        // Action buttons (for owner) - Teklifbul Rol & Onay Sistemi
        let actionButtonsHTML = "";
        if (isOwner) {
          // E-imza onay yetkisi kontrol√º (async deƒüil, bu y√ºzden √∂nceden kontrol edilmi≈ü olmalƒ±)
          // Bu kontrol loadBids √ßaƒürƒ±lmadan √∂nce yapƒ±lmalƒ±, ≈üimdilik butonlarƒ± her zaman g√∂ster
          // acceptBid fonksiyonu i√ßinde guard kontrol√º yapƒ±lacak
          const rolePermissions = {}; // settings.html'den alƒ±nabilir
          const userDoc = await getDoc(doc(db, "users", user.uid));
          const currentUserData = userDoc.exists() ? userDoc.data() : {};
          const canApprove = canESignApprove(currentUserData, rolePermissions);
          
          if (b.status === "sent" || b.status === "viewed") {
            actionButtonsHTML = `
              ${canApprove ? `<button onclick="acceptBid('${bidId}')" class="btn-action btn-accept" title="E-imza ile teklif onaylama">‚úÖ Kabul Et (E-imza)</button>` : `<button disabled class="btn-action btn-accept" style="opacity:0.5; cursor:not-allowed;" title="E-imza onay yetkisi yok. Yalnƒ±zca √ºst onaycƒ± rolleri e-imza ile teklif onaylayabilir.">‚úÖ Kabul Et (Yetki Yok)</button>`}
              <button onclick="rejectBid('${bidId}')" class="btn-action btn-reject">‚ùå Reddet</button>
              <button onclick="requestBidRevision('${bidId}')" class="btn-action btn-revision">üìù Revizyon Talep Et</button>
            `;
          } else if (b.status === "accepted") {
            actionButtonsHTML = `<button onclick="requestBidRevision('${bidId}')" class="btn-action btn-revision">üìù Revizyon Talep Et</button>`;
          } else if (b.status === "revision_requested") {
            actionButtonsHTML = `
              ${canApprove ? `<button onclick="acceptBid('${bidId}')" class="btn-action btn-accept" title="E-imza ile teklif onaylama">‚úÖ Kabul Et (E-imza)</button>` : `<button disabled class="btn-action btn-accept" style="opacity:0.5; cursor:not-allowed;" title="E-imza onay yetkisi yok. Yalnƒ±zca √ºst onaycƒ± rolleri e-imza ile teklif onaylayabilir.">‚úÖ Kabul Et (Yetki Yok)</button>`}
              <button onclick="rejectBid('${bidId}')" class="btn-action btn-reject">‚ùå Reddet</button>
            `;
          }
        }
        
        // Fiyat ge√ßmi≈üi
        let priceHistoryHTML = "";
        if (b.priceHistory && b.priceHistory.length > 0) {
          priceHistoryHTML = `<button onclick="showPriceHistory('${bidId}')" class="btn-history">üìä ${b.priceHistory.length} Fiyat Deƒüi≈üimi</button>`;
        }
        
        const noteDisplay = (b.changesSummary && b.changesSummary.length)
          ? `<span class="badge">${b.changesSummary}</span>`
          : '';

        // Payment label helper
        function paymentPrefLabel(pref){
          if (!pref) return '-';
          const t = pref.paymentType;
          if (t === 'pesin'){ return pref.pesin?.model === 'onodeme' ? `Pe≈üin (√ñn √ñdeme %${pref.pesin?.prepaymentRate||0})` : (pref.pesin?.model==='escrow' ? 'Pe≈üin (Escrow)' : 'Pe≈üin (Teslim & Onay)'); }
          if (t === 'krediKarti'){ return `Kredi Kartƒ± (${pref.krediKarti?.installments||1} taksit${pref.krediKarti?.financeRate?`, %${pref.krediKarti.financeRate}`:''})`; }
          if (t === 'acikHesap'){ return `A√ßƒ±k Hesap +${pref.acikHesap?.netDays||0} g√ºn`; }
          if (t === 'evrak'){ const n=(pref.evrak?.checks||[]).length; return `Evrak (√ßek ${n} adet)`; }
          return '-';
        }

        // Format date
        const createdAt = b.createdAt?.toDate ? b.createdAt.toDate().toLocaleString("tr-TR") : (b.createdAt || "Tarih yok");
        
        // Revizyon ge√ßmi≈üi
        let revisionHistoryHTML = "";
        if (b.statusHistory && b.statusHistory.length > 0) {
          revisionHistoryHTML = `<div class="revision-timeline"><strong>Revizyon Ge√ßmi≈üi:</strong><ul>${b.statusHistory.map(h => `<li>${getStatusLabel(h.status)} - ${new Date(h.timestamp).toLocaleString("tr-TR")}</li>`).join('')}</ul></div>`;
        }

        // Create bid card HTML
        bidCard.innerHTML = `
          <style>
            .bid-card {
              background: white;
              border: 2px solid #e5e7eb;
              border-radius: 12px;
              padding: 20px;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
              transition: all 0.3s ease;
            }
            .bid-card:hover {
              box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              border-color: #3b82f6;
            }
            .bid-card-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 16px;
              padding-bottom: 12px;
              border-bottom: 2px solid #f3f4f6;
            }
            .bid-card-title {
              font-size: 18px;
              font-weight: 700;
              color: #1e293b;
            }
            .bid-card-status {
              padding: 6px 12px;
              border-radius: 6px;
              font-size: 12px;
              font-weight: 600;
            }
            .bid-card-summary {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
              gap: 16px;
              margin-bottom: 16px;
            }
            .summary-item {
              background: #f8fafc;
              padding: 12px;
              border-radius: 8px;
            }
            .summary-label {
              font-size: 12px;
              color: #64748b;
              font-weight: 600;
              margin-bottom: 4px;
            }
            .summary-value {
              font-size: 16px;
              font-weight: 700;
              color: #1e293b;
            }
            .summary-value.highlight {
              color: #059669;
              font-size: 20px;
            }
            .bid-card-actions {
              display: flex;
              gap: 8px;
              flex-wrap: wrap;
              margin-top: 16px;
              padding-top: 16px;
              border-top: 1px solid #e5e7eb;
            }
            .btn-action {
              padding: 8px 16px;
              border: none;
              border-radius: 6px;
              font-weight: 600;
              font-size: 14px;
              cursor: pointer;
              transition: all 0.2s;
            }
            .btn-accept { background: #10b981; color: white; }
            .btn-accept:hover { background: #059669; }
            .btn-reject { background: #ef4444; color: white; }
            .btn-reject:hover { background: #dc2626; }
            .btn-revision { background: #f59e0b; color: white; }
            .btn-revision:hover { background: #d97706; }
            .btn-history { 
              padding: 6px 12px;
              background: #3b82f6;
              color: white;
              border: none;
              border-radius: 6px;
              font-size: 12px;
              cursor: pointer;
            }
            .bid-card-details {
              margin-top: 16px;
              padding-top: 16px;
              border-top: 1px solid #e5e7eb;
            }
            .revision-timeline {
              margin-top: 12px;
              padding: 12px;
              background: #f8fafc;
              border-radius: 8px;
              font-size: 13px;
            }
            .revision-timeline ul {
              margin: 8px 0 0 20px;
              padding: 0;
            }
            .revision-timeline li {
              margin: 4px 0;
              color: #64748b;
            }
            .badge {
              display: inline-block;
              padding: 4px 8px;
              border-radius: 4px;
              font-size: 11px;
              font-weight: 600;
            }
          </style>
          <div class="bid-card-header">
            <div>
              <div class="bid-card-title">${supplierDisplay}</div>
              <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Teklif Tarihi: ${createdAt}</div>
            </div>
            <span class="bid-card-status" style="${statusBadgeClass}">${statusLabel}</span>
          </div>
          
          <div class="bid-card-summary">
            <div class="summary-item">
              <div class="summary-label">Toplam (KDV Hari√ß)</div>
              <div class="summary-value">${totalExcl ? totalExcl.toLocaleString("tr-TR") + ' ‚Ç∫' : '-'}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">KDV (%)</div>
              <div class="summary-value">${vatDisplay}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Toplam (KDV Dahil)</div>
              <div class="summary-value highlight">${totalIncl ? totalIncl.toLocaleString("tr-TR") + ' ‚Ç∫' : '-'}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Marka</div>
              <div class="summary-value">${b.brand || "-"}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">√ñdeme ≈ûekli</div>
              <div class="summary-value">${paymentPrefLabel(b.paymentPreference)}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">√úr√ºn Sayƒ±sƒ±</div>
              <div class="summary-value">${itemsArr.length} kalem</div>
            </div>
          </div>
          
          ${noteDisplay ? `<div style="margin-top: 12px; padding: 8px; background: #fff7ed; border-radius: 6px; font-size: 13px;">üìù Not: ${noteDisplay}</div>` : ''}
          ${priceHistoryHTML}
          
          ${isOwner ? `
          <div class="bid-card-actions">
            ${actionButtonsHTML}
          </div>
          ` : ''}
          
          <div class="bid-card-details">
            <button onclick="toggleBidDetails('${bidId}')" class="btn-details" style="padding: 8px 16px; background: #f3f4f6; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%;">
              üìã Detaylarƒ± G√∂ster/Gizle
            </button>
            <div id="bid-details-${bidId}" style="display: none; margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px;">
              <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 700;">√úr√ºn Detaylarƒ±</h4>
              <div id="bid-items-${bidId}">Y√ºkleniyor...</div>
              ${revisionHistoryHTML}
            </div>
          </div>
        `;
        
        bidCardsContainer.appendChild(bidCard);
        
        // Load bid items details (async)
        loadBidItemsDetails(bidId, itemsArr);
      }
      
      if (bidCardsContainer && bidCardsContainer.children.length === 0) {
        bidCardsContainer.innerHTML = '<div style="text-align:center; padding: 40px; color:#6b7280; background:white; border-radius:12px; border:2px dashed #e5e7eb;"><div style="font-size:48px; margin-bottom:16px;">üì≠</div><div style="font-size:16px; font-weight:600;">Hen√ºz teklif yok</div><div style="font-size:14px; margin-top:8px;">Bu talep i√ßin hen√ºz teklif alƒ±nmadƒ±.</div></div>';
      }
      } catch (e) {
        logger.error("Bids load error", e);
        if (e.message && e.message.includes("Missing or insufficient permissions")) {
          logger.warn("Permission denied for bids - trying temp fix");
          if (bidCardsContainer) {
            bidCardsContainer.innerHTML = '<div style="text-align:center; padding: 40px; color:#dc2626; background:white; border-radius:12px; border:2px solid #fee2e2;"><div style="font-size:48px; margin-bottom:16px;">‚ö†Ô∏è</div><div style="font-size:16px; font-weight:600;">Teklifler y√ºklenemedi (ƒ∞zin hatasƒ±)</div><div style="font-size:14px; margin-top:8px;">Bu talebi g√∂rme yetkiniz olmayabilir.</div></div>';
          }
          
          // Don't redirect immediately - let the user see the demand details
          // setTimeout(() => {
          //   alert("Bu talebi g√∂rme yetkiniz yok. L√ºtfen kendi taleplerinizi kontrol edin.");
          //   location.href = "./demands.html";
          // }, 2000);
        } else {
          if (bidCardsContainer) {
            bidCardsContainer.innerHTML = '<div style="text-align:center; padding: 40px; color:#dc2626; background:white; border-radius:12px; border:2px solid #fee2e2;"><div style="font-size:48px; margin-bottom:16px;">‚ùå</div><div style="font-size:16px; font-weight:600;">Teklifler y√ºklenemedi</div><div style="font-size:14px; margin-top:8px;">Bir hata olu≈ütu. L√ºtfen sayfayƒ± yenileyin.</div></div>';
          }
        }
      }
    }
    
    // ====================
    // Bid Details Helpers
    // ====================
    
    function toggleBidDetails(bidId) {
      const detailsDiv = document.getElementById(`bid-details-${bidId}`);
      if (detailsDiv) {
        detailsDiv.style.display = detailsDiv.style.display === 'none' ? 'block' : 'none';
      }
    }
    
    function loadBidItemsDetails(bidId, itemsArr) {
      const itemsDiv = document.getElementById(`bid-items-${bidId}`);
      if (!itemsDiv || !itemsArr || itemsArr.length === 0) {
        if (itemsDiv) itemsDiv.innerHTML = '<div style="color:#6b7280; font-size:13px;">√úr√ºn bilgisi bulunamadƒ±.</div>';
        return;
      }
      
      let itemsHTML = '<table style="width:100%; border-collapse:collapse; font-size:13px;">';
      itemsHTML += '<thead><tr style="background:#f3f4f6; border-bottom:2px solid #e5e7eb;"><th style="padding:8px; text-align:left;">√úr√ºn</th><th style="padding:8px; text-align:right;">Miktar</th><th style="padding:8px; text-align:right;">Birim Fiyat</th><th style="padding:8px; text-align:right;">KDV</th><th style="padding:8px; text-align:right;">Toplam</th></tr></thead><tbody>';
      
      itemsArr.forEach((item, idx) => {
        const name = item.name || item.description || `√úr√ºn ${idx + 1}`;
        const qty = item.quantity || item.qty || 0;
        const unitPrice = item.netPrice || item.unitPrice || 0;
        const vatRate = item.vatRate || 0;
        const total = item.totalPrice || (qty * unitPrice);
        const totalWithVat = total * (1 + vatRate / 100);
        
        itemsHTML += `
          <tr style="border-bottom:1px solid #e5e7eb;">
            <td style="padding:10px;">${name}</td>
            <td style="padding:10px; text-align:right;">${qty.toLocaleString("tr-TR")} ${item.unit || ''}</td>
            <td style="padding:10px; text-align:right;">${unitPrice.toLocaleString("tr-TR")} ‚Ç∫</td>
            <td style="padding:10px; text-align:right;">${vatRate}%</td>
            <td style="padding:10px; text-align:right; font-weight:600;">${totalWithVat.toLocaleString("tr-TR")} ‚Ç∫</td>
          </tr>
        `;
      });
      
      itemsHTML += '</tbody></table>';
      itemsDiv.innerHTML = itemsHTML;
    }
    
    function showPriceHistory(bidId) {
      // Bu fonksiyon modal veya detay sayfasƒ± a√ßabilir
  toast.info(`${MESSAGES.INFO_PRICE_HISTORY_TODO}: ${bidId}`);
    }
    
    // Helper function to get status label
    function getStatusLabel(status) {
      const labels = {
        sent: "G√∂nderildi",
        viewed: "G√∂r√ºld√º",
        responded: "Yanƒ±tlandƒ±",
        completed: "Tamamlandƒ±",
        rejected: "Reddedildi",
        pending: "Beklemede",
        accepted: "Kabul Edildi",
        revision_requested: "Revizyon Talep Edildi"
      };
      return labels[status] || status;
    }
    
    
    
    // ====================
    // File Upload/Download/Delete
    // ====================
    async function loadFiles() {
      if (!isOwner) return;
      try {
        logger.info("Loading files for demand", { demandId });
        
        // Simple query without orderBy to avoid index requirement
        const q = query(collection(db, "demands", demandId, "files"));
        const snap = await getDocs(q);
        
        logger.info("Files query successful", { found: snap.size, files: "files" });
        
        fileList.innerHTML = "";
        if (snap.empty) {
          fileList.innerHTML = "<p style='color:#6b7280;'>Hen√ºz dosya y√ºklenmemi≈ü.</p>";
          return;
        }

        // Convert to array and sort by createdAt (client-side)
        const files = snap.docs
          .map(docSnap => ({ id: docSnap.id, ...docSnap.data() }))
          .sort((a, b) => {
            const aTime = a.createdAt?.toMillis?.() || 0;
            const bTime = b.createdAt?.toMillis?.() || 0;
            return bTime - aTime; // Newest first
          });

        files.forEach(file => {
          const fileDiv = document.createElement("div");
          fileDiv.className = "file-item";
          
          const sizeKB = (file.size / 1024).toFixed(1);
          const uploadDate = file.createdAt?.toDate().toLocaleDateString("tr-TR") || "-";
          
          fileDiv.innerHTML = `
            <div class="file-info">
              <strong>${file.name}</strong><br/>
              <small style="color:#6b7280;">${sizeKB} KB ‚Ä¢ ${file.contentType} ‚Ä¢ ${uploadDate}</small>
            </div>
            <div class="file-actions">
              <button class="btn btn-primary btn-download" data-id="${file.id}" data-path="${file.storagePath}">ƒ∞ndir</button>
              <button class="btn btn-danger btn-delete" data-id="${file.id}" data-path="${file.storagePath}">Sil</button>
            </div>
          `;
          fileList.appendChild(fileDiv);
        });

        // Attach event listeners
        document.querySelectorAll(".btn-download").forEach(btn => {
          btn.onclick = async () => {
            const path = btn.dataset.path;
            try {
              const url = await getDownloadURL(ref(storage, path));
              window.open(url, "_blank");
            } catch (e) {
              toast.error(MESSAGES.ERROR_FILE_DOWNLOAD + ": " + (e.message || e));
            }
          };
        });

        document.querySelectorAll(".btn-delete").forEach(btn => {
          btn.onclick = async () => {
            if (!confirm("Bu dosyayƒ± silmek istediƒüinizden emin misiniz?")) return;
            const fileId = btn.dataset.id;
            const path = btn.dataset.path;
            try {
              await deleteObject(ref(storage, path));
              await deleteDoc(doc(db, "demands", demandId, "files", fileId));
              await updateDoc(doc(db, "demands", demandId), { filesCount: increment(-1) });
              loadFiles();
            } catch (e) {
              toast.error(MESSAGES.ERROR_FILE_DELETE + ": " + (e.message || e));
            }
          };
        });

      } catch (e) {
        logger.error("Dosyalar y√ºklenemedi", e);
        logger.error("Error code", { code: e.code });
        logger.error("Error message", { message: e.message });
        
        // Show user-friendly error
        fileList.innerHTML = `<p style='color:#dc2626;'>‚ùå Dosyalar y√ºklenemedi: ${e.message || 'Bilinmeyen hata'}</p>`;
      }
    }

    async function uploadFiles(files) {
      if (!isOwner || !files || files.length === 0) return;
      
      const MAX_SIZE = 10 * 1024 * 1024; // 10 MB
        for (const f of files) {
          if (f.size > MAX_SIZE) {
            toast.error(`${f.name} ${MESSAGES.ERROR_FILE_SIZE_10MB}`);
            return;
          }
        }

      try {
        btnUpload.disabled = true;
        btnUpload.textContent = "Y√ºkl√ºyor...";

        for (const f of files) {
          const path = `demands/${demandId}/${user.uid}/${Date.now()}-${f.name}`;
          const sref = ref(storage, path);
          await uploadBytes(sref, f);
          await addDoc(collection(db, "demands", demandId, "files"), {
            name: f.name,
            size: f.size,
            contentType: f.type,
            storagePath: path,
            uploadedBy: user.uid,
            createdAt: serverTimestamp()
          });
        }

        await updateDoc(doc(db, "demands", demandId), { 
          filesCount: increment(files.length) 
        });

        fileInput.value = "";
        await loadFiles();
        toast.success(MESSAGES.SUCCESS_FILES_UPLOADED);
      } catch (e) {
        logger.error("Dosya y√ºkleme hatasƒ±", e);
        toast.error(MESSAGES.ERROR_UPLOAD + ": " + (e.message || e));
      } finally {
        btnUpload.disabled = false;
        btnUpload.textContent = "Y√ºkle";
      }
    }

    // ====================
    // Publish/Unpublish with Multi-Role Company Support
    // ====================
    
    // ---------- helper: batch supplier search ----------
    async function findSuppliersByCategoryBatches(categories = []) {
      if (!Array.isArray(categories) || categories.length === 0) return [];

      const uniqueSuppliers = new Map();

      // Process in batches of 10 (Firestore limit for array-contains-any)
      for (let i = 0; i < categories.length; i += 10) {
        const batch = categories.slice(i, i + 10);
        try {
          logger.info(`Querying suppliers for category batch [${i}..${i+batch.length-1}]`, { batch });
          
          // Query for users who have at least one of these categories in their supplierCategories
          const q = query(
            collection(db, 'users'),
            where('supplierCategories', 'array-contains-any', batch)
          );
          
          const snap = await getDocs(q);
          logger.info(`Batch ${i/10} returned ${snap.size} docs`);
          
          snap.forEach(d => {
            const data = d.data();
            logger.info(`User ${d.id}`, {
              roles: data.roles,
              supplierCategories: data.supplierCategories,
              isActive: data.isActive
            });
            
            // Only include active suppliers or buyer+supplier users
            const isActive = data.isActive !== false; // Default to true if not set
            const isSupplier = data.roles?.supplier === true;
            const isBuyerSupplier = data.roles?.buyer === true && data.roles?.supplier === true;
            
            if (isActive && (isSupplier || isBuyerSupplier)) {
              uniqueSuppliers.set(d.id, { id: d.id, ...data });
            }
          });
        } catch (e) {
          logger.error('findSuppliersByCategoryBatches - batch query error', { batch, error: e });
          // If permission denied, re-throw
          if (String(e).includes('permission-denied')) throw e;
        }
      }

      logger.info(`Total unique suppliers found across all batches`, { count: uniqueSuppliers.size });
      return Array.from(uniqueSuppliers.values()); // [{id, ...data}, ...]
    }

    // ---------- main: publish + match ----------
    async function publishDemandAndMatchSuppliers(demandId) {
      logger.info('publishDemandAndMatchSuppliers - starting', { demandId });
      try {
        const demandRef = doc(db, 'demands', demandId);
        const dSnap = await getDoc(demandRef);
        if (!dSnap.exists()) {
          logger.warn('publishDemandAndMatchSuppliers - demand not found', { demandId });
          return;
        }
        const demand = dSnap.data();
        const categories = Array.isArray(demand.categoryTags) ? demand.categoryTags : [];
        const groups = Array.isArray(demand.groupIds) ? demand.groupIds : [];

        logger.info('Searching with categories', { categories, groups });

        // 1) Kategori bazlƒ± batch sorgusu
        let suppliers = await findSuppliersByCategoryBatches(categories);
        logger.info('Initial suppliers found', { count: suppliers.length });
        
        // Debug: If no suppliers found, check if there are any active users at all
        if (suppliers.length === 0) {
          logger.info('No suppliers found in category search, checking for all users');
          try {
            // Try without isActive filter first
            const allUsersQuery = query(collection(db, 'users'));
            const allUsersSnap = await getDocs(allUsersQuery);
            logger.info(`Total users in database`, { count: allUsersSnap.size });
            
            if (allUsersSnap.size > 0) {
              logger.info('Sample user data', allUsersSnap.docs[0].data());
              logger.info('Sample user roles', allUsersSnap.docs[0].data().roles);
              logger.info('Sample user supplierCategories', allUsersSnap.docs[0].data().supplierCategories);
            }
          } catch (e) {
            logger.warn('Could not query all users', e);
          }
        }

        // 2) Eƒüer bulunamadƒ±ysa -- relaxed search (ilk 3 kategoriyle) dene
        if (suppliers.length === 0 && categories.length > 0) {
          const relaxed = categories.slice(0, Math.min(3, categories.length));
          logger.info('No suppliers in full search, trying relaxed search', { relaxed });
          const relaxedSuppliers = await findSuppliersByCategoryBatches(relaxed);
          // Merge ve dedupe
          const merged = new Map();
          relaxedSuppliers.forEach(s => merged.set(s.id, s));
          suppliers = Array.from(merged.values());
          logger.info('After relaxed search, suppliers found', { count: suppliers.length });
        }

        // 3) Eƒüer hala yoksa -- optional: company-level arama (eƒüer companies dok√ºmanlarƒ±nda kategoriler varsa)
        if (suppliers.length === 0 && categories.length > 0) {
          try {
            logger.info('Attempting company-level search for categories', { hasCategoryTags: true });
            const companySet = new Map();
            for (let i = 0; i < categories.length; i += 10) {
              const batch = categories.slice(i, i + 10);
              try {
                const q = query(collection(db, 'companies'),
                                where('categories', 'array-contains-any', batch));
                const snap = await getDocs(q);
                logger.info(`companies batch ${i/10} returned`, { count: snap.size });
                snap.forEach(c => {
                  companySet.set(c.id, { id: c.id, ...c.data() });
                });
              } catch (e) {
                logger.warn('Company batch query error', { batch, error: e });
                // izin hatasƒ± vs. -> swallow ve devam et
              }
            }
            // Eƒüer companies bulunduysa, denormalize supplier bilgilerine (√∂r. companies -> kullanƒ±cƒ±lar) ihtiya√ß var.
            if (companySet.size > 0) {
              logger.info('Found companies matching categories', { count: companySet.size });
              // Eƒüer company -> supplier ili≈ükisi varsa burada ilave sorgular yapƒ±labilir (√∂rn. users where supplierCompanyId in [...])
              // Bu uygulamaya g√∂re uyarlayƒ±n. Burada yalnƒ±zca log bƒ±rakƒ±yoruz.
            }
          } catch (e) {
            logger.warn('Company-level search error', e);
          }
        }

        // 4) Eƒüer halen e≈üle≈üme yoksa, demand'a not d√º≈ü ve √ßƒ±k
        if (!suppliers || suppliers.length === 0) {
          logger.warn('No matching companies found for this demand', { demandId });

          // Kayƒ±t bƒ±rak (opsiyonel alanlar, var ise)
          try {
            await updateDoc(demandRef, {
              lastMatchingAttemptAt: serverTimestamp(),
              lastMatchingNote: 'No matching suppliers found for given categories/groups'
            });
          } catch (e) {
            logger.warn('Could not write lastMatchingNote to demand', e);
          }

          // Eƒüer i≈ü akƒ±≈üƒ±nƒ±zda "hi√ß e≈üle≈üme yoksa da yayƒ±nlansƒ±n" gerekiyorsa burada yayƒ±n mantƒ±ƒüƒ±nƒ± s√ºrd√ºr√ºn.
          // ≈ûimdilik sadece log atƒ±yoruz ve fonksiyonu sonlandƒ±rƒ±yoruz.
          return;
        }

        // 5) Match sonucu hazƒ±rlama: supplier id'lerini unique hale getir
        const supplierIds = Array.from(new Set(suppliers.map(s => s.id)));
        logger.info('Final matched unique supplier count', { count: supplierIds.length });

        // 6) Demand doc'u g√ºncelleme: viewerIds veya matched supplier alanƒ±
        try {
          await updateDoc(demandRef, {
            viewerIds: supplierIds,
            matchedSupplierCount: supplierIds.length,
            lastMatchingAt: serverTimestamp()
          });
          logger.info('Demand updated with matched suppliers', { viewerIds: supplierIds.length, matchedSupplierCount: supplierIds.length });
        } catch (e) {
          logger.error('Error updating demand with matched suppliers', e);
          // Eƒüer permission-denied ise, √ºst katmana iletmek isteyebilirsiniz
          if (String(e).includes('permission-denied')) throw e;
        }

        // 7) (Opsiyonel) Tedarik√ßilere bildirim/sending i≈ülemi burada yapƒ±lƒ±r ‚Äî mevcut akƒ±≈üƒ±nƒ±za g√∂re ekleyin.
        logger.info('publishDemandAndMatchSuppliers - finished', { demandId });

      } catch (err) {
        logger.error('publishDemandAndMatchSuppliers - fatal error', err);
        // ƒ∞stenirse hatayƒ± yeniden fƒ±rlat:
        // throw err;
      }
    }

    async function publishDemand() {
      // Double-check ownership before attempting publish
      if (!isOwner) {
        toast.error(MESSAGES.ERROR_PUBLISH_OWNER_ONLY);
        publishModal.style.display = "none";
        return;
      }
      
      // Verify current user matches demand creator
      if (user.uid !== demandData.createdBy) {
        logger.error("Ownership mismatch", {
          currentUser: user.uid,
          demandCreator: demandData.createdBy
        });
        toast.error(MESSAGES.ERROR_PUBLISH_PERMISSION);
        publishModal.style.display = "none";
        return;
      }
      
      try {
        logger.info("Publish ba≈ülatƒ±lƒ±yor", {
          demandId,
          owner: demandData.createdBy,
          currentUser: user.uid
        });

        // Get demand categories and groups
        const catSet = new Set();
        (Array.isArray(demandData.categoryTags) ? demandData.categoryTags : []).forEach(c => c && catSet.add(c));
        if (demandData.customCategory) catSet.add(demandData.customCategory);
        (Array.isArray(demandData.categories) ? demandData.categories : []).forEach(c => c && catSet.add(c));
        if (typeof demandData.category === "string" && demandData.category.trim()) catSet.add(demandData.category.trim());
        
        const cats = [...catSet];
        const grps = demandData.groupIds || [];
        
        if (cats.length === 0 && grps.length === 0) {
          toast.error(MESSAGES.ERROR_DEMAND_NO_CATEGORY);
          publishModal.style.display = "none";
          return;
        }
        
        logger.info("Tedarik√ßiler aranƒ±yor", { categories: cats, groups: grps });
        
        // Use new matching function - now accepts demandId directly
        await publishDemandAndMatchSuppliers(demandId);
        
        logger.info("Talep g√ºncelleniyor", { demandId });
        
        // Ensure SATFK exists
        function generateSATFK(){
          const d = new Date();
          const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0'); const da = String(d.getDate()).padStart(2,'0');
          const rand = Math.random().toString(36).substring(2,6).toUpperCase();
          return `SATFK-${y}${m}${da}-${rand}`;
        }
        const satfkValue = demandData.satfk || generateSATFK();

        // REFACTORED: Sadece status ve updatedAt g√ºncelleniyor
        await updateDoc(doc(db, "demands", demandId), {
          status: 'published',
          updatedAt: serverTimestamp(),
          satfk: satfkValue
        });
        
        logger.info("G√ºncelleme ba≈üarƒ±lƒ±");
        
        demandData.status = 'published';
        demandData.satfk = satfkValue;
        isPublished = true;
        demandData.sentAt = { toDate: () => new Date() };
        
        renderDemand();
        updatePublishButtons();
        updateEditButton();
        applyVisibilityRules();
        publishModal.style.display = "none";
        
  toast.success(MESSAGES.SUCCESS_DEMAND_APPROVED_SENT);
      } catch (e) {
        // üîç Enhanced error logging
        logger.error("[publish] error", e);
        logger.error("Publish hatasƒ±", {
          error: e,
          code: e.code,
          message: e.message,
          demandId,
          owner: demandData.createdBy,
          currentUser: user.uid
        });
        
        toast.error(MESSAGES.ERROR_PUBLISH + ": " + (e.code || e.message || e));
        publishModal.style.display = "none";
      }
    }

    async function unpublishDemand() {
      // Verify ownership
      if (!isOwner || user.uid !== demandData.createdBy) {
        toast.error(MESSAGES.ERROR_UNPUBLISH_OWNER_ONLY);
        unpublishModal.style.display = "none";
        return;
      }
      
      try {
        logger.info("Unpublish ba≈ülatƒ±lƒ±yor", { demandId });
        logger.info("Mevcut durum", { 
          published: demandData.published, 
          status: demandData.status 
        });
        
        // REFACTORED: Status = 'withdrawn', updatedAt g√ºncelleniyor
        await updateDoc(doc(db, "demands", demandId), {
          status: 'withdrawn',
          updatedAt: serverTimestamp()
        });
        
        logger.info("Talep geri √ßekildi - Firestore g√ºncellendi");
        
        demandData.status = 'withdrawn';
        isPublished = false;
        renderDemand();
        updatePublishButtons();
        updateEditButton();
        applyVisibilityRules();
        unpublishModal.style.display = "none";
        toast.success(MESSAGES.SUCCESS_DEMAND_UNPUBLISHED);
      } catch (e) {
        logger.error("Unpublish hatasƒ±", {
          error: e,
          code: e.code,
          message: e.message
        });
        
        let errorMsg = "Geri √ßekme hatasƒ±: ";
        if (e.code === "permission-denied") {
          errorMsg += "Yetki reddedildi.";
        } else {
          errorMsg += e.code || e.message || e;
        }
        
        toast.error(errorMsg);
        unpublishModal.style.display = "none";
      }
    }

    // ====================
    // Export PDF
    // ====================
    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      
      pdf.setFontSize(16);
      pdf.text(`Talep: ${demandData.title || "-"}`, 14, 20);
      
      pdf.setFontSize(10);
      let y = 30;
      pdf.text(`SATFK: ${demandData.satfk || "-"}`, 14, y); y += 6;
      pdf.text(`Talep Tarihi: ${demandData.demandDate || "-"}`, 14, y); y += 6;
      pdf.text(`Termin: ${demandData.dueDate || "-"}`, 14, y); y += 6;
      pdf.text(`√ñncelik: ${demandData.priority || "-"}`, 14, y); y += 6;
      pdf.text(`Kategoriler: ${(demandData.categoryTags || []).join(", ")}`, 14, y); y += 10;
      
      pdf.setFontSize(12);
      pdf.text("Kalemler:", 14, y); y += 8;
      
      pdf.setFontSize(9);
      itemsData.slice(0, 30).forEach(item => {
        pdf.text(`${item.lineNo}. ${item.name || "-"} - ${item.qty} ${item.unit}`, 14, y);
        y += 6;
        if (y > 280) return; // Page limit
      });
      
      pdf.save(`${demandData.satfk || "talep"}.pdf`);
    }

    // ====================
    function exportExcel() {
      const wb = XLSX.utils.book_new();
      
      // Summary sheet with all the requested information
      const summary = [
        ["Ba≈ülƒ±k", demandData.title || "-"],
        ["SATFK", demandData.satfk || "-"],
        ["Talep Tarihi", demandData.demandDate || "-"],
        ["Termin", demandData.dueDate || "-"],
        ["√ñncelik", demandData.priority || "-"],
        ["Kategoriler", (demandData.categoryTags || []).join(", ")],
        ["≈ûantiye", demandData.siteName || "-"],
        ["Alƒ±m Yeri (ƒ∞l)", demandData.purchaseLocation || "-"],
        ["Talep Tipi", getBiddingModeText(demandData.biddingMode) || "-"],
        ["Para Birimi", demandData.currency || "TRY"],
        ["Talep Eden", demandData.requester || "-"],
        ["Onay Veren", demandData.approver || "-"],
        ["Satƒ±n Alma Yetkilisi", demandData.purchaseManager || "-"],
        ["Genel M√ºd√ºr", demandData.generalManager || "-"],
        ["√ñdeme ≈ûartlarƒ±", demandData.paymentTerms || "-"]
      ];
      
      // Add descriptions
      if (Array.isArray(demandData.descriptions)) {
        demandData.descriptions.forEach((desc, index) => {
          if (desc && desc.trim()) {
            summary.push([`A√ßƒ±klama ${index + 1}`, desc.trim()]);
          }
        });
      } else if (demandData.spec) {
        summary.push(["A√ßƒ±klama", demandData.spec]);
      }
      
      const ws1 = XLSX.utils.aoa_to_sheet(summary);
      
      // Items sheet with all requested information
      const rows = itemsData.map((i, index) => ({
        "Sƒ±ra": i.lineNo,
        "Kod": i.sku || "-",
        "Tanƒ±m": i.name || "-",
        "Marka/Model": i.brandModel || "-",
        "Miktar": i.qty,
        "Birim": i.unit,
        "Teslim Tarihi": i.itemDueDate || "-"
      }));
      const ws2 = XLSX.utils.json_to_sheet(rows);
      
      XLSX.utils.book_append_sheet(wb, ws1, "√ñzet");
      XLSX.utils.book_append_sheet(wb, ws2, "Kalemler");
      XLSX.writeFile(wb, `${demandData.satfk || "talep"}.xlsx`);
    }
    
    // Helper function to get bidding mode text
    function getBiddingModeText(mode) {
      const modeMap = {
        "secret": "Gizli Teklif (tek tur)",
        "open": "A√ßƒ±k Teklif (tek tur)",
        "hybrid": "Hibrit (1. tur gizli, 2. tur a√ßƒ±k)"
      };
      return modeMap[mode] || mode || "-";
    }
    
    // ====================
    // Submit Bid
    // ====================
    async function submitBid() {
      // Get general information
      const currencyVal = '';
      const deliveryDateVal = '';
      // paymentTerms kaldƒ±rƒ±ldƒ±
      const shippingTypeVal = document.getElementById("shippingType")?.value || '';
      const shippingModeVal = document.getElementById("shippingMode")?.value || 'excluded';
      const vehicleTripsVal = Number(document.getElementById("vehicleTrips")?.value || 0) || 0;
      const timeStartVal = (document.getElementById("deliveryTimeStart")?.value || '').trim();
      const timeEndVal = (document.getElementById("deliveryTimeEnd")?.value || '').trim();
      const shippingNotesVal = (document.getElementById("shippingNotes")?.value || '').trim();
      // shippingCost kaldƒ±rƒ±ldƒ±
      const deliveryMethodVal = document.getElementById("deliveryMethod")?.value || '';
      const minOrderQtyVal = '';
      const vatRateVal = document.getElementById("vatRate")?.value || 0;
      const notesVal = document.getElementById("notes")?.value || '';
      
      // Genel alanlar bo≈ü olabilir; satƒ±r bazƒ±nda doldurulmak zorunda
      
          // Collect product bid data
          const productBids = [];
          const container = document.getElementById('product-bid-forms');
          
          if (!container || !itemsData || itemsData.length === 0) {
            toast.error(MESSAGES.ERROR_PRODUCT_INFO_NOT_FOUND);
        return;
      }
      
        // Validate each product form
          for (let i = 0; i < itemsData.length; i++) {
        const formDiv = container.children[i];
        if (!formDiv) continue;
        
        const quantity = formDiv.querySelector(`[data-field="quantity"]`).value;
        const unit = formDiv.querySelector(`[data-field="unit"]`).value;
        let unitPrice = formDiv.querySelector(`[data-field="unitPrice"]`).value;
        unitPrice = normalizeDecimalString(unitPrice);
        const lineCurrency = (formDiv.querySelector(`[data-field="currency"]`)?.value || currencyVal || '').trim();
        const lineDelivery  = (formDiv.querySelector(`[data-field="deliveryDate"]`)?.value || '').trim();
          const offerDesc = (formDiv.querySelector(`[data-field="offerDescription"]`)?.value || '').trim();
        
        if (!quantity || !unit || !unitPrice) {
          toast.error(MESSAGES.ERROR_PRODUCT_FIELDS_REQUIRED.replace('{n}', String(i + 1)));
          return;
        }
        const vatSelectEl = formDiv.querySelector(`[data-field="vatRate"]`);
        if (!vatSelectEl || vatSelectEl.value === '') {
          toast.error(MESSAGES.ERROR_PRODUCT_VAT_REQUIRED.replace('{n}', String(i + 1)));
          return;
        }
        if (!lineCurrency) { toast.error(MESSAGES.ERROR_PRODUCT_CURRENCY_REQUIRED.replace('{n}', String(i + 1))); return; }
        if (!lineDelivery) { toast.error(MESSAGES.ERROR_PRODUCT_DELIVERY_REQUIRED.replace('{n}', String(i + 1))); return; }
        
        // Get discount values for this product
        const d1 = Number(formDiv.querySelector(`[data-field="discount1"]`).value || 0);
        const d2 = Number(formDiv.querySelector(`[data-field="discount2"]`).value || 0);
        const d3 = Number(formDiv.querySelector(`[data-field="discount3"]`).value || 0);
        const d4 = Number(formDiv.querySelector(`[data-field="discount4"]`).value || 0);
        const d5 = Number(formDiv.querySelector(`[data-field="discount5"]`).value || 0);
        const vatRate = Number(formDiv.querySelector(`[data-field="vatRate"]`)?.value || 0);
        
        // Calculate net price
        let netPrice = Number(unitPrice);
        if (d1 > 0) netPrice = netPrice * (1 - d1 / 100);
        if (d2 > 0) netPrice = netPrice * (1 - d2 / 100);
        if (d3 > 0) netPrice = netPrice * (1 - d3 / 100);
        if (d4 > 0) netPrice = netPrice * (1 - d4 / 100);
        if (d5 > 0) netPrice = netPrice * (1 - d5 / 100);
          const requestedQty = Number(itemsData[i].qty || 0);
          const requestedDesc = itemsData[i].name || '';
          const offeredQty = Number(quantity);
          const offeredDesc = offerDesc || requestedDesc;
          const quantityChanged = offeredQty !== requestedQty;
          const descChanged = offeredDesc.trim() !== requestedDesc.trim();
          const unitChanged = (unit || '').toLowerCase() !== String(itemsData[i].unit || '').toLowerCase();
          const changeNoteParts = [];
          if (quantityChanged) changeNoteParts.push(`Miktar ${requestedQty} ‚Üí ${offeredQty}`);
          if (unitChanged) changeNoteParts.push(`Birim ${(itemsData[i].unit||'').toString()} ‚Üí ${unit}`);
          if (descChanged) changeNoteParts.push('Tanƒ±m deƒüi≈üti');
          const changeNote = changeNoteParts.join(' | ');

          // Sertifikalar
          const certs = Array.from(formDiv.querySelectorAll('[data-field="certChips"] .cert-chip'))
            .map(c => c.childNodes?.[0]?.textContent?.trim() || c.textContent.trim())
            .filter(Boolean);

          productBids.push({
            lineNo: itemsData[i].lineNo || (i+1),
            productIndex: i,
            description: offeredDesc,
            quantity: offeredQty,
            unit: unit,
            unitPrice: Number(unitPrice),
            netPrice: netPrice,
            discounts: [d1, d2, d3, d4, d5].filter(d => d > 0),
            vatRate,
            totalPrice: netPrice * offeredQty,
            totalWithVat: (netPrice * offeredQty) * (1 + (vatRate/100)),
            currency: lineCurrency,
            deliveryDate: lineDelivery,
            qualityCerts: certs,
            requested: { description: requestedDesc, quantity: requestedQty, unit: itemsData[i].unit, features: itemsData[i].featuresPairs || [] },
            offered:   { description: offeredDesc,   quantity: offeredQty,   unit },
            changes:   { quantityChanged, unitChanged, descChanged },
            changeNote,
            imageUrl: (formDiv.querySelector('[data-field="imageUrl"]')?.value || '').trim(),
            note: (formDiv.querySelector('[data-field="itemNote"]')?.value || '').trim()
          });
      }
      
      if (productBids.length === 0) {
        toast.error(MESSAGES.ERROR_BID_PRODUCT_NOT_FOUND);
        return;
      }
      
      // Nakliye dahil ise detaylarƒ± zorunlu tut ve nakliye kalemini ekle
      if (shippingModeVal === 'included') {
        if (!(vehicleTripsVal > 0)) { toast.error(MESSAGES.ERROR_TRANSPORT_TRIPS); return; }
        if (!timeStartVal || !timeEndVal) { toast.error(MESSAGES.ERROR_TRANSPORT_TIME); return; }
        // Shipping line validation
        const sQty = Number(document.getElementById('shipLineQty')?.value || 0);
        const sUnit = (document.getElementById('shipLineUnit')?.value || '').trim();
        const sUnitPrice = normalizeDecimalString(document.getElementById('shipLineUnitPrice')?.value || '');
        const sVat = document.getElementById('shipLineVat')?.value || '';
        if (!sQty || !sUnit || !sUnitPrice || sVat==='') { toast.error(MESSAGES.ERROR_TRANSPORT_ITEM_REQUIRED); return; }
        // Push shipping line as product item
        const sUnitPriceNum = Number(sUnitPrice);
        const sVatNum = Number(sVat);
        const sNet = sUnitPriceNum;
        productBids.push({
          lineNo: (itemsData.length + 1),
          productIndex: itemsData.length,
          description: 'Nakliye',
          quantity: sQty,
          unit: sUnit,
          unitPrice: sUnitPriceNum,
          netPrice: sNet,
          discounts: [],
          vatRate: sVatNum,
          totalPrice: sNet * sQty,
          totalWithVat: (sNet * sQty) * (1 + (sVatNum/100)),
          currency: (container.querySelector('[data-field="currency"]')?.value || 'TRY'),
          deliveryDate: (document.getElementById('deliveryTimeStart')?.value || ''),
          qualityCerts: [],
          requested: { description: 'Nakliye', quantity: null, unit: null, features: [] },
          offered:   { description: 'Nakliye', quantity: sQty, unit: sUnit },
          changes:   { quantityChanged: false, unitChanged: false, descChanged: false },
          changeNote: '',
          imageUrl: '',
          note: (document.getElementById('shippingNotes')?.value || '').trim()
        });
      }

      // Collect payment schedule
      // payment program kaldƒ±rƒ±ldƒ±

      // Calculate total bid amount
      const totalAmount = productBids.reduce((sum, bid) => sum + bid.totalPrice, 0);
      const changesSummary = productBids.filter(b => b.changeNote).map(b => `#${b.lineNo}: ${b.changeNote}`).join('; ');
      
      // Show confirmation
      const confirmMessage = `Teklif √ñzeti:\n\n` +
        productBids.map((bid, index) => 
          `${index + 1}. ${bid.description}
   Miktar: ${bid.quantity} ${bid.unit}
   Birim Fiyat: ${bid.unitPrice.toFixed(2)} ${currencyVal}
   Net Fiyat: ${bid.netPrice.toFixed(2)} ${currencyVal}
   Toplam: ${bid.totalPrice.toFixed(2)} ${currencyVal}`
        ).join('\n\n') +
        `

Genel Toplam: ${totalAmount.toFixed(2)} ${currencyVal}

Bu teklifi g√∂ndermek istediƒüinizden emin misiniz?`;
      
      if (!confirm(confirmMessage)) {
        return;
      }
      
      try {
        // Get current user info (required at top via requireAuth())
        const currentUser = user;
        if (!currentUser) {
          toast.error(MESSAGES.ERROR_AUTH);
          return;
        }
        
        // Get company info
        const companyDoc = await getDoc(doc(db, "companies", `solo-${currentUser.uid}`));
        const companyData = companyDoc.exists() ? companyDoc.data() : {};
        
        // Genel varyant/alternatif/sertifika kaldƒ±rƒ±ldƒ± (satƒ±r bazlƒ±)

        // Create bid data
        const bidData = {
          demandId: demandId,
          supplierId: currentUser.uid,
          supplierName: companyData.name || currentUser.displayName || "Bilinmeyen Firma",
          supplierPhone: companyData.phone || "",
          buyerId: demandData.createdBy,
          items: productBids,
          currency: currencyVal,
          // genel teslim tarihi ve marka kaldƒ±rƒ±ldƒ±
          // paymentTerms kaldƒ±rƒ±ldƒ±
          paymentPreference: selectedPaymentPref || null,
          shippingType: shippingTypeVal,
          deliveryMethod: deliveryMethodVal,
          // min sipari≈ü genel kaldƒ±rƒ±ldƒ±
          vatRate: Number(vatRateVal),
          notes: notesVal,
          shipping: {
            mode: shippingModeVal,
            type: shippingTypeVal || null,
            // cost removed; represented as line item when included
            vehicleTrips: shippingModeVal==='included' ? vehicleTripsVal : null,
            timeWindow: shippingModeVal==='included' ? { start: timeStartVal || null, end: timeEndVal || null } : null,
            notes: shippingNotesVal || null
          },
          totalAmount: totalAmount,
          changesSummary: changesSummary || '',
            status: "sent",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };
        
        // Add to bids collection
        await addDoc(collection(db, "bids"), bidData);
        
        toast.success(MESSAGES.SUCCESS_BID_SENT);
        
        // Reload bids to show the new bid
        await loadBids();
        
        // Clear form
        clearBidForm();
        
      } catch (error) {
        logger.error("Error submitting bid", error);
        toast.error(MESSAGES.ERROR_BID_SEND + ": " + error.message);
      }
    }
    
    // Clear bid form
    function clearBidForm() {
      const container = document.getElementById('product-bid-forms');
      if (container) {
        // Clear all product forms
        container.querySelectorAll('input[type="number"]').forEach(input => {
          if (input.getAttribute('data-field') !== 'quantity') {
            input.value = '';
          }
        });
        
        // Reset net prices
        container.querySelectorAll('[data-field="netPrice"]').forEach(element => {
          element.textContent = '-';
        });
      }
      
      // Clear general fields (defensive - some inputs may not exist)
      [
        'paymentTerms', 'shippingType', 'shippingCost', 'deliveryMethod',
        'notes', 'shippingMode', 'vehicleTrips', 'deliveryTimeStart', 'deliveryTimeEnd', 'shippingNotes'
      ].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
    }
    
    // Add revision request function
    async function requestRevision() {
      const revisionNotes = document.getElementById("revisionNotes").value;
      if (!revisionNotes.trim()) {
        toast.warn(MESSAGES.WARN_REVISION_REQUEST_REQUIRED);
        return;
      }
      
      try {
        // Create a revision request document
        const revisionRequest = {
          demandId: demandId,
          requesterId: user.uid,
          notes: revisionNotes,
          status: "pending", // pending, approved, rejected
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };
        
        const revisionRef = await addDoc(collection(db, "bidRevisions"), revisionRequest);
        
        // Update bid status to "revision_requested"
        // In a real implementation, you would find the specific bid and update it
        // For now, we'll just show a success message
        
        toast.success(MESSAGES.SUCCESS_REVISION_REQUEST_SENT);
        document.getElementById("revisionNotes").value = "";
      } catch (e) {
        logger.error("Revizyon talebi g√∂nderme hatasƒ±", e);
        toast.error(MESSAGES.ERROR_GENERAL + ": " + (e.message || e));
      }
    }
    
    // Add function to submit revised bid
    async function submitRevisedBid() {
      // This function would be called when a supplier submits a revised bid
      // in response to a revision request
      
      // Get the revision request details
      // Create a new bid document with revised terms
      // Update the revision request status to "completed"
      
      logger.info("Revised bid submission functionality would be implemented here");
    }
    
    // Add helper function to determine payment method
    function getPaymentMethod(paymentTerms) {
      if (!paymentTerms) return "unknown";
      
      const terms = paymentTerms.toLowerCase();
      if (terms.includes("nakit") || terms.includes("cash")) return "cash";
      if (terms.includes("kredi") || terms.includes("credit")) return "credit";
      if (terms.includes("havale") || terms.includes("eft")) return "bank_transfer";
      if (terms.includes("√ßek")) return "check";
      
      return "other";
    }
    
    // ====================
    // Net Price Calculator
    // ====================
    function calcNetPrice() {
      const list = Number(document.getElementById("priceList").value || 0);
      const d = [1, 2, 3, 4, 5].map(i => Number(document.getElementById("discount" + i).value || 0));
      let net = list;
      d.forEach(p => { if (p > 0) net = net * (1 - (p / 100)); });
      document.getElementById("netPrice").textContent = net > 0 ? net.toFixed(2) + " ‚Ç∫" : "-";
    }
    
    // Attach listeners for auto-calculation
    ["priceList", "discount1", "discount2", "discount3", "discount4", "discount5"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("input", calcNetPrice);
    });

    // ====================
    // Event Listeners
    // ====================
    if (btnUpload) {
      btnUpload.onclick = () => uploadFiles(fileInput.files);
    }

    if (btnEdit) {
      btnEdit.onclick = () => { location.href = `./demand-new.html?id=${demandId}`; };
    }

    if (btnPublish) {
      btnPublish.onclick = () => { publishModal.style.display = "block"; };
    }

    if (btnUnpublish) {
      btnUnpublish.onclick = () => { unpublishModal.style.display = "block"; };
    }
    
    // Excel'den teklif y√ºkleme
    const btnUploadBid = document.getElementById("btnUploadBid");
    const excelBidInput = document.getElementById("excelBidInput");
    if (btnUploadBid && excelBidInput) {
      btnUploadBid.onclick = () => {
        excelBidInput.click();
      };
      
      excelBidInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
          btnUploadBid.disabled = true;
          btnUploadBid.textContent = "‚è≥ ƒ∞≈üleniyor...";
          
          await importBidFromExcel(file);
          
          toast.success(MESSAGES.SUCCESS_BID_SAVED);
          location.reload();
        } catch (error) {
          logger.error("Excel teklif y√ºkleme hatasƒ±", error);
          toast.error(MESSAGES.ERROR_BID_LOAD + ": " + (error.message || error));
        } finally {
          btnUploadBid.disabled = false;
          btnUploadBid.textContent = "üì§ Excel'den Teklif Y√ºkle";
          excelBidInput.value = "";
        }
      };
    }

    document.getElementById("confirmPublish").onclick = publishDemand;
    document.getElementById("cancelPublish").onclick = () => { publishModal.style.display = "none"; };
    document.getElementById("confirmUnpublish").onclick = unpublishDemand;
    document.getElementById("cancelUnpublish").onclick = () => { unpublishModal.style.display = "none"; };

    if (btnExportPDF) {
      btnExportPDF.onclick = exportPDF;
    }

    if (btnExportExcel) {
      btnExportExcel.onclick = exportExcel;
    }

    // bidBtn artƒ±k yok, RFQ bid form kullanƒ±yoruz
    // document.getElementById("bidBtn").onclick = submitBid;
    
    // Add revision request functionality
    const requestRevisionBtn = document.getElementById("requestRevisionBtn");
    if (requestRevisionBtn) {
      requestRevisionBtn.onclick = requestRevision;
    }

    // Round 2 transition button
    const btnRound2 = document.getElementById("btnRound2");
    if (btnRound2) {
      btnRound2.onclick = transitionToRound2;
    }

    // ====================
    // Helper Functions
    // ====================
    function setText(sel, val) { 
      const el = document.querySelector(sel); 
      if (el) {
        el.textContent = val;
        logger.info(`setText`, { selector: sel, value: val });
      } else {
        logger.warn(`Element bulunamadƒ±`, { selector: sel });
      }
    }
    function hide(el) { if (el) el.style.display = "none"; }
    function show(el) { if (el) el.style.display = ""; }
    
    // Tooltip functionality
    function initTooltips() {
      const tooltips = document.querySelectorAll('.tooltip');
      tooltips.forEach(tooltip => {
        const icon = tooltip.querySelector('.help-icon');
        const text = tooltip.querySelector('.tooltiptext');
        
        if (icon && text) {
          icon.addEventListener('mouseenter', () => {
            text.style.visibility = 'visible';
            text.style.opacity = '1';
          });
          
          icon.addEventListener('mouseleave', () => {
            text.style.visibility = 'hidden';
            text.style.opacity = '0';
          });
        }
      });
    }
    
    // Get bidding mode description
    function getBiddingModeDescription(mode) {
      const descriptions = {
        'secret': 'Gizli Teklif (tek tur): Tedarik√ßiler tekliflerini gizli olarak g√∂nderir. En iyi teklif kazanƒ±r.',
        'open': 'A√ßƒ±k Teklif (tek tur): T√ºm teklifler herkese a√ßƒ±k olarak gelir. Rekabet√ßi fiyatlandƒ±rma.',
        'hybrid': 'Hibrit (1. tur gizli, 2. tur a√ßƒ±k): ƒ∞lk turda gizli teklifler toplanƒ±r, ikinci turda a√ßƒ±k artƒ±rma yapƒ±lƒ±r.'
      };
      return descriptions[mode] || 'Bilinmeyen talep tipi';
    }
    
    // Get visibility description
    function getVisibilityDescription(visibility) {
      const descriptions = {
        'private': '√ñzel: Sadece belirlenen tedarik√ßiler g√∂rebilir',
        'company': '≈ûirket: Aynƒ± ≈üirketteki t√ºm kullanƒ±cƒ±lar g√∂rebilir',
        'public': 'Genel: T√ºm kullanƒ±cƒ±lar g√∂rebilir'
      };
      return descriptions[visibility] || 'Bilinmeyen g√∂r√ºn√ºrl√ºk';
    }
    
    // Fiyat ge√ßmi≈üi modal fonksiyonlarƒ±
    window.showPriceHistory = async function(bidId) {
      try {
        const bidDoc = await getDoc(doc(db, "bids", bidId));
        if (!bidDoc.exists()) {
          toast.error(MESSAGES.ERROR_BID_NOT_FOUND);
          return;
        }
        
        const bidData = bidDoc.data();
        const priceHistory = bidData.priceHistory || [];
        
        if (priceHistory.length === 0) {
          toast.warn(MESSAGES.WARN_PRICE_HISTORY_NOT_FOUND);
          return;
        }
        
        // Modal i√ßeriƒüini olu≈ütur
        const content = document.getElementById("priceHistoryContent");
        content.innerHTML = `
          <div style="margin-bottom: 16px;">
            <strong>Tedarik√ßi:</strong> ${bidData.supplierName || "Bilinmiyor"}<br>
            <strong>G√ºncel Fiyat:</strong> ${bidData.netPrice?.toLocaleString("tr-TR")} ${bidData.currency || "TRY"}
          </div>
          <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
            <thead>
              <tr style="background: #f9fafb;">
                <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: left;">Sƒ±ra</th>
                <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: left;">Liste Fiyatƒ±</th>
                <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: left;">ƒ∞ndirimler</th>
                <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: left;">Net Fiyat</th>
                <th style="padding: 8px; border: 1px solid #e5e7eb; text-align: left;">Tarih</th>
              </tr>
            </thead>
            <tbody>
              ${priceHistory.map((price, index) => `
                <tr style="background: ${index === priceHistory.length - 1 ? '#f0f9ff' : 'white'};">
                  <td style="padding: 8px; border: 1px solid #e5e7eb;">${index + 1}</td>
                  <td style="padding: 8px; border: 1px solid #e5e7eb;">${price.priceList?.toLocaleString("tr-TR") || "-"}</td>
                  <td style="padding: 8px; border: 1px solid #e5e7eb;">
                    ${[price.discount1, price.discount2, price.discount3, price.discount4, price.discount5]
                      .filter(d => d > 0)
                      .map(d => `${d}%`)
                      .join(" + ") || "-"}
                  </td>
                  <td style="padding: 8px; border: 1px solid #e5e7eb; font-weight: bold;">${price.netPrice?.toLocaleString("tr-TR") || "-"}</td>
                  <td style="padding: 8px; border: 1px solid #e5e7eb;">${new Date(price.timestamp).toLocaleString("tr-TR")}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `;
        
        // Modalƒ± g√∂ster
        document.getElementById("priceHistoryModal").style.display = "block";
        
      } catch (error) {
        logger.error("Fiyat ge√ßmi≈üi y√ºklenirken hata", error);
        toast.error(MESSAGES.ERROR_PRICE_HISTORY_LOAD);
      }
    };
    
    window.closePriceHistoryModal = function() {
      document.getElementById("priceHistoryModal").style.display = "none";
    };

    // ====================
    // Fiyat Kar≈üƒ±la≈ütƒ±rma Sistemi
    // ====================
    
    // Fiyat kar≈üƒ±la≈ütƒ±rma butonu event listener
    document.getElementById("btnPriceComparison").addEventListener("click", async function() {
      try {
        await generatePriceComparisonExcel();
      } catch (error) {
        logger.error("Fiyat kar≈üƒ±la≈ütƒ±rmasƒ± olu≈üturulurken hata", error);
        toast.error(MESSAGES.ERROR_PRICE_COMPARISON_CREATE + ": " + error.message);
      }
    });

    async function generatePriceComparisonExcel() {
      try {
        // Talep verilerini al
        const demandRef = doc(db, "demands", demandId);
        const demandSnap = await getDoc(demandRef);
        
        if (!demandSnap.exists()) {
          throw new Error("Talep bulunamadƒ±");
        }
        
        const demandData = demandSnap.data();
        
        // Teklifleri al - daha basit sorgu kullan
        const bidsQuery = query(
          collection(db, "bids"),
          where("demandId", "==", demandId)
        );
        
        const bidsSnap = await getDocs(bidsQuery);
        const bidsData = [];
        
        // Her teklif i√ßin tedarik√ßi bilgilerini al
        for (const bidDoc of bidsSnap.docs) {
          const bidData = bidDoc.data();
          
          // T√ºm teklifleri al (sent, viewed, responded)
          // if (bidData.status !== "sent") {
          //   continue;
          // }
          
          // Tedarik√ßi bilgilerini al
          const supplierRef = doc(db, "users", bidData.supplierId);
          const supplierSnap = await getDoc(supplierRef);
          
          if (supplierSnap.exists()) {
            const supplierData = supplierSnap.data();
            bidData.supplierName = supplierData.companyName || supplierData.displayName || "Bilinmiyor";
            bidData.supplierPhone = supplierData.phone || "";
          } else {
            bidData.supplierName = "Bilinmiyor";
            bidData.supplierPhone = "";
          }
          
          bidsData.push(bidData);
        }
        
        if (bidsData.length === 0) {
          toast.warn(MESSAGES.WARN_NO_BIDS);
          return;
        }
        
        // Excel olu≈ütur
        await createPriceComparisonExcel(demandData, bidsData);
        
      } catch (error) {
        logger.error("Excel olu≈üturma hatasƒ±", error);
        throw error;
      }
    }

    async function createPriceComparisonExcel(demandData, bidsData) {
      try {
        // XLSX k√ºt√ºphanesini CDN'den y√ºkle
        if (typeof XLSX === 'undefined') {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
          document.head.appendChild(script);
          
          // K√ºt√ºphanenin y√ºklenmesini bekle
          await new Promise((resolve, reject) => {
            script.onload = resolve;
            script.onerror = reject;
          });
        }
        
        // Excel ≈üablonunu y√ºkle
        const templateResponse = await fetch('./assets/teklif mukayese formu.xlsx');
        const templateArrayBuffer = await templateResponse.arrayBuffer();
        const templateWorkbook = XLSX.read(templateArrayBuffer, { type: 'array' });
        
        // ƒ∞lk sheet'i al
        const sheetName = templateWorkbook.SheetNames[0];
        const worksheet = templateWorkbook.Sheets[sheetName];
        
        // ≈ûablonu kopyala
        const newWorkbook = XLSX.utils.book_new();
        const newWorksheet = JSON.parse(JSON.stringify(worksheet));
        
        // Verileri ≈üablona yerle≈ütir
        await fillTemplateWithData(newWorksheet, demandData, bidsData);
        
        // Workbook'a ekle
        XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, "Fiyat Kar≈üƒ±la≈ütƒ±rma");
        
        // Dosyayƒ± indir
        const filename = `${demandData.satfk || "talep"}_mukayese_tablo.xlsx`;
        XLSX.writeFile(newWorkbook, filename);
        
        toast.success(MESSAGES.SUCCESS_PRICE_COMPARISON_CREATED);
        
      } catch (error) {
        logger.error("Excel olu≈üturma hatasƒ±", error);
        throw error;
      }
    }

    async function fillTemplateWithData(worksheet, demandData, bidsData) {
      try {
        // === 1. √úST Bƒ∞LGƒ∞LERƒ∞ YERLE≈ûTƒ∞R ===
        setCellValue(worksheet, 'T1', demandData.satfk || ''); // SATFK
        setCellValue(worksheet, 'T3', demandData.site || ''); // ≈ûantiye
        setCellValue(worksheet, 'T4', demandData.usdTryRate || '34.85'); // USD/TRY Kuru
        setCellValue(worksheet, 'B5', demandData.title || ''); // Talep Konusu
        
        // === 2. √úR√úNLERƒ∞ EKLE ===
        const startRow = 8;
        if (demandData.items && Array.isArray(demandData.items)) {
          demandData.items.forEach((item, idx) => {
            const row = startRow + idx;
            setCellValue(worksheet, `B${row}`, idx + 1); // No
            setCellValue(worksheet, `C${row}`, item.description || ''); // √úr√ºn Adƒ±
            setCellValue(worksheet, `D${row}`, item.quantity || ''); // Miktar
            setCellValue(worksheet, `E${row}`, item.unit || ''); // Birim
          });
        }
        
        // === 3. TEKLƒ∞F VEREN Fƒ∞RMALARI SIRALA (EN UCUZDAN) ===
        const sortedBids = bidsData.sort((a, b) => {
          const totalA = calculateBidTotal(a, demandData.items);
          const totalB = calculateBidTotal(b, demandData.items);
          return totalA - totalB;
        });
        
        // Premium kullanƒ±cƒ± kontrol√º (≈üimdilik 5 firma limiti)
        const maxFirms = 5;
        const topBids = sortedBids.slice(0, maxFirms);
        
        // S√ºtun haritalarƒ±
        const columns = ['F', 'I', 'L', 'O', 'R'];
        
        for (let idx = 0; idx < topBids.length; idx++) {
          const bid = topBids[idx];
          const col = columns[idx];
          
          // Firma bilgileri
          setCellValue(worksheet, `${col}6`, `${bid.supplierName} (${bid.supplierPhone})`);
          
          // √úr√ºn fiyatlarƒ± ve toplamlar
          let totalAmount = 0;
          if (demandData.items && Array.isArray(demandData.items)) {
            demandData.items.forEach((item, itemIdx) => {
              const row = startRow + itemIdx;
              const unitPrice = getBidItemPrice(bid, itemIdx) || 0;
              const quantity = item.quantity || 0;
              const itemTotal = unitPrice * quantity;
              
              // Birim fiyat
              setCellValue(worksheet, `${col}${row}`, unitPrice);
              
              // Toplam fiyat (G, J, M, P, S s√ºtunlarƒ±)
              const totalCol = String.fromCharCode(col.charCodeAt(0) + 1);
              setCellValue(worksheet, `${totalCol}${row}`, itemTotal);
              
              totalAmount += itemTotal;
            });
          }
          
          // Alt satƒ±rlara toplam ve diƒüer bilgiler
          setCellValue(worksheet, `${col}21`, totalAmount); // KDV HARƒ∞√á TOPLAM TUTAR
          setCellValue(worksheet, `${col}22`, bid.paymentTerms || ''); // √ñDEME ≈ûEKLƒ∞
          setCellValue(worksheet, `${col}23`, bid.deliveryDate || ''); // TESLƒ∞M S√úRESƒ∞
          setCellValue(worksheet, `${col}24`, bid.deliveryMethod || demandData.site || ''); // TESLƒ∞M ≈ûEKLƒ∞
          setCellValue(worksheet, `${col}25`, bid.notes || demandData.description || ''); // A√áIKLAMA
        }
        
      } catch (error) {
        logger.error("≈ûablon doldurma hatasƒ±", error);
        throw error;
      }
    }

    function calculateBidTotal(bid, items) {
      if (!items || !Array.isArray(items)) return 0;
      
      return items.reduce((total, item, index) => {
        const unitPrice = getBidItemPrice(bid, index) || 0;
        const quantity = item.quantity || 0;
        return total + (unitPrice * quantity);
      }, 0);
    }

    function getBidItemPrice(bid, itemIndex) {
      // Bid'de items array'i varsa kullan
      if (bid.items && Array.isArray(bid.items) && bid.items[itemIndex]) {
        return bid.items[itemIndex].unitPrice || bid.items[itemIndex].price || 0;
      }
      
      // Tek √ºr√ºn i√ßin netPrice kullan
      if (itemIndex === 0) {
        return bid.netPrice || bid.price || 0;
      }
      
      return 0;
    }

    function setCellValue(worksheet, cellAddress, value) {
      if (!worksheet[cellAddress]) {
        worksheet[cellAddress] = {};
      }
      worksheet[cellAddress].v = value;
      worksheet[cellAddress].t = typeof value === 'number' ? 'n' : 's';
    }

    // ====================
    // Bid Management Functions
    // ====================
    
    async function acceptBid(bidId) {
      // Teklifbul Rol & Onay Sistemi - Guard kontrol√º
      try {
        // Kullanƒ±cƒ± bilgilerini y√ºkle
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const currentUserData = userDoc.exists() ? userDoc.data() : {};
        
        // Rol yetkileri (settings.html'den alƒ±nabilir, ≈üimdilik basit kontrol)
        const rolePermissions = {}; // Bu nesne settings.html'deki rolePermissions ile doldurulabilir
        
        // E-imza onay yetkisi kontrol√º
        const canApprove = canESignApprove(currentUserData, rolePermissions);
        
        if (!canApprove) {
          // Audit log - yetkisiz onay denemesi
          await createAuditLog({
            entity_type: 'bid',
            entity_id: bidId,
            action: 'approve_attempt',
            actor_user_id: user.uid,
            actor_role_key: currentUserData.companyRole || currentUserData.requestedCompanyRole || 'unknown',
            result: 'blocked',
            reason: 'E-imza onay yetkisi yok. Yalnƒ±zca √ºst onaycƒ± rolleri (Genel M√ºd√ºr, GMY, CEO, ƒ∞≈üveren, YKB, YK √úyesi) e-imza ile teklif onaylayabilir.',
            metadata: { bidId, demandId }
          });
          
          toast.error(MESSAGES.ERROR_BID_APPROVAL_PERMISSION + "\n\nMevcut rol√ºn√ºz: " + (currentUserData.companyRole || currentUserData.requestedCompanyRole || 'Belirlenmedi'));
          return;
        }
        
        // PO kontrol√º (eƒüer onay sonrasƒ± PO olu≈üturulacaksa)
        const companyId = currentUserData.companies?.[0] || null;
        if (companyId) {
          const poCheck = await canIssuePO(companyId);
          if (!poCheck.allowed) {
            // Audit log - PO engellendi
            await createAuditLog({
              entity_type: 'bid',
              entity_id: bidId,
              action: 'approve_po_check',
              actor_user_id: user.uid,
              actor_role_key: currentUserData.companyRole || 'unknown',
              result: 'blocked',
              reason: poCheck.reason,
              metadata: { bidId, demandId, companyId }
            });
            
            toast.warn(MESSAGES.WARN_PO_CREATE_BLOCKED + "\n\n" + poCheck.reason);
            // Yine de devam edebilir, sadece PO olu≈üturulamaz
          }
        }
        
        if (confirm("Bu teklifi e-imza ile onaylamak istediƒüinizden emin misiniz?")) {
          try {
            const bidRef = doc(db, "bids", bidId);
            const bidSnap = await getDoc(bidRef);
            const bidData = bidSnap.exists() ? bidSnap.data() : {};
            
            await updateDoc(bidRef, {
              status: "accepted",
              statusHistory: arrayUnion({
                status: "accepted",
                timestamp: Date.now(),
                userId: user.uid,
                notes: "Bid accepted by buyer with e-signature",
                approvedBy: user.uid,
                approvedAt: serverTimestamp(),
                approvalMethod: "e-signature"
              }),
              updatedAt: serverTimestamp(),
              approvedBy: user.uid,
              approvedAt: serverTimestamp()
            });
            
            // Audit log - ba≈üarƒ±lƒ± onay
            await createAuditLog({
              entity_type: 'bid',
              entity_id: bidId,
              action: 'approve_esign',
              actor_user_id: user.uid,
              actor_role_key: currentUserData.companyRole || currentUserData.requestedCompanyRole || 'unknown',
              result: 'success',
              metadata: { bidId, demandId, supplierId: bidData.supplierId, price: bidData.netPrice || bidData.price }
            });
            
            toast.success(MESSAGES.SUCCESS_BID_APPROVED);
            await loadBids();
          } catch (e) {
            logger.error("Error accepting bid", e);
            
            // Audit log - hata
            await createAuditLog({
              entity_type: 'bid',
              entity_id: bidId,
              action: 'approve_esign',
              actor_user_id: user.uid,
              actor_role_key: currentUserData.companyRole || 'unknown',
              result: 'failed',
              reason: e.message || e.toString(),
              metadata: { bidId, demandId }
            });
            
            toast.error(MESSAGES.ERROR_BID_APPROVE + ": " + e.message);
          }
        }
      } catch (e) {
        logger.error("Error in acceptBid guard check", e);
        toast.error(MESSAGES.ERROR_PERMISSION_CHECK + ": " + e.message);
      }
    }

    async function rejectBid(bidId) {
      if (confirm("Bu teklifi reddetmek istediƒüinizden emin misiniz?")) {
        try {
          const bidRef = doc(db, "bids", bidId);
          await updateDoc(bidRef, {
            status: "rejected",
            statusHistory: arrayUnion({
              status: "rejected",
              timestamp: Date.now(),
              userId: user.uid,
              notes: "Bid rejected by buyer"
            }),
            updatedAt: serverTimestamp()
          });
          
          toast.success(MESSAGES.SUCCESS_BID_REJECTED);
          await loadBids();
        } catch (e) {
          logger.error("Error rejecting bid", e);
          toast.error(MESSAGES.ERROR_BID_REJECT + ": " + e.message);
        }
      }
    }

    async function requestBidRevision(bidId) {
      // Prompt for revision notes if not available in textarea
      let revisionNotes = "";
      const notesInput = document.getElementById("revisionNotes");
      if (notesInput) {
        revisionNotes = notesInput.value.trim();
      }
      
      if (!revisionNotes) {
        revisionNotes = prompt("Revizyon talebinizi belirtin:");
        if (!revisionNotes || !revisionNotes.trim()) {
          toast.warn(MESSAGES.WARN_REVISION_REQUEST_NOT_SPECIFIED);
          return;
        }
      }
      
      if (confirm("Revizyon talebi g√∂ndermek istediƒüinizden emin misiniz?")) {
        try {
          const bidRef = doc(db, "bids", bidId);
          await updateDoc(bidRef, {
            status: "revision_requested",
            statusHistory: arrayUnion({
              status: "revision_requested",
              timestamp: Date.now(),
              userId: user.uid,
              notes: revisionNotes
            }),
            updatedAt: serverTimestamp()
          });
          
          toast.success(MESSAGES.SUCCESS_REVISION_REQUEST_SENT_ALT);
          if (notesInput) notesInput.value = "";
          await loadBids();
        } catch (e) {
          logger.error("Error requesting revision", e);
          toast.error(MESSAGES.ERROR_REVISION_REQUEST_SEND + ": " + e.message);
        }
      }
    }

    // Expose functions to global scope for onclick handlers
    // Must be done before page initialization completes
    window.acceptBid = acceptBid;
    window.rejectBid = rejectBid;
    window.requestBidRevision = requestBidRevision;
    
    logger.info("Bid action functions exposed to global scope");

    // ====================
    // Export SATFK Excel - Tedarik√ßi i√ßin Teklif ≈ûablonu
    // ====================
    // ExcelJS ile tam stil desteƒüi - Kenarlƒ±k, renk, kalƒ±n yazƒ±
    async function exportSatfkExcel() {
      try {
        if (!demandData || !itemsData || itemsData.length === 0) {
          toast.error(MESSAGES.ERROR_DEMAND_DATA_NOT_LOADED);
          return;
        }

        // ExcelJS kontrol√º
        if (typeof ExcelJS === 'undefined') {
          toast.error(MESSAGES.ERROR_EXCELJS_LOAD);
          return;
        }

        // XLSX fallback (eski kod i√ßin gerekli olabilir)
        if (typeof XLSX === 'undefined') {
          await loadXLSXLibrary();
        }

        // Tarih formatƒ±
        const fmtDate = (date) => {
          if (!date) return "";
          if (date.toDate) return date.toDate().toLocaleDateString("tr-TR");
          if (date instanceof Date) return date.toLocaleDateString("tr-TR");
          if (typeof date === "string") return date;
          return "";
        };

        // ExcelJS workbook olu≈ütur
        const workbook = new ExcelJS.Workbook();
        
        // Stil yardƒ±mcƒ± fonksiyonlarƒ±
        const applyCellStyle = (cell, options) => {
          if (options.font) cell.font = options.font;
          if (options.fill) cell.fill = options.fill;
          if (options.border) cell.border = options.border;
          if (options.alignment) cell.alignment = options.alignment;
        };
        
        // Stil tanƒ±mlarƒ±
        const styles = {
          // Ana ba≈ülƒ±k: Mavi arka plan, beyaz kalƒ±n yazƒ±
          mainHeader: {
            font: { bold: true, size: 16, color: { argb: 'FFFFFFFF' } },
            fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } },
            border: {
              top: { style: 'medium' },
              left: { style: 'medium' },
              bottom: { style: 'medium' },
              right: { style: 'medium' }
            },
            alignment: { vertical: 'middle', horizontal: 'center' }
          },
          // B√∂l√ºm ba≈ülƒ±ƒüƒ±: Mavi arka plan, beyaz kalƒ±n yazƒ±
          sectionHeader: {
            font: { bold: true, size: 12, color: { argb: 'FFFFFFFF' } },
            fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } },
            border: {
              top: { style: 'medium' },
              left: { style: 'medium' },
              bottom: { style: 'medium' },
              right: { style: 'medium' }
            },
            alignment: { vertical: 'middle', horizontal: 'center' }
          },
          // Tablo ba≈ülƒ±ƒüƒ±: Mavi arka plan, beyaz kalƒ±n yazƒ±
          tableHeader: {
            font: { bold: true, size: 11, color: { argb: 'FFFFFFFF' } },
            fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } },
            border: {
              top: { style: 'medium' },
              left: { style: 'medium' },
              bottom: { style: 'medium' },
              right: { style: 'medium' }
            },
            alignment: { vertical: 'middle', horizontal: 'center', wrapText: true }
          },
          // Etiket: A√ßƒ±k gri arka plan, kalƒ±n yazƒ±
          label: {
            font: { bold: true, size: 11 },
            fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD3D3D3' } },
            border: {
              top: { style: 'thin' },
              left: { style: 'medium' },
              bottom: { style: 'thin' },
              right: { style: 'thin' }
            },
            alignment: { vertical: 'middle', horizontal: 'left', wrapText: true }
          },
          // Veri h√ºcresi: Beyaz arka plan, kenarlƒ±k
          data: {
            font: { size: 11 },
            fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } },
            border: {
              top: { style: 'thin' },
              left: { style: 'thin' },
              bottom: { style: 'thin' },
              right: { style: 'thin' }
            },
            alignment: { vertical: 'middle', horizontal: 'left', wrapText: true }
          },
          // √úr√ºn satƒ±rƒ±: Beyaz arka plan, kenarlƒ±k
          productRow: {
            font: { size: 10 },
            fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } },
            border: {
              top: { style: 'thin' },
              left: { style: 'thin' },
              bottom: { style: 'thin' },
              right: { style: 'thin' }
            },
            alignment: { vertical: 'middle' }
          },
          // Toplam satƒ±rƒ±: Ye≈üil arka plan, beyaz kalƒ±n yazƒ±
          totalRow: {
            font: { bold: true, size: 12, color: { argb: 'FFFFFFFF' } },
            fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF059669' } },
            border: {
              top: { style: 'medium' },
              left: { style: 'medium' },
              bottom: { style: 'medium' },
              right: { style: 'medium' }
            },
            alignment: { vertical: 'middle' }
          }
        };
        
        // ====================
        // SAYFA 1: Talep Bilgileri - ExcelJS ile stil desteƒüi
        // ====================
        const worksheet1 = workbook.addWorksheet("Talep");
        
        // S√ºtun geni≈ülikleri ayarla
        worksheet1.getColumn(1).width = 15;   // A: Etiketler / Sƒ±ra No
        worksheet1.getColumn(2).width = 20;   // B: Deƒüerler / Malzeme Kodu
        worksheet1.getColumn(3).width = 40;   // C: Tanƒ±m
        worksheet1.getColumn(4).width = 20;   // D: Marka/Model
        worksheet1.getColumn(5).width = 10;   // E: Miktar
        worksheet1.getColumn(6).width = 10;   // F: Birim
        worksheet1.getColumn(7).width = 18;   // G: ƒ∞stenilen Teslim Tarihi
        worksheet1.getColumn(8).width = 12;   // H: Birim Fiyat
        worksheet1.getColumn(9).width = 10;   // I: KDV (%)
        worksheet1.getColumn(10).width = 18;  // J: KDV Hari√ß Toplam
        worksheet1.getColumn(11).width = 18;  // K: KDV Dahil Toplam

        let currentRow = 1;
        
        // 1. Ana ba≈ülƒ±k: TALEP FORMU (A1:K1 birle≈ütir, mavi arka plan, beyaz kalƒ±n yazƒ±)
        worksheet1.getCell(currentRow, 1).value = "TALEP FORMU";
        worksheet1.mergeCells(currentRow, 1, currentRow, 11);
        applyCellStyle(worksheet1.getCell(currentRow, 1), styles.mainHeader);
        worksheet1.getRow(currentRow).height = 30;
        currentRow++;
        
        // Bo≈ü satƒ±r
        currentRow++;
        
        // 2. B√∂l√ºm ba≈ülƒ±ƒüƒ±: TALEP Bƒ∞LGƒ∞LERƒ∞ (A3:K3 birle≈ütir)
        worksheet1.getCell(currentRow, 1).value = "TALEP Bƒ∞LGƒ∞LERƒ∞";
        worksheet1.mergeCells(currentRow, 1, currentRow, 11);
        applyCellStyle(worksheet1.getCell(currentRow, 1), styles.sectionHeader);
        worksheet1.getRow(currentRow).height = 25;
        currentRow++;
        
        // 3. Talep detaylarƒ± - 2 s√ºtun formatƒ± (etiket | deƒüer)
        const demandDetails = [
          ["Talep Kodu:", demandData.satfk || demandData.talep_kodu || demandData.demandCode || ""],
          ["STF No:", ""],
          ["≈ûantiye:", demandData.siteName || demandData.santiye || ""],
          ["Talep Tarihi:", fmtDate(demandData.demandDate || demandData.createdAt)],
          ["Termin:", fmtDate(demandData.dueDate || demandData.termin_tarihi)],
          ["Talep Eden:", demandData.creatorCompanyName || ""],
          ["Teslimat Adresi:", demandData.deliveryAddress || demandData.deliveryLocation || ""],
          ["Teslim ≈ûekli:", demandData.deliveryMethod || ""],
          ["Teslim Yeri:", ""],
          ["Alƒ±m Yeri (ƒ∞l):", demandData.purchaseLocation || ""],
          ["Para Birimi:", demandData.currency || "TRY"],
          ["√ñdeme ≈ûartlarƒ±:", demandData.paymentTerms || ""],
          ["Onaylayan:", ""],
          ["Satƒ±nalma Sorumlusu:", ""],
          ["Genel M√ºd√ºr:", ""],
          ["Kategoriler:", (demandData.categoryTags || []).join(", ") || ""]
        ];

        // Talep detaylarƒ±nƒ± yaz (etiket: a√ßƒ±k gri, deƒüer: beyaz, her ikisi de kenarlƒ±klƒ±)
        demandDetails.forEach(([label, value]) => {
          // A s√ºtunu: Etiket (a√ßƒ±k gri arka plan, kalƒ±n)
          worksheet1.getCell(currentRow, 1).value = label;
          applyCellStyle(worksheet1.getCell(currentRow, 1), styles.label);
          
          // B s√ºtunu: Deƒüer (beyaz arka plan)
          worksheet1.getCell(currentRow, 2).value = value;
          applyCellStyle(worksheet1.getCell(currentRow, 2), styles.data);
          
          // C-K s√ºtunlarƒ±: Bo≈ü ama kenarlƒ±klƒ±
          for (let col = 3; col <= 11; col++) {
            applyCellStyle(worksheet1.getCell(currentRow, col), styles.data);
          }
          
          worksheet1.getRow(currentRow).height = 20;
          currentRow++;
        });

        // Bo≈ü satƒ±r
        currentRow++;
        
        // 4. √úr√ºn listesi ba≈ülƒ±ƒüƒ±: √úR√úN Lƒ∞STESƒ∞ VE TEKLƒ∞F FORMU
        worksheet1.getCell(currentRow, 1).value = "√úR√úN Lƒ∞STESƒ∞ VE TEKLƒ∞F FORMU";
        worksheet1.mergeCells(currentRow, 1, currentRow, 11);
        applyCellStyle(worksheet1.getCell(currentRow, 1), styles.sectionHeader);
        worksheet1.getRow(currentRow).height = 25;
        currentRow++;
        
        // Bo≈ü satƒ±r
        currentRow++;
        
        // 5. √úr√ºn tablosu ba≈ülƒ±k satƒ±rƒ± (mavi arka plan, beyaz kalƒ±n yazƒ±, kenarlƒ±k)
        const productTableHeaderRow = currentRow;
        const headerLabels = ["Sƒ±ra No", "Malzeme Kodu", "Tanƒ±m", "Marka/Model", "Miktar", "Birim", "ƒ∞stenilen Teslim Tarihi", "Birim Fiyat", "KDV (%)", "KDV Hari√ß Toplam", "KDV Dahil Toplam"];
        headerLabels.forEach((label, idx) => {
          worksheet1.getCell(currentRow, idx + 1).value = label;
          applyCellStyle(worksheet1.getCell(currentRow, idx + 1), styles.tableHeader);
        });
        worksheet1.getRow(currentRow).height = 30;
        currentRow++;

        // 6. √úr√ºn satƒ±rlarƒ±nƒ± yaz (her satƒ±r kenarlƒ±klƒ±)
        const firstProductRow = currentRow;
        itemsData.forEach((item, idx) => {
          const lineNo = item.lineNo || item.no || (idx + 1);
          const qty = item.qty || item.quantity || 0;
          const unit = item.unit || "";
          const name = item.name || item.description || "";
          const sku = item.sku || item.materialCode || "";
          const brand = item.brandModel || item.brand || "";
          const deliveryDate = fmtDate(item.itemDueDate || item.req_date || item.deliveryDate || demandData.dueDate);
          
          // √úr√ºn verilerini yaz
          worksheet1.getCell(currentRow, 1).value = lineNo;              // A: Sƒ±ra No
          worksheet1.getCell(currentRow, 2).value = sku;                 // B: Malzeme Kodu
          worksheet1.getCell(currentRow, 3).value = name;                // C: Tanƒ±m
          worksheet1.getCell(currentRow, 4).value = brand;              // D: Marka/Model
          worksheet1.getCell(currentRow, 5).value = qty;                 // E: Miktar
          worksheet1.getCell(currentRow, 6).value = unit;               // F: Birim
          worksheet1.getCell(currentRow, 7).value = deliveryDate;        // G: ƒ∞stenilen Teslim Tarihi
          worksheet1.getCell(currentRow, 8).value = "";                 // H: Birim Fiyat (TEDARƒ∞K√áƒ∞ DOLDURUR)
          worksheet1.getCell(currentRow, 9).value = "";                 // I: KDV (%) (TEDARƒ∞K√áƒ∞ DOLDURUR)
          
          // Form√ºller: J = E*H*(1-I/100), K = E*H
          const jFormula = `IF(AND(E${currentRow}<>"",H${currentRow}<>""),E${currentRow}*H${currentRow},"")`;
          const kFormula = `IF(AND(E${currentRow}<>"",H${currentRow}<>"",I${currentRow}<>""),E${currentRow}*H${currentRow}*(1+I${currentRow}/100),"")`;
          worksheet1.getCell(currentRow, 10).value = { formula: jFormula };  // J: KDV Hari√ß Toplam
          worksheet1.getCell(currentRow, 11).value = { formula: kFormula };  // K: KDV Dahil Toplam

        // Stil uygula
          const rowStyle = { ...styles.productRow };
          rowStyle.alignment = { vertical: 'middle', horizontal: 'left', wrapText: true };
          for (let col = 1; col <= 11; col++) {
            const cell = worksheet1.getCell(currentRow, col);
            // Sayƒ±sal s√ºtunlar i√ßin ortala
            if ([1, 5, 6, 8, 9].includes(col)) {
              rowStyle.alignment.horizontal = 'center';
            } else {
              rowStyle.alignment.horizontal = 'left';
            }
            applyCellStyle(cell, rowStyle);
          }
          
          worksheet1.getRow(currentRow).height = 20;
          currentRow++;
        });
        
        // 7. Toplam satƒ±rƒ± (ye≈üil arka plan, beyaz kalƒ±n yazƒ±, kenarlƒ±k, form√ºller)
        const totalRow = currentRow;
        worksheet1.getCell(currentRow, 1).value = "TOPLAM:";
        worksheet1.getCell(currentRow, 10).value = { formula: `SUM(J${firstProductRow}:J${currentRow - 1})` };
        worksheet1.getCell(currentRow, 11).value = { formula: `SUM(K${firstProductRow}:K${currentRow - 1})` };
        
        // Toplam satƒ±rƒ±na stil uygula
        applyCellStyle(worksheet1.getCell(currentRow, 1), styles.totalRow);
        applyCellStyle(worksheet1.getCell(currentRow, 1), { ...styles.totalRow, alignment: { vertical: 'middle', horizontal: 'left' } });
        for (let col = 2; col <= 9; col++) {
          applyCellStyle(worksheet1.getCell(currentRow, col), styles.totalRow);
        }
        applyCellStyle(worksheet1.getCell(currentRow, 10), { ...styles.totalRow, alignment: { vertical: 'middle', horizontal: 'right' } });
        applyCellStyle(worksheet1.getCell(currentRow, 11), { ...styles.totalRow, alignment: { vertical: 'middle', horizontal: 'right' } });
        worksheet1.getRow(currentRow).height = 30;
        currentRow++;
        
        // Bo≈ü satƒ±r
        currentRow++;
        
        // 8. Not satƒ±rƒ±
        worksheet1.getCell(currentRow, 1).value = "NOT: L√ºtfen 'Birim Fiyat' ve 'KDV (%)' s√ºtunlarƒ±nƒ± doldurunuz. Toplamlar otomatik hesaplanacaktƒ±r.";
        worksheet1.mergeCells(currentRow, 1, currentRow, 11);
        worksheet1.getRow(currentRow).height = 20;
        currentRow++;

        // SAYFA 1 tamamlandƒ± - ExcelJS ile stil uygulandƒ±

        // ====================
        // SAYFA 2: Teklif - ExcelJS ile stil desteƒüi
        // ====================
        const worksheet2 = workbook.addWorksheet("Teklif");
        
        // S√ºtun geni≈ülikleri ayarla (A-T arasƒ±, S ve T eklendi)
        worksheet2.getColumn(1).width = 15;   // A: Etiketler / Sƒ±ra No
        worksheet2.getColumn(2).width = 20;   // B: Deƒüerler / √úr√ºn Kodu
        worksheet2.getColumn(3).width = 30;   // C: √úr√ºn Adƒ±
        worksheet2.getColumn(4).width = 30;   // D: Teklif Tanƒ±mƒ±
        worksheet2.getColumn(5).width = 10;   // E: Miktar
        worksheet2.getColumn(6).width = 10;   // F: Birim
        worksheet2.getColumn(7).width = 18;   // G: Birim Fiyat
        worksheet2.getColumn(8).width = 10;   // H: ƒ∞skonto %1
        worksheet2.getColumn(9).width = 10;   // I: ƒ∞skonto %2
        worksheet2.getColumn(10).width = 10;  // J: ƒ∞skonto %3
        worksheet2.getColumn(11).width = 10;  // K: ƒ∞skonto %4
        worksheet2.getColumn(12).width = 10;  // L: ƒ∞skonto %5
        worksheet2.getColumn(13).width = 10;  // M: KDV (%)
        worksheet2.getColumn(14).width = 15;  // N: Teslim Tarihi
        worksheet2.getColumn(15).width = 12;  // O: Para Birimi
        worksheet2.getColumn(16).width = 20;  // P: Kalite/Sertifika
        worksheet2.getColumn(17).width = 25;  // Q: G√∂rsel URL
        worksheet2.getColumn(18).width = 30;  // R: Ek A√ßƒ±klama
        worksheet2.getColumn(19).width = 18;  // S: KDV Hari√ß Toplam (AUTO)
        worksheet2.getColumn(20).width = 18;  // T: KDV Dahil Toplam (AUTO)
        
        let currentRow2 = 1;

        // 1. Ana ba≈ülƒ±k: TEKLƒ∞F FORMU (A1:T1 birle≈ütir)
        worksheet2.getCell(currentRow2, 1).value = "TEKLƒ∞F FORMU";
        worksheet2.mergeCells(currentRow2, 1, currentRow2, 20);
        applyCellStyle(worksheet2.getCell(currentRow2, 1), styles.mainHeader);
        worksheet2.getRow(currentRow2).height = 30;
        currentRow2++;
        
        // Bo≈ü satƒ±r
        currentRow2++;
        
        // 2. B√∂l√ºm ba≈ülƒ±ƒüƒ±: TEKLƒ∞F Bƒ∞LGƒ∞LERƒ∞ (A3:T3 birle≈ütir)
        worksheet2.getCell(currentRow2, 1).value = "TEKLƒ∞F Bƒ∞LGƒ∞LERƒ∞";
        worksheet2.mergeCells(currentRow2, 1, currentRow2, 20);
        applyCellStyle(worksheet2.getCell(currentRow2, 1), styles.sectionHeader);
        worksheet2.getRow(currentRow2).height = 25;
        currentRow2++;
        
        // 3. Teklif detaylarƒ± - 2 s√ºtun formatƒ± (B=Etiket, C=Deƒüer) per VBA prompt
        const teklifDetails = [
          { label: "Para Birimi:", cell: 'C4', row: currentRow2 },           // B4: label, C4: value (dropdown)
          { label: "Ge√ßerlilik S√ºresi:", cell: 'C5', row: currentRow2 + 1 },  // B5: label, C5: value (number)
          { label: "Teslim ≈ûekli/Modu:", cell: 'C6', row: currentRow2 + 2 },  // B6: label, C6: value (dropdown)
          { label: "Garanti S√ºresi (Ay):", cell: 'C7', row: currentRow2 + 3 }, // B7: label, C7: value (number)
          { label: "√ñdeme Planƒ±:", cell: 'C8', row: currentRow2 + 4 },        // B8: label, C8: value (dropdown)
          { label: "Teslimat Adresi:", cell: 'C9', row: currentRow2 + 5, merged: true }, // B9: label, C9:H9: value (merged, wrap)
          { label: "Genel Notlar:", cell: 'C10', row: currentRow2 + 6, merged: true }    // B10: label, C10:H10: value (merged, wrap)
        ];

        // Teklif detaylarƒ±nƒ± yaz (B=Etiket, C=Deƒüer) per VBA prompt
        teklifDetails.forEach((item, idx) => {
          const row = item.row;
          
          // B s√ºtunu: Etiket (a√ßƒ±k gri arka plan, kalƒ±n) - per VBA prompt B4:B10
          worksheet2.getCell(row, 2).value = item.label;
          applyCellStyle(worksheet2.getCell(row, 2), styles.label);
          
          // C s√ºtunu: Deƒüer (beyaz arka plan)
          // For merged cells (C9:H9, C10:H10), merge first then set value
          if (item.merged) {
            const startCol = 3; // C
            const endCol = 8;   // H
            worksheet2.mergeCells(row, startCol, row, endCol);
            worksheet2.getCell(row, startCol).value = "";
            applyCellStyle(worksheet2.getCell(row, startCol), { ...styles.data, alignment: { vertical: 'top', horizontal: 'left', wrapText: true } });
          } else {
            worksheet2.getCell(row, 3).value = "";
            applyCellStyle(worksheet2.getCell(row, 3), styles.data);
          }
          
          // C-T s√ºtunlarƒ±: Bo≈ü ama kenarlƒ±klƒ± (for non-merged rows)
          if (!item.merged) {
            for (let col = 4; col <= 20; col++) {
              applyCellStyle(worksheet2.getCell(row, col), styles.data);
            }
          }
          
          worksheet2.getRow(row).height = item.merged ? 48 : 20; // Merged rows taller for wrap text
          if (idx === teklifDetails.length - 2) currentRow2 = row + 1; // Update currentRow2 after last detail
        });
        
        currentRow2 = teklifDetails[teklifDetails.length - 1].row + 1;

        // Bo≈ü satƒ±r
        currentRow2++;
        
        // 4. √úr√ºn kalemleri ba≈ülƒ±ƒüƒ±: √úR√úN KALEMLERƒ∞ TEKLƒ∞Fƒ∞
        worksheet2.getCell(currentRow2, 1).value = "√úR√úN KALEMLERƒ∞ TEKLƒ∞Fƒ∞";
        worksheet2.mergeCells(currentRow2, 1, currentRow2, 20);
        applyCellStyle(worksheet2.getCell(currentRow2, 1), styles.sectionHeader);
        worksheet2.getRow(currentRow2).height = 25;
        currentRow2++;
        
        // Bo≈ü satƒ±r
        currentRow2++;
        
        // 5. √úr√ºn tablosu ba≈ülƒ±k satƒ±rƒ± (row 14 per VBA prompt: A14:T14)
        // Per VBA: "TEKLIF ‚Äì TABLE (headers at row 14; data starts row 15)"
        const productTableHeaderRow2 = 14; // Fixed at row 14 per VBA prompt
        if (currentRow2 !== productTableHeaderRow2) {
          // Adjust currentRow2 to match row 14 if needed
          currentRow2 = productTableHeaderRow2;
        }
        const headerLabels2 = [
            "Sƒ±ra No", "√úr√ºn Kodu", "√úr√ºn Adƒ±/Tanƒ±m", "Teklif Tanƒ±mƒ±", "Miktar", "Birim", 
            "Birim Fiyat (KDV Hari√ß)", "ƒ∞skonto %1", "ƒ∞skonto %2", "ƒ∞skonto %3", "ƒ∞skonto %4", "ƒ∞skonto %5",
          "KDV (%)", "Teslim Tarihi", "Para Birimi", "Kalite/Sertifika", "G√∂rsel URL", "Ek A√ßƒ±klama",
          "KDV Hari√ß Toplam", "KDV Dahil Toplam"
        ];
        headerLabels2.forEach((label, idx) => {
          worksheet2.getCell(currentRow2, idx + 1).value = label;
          applyCellStyle(worksheet2.getCell(currentRow2, idx + 1), styles.tableHeader);
        });
        worksheet2.getRow(currentRow2).height = 40; // WrapText i√ßin daha y√ºksek
        currentRow2++;
        
        // 6. √úr√ºn satƒ±rlarƒ±nƒ± yaz (her satƒ±r kenarlƒ±klƒ±)
        const firstProductRow2 = currentRow2;
        itemsData.forEach((item, idx) => {
          const lineNo = item.lineNo || item.no || (idx + 1);
          const qty = item.qty || item.quantity || 0;
          const unit = item.unit || "";
          const name = item.name || item.description || "";
          const sku = item.sku || item.materialCode || "";
          
          // √úr√ºn verilerini yaz
          worksheet2.getCell(currentRow2, 1).value = lineNo;              // A: Sƒ±ra No
          worksheet2.getCell(currentRow2, 2).value = sku;               // B: √úr√ºn Kodu
          worksheet2.getCell(currentRow2, 3).value = name;               // C: √úr√ºn Adƒ±/Tanƒ±m
          worksheet2.getCell(currentRow2, 4).value = "";                 // D: Teklif Tanƒ±mƒ± (TEDARƒ∞K√áƒ∞ DOLDURUR)
          worksheet2.getCell(currentRow2, 5).value = qty;                // E: Miktar
          worksheet2.getCell(currentRow2, 6).value = unit;               // F: Birim
          worksheet2.getCell(currentRow2, 7).value = "";                 // G: Birim Fiyat (KDV Hari√ß) (TEDARƒ∞K√áƒ∞ DOLDURUR)
          worksheet2.getCell(currentRow2, 8).value = "";                 // H: ƒ∞skonto %1
          worksheet2.getCell(currentRow2, 9).value = "";                 // I: ƒ∞skonto %2
          worksheet2.getCell(currentRow2, 10).value = "";                // J: ƒ∞skonto %3
          worksheet2.getCell(currentRow2, 11).value = "";                // K: ƒ∞skonto %4
          worksheet2.getCell(currentRow2, 12).value = "";               // L: ƒ∞skonto %5
          worksheet2.getCell(currentRow2, 13).value = "";                // M: KDV (%)
          worksheet2.getCell(currentRow2, 14).value = "";                // N: Teslim Tarihi
          worksheet2.getCell(currentRow2, 15).value = "";                // O: Para Birimi
          worksheet2.getCell(currentRow2, 16).value = "";               // P: Kalite/Sertifika
          worksheet2.getCell(currentRow2, 17).value = "";                // Q: G√∂rsel URL
          worksheet2.getCell(currentRow2, 18).value = "";               // R: Ek A√ßƒ±klama
          
          // S: KDV Hari√ß Toplam (OTOMATIK HESAPLANIR)
          // Form√ºl: E √ó G √ó (1-H/100) √ó (1-I/100) √ó (1-J/100) √ó (1-K/100) √ó (1-L/100)
          // ƒ∞skonto yoksa sadece E √ó G
          const row = currentRow2;
          const iskontoFormula = `IF(AND(E${row}<>"",G${row}<>""),E${row}*G${row}*IF(H${row}<>"",1-H${row}/100,1)*IF(I${row}<>"",1-I${row}/100,1)*IF(J${row}<>"",1-J${row}/100,1)*IF(K${row}<>"",1-K${row}/100,1)*IF(L${row}<>"",1-L${row}/100,1),"")`;
          worksheet2.getCell(currentRow2, 19).value = { formula: iskontoFormula };
          
          // T: KDV Dahil Toplam (OTOMATIK HESAPLANIR)
          // Form√ºl: S √ó (1 + M/100)
          const kdvFormula = `IF(AND(S${row}<>"",M${row}<>""),S${row}*(1+M${row}/100),"")`;
          worksheet2.getCell(currentRow2, 20).value = { formula: kdvFormula };
          
          // Stil uygula (t√ºm s√ºtunlar kenarlƒ±klƒ±, S ve T dahil)
          const rowStyle = { ...styles.productRow };
          for (let col = 1; col <= 20; col++) {
            const cell = worksheet2.getCell(currentRow2, col);
            // Sayƒ±sal s√ºtunlar i√ßin ortala veya saƒüa hizala
            if ([1, 5, 6, 8, 9, 10, 11, 12, 13].includes(col)) {
              rowStyle.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
            } else if ([19, 20].includes(col)) {
              // S ve T: Saƒüa hizalƒ± (sayƒ±sal deƒüerler)
              rowStyle.alignment = { vertical: 'middle', horizontal: 'right', wrapText: true };
            } else {
              rowStyle.alignment = { vertical: 'middle', horizontal: 'left', wrapText: true };
            }
            applyCellStyle(cell, rowStyle);
          }
          
          worksheet2.getRow(currentRow2).height = 20;
          currentRow2++;
        });
        
        // 7. KDV TOPLAM SATIRLARI (√úr√ºn tablosunun altƒ±na - S ve T s√ºtunlarƒ±ndan toplam)
        // Bo≈ü satƒ±r
        currentRow2++;
        
        // KDV Hari√ß Toplam satƒ±rƒ± (S s√ºtunundaki t√ºm deƒüerlerin toplamƒ±)
        const totalExclVatRow = currentRow2;
        const lastProductRow2 = currentRow2 - 2; // √úr√ºn satƒ±rlarƒ±nƒ±n son satƒ±rƒ± (bo≈ü satƒ±r √∂ncesi)
        worksheet2.getCell(currentRow2, 18).value = "KDV Hari√ß Toplam:";
        worksheet2.getCell(currentRow2, 19).value = { formula: `SUM(S${firstProductRow2}:S${lastProductRow2})` }; // S s√ºtunundaki t√ºm deƒüerlerin toplamƒ±
        // Stil uygula (P ve S s√ºtunlarƒ± birle≈ütir)
        applyCellStyle(worksheet2.getCell(currentRow2, 18), { ...styles.totalRow, alignment: { vertical: 'middle', horizontal: 'right' } });
        applyCellStyle(worksheet2.getCell(currentRow2, 19), { ...styles.totalRow, alignment: { vertical: 'middle', horizontal: 'right' } });
        worksheet2.getRow(currentRow2).height = 30;
        currentRow2++;
        
        // KDV Dahil Toplam satƒ±rƒ± (T s√ºtunundaki t√ºm deƒüerlerin toplamƒ±)
        const totalInclVatRow = currentRow2;
        worksheet2.getCell(currentRow2, 18).value = "KDV Dahil Toplam:";
        worksheet2.getCell(currentRow2, 20).value = { formula: `SUM(T${firstProductRow2}:T${lastProductRow2})` }; // T s√ºtunundaki t√ºm deƒüerlerin toplamƒ±
        // Stil uygula
        applyCellStyle(worksheet2.getCell(currentRow2, 18), { ...styles.totalRow, alignment: { vertical: 'middle', horizontal: 'right' } });
        applyCellStyle(worksheet2.getCell(currentRow2, 20), { ...styles.totalRow, alignment: { vertical: 'middle', horizontal: 'right' } });
        // Bo≈ü h√ºcreler (P, Q, R, S, T hari√ß diƒüerleri) de stil uygula
        for (let col = 1; col <= 20; col++) {
          if (![18, 19, 20].includes(col)) {
            applyCellStyle(worksheet2.getCell(currentRow2, col), styles.totalRow);
          }
        }
        worksheet2.getRow(currentRow2).height = 30;
        currentRow2++;
        
        // SAYFA 2 tamamlandƒ± - ExcelJS ile stil uygulandƒ±
        
        // ====================
        // VBA PROMPT √ñZELLƒ∞KLERƒ∞: Data Validation, Tables, Print Settings
        // ====================
        
        // 1. Create hidden "Lists" sheet for dropdown options
        const listsSheet = workbook.addWorksheet("Lists");
        listsSheet.state = 'hidden'; // VeryHidden equivalent
        const vatRates = [0, 1, 8, 10, 18, 20];
        const currencies = ["TRY", "USD", "EUR"];
        const paymentOptions = ["Pe≈üin", "Kredi Kartƒ±", "A√ßƒ±k Hesap", "Evrak"];
        const shippingModes = ["Nakliye Hari√ß", "Nakliye Dahil", "√ñzel/Anla≈ümaya G√∂re"];
        
        // Write lists to sheet
        listsSheet.getCell(1, 1).value = "VatRateOptions";
        vatRates.forEach((rate, idx) => {
          listsSheet.getCell(idx + 2, 1).value = rate;
        });
        
        listsSheet.getCell(1, 2).value = "CurrencyOptions";
        currencies.forEach((curr, idx) => {
          listsSheet.getCell(idx + 2, 2).value = curr;
        });
        
        listsSheet.getCell(1, 3).value = "PaymentOptions";
        paymentOptions.forEach((pay, idx) => {
          listsSheet.getCell(idx + 2, 3).value = pay;
        });
        
        listsSheet.getCell(1, 4).value = "ShippingModeOptions";
        shippingModes.forEach((ship, idx) => {
          listsSheet.getCell(idx + 2, 4).value = ship;
        });
        
        // Create named ranges for data validation
        workbook.definedNames.add('VatRateOptions', 'Lists!$A$2:$A$' + (vatRates.length + 1));
        workbook.definedNames.add('CurrencyOptions', 'Lists!$B$2:$B$' + (currencies.length + 1));
        workbook.definedNames.add('PaymentOptions', 'Lists!$C$2:$C$' + (paymentOptions.length + 1));
        workbook.definedNames.add('ShippingModeOptions', 'Lists!$D$2:$D$' + (shippingModes.length + 1));
        
        // 2. TEKLIF sheet: Apply data validation dropdowns
        // C4: Para Birimi dropdown
        worksheet2.getCell('C4').dataValidation = {
          type: 'list',
          allowBlank: false,
          formulae: [`"${currencies.join(',')}"`],
          showErrorMessage: true,
          errorStyle: 'stop',
          errorTitle: 'Ge√ßersiz Se√ßim',
          error: 'L√ºtfen ge√ßerli bir para birimi se√ßin (TRY, USD, EUR)'
        };
        
        // C5: Ge√ßerlilik S√ºresi (whole number >=1)
        worksheet2.getCell('C5').dataValidation = {
          type: 'whole',
          operator: 'greaterThan',
          formulae: [0],
          showErrorMessage: true,
          errorStyle: 'stop',
          errorTitle: 'Ge√ßersiz Deƒüer',
          error: 'Ge√ßerlilik s√ºresi en az 1 g√ºn olmalƒ±dƒ±r'
        };
        
        // C6: Teslim ≈ûekli dropdown
        worksheet2.getCell('C6').dataValidation = {
          type: 'list',
          allowBlank: false,
          formulae: [`"${shippingModes.join(',')}"`],
          showErrorMessage: true,
          errorStyle: 'stop',
          errorTitle: 'Ge√ßersiz Se√ßim',
          error: 'L√ºtfen ge√ßerli bir teslim ≈üekli se√ßin'
        };
        
        // C7: Garanti S√ºresi (whole number >=0)
        worksheet2.getCell('C7').dataValidation = {
          type: 'whole',
          operator: 'greaterThanOrEqual',
          formulae: [0],
          showErrorMessage: true,
          errorStyle: 'stop',
          errorTitle: 'Ge√ßersiz Deƒüer',
          error: 'Garanti s√ºresi 0 veya daha b√ºy√ºk olmalƒ±dƒ±r'
        };
        
        // C8: √ñdeme Planƒ± dropdown
        worksheet2.getCell('C8').dataValidation = {
          type: 'list',
          allowBlank: false,
          formulae: [`"${paymentOptions.join(',')}"`],
          showErrorMessage: true,
          errorStyle: 'stop',
          errorTitle: 'Ge√ßersiz Se√ßim',
          error: 'L√ºtfen ge√ßerli bir √∂deme planƒ± se√ßin'
        };
        
        // M column (KDV %): Apply dropdown to all product rows
        const kdvCol = 13; // M column
        for (let row = firstProductRow2; row <= lastProductRow2; row++) {
          worksheet2.getCell(row, kdvCol).dataValidation = {
            type: 'list',
            allowBlank: true,
            formulae: [`"${vatRates.join(',')}"`],
            showErrorMessage: true,
            errorStyle: 'stop',
            errorTitle: 'Ge√ßersiz KDV Oranƒ±',
            error: 'L√ºtfen ge√ßerli bir KDV oranƒ± se√ßin (0, 1, 8, 10, 18, 20)'
          };
        }
        
        // 3. TALEP sheet: Apply KDV dropdown to I column (product rows start at row 24 per prompt)
        const talepKdvCol = 9; // I column
        const talepFirstRow = 24; // Product rows start at 24
        const talepLastRow = firstProductRow + itemsData.length - 1; // Adjust based on actual data
        
        // Note: Talep sheet I column should also have KDV dropdown if it exists
        // We'll apply to the range where data might be filled
        
        // 4. Convert to Excel Tables (ListObjects) for structured references
        // TEKLIF table (tblTeklif) - from row 14 (header) down per VBA prompt
        try {
          const teklifTable = worksheet2.addTable({
            name: 'tblTeklif',
            displayName: 'tblTeklif',
            ref: `A${productTableHeaderRow2}:T${lastProductRow2}`, // Row 14 header, data starts 15
            headerRow: true,
            totalsRow: false,
            style: {
              theme: 'TableStyleMedium2',
              showFirstColumn: false,
              showLastColumn: false,
              showRowStripes: true,
              showColumnStripes: false
            },
            columns: headerLabels2.map(label => ({ name: label, filterButton: false }))
          });
        } catch (e) {
          logger.warn('Could not create tblTeklif table', e);
        }
        
        // TALEP table (tblTalep) - from row 24 (header) down
        try {
          const talepTable = worksheet1.addTable({
            name: 'tblTalep',
            displayName: 'tblTalep',
            ref: `A${productTableHeaderRow}:K${totalRow - 1}`, // Exclude total row
            headerRow: true,
            totalsRow: true, // Enable totals row
            style: {
              theme: 'TableStyleMedium2',
              showFirstColumn: false,
              showLastColumn: false,
              showRowStripes: true,
              showColumnStripes: false
            },
            columns: headerLabels.map((label, idx) => ({
              name: label,
              filterButton: false,
              totalsRowFunction: (idx === 9 || idx === 10) ? 'sum' : 'none' // J and K columns
            }))
          });
          
          // Set totals row formulas using structured references (Excel will auto-update)
          // Note: ExcelJS doesn't fully support structured references in formulas, so we'll use SUM
        } catch (e) {
          logger.warn('Could not create tblTalep table', e);
        }
        
        // 5. Freeze panes - TEKLIF: below row 3 (keep header visible)
        worksheet2.views = [
          {
            state: 'frozen',
            ySplit: 3,
            activeCell: 'A4',
            showGridLines: true
          }
        ];
        
        // TALEP: below row 24 (keep product header visible)
        worksheet1.views = [
          {
            state: 'frozen',
            ySplit: productTableHeaderRow,
            activeCell: `A${productTableHeaderRow + 1}`,
            showGridLines: true
          }
        ];
        
        // 6. Print settings for both sheets
        // TEKLIF print settings
        worksheet2.pageSetup = {
          orientation: 'portrait',
          fitToPage: true,
          fitToWidth: 1,
          fitToHeight: false,
          paperSize: 9, // A4
          margins: {
            left: 0.7,
            right: 0.7,
            top: 0.75,
            bottom: 0.75,
            header: 0.3,
            footer: 0.3
          },
          printArea: `A1:T${currentRow2}`, // From top to last row
          showGridLines: true
        };
        
        // TALEP print settings
        worksheet1.pageSetup = {
          orientation: 'portrait',
          fitToPage: true,
          fitToWidth: 1,
          fitToHeight: false,
          paperSize: 9, // A4
          margins: {
            left: 0.7,
            right: 0.7,
            top: 0.75,
            bottom: 0.75,
            header: 0.3,
            footer: 0.3
          },
          printArea: `A1:K${currentRow}`, // From top to last row
          showGridLines: true
        };
        
        // 7. Wrap text for long text cells (TEKLIF C9:H9 and C10:H10)
        worksheet2.getRow(9).height = 48; // Teslimat Adresi row
        worksheet2.getRow(10).height = 48; // Genel Notlar row
        worksheet2.getCell('C9').alignment = { ...worksheet2.getCell('C9').alignment, wrapText: true, vertical: 'top' };
        worksheet2.getCell('C10').alignment = { ...worksheet2.getCell('C10').alignment, wrapText: true, vertical: 'top' };
        
        // TALEP: Wrap text for B10 (Teslimat Adresi) and B19 (Kategoriler)
        if (demandDetails.length > 0) {
          // Find row with "Teslimat Adresi:" (usually around row 7-8)
          // Find row with "Kategoriler:" (last item in demandDetails)
          const teslimatRow = demandDetails.findIndex(([label]) => label.includes('Teslimat Adresi')) + 3; // +3 for header rows
          const kategorilerRow = demandDetails.findIndex(([label]) => label.includes('Kategoriler')) + 3;
          
          if (teslimatRow > 3) {
            worksheet1.getRow(teslimatRow).height = 36;
            worksheet1.getCell(`B${teslimatRow}`).alignment = { ...worksheet1.getCell(`B${teslimatRow}`).alignment, wrapText: true, vertical: 'top' };
          }
          if (kategorilerRow > 3) {
            worksheet1.getRow(kategorilerRow).height = 36;
            worksheet1.getCell(`B${kategorilerRow}`).alignment = { ...worksheet1.getCell(`B${kategorilerRow}`).alignment, wrapText: true, vertical: 'top' };
          }
        }
        
        // ====================
        // Excel dosyasƒ±nƒ± kaydet (ExcelJS formatƒ±)
        // ====================
        const satfk = demandData.satfk || demandData.talep_kodu || demandData.demandCode || "talep";
        const filename = `Teklif_Formu_${satfk}.xlsx`;
        
        // ExcelJS workbook'u buffer olarak kaydet ve indir
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);

        logger.info("Teklif formu Excel'i indirildi", { filename: `Teklif_Formu_${satfk}.xlsx` });
  toast.success(MESSAGES.INFO_EXCEL_FORM_INSTRUCTIONS);
      } catch (error) {
        logger.error("Excel olu≈üturma hatasƒ±", error);
        toast.error(MESSAGES.ERROR_EXCEL_CREATE + ": " + (error.message || error));
      }
    }

    // XLSX k√ºt√ºphanesini y√ºkle
    async function loadXLSXLibrary() {
      return new Promise((resolve, reject) => {
        if (typeof XLSX !== 'undefined') {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        script.onload = () => {
          logger.info("XLSX k√ºt√ºphanesi y√ºklendi");
          resolve();
        };
        script.onerror = () => {
          reject(new Error("XLSX k√ºt√ºphanesi y√ºklenemedi"));
        };
        document.head.appendChild(script);
      });
    }

    // ====================
    // Excel'den Teklif ƒ∞√ße Aktarma
    // ====================
    async function importBidFromExcel(file) {
      return new Promise(async (resolve, reject) => {
        try {
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array', cellDates: true });
              
              // "Teklif" sayfasƒ±nƒ± bul (√∂ncelikli) veya yoksa ikinci sayfayƒ± al
              let sheetName = null;
              let worksheet = null;
              
              // √ñnce "Teklif" sayfasƒ±nƒ± ara
              if (workbook.SheetNames.includes("Teklif")) {
                sheetName = "Teklif";
                worksheet = workbook.Sheets["Teklif"];
                logger.info("'Teklif' sayfasƒ± bulundu, okunuyor");
              } else if (workbook.SheetNames.length > 1) {
                // "Teklif" yoksa ikinci sayfayƒ± al (genelde Talep=1, Teklif=2)
                sheetName = workbook.SheetNames[1];
                worksheet = workbook.Sheets[sheetName];
                logger.info(`ƒ∞kinci sayfa bulundu`, { sheetName });
              } else {
                // Tek sayfa varsa onu al (geriye d√∂n√ºk uyumluluk)
                sheetName = workbook.SheetNames[0];
                worksheet = workbook.Sheets[sheetName];
                logger.warn(`Tek sayfa var`, { sheetName });
              }
              
              if (!worksheet) {
                throw new Error("Excel'de 'Teklif' sayfasƒ± bulunamadƒ±. L√ºtfen Excel dosyasƒ±nda 'Teklif' adƒ±nda bir sayfa olduƒüundan emin olun.");
              }
              
              // √úr√ºn tablosunu bul (ba≈ülƒ±k satƒ±rƒ±nƒ± ara)
              let headerRow = -1;
              let itemsStartRow = -1;
              const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1:Z1000');
              
              // Ba≈ülƒ±k satƒ±rƒ±nƒ± bul - "Teklif" sayfasƒ± formatƒ±
              // Teklif sayfasƒ± formatƒ±: A=Sƒ±ra No, B=√úr√ºn Kodu, C=√úr√ºn Adƒ±/Tanƒ±m, D=Teklif Tanƒ±mƒ±, E=Miktar, F=Birim, G=Birim Fiyat (KDV Hari√ß)
              for (let row = 1; row <= Math.min(range.e.r, 50); row++) {
                const cellA = worksheet[XLSX.utils.encode_cell({ r: row, c: 0 })]; // A: Sƒ±ra No
                const cellB = worksheet[XLSX.utils.encode_cell({ r: row, c: 1 })]; // B: √úr√ºn Kodu
                const cellC = worksheet[XLSX.utils.encode_cell({ r: row, c: 2 })]; // C: √úr√ºn Adƒ±/Tanƒ±m
                const cellG = worksheet[XLSX.utils.encode_cell({ r: row, c: 6 })]; // G: Birim Fiyat (KDV Hari√ß)
                
                const valA = cellA?.v?.toString().toUpperCase().trim() || "";
                const valB = cellB?.v?.toString().toUpperCase().trim() || "";
                const valC = cellC?.v?.toString().toUpperCase().trim() || "";
                const valG = cellG?.v?.toString().toUpperCase().trim() || "";
                
                // Teklif sayfasƒ± formatƒ±: "SIRA NO", "√úR√úN KODU" veya "√úR√úN ADI", "BIRIM FIYAT (KDV HARƒ∞√á)"
                if ((valA.includes("SIRA") && valA.includes("NO")) && 
                    (valC.includes("√úR√úN") || valC.includes("TANIM") || valC.includes("ADƒ∞") || valC.includes("A√áIKLAMA")) &&
                    (valG.includes("BIRIM") && valG.includes("FIYAT"))) {
                  headerRow = row;
                  itemsStartRow = row + 1;
                  logger.info(`Teklif sayfasƒ± ba≈ülƒ±k satƒ±rƒ± bulundu`, { row: row + 1 });
                  break;
                }
                // Fallback: Sadece "SIRA NO" ve "BIRIM FIYAT" varsa kabul et
                if ((valA.includes("SIRA") || valA.includes("NO")) && 
                    (valG.includes("BIRIM") && valG.includes("FIYAT"))) {
                  headerRow = row;
                  itemsStartRow = row + 1;
                  logger.info(`Teklif sayfasƒ± ba≈ülƒ±k satƒ±rƒ± bulundu (fallback)`, { row: row + 1 });
                  break;
                }
              }
              
              if (headerRow === -1) {
                throw new Error("Excel'de √ºr√ºn tablosu bulunamadƒ±. L√ºtfen Excel formatƒ±nƒ± kontrol edin. Ba≈ülƒ±k satƒ±rƒ±nda 'Sƒ±ra No', '√úr√ºn Adƒ±' ve 'Birim Fiyat' s√ºtunlarƒ± olmalƒ±dƒ±r.");
              }
              
              logger.info("Excel ba≈ülƒ±k satƒ±rƒ± bulundu", { headerRow, itemsStartRow });
              
              // Orijinal talep √ºr√ºnleri ile kar≈üƒ±la≈ütƒ±rma i√ßin
              const originalItems = itemsData.map((item, idx) => ({
                lineNo: item.lineNo || item.no || (idx + 1),
                sku: item.sku || item.materialCode || "",
                name: (item.name || item.description || "").trim().toLowerCase(),
                qty: item.qty || item.quantity || 0,
                unit: (item.unit || "").trim().toLowerCase()
              }));
              
              // √úr√ºn satƒ±rlarƒ±nƒ± oku - "Teklif" sayfasƒ± formatƒ±
              // Teklif sayfasƒ±: A=Sƒ±ra No, B=√úr√ºn Kodu, C=√úr√ºn Adƒ±/Tanƒ±m, D=Teklif Tanƒ±mƒ±, E=Miktar, F=Birim, G=Birim Fiyat (KDV Hari√ß), H-L=ƒ∞skonto, M=KDV (%), N=Teslim Tarihi, O=Para Birimi, P=Kalite/Sertifika, Q=G√∂rsel URL, R=Ek A√ßƒ±klama
              const bidItems = [];
              for (let row = itemsStartRow; row <= range.e.r; row++) {
                const cellA = worksheet[XLSX.utils.encode_cell({ r: row, c: 0 })]; // A: Sƒ±ra No
                const cellB = worksheet[XLSX.utils.encode_cell({ r: row, c: 1 })]; // B: √úr√ºn Kodu
                const cellC = worksheet[XLSX.utils.encode_cell({ r: row, c: 2 })]; // C: √úr√ºn Adƒ±/Tanƒ±m
                const cellD = worksheet[XLSX.utils.encode_cell({ r: row, c: 3 })]; // D: Teklif Tanƒ±mƒ±
                const cellE = worksheet[XLSX.utils.encode_cell({ r: row, c: 4 })]; // E: Miktar
                const cellF = worksheet[XLSX.utils.encode_cell({ r: row, c: 5 })]; // F: Birim
                const cellG = worksheet[XLSX.utils.encode_cell({ r: row, c: 6 })]; // G: Birim Fiyat (KDV Hari√ß)
                const cellH = worksheet[XLSX.utils.encode_cell({ r: row, c: 7 })]; // H: ƒ∞skonto %1
                const cellI = worksheet[XLSX.utils.encode_cell({ r: row, c: 8 })]; // I: ƒ∞skonto %2
                const cellJ = worksheet[XLSX.utils.encode_cell({ r: row, c: 9 })]; // J: ƒ∞skonto %3
                const cellK = worksheet[XLSX.utils.encode_cell({ r: row, c: 10 })]; // K: ƒ∞skonto %4
                const cellL = worksheet[XLSX.utils.encode_cell({ r: row, c: 11 })]; // L: ƒ∞skonto %5
                const cellM = worksheet[XLSX.utils.encode_cell({ r: row, c: 12 })]; // M: KDV (%)
                const cellN = worksheet[XLSX.utils.encode_cell({ r: row, c: 13 })]; // N: Teslim Tarihi
                const cellO = worksheet[XLSX.utils.encode_cell({ r: row, c: 14 })]; // O: Para Birimi
                const cellP = worksheet[XLSX.utils.encode_cell({ r: row, c: 15 })]; // P: Kalite/Sertifika
                const cellQ = worksheet[XLSX.utils.encode_cell({ r: row, c: 16 })]; // Q: G√∂rsel URL
                const cellR = worksheet[XLSX.utils.encode_cell({ r: row, c: 17 })]; // R: Ek A√ßƒ±klama
                
                // Bo≈ü satƒ±r veya "TOPLAM" satƒ±rƒ± ise atla
                if (!cellA || cellA.v === undefined || cellA.v === null) continue;
                const lineNoStr = cellA.v.toString().toUpperCase().trim();
                if (lineNoStr.includes("TOPLAM") || lineNoStr.includes("TOPLAMI") || lineNoStr === "") break;
                
                // Teklif sayfasƒ± formatƒ±: A=Sƒ±ra No, B=√úr√ºn Kodu, C=√úr√ºn Adƒ±/Tanƒ±m, D=Teklif Tanƒ±mƒ±, E=Miktar, F=Birim, G=Birim Fiyat (KDV Hari√ß)
                const lineNo = parseInt(cellA?.v || 0) || bidItems.length + 1;
                const sku = (cellB?.v?.toString() || "").trim();
                const name = (cellC?.v?.toString() || "").trim();
                const teklifTanimi = (cellD?.v?.toString() || "").trim();  // D: Teklif Tanƒ±mƒ±
                const qty = parseFloat(cellE?.v || 0) || 0;  // E: Miktar
                const unit = (cellF?.v?.toString() || "").trim();  // F: Birim
                const unitPrice = parseFloat(cellG?.v || 0) || 0;  // G: Birim Fiyat (KDV Hari√ß)
                // ƒ∞skontolar (H-L) - opsiyonel, ≈üimdilik atlanƒ±yor
                const vatRate = parseFloat(cellM?.v || 0) || 20;  // M: KDV (%) (varsayƒ±lan 20)
                const deliveryDate = cellN?.v ? (cellN.v instanceof Date ? cellN.v.toLocaleDateString("tr-TR") : cellN.v.toString()) : "";  // N: Teslim Tarihi
                const currency = (cellO?.v?.toString() || demandData.currency || "TRY").trim();  // O: Para Birimi
                const quality = (cellP?.v?.toString() || "").trim();  // P: Kalite/Sertifika
                const imageUrl = (cellQ?.v?.toString() || "").trim();  // Q: G√∂rsel URL
                const notes = (cellR?.v?.toString() || teklifTanimi || "").trim();  // R: Ek A√ßƒ±klama veya D: Teklif Tanƒ±mƒ±
                
                // Toplamlarƒ± hesapla (iskonto uygulanmadƒ±, basit hesaplama)
                const totalExclVat = qty * unitPrice;  // KDV Hari√ß Toplam
                const totalInclVat = totalExclVat * (1 + vatRate / 100);  // KDV Dahil Toplam
                
                // √ñdeme ≈üartlarƒ± (Teklif Bilgileri b√∂l√ºm√ºnden okunabilir, ≈üimdilik bo≈ü)
                const paymentTerms = "";
                
                // Validasyon: Birim fiyat ve miktar zorunlu
                if (!unitPrice || unitPrice <= 0) {
                  logger.warn(`Satƒ±r ${row + 1}: Birim fiyat eksik veya 0, atlanƒ±yor`);
                  continue;
                }
                if (!qty || qty <= 0) {
                  logger.warn(`Satƒ±r ${row + 1}: Miktar eksik veya 0, atlanƒ±yor`);
                  continue;
                }
                
                // Orijinal talep ile e≈üle≈ütirme kontrol√º (opsiyonel - sƒ±ralama korunmalƒ±)
                const originalItem = originalItems.find(item => 
                  item.lineNo === lineNo || 
                  (item.name === name.toLowerCase() && item.qty === qty && item.unit === unit.toLowerCase())
                );
                
                if (!originalItem && bidItems.length > 0) {
                  logger.warn(`Satƒ±r ${row + 1}: Orijinal talep ile e≈üle≈ümedi, devam ediliyor`);
                }
                
                bidItems.push({
                  lineNo: lineNo,
                  sku: sku,
                  name: name,
                  teklifTanimi: teklifTanimi,
                  qty: qty,
                  unit: unit,
                  deliveryDate: deliveryDate,
                  unitPrice: unitPrice,
                  vatRate: vatRate,
                  totalExclVat: totalExclVat,
                  totalInclVat: totalInclVat,
                  currency: currency,
                  quality: quality,
                  imageUrl: imageUrl,
                  paymentTerms: paymentTerms,
                  notes: notes
                });
                
                logger.info(`Teklif kalemi okundu`, { name, qty, unit, unitPrice, currency: demandData.currency || 'TRY' });
              }
              
              if (bidItems.length === 0) {
                throw new Error("Excel'de ge√ßerli √ºr√ºn satƒ±rƒ± bulunamadƒ±. L√ºtfen birim fiyat ve miktar bilgilerini kontrol edin.");
              }
              
              // Toplamlarƒ± hesapla
              let totalExclVat = 0;
              let totalInclVat = 0;
              bidItems.forEach(item => {
                totalExclVat += item.totalExclVat;
                totalInclVat += item.totalInclVat;
              });
              
              // Ortalama KDV oranƒ± hesapla
              const avgVatRate = bidItems.length > 0
                ? bidItems.reduce((sum, item) => sum + item.vatRate, 0) / bidItems.length
                : 20;
              
              // Genel √∂deme ≈üartlarƒ± (ilk satƒ±rdan veya en √ßok kullanƒ±lan)
              const commonPaymentTerms = bidItems
                .filter(item => item.paymentTerms)
                .reduce((acc, item) => {
                  acc[item.paymentTerms] = (acc[item.paymentTerms] || 0) + 1;
                  return acc;
                }, {});
              const mostCommonPayment = Object.keys(commonPaymentTerms).sort((a, b) => 
                commonPaymentTerms[b] - commonPaymentTerms[a]
              )[0] || demandData.paymentTerms || "";
              
              // Genel notlar birle≈ütir
              const allNotes = bidItems
                .filter(item => item.notes)
                .map(item => `${item.name}: ${item.notes}`)
                .join("; ");
              
              // Bid items formatƒ±nƒ± d√ºzelt (sistem formatƒ±na uygun)
              const formattedItems = bidItems.map(item => ({
                lineNo: item.lineNo,
                demandItemId: item.sku || `item_${item.lineNo}`,
                description: item.name,
                quantity: item.qty,
                unit: item.unit,
                unitPrice: item.unitPrice,
                netPrice: item.unitPrice, // Net fiyat = birim fiyat (KDV hari√ß)
                totalPrice: item.totalInclVat, // Toplam = KDV dahil
                vatRate: item.vatRate,
                quality: item.quality || "",
                imageUrl: item.imageUrl || "",
                deliveryDate: item.deliveryDate,
                notes: item.notes || ""
              }));
              
              logger.info(`Teklif √∂zeti`, { kalem: bidItems.length, toplam: totalInclVat.toFixed(2), currency: bidItems[0]?.currency || demandData.currency || 'TRY' });
              
              // Kullanƒ±cƒ±dan onay almak i√ßin modal g√∂ster
              const confirmMessage = `
Teklif √ñzeti:
‚Ä¢ Kalem Sayƒ±sƒ±: ${bidItems.length}
‚Ä¢ KDV Hari√ß Toplam: ${totalExclVat.toFixed(2)} ${bidItems[0]?.currency || demandData.currency || 'TRY'}
‚Ä¢ KDV Dahil Toplam: ${totalInclVat.toFixed(2)} ${bidItems[0]?.currency || demandData.currency || 'TRY'}
‚Ä¢ Para Birimi: ${bidItems[0]?.currency || demandData.currency || 'TRY'}

Bu teklifi talep edene iletmek istiyor musunuz?
              `.trim();
              
              const confirmed = confirm(confirmMessage + "\n\nOnaylamak i√ßin 'Tamam', iptal etmek i√ßin 'ƒ∞ptal' butonuna tƒ±klayƒ±n.");
              
              if (!confirmed) {
                resolve(null);
                return;
              }
              
              // Teklif verisini olu≈ütur
              const bidData = {
                demandId: demandId,
                buyerId: demandData.createdBy,
                supplierId: user.uid,
                supplierName: user.displayName || user.email || "Tedarik√ßi",
                status: "sent", // Onaydan sonra direkt "sent" olarak g√∂nder
                currency: bidItems[0]?.currency || demandData.currency || "TRY",
                vatRate: avgVatRate,
                netPrice: totalExclVat,
                grossPrice: totalInclVat,
                totalAmount: totalInclVat.toFixed(2),
                price: totalExclVat, // Geriye d√∂n√ºk uyumluluk
                paymentTerms: mostCommonPayment,
                items: formattedItems,
                notes: allNotes || `Excel dosyasƒ±ndan y√ºklenen teklif (${file.name})`,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                submittedAt: serverTimestamp()
              };
              
              // Firestore'a kaydet
              const bidRef = await addDoc(collection(db, "bids"), bidData);
              logger.info("Teklif kaydedildi ve talep edene iletildi", { bidId: bidRef.id });
              
              // Ba≈üarƒ± mesajƒ± (merkezi MESSAGES kullanƒ±larak dinamik deƒüerler yerle≈ütirildi)
              toast.success(
                MESSAGES.SUCCESS_BID_SENT_SUMMARY
                  .replace('{count}', String(bidItems.length))
                  .replace('{total}', totalInclVat.toFixed(2))
                  .replace('{currency}', bidData.currency)
              );
              
              // Sayfayƒ± yenile
              setTimeout(() => {
                window.location.reload();
              }, 1500);
              
              resolve(bidRef.id);
            } catch (err) {
              reject(err);
            }
          };
          
          reader.onerror = () => reject(new Error("Dosya okunamadƒ±"));
          reader.readAsArrayBuffer(file);
        } catch (err) {
          reject(err);
        }
      });
    }

    // ====================
    // Initialize
    // ====================
    logger.info("Demand detail sayfasƒ± ba≈ülatƒ±lƒ±yor", { demandId });
    
    await loadDemand();
    logger.info("loadDemand() tamamlandƒ±");
    
    await loadItems();
    logger.info("loadItems() tamamlandƒ±");
    
    await loadBids();
    logger.info("loadBids() tamamlandƒ±");
    
    if (isOwner) {
      logger.info("Owner, files y√ºkleniyor");
      await loadFiles();
      // Show revision request section for owners
      const revisionSection = document.getElementById("revisionRequestSection");
      if (revisionSection) {
        revisionSection.style.display = "block";
      }
    }

    // SATFK Excel Export button handler
    const exportSatfkBtn = document.getElementById("exportSatfkBtn");
    if (exportSatfkBtn) {
      exportSatfkBtn.onclick = exportSatfkExcel;
      logger.info("exportSatfkBtn handler eklendi");
    } else {
      logger.warn("exportSatfkBtn bulunamadƒ±");
    }
    
    // Verify global functions are available
    if (typeof window.acceptBid === 'function' && 
        typeof window.rejectBid === 'function' && 
        typeof window.requestBidRevision === 'function') {
      logger.info("Bid action functions available globally");
    } else {
      logger.warn("Bid action functions not properly exposed to global scope");
    }
    
    logger.info("Sayfa ba≈ülatma tamamlandƒ±");
  </script>
  <script type="module" src="/js/ui-standard.js"></script>
</body>
</html>
