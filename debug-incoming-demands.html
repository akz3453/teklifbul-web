<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teklifbul Debug - Gelen Talepler</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
    </style>
</head>
<body>
    <h1>ğŸ” Teklifbul Debug - Gelen Talepler Sorunu</h1>
    
    <div id="debug-results"></div>
    
    <button onclick="runFullDebug()">Full Debug Ã‡alÄ±ÅŸtÄ±r</button>
    <button onclick="clearResults()">SonuÃ§larÄ± Temizle</button>
    <button onclick="testPublishDemand()">Test Talep YayÄ±nla</button>
    
    <script type="module">
        import { db, auth } from './firebase.js';
        import { 
            collection, 
            query, 
            where, 
            getDocs, 
            getDoc,
            doc,
            orderBy, 
            limit,
            addDoc,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `debug-section ${type}`;
            div.innerHTML = message;
            document.getElementById('debug-results').appendChild(div);
        }
        
        function clearResults() {
            document.getElementById('debug-results').innerHTML = '';
        }
        
        async function runFullDebug() {
            clearResults();
            addResult('<h2>ğŸ” Full Debug BaÅŸlatÄ±lÄ±yor...</h2>', 'info');
            
            // 1. KullanÄ±cÄ± bilgilerini kontrol et
            await debugUserInfo();
            
            // 2. demandRecipients koleksiyonunu kontrol et
            await debugDemandRecipients();
            
            // 3. demands koleksiyonunu kontrol et
            await debugDemands();
            
            // 4. loadIncoming fonksiyonunu simÃ¼le et
            await debugLoadIncoming();
            
            // 5. Index durumunu kontrol et
            await debugIndexes();
        }
        
        async function debugUserInfo() {
            addResult('<h3>1. ğŸ‘¤ KullanÄ±cÄ± Bilgileri</h3>', 'info');
            
            if (!auth.currentUser) {
                addResult('âŒ KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸ!', 'error');
                return;
            }
            
            const user = auth.currentUser;
            addResult(`âœ… KullanÄ±cÄ±: ${user.email} (${user.uid})`, 'success');
            
            // Users koleksiyonundan kullanÄ±cÄ± detaylarÄ±nÄ± al
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    addResult(`<pre>KullanÄ±cÄ± Verisi: ${JSON.stringify(userData, null, 2)}</pre>`, 'info');
                    
                    // Rolleri kontrol et
                    if (userData.roles) {
                        addResult(`âœ… Roller: ${JSON.stringify(userData.roles)}`, 'success');
                    } else {
                        addResult('âš ï¸ Roller tanÄ±mlanmamÄ±ÅŸ!', 'warning');
                    }
                    
                    // Kategorileri kontrol et
                    if (userData.categories && userData.categories.length > 0) {
                        addResult(`âœ… Kategoriler: ${userData.categories.join(', ')}`, 'success');
                    } else {
                        addResult('âš ï¸ Kategoriler tanÄ±mlanmamÄ±ÅŸ!', 'warning');
                    }
                    
                    // Grup ID'lerini kontrol et
                    if (userData.groupIds && userData.groupIds.length > 0) {
                        addResult(`âœ… Grup ID'leri: ${userData.groupIds.join(', ')}`, 'success');
                    } else {
                        addResult('âš ï¸ Grup ID\'leri tanÄ±mlanmamÄ±ÅŸ!', 'warning');
                    }
                } else {
                    addResult('âŒ KullanÄ±cÄ± users koleksiyonunda bulunamadÄ±!', 'error');
                }
            } catch (e) {
                addResult(`âŒ KullanÄ±cÄ± bilgileri alÄ±namadÄ±: ${e.message}`, 'error');
            }
        }
        
        async function debugDemandRecipients() {
            addResult('<h3>2. ğŸ“¨ demandRecipients Koleksiyonu</h3>', 'info');
            
            try {
                // TÃ¼m demandRecipients kayÄ±tlarÄ±nÄ± al
                const allRecipients = await getDocs(collection(db, 'demandRecipients'));
                addResult(`ğŸ“Š Toplam demandRecipients kaydÄ±: ${allRecipients.size}`, 'info');
                
                if (allRecipients.size === 0) {
                    addResult('âš ï¸ HiÃ§ demandRecipients kaydÄ± yok! Bu yÃ¼zden gelen talepler gÃ¶rÃ¼nmÃ¼yor.', 'warning');
                    return;
                }
                
                // KullanÄ±cÄ±ya ait kayÄ±tlarÄ± filtrele
                const userRecipients = allRecipients.docs.filter(doc => 
                    doc.data().supplierId === auth.currentUser.uid
                );
                
                addResult(`ğŸ“Š KullanÄ±cÄ±ya ait demandRecipients kaydÄ±: ${userRecipients.length}`, 'info');
                
                if (userRecipients.length === 0) {
                    addResult('âš ï¸ KullanÄ±cÄ±ya ait demandRecipients kaydÄ± yok!', 'warning');
                } else {
                    addResult('<h4>KullanÄ±cÄ±ya ait demandRecipients kayÄ±tlarÄ±:</h4>', 'info');
                    const table = document.createElement('table');
                    table.innerHTML = `
                        <tr>
                            <th>ID</th>
                            <th>demandId</th>
                            <th>buyerId</th>
                            <th>supplierId</th>
                            <th>matchedAt</th>
                            <th>status</th>
                        </tr>
                    `;
                    
                    userRecipients.forEach(doc => {
                        const data = doc.data();
                        const row = table.insertRow();
                        row.innerHTML = `
                            <td>${doc.id}</td>
                            <td>${data.demandId}</td>
                            <td>${data.buyerId}</td>
                            <td>${data.supplierId}</td>
                            <td>${data.matchedAt?.toDate?.()?.toLocaleString() || 'N/A'}</td>
                            <td>${data.status}</td>
                        `;
                    });
                    
                    addResult(table.outerHTML, 'info');
                }
                
            } catch (e) {
                addResult(`âŒ demandRecipients sorgusu baÅŸarÄ±sÄ±z: ${e.message}`, 'error');
            }
        }
        
        async function debugDemands() {
            addResult('<h3>3. ğŸ“‹ demands Koleksiyonu</h3>', 'info');
            
            try {
                // YayÄ±nlanmÄ±ÅŸ talepleri al
                const publishedDemands = await getDocs(
                    query(collection(db, 'demands'), where('isPublished', '==', true))
                );
                
                addResult(`ğŸ“Š Toplam yayÄ±nlanmÄ±ÅŸ talep: ${publishedDemands.size}`, 'info');
                
                if (publishedDemands.size === 0) {
                    addResult('âš ï¸ HiÃ§ yayÄ±nlanmÄ±ÅŸ talep yok!', 'warning');
                    return;
                }
                
                // KullanÄ±cÄ±nÄ±n kategorilerine uygun talepleri bul
                const userDoc = await getDoc(doc(db, 'users', auth.currentUser.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const userCategories = userData.categories || [];
                    
                    if (userCategories.length === 0) {
                        addResult('âš ï¸ KullanÄ±cÄ±nÄ±n kategorileri yok!', 'warning');
                        return;
                    }
                    
                    const matchingDemands = publishedDemands.docs.filter(doc => {
                        const demand = doc.data();
                        const demandCategories = demand.categories || [];
                        return demandCategories.some(cat => userCategories.includes(cat));
                    });
                    
                    addResult(`ğŸ“Š KullanÄ±cÄ±nÄ±n kategorilerine uygun talep: ${matchingDemands.length}`, 'info');
                    
                    if (matchingDemands.length > 0) {
                        addResult('<h4>KullanÄ±cÄ±nÄ±n kategorilerine uygun talepler:</h4>', 'info');
                        const table = document.createElement('table');
                        table.innerHTML = `
                            <tr>
                                <th>ID</th>
                                <th>BaÅŸlÄ±k</th>
                                <th>Kategoriler</th>
                                <th>OluÅŸturan</th>
                                <th>YayÄ±n Tarihi</th>
                            </tr>
                        `;
                        
                        matchingDemands.forEach(doc => {
                            const data = doc.data();
                            const row = table.insertRow();
                            row.innerHTML = `
                                <td>${doc.id}</td>
                                <td>${data.title || 'N/A'}</td>
                                <td>${(data.categories || []).join(', ')}</td>
                                <td>${data.createdBy}</td>
                                <td>${data.createdAt?.toDate?.()?.toLocaleString() || 'N/A'}</td>
                            `;
                        });
                        
                        addResult(table.outerHTML, 'info');
                    }
                }
                
            } catch (e) {
                addResult(`âŒ demands sorgusu baÅŸarÄ±sÄ±z: ${e.message}`, 'error');
            }
        }
        
        async function debugLoadIncoming() {
            addResult('<h3>4. ğŸ”„ loadIncoming Fonksiyonu SimÃ¼lasyonu</h3>', 'info');
            
            try {
                const user = auth.currentUser;
                
                // 1. demandRecipients sorgusu
                const q = query(
                    collection(db, 'demandRecipients'), 
                    where('supplierId', '==', user.uid), 
                    orderBy('matchedAt', 'desc'), 
                    limit(100)
                );
                
                addResult('ğŸ” demandRecipients sorgusu Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...', 'info');
                const rs = await getDocs(q);
                addResult(`ğŸ“Š Sorgu sonucu: ${rs.size} kayÄ±t`, 'info');
                
                if (rs.size === 0) {
                    addResult('âš ï¸ demandRecipients sorgusu sonuÃ§ vermedi!', 'warning');
                    return;
                }
                
                // 2. demandId'leri al
                const ids = rs.docs.map(d => d.data().demandId);
                addResult(`ğŸ“Š Bulunan demandId'ler: ${ids.join(', ')}`, 'info');
                
                // 3. Her demandId iÃ§in demands koleksiyonundan veri al
                const rows = [];
                for (const id of ids) {
                    addResult(`ğŸ” demandId ${id} iÃ§in demands koleksiyonu sorgulanÄ±yor...`, 'info');
                    const ds = await getDoc(doc(db, 'demands', id));
                    if (ds.exists()) {
                        rows.push({ id: ds.id, ...ds.data() });
                        addResult(`âœ… demandId ${id} bulundu`, 'success');
                    } else {
                        addResult(`âŒ demandId ${id} bulunamadÄ±!`, 'error');
                    }
                }
                
                addResult(`ğŸ“Š Toplam yÃ¼klenen talep: ${rows.length}`, 'info');
                
                if (rows.length > 0) {
                    addResult('<h4>YÃ¼klenen talepler:</h4>', 'info');
                    const table = document.createElement('table');
                    table.innerHTML = `
                        <tr>
                            <th>ID</th>
                            <th>BaÅŸlÄ±k</th>
                            <th>Kategoriler</th>
                            <th>Durum</th>
                        </tr>
                    `;
                    
                    rows.forEach(row => {
                        const tr = table.insertRow();
                        tr.innerHTML = `
                            <td>${row.id}</td>
                            <td>${row.title || 'N/A'}</td>
                            <td>${(row.categories || []).join(', ')}</td>
                            <td>${row.status || (row.isPublished ? 'YayÄ±nda' : 'Taslak')}</td>
                        `;
                    });
                    
                    addResult(table.outerHTML, 'info');
                } else {
                    addResult('âš ï¸ HiÃ§ talep yÃ¼klenemedi!', 'warning');
                }
                
            } catch (e) {
                addResult(`âŒ loadIncoming simÃ¼lasyonu baÅŸarÄ±sÄ±z: ${e.message}`, 'error');
                
                // Index hatasÄ± kontrolÃ¼
                if (e.message.includes('index')) {
                    addResult('ğŸ” Index hatasÄ± tespit edildi! Konsoldaki "Create index" linkine tÄ±klayÄ±n.', 'warning');
                }
            }
        }
        
        async function debugIndexes() {
            addResult('<h3>5. ğŸ“Š Firestore Index Durumu</h3>', 'info');
            
            const requiredIndexes = [
                'demandRecipients â†’ supplierId (ASC), matchedAt (DESC)',
                'demands â†’ createdBy (ASC), createdAt (DESC)',
                'demands â†’ isPublished (ASC), visibility (ASC), createdAt (DESC)',
                'users â†’ isActive (ASC), roles.supplier (ASC), categories (CONTAINS)',
                'users â†’ isActive (ASC), roles.supplier (ASC), groupIds (CONTAINS)'
            ];
            
            addResult('<h4>Gerekli Index\'ler:</h4>', 'info');
            requiredIndexes.forEach(index => {
                addResult(`ğŸ“‹ ${index}`, 'info');
            });
            
            addResult('ğŸ’¡ Index hatasÄ± alÄ±yorsanÄ±z Firebase Console â†’ Firestore â†’ Indexes bÃ¶lÃ¼mÃ¼nden oluÅŸturun.', 'warning');
        }
        
        async function testPublishDemand() {
            addResult('<h3>ğŸ§ª Test Talep YayÄ±nlama</h3>', 'info');
            
            try {
                // Test talep oluÅŸtur
                const testDemand = {
                    title: 'Test Talep - Debug',
                    description: 'Bu bir test talebidir',
                    categories: ['test', 'debug'],
                    groupIds: ['TEST-GROUP'],
                    createdBy: auth.currentUser.uid,
                    companyId: 'test-company',
                    isPublished: true,
                    visibility: 'public',
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };
                
                addResult('ğŸ” Test talep oluÅŸturuluyor...', 'info');
                const demandRef = await addDoc(collection(db, 'demands'), testDemand);
                addResult(`âœ… Test talep oluÅŸturuldu: ${demandRef.id}`, 'success');
                
                // publishDemandAndMatchSuppliers fonksiyonunu simÃ¼le et
                addResult('ğŸ” publishDemandAndMatchSuppliers simÃ¼lasyonu...', 'info');
                
                const cats = testDemand.categories || [];
                const grps = testDemand.groupIds || [];
                
                // Kategori bazlÄ± tedarikÃ§i sorgularÄ±
                const supplierQueries = [];
                
                if (cats.length > 0) {
                    supplierQueries.push(
                        query(collection(db, 'users'),
                              where('isActive', '==', true),
                              where('categories', 'array-contains-any', cats),
                              where('roles.supplier', '==', true))
                    );
                    
                    supplierQueries.push(
                        query(collection(db, 'users'),
                              where('isActive', '==', true),
                              where('categories', 'array-contains-any', cats),
                              where('roles.buyer', '==', true))
                    );
                }
                
                if (grps.length > 0) {
                    supplierQueries.push(
                        query(collection(db, 'users'),
                              where('groupIds', 'array-contains-any', grps),
                              where('isActive', '==', true))
                    );
                }
                
                const resultSet = new Map();
                
                for (const q of supplierQueries) {
                    try {
                        const res = await getDocs(q);
                        res.forEach(u => {
                            const data = u.data();
                            if (data.roles?.supplier || data.roles?.buyer) {
                                resultSet.set(u.id, data);
                            }
                        });
                    } catch (e) {
                        addResult(`âš ï¸ Sorgu baÅŸarÄ±sÄ±z: ${e.message}`, 'warning');
                    }
                }
                
                addResult(`ğŸ“Š Bulunan eÅŸleÅŸen firma: ${resultSet.size}`, 'info');
                
                // demandRecipients kayÄ±tlarÄ± oluÅŸtur
                const tasks = [];
                for (const [uid, udata] of resultSet.entries()) {
                    if (uid === testDemand.createdBy) continue;
                    
                    tasks.push(
                        addDoc(collection(db, "demandRecipients"), {
                            demandId: demandRef.id,
                            buyerId: testDemand.createdBy,
                            supplierId: uid,
                            supplierCompanyId: udata.companyId || null,
                            matchedAt: serverTimestamp(),
                            status: "pending",
                        })
                    );
                }
                
                if (tasks.length > 0) {
                    await Promise.all(tasks);
                    addResult(`âœ… ${tasks.length} demandRecipients kaydÄ± oluÅŸturuldu`, 'success');
                } else {
                    addResult('âš ï¸ HiÃ§ eÅŸleÅŸen firma bulunamadÄ±!', 'warning');
                }
                
            } catch (e) {
                addResult(`âŒ Test talep yayÄ±nlama baÅŸarÄ±sÄ±z: ${e.message}`, 'error');
            }
        }
        
        // Make functions global
        window.runFullDebug = runFullDebug;
        window.clearResults = clearResults;
        window.testPublishDemand = testPublishDemand;
    </script>
</body>
</html>
