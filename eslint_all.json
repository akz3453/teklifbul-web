[{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\__tests__\\mapping\\normalization.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\__tests__\\mapping\\scorers.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\bid-form-import.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\bid-form.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\firebase.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\address-service.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'localError' is defined but never used.","line":130,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":130,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'saveError' is defined but never used.","line":156,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":156,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Adres Servisi - ID Tabanlƒ± Sistem\r\n * Teklifbul Rule v1.0\r\n */\r\n\r\n// Teklifbul Rule v1.0 - Structured Logging\r\nimport { logger } from '../../src/shared/log/logger.js';\r\n\r\n/**\r\n * T√ºrk√ße karakterleri normalize et\r\n */\r\nexport function normalizeTR(s) {\r\n  if (!s) return s || '';\r\n  return String(s)\r\n    .replace(/ƒ∞/g, 'I')\r\n    .replace(/IÃá/g, 'I')\r\n    .replace(/ƒ±/g, 'i')\r\n    .replace(/ƒü/g, 'g')\r\n    .replace(/ƒû/g, 'G')\r\n    .replace(/√º/g, 'u')\r\n    .replace(/√ú/g, 'U')\r\n    .replace(/≈ü/g, 's')\r\n    .replace(/≈û/g, 'S')\r\n    .replace(/√∂/g, 'o')\r\n    .replace(/√ñ/g, 'O')\r\n    .replace(/√ß/g, 'c')\r\n    .replace(/√á/g, 'C')\r\n    .trim();\r\n}\r\n\r\n/**\r\n * Sokak JSON dosya yolu olu≈ütur\r\n */\r\nexport function buildStreetAssetPath(districtId, neighborhoodId) {\r\n  return `/assets/sokak/${districtId}_mah-${neighborhoodId}.json`;\r\n}\r\n\r\n/**\r\n * ƒ∞l/ƒ∞l√ße/Mahalle isimlerinden ID'leri √ß√∂z√ºmle\r\n */\r\nexport async function resolveIdsByNames(provinceName, districtName, neighborhoodName) {\r\n  try {\r\n    const params = new URLSearchParams({\r\n      provinceName: String(provinceName || ''),\r\n      districtName: String(districtName || ''),\r\n      neighborhoodName: String(neighborhoodName || '')\r\n    });\r\n    \r\n    const res = await fetch(`/api/addr/resolve-ids?${params.toString()}`);\r\n    const json = await res.json();\r\n    \r\n    if (json.ok && json.data) {\r\n      return json.data; // { provinceId, districtId, neighborhoodId, defaultPostalCode? }\r\n    }\r\n    \r\n    // Teklifbul Rule v1.0 - Structured Logging\r\n    logger.warn('[addr] ID resolution failed', { error: json.error || 'Unknown error' });\r\n    return null;\r\n  } catch (e) {\r\n    logger.error('[addr] ID resolution error', e);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * ID tabanlƒ± sokak listesi y√ºkle\r\n * @param {Object} params\r\n * @param {string} params.provinceName - ƒ∞l adƒ±\r\n * @param {string} params.districtName - ƒ∞l√ße adƒ±\r\n * @param {string} params.neighborhoodName - Mahalle adƒ±\r\n * @param {number} [params.neighborhoodIdFromState] - Mahalle ID (varsa kullanƒ±lƒ±r)\r\n * @param {number} [params.districtIdFromState] - ƒ∞l√ße ID (varsa kullanƒ±lƒ±r)\r\n * @returns {Promise<Array>} Sokak listesi [{ id, name, postalCode? }]\r\n */\r\nexport async function loadStreets({ \r\n  provinceName, \r\n  districtName, \r\n  neighborhoodName, \r\n  neighborhoodIdFromState,\r\n  districtIdFromState \r\n}) {\r\n  let neighborhoodId = neighborhoodIdFromState;\r\n  let districtId = districtIdFromState;\r\n  \r\n  // 0) ID'ler yoksa √ß√∂z√ºmle\r\n  if (!neighborhoodId || !districtId) {\r\n    const ids = await resolveIdsByNames(provinceName, districtName, neighborhoodName);\r\n    \r\n    if (!ids) {\r\n      logger.info('[addr] streets empty ‚Üí free-text (ID resolution failed)', { \r\n        provinceName, \r\n        districtName, \r\n        neighborhoodName \r\n      });\r\n      return [];\r\n    }\r\n    \r\n    neighborhoodId = ids.neighborhoodId || neighborhoodId;\r\n    districtId = ids.districtId || districtId;\r\n  }\r\n  \r\n  if (!neighborhoodId) {\r\n    logger.info('[addr] streets empty ‚Üí free-text (no neighborhoodId)', { \r\n      provinceName, \r\n      districtName, \r\n      neighborhoodName \r\n    });\r\n    return [];\r\n  }\r\n  \r\n  // 1) Local JSON dene (sessizce, 404 normal)\r\n  try {\r\n    const assetPath = buildStreetAssetPath(districtId || 0, neighborhoodId);\r\n    const localRes = await fetch(assetPath);\r\n    \r\n    if (localRes.ok) {\r\n      const localData = await localRes.json();\r\n      const streets = Array.isArray(localData?.streets) ? localData.streets : [];\r\n      \r\n      if (streets.length > 0) {\r\n        logger.info('[addr] streets loaded from local JSON', { neighborhoodId, count: streets.length });\r\n        return streets.map(s => ({\r\n          id: s.id || s.name,\r\n          name: s.name || s,\r\n          postalCode: s.postalCode || s.postal_code || null\r\n        }));\r\n      }\r\n    }\r\n    // 404 sessizce ge√ß (normal durum)\r\n  } catch (localError) {\r\n    // Local fetch hatasƒ± sessizce ge√ß\r\n  }\r\n  \r\n  // 2) Backend proxy (retry'li, CORS g√ºvenli)\r\n  try {\r\n    const apiRes = await fetch(`/api/addr/streets?neighborhoodId=${neighborhoodId}`);\r\n    const apiJson = await apiRes.json();\r\n    \r\n    if (apiJson.ok && Array.isArray(apiJson.data) && apiJson.data.length > 0) {\r\n      logger.info('[addr] streets loaded from API', { neighborhoodId, count: apiJson.data.length });\r\n      \r\n      // Cache'e kaydet (opsiyonel)\r\n      if (districtId) {\r\n        try {\r\n          await fetch(`${location.origin}/save-street-json`, {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n              districtId,\r\n              districtName,\r\n              neighborhoodId,\r\n              neighborhoodName,\r\n              streets: apiJson.data\r\n            })\r\n          });\r\n        } catch (saveError) {\r\n          // Cache kaydetme hatasƒ± sessizce ge√ß\r\n        }\r\n      }\r\n      \r\n      return apiJson.data;\r\n    }\r\n    \r\n    logger.info('[addr] streets empty ‚Üí free-text (API returned empty)', { neighborhoodId });\r\n  } catch (apiError) {\r\n    logger.warn('[addr] streets API fail', { \r\n      neighborhoodId, \r\n      error: apiError.message || String(apiError) \r\n    });\r\n  }\r\n  \r\n  // 3) Free-text fallback (bo≈ü array d√∂nd√ºr, UI free-text input'u a√ßacak)\r\n  return [];\r\n}\r\n\r\n/**\r\n * Posta kodu otomasyonu\r\n * Sokak se√ßilince postalCode'u set et\r\n */\r\nexport function onStreetSelected(street, neighborhood, setPostalCodeFn) {\r\n  if (!setPostalCodeFn) return;\r\n  \r\n  const postalCode = street?.postalCode || neighborhood?.defaultPostalCode || '';\r\n  \r\n  if (postalCode) {\r\n    setPostalCodeFn(postalCode);\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\address-verify-modal.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isGoogleMapsLoaded' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Adres Doƒürulama Modal Bile≈üeni\r\n * Teklifbul Rule v1.0 - Modal + Places Autocomplete + Harita\r\n */\r\n\r\nimport { loadGoogleMaps, isGoogleMapsLoaded } from './google-maps-loader.js';\r\n\r\n/**\r\n * Adres doƒürulama modalƒ±nƒ± olu≈üturur ve g√∂sterir\r\n * @param {Object} options\r\n * @param {string} options.defaultAddress - Varsayƒ±lan adres\r\n * @param {Function} options.onConfirm - Onaylandƒ±ƒüƒ±nda √ßaƒürƒ±lƒ±r: (result) => { address, lat, lng }\r\n * @param {Function} options.onCancel - ƒ∞ptal edildiƒüinde √ßaƒürƒ±lƒ±r: () => {}\r\n */\r\nexport function showAddressVerifyModal({ defaultAddress = '', onConfirm, onCancel }) {\r\n  // Modal container olu≈ütur\r\n  const modalOverlay = document.createElement('div');\r\n  modalOverlay.id = 'addressVerifyModal';\r\n  modalOverlay.style.cssText = `\r\n    position: fixed;\r\n    inset: 0;\r\n    z-index: 10000;\r\n    background: rgba(0, 0, 0, 0.4);\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    padding: 20px;\r\n  `;\r\n\r\n  const modalContent = document.createElement('div');\r\n  modalContent.style.cssText = `\r\n    background: white;\r\n    width: 100%;\r\n    max-width: 800px;\r\n    border-radius: 16px;\r\n    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);\r\n    overflow: hidden;\r\n    display: flex;\r\n    flex-direction: column;\r\n    max-height: 90vh;\r\n  `;\r\n\r\n  // Header\r\n  const header = document.createElement('div');\r\n  header.style.cssText = `\r\n    padding: 20px;\r\n    border-bottom: 1px solid #e5e7eb;\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: space-between;\r\n  `;\r\n  header.innerHTML = `\r\n    <h3 style=\"margin:0; font-size:18px; font-weight:600; color:#1f2937;\">üìç Harita ile Adres Doƒürulama</h3>\r\n    <button id=\"closeAddressModal\" style=\"background:none; border:none; font-size:24px; cursor:pointer; color:#6b7280; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center;\">&times;</button>\r\n  `;\r\n\r\n  // Body\r\n  const body = document.createElement('div');\r\n  body.style.cssText = `\r\n    padding: 20px;\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: 16px;\r\n    flex: 1;\r\n    overflow-y: auto;\r\n  `;\r\n\r\n  // Adres input + Places autocomplete\r\n  const inputContainer = document.createElement('div');\r\n  inputContainer.style.cssText = `\r\n    display: flex;\r\n    gap: 12px;\r\n    align-items: center;\r\n  `;\r\n\r\n  const addressInput = document.createElement('input');\r\n  addressInput.id = 'addressVerifyInput';\r\n  addressInput.type = 'text';\r\n  addressInput.placeholder = 'Adres yazƒ±n (√∂rn: Baƒüdat Caddesi 123, Kadƒ±k√∂y, ƒ∞stanbul)';\r\n  addressInput.value = defaultAddress;\r\n  addressInput.style.cssText = `\r\n    flex: 1;\r\n    padding: 12px 16px;\r\n    border: 2px solid #e5e7eb;\r\n    border-radius: 8px;\r\n    font-size: 14px;\r\n    transition: border-color 0.2s;\r\n  `;\r\n\r\n  inputContainer.appendChild(addressInput);\r\n\r\n  // Map container\r\n  const mapContainer = document.createElement('div');\r\n  mapContainer.id = 'addressVerifyMap';\r\n  mapContainer.style.cssText = `\r\n    width: 100%;\r\n    height: 400px;\r\n    border-radius: 8px;\r\n    border: 2px solid #e5e7eb;\r\n    background: #f3f4f6;\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    color: #6b7280;\r\n  `;\r\n  mapContainer.innerHTML = '<p>Harita y√ºkleniyor...</p>';\r\n\r\n  body.appendChild(inputContainer);\r\n  body.appendChild(mapContainer);\r\n\r\n  // Footer\r\n  const footer = document.createElement('div');\r\n  footer.style.cssText = `\r\n    padding: 20px;\r\n    border-top: 1px solid #e5e7eb;\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: space-between;\r\n    gap: 16px;\r\n  `;\r\n\r\n  const infoDiv = document.createElement('div');\r\n  infoDiv.id = 'addressVerifyInfo';\r\n  infoDiv.style.cssText = `\r\n    flex: 1;\r\n    font-size: 13px;\r\n    color: #6b7280;\r\n    line-height: 1.6;\r\n  `;\r\n  infoDiv.innerHTML = 'Adres se√ßin veya haritadan bir nokta tƒ±klayƒ±n.';\r\n\r\n  const confirmBtn = document.createElement('button');\r\n  confirmBtn.id = 'addressVerifyConfirm';\r\n  confirmBtn.textContent = 'Onayla';\r\n  confirmBtn.disabled = true;\r\n  confirmBtn.style.cssText = `\r\n    padding: 12px 24px;\r\n    background: #3b82f6;\r\n    color: white;\r\n    border: none;\r\n    border-radius: 8px;\r\n    font-weight: 600;\r\n    cursor: pointer;\r\n    transition: background 0.2s;\r\n    font-size: 14px;\r\n  `;\r\n\r\n  footer.appendChild(infoDiv);\r\n  footer.appendChild(confirmBtn);\r\n\r\n  modalContent.appendChild(header);\r\n  modalContent.appendChild(body);\r\n  modalContent.appendChild(footer);\r\n  modalOverlay.appendChild(modalContent);\r\n  document.body.appendChild(modalOverlay);\r\n\r\n  // Se√ßili adres bilgisi\r\n  let selectedAddress = null;\r\n\r\n  // Google Maps y√ºkleme ve harita ba≈ülatma\r\n  loadGoogleMaps()\r\n    .then(() => {\r\n      if (!window.google?.maps) {\r\n        throw new Error('Google Maps API y√ºklenemedi');\r\n      }\r\n\r\n      const google = window.google;\r\n      const geocoder = new google.maps.Geocoder();\r\n\r\n      // Harita olu≈ütur\r\n      const map = new google.maps.Map(mapContainer, {\r\n        center: { lat: 39.9255, lng: 32.8663 }, // T√ºrkiye merkezi\r\n        zoom: 6,\r\n        mapTypeControl: false,\r\n        streetViewControl: false,\r\n        fullscreenControl: false,\r\n      });\r\n\r\n      const marker = new google.maps.Marker({ map });\r\n\r\n      // Places Autocomplete\r\n      const autocomplete = new google.maps.places.Autocomplete(addressInput, {\r\n        fields: ['formatted_address', 'geometry', 'place_id'],\r\n        componentRestrictions: { country: ['tr'] },\r\n      });\r\n\r\n      // Place se√ßildiƒüinde\r\n      autocomplete.addListener('place_changed', () => {\r\n        const place = autocomplete.getPlace();\r\n        if (!place?.geometry?.location) return;\r\n\r\n        const location = place.geometry.location;\r\n        map.setCenter(location);\r\n        map.setZoom(16);\r\n        marker.setPosition(location);\r\n\r\n        selectedAddress = {\r\n          address: place.formatted_address || addressInput.value,\r\n          lat: location.lat(),\r\n          lng: location.lng(),\r\n        };\r\n\r\n        updateInfo();\r\n        confirmBtn.disabled = false;\r\n      });\r\n\r\n      // Varsayƒ±lan adres varsa geocode et\r\n      if (defaultAddress) {\r\n        geocoder.geocode({ address: defaultAddress }, (results, status) => {\r\n          if (status === 'OK' && results?.[0]) {\r\n            const location = results[0].geometry.location;\r\n            map.setCenter(location);\r\n            map.setZoom(16);\r\n            marker.setPosition(location);\r\n\r\n            selectedAddress = {\r\n              address: results[0].formatted_address || defaultAddress,\r\n              lat: location.lat(),\r\n              lng: location.lng(),\r\n            };\r\n\r\n            updateInfo();\r\n            confirmBtn.disabled = false;\r\n          }\r\n        });\r\n      }\r\n\r\n      // Harita tƒ±klama\r\n      map.addListener('click', (e) => {\r\n        if (!e.latLng) return;\r\n\r\n        marker.setPosition(e.latLng);\r\n        geocoder.geocode({ location: e.latLng }, (results, status) => {\r\n          const address = status === 'OK' && results?.[0]?.formatted_address\r\n            ? results[0].formatted_address\r\n            : addressInput.value || 'Se√ßili konum';\r\n\r\n          selectedAddress = {\r\n            address: address,\r\n            lat: e.latLng.lat(),\r\n            lng: e.latLng.lng(),\r\n          };\r\n\r\n          addressInput.value = address;\r\n          updateInfo();\r\n          confirmBtn.disabled = false;\r\n        });\r\n      });\r\n\r\n      function updateInfo() {\r\n        if (selectedAddress) {\r\n          infoDiv.innerHTML = `\r\n            <div style=\"color:#10b981; font-weight:600; margin-bottom:4px;\">‚úî <b>${selectedAddress.address}</b></div>\r\n            <div style=\"font-size:12px; color:#6b7280;\">lat: ${selectedAddress.lat.toFixed(6)} ¬∑ lng: ${selectedAddress.lng.toFixed(6)}</div>\r\n          `;\r\n        } else {\r\n          infoDiv.innerHTML = 'Adres se√ßin veya haritadan bir nokta tƒ±klayƒ±n.';\r\n        }\r\n      }\r\n    })\r\n    .catch((err) => {\r\n      logger.error('Google Maps y√ºkleme hatasƒ±', err);\r\n      mapContainer.innerHTML = `<p style=\"color:#ef4444;\">‚ùå Harita y√ºklenemedi: ${err.message}</p>`;\r\n    });\r\n\r\n  // Event listeners\r\n  const closeBtn = document.getElementById('closeAddressModal');\r\n  closeBtn.addEventListener('click', () => {\r\n    if (onCancel) onCancel();\r\n    document.body.removeChild(modalOverlay);\r\n  });\r\n\r\n  confirmBtn.addEventListener('click', () => {\r\n    if (selectedAddress && onConfirm) {\r\n      onConfirm(selectedAddress);\r\n      document.body.removeChild(modalOverlay);\r\n    }\r\n  });\r\n\r\n  // ESC tu≈üu ile kapatma\r\n  const handleEsc = (e) => {\r\n    if (e.key === 'Escape') {\r\n      if (onCancel) onCancel();\r\n      document.body.removeChild(modalOverlay);\r\n      document.removeEventListener('keydown', handleEsc);\r\n    }\r\n  };\r\n  document.addEventListener('keydown', handleEsc);\r\n\r\n  // Overlay tƒ±klama ile kapatma (modal i√ßeriƒüine tƒ±klamada kapanmaz)\r\n  modalOverlay.addEventListener('click', (e) => {\r\n    if (e.target === modalOverlay) {\r\n      if (onCancel) onCancel();\r\n      document.body.removeChild(modalOverlay);\r\n      document.removeEventListener('keydown', handleEsc);\r\n    }\r\n  });\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\auth-guard.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\fcm.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getDoc' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":63,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":63,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Firebase Cloud Messaging (FCM) Setup\r\n * Teklifbul Rule v1.0 - Push notification support\r\n */\r\n\r\nimport { app, db, auth } from '/firebase.js';\r\n// Teklifbul Rule v1.0 - Structured Logging\r\nimport { logger } from '../../src/shared/log/logger.js';\r\nimport { getApp, getApps } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';\r\nimport { getMessaging, getToken, onMessage, isSupported } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-messaging.js';\r\nimport { doc, setDoc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';\r\n\r\n// VAPID Public Key - Firebase Console ‚Üí Project Settings ‚Üí Cloud Messaging ‚Üí Web Push certificates\r\n// Teklifbul Rule v1.0 - FCM Push Notifications\r\n// VAPID key format: Base64 URL-safe encoded, usually 87-88 characters\r\n// Firebase Console ‚Üí Project Settings ‚Üí Cloud Messaging ‚Üí Web Push certificates ‚Üí Key pair ‚Üí Public key\r\nconst VAPID_PUBLIC_KEY = window.FCM_VAPID_KEY || process.env.VITE_FCM_VAPID_KEY || '';\r\n\r\nlet messagingInstance = null;\r\nlet currentToken = null;\r\n\r\n/**\r\n * FCM messaging'i ba≈ülatƒ±r ve token alƒ±r\r\n * @param {ServiceWorkerRegistration} swReg - Service worker kaydƒ±\r\n * @returns {Promise<string|null>} FCM token veya null\r\n */\r\nexport async function setupMessaging(swReg) {\r\n  try {\r\n    // Messaging desteƒüi kontrol√º\r\n    const supported = await isSupported();\r\n    if (!supported) {\r\n      logger.warn('FCM bu tarayƒ±cƒ±da desteklenmiyor');\r\n      return null;\r\n    }\r\n\r\n    // Messaging instance olu≈ütur - Teklifbul Rule v1.0\r\n    // FCM i√ßin messagingSenderId gerekli - doƒüru app'i bul\r\n    let messagingApp = app;\r\n    \r\n    // App config kontrol√º - messagingSenderId olmalƒ±\r\n    if (!app.options || !app.options.messagingSenderId) {\r\n      logger.warn('Import edilen app\\'de messagingSenderId yok, t√ºm app\\'ler kontrol ediliyor...');\r\n      \r\n      // T√ºm app'leri kontrol et\r\n      const allApps = getApps();\r\n      const appWithMessaging = allApps.find(a => \r\n        a.options && a.options.messagingSenderId === '636669818119'\r\n      );\r\n      \r\n      if (appWithMessaging) {\r\n        messagingApp = appWithMessaging;\r\n        logger.info('messagingSenderId\\'li app bulundu', { appName: messagingApp.name });\r\n      } else {\r\n        // Default app'i dene\r\n        try {\r\n          const defaultApp = getApp();\r\n          if (defaultApp.options && defaultApp.options.messagingSenderId) {\r\n            messagingApp = defaultApp;\r\n            logger.info('Default app kullanƒ±lƒ±yor (messagingSenderId var)');\r\n          } else {\r\n            throw new Error('Default app\\'de de messagingSenderId yok');\r\n          }\r\n        } catch (e) {\r\n          logger.error('Firebase app\\'de messagingSenderId yok!');\r\n          logger.error('Import edilen app options', app.options);\r\n          logger.error('T√ºm app\\'ler', allApps.map(a => ({ name: a.name, hasMessaging: !!a.options?.messagingSenderId })));\r\n          throw new Error('Firebase app must have messagingSenderId configured. Check firebase.js config.');\r\n        }\r\n      }\r\n    }\r\n    \r\n    messagingInstance = getMessaging(messagingApp);\r\n    logger.info('Messaging instance olu≈üturuldu', { messagingSenderId: messagingApp.options.messagingSenderId });\r\n\r\n    // Bildirim izni iste\r\n    const permission = await Notification.requestPermission();\r\n    if (permission !== 'granted') {\r\n      logger.warn('Bildirim izni verilmedi', { permission });\r\n      return null;\r\n    }\r\n\r\n    // VAPID key kontrol√º ve format validasyonu\r\n    if (!VAPID_PUBLIC_KEY || VAPID_PUBLIC_KEY === 'BURAYA_FCM_WEB_PUSH_PUBLIC_KEY' || VAPID_PUBLIC_KEY.trim() === '') {\r\n      logger.error('VAPID_PUBLIC_KEY ayarlanmamƒ±≈ü!');\r\n      logger.error('VAPID key\\'i almak i√ßin:');\r\n      logger.error('   1. Firebase Console\\'a git: https://console.firebase.google.com/');\r\n      logger.error('   2. Project Settings ‚Üí Cloud Messaging ‚Üí Web Push certificates');\r\n      logger.error('   3. \"Generate key pair\" veya mevcut key pair\\'i kopyala');\r\n      logger.error('   4. Public key\\'i window.FCM_VAPID_KEY veya .env dosyasƒ±na ekle');\r\n      return null;\r\n    }\r\n    \r\n    // VAPID key format kontrol√º (Base64 URL-safe, genellikle 87-88 karakter)\r\n    const keyLength = VAPID_PUBLIC_KEY.length;\r\n    if (keyLength < 80 || keyLength > 90) {\r\n      logger.warn('VAPID key uzunluƒüu beklenenden farklƒ±', { keyLength, expected: '87-88 karakter' });\r\n    }\r\n    \r\n    // Base64 URL-safe karakter kontrol√º (opsiyonel - sadece uyarƒ±)\r\n    const base64UrlRegex = /^[A-Za-z0-9_-]+$/;\r\n    if (!base64UrlRegex.test(VAPID_PUBLIC_KEY)) {\r\n      logger.warn('VAPID key formatƒ± beklenmeyen karakterler i√ßeriyor (Base64 URL-safe olmalƒ±)');\r\n    }\r\n\r\n    // Token al\r\n    const token = await getToken(messagingInstance, {\r\n      vapidKey: VAPID_PUBLIC_KEY,\r\n      serviceWorkerRegistration: swReg,\r\n    });\r\n\r\n    if (!token) {\r\n      logger.warn('FCM token alƒ±namadƒ±');\r\n      return null;\r\n    }\r\n\r\n    currentToken = token;\r\n    logger.info('FCM token alƒ±ndƒ±', { tokenPrefix: token.substring(0, 20) + '...' });\r\n\r\n    // Token'ƒ± Firestore'a kaydet\r\n    await saveTokenToFirestore(token);\r\n\r\n    // Foreground mesajlarƒ±nƒ± dinle\r\n    onMessage(messagingInstance, (payload) => {\r\n      logger.info('Foreground FCM mesajƒ±', payload);\r\n      handleForegroundMessage(payload);\r\n    });\r\n\r\n    return token;\r\n  } catch (error) {\r\n    logger.error('FCM setup hatasƒ±', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Token'ƒ± Firestore'a kaydeder\r\n * @param {string} token - FCM token\r\n */\r\nasync function saveTokenToFirestore(token) {\r\n  try {\r\n    const user = auth.currentUser;\r\n    if (!user) {\r\n      logger.warn('Kullanƒ±cƒ± oturum a√ßmamƒ±≈ü, token kaydedilemedi');\r\n      return;\r\n    }\r\n\r\n    const userId = user.uid;\r\n    const tokenRef = doc(db, 'userTokens', userId, 'tokens', token);\r\n\r\n    await setDoc(tokenRef, {\r\n      token: token,\r\n      userId: userId,\r\n      createdAt: serverTimestamp(),\r\n      updatedAt: serverTimestamp(),\r\n      platform: 'web',\r\n      userAgent: navigator.userAgent,\r\n    }, { merge: true });\r\n\r\n    logger.info('FCM token Firestore\\'a kaydedildi');\r\n  } catch (error) {\r\n    logger.error('Token kaydetme hatasƒ±', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Foreground mesajlarƒ±nƒ± handle eder\r\n * @param {Object} payload - FCM payload\r\n */\r\nfunction handleForegroundMessage(payload) {\r\n  // Teklifbul Rule v1.0 - Toast notification g√∂ster\r\n  const title = payload.notification?.title || payload.data?.title || 'Teklifbul';\r\n  const body = payload.notification?.body || payload.data?.body || 'Yeni bildirim';\r\n\r\n  // Toast g√∂ster (eƒüer toast sistemi varsa)\r\n  if (window.showToast) {\r\n    window.showToast(title, body, 'info');\r\n  } else {\r\n    // Fallback: Browser notification (foreground)\r\n    if (Notification.permission === 'granted') {\r\n      new Notification(title, {\r\n        body: body,\r\n        icon: '/favicon.ico',\r\n        badge: '/favicon.ico',\r\n        tag: payload.data?.requestId || payload.data?.rfqId || 'fcm',\r\n        data: payload.data || {},\r\n      });\r\n    }\r\n  }\r\n\r\n  // Custom event dispatch (sayfalar dinleyebilir)\r\n  window.dispatchEvent(new CustomEvent('fcm-message', { detail: payload }));\r\n}\r\n\r\n/**\r\n * Service worker'ƒ± kaydeder ve FCM'i ba≈ülatƒ±r\r\n */\r\nexport async function initFCM() {\r\n  if (!('serviceWorker' in navigator)) {\r\n    logger.warn('Service Worker desteklenmiyor');\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    // Service worker'ƒ± kaydet\r\n    const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');\r\n    logger.info('Service Worker kaydedildi', { scope: registration.scope });\r\n\r\n    // FCM'i ba≈ülat\r\n    const token = await setupMessaging(registration);\r\n    return token;\r\n  } catch (error) {\r\n    logger.error('FCM init hatasƒ±', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Mevcut token'ƒ± d√∂nd√ºr√ºr\r\n * @returns {string|null}\r\n */\r\nexport function getCurrentToken() {\r\n  return currentToken;\r\n}\r\n\r\n/**\r\n * Token'ƒ± yeniler (kullanƒ±cƒ± deƒüi≈ütiƒüinde vs.)\r\n */\r\nexport async function refreshToken() {\r\n  if (!messagingInstance) {\r\n    await initFCM();\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const registration = await navigator.serviceWorker.ready;\r\n    const token = await setupMessaging(registration);\r\n    return token;\r\n  } catch (error) {\r\n    logger.error('Token yenileme hatasƒ±', error);\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\firebase.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\firebase\\init.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\firebase\\listener-manager.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\google-maps-loader.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\init\\address-init.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\init\\tax-init.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MANUAL_TOKEN' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":22,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { TaxService, MANUAL_TOKEN } from '../tax/taxService';\r\nimport { renderTaxSelect } from '../tax/render';\r\nimport { bindTaxSelect } from '../tax/bind';\r\nimport { TaxOffice } from '../types/taxOffice';\r\n// Teklifbul Rule v1.0 - Structured Logging\r\nimport { logger } from '../../../src/shared/log/logger.js';\r\n\r\n// 1) Veriyi y√ºkle (API/Firestore ‚Üí TaxOffice[])\r\nasync function loadTaxOffices(): Promise<TaxOffice[]> {\r\n  // Firestore'dan y√ºkle\r\n  try {\r\n    const response = await fetch('/api/taxoffices').then(r => r.json()).catch(() => null);\r\n    if (Array.isArray(response) && response.length > 0) {\r\n      return response;\r\n    }\r\n  } catch (e) {\r\n    logger.warn('API\\'den vergi dairesi y√ºklenemedi, fallback kullanƒ±lƒ±yor', e);\r\n  }\r\n  \r\n  // Fallback: LOCAL_TAX_OFFICES (window global)\r\n  if (typeof window !== 'undefined' && (window as any).LOCAL_TAX_OFFICES) {\r\n    const local = (window as any).LOCAL_TAX_OFFICES;\r\n    // Eƒüer string array ise TaxOffice[]'e d√∂n√º≈üt√ºr\r\n    if (Array.isArray(local)) {\r\n      return local.map((name: string, idx: number): TaxOffice => ({\r\n        id: `local-${idx}`,\r\n        name: String(name),\r\n        cityCode: '', // Bilinmiyor\r\n        scope: 'district' // Varsayƒ±lan\r\n      }));\r\n    }\r\n  }\r\n  \r\n  return [];\r\n}\r\n\r\nexport async function initTaxUI() {\r\n  const selCity   = document.getElementById('mainAddr_il')   as HTMLSelectElement;   // value=cityCode\r\n  const selDist   = document.getElementById('mainAddr_ilce') as HTMLSelectElement;   // value=districtCode\r\n  const selVD     = document.getElementById('mainAddr_taxOfficeSelect') as HTMLSelectElement;\r\n  const inpVD     = document.getElementById('mainAddr_taxOffice')       as HTMLInputElement;\r\n\r\n  if (!selVD || !inpVD) {\r\n    logger.warn('Tax office select/input elements not found');\r\n    return;\r\n  }\r\n\r\n  const data = await loadTaxOffices();\r\n  const svc  = new TaxService(data);\r\n\r\n  const idToName = (id: string) => svc.findById(id)?.name;\r\n\r\n  bindTaxSelect(selVD, inpVD, idToName);\r\n\r\n  const build = () => {\r\n    const cityCode     = selCity?.value || '';\r\n    const districtCode = selDist?.value || '';\r\n    const currentName  = inpVD.value || '';\r\n\r\n    // Kritik: **text deƒüil kod** kullan!\r\n    const lists = svc.splitByScope({ cityCode, districtCode });\r\n    renderTaxSelect(selVD, inpVD, lists, currentName);\r\n  };\r\n\r\n  build(); // ilk y√ºkleme (il/il√ße hen√ºz se√ßili deƒüilse t√ºm liste gruplu gelir)\r\n  \r\n  selCity?.addEventListener('change', build);\r\n  selDist?.addEventListener('change', build);\r\n  \r\n  const refreshBtn = document.getElementById('mainAddr_refreshTaxOfficesBtn');\r\n  if (refreshBtn) {\r\n    refreshBtn.addEventListener('click', async () => {\r\n      try {\r\n        refreshBtn.setAttribute('disabled', 'disabled');\r\n        refreshBtn.textContent = '‚è≥ Y√ºkleniyor...';\r\n        const fresh = await loadTaxOffices();\r\n        svc.setOffices(fresh);\r\n        build();\r\n        logger.info(\"Vergi dairesi listesi yenilendi\");\r\n      } catch (error) {\r\n        logger.error(\"Liste yenilenemedi\", error);\r\n      } finally {\r\n        refreshBtn.removeAttribute('disabled');\r\n        refreshBtn.textContent = 'üîÑ Yenile';\r\n      }\r\n    });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\services\\approval-guards.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\services\\audit.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'doc' is defined but never used. Allowed unused vars must match /^_/u.","line":16,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":16,"endColumn":6},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getDoc' is defined but never used. Allowed unused vars must match /^_/u.","line":17,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":17,"endColumn":9}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Audit Logs Service Module\r\n * Handles audit log operations and queries\r\n */\r\n\r\nimport { db } from '../firebase.js';\r\n// Teklifbul Rule v1.0 - Structured Logging\r\nimport { logger } from '../../../src/shared/log/logger.js';\r\nimport {\r\n  collection,\r\n  query,\r\n  where,\r\n  orderBy,\r\n  limit,\r\n  getDocs,\r\n  doc,\r\n  getDoc,\r\n  addDoc\r\n} from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';\r\n\r\n/**\r\n * Get audit logs for a specific demand\r\n * @param {string} demandId - Demand ID\r\n * @param {number} limitCount - Maximum number of logs to return\r\n * @returns {Promise<Array>} Array of audit log objects\r\n */\r\nexport async function getDemandAuditLogs(demandId, limitCount = 50) {\r\n  const q = query(\r\n    collection(db, \"auditLogs\"),\r\n    where(\"demandId\", \"==\", demandId),\r\n    orderBy(\"timestamp\", \"desc\"),\r\n    limit(limitCount)\r\n  );\r\n  \r\n  const snap = await getDocs(q);\r\n  return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));\r\n}\r\n\r\n/**\r\n * Get audit logs for a specific user\r\n * @param {string} userId - User ID\r\n * @param {number} limitCount - Maximum number of logs to return\r\n * @returns {Promise<Array>} Array of audit log objects\r\n */\r\nexport async function getUserAuditLogs(userId, limitCount = 50) {\r\n  const q = query(\r\n    collection(db, \"auditLogs\"),\r\n    where(\"actorUid\", \"==\", userId),\r\n    orderBy(\"timestamp\", \"desc\"),\r\n    limit(limitCount)\r\n  );\r\n  \r\n  const snap = await getDocs(q);\r\n  return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));\r\n}\r\n\r\n/**\r\n * Get all audit logs\r\n * @param {number} limitCount - Maximum number of logs to return\r\n * @returns {Promise<Array>} Array of audit log objects\r\n */\r\nexport async function getAllAuditLogs(limitCount = 100) {\r\n  const q = query(\r\n    collection(db, \"auditLogs\"),\r\n    orderBy(\"timestamp\", \"desc\"),\r\n    limit(limitCount)\r\n  );\r\n  \r\n  const snap = await getDocs(q);\r\n  return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));\r\n}\r\n\r\n/**\r\n * Get audit logs by field type\r\n * @param {string} field - Field name (isPublished, visibility, etc.)\r\n * @param {number} limitCount - Maximum number of logs to return\r\n * @returns {Promise<Array>} Array of audit log objects\r\n */\r\nexport async function getAuditLogsByField(field, limitCount = 50) {\r\n  const q = query(\r\n    collection(db, \"auditLogs\"),\r\n    where(\"field\", \"==\", field),\r\n    orderBy(\"timestamp\", \"desc\"),\r\n    limit(limitCount)\r\n  );\r\n  \r\n  const snap = await getDocs(q);\r\n  return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));\r\n}\r\n\r\n/**\r\n * Format audit log for display\r\n * @param {Object} log - Audit log object\r\n * @returns {Object} Formatted log object\r\n */\r\nexport function formatAuditLog(log) {\r\n  const timestamp = log.timestamp?.toDate?.() || new Date(log.timestamp || 0);\r\n  \r\n  let action = '';\r\n  let description = '';\r\n  \r\n  switch (log.field) {\r\n    case 'isPublished':\r\n      action = log.to ? 'Yayƒ±nlandƒ±' : 'Yayƒ±ndan Kaldƒ±rƒ±ldƒ±';\r\n      description = `Talep ${log.to ? 'yayƒ±nlandƒ±' : 'yayƒ±ndan kaldƒ±rƒ±ldƒ±'}`;\r\n      break;\r\n    case 'visibility':\r\n      const visibilityNames = {\r\n        'public': 'Herkese A√ßƒ±k',\r\n        'company': '≈ûirket ƒ∞√ßinde',\r\n        'private': '√ñzel'\r\n      };\r\n      action = 'G√∂r√ºn√ºrl√ºk Deƒüi≈ütirildi';\r\n      description = `G√∂r√ºn√ºrl√ºk \"${visibilityNames[log.from] || log.from}\" ‚Üí \"${visibilityNames[log.to] || log.to}\" olarak deƒüi≈ütirildi`;\r\n      break;\r\n    default:\r\n      action = 'Deƒüi≈üiklik';\r\n      description = `${log.field} alanƒ± deƒüi≈ütirildi`;\r\n  }\r\n  \r\n  return {\r\n    ...log,\r\n    formattedTimestamp: timestamp.toLocaleString('tr-TR'),\r\n    action,\r\n    description\r\n  };\r\n}\r\n\r\n/**\r\n * Get audit log statistics\r\n * @param {string} demandId - Demand ID (optional)\r\n * @returns {Promise<Object>} Statistics object\r\n */\r\nexport async function getAuditStats(demandId = null) {\r\n  try {\r\n    let q;\r\n    if (demandId) {\r\n      q = query(\r\n        collection(db, \"auditLogs\"),\r\n        where(\"demandId\", \"==\", demandId)\r\n      );\r\n    } else {\r\n      q = query(collection(db, \"auditLogs\"));\r\n    }\r\n    \r\n    const snap = await getDocs(q);\r\n    const logs = snap.docs.map(doc => doc.data());\r\n    \r\n    const stats = {\r\n      totalLogs: logs.length,\r\n      publishCount: logs.filter(log => log.field === 'isPublished' && log.to === true).length,\r\n      unpublishCount: logs.filter(log => log.field === 'isPublished' && log.to === false).length,\r\n      visibilityChanges: logs.filter(log => log.field === 'visibility').length,\r\n      uniqueActors: new Set(logs.map(log => log.actorUid)).size,\r\n      uniqueDemands: new Set(logs.map(log => log.demandId)).size\r\n    };\r\n    \r\n    return stats;\r\n  } catch (error) {\r\n    logger.error('Error getting audit stats', error);\r\n    return {\r\n      totalLogs: 0,\r\n      publishCount: 0,\r\n      unpublishCount: 0,\r\n      visibilityChanges: 0,\r\n      uniqueActors: 0,\r\n      uniqueDemands: 0\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Create a manual audit log entry\r\n * @param {Object} logData - Audit log data\r\n * @returns {Promise<string>} Created log ID\r\n */\r\nexport async function createAuditLog(logData) {\r\n  const docRef = await addDoc(collection(db, \"auditLogs\"), {\r\n    ...logData,\r\n    timestamp: new Date(),\r\n    createdAt: new Date()\r\n  });\r\n  return docRef.id;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\services\\category-groups.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\services\\category-suggest.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\services\\demands-new.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\services\\demands.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\services\\rfq-bids.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'limit' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'arrayRemove' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":62,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":73}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// RFQ Bidding System Service\r\nimport { db } from '../firebase.js';\r\n// Teklifbul Rule v1.0 - Structured Logging\r\nimport { logger } from '../../../src/shared/log/logger.js';\r\nimport {\r\n  collection, doc, addDoc, updateDoc, deleteDoc, getDocs, getDoc,\r\n  query, where, orderBy, limit, serverTimestamp, arrayUnion, arrayRemove\r\n} from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';\r\n\r\n/**\r\n * Create a new RFQ bid with commercial terms and item matrix\r\n */\r\nexport async function createRFQBid(bidData) {\r\n  try {\r\n    const bidRef = await addDoc(collection(db, 'bids'), {\r\n      ...bidData,\r\n      status: 'draft',\r\n      statusHistory: [{\r\n        status: 'draft',\r\n        timestamp: Date.now(),\r\n        note: 'Teklif olu≈üturuldu'\r\n      }],\r\n      createdAt: serverTimestamp(),\r\n      updatedAt: serverTimestamp()\r\n    });\r\n\r\n    // Create bid items subcollection\r\n    if (bidData.items && bidData.items.length > 0) {\r\n      const itemsRef = collection(db, 'bids', bidRef.id, 'items');\r\n      \r\n      for (const item of bidData.items) {\r\n        await addDoc(itemsRef, {\r\n          ...item,\r\n          createdAt: serverTimestamp(),\r\n          updatedAt: serverTimestamp()\r\n        });\r\n      }\r\n    }\r\n\r\n    return bidRef.id;\r\n  } catch (error) {\r\n    logger.error('Error creating RFQ bid', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Update an existing RFQ bid\r\n */\r\nexport async function updateRFQBid(bidId, bidData) {\r\n  try {\r\n    const bidRef = doc(db, 'bids', bidId);\r\n    \r\n    // Update main bid document\r\n    await updateDoc(bidRef, {\r\n      ...bidData,\r\n      updatedAt: serverTimestamp()\r\n    });\r\n\r\n    // Update items if provided\r\n    if (bidData.items) {\r\n      // Delete existing items\r\n      const itemsSnapshot = await getDocs(collection(db, 'bids', bidId, 'items'));\r\n      for (const itemDoc of itemsSnapshot.docs) {\r\n        await deleteDoc(doc(db, 'bids', bidId, 'items', itemDoc.id));\r\n      }\r\n\r\n      // Add new items\r\n      const itemsRef = collection(db, 'bids', bidId, 'items');\r\n      for (const item of bidData.items) {\r\n        await addDoc(itemsRef, {\r\n          ...item,\r\n          createdAt: serverTimestamp(),\r\n          updatedAt: serverTimestamp()\r\n        });\r\n      }\r\n    }\r\n\r\n    return bidId;\r\n  } catch (error) {\r\n    logger.error('Error updating RFQ bid', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Get bid with items\r\n */\r\nexport async function getRFQBidWithItems(bidId) {\r\n  try {\r\n    const bidDoc = await getDoc(doc(db, 'bids', bidId));\r\n    if (!bidDoc.exists()) {\r\n      throw new Error('Bid not found');\r\n    }\r\n\r\n    const bidData = bidDoc.data();\r\n    \r\n    // Get items\r\n    const itemsSnapshot = await getDocs(collection(db, 'bids', bidId, 'items'));\r\n    const items = itemsSnapshot.docs.map(doc => ({\r\n      id: doc.id,\r\n      ...doc.data()\r\n    }));\r\n\r\n    return {\r\n      id: bidDoc.id,\r\n      ...bidData,\r\n      items\r\n    };\r\n  } catch (error) {\r\n    logger.error('Error getting RFQ bid', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Get all bids for a demand with items\r\n */\r\nexport async function getDemandBidsWithItems(demandId) {\r\n  try {\r\n    const bidsQuery = query(\r\n      collection(db, 'bids'),\r\n      where('demandId', '==', demandId),\r\n      orderBy('createdAt', 'desc')\r\n    );\r\n    \r\n    const bidsSnapshot = await getDocs(bidsQuery);\r\n    const bids = [];\r\n\r\n    for (const bidDoc of bidsSnapshot.docs) {\r\n      const bidData = bidDoc.data();\r\n      \r\n      // Get items for this bid\r\n      const itemsSnapshot = await getDocs(collection(db, 'bids', bidDoc.id, 'items'));\r\n      const items = itemsSnapshot.docs.map(itemDoc => ({\r\n        id: itemDoc.id,\r\n        ...itemDoc.data()\r\n      }));\r\n\r\n      bids.push({\r\n        id: bidDoc.id,\r\n        ...bidData,\r\n        items\r\n      });\r\n    }\r\n\r\n    return bids;\r\n  } catch (error) {\r\n    logger.error('Error getting demand bids', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Update bid status with history tracking\r\n */\r\nexport async function updateBidStatus(bidId, newStatus, note = '') {\r\n  try {\r\n    const bidRef = doc(db, 'bids', bidId);\r\n    \r\n    await updateDoc(bidRef, {\r\n      status: newStatus,\r\n      statusHistory: arrayUnion({\r\n        status: newStatus,\r\n        timestamp: Date.now(),\r\n        note: note\r\n      }),\r\n      updatedAt: serverTimestamp()\r\n    });\r\n\r\n    return bidId;\r\n  } catch (error) {\r\n    logger.error('Error updating bid status', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Shortlist a bid\r\n */\r\nexport async function shortlistBid(bidId) {\r\n  return updateBidStatus(bidId, 'shortlisted', 'Teklif kƒ±sa listeye alƒ±ndƒ±');\r\n}\r\n\r\n/**\r\n * Accept a bid\r\n */\r\nexport async function acceptBid(bidId) {\r\n  return updateBidStatus(bidId, 'accepted', 'Teklif kabul edildi');\r\n}\r\n\r\n/**\r\n * Reject a bid\r\n */\r\nexport async function rejectBid(bidId) {\r\n  return updateBidStatus(bidId, 'rejected', 'Teklif reddedildi');\r\n}\r\n\r\n/**\r\n * Set bid as completed\r\n */\r\nexport async function setBidCompleted(bidId) {\r\n  return updateBidStatus(bidId, 'completed', 'Teklif tamamlandƒ±');\r\n}\r\n\r\n/**\r\n * Calculate total bid amount\r\n */\r\nexport function calculateBidTotal(items, currency = 'TRY') {\r\n  let total = 0;\r\n  \r\n  for (const item of items) {\r\n    if (item.compliance === 'match' && item.netPrice && item.quantity) {\r\n      total += parseFloat(item.netPrice) * parseFloat(item.quantity);\r\n    }\r\n  }\r\n  \r\n  return {\r\n    amount: total,\r\n    currency: currency,\r\n    formatted: `${total.toLocaleString('tr-TR')} ${currency}`\r\n  };\r\n}\r\n\r\n/**\r\n * Validate bid data\r\n */\r\nexport function validateBidData(bidData) {\r\n  const errors = [];\r\n  \r\n  // Required commercial terms\r\n  if (!bidData.currency) errors.push('Para birimi se√ßilmelidir');\r\n  if (!bidData.validityDays) errors.push('Ge√ßerlilik s√ºresi belirtilmelidir');\r\n  if (!bidData.incoterm) errors.push('Teslim ≈üekli se√ßilmelidir');\r\n  if (!bidData.deliveryAddress) errors.push('Teslimat adresi belirtilmelidir');\r\n  \r\n  // Items validation\r\n  if (!bidData.items || bidData.items.length === 0) {\r\n    errors.push('En az bir √ºr√ºn kalemi teklif edilmelidir');\r\n  } else {\r\n    bidData.items.forEach((item, index) => {\r\n      if (item.compliance === 'match') {\r\n        if (!item.netPrice) errors.push(`√úr√ºn ${index + 1}: Fiyat belirtilmelidir`);\r\n        if (!item.brand) errors.push(`√úr√ºn ${index + 1}: Marka belirtilmelidir`);\r\n        if (!item.leadTimeDays) errors.push(`√úr√ºn ${index + 1}: Teslim s√ºresi belirtilmelidir`);\r\n      }\r\n    });\r\n  }\r\n  \r\n  return {\r\n    isValid: errors.length === 0,\r\n    errors\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\services\\suppliers.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\state\\company.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":186,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":186,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":216,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":216,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Company State Management\r\n * Handles company selection and persistence with priority-based resolution\r\n */\r\n\r\nimport { db, auth } from '../firebase.js';\r\nimport { doc, getDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';\r\n\r\nconst LS_KEY = 'activeCompanyId';\r\nconst PROFILE_KEYS = ['companyName', 'company_name', 'company_title']; // robust keys\r\nlet activeCompanyId = null;\r\nlet userCompanies = [];\r\n\r\n/**\r\n * Get active company ID with priority-based resolution\r\n * Priority: (1) localStorage, (2) user.defaultCompanyId, (3) first membership\r\n * @returns {Promise<string|null>} Active company ID\r\n */\r\nexport async function getActiveCompanyId() {\r\n  try {\r\n    // Priority 1: localStorage\r\n    const saved = localStorage.getItem(LS_KEY);\r\n    if (saved) {\r\n      activeCompanyId = saved;\r\n      return saved;\r\n    }\r\n\r\n    const user = auth.currentUser;\r\n    if (!user) return null;\r\n\r\n    // Priority 2: users/{uid}.defaultCompanyId\r\n    const profSnap = await getDoc(doc(db, 'users', user.uid)).catch(() => null);\r\n    if (profSnap?.exists()) {\r\n      const data = profSnap.data() || {};\r\n      if (data.defaultCompanyId) {\r\n        localStorage.setItem(LS_KEY, data.defaultCompanyId);\r\n        activeCompanyId = data.defaultCompanyId;\r\n        return data.defaultCompanyId;\r\n      }\r\n    }\r\n\r\n    // Priority 3: membership fallback\r\n    try {\r\n      const companiesQ = query(collection(db, 'companies'), where('members', 'array-contains', user.uid));\r\n      const companies = await getDocs(companiesQ);\r\n      const first = companies.docs?.[0];\r\n      if (first) {\r\n        localStorage.setItem(LS_KEY, first.id);\r\n        activeCompanyId = first.id;\r\n        return first.id;\r\n      }\r\n    } catch (e) {\r\n      logger.warn('Membership query failed', e);\r\n    }\r\n\r\n    return null;\r\n    \r\n  } catch (error) {\r\n    logger.error('Error getting active company ID', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Set active company ID and persist to localStorage\r\n * @param {string} companyId - Company ID to set as active\r\n */\r\nexport function setActiveCompanyId(companyId) {\r\n  activeCompanyId = companyId;\r\n  localStorage.setItem(LS_KEY, companyId);\r\n  \r\n  // Dispatch change event\r\n  window.dispatchEvent(new CustomEvent('company:changed', {\r\n    detail: { companyId }\r\n  }));\r\n  \r\n  logger.info('Active company changed', { companyId });\r\n}\r\n\r\n/**\r\n * Load user companies from Firestore\r\n * @param {string} uid - User ID\r\n * @returns {Promise<Array>} Array of company objects\r\n */\r\nexport async function loadUserCompanies(uid) {\r\n  try {\r\n    // Get user profile to find company memberships\r\n    const userDoc = await getDoc(doc(db, 'users', uid));\r\n    if (!userDoc.exists()) {\r\n      userCompanies = [];\r\n      return userCompanies;\r\n    }\r\n\r\n    const userData = userDoc.data();\r\n    const companyIds = userData.companies || [];\r\n    \r\n    logger.info('User data from Firestore', {\r\n      uid,\r\n      companies: companyIds,\r\n      defaultCompanyId: userData.defaultCompanyId,\r\n      companyName: userData.companyName\r\n    });\r\n\r\n    if (companyIds.length === 0) {\r\n      // If no companies array, try to use defaultCompanyId\r\n      if (userData.defaultCompanyId) {\r\n        logger.info('No companies array, using defaultCompanyId', { defaultCompanyId: userData.defaultCompanyId });\r\n        companyIds.push(userData.defaultCompanyId);\r\n      } else {\r\n        userCompanies = [];\r\n        return userCompanies;\r\n      }\r\n    }\r\n\r\n    // Fetch company details\r\n    const companies = [];\r\n    for (const companyId of companyIds) {\r\n      try {\r\n        const companyDoc = await getDoc(doc(db, 'companies', companyId));\r\n        if (companyDoc.exists()) {\r\n          companies.push({\r\n            id: companyId,\r\n            ...companyDoc.data()\r\n          });\r\n        } else {\r\n          // If company document doesn't exist, try to use user's companyName\r\n          if (userData.companyName) {\r\n            logger.info('Company document not found, using user companyName', { companyName: userData.companyName });\r\n            companies.push({\r\n              id: companyId,\r\n              name: userData.companyName\r\n            });\r\n          }\r\n        }\r\n      } catch (error) {\r\n        logger.warn(`Failed to load company ${companyId}`, error);\r\n        // Fallback to user's companyName\r\n        if (userData.companyName) {\r\n          companies.push({\r\n            id: companyId,\r\n            name: userData.companyName\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    userCompanies = companies;\r\n    logger.info('Loaded user companies', { companies: userCompanies });\r\n    return userCompanies;\r\n    \r\n  } catch (error) {\r\n    logger.error('Error loading user companies', error);\r\n    userCompanies = [];\r\n    return userCompanies;\r\n  }\r\n}\r\n\r\n/**\r\n * Get active company data\r\n * @returns {Promise<Object|null>} Active company object or null\r\n */\r\nexport async function getActiveCompany() {\r\n  try {\r\n    // Try by id first\r\n    const id = await getActiveCompanyId();\r\n    if (id) {\r\n      const snap = await getDoc(doc(db, 'companies', id)).catch(() => null);\r\n      if (snap?.exists()) return { id, ...snap.data() };\r\n    }\r\n\r\n    // Otherwise fallback to profile \"≈ûirket Adƒ±\" fields\r\n    const user = auth.currentUser;\r\n    if (!user) return null;\r\n    \r\n    // Try profiles collection first (hesap ayarlarƒ±)\r\n    const collections = ['profiles', 'users', 'publicProfiles'];\r\n    for (const collection of collections) {\r\n      try {\r\n        const profSnap = await getDoc(doc(db, collection, user.uid)).catch(() => null);\r\n        if (profSnap?.exists()) {\r\n          const data = profSnap.data() || {};\r\n          for (const k of PROFILE_KEYS) {\r\n            if (data[k]) return { id: null, name: data[k] };\r\n          }\r\n        }\r\n      } catch (e) {\r\n        continue;\r\n      }\r\n    }\r\n    return null;\r\n    \r\n  } catch (error) {\r\n    logger.error('Error getting active company', error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function getCompanyName() {\r\n  const c = await getActiveCompany();\r\n  if (c?.name) return c.name;\r\n  \r\n  // As a last resort, try the profile fields directly\r\n  const user = auth.currentUser;\r\n  if (!user) return '≈ûirket Yok';\r\n  \r\n  const collections = ['profiles', 'users', 'publicProfiles'];\r\n  for (const collection of collections) {\r\n    try {\r\n      const profSnap = await getDoc(doc(db, collection, user.uid)).catch(() => null);\r\n      if (profSnap?.exists()) {\r\n        const data = profSnap.data() || {};\r\n        for (const k of PROFILE_KEYS) {\r\n          if (data[k]) return data[k];\r\n        }\r\n      }\r\n    } catch (e) {\r\n      continue;\r\n    }\r\n  }\r\n  \r\n  return '≈ûirket Yok';\r\n}\r\n\r\n/**\r\n * Resolve active company (auto-select if none)\r\n * @param {string} uid - User ID\r\n * @returns {Promise<string|null>} Active company ID\r\n */\r\nexport async function resolveActiveCompany(uid) {\r\n  await loadUserCompanies(uid);\r\n  \r\n  // Try to get from localStorage first\r\n  const savedCompanyId = localStorage.getItem(LS_KEY);\r\n  \r\n  if (savedCompanyId && userCompanies.find(c => c.id === savedCompanyId)) {\r\n    activeCompanyId = savedCompanyId;\r\n    return activeCompanyId;\r\n  }\r\n\r\n  // If no saved company or invalid, use first available\r\n  if (userCompanies.length > 0) {\r\n    activeCompanyId = userCompanies[0].id;\r\n    localStorage.setItem(LS_KEY, activeCompanyId);\r\n    return activeCompanyId;\r\n  } else {\r\n    activeCompanyId = null;\r\n    localStorage.removeItem(LS_KEY);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Get all user companies\r\n * @returns {Array} Array of company objects\r\n */\r\nexport function getUserCompanies() {\r\n  return userCompanies;\r\n}\r\n\r\n/**\r\n * Check if user has multiple companies\r\n * @returns {boolean} True if user has multiple companies\r\n */\r\nexport function hasMultipleCompanies() {\r\n  return userCompanies.length > 1;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\tax\\bind.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\tax\\render.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\tax\\saveTax.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\tax\\taxService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\theme.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\types\\address.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\types\\taxOffice.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\ui\\auto-resize.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\ui\\category-groups-modal.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'currentStep' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":138,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":138,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Category Groups Modal UI - BASIT VERSƒ∞YON\n * Test sayfasƒ±ndaki gibi √ßalƒ±≈üan basit modal\n */\n\n// Teklifbul Rule v1.0 - Structured Logging\nimport { logger } from '../../../src/shared/log/logger.js';\n\n// Categories embedded directly to avoid import issues\nconst EMBEDDED_CATEGORIES = [\n  \"Sac/Metal\",\n  \"Elektrik\", \n  \"Elektronik\",\n  \"Makine-ƒ∞malat\",\n  \"Hƒ±rdavat\",\n  \"Ambalaj\",\n  \"Kimyasal\",\n  \"ƒ∞n≈üaat Malzemeleri\",\n  \"Mobilya\",\n  \"Boya\",\n  \"Plastik\",\n  \"Otomotiv Yan Sanayi\",\n  \"ƒ∞≈ü G√ºvenliƒüi\",\n  \"Temizlik\",\n  \"Gƒ±da\",\n  \"Hizmet\",\n  \"Lojistik\"\n];\n\n// Dynamic import for categories to handle missing file gracefully\nasync function loadCategories() {\n  try {\n    // Try to load from external file first\n    const mod = await import('../../../categories.js');\n    logger.info('Categories loaded from file', { count: mod.CATEGORIES?.length });\n    return mod.CATEGORIES || EMBEDDED_CATEGORIES;\n  } catch (e) {\n    logger.warn('categories.js y√ºklenemedi, embedded kategoriler kullanƒ±lƒ±yor', e);\n    try {\n      // Fallback: absolute path\n      const mod2 = await import('/categories.js');\n      logger.info('Categories loaded (fallback)', { count: mod2.CATEGORIES?.length });\n      return mod2.CATEGORIES || EMBEDDED_CATEGORIES;\n    } catch (e2) {\n      logger.warn('categories.js y√ºklenemedi, embedded kategoriler kullanƒ±lƒ±yor', e2);\n      // Use embedded categories as final fallback\n      logger.info('Using embedded categories', { count: EMBEDDED_CATEGORIES.length });\n      return EMBEDDED_CATEGORIES;\n    }\n  }\n}\n\n// Simple category groups modal - BASIT VERSƒ∞YON\nfunction initCategoryGroupsModal() {\n  logger.info('Category groups modal initializing...');\n  \n  // Remove existing modal if any\n  const existingModal = document.getElementById('categoryGroupsModal');\n  if (existingModal) {\n    existingModal.remove();\n  }\n  \n  // Create simple modal HTML\n  const modalHTML = `\n    <div id=\"categoryGroupsModal\" style=\"display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;\">\n      <div style=\"position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 24px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;\">\n        \n        <!-- Header -->\n        <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;\">\n          <h2 id=\"modalTitle\" style=\"margin: 0; color: #1f2937;\">üè∑Ô∏è Kategori Grubu Olu≈ütur</h2>\n          <button id=\"closeModal\" style=\"background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;\">&times;</button>\n        </div>\n        \n        <!-- Step 1: Group Name -->\n        <div id=\"step1\" class=\"modal-step\">\n          <div style=\"margin-bottom: 16px;\">\n            <label for=\"groupName\" style=\"display: block; margin-bottom: 8px; font-weight: 600; color: #374151;\">Grup Adƒ± *</label>\n            <input type=\"text\" id=\"groupName\" placeholder=\"√ñrn: ƒ∞n≈üaat Malzemeleri\" style=\"width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;\">\n            <p id=\"nameError\" style=\"color: #dc2626; font-size: 12px; margin-top: 4px; display: none;\"></p>\n          </div>\n          <div style=\"display: flex; gap: 12px; justify-content: flex-end;\">\n            <button id=\"cancelStep1\" style=\"padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;\">ƒ∞ptal</button>\n            <button id=\"nextStep\" style=\"padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;\">ƒ∞lerle</button>\n          </div>\n        </div>\n        \n        <!-- Step 2: Category Selection - BASIT VERSƒ∞YON -->\n        <div id=\"step2\" class=\"modal-step\" style=\"display: none;\">\n          <div style=\"margin-bottom: 16px;\">\n            <label style=\"display: block; margin-bottom: 8px; font-weight: 600; color: #374151;\">Kategoriler Se√ß *</label>\n            <input type=\"text\" id=\"categorySearch\" placeholder=\"Kategori ara...\" style=\"width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;\">\n          </div>\n          \n          <!-- BASIT KATEGORƒ∞ Lƒ∞STESƒ∞ -->\n          <div style=\"border: 2px solid #3b82f6; background: #f0f9ff; padding: 20px; margin: 10px 0; border-radius: 8px;\">\n            <h4 style=\"margin: 0 0 15px 0; color: #1e40af;\">üìã Mevcut Kategoriler:</h4>\n            <div id=\"categoryList\" style=\"background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 15px; min-height: 300px; max-height: 400px; overflow-y: auto;\">\n              <!-- Categories will be populated here -->\n            </div>\n          </div>\n          \n          <div style=\"margin-top: 16px;\">\n            <p style=\"font-size: 12px; color: #6b7280; margin: 0;\">\n              <span id=\"selectedCount\">0</span> kategori se√ßildi\n            </p>\n          </div>\n          \n          <div style=\"margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;\">\n            <button id=\"backStep\" style=\"padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;\">Geri</button>\n            <button id=\"saveGroup\" style=\"padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;\">Kaydet</button>\n          </div>\n        </div>\n        \n      </div>\n    </div>\n  `;\n  \n  // Add modal to page\n  document.body.insertAdjacentHTML('beforeend', modalHTML);\n  logger.info('Modal HTML added to page');\n  \n  // Get modal elements\n  const modal = document.getElementById('categoryGroupsModal');\n  const closeBtn = document.getElementById('closeModal');\n  const groupNameInput = document.getElementById('groupName');\n  const nameError = document.getElementById('nameError');\n  const nextStepBtn = document.getElementById('nextStep');\n  const backStepBtn = document.getElementById('backStep');\n  const saveGroupBtn = document.getElementById('saveGroup');\n  const cancelStep1Btn = document.getElementById('cancelStep1');\n  const categorySearch = document.getElementById('categorySearch');\n  const categoryList = document.getElementById('categoryList');\n  const selectedCount = document.getElementById('selectedCount');\n  \n  logger.info('Modal element found', { modal: !!modal });\n  \n  // State\n  let currentStep = 1;\n  let selectedCategories = new Set();\n  let allCategories = [];\n  \n  // Event listeners\n  closeBtn.addEventListener('click', closeModal);\n  cancelStep1Btn.addEventListener('click', closeModal);\n  \n  nextStepBtn.addEventListener('click', () => {\n    const groupName = groupNameInput.value.trim();\n    if (!groupName) {\n      nameError.textContent = 'Grup adƒ± gereklidir';\n      nameError.style.display = 'block';\n      return;\n    }\n    \n    nameError.style.display = 'none';\n    showStep(2);\n  });\n  \n  backStepBtn.addEventListener('click', () => {\n    showStep(1);\n  });\n  \n  saveGroupBtn.addEventListener('click', async () => {\n    if (selectedCategories.size === 0) {\n      alert('En az bir kategori se√ßmelisiniz');\n      return;\n    }\n    \n    const groupName = groupNameInput.value.trim();\n    const groupData = {\n      name: groupName,\n      categories: Array.from(selectedCategories),\n      createdAt: new Date().toISOString()\n    };\n    \n    try {\n      // Save group (you can implement this)\n      logger.info('Saving group', groupData);\n      alert(`Grup \"${groupName}\" ba≈üarƒ±yla olu≈üturuldu!`);\n      closeModal();\n    } catch (error) {\n      logger.error('Error saving group', error);\n      alert('Grup kaydedilirken hata olu≈ütu');\n    }\n  });\n  \n  // Category search\n  categorySearch.addEventListener('input', (e) => {\n    const searchTerm = e.target.value.toLowerCase();\n    populateCategories(searchTerm);\n  });\n  \n  // Functions\n  function showStep(step) {\n    currentStep = step;\n    \n    // Hide all steps\n    document.querySelectorAll('.modal-step').forEach(stepEl => {\n      stepEl.style.display = 'none';\n    });\n    \n    // Show current step\n    document.getElementById(`step${step}`).style.display = 'block';\n    \n    if (step === 2) {\n      loadAndPopulateCategories();\n    }\n  }\n  \n  async function loadAndPopulateCategories() {\n    logger.info('Loading categories...');\n    allCategories = await loadCategories();\n    logger.info('Categories loaded', { count: allCategories.length });\n    populateCategories();\n  }\n  \n  function populateCategories(searchTerm = '') {\n    logger.info('Populating categories...');\n    \n    // Clear existing categories\n    categoryList.innerHTML = '';\n    \n    // Filter categories based on search\n    const filteredCategories = allCategories.filter(category => \n      category.toLowerCase().includes(searchTerm.toLowerCase())\n    );\n    \n    logger.info(`Showing ${filteredCategories.length} categories`);\n    \n    // Add each category\n    filteredCategories.forEach(category => {\n      const isSelected = selectedCategories.has(category);\n      \n      const categoryDiv = document.createElement('div');\n      categoryDiv.style.cssText = `\n        display: flex !important;\n        align-items: center !important;\n        padding: 12px !important;\n        margin: 8px 0 !important;\n        border-radius: 8px !important;\n        cursor: pointer !important;\n        background-color: ${isSelected ? '#dbeafe' : '#f8fafc'} !important;\n        border: 2px solid ${isSelected ? '#3b82f6' : '#e5e7eb'} !important;\n        min-height: 50px !important;\n        width: 100% !important;\n        font-size: 16px !important;\n        font-weight: 500 !important;\n        visibility: visible !important;\n        opacity: 1 !important;\n        position: relative !important;\n        z-index: 1 !important;\n      `;\n      \n      // Teklifbul Rule v1.0 - Kategori √∂neri sistemi: tooltip ve detay desteƒüi\n      categoryDiv.innerHTML = `\n        <input type=\"checkbox\" ${isSelected ? 'checked' : ''} style=\"margin-right: 12px; width: 20px; height: 20px; transform: scale(1.2);\">\n        <span style=\"flex: 1; color: #1f2937;\">${category}</span>\n        <span class=\"category-info-icon\" data-category=\"${category}\" \n              style=\"margin-left: 8px; cursor: pointer; color: #3b82f6; font-size: 18px;\"\n              title=\"Kategori bilgisi\" aria-label=\"Kategori bilgisi\">\n          ‚ìò\n        </span>\n      `;\n      \n      // Tooltip i√ßin event listener\n      const infoIcon = categoryDiv.querySelector('.category-info-icon');\n      if (infoIcon) {\n        infoIcon.addEventListener('click', (e) => {\n          e.stopPropagation();\n          showCategoryInfo(category);\n        });\n        \n        // Hover tooltip (basit)\n        let tooltipTimeout;\n        infoIcon.addEventListener('mouseenter', () => {\n          tooltipTimeout = setTimeout(() => {\n            loadCategoryTooltip(category, infoIcon);\n          }, 500);\n        });\n        infoIcon.addEventListener('mouseleave', () => {\n          clearTimeout(tooltipTimeout);\n          hideTooltip();\n        });\n      }\n      \n      // Click handler\n      categoryDiv.addEventListener('click', (e) => {\n        if (e.target.type !== 'checkbox') {\n          const checkbox = categoryDiv.querySelector('input[type=\"checkbox\"]');\n          checkbox.checked = !checkbox.checked;\n        }\n        \n        const checkbox = categoryDiv.querySelector('input[type=\"checkbox\"]');\n        if (checkbox.checked) {\n          selectedCategories.add(category);\n          categoryDiv.style.backgroundColor = '#dbeafe';\n          categoryDiv.style.borderColor = '#3b82f6';\n        } else {\n          selectedCategories.delete(category);\n          categoryDiv.style.backgroundColor = '#f8fafc';\n          categoryDiv.style.borderColor = '#e5e7eb';\n        }\n        \n        updateSelectedCount();\n      });\n      \n      categoryList.appendChild(categoryDiv);\n      logger.info(`Category \"${category}\" added to DOM`);\n    });\n    \n    updateSelectedCount();\n    logger.info(`${filteredCategories.length} categories rendered`);\n    \n    // AGGRESSIVE CSS FORCE - Container\n    categoryList.style.cssText = `\n      background: white !important;\n      border: 2px solid #3b82f6 !important;\n      border-radius: 6px !important;\n      padding: 15px !important;\n      min-height: 300px !important;\n      max-height: 400px !important;\n      overflow-y: auto !important;\n      display: block !important;\n      visibility: visible !important;\n      opacity: 1 !important;\n      position: relative !important;\n      z-index: 1 !important;\n    `;\n    \n    logger.info('AGGRESSIVE CSS forced for categoryList');\n  }\n  \n  function updateSelectedCount() {\n    selectedCount.textContent = selectedCategories.size;\n  }\n  \n  // Teklifbul Rule v1.0 - Kategori bilgi tooltip ve detay kartƒ±\n  let tooltipElement = null;\n  let categoryDetailsCache = new Map();\n  \n  async function loadCategoryTooltip(categoryName, anchorElement) {\n    try {\n      // Cache kontrol√º\n      if (categoryDetailsCache.has(categoryName)) {\n        showTooltip(categoryDetailsCache.get(categoryName), anchorElement);\n        return;\n      }\n      \n      // API'den kategori detayƒ±nƒ± al\n      const { getCategoryDetails } = await import('/assets/js/services/category-suggest.js');\n      const details = await getCategoryDetails(categoryName);\n      \n      if (details) {\n        categoryDetailsCache.set(categoryName, details);\n        showTooltip(details, anchorElement);\n      }\n    } catch (error) {\n      logger.warn('Category tooltip load failed', error);\n    }\n  }\n  \n  function showTooltip(details, anchorElement) {\n    if (!details.short_desc && (!details.examples || details.examples.length === 0)) {\n      return; // Bilgi yoksa tooltip g√∂sterme\n    }\n    \n    // Mevcut tooltip'i kaldƒ±r\n    if (tooltipElement) {\n      tooltipElement.remove();\n    }\n    \n    // Yeni tooltip olu≈ütur\n    tooltipElement = document.createElement('div');\n    tooltipElement.style.cssText = `\n      position: absolute;\n      background: #1f2937;\n      color: white;\n      padding: 12px;\n      border-radius: 8px;\n      font-size: 13px;\n      max-width: 300px;\n      z-index: 10000;\n      box-shadow: 0 4px 6px rgba(0,0,0,0.1);\n      pointer-events: none;\n    `;\n    \n    let content = `<div style=\"font-weight: 600; margin-bottom: 6px;\">${details.name}</div>`;\n    if (details.short_desc) {\n      content += `<div style=\"margin-bottom: 6px; line-height: 1.4;\">${details.short_desc}</div>`;\n    }\n    if (details.examples && details.examples.length > 0) {\n      content += `<div style=\"font-size: 11px; color: #d1d5db; margin-top: 6px;\">\n        √ñrnekler: ${details.examples.slice(0, 4).join(', ')}\n      </div>`;\n    }\n    \n    tooltipElement.innerHTML = content;\n    document.body.appendChild(tooltipElement);\n    \n    // Pozisyonlandƒ±r\n    const rect = anchorElement.getBoundingClientRect();\n    tooltipElement.style.top = `${rect.bottom + 8}px`;\n    tooltipElement.style.left = `${rect.left}px`;\n  }\n  \n  function hideTooltip() {\n    if (tooltipElement) {\n      tooltipElement.remove();\n      tooltipElement = null;\n    }\n  }\n  \n  async function showCategoryInfo(categoryName) {\n    try {\n      const { getCategoryDetails } = await import('/assets/js/services/category-suggest.js');\n      const details = await getCategoryDetails(categoryName);\n      \n      if (!details) {\n        alert(`\"${categoryName}\" kategorisi i√ßin detay bulunamadƒ±.`);\n        return;\n      }\n      \n      // Modal veya kart g√∂ster\n      let infoCard = document.getElementById('categoryInfoCard');\n      if (!infoCard) {\n        infoCard = document.createElement('div');\n        infoCard.id = 'categoryInfoCard';\n        infoCard.style.cssText = `\n          position: fixed;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%);\n          background: white;\n          padding: 24px;\n          border-radius: 12px;\n          box-shadow: 0 10px 25px rgba(0,0,0,0.2);\n          max-width: 500px;\n          z-index: 10001;\n        `;\n        document.body.appendChild(infoCard);\n      }\n      \n      let content = `<div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;\">\n        <h3 style=\"margin: 0; color: #1f2937;\">${details.name}</h3>\n        <button id=\"closeCategoryInfo\" style=\"background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;\">&times;</button>\n      </div>`;\n      \n      if (details.short_desc) {\n        content += `<div style=\"margin-bottom: 16px; color: #374151; line-height: 1.6;\">${details.short_desc}</div>`;\n      }\n      \n      if (details.examples && details.examples.length > 0) {\n        content += `<div style=\"margin-top: 16px;\">\n          <div style=\"font-weight: 600; margin-bottom: 8px; color: #1f2937;\">Bu kategoride neler var?</div>\n          <div style=\"display: flex; flex-wrap: wrap; gap: 6px;\">\n            ${details.examples.map(ex => `<span style=\"background: #e0e7ff; color: #1e40af; padding: 4px 10px; border-radius: 12px; font-size: 12px;\">${ex}</span>`).join('')}\n          </div>\n        </div>`;\n      }\n      \n      infoCard.innerHTML = content;\n      infoCard.style.display = 'block';\n      \n      // Kapat butonu\n      document.getElementById('closeCategoryInfo').addEventListener('click', () => {\n        infoCard.style.display = 'none';\n      });\n      \n      // Dƒ±≈üarƒ± tƒ±klayƒ±nca kapat\n      infoCard.addEventListener('click', (e) => {\n        if (e.target === infoCard) {\n          infoCard.style.display = 'none';\n        }\n      });\n      \n    } catch (error) {\n      logger.error('Show category info failed', error);\n      alert('Kategori bilgisi y√ºklenirken hata olu≈ütu.');\n    }\n  }\n  \n  function closeModal() {\n    modal.style.display = 'none';\n    // Reset form\n    groupNameInput.value = '';\n    nameError.style.display = 'none';\n    selectedCategories.clear();\n    showStep(1);\n  }\n  \n  function showModal(group = null) {\n    logger.info('showModal called with group', group);\n    \n    if (group) {\n      // Edit mode\n      groupNameInput.value = group.name;\n      selectedCategories = new Set(group.categories || []);\n      showStep(2);\n    } else {\n      // Create mode\n      groupNameInput.value = '';\n      selectedCategories.clear();\n      showStep(1);\n    }\n    \n    modal.style.display = 'block';\n    logger.info('Modal displayed');\n  }\n  \n  // Public API\n  return {\n    showModal,\n    showEditModal: (group) => showModal(group)\n  };\n}\n\n// Initialize modal\nconst categoryGroupsModal = initCategoryGroupsModal();\n\n// Export for use in other files\nwindow.categoryGroupsModal = categoryGroupsModal;\n\nlogger.info('Category groups modal initialized');","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\ui\\company-selector.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'orderBy' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":10}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Company Selector UI Component\r\n * Handles company selection and switching functionality\r\n */\r\n\r\nimport { db, auth } from '../firebase.js';\r\nimport {\r\n  collection,\r\n  query,\r\n  where,\r\n  orderBy,\r\n  getDocs,\r\n  doc,\r\n  getDoc\r\n} from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';\r\n\r\n/**\r\n * Company Selector Class\r\n */\r\nexport class CompanySelector {\r\n  constructor(containerSelector, options = {}) {\r\n    this.container = document.querySelector(containerSelector);\r\n    this.options = {\r\n      showLabel: true,\r\n      showUserInfo: true,\r\n      onCompanyChange: null,\r\n      ...options\r\n    };\r\n    this.companies = [];\r\n    this.currentCompany = null;\r\n    this.user = null;\r\n    this.init();\r\n  }\r\n\r\n  /**\r\n   * Initialize the company selector\r\n   */\r\n  async init() {\r\n    if (!this.container) {\r\n      logger.warn('Company selector container not found', { containerSelector: this.containerSelector });\r\n      return;\r\n    }\r\n\r\n    this.user = auth.currentUser;\r\n    if (!this.user) {\r\n      logger.warn('User not authenticated');\r\n      return;\r\n    }\r\n\r\n    await this.loadCompanies();\r\n    this.render();\r\n    this.bindEvents();\r\n  }\r\n\r\n  /**\r\n   * Load user's companies\r\n   */\r\n  async loadCompanies() {\r\n    try {\r\n      // Get user's profile to find company memberships\r\n      const userDoc = await getDoc(doc(db, 'users', this.user.uid));\r\n      const userData = userDoc.data();\r\n      \r\n      if (!userData) {\r\n        logger.warn('User data not found');\r\n        return;\r\n      }\r\n\r\n      // Get user's company memberships\r\n      const membershipsQuery = query(\r\n        collection(db, 'companies'),\r\n        where('memberships', 'array-contains', this.user.uid)\r\n      );\r\n      \r\n      const membershipsSnap = await getDocs(membershipsQuery);\r\n      const memberCompanies = membershipsSnap.docs.map(doc => ({\r\n        id: doc.id,\r\n        ...doc.data()\r\n      }));\r\n\r\n      // Get companies owned by user\r\n      const ownedQuery = query(\r\n        collection(db, 'companies'),\r\n        where('ownerId', '==', this.user.uid)\r\n      );\r\n      \r\n      const ownedSnap = await getDocs(ownedQuery);\r\n      const ownedCompanies = ownedSnap.docs.map(doc => ({\r\n        id: doc.id,\r\n        ...doc.data()\r\n      }));\r\n\r\n      // Combine and deduplicate companies\r\n      const allCompanies = [...memberCompanies, ...ownedCompanies];\r\n      this.companies = allCompanies.filter((company, index, self) => \r\n        index === self.findIndex(c => c.id === company.id)\r\n      );\r\n\r\n      // Set current company (from user profile or first company)\r\n      this.currentCompany = userData.companyId ? \r\n        this.companies.find(c => c.id === userData.companyId) : \r\n        this.companies[0] || null;\r\n\r\n    } catch (error) {\r\n      logger.error('Error loading companies', error);\r\n      this.companies = [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Render the company selector\r\n   */\r\n  render() {\r\n    if (this.companies.length === 0) {\r\n      this.container.innerHTML = `\r\n        <div class=\"company-selector-empty\">\r\n          <span class=\"company-label\">≈ûirket:</span>\r\n          <span class=\"company-name\">≈ûirket bulunamadƒ±</span>\r\n        </div>\r\n      `;\r\n      return;\r\n    }\r\n\r\n    const currentCompanyName = this.currentCompany?.name || '≈ûirket Se√ßin';\r\n    const currentCompanyId = this.currentCompany?.id || '';\r\n\r\n    this.container.innerHTML = `\r\n      <div class=\"company-selector\">\r\n        ${this.options.showLabel ? '<span class=\"company-label\">≈ûirket:</span>' : ''}\r\n        <div class=\"company-dropdown\">\r\n          <button class=\"company-button\" type=\"button\" aria-haspopup=\"true\" aria-expanded=\"false\">\r\n            <span class=\"company-name\">${currentCompanyName}</span>\r\n            <span class=\"company-arrow\">‚ñº</span>\r\n          </button>\r\n          <div class=\"company-menu\" role=\"menu\">\r\n            ${this.companies.map(company => `\r\n              <div class=\"company-option ${company.id === currentCompanyId ? 'active' : ''}\" \r\n                   data-company-id=\"${company.id}\" \r\n                   role=\"menuitem\">\r\n                <span class=\"company-option-name\">${company.name}</span>\r\n                <span class=\"company-option-role\">${company.ownerId === this.user.uid ? 'Sahip' : '√úye'}</span>\r\n              </div>\r\n            `).join('')}\r\n          </div>\r\n        </div>\r\n        ${this.options.showUserInfo ? `\r\n          <div class=\"user-info\">\r\n            <span class=\"user-name\">${this.user.displayName || this.user.email}</span>\r\n          </div>\r\n        ` : ''}\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Bind event listeners\r\n   */\r\n  bindEvents() {\r\n    const button = this.container.querySelector('.company-button');\r\n    const menu = this.container.querySelector('.company-menu');\r\n    const options = this.container.querySelectorAll('.company-option');\r\n\r\n    if (!button || !menu) return;\r\n\r\n    // Toggle dropdown\r\n    button.addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      const isExpanded = button.getAttribute('aria-expanded') === 'true';\r\n      button.setAttribute('aria-expanded', !isExpanded);\r\n      menu.classList.toggle('show', !isExpanded);\r\n    });\r\n\r\n    // Handle option selection\r\n    options.forEach(option => {\r\n      option.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n        const companyId = option.dataset.companyId;\r\n        this.selectCompany(companyId);\r\n        this.closeDropdown();\r\n      });\r\n    });\r\n\r\n    // Close dropdown when clicking outside\r\n    document.addEventListener('click', (e) => {\r\n      if (!this.container.contains(e.target)) {\r\n        this.closeDropdown();\r\n      }\r\n    });\r\n\r\n    // Handle keyboard navigation\r\n    button.addEventListener('keydown', (e) => {\r\n      if (e.key === 'Enter' || e.key === ' ') {\r\n        e.preventDefault();\r\n        button.click();\r\n      } else if (e.key === 'Escape') {\r\n        this.closeDropdown();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Select a company\r\n   * @param {string} companyId - Company ID\r\n   */\r\n  async selectCompany(companyId) {\r\n    const company = this.companies.find(c => c.id === companyId);\r\n    if (!company) {\r\n      logger.warn('Company not found', { companyId });\r\n      return;\r\n    }\r\n\r\n    this.currentCompany = company;\r\n    \r\n    // Update UI\r\n    const companyName = this.container.querySelector('.company-name');\r\n    if (companyName) {\r\n      companyName.textContent = company.name;\r\n    }\r\n\r\n    // Update active option\r\n    const options = this.container.querySelectorAll('.company-option');\r\n    options.forEach(option => {\r\n      option.classList.toggle('active', option.dataset.companyId === companyId);\r\n    });\r\n\r\n    // Call change handler\r\n    if (this.options.onCompanyChange) {\r\n      this.options.onCompanyChange(company);\r\n    }\r\n\r\n    // Dispatch custom event\r\n    const event = new CustomEvent('companyChanged', {\r\n      detail: { company, companyId }\r\n    });\r\n    this.container.dispatchEvent(event);\r\n  }\r\n\r\n  /**\r\n   * Close the dropdown\r\n   */\r\n  closeDropdown() {\r\n    const button = this.container.querySelector('.company-button');\r\n    const menu = this.container.querySelector('.company-menu');\r\n    \r\n    if (button && menu) {\r\n      button.setAttribute('aria-expanded', 'false');\r\n      menu.classList.remove('show');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get current company\r\n   * @returns {Object|null} Current company object\r\n   */\r\n  getCurrentCompany() {\r\n    return this.currentCompany;\r\n  }\r\n\r\n  /**\r\n   * Get all companies\r\n   * @returns {Array} Array of company objects\r\n   */\r\n  getCompanies() {\r\n    return this.companies;\r\n  }\r\n\r\n  /**\r\n   * Refresh companies data\r\n   */\r\n  async refresh() {\r\n    await this.loadCompanies();\r\n    this.render();\r\n    this.bindEvents();\r\n  }\r\n}\r\n\r\n/**\r\n * Simple company selector for basic use cases\r\n * @param {string} containerSelector - Container selector\r\n * @param {Object} options - Options object\r\n * @returns {CompanySelector} Company selector instance\r\n */\r\nexport function initCompanySelector(containerSelector, options = {}) {\r\n  return new CompanySelector(containerSelector, options);\r\n}\r\n\r\n/**\r\n * Get company name by ID\r\n * @param {string} companyId - Company ID\r\n * @returns {Promise<string>} Company name\r\n */\r\nexport async function getCompanyName(companyId) {\r\n  try {\r\n    const docRef = doc(db, 'companies', companyId);\r\n    const docSnap = await getDoc(docRef);\r\n    \r\n    if (docSnap.exists()) {\r\n      return docSnap.data().name || 'Bilinmeyen ≈ûirket';\r\n    }\r\n    return '≈ûirket Bulunamadƒ±';\r\n  } catch (error) {\r\n    logger.error('Error getting company name', error);\r\n    return 'Hata';\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\ui\\errors.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\ui\\header.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'doc' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":221,"column":66,"nodeType":null,"messageId":"unusedVar","endLine":221,"endColumn":69},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'updateDoc' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":221,"column":71,"nodeType":null,"messageId":"unusedVar","endLine":221,"endColumn":80},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":449,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":449,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Shared Header Component\r\n * Unified header for all pages with real company name display\r\n */\r\n\r\nimport { auth } from '../../firebase.js';\r\n// Teklifbul Rule v1.0 - Structured Logging\r\nimport { logger } from '../../../src/shared/log/logger.js';\r\nimport { MESSAGES } from '../../../src/shared/constants/messages.js';\r\n\r\n// Theme management\r\nlet currentTheme = localStorage.getItem('theme') || 'light';\r\n\r\nfunction applyTheme(theme) {\r\n  document.documentElement.setAttribute('data-theme', theme);\r\n  localStorage.setItem('theme', theme);\r\n  \r\n  // Update theme toggle button text\r\n  const themeToggle = document.getElementById('themeToggle');\r\n  if (themeToggle) {\r\n    themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è A√ßƒ±k' : 'üåô Koyu';\r\n  }\r\n}\r\n\r\nfunction toggleTheme() {\r\n  currentTheme = currentTheme === 'light' ? 'dark' : 'light';\r\n  applyTheme(currentTheme);\r\n}\r\n\r\n/**\r\n * Initialize global header component\r\n * @param {Object} options - Configuration options\r\n * @param {string|Element} options.mount - Mount point selector or element\r\n * @param {string} options.activeRoute - Active route name for highlighting\r\n */\r\nexport async function initGlobalHeader({ mount = '#app-header', activeRoute = '' } = {}) {\r\n  const el = (typeof mount === 'string') ? document.querySelector(mount) : mount;\r\n  if (!el) {\r\n    logger.warn('Header mount point not found', { mount });\r\n    return;\r\n  }\r\n\r\n  el.classList.add('global-header');\r\n  el.innerHTML = `\r\n    <div class=\"header-wrap\" style=\"display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);background:var(--card-bg);\">\r\n      <nav class=\"nav-left\" style=\"display:flex;gap:20px;align-items:center;\">\r\n        <a href=\"/dashboard.html\" class=\"brand\" style=\"font-weight:600;color:var(--text);text-decoration:none;\">Teklifbul</a>\r\n        <a href=\"/dashboard.html\" class=\"nav ${activeRoute==='dashboard'?'active':''}\" style=\"color:var(--text-muted);text-decoration:none;display:flex;align-items:center;gap:6px;\">\r\n          <span style=\"font-size:16px;\">üìä</span>Dashboard\r\n        </a>\r\n        <a href=\"/demands.html\" class=\"nav ${activeRoute==='demands'?'active':''}\" style=\"color:var(--text-muted);text-decoration:none;display:flex;align-items:center;gap:6px;\">\r\n          <span style=\"font-size:16px;\">üìã</span>Talepler\r\n        </a>\r\n        <a href=\"/bids.html?tab=incoming\" class=\"nav ${activeRoute==='bids'?'active':''}\" style=\"color:var(--text-muted);text-decoration:none;display:flex;align-items:center;gap:6px;\">\r\n          <span style=\"font-size:16px;\">üí∞</span>Teklifler\r\n        </a>\r\n        <a href=\"/main-demands.html\" class=\"nav ${activeRoute==='main'?'active':''}\" style=\"color:var(--text-muted);text-decoration:none;display:flex;align-items:center;gap:6px;\">\r\n          <span style=\"font-size:16px;\">üõçÔ∏è</span>Ana Talep Ekranƒ±\r\n        </a>\r\n        <a href=\"/demand-new.html\" class=\"nav ${activeRoute==='new'?'active':''}\" style=\"color:var(--text-muted);text-decoration:none;display:flex;align-items:center;gap:6px;\">\r\n          <span style=\"font-size:16px;\">‚ûï</span>Yeni Talep\r\n        </a>\r\n        <a href=\"/settings.html\" class=\"nav ${activeRoute==='settings'?'active':''}\" style=\"color:var(--text-muted);text-decoration:none;display:flex;align-items:center;gap:6px;\">\r\n          <span style=\"font-size:16px;\">‚öôÔ∏è</span>Ayarlar\r\n        </a>\r\n        <a href=\"/inventory-index.html\" class=\"nav ${activeRoute==='inventory'?'active':''}\" style=\"color:var(--text-muted);text-decoration:none;display:flex;align-items:center;gap:6px;\">\r\n          <span style=\"font-size:16px;\">üì¶</span>Stok Takip\r\n        </a>\r\n      </nav>\r\n      <div class=\"nav-right\" style=\"display:flex;gap:12px;align-items:center;\">\r\n        <!-- Notification Icon -->\r\n        <div id=\"notificationBell\" style=\"position: relative; cursor: pointer;\">\r\n          <button id=\"notificationBtn\" style=\"background: none; border: none; font-size: 20px; cursor: pointer; padding: 4px;\">\r\n            üîî\r\n          </button>\r\n          <span id=\"notificationCount\" style=\"position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; display: flex; align-items: center; justify-content: center;\">0</span>\r\n        </div>\r\n        <!-- Theme Toggle -->\r\n        <button id=\"themeToggle\" class=\"btn btn-outline\" title=\"Tema Deƒüi≈ütir\" style=\"background:var(--surface);color:var(--text);border:1px solid var(--border);padding:6px 10px;border-radius:6px;cursor:pointer;font-size:14px;\">\r\n          ${currentTheme === 'dark' ? '‚òÄÔ∏è A√ßƒ±k' : 'üåô Koyu'}\r\n        </button>\r\n        <span style=\"color:var(--text-muted);\">≈ûirket Adƒ±:</span>\r\n        <span id=\"headerCompanyName\" style=\"font-weight:600;color:var(--text);\">Y√ºkleniyor‚Ä¶</span>\r\n        <span id=\"userEmail\" style=\"color:var(--text-muted);\"></span>\r\n        <button id=\"logoutBtn\" class=\"btn btn-danger btn-sm\">√áƒ±kƒ±≈ü</button>\r\n      </div>\r\n    </div>\r\n    \r\n    <!-- Notification Dropdown -->\r\n    <div id=\"notificationDropdown\" style=\"display: none; position: absolute; right: 20px; top: 60px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 300px; z-index: 1000;\">\r\n      <div style=\"padding: 12px; border-bottom: 1px solid #e5e7eb; font-weight: 600;\">Bildirimler</div>\r\n      <div id=\"notificationList\" style=\"max-height: 300px; overflow-y: auto;\">\r\n        <div style=\"padding: 16px; text-align: center; color: #6b7280;\">Yeni bildirim yok</div>\r\n      </div>\r\n      <div style=\"padding: 8px; border-top: 1px solid #e5e7eb; text-align: center;\">\r\n        <button id=\"closeNotifications\" style=\"background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 14px;\">Kapat</button>\r\n      </div>\r\n    </div>\r\n    \r\n    <style>\r\n      :root {\r\n        --background: #ffffff;\r\n        --text: #1f2937;\r\n        --text-muted: #6b7280;\r\n        --border: #e5e7eb;\r\n        --card-bg: #ffffff;\r\n        --surface: #f9fafb;\r\n      }\r\n      \r\n      [data-theme=\"dark\"] {\r\n        --background: #111827;\r\n        --text: #f9fafb;\r\n        --text-muted: #9ca3af;\r\n        --border: #374151;\r\n        --card-bg: #1f2937;\r\n        --surface: #111827;\r\n      }\r\n      \r\n      body {\r\n        background-color: var(--background);\r\n        color: var(--text);\r\n      }\r\n    </style>\r\n  `;\r\n\r\n  // Apply current theme\r\n  applyTheme(currentTheme);\r\n\r\n  // Fill user email\r\n  const fillEmail = () => {\r\n    const u = auth.currentUser;\r\n    const emailEl = el.querySelector('#userEmail');\r\n    if (emailEl) emailEl.textContent = u?.email || '';\r\n  };\r\n\r\n  // Cache for company name to avoid repeated queries across page loads\r\n  const COMPANY_NAME_CACHE = new Map();\r\n  \r\n  // Fill company name from user settings\r\n  const fillCompanyName = async () => {\r\n    try {\r\n      const user = auth.currentUser;\r\n      if (!user) return;\r\n      \r\n      // Check cache first\r\n      if (COMPANY_NAME_CACHE.has(user.uid)) {\r\n        const companyName = COMPANY_NAME_CACHE.get(user.uid);\r\n        const companyEl = el.querySelector('#headerCompanyName');\r\n        if (companyEl) companyEl.textContent = companyName;\r\n        return;\r\n      }\r\n      \r\n      // Hesap ayarlarƒ±ndan ≈üirket adƒ±nƒ± √ßek (profiles collection)\r\n      const collections = ['profiles', 'users', 'publicProfiles'];\r\n      let companyName = '≈ûirket Adƒ± Yok';\r\n      \r\n      // OPTIMIZED: Try all collections in parallel instead of sequential\r\n      const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js');\r\n      const { db } = await import('../firebase.js');\r\n      \r\n      const promises = collections.map(async (collection) => {\r\n        try {\r\n          const profileSnap = await getDoc(doc(db, collection, user.uid));\r\n          if (profileSnap.exists()) {\r\n            const profileData = profileSnap.data();\r\n            return profileData?.companyName || \r\n                   profileData?.company?.name || \r\n                   profileData?.displayName ||\r\n                   profileData?.name || null;\r\n          }\r\n        } catch (error) {\r\n          logger.warn(`Profile collection ${collection} okunamadƒ±`, error.message);\r\n        }\r\n        return null;\r\n      });\r\n      \r\n      const results = await Promise.all(promises);\r\n      const foundName = results.find(name => name && name.trim());\r\n      if (foundName) {\r\n        companyName = foundName.trim();\r\n      }\r\n      \r\n      // Cache the result\r\n      COMPANY_NAME_CACHE.set(user.uid, companyName);\r\n      \r\n      // Header'da g√∂ster\r\n      const companyEl = el.querySelector('#headerCompanyName');\r\n      if (companyEl) {\r\n        companyEl.textContent = companyName;\r\n        logger.info('Header ≈üirket adƒ± g√ºncellendi', { companyName });\r\n      }\r\n    } catch (error) {\r\n      logger.error('≈ûirket adƒ± y√ºklenirken hata', error);\r\n      const companyEl = el.querySelector('#headerCompanyName');\r\n      if (companyEl) companyEl.textContent = '≈ûirket Adƒ± Yok';\r\n    }\r\n  };\r\n\r\n  // Setup theme toggle\r\n  const themeToggle = el.querySelector('#themeToggle');\r\n  if (themeToggle) {\r\n    themeToggle.addEventListener('click', toggleTheme);\r\n  }\r\n\r\n  // Setup notification system - Teklifbul Rule v1.0\r\n  const notificationBtn = el.querySelector('#notificationBtn');\r\n  const notificationDropdown = el.querySelector('#notificationDropdown');\r\n  const closeNotificationsBtn = el.querySelector('#closeNotifications');\r\n  const notificationCount = el.querySelector('#notificationCount');\r\n  const notificationList = el.querySelector('#notificationList');\r\n  \r\n  // Bildirimleri y√ºkle ve g√∂ster - Teklifbul Rule v1.0\r\n  let currentUnreadCount = 0; // Global scope i√ßin unread count\r\n  \r\n  async function loadNotifications() {\r\n    try {\r\n      const user = auth.currentUser;\r\n      if (!user) return;\r\n      \r\n      // Firestore'dan bildirimleri y√ºkle\r\n      const { collection, query, where, orderBy, limit, getDocs, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js');\r\n      const { db } = await import('../../firebase.js');\r\n      \r\n      // Teklifbul Rule v1.0 - Firestore index olmadan sorgu yap (index olu≈üturulana kadar)\r\n      let snapshot;\r\n      let needsClientSort = false;\r\n      \r\n      try {\r\n        // √ñnce index'li sorguyu dene (hƒ±zlƒ±)\r\n        const indexedQuery = query(\r\n          collection(db, 'notifications'),\r\n          where('userId', '==', user.uid),\r\n          orderBy('createdAt', 'desc'),\r\n          limit(20)\r\n        );\r\n        snapshot = await getDocs(indexedQuery);\r\n      } catch (indexError) {\r\n        // Index yoksa, index gerektirmeyen sorgu yap\r\n        logger.warn('Firestore index bulunamadƒ±, index gerektirmeyen sorgu kullanƒ±lƒ±yor');\r\n        if (indexError.message.includes('index') && indexError.message.includes('create_composite')) {\r\n          const indexUrl = indexError.message.match(/https:\\/\\/[^\\s]+/)?.[0];\r\n          if (indexUrl) {\r\n            logger.info('Index olu≈üturmak i√ßin', { indexUrl });\r\n          }\r\n        }\r\n        \r\n        // Index gerektirmeyen sorgu: sadece userId filtresi\r\n        const simpleQuery = query(\r\n          collection(db, 'notifications'),\r\n          where('userId', '==', user.uid),\r\n          limit(50) // Daha fazla al, client-side sƒ±ralama yapacaƒüƒ±z\r\n        );\r\n        snapshot = await getDocs(simpleQuery);\r\n        needsClientSort = true;\r\n      }\r\n      \r\n      const notifications = [];\r\n      currentUnreadCount = 0;\r\n      \r\n      snapshot.forEach(docSnap => {\r\n        const data = docSnap.data();\r\n        notifications.push({\r\n          id: docSnap.id,\r\n          ...data,\r\n          createdAt: data.createdAt?.toDate?.() || (data.createdAt?.seconds ? new Date(data.createdAt.seconds * 1000) : new Date())\r\n        });\r\n        if (!data.read) currentUnreadCount++;\r\n      });\r\n      \r\n      // Client-side sƒ±ralama (eƒüer orderBy kullanƒ±lamadƒ±ysa)\r\n      if (needsClientSort) {\r\n        notifications.sort((a, b) => {\r\n          const timeA = a.createdAt?.getTime?.() || 0;\r\n          const timeB = b.createdAt?.getTime?.() || 0;\r\n          return timeB - timeA; // Yeni √∂nce\r\n        });\r\n      }\r\n      \r\n      // En son 20'yi al\r\n      const limitedNotifications = notifications.slice(0, 20);\r\n      \r\n      // Bildirim sayƒ±sƒ±nƒ± g√ºncelle\r\n      if (notificationCount) {\r\n        notificationCount.textContent = currentUnreadCount > 0 ? currentUnreadCount : '';\r\n        notificationCount.style.display = currentUnreadCount > 0 ? 'flex' : 'none';\r\n      }\r\n      \r\n      // Bildirim listesini g√∂ster\r\n      if (notificationList) {\r\n        if (limitedNotifications.length === 0) {\r\n          notificationList.innerHTML = '<div style=\"padding: 16px; text-align: center; color: #6b7280;\">Yeni bildirim yok</div>';\r\n        } else {\r\n          notificationList.innerHTML = limitedNotifications.map(notif => {\r\n            const timeAgo = getTimeAgo(notif.createdAt);\r\n            const readClass = notif.read ? '' : 'style=\"background: #f0f9ff; border-left: 3px solid #3b82f6;\"';\r\n            return `\r\n              <div ${readClass} style=\"padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer;\" data-id=\"${notif.id}\" data-read=\"${notif.read || false}\">\r\n                <div style=\"font-weight: 600; margin-bottom: 4px; color: #1f2937;\">${notif.title || 'Bildirim'}</div>\r\n                <div style=\"font-size: 13px; color: #6b7280; margin-bottom: 4px;\">${notif.body || notif.message || ''}</div>\r\n                <div style=\"font-size: 11px; color: #9ca3af;\">${timeAgo}</div>\r\n              </div>\r\n            `;\r\n          }).join('');\r\n          \r\n          // Bildirim tƒ±klama event'leri - Teklifbul Rule v1.0\r\n          notificationList.querySelectorAll('[data-id]').forEach(item => {\r\n            item.addEventListener('click', async () => {\r\n              const notifId = item.getAttribute('data-id');\r\n              const isRead = item.getAttribute('data-read') === 'true';\r\n              \r\n              if (!isRead) {\r\n                // Okundu olarak i≈üaretle\r\n                try {\r\n                  const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js');\r\n                  const { db } = await import('../../firebase.js');\r\n                  await updateDoc(doc(db, 'notifications', notifId), { read: true, readAt: new Date() });\r\n                  item.setAttribute('data-read', 'true');\r\n                  item.style.background = '';\r\n                  item.style.borderLeft = '';\r\n                  currentUnreadCount--;\r\n                  if (notificationCount) {\r\n                    notificationCount.textContent = currentUnreadCount > 0 ? currentUnreadCount : '';\r\n                    notificationCount.style.display = currentUnreadCount > 0 ? 'flex' : 'none';\r\n                  }\r\n                } catch (err) {\r\n                  logger.error('Bildirim okundu i≈üaretleme hatasƒ±', err);\r\n                }\r\n              }\r\n              \r\n              // Bildirim tipine g√∂re y√∂nlendir\r\n              const notif = limitedNotifications.find(n => n.id === notifId);\r\n              if (notif?.data?.demandId) {\r\n                window.location.href = `/demand-detail.html?id=${notif.data.demandId}`;\r\n              } else if (notif?.data?.bidId) {\r\n                window.location.href = `/bids.html?tab=incoming`;\r\n              } else if (notif?.data?.rfqId) {\r\n                window.location.href = `/bids.html?tab=incoming`;\r\n              }\r\n            });\r\n          });\r\n        }\r\n      }\r\n      \r\n    } catch (error) {\r\n      logger.error('Bildirimler y√ºklenemedi', error);\r\n      if (notificationList) {\r\n        notificationList.innerHTML = '<div style=\"padding: 16px; text-align: center; color: #ef4444;\">Bildirimler y√ºklenemedi</div>';\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Zaman g√∂sterimi helper\r\n  function getTimeAgo(date) {\r\n    if (!date) return '';\r\n    const now = new Date();\r\n    const diff = now - date;\r\n    const seconds = Math.floor(diff / 1000);\r\n    const minutes = Math.floor(seconds / 60);\r\n    const hours = Math.floor(minutes / 60);\r\n    const days = Math.floor(hours / 24);\r\n    \r\n    if (days > 7) return date.toLocaleDateString('tr-TR');\r\n    if (days > 0) return `${days} g√ºn √∂nce`;\r\n    if (hours > 0) return `${hours} saat √∂nce`;\r\n    if (minutes > 0) return `${minutes} dakika √∂nce`;\r\n    return 'Az √∂nce';\r\n  }\r\n  \r\n  if (notificationBtn && notificationDropdown) {\r\n    notificationBtn.addEventListener('click', async (e) => {\r\n      e.stopPropagation();\r\n      const isOpen = notificationDropdown.style.display === 'block';\r\n      notificationDropdown.style.display = isOpen ? 'none' : 'block';\r\n      \r\n      // Dropdown a√ßƒ±ldƒ±ƒüƒ±nda bildirimleri y√ºkle\r\n      if (!isOpen) {\r\n        await loadNotifications();\r\n      }\r\n    });\r\n    \r\n    closeNotificationsBtn.addEventListener('click', () => {\r\n      notificationDropdown.style.display = 'none';\r\n    });\r\n    \r\n    // Close dropdown when clicking outside\r\n    document.addEventListener('click', (e) => {\r\n      if (!notificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {\r\n        notificationDropdown.style.display = 'none';\r\n      }\r\n    });\r\n    \r\n    // Kullanƒ±cƒ± giri≈ü yaptƒ±ƒüƒ±nda bildirimleri y√ºkle\r\n    if (auth.currentUser) {\r\n      loadNotifications();\r\n      // Her 30 saniyede bir g√ºncelle\r\n      setInterval(loadNotifications, 30000);\r\n    } else {\r\n      auth.onAuthStateChanged((user) => {\r\n        if (user) {\r\n          loadNotifications();\r\n          setInterval(loadNotifications, 30000);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  // Setup logout button - Teklifbul Rule v1.0\r\n  const logoutBtn = el.querySelector('#logoutBtn');\r\n  if (logoutBtn) {\r\n    logoutBtn.addEventListener('click', async () => {\r\n      // Teklifbul Rule v1.0 - Logout akƒ±≈üƒ± (toast + logger ile)\r\n      const { logger } = await import('../../../src/shared/log/logger.js');\r\n      const { toast } = await import('../../../src/shared/ui/toast.js');\r\n      const { signOut } = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js');\r\n      \r\n      logger.group(\"Logout\");\r\n      try {\r\n        await signOut(auth);\r\n        toast.info(MESSAGES.INFO_SESSION_CLOSED);\r\n        logger.info(\"Oturum kapatƒ±ldƒ±\");\r\n        // onAuthStateChanged login'e y√∂nlendirir\r\n      } catch (err) {\r\n        logger.error(\"√áƒ±kƒ±≈ü hatasƒ±\", err);\r\n        toast.error(MESSAGES.ERROR_LOGOUT);\r\n      } finally {\r\n        logger.end();\r\n      }\r\n    });\r\n  }\r\n\r\n  // Initialize on auth ready\r\n  if (auth.currentUser) {\r\n    fillEmail();\r\n    await fillCompanyName();\r\n  } else {\r\n    // Optimized auth listener - cleanup immediately after first check\r\n    const unsub = auth.onAuthStateChanged(async (user) => {\r\n      if (user) {\r\n        fillEmail();\r\n        await fillCompanyName();\r\n        unsub(); // Cleanup immediately - no need to keep listening\r\n      }\r\n    });\r\n    \r\n    // Safety cleanup after 5 seconds (in case user is already logged in)\r\n    setTimeout(() => {\r\n      try {\r\n        unsub();\r\n      } catch (e) {\r\n        // Ignore - might already be unsubscribed\r\n      }\r\n    }, 5000);\r\n  }\r\n\r\n  logger.info('Global header initialized', { route: activeRoute });\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\ui\\rfq-bid-form.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'updateRFQBid' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":24,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":36}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// RFQ Bid Form UI Component\nimport { createRFQBid, updateRFQBid, validateBidData, calculateBidTotal } from '../services/rfq-bids.js';\n// Teklifbul Rule v1.0 - Structured Logging\nimport { logger } from '../../../src/shared/log/logger.js';\n\nexport class RFQBidForm {\n  constructor(containerId, demandData, itemsData) {\n    this.container = document.getElementById(containerId);\n    this.demandData = demandData;\n    this.itemsData = itemsData;\n    this.bidData = {\n      demandId: demandData.id,\n      currency: 'TRY',\n      validityDays: 30,\n      incoterm: 'DAP',\n      warrantyMonths: 12,\n      paymentPlan: '30-days',\n      deliveryAddress: '',\n      notes: '',\n      items: []\n    };\n    this.attachments = [];\n    \n    this.init();\n  }\n\n  init() {\n    this.render();\n    this.bindEvents();\n    this.loadDeliveryAddress();\n  }\n\n  render() {\n    this.container.innerHTML = `\n      <div class=\"rfq-bid-form\">\n        <!-- Commercial Terms Panel -->\n        <div class=\"commercial-terms-panel\">\n          <h4>üíº Genel Ticari ≈ûartlar</h4>\n          <div class=\"terms-grid\">\n            <div class=\"form-group\">\n              <label for=\"bid-currency\">Para Birimi *</label>\n              <select id=\"bid-currency\" required>\n                <option value=\"TRY\">T√ºrk Lirasƒ± (‚Ç∫)</option>\n                <option value=\"USD\">Amerikan Dolarƒ± ($)</option>\n                <option value=\"EUR\">Euro (‚Ç¨)</option>\n                <option value=\"GBP\">ƒ∞ngiliz Sterlini (¬£)</option>\n              </select>\n            </div>\n            \n            <div class=\"form-group\">\n              <label for=\"bid-validity\">Ge√ßerlilik S√ºresi (G√ºn) *</label>\n              <input type=\"number\" id=\"bid-validity\" min=\"1\" max=\"365\" value=\"30\" required>\n            </div>\n            \n            <div class=\"form-group\">\n              <label for=\"bid-incoterm\">Teslim ≈ûekli *</label>\n              <select id=\"bid-incoterm\" required>\n                <option value=\"EXW\">EXW - Fabrikadan Teslim</option>\n                <option value=\"FCA\">FCA - Ta≈üƒ±yƒ±cƒ±ya Teslim</option>\n                <option value=\"CPT\">CPT - Navlun √ñdenmi≈ü Teslim</option>\n                <option value=\"CIP\">CIP - Navlun ve Sigorta √ñdenmi≈ü Teslim</option>\n                <option value=\"DAP\" selected>DAP - Teslim Yerinde Teslim</option>\n                <option value=\"DPU\">DPU - Teslim Yerinde Bo≈üaltƒ±lmƒ±≈ü Teslim</option>\n                <option value=\"DDP\">DDP - G√ºmr√ºk Vergileri Dahil Teslim</option>\n                <option value=\"FOB\">FOB - Gemi √úzerinde Teslim</option>\n                <option value=\"CIF\">CIF - Maliyet, Sigorta ve Navlun</option>\n                <option value=\"DAP-≈ûantiye\">DAP - ≈ûantiye Teslim</option>\n                <option value=\"Depo-Teslim\">Depo Teslim</option>\n                <option value=\"Liman-Teslim\">Liman Teslim</option>\n              </select>\n            </div>\n            \n            <div class=\"form-group\">\n              <label for=\"bid-warranty\">Garanti S√ºresi (Ay)</label>\n              <input type=\"number\" id=\"bid-warranty\" min=\"0\" max=\"60\" value=\"12\">\n            </div>\n            \n            <div class=\"form-group\">\n              <label for=\"bid-payment\">√ñdeme Planƒ±</label>\n              <select id=\"bid-payment\" onchange=\"togglePaymentCustom()\">\n                <option value=\"advance\">Pe≈üin</option>\n                <option value=\"30-days\" selected>30 G√ºn Vadeli</option>\n                <option value=\"60-days\">60 G√ºn Vadeli</option>\n                <option value=\"90-days\">90 G√ºn Vadeli</option>\n                <option value=\"custom\">√ñzel Plan</option>\n              </select>\n              <input type=\"text\" id=\"bid-payment-custom\" placeholder=\"√ñzel √∂deme planƒ±nƒ±zƒ± yazƒ±n...\" style=\"display: none; margin-top: 8px;\">\n            </div>\n            \n            <div class=\"form-group full-width\">\n              <label for=\"bid-delivery\">Teslimat Adresi *</label>\n              <textarea id=\"bid-delivery\" rows=\"2\" required placeholder=\"Teslimat adresini giriniz...\"></textarea>\n            </div>\n            \n            <div class=\"form-group full-width\">\n              <label for=\"bid-notes\">Genel Notlar</label>\n              <textarea id=\"bid-notes\" rows=\"3\" placeholder=\"Teklifinizle ilgili √∂zel ≈üartlar, a√ßƒ±klamalar...\"></textarea>\n            </div>\n          </div>\n        </div>\n        \n        <!-- Item Matrix -->\n        <div class=\"item-matrix-section\">\n          <h4>üìä √úr√ºn Kalemleri Teklifi</h4>\n          <div class=\"item-matrix-container\">\n            ${this.renderItemMatrix()}\n          </div>\n        </div>\n        \n        <!-- Attachments -->\n        <div class=\"bid-attachments\">\n          <h4>üìé Ekler</h4>\n          <div id=\"bid-file-list\" class=\"file-list\"></div>\n          <input type=\"file\" id=\"bid-file-input\" multiple accept=\".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png\">\n          <button id=\"bid-upload-btn\" class=\"btn btn-primary\">üìé Dosya Ekle</button>\n        </div>\n        \n        <!-- Submit Button -->\n        <div class=\"submit-section\">\n          <button id=\"submit-bid-btn\" class=\"btn btn-success\">üì§ Teklifi G√∂nder</button>\n        </div>\n      </div>\n    `;\n  }\n\n  renderItemMatrix() {\n    if (!this.itemsData || this.itemsData.length === 0) {\n      return '<p class=\"no-items\">Bu talep i√ßin √ºr√ºn bilgisi bulunamadƒ±.</p>';\n    }\n\n    return `\n      <div class=\"item-matrix-table\">\n        <div class=\"matrix-header\">\n          <div class=\"col-item\">Talep Edilen √úr√ºn</div>\n          <div class=\"col-qty\">Miktar</div>\n          <div class=\"col-unit\">Birim</div>\n          <div class=\"col-compliance\">Uygunluk</div>\n          <div class=\"col-price\">Birim Fiyat (Net)</div>\n          <div class=\"col-total\">Toplam (TL)</div>\n          <div class=\"col-brand\">Marka/Model</div>\n          <div class=\"col-leadtime\">Teslim S√ºresi</div>\n          <div class=\"col-minqty\">Min. Sipari≈ü</div>\n          <div class=\"col-partial\">Kƒ±smi ƒ∞zin</div>\n          <div class=\"col-origin\">Men≈üei</div>\n          <div class=\"col-comments\">A√ßƒ±klama</div>\n        </div>\n        ${this.itemsData.map((item, index) => this.renderItemRow(item, index)).join('')}\n      </div>\n    `;\n  }\n\n  renderItemRow(item, index) {\n    const demandQty = item.quantity || item.qty || 1;\n    const demandUnit = item.unit || item.uom || 'adet';\n    // All available units from demand-new.html unitList\n    const allUnits = [\n      'adet', 'paket', 'kutu', 'koli', 'set', '√ßift', 'par√ßa', 'takƒ±m', '√ßar≈üaf', 'd√ºzine', 'gros',\n      'kg', 'g', 'ton',\n      'metre', 'm', 'cm', 'mm',\n      'metrekare', 'm¬≤', 'metrekup', 'm¬≥',\n      'litre', 'lt', 'ml',\n      'rulo', 'sac', 'tabaka', 'sheet', 'kangal', 'varil', 'kova', 'bidon', 'kase', 'torba', 'palet', 'rol', 'top', 'yumak', 'diƒüer'\n    ];\n    \n    return `\n      <div class=\"matrix-row\" data-item-index=\"${index}\">\n        <div class=\"col-item\">\n          <div class=\"item-info\">\n            <div class=\"item-name\" style=\"font-size:13px; font-weight:600; color:#111827;\">${item.description || item.name || '√úr√ºn A√ßƒ±klamasƒ±'}</div>\n            <div class=\"item-sku\" style=\"font-size:11px; color:#64748b;\">${item.sku || '-'}</div>\n            <div class=\"item-alt\" style=\"margin-top:6px;\">\n              <input type=\"text\" class=\"item-alt-desc\" placeholder=\"Teklif edilen alternatif tanƒ±m (opsiyonel)\" style=\"width:100%; font-size:12px;\">\n            </div>\n          </div>\n        </div>\n        <div class=\"col-qty\">\n          <input type=\"number\" class=\"item-qty\" value=\"${demandQty}\" min=\"0\" step=\"0.01\">\n        </div>\n        <div class=\"col-unit\">\n          <select class=\"item-unit\" data-item-index=\"${index}\">\n            ${demandUnit && !allUnits.includes(demandUnit.toLowerCase()) ? `<option value=\"${demandUnit}\" selected>${demandUnit.charAt(0).toUpperCase() + demandUnit.slice(1)} (Talep)</option>` : ''}\n            ${allUnits.map(u => `<option value=\"${u}\" ${demandUnit && demandUnit.toLowerCase() === u.toLowerCase() ? 'selected' : ''}>${u.charAt(0).toUpperCase() + u.slice(1)}</option>`).join('')}\n          </select>\n          ${demandUnit ? `<div style=\"font-size:11px;color:#059669;margin-top:2px;\">Talep: ${demandUnit}</div>` : ''}\n        </div>\n        <div class=\"col-compliance\">\n          <select class=\"item-compliance\" required>\n            <option value=\"\">Se√ßiniz</option>\n            <option value=\"match\">‚úÖ Uygun</option>\n            <option value=\"alt\">üîÑ Alternatif</option>\n            <option value=\"no-bid\">‚ùå Teklif Yok</option>\n          </select>\n        </div>\n        <div class=\"col-price\">\n          <input type=\"number\" class=\"item-price\" min=\"0\" step=\"0.01\" placeholder=\"0.00\">\n        </div>\n        <div class=\"col-total\">\n          <span class=\"item-total\">0,00</span>\n        </div>\n        <div class=\"col-brand\">\n          <input type=\"text\" class=\"item-brand\" placeholder=\"Marka/Model\">\n        </div>\n        <div class=\"col-leadtime\">\n          <input type=\"number\" class=\"item-leadtime\" min=\"1\" max=\"365\" placeholder=\"G√ºn\">\n        </div>\n        <div class=\"col-minqty\">\n          <input type=\"number\" class=\"item-minqty\" min=\"0\" step=\"0.01\" placeholder=\"Min. miktar\">\n        </div>\n        <div class=\"col-partial\">\n          <select class=\"item-partial\">\n            <option value=\"yes\">Evet</option>\n            <option value=\"no\" selected>Hayƒ±r</option>\n          </select>\n        </div>\n        <div class=\"col-origin\">\n          <input type=\"text\" class=\"item-origin\" placeholder=\"Men≈üei\">\n        </div>\n        <div class=\"col-comments\">\n          <textarea class=\"item-comments\" rows=\"3\" placeholder=\"√úr√ºn hakkƒ±nda detaylƒ± a√ßƒ±klama...\"></textarea>\n        </div>\n      </div>\n    `;\n  }\n\n  bindEvents() {\n    // Commercial terms change\n    this.container.addEventListener('change', (e) => {\n      if (e.target.id.startsWith('bid-')) {\n        this.updateCommercialTerms();\n      }\n    });\n\n    // Payment plan custom toggle\n    window.togglePaymentCustom = () => {\n      const paymentSelect = this.container.querySelector('#bid-payment');\n      const customInput = this.container.querySelector('#bid-payment-custom');\n      \n      if (paymentSelect.value === 'custom') {\n        customInput.style.display = 'block';\n        customInput.required = true;\n      } else {\n        customInput.style.display = 'none';\n        customInput.required = false;\n        customInput.value = '';\n      }\n    };\n\n    // Item matrix changes\n    this.container.addEventListener('input', (e) => {\n      const cls = e.target.classList;\n      if (\n        cls.contains('item-qty') ||\n        cls.contains('item-price') ||\n        cls.contains('item-compliance') ||\n        cls.contains('item-brand') ||\n        cls.contains('item-leadtime') ||\n        cls.contains('item-minqty') ||\n        cls.contains('item-partial') ||\n        cls.contains('item-origin') ||\n        cls.contains('item-comments') ||\n        cls.contains('item-alt-desc')\n      ) {\n        if (cls.contains('item-qty') || cls.contains('item-price')) this.updateRowTotal(e.target.closest('.matrix-row'));\n        this.updateItemData();\n      }\n    });\n\n    // File upload\n    const fileInput = this.container.querySelector('#bid-file-input');\n    const uploadBtn = this.container.querySelector('#bid-upload-btn');\n    \n    uploadBtn.addEventListener('click', () => {\n      fileInput.click();\n    });\n    \n    fileInput.addEventListener('change', (e) => {\n      this.handleFileUpload(e.target.files);\n    });\n\n    // Submit bid\n    const submitBtn = this.container.querySelector('#submit-bid-btn');\n    submitBtn.addEventListener('click', () => {\n      this.submitBid();\n    });\n  }\n\n  updateCommercialTerms() {\n    this.bidData.currency = this.container.querySelector('#bid-currency').value;\n    this.bidData.validityDays = parseInt(this.container.querySelector('#bid-validity').value);\n    this.bidData.incoterm = this.container.querySelector('#bid-incoterm').value;\n    this.bidData.warrantyMonths = parseInt(this.container.querySelector('#bid-warranty').value);\n    this.bidData.paymentPlan = this.container.querySelector('#bid-payment').value;\n    this.bidData.deliveryAddress = this.container.querySelector('#bid-delivery').value;\n    this.bidData.notes = this.container.querySelector('#bid-notes').value;\n  }\n\n  updateItemData() {\n    this.bidData.items = [];\n    \n    const rows = this.container.querySelectorAll('.matrix-row');\n    rows.forEach((row, index) => {\n      const qty = parseFloat(row.querySelector('.item-qty').value) || 0;\n      const compliance = row.querySelector('.item-compliance').value;\n      const price = parseFloat(row.querySelector('.item-price').value) || 0;\n      const unit = row.querySelector('.item-unit').value || '';\n      const brand = row.querySelector('.item-brand').value;\n      const leadTime = parseInt(row.querySelector('.item-leadtime').value) || 0;\n      const minQty = parseFloat(row.querySelector('.item-minqty').value) || 0;\n      const partialAllowed = row.querySelector('.item-partial').value === 'yes';\n      const origin = row.querySelector('.item-origin').value;\n      const comments = row.querySelector('.item-comments').value;\n      const altDesc = row.querySelector('.item-alt-desc')?.value || '';\n      const totalPrice = qty * price;\n      \n      this.bidData.items.push({\n        demandItemId: this.itemsData[index].id || `item_${index}`,\n        compliance: compliance,\n        quantity: qty,\n        unit: unit,\n        unitPrice: price,\n        totalPrice: totalPrice,\n        netPrice: compliance === 'match' ? price : null,\n        brand: brand,\n        model: brand, // Same as brand for now\n        leadTimeDays: leadTime,\n        minOrderQty: minQty,\n        partialAllowed: partialAllowed,\n        origin: origin,\n        comments: comments,\n        offeredDescription: altDesc\n      });\n    });\n  }\n\n  updateRowTotal(rowEl) {\n    if (!rowEl) return;\n    const qty = parseFloat(rowEl.querySelector('.item-qty')?.value || '0') || 0;\n    const price = parseFloat(rowEl.querySelector('.item-price')?.value || '0') || 0;\n    const totalEl = rowEl.querySelector('.item-total');\n    if (totalEl) {\n      const total = qty * price;\n      totalEl.textContent = new Intl.NumberFormat('tr-TR', { maximumFractionDigits: 2 }).format(total);\n    }\n  }\n\n  loadDeliveryAddress() {\n    // Pre-fill delivery address from demand if available\n    if (this.demandData.deliveryAddress) {\n      this.container.querySelector('#bid-delivery').value = this.demandData.deliveryAddress;\n      this.bidData.deliveryAddress = this.demandData.deliveryAddress;\n    }\n  }\n\n  handleFileUpload(files) {\n    Array.from(files).forEach(file => {\n      this.attachments.push({\n        name: file.name,\n        size: file.size,\n        type: file.type,\n        file: file\n      });\n    });\n    \n    this.updateFileList();\n  }\n\n  updateFileList() {\n    const fileList = this.container.querySelector('#bid-file-list');\n    fileList.innerHTML = this.attachments.map((file, index) => `\n      <div class=\"file-item\">\n        <span class=\"file-name\">${file.name}</span>\n        <span class=\"file-size\">(${(file.size / 1024).toFixed(1)} KB)</span>\n        <button class=\"remove-file\" data-index=\"${index}\">‚ùå</button>\n      </div>\n    `).join('');\n    \n    // Bind remove file events\n    fileList.querySelectorAll('.remove-file').forEach(btn => {\n      btn.addEventListener('click', (e) => {\n        const index = parseInt(e.target.dataset.index);\n        this.attachments.splice(index, 1);\n        this.updateFileList();\n      });\n    });\n  }\n\n  async submitBid() {\n    try {\n      // Update data\n      this.updateCommercialTerms();\n      this.updateItemData();\n      // Auto-detect differences vs demand and append to notes\n      const diffs = [];\n      this.itemsData.forEach((dItem, i) => {\n        const bItem = this.bidData.items[i] || {};\n        const dQty = parseFloat(dItem.quantity || dItem.qty || 0) || 0;\n        const dUnit = dItem.unit || dItem.uom || '';\n        const dDesc = dItem.description || dItem.name || '';\n        if (bItem.quantity != null && (Number(bItem.quantity) !== Number(dQty))) {\n          diffs.push(`Kalem ${i+1}: Miktar deƒüi≈üikliƒüi ‚Äì talep ${dQty} ${dUnit || ''}, teklif ${bItem.quantity} ${bItem.unit || ''}`);\n        }\n        if ((bItem.unit || '') && dUnit && (String(bItem.unit).toLowerCase() !== String(dUnit).toLowerCase())) {\n          diffs.push(`Kalem ${i+1}: Birim deƒüi≈üikliƒüi ‚Äì talep ${dUnit}, teklif ${bItem.unit}`);\n        }\n        if ((bItem.offeredDescription || '').trim() && (bItem.offeredDescription || '').trim() !== (dDesc || '').trim()) {\n          diffs.push(`Kalem ${i+1}: Tanƒ±m farklƒ± ‚Äì talep \"${dDesc}\", teklif \"${bItem.offeredDescription}\"`);\n        }\n        if ((bItem.brand || '').trim()) {\n          const dBrand = dItem.brand || dItem.model || '';\n          if (dBrand && (bItem.brand.trim().toLowerCase() !== String(dBrand).trim().toLowerCase())) {\n            diffs.push(`Kalem ${i+1}: Marka/Model farklƒ± ‚Äì talep \"${dBrand}\", teklif \"${bItem.brand}\"`);\n          } else if (!dBrand) {\n            diffs.push(`Kalem ${i+1}: Marka/Model ‚Äì \"${bItem.brand}\"`);\n          }\n        }\n      });\n      if (diffs.length) {\n        const sysNote = `Sistem Notu ‚Äì Tespit edilen farklar:\\n- ${diffs.join('\\n- ')}`;\n        const notesNow = (this.container.querySelector('#bid-notes').value || '').trim();\n        const combined = notesNow ? `${notesNow}\\n\\n${sysNote}` : sysNote;\n        this.container.querySelector('#bid-notes').value = combined;\n        this.bidData.notes = combined;\n      }\n      \n      // Validate\n      const validation = validateBidData(this.bidData);\n      if (!validation.isValid) {\n        alert('L√ºtfen a≈üaƒüƒ±daki hatalarƒ± d√ºzeltin:\\n' + validation.errors.join('\\n'));\n        return;\n      }\n      \n      // Calculate total\n      const total = calculateBidTotal(this.bidData.items, this.bidData.currency);\n      \n      // Confirm submission\n      const confirmMsg = `Teklif Toplamƒ±: ${total.formatted}\\n\\nTeklifi g√∂ndermek istediƒüinizden emin misiniz?`;\n      if (!confirm(confirmMsg)) return;\n      \n      // Submit\n      const bidId = await createRFQBid(this.bidData);\n      \n      alert('‚úÖ Teklifiniz ba≈üarƒ±yla g√∂nderildi!');\n      \n      // Reset form\n      this.resetForm();\n      \n      return bidId;\n      \n    } catch (error) {\n      logger.error('Error submitting bid', error);\n      alert('‚ùå Teklif g√∂nderilirken hata olu≈ütu: ' + error.message);\n    }\n  }\n\n  resetForm() {\n    // Reset commercial terms\n    this.container.querySelector('#bid-currency').value = 'TRY';\n    this.container.querySelector('#bid-validity').value = '30';\n    this.container.querySelector('#bid-incoterm').value = 'DAP';\n    this.container.querySelector('#bid-warranty').value = '12';\n    this.container.querySelector('#bid-payment').value = '30-days';\n    this.container.querySelector('#bid-delivery').value = '';\n    this.container.querySelector('#bid-notes').value = '';\n    \n    // Reset item matrix\n    this.container.querySelectorAll('.item-compliance').forEach(select => select.value = '');\n    this.container.querySelectorAll('.item-price').forEach(input => input.value = '');\n    this.container.querySelectorAll('.item-brand').forEach(input => input.value = '');\n    this.container.querySelectorAll('.item-leadtime').forEach(input => input.value = '');\n    this.container.querySelectorAll('.item-minqty').forEach(input => input.value = '');\n    this.container.querySelectorAll('.item-partial').forEach(select => select.value = 'no');\n    this.container.querySelectorAll('.item-origin').forEach(input => input.value = '');\n    this.container.querySelectorAll('.item-comments').forEach(textarea => textarea.value = '');\n    \n    // Reset attachments\n    this.attachments = [];\n    this.updateFileList();\n    \n    // Reset data\n    this.bidData = {\n      demandId: this.demandData.id,\n      currency: 'TRY',\n      validityDays: 30,\n      incoterm: 'DAP',\n      warrantyMonths: 12,\n      paymentPlan: '30-days',\n      deliveryAddress: '',\n      notes: '',\n      items: []\n    };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\ui\\tabs.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'tabId' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":103,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":103,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Tabs UI Module\r\n * Handles tab switching and active state management\r\n */\r\n\r\n// Teklifbul Rule v1.0 - Structured Logging\r\nimport { logger } from '../../../src/shared/log/logger.js';\r\n\r\n/**\r\n * Tab Manager Class\r\n */\r\nexport class TabManager {\r\n  constructor(containerSelector) {\r\n    this.container = document.querySelector(containerSelector);\r\n    this.tabs = [];\r\n    this.activeTab = null;\r\n    this.init();\r\n  }\r\n\r\n  /**\r\n   * Initialize the tab manager\r\n   */\r\n  init() {\r\n    if (!this.container) {\r\n      logger.warn('Tab container not found', { containerSelector: this.containerSelector });\r\n      return;\r\n    }\r\n\r\n    // Find all tab buttons\r\n    this.tabs = Array.from(this.container.querySelectorAll('[role=\"tab\"]'));\r\n    \r\n    if (this.tabs.length === 0) {\r\n      logger.warn('No tabs found in container');\r\n      return;\r\n    }\r\n\r\n    // Set up event listeners\r\n    this.tabs.forEach(tab => {\r\n      tab.addEventListener('click', (e) => {\r\n        e.preventDefault();\r\n        this.switchTab(tab);\r\n      });\r\n    });\r\n\r\n    // Set initial active tab\r\n    const activeTab = this.container.querySelector('.tab.active, [aria-selected=\"true\"]');\r\n    if (activeTab) {\r\n      this.setActiveTab(activeTab);\r\n    } else if (this.tabs.length > 0) {\r\n      this.setActiveTab(this.tabs[0]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Switch to a specific tab\r\n   * @param {HTMLElement} tabElement - Tab element to switch to\r\n   */\r\n  switchTab(tabElement) {\r\n    if (!this.tabs.includes(tabElement)) {\r\n      logger.warn('Tab element not found in tabs array');\r\n      return;\r\n    }\r\n\r\n    this.setActiveTab(tabElement);\r\n    \r\n    // Dispatch custom event\r\n    const event = new CustomEvent('tabChanged', {\r\n      detail: {\r\n        tab: tabElement,\r\n        tabId: tabElement.id,\r\n        tabName: tabElement.textContent.trim()\r\n      }\r\n    });\r\n    this.container.dispatchEvent(event);\r\n  }\r\n\r\n  /**\r\n   * Set active tab\r\n   * @param {HTMLElement} tabElement - Tab element to make active\r\n   */\r\n  setActiveTab(tabElement) {\r\n    // Remove active class from all tabs\r\n    this.tabs.forEach(tab => {\r\n      tab.classList.remove('active');\r\n      tab.setAttribute('aria-selected', 'false');\r\n    });\r\n\r\n    // Add active class to selected tab\r\n    tabElement.classList.add('active');\r\n    tabElement.setAttribute('aria-selected', 'true');\r\n    \r\n    this.activeTab = tabElement;\r\n\r\n    // Show/hide corresponding content\r\n    this.updateContent(tabElement);\r\n  }\r\n\r\n  /**\r\n   * Update content visibility based on active tab\r\n   * @param {HTMLElement} tabElement - Active tab element\r\n   */\r\n  updateContent(tabElement) {\r\n    const tabId = tabElement.id;\r\n    const controlsId = tabElement.getAttribute('aria-controls');\r\n    \r\n    if (controlsId) {\r\n      const contentElement = document.getElementById(controlsId);\r\n      if (contentElement) {\r\n        // Hide all tab content\r\n        const allContent = document.querySelectorAll('[role=\"tabpanel\"]');\r\n        allContent.forEach(content => {\r\n          content.classList.add('hidden');\r\n          content.setAttribute('aria-hidden', 'true');\r\n        });\r\n\r\n        // Show active content\r\n        contentElement.classList.remove('hidden');\r\n        contentElement.setAttribute('aria-hidden', 'false');\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get active tab\r\n   * @returns {HTMLElement|null} Active tab element\r\n   */\r\n  getActiveTab() {\r\n    return this.activeTab;\r\n  }\r\n\r\n  /**\r\n   * Get tab by ID\r\n   * @param {string} tabId - Tab ID\r\n   * @returns {HTMLElement|null} Tab element\r\n   */\r\n  getTabById(tabId) {\r\n    return this.tabs.find(tab => tab.id === tabId) || null;\r\n  }\r\n\r\n  /**\r\n   * Switch to tab by ID\r\n   * @param {string} tabId - Tab ID\r\n   */\r\n  switchToTab(tabId) {\r\n    const tab = this.getTabById(tabId);\r\n    if (tab) {\r\n      this.switchTab(tab);\r\n    } else {\r\n      logger.warn('Tab not found', { tabId });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add new tab\r\n   * @param {Object} tabConfig - Tab configuration\r\n   * @param {string} tabConfig.id - Tab ID\r\n   * @param {string} tabConfig.label - Tab label\r\n   * @param {string} tabConfig.contentId - Content element ID\r\n   * @param {boolean} tabConfig.active - Whether to make this tab active\r\n   */\r\n  addTab(tabConfig) {\r\n    const { id, label, contentId, active = false } = tabConfig;\r\n\r\n    // Create tab button\r\n    const tabButton = document.createElement('button');\r\n    tabButton.id = id;\r\n    tabButton.className = 'tab';\r\n    tabButton.textContent = label;\r\n    tabButton.setAttribute('role', 'tab');\r\n    tabButton.setAttribute('aria-controls', contentId);\r\n    tabButton.setAttribute('aria-selected', 'false');\r\n\r\n    // Add click event listener\r\n    tabButton.addEventListener('click', (e) => {\r\n      e.preventDefault();\r\n      this.switchTab(tabButton);\r\n    });\r\n\r\n    // Add to container\r\n    this.container.appendChild(tabButton);\r\n    this.tabs.push(tabButton);\r\n\r\n    // Make active if specified\r\n    if (active) {\r\n      this.setActiveTab(tabButton);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove tab\r\n   * @param {string} tabId - Tab ID to remove\r\n   */\r\n  removeTab(tabId) {\r\n    const tab = this.getTabById(tabId);\r\n    if (tab) {\r\n      // Remove from DOM\r\n      tab.remove();\r\n      \r\n      // Remove from tabs array\r\n      this.tabs = this.tabs.filter(t => t !== tab);\r\n      \r\n      // If this was the active tab, switch to another tab\r\n      if (this.activeTab === tab) {\r\n        if (this.tabs.length > 0) {\r\n          this.setActiveTab(this.tabs[0]);\r\n        } else {\r\n          this.activeTab = null;\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Simple tab switching function for basic use cases\r\n * @param {string} tabId - Tab ID to switch to\r\n * @param {string} containerSelector - Container selector\r\n */\r\nexport function switchTab(tabId, containerSelector = '.tabs') {\r\n  const container = document.querySelector(containerSelector);\r\n  if (!container) {\r\n    logger.warn('Tab container not found', { containerSelector });\r\n    return;\r\n  }\r\n\r\n  const tab = container.querySelector(`#${tabId}`);\r\n  if (!tab) {\r\n    logger.warn('Tab not found', { tabId });\r\n    return;\r\n  }\r\n\r\n  // Remove active class from all tabs\r\n  const allTabs = container.querySelectorAll('.tab');\r\n  allTabs.forEach(t => {\r\n    t.classList.remove('active');\r\n    t.setAttribute('aria-selected', 'false');\r\n  });\r\n\r\n  // Add active class to selected tab\r\n  tab.classList.add('active');\r\n  tab.setAttribute('aria-selected', 'true');\r\n\r\n  // Show/hide content\r\n  const controlsId = tab.getAttribute('aria-controls');\r\n  if (controlsId) {\r\n    const contentElement = document.getElementById(controlsId);\r\n    if (contentElement) {\r\n      // Hide all tab content\r\n      const allContent = document.querySelectorAll('[role=\"tabpanel\"]');\r\n      allContent.forEach(content => {\r\n        content.classList.add('hidden');\r\n        content.setAttribute('aria-hidden', 'true');\r\n      });\r\n\r\n      // Show active content\r\n      contentElement.classList.remove('hidden');\r\n      contentElement.setAttribute('aria-hidden', 'false');\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Initialize tabs for a specific container\r\n * @param {string} containerSelector - Container selector\r\n * @returns {TabManager} Tab manager instance\r\n */\r\nexport function initTabs(containerSelector) {\r\n  return new TabManager(containerSelector);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\utils\\address.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'trNorm' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Teklifbul Rule v1.0 - Adres compose ve preview utilities\r\nimport type { Address } from '../types/address.js';\r\nimport { trNorm } from './stringNorm.js';\r\n\r\nexport const composeAddress = (a: Partial<Address>): string => {\r\n  const parts = [\r\n    a.sokak && (/(sokak|cadde)$/i.test(a.sokak) ? a.sokak : `${a.sokak} Sokak`),\r\n    a.cadde && (/(cadde)$/i.test(a.cadde) ? a.cadde : `${a.cadde} Cadde`),\r\n    a.kapiNo && `Kapƒ± No: ${a.kapiNo}`,\r\n    a.daire && `Daire: ${a.daire}`,\r\n    a.ilce,\r\n    a.il,\r\n    a.postaKodu && a.postaKodu,\r\n    a.ulke || 'T√ºrkiye',\r\n  ].filter(Boolean) as string[];\r\n\r\n  return parts.join(' - ');\r\n};\r\n\r\nexport const updatePreview = (displayEl: HTMLElement | null, addr: Partial<Address>): void => {\r\n  if (!displayEl) return;\r\n  displayEl.textContent = composeAddress(addr);\r\n};\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\utils\\stringNorm.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\utils\\taxOffices.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\js\\utils\\tr.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\assets\\purchase-form.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\backfill-supplier-categories.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\bid-management.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\categories.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\components\\escrow-panel.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\comprehensive-backfill.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\debug-demand-flow.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\demand-code-generator.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\enhanced-backfill.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\eslint.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\firebase.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\functions\\excel-export\\.eslintrc.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\functions\\excel-export\\index.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'row' is assigned a value but never used.","line":197,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":197,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'row' is assigned a value but never used.","line":217,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":217,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'row' is assigned a value but never used.","line":237,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":237,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'row' is assigned a value but never used.","line":381,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":381,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'noteRowTeklif' is assigned a value but never used.","line":603,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":603,"endColumn":26}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const functions = require(\"firebase-functions\");\nconst ExcelJS = require(\"exceljs\");\n\nexports.exportPurchaseForm = functions\n  .https\n  .onRequest(async (req, res) => {\n    // CORS\n    res.set(\"Access-Control-Allow-Origin\", \"*\");\n    res.set(\"Access-Control-Allow-Methods\", \"POST, OPTIONS, GET\");\n    res.set(\"Access-Control-Allow-Headers\", \"Content-Type\");\n\n    if (req.method === \"OPTIONS\") return res.status(204).send(\"\");\n    if (req.method === \"GET\") return res.status(200).send(\"exportPurchaseForm OK v3.0 - TWO SHEETS (Talep + Teklif) (use POST for Excel).\");\n    if (req.method !== \"POST\") return res.status(405).send(\"Method Not Allowed\");\n\n    try {\n      console.log(\"==========================================\");\n      console.log(\"üì• Excel export request received - v3.0\");\n      console.log(\"==========================================\");\n      const {\n        talep_kodu,\n        santiye,\n        items,\n        // T√ºm talep bilgileri\n        talep_tarihi,\n        termin,\n        talep_eden,\n        teslimat_adresi,\n        teslim_sekli,\n        teslim_yeri,\n        alim_yeri,\n        para_birimi,\n        odeme_sartlari,\n        onaylayan,\n        satinalma_sorumlusu,\n        genel_mudur,\n        aciklama,\n        kategoriler\n      } = req.body || {};\n\n      console.log(\"üìä Request data:\", {\n        talep_kodu,\n        items_count: Array.isArray(items) ? items.length : 0,\n        has_talep_tarihi: !!talep_tarihi,\n        has_talep_eden: !!talep_eden\n      });\n\n      const wb = new ExcelJS.Workbook();\n\n      // ============================================\n      // SAYFA 1: TALEP (Salt Okunur - Talep Bilgileri)\n      // ============================================\n      const shTalep = wb.addWorksheet(\"Talep\");\n      console.log(\"‚úÖ Talep worksheet created\");\n\n      // Stil tanƒ±mlamalarƒ±\n      const headerStyle = {\n        font: { bold: true, size: 12, color: { argb: \"FFFFFFFF\" } },\n        fill: {\n          type: \"pattern\",\n          pattern: \"solid\",\n          fgColor: { argb: \"FF2563EB\" }\n        },\n        alignment: { vertical: \"middle\", horizontal: \"center\" },\n        border: {\n          top: { style: \"thin\", color: { argb: \"FF000000\" } },\n          left: { style: \"thin\", color: { argb: \"FF000000\" } },\n          bottom: { style: \"thin\", color: { argb: \"FF000000\" } },\n          right: { style: \"thin\", color: { argb: \"FF000000\" } }\n        }\n      };\n\n      const labelStyle = {\n        font: { bold: true, size: 11 },\n        fill: {\n          type: \"pattern\",\n          pattern: \"solid\",\n          fgColor: { argb: \"FFF3F4F6\" }\n        },\n        alignment: { vertical: \"middle\", horizontal: \"right\" },\n        border: {\n          top: { style: \"thin\", color: { argb: \"FF000000\" } },\n          left: { style: \"thin\", color: { argb: \"FF000000\" } },\n          bottom: { style: \"thin\", color: { argb: \"FF000000\" } },\n          right: { style: \"thin\", color: { argb: \"FF000000\" } }\n        }\n      };\n\n      const valueStyle = {\n        font: { size: 11 },\n        alignment: { vertical: \"middle\", horizontal: \"left\" },\n        border: {\n          top: { style: \"thin\", color: { argb: \"FF000000\" } },\n          left: { style: \"thin\", color: { argb: \"FF000000\" } },\n          bottom: { style: \"thin\", color: { argb: \"FF000000\" } },\n          right: { style: \"thin\", color: { argb: \"FF000000\" } }\n        }\n      };\n\n      const tableHeaderStyle = {\n        font: { bold: true, size: 11, color: { argb: \"FFFFFFFF\" } },\n        fill: {\n          type: \"pattern\",\n          pattern: \"solid\",\n          fgColor: { argb: \"FF1E40AF\" }\n        },\n        alignment: { vertical: \"middle\", horizontal: \"center\", wrapText: true },\n        border: {\n          top: { style: \"medium\", color: { argb: \"FF000000\" } },\n          left: { style: \"medium\", color: { argb: \"FF000000\" } },\n          bottom: { style: \"medium\", color: { argb: \"FF000000\" } },\n          right: { style: \"medium\", color: { argb: \"FF000000\" } }\n        }\n      };\n\n      const tableCellStyle = {\n        font: { size: 11 },\n        alignment: { vertical: \"middle\", horizontal: \"center\" },\n        border: {\n          top: { style: \"thin\", color: { argb: \"FF000000\" } },\n          left: { style: \"thin\", color: { argb: \"FF000000\" } },\n          bottom: { style: \"thin\", color: { argb: \"FF000000\" } },\n          right: { style: \"thin\", color: { argb: \"FF000000\" } }\n        }\n      };\n\n      const readOnlyCellStyle = {\n        font: { size: 11, italic: true },\n        fill: {\n          type: \"pattern\",\n          pattern: \"solid\",\n          fgColor: { argb: \"FFF9FAFB\" }\n        },\n        alignment: { vertical: \"middle\", horizontal: \"center\" },\n        border: {\n          top: { style: \"thin\", color: { argb: \"FF000000\" } },\n          left: { style: \"thin\", color: { argb: \"FF000000\" } },\n          bottom: { style: \"thin\", color: { argb: \"FF000000\" } },\n          right: { style: \"thin\", color: { argb: \"FF000000\" } }\n        }\n      };\n\n      // TALEP SAYFASI - Ba≈ülƒ±k\n      const titleRow = shTalep.addRow([\"TALEP FORMU\"]);\n      titleRow.height = 30;\n      shTalep.mergeCells(`A1:I1`);\n      const titleCell = shTalep.getCell(1, 1);\n      titleCell.font = { bold: true, size: 16, color: { argb: \"FFFFFFFF\" } };\n      titleCell.fill = {\n        type: \"pattern\",\n        pattern: \"solid\",\n        fgColor: { argb: \"FF2563EB\" }\n      };\n      titleCell.alignment = { vertical: \"middle\", horizontal: \"center\" };\n      titleCell.border = {\n        top: { style: \"medium\", color: { argb: \"FF000000\" } },\n        left: { style: \"medium\", color: { argb: \"FF000000\" } },\n        bottom: { style: \"medium\", color: { argb: \"FF000000\" } },\n        right: { style: \"medium\", color: { argb: \"FF000000\" } }\n      };\n\n      // Bo≈ü satƒ±r\n      shTalep.addRow([]);\n\n      // Talep Bilgileri B√∂l√ºm√º\n      let rowNumTalep = 3;\n      shTalep.addRow([\"TALEP Bƒ∞LGƒ∞LERƒ∞\"]);\n      shTalep.mergeCells(`A${rowNumTalep}:I${rowNumTalep}`);\n      const sectionHeader = shTalep.getRow(rowNumTalep);\n      sectionHeader.height = 25;\n      const sectionCell = shTalep.getCell(rowNumTalep, 1);\n      sectionCell.font = headerStyle.font;\n      sectionCell.fill = headerStyle.fill;\n      sectionCell.alignment = headerStyle.alignment;\n      sectionCell.border = headerStyle.border;\n      rowNumTalep++;\n\n      // Talep bilgileri (Label-Value √ßiftleri) - STF No kaldƒ±rƒ±ldƒ±\n      const demandInfo = [\n        { label: \"Talep Kodu:\", value: talep_kodu || \"\" },\n        { label: \"≈ûantiye:\", value: santiye || \"\" },\n        { label: \"Talep Tarihi:\", value: talep_tarihi || \"\" },\n        { label: \"Termin:\", value: termin || \"\" },\n        { label: \"Talep Eden:\", value: talep_eden || \"\" },\n        { label: \"Teslimat Adresi:\", value: teslimat_adresi || \"\" },\n        { label: \"Teslim ≈ûekli:\", value: teslim_sekli || \"\" },\n        { label: \"Teslim Yeri:\", value: teslim_yeri || \"\" },\n        { label: \"Alƒ±m Yeri (ƒ∞l):\", value: alim_yeri || \"\" },\n        { label: \"Para Birimi:\", value: para_birimi || \"TRY\" },\n        { label: \"√ñdeme ≈ûartlarƒ±:\", value: odeme_sartlari || \"\" },\n        { label: \"Onaylayan:\", value: onaylayan || \"\" },\n        { label: \"Satƒ±nalma Sorumlusu:\", value: satinalma_sorumlusu || \"\" },\n        { label: \"Genel M√ºd√ºr:\", value: genel_mudur || \"\" }\n      ];\n\n      demandInfo.forEach(info => {\n        const row = shTalep.addRow([]);\n        const labelCell = shTalep.getCell(rowNumTalep, 1);\n        labelCell.value = info.label;\n        labelCell.font = labelStyle.font;\n        labelCell.fill = labelStyle.fill;\n        labelCell.alignment = labelStyle.alignment;\n        labelCell.border = labelStyle.border;\n        shTalep.mergeCells(`A${rowNumTalep}:C${rowNumTalep}`);\n        \n        const valueCell = shTalep.getCell(rowNumTalep, 4);\n        valueCell.value = info.value;\n        valueCell.font = valueStyle.font;\n        valueCell.alignment = valueStyle.alignment;\n        valueCell.border = valueStyle.border;\n        shTalep.mergeCells(`D${rowNumTalep}:I${rowNumTalep}`);\n        rowNumTalep++;\n      });\n\n      // Kategoriler\n      if (kategoriler && Array.isArray(kategoriler) && kategoriler.length > 0) {\n        const row = shTalep.addRow([]);\n        const labelCell = shTalep.getCell(rowNumTalep, 1);\n        labelCell.value = \"Kategoriler:\";\n        labelCell.font = labelStyle.font;\n        labelCell.fill = labelStyle.fill;\n        labelCell.alignment = labelStyle.alignment;\n        labelCell.border = labelStyle.border;\n        shTalep.mergeCells(`A${rowNumTalep}:C${rowNumTalep}`);\n        \n        const valueCell = shTalep.getCell(rowNumTalep, 4);\n        valueCell.value = kategoriler.join(\", \");\n        valueCell.font = valueStyle.font;\n        valueCell.alignment = valueStyle.alignment;\n        valueCell.border = valueStyle.border;\n        shTalep.mergeCells(`D${rowNumTalep}:I${rowNumTalep}`);\n        rowNumTalep++;\n      }\n\n      // A√ßƒ±klama\n      if (aciklama) {\n        const row = shTalep.addRow([]);\n        const labelCell = shTalep.getCell(rowNumTalep, 1);\n        labelCell.value = \"A√ßƒ±klama:\";\n        labelCell.font = labelStyle.font;\n        labelCell.fill = labelStyle.fill;\n        labelCell.alignment = labelStyle.alignment;\n        labelCell.border = labelStyle.border;\n        shTalep.mergeCells(`A${rowNumTalep}:C${rowNumTalep}`);\n        \n        const valueCell = shTalep.getCell(rowNumTalep, 4);\n        valueCell.value = aciklama;\n        valueCell.font = valueStyle.font;\n        valueCell.alignment = { ...valueStyle.alignment, wrapText: true };\n        valueCell.border = valueStyle.border;\n        shTalep.mergeCells(`D${rowNumTalep}:I${rowNumTalep}`);\n        rowNumTalep++;\n      }\n\n      // Bo≈ü satƒ±r\n      shTalep.addRow([]);\n      rowNumTalep++;\n\n      // √úr√ºn Tablosu Ba≈ülƒ±ƒüƒ±\n      const tableTitleRow = shTalep.addRow([\"TALEP EDƒ∞LEN √úR√úNLER\"]);\n      tableTitleRow.height = 25;\n      shTalep.mergeCells(`A${rowNumTalep}:H${rowNumTalep}`);\n      const tableTitleCell = shTalep.getCell(rowNumTalep, 1);\n      tableTitleCell.font = headerStyle.font;\n      tableTitleCell.fill = headerStyle.fill;\n      tableTitleCell.alignment = headerStyle.alignment;\n      tableTitleCell.border = headerStyle.border;\n      rowNumTalep++;\n\n      // Tablo ba≈ülƒ±klarƒ± (sadece talep bilgileri)\n      const demandHeaders = [\n        \"Sƒ±ra No\",\n        \"Malzeme Kodu\",\n        \"√úr√ºn Tanƒ±mƒ±\",\n        \"Marka/Model\",\n        \"Talep Edilen Miktar\",\n        \"Birim\",\n        \"ƒ∞stenilen Teslim Tarihi\"\n      ];\n      const headerRow = shTalep.addRow(demandHeaders);\n      headerRow.height = 25;\n\n      demandHeaders.forEach((header, colIndex) => {\n        const cell = shTalep.getCell(rowNumTalep, colIndex + 1);\n        cell.font = tableHeaderStyle.font;\n        cell.fill = tableHeaderStyle.fill;\n        cell.alignment = tableHeaderStyle.alignment;\n        cell.border = tableHeaderStyle.border;\n      });\n      rowNumTalep++;\n\n      // √úr√ºn satƒ±rlarƒ± (sadece talep bilgileri)\n      const itemsArray = Array.isArray(items) ? items : [];\n      itemsArray.forEach((item, index) => {\n        const row = shTalep.addRow([\n          index + 1,\n          item.sku || item.materialCode || \"\",\n          item.name || item.description || \"\",\n          item.brand || item.brandModel || \"\",\n          item.qty || item.quantity || 0,\n          item.unit || \"\",\n          item.req_date || item.itemDueDate || item.deliveryDate || \"\"\n        ]);\n\n        row.height = 20;\n        row.eachCell({ includeEmpty: true }, (cell) => {\n          cell.font = readOnlyCellStyle.font;\n          cell.fill = readOnlyCellStyle.fill;\n          cell.alignment = readOnlyCellStyle.alignment;\n          cell.border = readOnlyCellStyle.border;\n        });\n        rowNumTalep++;\n      });\n\n      // S√ºtun geni≈ülikleri\n      shTalep.columns = [\n        { width: 10 }, // Sƒ±ra No\n        { width: 15 }, // Malzeme Kodu\n        { width: 40 }, // √úr√ºn Tanƒ±mƒ±\n        { width: 20 }, // Marka/Model\n        { width: 18 }, // Talep Edilen Miktar\n        { width: 10 }, // Birim\n        { width: 20 }  // ƒ∞stenilen Teslim Tarihi\n      ];\n\n      // ============================================\n      // SAYFA 2: TEKLƒ∞F (Tedarik√ßinin Dolduracaƒüƒ±)\n      // ============================================\n      const shTeklif = wb.addWorksheet(\"Teklif\");\n      console.log(\"‚úÖ Teklif worksheet created\");\n\n      // TEKLƒ∞F SAYFASI - Ba≈ülƒ±k\n      const titleRowTeklif = shTeklif.addRow([\"TEKLƒ∞F FORMU\"]);\n      titleRowTeklif.height = 30;\n      shTeklif.mergeCells(`A1:P1`);\n      const titleCellTeklif = shTeklif.getCell(1, 1);\n      titleCellTeklif.font = { bold: true, size: 16, color: { argb: \"FFFFFFFF\" } };\n      titleCellTeklif.fill = {\n        type: \"pattern\",\n        pattern: \"solid\",\n        fgColor: { argb: \"FF059669\" }\n      };\n      titleCellTeklif.alignment = { vertical: \"middle\", horizontal: \"center\" };\n      titleCellTeklif.border = {\n        top: { style: \"medium\", color: { argb: \"FF000000\" } },\n        left: { style: \"medium\", color: { argb: \"FF000000\" } },\n        bottom: { style: \"medium\", color: { argb: \"FF000000\" } },\n        right: { style: \"medium\", color: { argb: \"FF000000\" } }\n      };\n\n      // Bo≈ü satƒ±r\n      shTeklif.addRow([]);\n\n      // Talep √ñzeti\n      let rowNumTeklif = 3;\n      shTeklif.addRow([\"TEKLƒ∞F Bƒ∞LGƒ∞LERƒ∞\"]);\n      shTeklif.mergeCells(`A${rowNumTeklif}:P${rowNumTeklif}`);\n      const sectionHeaderTeklif = shTeklif.getRow(rowNumTeklif);\n      sectionHeaderTeklif.height = 25;\n      const sectionCellTeklif = shTeklif.getCell(rowNumTeklif, 1);\n      sectionCellTeklif.font = { ...headerStyle.font, size: 12 };\n      sectionCellTeklif.fill = {\n        type: \"pattern\",\n        pattern: \"solid\",\n        fgColor: { argb: \"FF059669\" }\n      };\n      sectionCellTeklif.alignment = headerStyle.alignment;\n      sectionCellTeklif.border = headerStyle.border;\n      rowNumTeklif++;\n\n      // Talep √∂zeti (k√º√ß√ºk)\n      const summaryInfo = [\n        { label: \"Talep Kodu:\", value: talep_kodu || \"\" },\n        { label: \"≈ûantiye:\", value: santiye || \"\" },\n        { label: \"Para Birimi:\", value: para_birimi || \"TRY\" },\n        { label: \"Teslim Yeri:\", value: teslim_yeri || \"\" }\n      ];\n\n      summaryInfo.forEach((info, idx) => {\n        if (idx % 2 === 0) {\n          const row = shTeklif.addRow([]);\n          const labelCell = shTeklif.getCell(rowNumTeklif, 1);\n          labelCell.value = info.label;\n          labelCell.font = labelStyle.font;\n          labelCell.fill = labelStyle.fill;\n          labelCell.alignment = labelStyle.alignment;\n          labelCell.border = labelStyle.border;\n          shTeklif.mergeCells(`A${rowNumTeklif}:C${rowNumTeklif}`);\n          \n          const valueCell = shTeklif.getCell(rowNumTeklif, 4);\n          valueCell.value = info.value;\n          valueCell.font = valueStyle.font;\n          valueCell.alignment = valueStyle.alignment;\n          valueCell.border = valueStyle.border;\n          shTeklif.mergeCells(`D${rowNumTeklif}:F${rowNumTeklif}`);\n          \n          // ƒ∞kinci bilgi aynƒ± satƒ±rda\n          const info2 = summaryInfo[idx + 1];\n          if (info2) {\n            const labelCell2 = shTeklif.getCell(rowNumTeklif, 7);\n            labelCell2.value = info2.label;\n            labelCell2.font = labelStyle.font;\n            labelCell2.fill = labelStyle.fill;\n            labelCell2.alignment = labelStyle.alignment;\n            labelCell2.border = labelStyle.border;\n            shTeklif.mergeCells(`G${rowNumTeklif}:I${rowNumTeklif}`);\n            \n            const valueCell2 = shTeklif.getCell(rowNumTeklif, 10);\n            valueCell2.value = info2.value;\n            valueCell2.font = valueStyle.font;\n            valueCell2.alignment = valueStyle.alignment;\n            valueCell2.border = valueStyle.border;\n            shTeklif.mergeCells(`J${rowNumTeklif}:L${rowNumTeklif}`);\n          }\n          rowNumTeklif++;\n        }\n      });\n\n      // Bo≈ü satƒ±r\n      shTeklif.addRow([]);\n      rowNumTeklif++;\n\n      // √úr√ºn Tablosu Ba≈ülƒ±ƒüƒ±\n      const teklifTableTitleRow = shTeklif.addRow([\"TEKLƒ∞F √úR√úN Lƒ∞STESƒ∞\"]);\n      teklifTableTitleRow.height = 25;\n      shTeklif.mergeCells(`A${rowNumTeklif}:P${rowNumTeklif}`);\n      const teklifTableTitleCell = shTeklif.getCell(rowNumTeklif, 1);\n      teklifTableTitleCell.font = headerStyle.font;\n      teklifTableTitleCell.fill = {\n        type: \"pattern\",\n        pattern: \"solid\",\n        fgColor: { argb: \"FF059669\" }\n      };\n      teklifTableTitleCell.alignment = headerStyle.alignment;\n      teklifTableTitleCell.border = headerStyle.border;\n      rowNumTeklif++;\n\n      // Tablo ba≈ülƒ±klarƒ± - Talep bilgileri (okunur) + Teklif bilgileri (d√ºzenlenebilir)\n      const teklifHeaders = [\n        \"Sƒ±ra\", // A\n        \"Talep Malzeme Kodu\", // B (okunur)\n        \"Talep Edilen √úr√ºn\", // C (okunur)\n        \"Talep Miktar\", // D (okunur)\n        \"Talep Birim\", // E (okunur)\n        \"ƒ∞stenen Teslim Tarihi\", // F (okunur)\n        \"TEKLƒ∞F √úR√úN ADI/TANIM\", // G (d√ºzenlenebilir)\n        \"TEKLƒ∞F Mƒ∞KTAR\", // H (d√ºzenlenebilir)\n        \"TEKLƒ∞F Bƒ∞Rƒ∞M\", // I (d√ºzenlenebilir)\n        \"Bƒ∞Rƒ∞M Fƒ∞YAT\", // J (d√ºzenlenebilir)\n        \"KDV (%)\", // K (d√ºzenlenebilir)\n        \"Marka/Model\", // L (d√ºzenlenebilir)\n        \"Teslim S√ºresi (G√ºn)\", // M (d√ºzenlenebilir)\n        \"Minimum Sipari≈ü\", // N (d√ºzenlenebilir)\n        \"Kƒ±smi Teslimat (E/H)\", // O (d√ºzenlenebilir)\n        \"Men≈üei\", // P (d√ºzenlenebilir)\n        \"Notlar\", // Q (d√ºzenlenebilir)\n        \"KDV Hari√ß Toplam\", // R (form√ºl)\n        \"KDV Dahil Toplam\"  // S (form√ºl)\n      ];\n      \n      const teklifHeaderRow = shTeklif.addRow(teklifHeaders);\n      teklifHeaderRow.height = 25;\n\n      teklifHeaders.forEach((header, colIndex) => {\n        const cell = shTeklif.getCell(rowNumTeklif, colIndex + 1);\n        if (colIndex < 6) {\n          // Talep bilgileri (okunur) - mavi header\n          cell.font = tableHeaderStyle.font;\n          cell.fill = {\n            type: \"pattern\",\n            pattern: \"solid\",\n            fgColor: { argb: \"FF1E40AF\" }\n          };\n        } else {\n          // Teklif bilgileri (d√ºzenlenebilir) - ye≈üil header\n          cell.font = tableHeaderStyle.font;\n          cell.fill = {\n            type: \"pattern\",\n            pattern: \"solid\",\n            fgColor: { argb: \"FF059669\" }\n          };\n        }\n        cell.alignment = tableHeaderStyle.alignment;\n        cell.border = tableHeaderStyle.border;\n      });\n      rowNumTeklif++;\n\n      // √úr√ºn satƒ±rlarƒ±\n      const firstDataRow = rowNumTeklif;\n      itemsArray.forEach((item, index) => {\n        const row = shTeklif.addRow([\n          index + 1, // Sƒ±ra\n          item.sku || item.materialCode || \"\", // Talep Malzeme Kodu (okunur)\n          item.name || item.description || \"\", // Talep Edilen √úr√ºn (okunur)\n          item.qty || item.quantity || 0, // Talep Miktar (okunur)\n          item.unit || \"\", // Talep Birim (okunur)\n          item.req_date || item.itemDueDate || item.deliveryDate || \"\", // ƒ∞stenen Teslim Tarihi (okunur)\n          \"\", // TEKLƒ∞F √úR√úN ADI/TANIM (d√ºzenlenebilir)\n          \"\", // TEKLƒ∞F Mƒ∞KTAR (d√ºzenlenebilir)\n          item.unit || \"\", // TEKLƒ∞F Bƒ∞Rƒ∞M (varsayƒ±lan talep birimi)\n          \"\", // Bƒ∞Rƒ∞M Fƒ∞YAT (d√ºzenlenebilir)\n          \"\", // KDV (%) (d√ºzenlenebilir)\n          \"\", // Marka/Model (d√ºzenlenebilir)\n          \"\", // Teslim S√ºresi (G√ºn) (d√ºzenlenebilir)\n          \"\", // Minimum Sipari≈ü (d√ºzenlenebilir)\n          \"\", // Kƒ±smi Teslimat (E/H) (d√ºzenlenebilir)\n          \"\", // Men≈üei (d√ºzenlenebilir)\n          \"\", // Notlar (d√ºzenlenebilir)\n          \"\", // KDV Hari√ß Toplam (form√ºl)\n          \"\"  // KDV Dahil Toplam (form√ºl)\n        ]);\n\n        row.height = 20;\n\n        // H√ºcre stilleri\n        row.eachCell({ includeEmpty: true }, (cell, colNumber) => {\n          if (colNumber <= 6) {\n            // Talep bilgileri (salt okunur - gri)\n            cell.font = readOnlyCellStyle.font;\n            cell.fill = readOnlyCellStyle.fill;\n            cell.alignment = readOnlyCellStyle.alignment;\n            cell.border = readOnlyCellStyle.border;\n          } else {\n            // Teklif bilgileri (d√ºzenlenebilir - beyaz)\n            cell.font = tableCellStyle.font;\n            cell.alignment = tableCellStyle.alignment;\n            cell.border = tableCellStyle.border;\n          }\n        });\n\n        // Form√ºller\n        // KDV Hari√ß Toplam = TEKLƒ∞F Mƒ∞KTAR (H) * Bƒ∞Rƒ∞M Fƒ∞YAT (J)\n        const exclVatFormula = `=H${rowNumTeklif}*J${rowNumTeklif}`;\n        shTeklif.getCell(rowNumTeklif, 18).value = { formula: exclVatFormula };\n        shTeklif.getCell(rowNumTeklif, 18).numFmt = \"#,##0.00\";\n\n        // KDV Dahil Toplam = KDV Hari√ß Toplam * (1 + KDV/100)\n        const inclVatFormula = `=R${rowNumTeklif}*(1+K${rowNumTeklif}/100)`;\n        shTeklif.getCell(rowNumTeklif, 19).value = { formula: inclVatFormula };\n        shTeklif.getCell(rowNumTeklif, 19).numFmt = \"#,##0.00\";\n\n        rowNumTeklif++;\n      });\n\n      // Bo≈ü satƒ±r\n      shTeklif.addRow([]);\n      rowNumTeklif++;\n\n      // Toplam satƒ±rƒ±\n      const totalRowTeklif = shTeklif.addRow([\n        \"\",\n        \"\",\n        \"\",\n        \"\",\n        \"\",\n        \"\",\n        \"\",\n        \"\",\n        \"\",\n        \"\",\n        \"\",\n        \"\",\n        \"\",\n        \"\",\n        \"\",\n        \"\",\n        \"TOPLAM:\",\n        `=SUM(R${firstDataRow}:R${rowNumTeklif - 1})`, // KDV Hari√ß Toplam\n        `=SUM(S${firstDataRow}:S${rowNumTeklif - 1})`  // KDV Dahil Toplam\n      ]);\n      totalRowTeklif.height = 25;\n\n      // Toplam satƒ±rƒ± stil\n      [\"Q\", \"R\", \"S\"].forEach((col, idx) => {\n        const cell = shTeklif.getCell(rowNumTeklif, 17 + idx);\n        cell.font = {\n          bold: true,\n          size: 11,\n          color: { argb: \"FFFFFFFF\" }\n        };\n        cell.fill = {\n          type: \"pattern\",\n          pattern: \"solid\",\n          fgColor: { argb: \"FF059669\" }\n        };\n        cell.alignment = { vertical: \"middle\", horizontal: \"center\" };\n        cell.border = {\n          top: { style: \"medium\", color: { argb: \"FF000000\" } },\n          left: { style: \"medium\", color: { argb: \"FF000000\" } },\n          bottom: { style: \"medium\", color: { argb: \"FF000000\" } },\n          right: { style: \"medium\", color: { argb: \"FF000000\" } }\n        };\n        if (idx > 0) {\n          cell.numFmt = \"#,##0.00\";\n        }\n      });\n\n      // Not satƒ±rƒ±\n      rowNumTeklif++;\n      shTeklif.addRow([]);\n      rowNumTeklif++;\n      \n      const noteRowTeklif = shTeklif.addRow([\"NOT: 'TEKLƒ∞F' s√ºtunlarƒ±nƒ± doldurunuz. Talep bilgileri referans ama√ßlƒ±dƒ±r. Teklif √ºr√ºn adƒ±, miktar, birim fiyat ve KDV bilgilerini girdikten sonra toplamlar otomatik hesaplanacaktƒ±r.\"]);\n      shTeklif.mergeCells(`A${rowNumTeklif}:S${rowNumTeklif}`);\n      const noteCellTeklif = shTeklif.getCell(rowNumTeklif, 1);\n      noteCellTeklif.font = { italic: true, size: 10, color: { argb: \"FF6B7280\" } };\n      noteCellTeklif.alignment = { horizontal: \"left\" };\n\n      // S√ºtun geni≈ülikleri\n      shTeklif.columns = [\n        { width: 8 },  // Sƒ±ra\n        { width: 15 }, // Talep Malzeme Kodu\n        { width: 30 }, // Talep Edilen √úr√ºn\n        { width: 12 }, // Talep Miktar\n        { width: 10 }, // Talep Birim\n        { width: 18 }, // ƒ∞stenen Teslim Tarihi\n        { width: 35 }, // TEKLƒ∞F √úR√úN ADI/TANIM\n        { width: 12 }, // TEKLƒ∞F Mƒ∞KTAR\n        { width: 10 }, // TEKLƒ∞F Bƒ∞Rƒ∞M\n        { width: 15 }, // Bƒ∞Rƒ∞M Fƒ∞YAT\n        { width: 10 }, // KDV (%)\n        { width: 20 }, // Marka/Model\n        { width: 15 }, // Teslim S√ºresi (G√ºn)\n        { width: 15 }, // Minimum Sipari≈ü\n        { width: 15 }, // Kƒ±smi Teslimat\n        { width: 12 }, // Men≈üei\n        { width: 30 }, // Notlar\n        { width: 18 }, // KDV Hari√ß Toplam\n        { width: 18 }  // KDV Dahil Toplam\n      ];\n\n      console.log(\"üíæ Generating Excel buffer...\");\n      const buffer = await wb.xlsx.writeBuffer();\n      console.log(\"‚úÖ Excel buffer generated, size:\", buffer.length, \"bytes\");\n      console.log(\"üìã Talep worksheet row count:\", shTalep.rowCount);\n      console.log(\"üìã Teklif worksheet row count:\", shTeklif.rowCount);\n      res.set(\"Content-Type\", \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\");\n      res.set(\"Content-Disposition\", `attachment; filename=${(talep_kodu || \"talep\")}.xlsx`);\n      return res.status(200).send(Buffer.from(buffer));\n    } catch (err) {\n      console.error(\"‚ùå Excel olu≈üturma hatasƒ±:\", err);\n      console.error(\"‚ùå Error stack:\", err.stack);\n      return res.status(500).send(\"Excel olu≈üturulamadƒ±: \" + err.message);\n  }\n});\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\functions\\index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\functions\\src\\index.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":30,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[936,939],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[936,939],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":174,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":174,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6015,6018],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6015,6018],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":203,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":203,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7293,7296],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7293,7296],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":232,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":232,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8656,8659],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8656,8659],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\header.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\js\\ui-standard.js","messages":[{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":91,"column":3,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":91,"endColumn":97}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Otomatik sƒ±nƒ±flandƒ±rma ve ba≈ülƒ±k standardizasyonu\n(() => {\n  const EDITABLE_HINT_KEYS = [\n    'Teklif Edilen','ƒ∞skontolar','KDV','√ñdeme','Teslim','Kalite','Sertifika',\n    'Birim Fiyat','Para Birimi','A√ßƒ±klama','√úr√ºn G√∂rseli','Vade','Taksit','Kur','FX','√ñn √ñdeme'\n  ];\n  const STATIC_HINT_KEYS = ['Talep Bilgisi','Talep Detayƒ±','Talep Kalemi','√úr√ºn ƒ∞smi','Sƒ±ra No','Miktar','Birim','Toplam','Hedef'];\n\n  const q = (sel,root=document)=>Array.from(root.querySelectorAll(sel));\n  const matchText = (el,keys)=>keys.some(k => (el.textContent||'').toLowerCase().includes(k.toLowerCase()));\n  const findContainer = el =>\n    el.closest('.item-card,.card,.section-box,.panel,.box,section,.group,.wrapper,.container') || el.parentElement;\n\n  // Sayfa ba≈ülƒ±klarƒ±nƒ± kurumsal .section-header formatƒ±na d√∂n√º≈üt√ºr\n  function upgradeSectionHeaders(){\n    q('h1,h2,h3').forEach(h=>{\n      const t=(h.textContent||'').trim();\n      if(!t) return;\n      if(/^üìã|^üì¶|^üìù|^üìä|Genel Teklif Bilgileri|Kendi Teklifin|Talep Bilgisi|Fiyat Kar≈üƒ±la≈ütƒ±rma/i.test(t)){\n        if(h.classList.contains('section-header')) return;\n        const container = findContainer(h);\n        const wrap=document.createElement('div'); wrap.className='section-header';\n        const arr = Array.from(t);\n        const first = arr[0] || '‚Ä¢';\n        const rest = (arr.slice(1).join('')).trim() || t;\n        const icon=document.createElement('span'); icon.className='icon'; icon.textContent=first;\n        const label=document.createElement('span'); label.textContent=rest;\n        wrap.append(icon,label); h.replaceWith(wrap);\n        // Force static styling for specific headings\n        if(/Taslak Talepler/i.test(rest)){\n          wrap.classList.add('force-static');\n          if(container){ container.classList.add('block--static'); container.classList.remove('block--editable'); }\n        }\n      }\n    });\n  }\n\n  // Tablo ba≈ülƒ±k/altlƒ±k sƒ±nƒ±flarƒ±\n  function tagTables(){\n    q('table thead').forEach(t=>t.classList.add('table-head'));\n    q('table tbody tr').forEach(r=>r.classList.add('table-row'));\n    q('table tfoot').forEach(f=>f.classList.add('table-foot'));\n  }\n\n  // √úr√ºn kalemi tipindeki bloklarƒ± kart ve info-block yap\n  function tagItemBlocks(){\n    q('.rfq-item-block,.demand-item,.item,.item-block').forEach(el=>el.classList.add('item-card'));\n    q('.iskonto,.discount,.payment,.fx,.delivery,.cert,.quality').forEach(el=>el.classList.add('info-block'));\n  }\n\n  // Editable vs static otomatik tespiti\n  function classifyBlocks(){\n    // Manuel override: data-block / data-readonly\n    q('[data-block]').forEach(el=>{\n      const type=(el.getAttribute('data-block')||'').toLowerCase();\n      el.classList.add(type==='editable' ? 'block--editable' : 'block--static');\n    });\n    q('[data-readonly=\"true\"]').forEach(el=>el.classList.add('is-readonly'));\n\n    // Ba≈ülƒ±klara g√∂re ipucu\n    q('h2,h3,h4,.block-title,.section-title').forEach(h=>{\n      const box=findContainer(h); if(!box) return;\n      if(box.matches('[data-block]')) return; // manuel ise dokunma\n      if(matchText(h,EDITABLE_HINT_KEYS)) box.classList.add('block--editable');\n      if(matchText(h,STATIC_HINT_KEYS))   box.classList.add('block--static');\n      if(box.classList.contains('block--editable')){\n        h.classList.add('heading--editable');\n      }else if(box.classList.contains('block--static')){\n        h.classList.add('heading--static');\n      }\n    });\n\n    // Form elemanƒ± i√ßeriyorsa ve disabled deƒüilse editable say\n    q('.card,.item-card,.section-box,.panel,.box,section').forEach(box=>{\n      if(box.matches('[data-block]')) return; // manuel ise atla\n      const inputs=q('input,select,textarea,[contenteditable=\"true\"]',box);\n      const hasActive = inputs.some(i=>!(i.disabled||i.readOnly||i.getAttribute('aria-disabled')==='true'));\n      if(hasActive){ box.classList.add('block--editable'); q('h2,h3,h4,.block-title,.section-title',box).forEach(h=>h.classList.add('heading--editable')); }\n      else { box.classList.add('block--static'); q('h2,h3,h4,.block-title,.section-title',box).forEach(h=>h.classList.add('heading--static')); }\n    });\n\n    // Role tabanlƒ± readonly: data-required-role ile\n    const currentRole=window.CURRENT_ROLE||'buyer';\n    q('[data-required-role]').forEach(box=>{\n      const need=box.getAttribute('data-required-role');\n      if(need && need!==currentRole){ box.classList.add('is-readonly'); }\n    });\n  }\n\n  function init(){ upgradeSectionHeaders(); tagTables(); tagItemBlocks(); classifyBlocks(); }\n  document.readyState==='loading' ? document.addEventListener('DOMContentLoaded',init) : init();\n})();\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\migrate-bids-add-buyerid-simple.cjs","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'query' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":5,"column":60,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":65},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'where' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":5,"column":67,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":72},{"ruleId":"no-undef","severity":1,"message":"'getDoc' is not defined.","line":55,"column":33,"nodeType":"Identifier","messageId":"undef","endLine":55,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// migrate-bids-add-buyerid-simple.cjs\r\n// Bu script mevcut tekliflere buyerId alanƒ±nƒ± ekler (basit versiyon)\r\n\r\nconst { initializeApp } = require('firebase/app');\r\nconst { getFirestore, collection, getDocs, updateDoc, doc, query, where } = require('firebase/firestore');\r\n\r\n// Firebase config\r\nconst firebaseConfig = {\r\n  apiKey: \"AIzaSyAbX3UWRPpw-yo4I4HbSdTg82LxvM-fqTE\",\r\n  authDomain: \"teklifbul.firebaseapp.com\",\r\n  projectId: \"teklifbul\",\r\n  storageBucket: \"teklifbul.firebasestorage.app\",\r\n  messagingSenderId: \"123456789\",\r\n  appId: \"1:123456789:web:abcdef123456\"\r\n};\r\n\r\nconst app = initializeApp(firebaseConfig);\r\nconst db = getFirestore(app);\r\n\r\nasync function migrateBidsAddBuyerIdSimple() {\r\n  console.log('üîÑ Tekliflere buyerId alanƒ± ekleniyor (basit versiyon)...');\r\n  \r\n  try {\r\n    // T√ºm teklifleri al\r\n    const bidsSnapshot = await getDocs(collection(db, 'bids'));\r\n    console.log(`üìä Toplam ${bidsSnapshot.docs.length} teklif bulundu`);\r\n    \r\n    if (bidsSnapshot.docs.length === 0) {\r\n      console.log('‚ö†Ô∏è Hi√ß teklif yok');\r\n      return;\r\n    }\r\n    \r\n    let updatedCount = 0;\r\n    let skippedCount = 0;\r\n    \r\n    for (const bidDoc of bidsSnapshot.docs) {\r\n      const bidData = bidDoc.data();\r\n      \r\n      // Eƒüer buyerId zaten varsa atla\r\n      if (bidData.buyerId) {\r\n        console.log(`‚è≠Ô∏è Teklif ${bidDoc.id} zaten buyerId'ye sahip: ${bidData.buyerId}`);\r\n        skippedCount++;\r\n        continue;\r\n      }\r\n      \r\n      // demandId'den talep bilgisini al\r\n      if (!bidData.demandId) {\r\n        console.log(`‚ö†Ô∏è Teklif ${bidDoc.id} demandId'ye sahip deƒüil, atlanƒ±yor`);\r\n        skippedCount++;\r\n        continue;\r\n      }\r\n      \r\n      try {\r\n        // Talep bilgisini al\r\n        const demandDoc = await getDoc(doc(db, 'demands', bidData.demandId));\r\n        \r\n        if (!demandDoc.exists()) {\r\n          console.log(`‚ö†Ô∏è Teklif ${bidDoc.id} i√ßin talep bulunamadƒ±: ${bidData.demandId}`);\r\n          skippedCount++;\r\n          continue;\r\n        }\r\n        \r\n        const demandData = demandDoc.data();\r\n        const buyerId = demandData.createdBy;\r\n        \r\n        if (!buyerId) {\r\n          console.log(`‚ö†Ô∏è Talep ${bidData.demandId} createdBy alanƒ±na sahip deƒüil`);\r\n          skippedCount++;\r\n          continue;\r\n        }\r\n        \r\n        // buyerId'yi ekle\r\n        await updateDoc(doc(db, 'bids', bidDoc.id), {\r\n          buyerId: buyerId\r\n        });\r\n        \r\n        console.log(`‚úÖ Teklif ${bidDoc.id} g√ºncellendi - buyerId: ${buyerId}`);\r\n        updatedCount++;\r\n        \r\n      } catch (error) {\r\n        console.error(`‚ùå Teklif ${bidDoc.id} g√ºncellenemedi:`, error);\r\n        skippedCount++;\r\n      }\r\n    }\r\n    \r\n    console.log(`\\nüìä Migration tamamlandƒ±:`);\r\n    console.log(`‚úÖ G√ºncellenen: ${updatedCount}`);\r\n    console.log(`‚è≠Ô∏è Atlanan: ${skippedCount}`);\r\n    console.log(`üìä Toplam: ${bidsSnapshot.docs.length}`);\r\n    \r\n  } catch (error) {\r\n    console.error('‚ùå Migration hatasƒ±:', error);\r\n  }\r\n}\r\n\r\n// Migration'ƒ± √ßalƒ±≈ütƒ±r\r\nmigrateBidsAddBuyerIdSimple();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\migrate-bids-add-buyerid.cjs","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'demandRef' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":50,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":50,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// migrate-bids-add-buyerid.cjs\r\n// Bu script mevcut tekliflere buyerId alanƒ±nƒ± ekler\r\n\r\nconst { initializeApp } = require('firebase/app');\r\nconst { getFirestore, collection, getDocs, updateDoc, doc, query, where } = require('firebase/firestore');\r\n\r\n// Firebase config\r\nconst firebaseConfig = {\r\n  apiKey: \"AIzaSyAbX3UWRPpw-yo4I4HbSdTg82LxvM-fqTE\",\r\n  authDomain: \"teklifbul.firebaseapp.com\",\r\n  projectId: \"teklifbul\",\r\n  storageBucket: \"teklifbul.firebasestorage.app\",\r\n  messagingSenderId: \"123456789\",\r\n  appId: \"1:123456789:web:abcdef123456\"\r\n};\r\n\r\nconst app = initializeApp(firebaseConfig);\r\nconst db = getFirestore(app);\r\n\r\nasync function migrateBidsAddBuyerId() {\r\n  console.log('üîÑ Tekliflere buyerId alanƒ± ekleniyor...');\r\n  \r\n  try {\r\n    // T√ºm teklifleri al\r\n    const bidsSnapshot = await getDocs(collection(db, 'bids'));\r\n    console.log(`üìä Toplam ${bidsSnapshot.docs.length} teklif bulundu`);\r\n    \r\n    let updatedCount = 0;\r\n    let skippedCount = 0;\r\n    \r\n    for (const bidDoc of bidsSnapshot.docs) {\r\n      const bidData = bidDoc.data();\r\n      \r\n      // Eƒüer buyerId zaten varsa atla\r\n      if (bidData.buyerId) {\r\n        console.log(`‚è≠Ô∏è Teklif ${bidDoc.id} zaten buyerId'ye sahip: ${bidData.buyerId}`);\r\n        skippedCount++;\r\n        continue;\r\n      }\r\n      \r\n      // demandId'den talep bilgisini al\r\n      if (!bidData.demandId) {\r\n        console.log(`‚ö†Ô∏è Teklif ${bidDoc.id} demandId'ye sahip deƒüil, atlanƒ±yor`);\r\n        skippedCount++;\r\n        continue;\r\n      }\r\n      \r\n      try {\r\n        // Talep bilgisini al - doc() kullanarak\r\n        const demandRef = doc(db, 'demands', bidData.demandId);\r\n        const demandDoc = await getDocs(query(collection(db, 'demands'), where('__name__', '==', bidData.demandId)));\r\n        \r\n        if (demandDoc.empty) {\r\n          console.log(`‚ö†Ô∏è Teklif ${bidDoc.id} i√ßin talep bulunamadƒ±: ${bidData.demandId}`);\r\n          skippedCount++;\r\n          continue;\r\n        }\r\n        \r\n        const demandData = demandDoc.docs[0].data();\r\n        const buyerId = demandData.createdBy;\r\n        \r\n        if (!buyerId) {\r\n          console.log(`‚ö†Ô∏è Talep ${bidData.demandId} createdBy alanƒ±na sahip deƒüil`);\r\n          skippedCount++;\r\n          continue;\r\n        }\r\n        \r\n        // buyerId'yi ekle\r\n        await updateDoc(doc(db, 'bids', bidDoc.id), {\r\n          buyerId: buyerId\r\n        });\r\n        \r\n        console.log(`‚úÖ Teklif ${bidDoc.id} g√ºncellendi - buyerId: ${buyerId}`);\r\n        updatedCount++;\r\n        \r\n      } catch (error) {\r\n        console.error(`‚ùå Teklif ${bidDoc.id} g√ºncellenemedi:`, error);\r\n        skippedCount++;\r\n      }\r\n    }\r\n    \r\n    console.log(`\\nüìä Migration tamamlandƒ±:`);\r\n    console.log(`‚úÖ G√ºncellenen: ${updatedCount}`);\r\n    console.log(`‚è≠Ô∏è Atlanan: ${skippedCount}`);\r\n    console.log(`üìä Toplam: ${bidsSnapshot.docs.length}`);\r\n    \r\n  } catch (error) {\r\n    console.error('‚ùå Migration hatasƒ±:', error);\r\n  }\r\n}\r\n\r\n// Migration'ƒ± √ßalƒ±≈ütƒ±r\r\nmigrateBidsAddBuyerId();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\migrate-bids-add-buyerid.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\migrate-demands-to-recipients.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\migrate-demands.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\migrate-users-multi-role.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\public\\firebase-messaging-sw.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'event' is defined but never used. Allowed unused args must match /^_/u.","line":91,"column":35,"nodeType":null,"messageId":"unusedVar","endLine":91,"endColumn":40}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/* global self, importScripts, firebase */\r\n/**\r\n * Firebase Cloud Messaging Service Worker\r\n * Teklifbul Rule v1.0 - Background push notifications\r\n * \r\n * Bu dosya public/ klas√∂r√ºnde olmalƒ± ve /firebase-messaging-sw.js URL'inden eri≈üilebilir olmalƒ±\r\n */\r\n\r\nimportScripts('https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js');\r\nimportScripts('https://www.gstatic.com/firebasejs/10.13.1/firebase-messaging-compat.js');\r\n\r\n// Firebase config - firebase.js ile aynƒ± olmalƒ±\r\nfirebase.initializeApp({\r\n  apiKey: 'AIzaSyAbX3UWRPpw-yo4I4HbSdTg82LxvM-fqTE',\r\n  authDomain: 'teklifbul.firebaseapp.com',\r\n  projectId: 'teklifbul',\r\n  storageBucket: 'teklifbul.firebasestorage.app',\r\n  messagingSenderId: '636669818119', // Firebase Console ‚Üí Project Settings ‚Üí General\r\n  appId: '1:636669818119:web:9085962e660831c36941a2'\r\n});\r\n\r\nconst messaging = firebase.messaging();\r\n\r\n// Arka planda (tab kapalƒ±/arka planda) data geldiƒüinde\r\nmessaging.onBackgroundMessage((payload) => {\r\n  console.log('üì© Background FCM mesajƒ±:', payload);\r\n\r\n  const title = payload.notification?.title || payload.data?.title || 'Teklifbul';\r\n  const body = payload.notification?.body || payload.data?.body || 'Yeni bildirim';\r\n  const icon = payload.notification?.icon || '/favicon.ico';\r\n  const badge = '/favicon.ico';\r\n\r\n  // Bildirim g√∂ster\r\n  const notificationOptions = {\r\n    body: body,\r\n    icon: icon,\r\n    badge: badge,\r\n    tag: payload.data?.requestId || payload.data?.rfqId || 'fcm',\r\n    data: payload.data || {},\r\n    requireInteraction: false,\r\n    actions: payload.data?.actions || [], // √ñzel aksiyonlar (opsiyonel)\r\n  };\r\n\r\n  // Bildirim g√∂ster\r\n  return self.registration.showNotification(title, notificationOptions);\r\n});\r\n\r\n// Bildirim tƒ±klama event'i\r\nself.addEventListener('notificationclick', (event) => {\r\n  console.log('üîî Bildirim tƒ±klandƒ±:', event.notification);\r\n\r\n  event.notification.close();\r\n\r\n  // √ñzel data ile sayfa a√ß\r\n  const data = event.notification.data || {};\r\n  let url = '/';\r\n\r\n  // URL mapping\r\n  if (data.requestId) {\r\n    url = `/demand-detail.html?id=${data.requestId}`;\r\n  } else if (data.rfqId) {\r\n    url = `/bid-detail.html?id=${data.rfqId}`;\r\n  } else if (data.url) {\r\n    url = data.url;\r\n  }\r\n\r\n  // Client a√ßƒ±k mƒ± kontrol et\r\n  event.waitUntil(\r\n    clients.matchAll({ type: 'window', includeUncontrolled: true }).then((clientList) => {\r\n      // Aynƒ± origin'de a√ßƒ±k pencere var mƒ±?\r\n      for (let i = 0; i < clientList.length; i++) {\r\n        const client = clientList[i];\r\n        if (client.url.includes(self.origin) && 'focus' in client) {\r\n          // Mevcut pencereyi odakla ve URL'i g√ºncelle\r\n          return client.focus().then(() => {\r\n            if (client.navigate) {\r\n              client.navigate(url);\r\n            }\r\n          });\r\n        }\r\n      }\r\n      // Yeni pencere a√ß\r\n      if (clients.openWindow) {\r\n        return clients.openWindow(url);\r\n      }\r\n    })\r\n  );\r\n});\r\n\r\n// Service worker install event\r\nself.addEventListener('install', (event) => {\r\n  console.log('‚úÖ Service Worker y√ºklendi');\r\n  self.skipWaiting(); // Hemen aktif et\r\n});\r\n\r\n// Service worker activate event\r\nself.addEventListener('activate', (event) => {\r\n  console.log('‚úÖ Service Worker aktif');\r\n  event.waitUntil(clients.claim()); // T√ºm client'larƒ± kontrol altƒ±na al\r\n});\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\public\\js\\import.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\public\\js\\site-address-link.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\public\\js\\ui-standard.js","messages":[{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":91,"column":3,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":91,"endColumn":97}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Otomatik sƒ±nƒ±flandƒ±rma ve ba≈ülƒ±k standardizasyonu\n(() => {\n  const EDITABLE_HINT_KEYS = [\n    'Teklif Edilen','ƒ∞skontolar','KDV','√ñdeme','Teslim','Kalite','Sertifika',\n    'Birim Fiyat','Para Birimi','A√ßƒ±klama','√úr√ºn G√∂rseli','Vade','Taksit','Kur','FX','√ñn √ñdeme'\n  ];\n  const STATIC_HINT_KEYS = ['Talep Bilgisi','Talep Detayƒ±','Talep Kalemi','√úr√ºn ƒ∞smi','Sƒ±ra No','Miktar','Birim','Toplam','Hedef'];\n\n  const q = (sel,root=document)=>Array.from(root.querySelectorAll(sel));\n  const matchText = (el,keys)=>keys.some(k => (el.textContent||'').toLowerCase().includes(k.toLowerCase()));\n  const findContainer = el =>\n    el.closest('.item-card,.card,.section-box,.panel,.box,section,.group,.wrapper,.container') || el.parentElement;\n\n  // Sayfa ba≈ülƒ±klarƒ±nƒ± kurumsal .section-header formatƒ±na d√∂n√º≈üt√ºr\n  function upgradeSectionHeaders(){\n    q('h1,h2,h3').forEach(h=>{\n      const t=(h.textContent||'').trim();\n      if(!t) return;\n      if(/^üìã|^üì¶|^üìù|^üìä|Genel Teklif Bilgileri|Kendi Teklifin|Talep Bilgisi|Fiyat Kar≈üƒ±la≈ütƒ±rma/i.test(t)){\n        if(h.classList.contains('section-header')) return;\n        const container = findContainer(h);\n        const wrap=document.createElement('div'); wrap.className='section-header';\n        const arr = Array.from(t);\n        const first = arr[0] || '‚Ä¢';\n        const rest = (arr.slice(1).join('')).trim() || t;\n        const icon=document.createElement('span'); icon.className='icon'; icon.textContent=first;\n        const label=document.createElement('span'); label.textContent=rest;\n        wrap.append(icon,label); h.replaceWith(wrap);\n        // Force static styling for specific headings\n        if(/Taslak Talepler/i.test(rest)){\n          wrap.classList.add('force-static');\n          if(container){ container.classList.add('block--static'); container.classList.remove('block--editable'); }\n        }\n      }\n    });\n  }\n\n  // Tablo ba≈ülƒ±k/altlƒ±k sƒ±nƒ±flarƒ±\n  function tagTables(){\n    q('table thead').forEach(t=>t.classList.add('table-head'));\n    q('table tbody tr').forEach(r=>r.classList.add('table-row'));\n    q('table tfoot').forEach(f=>f.classList.add('table-foot'));\n  }\n\n  // √úr√ºn kalemi tipindeki bloklarƒ± kart ve info-block yap\n  function tagItemBlocks(){\n    q('.rfq-item-block,.demand-item,.item,.item-block').forEach(el=>el.classList.add('item-card'));\n    q('.iskonto,.discount,.payment,.fx,.delivery,.cert,.quality').forEach(el=>el.classList.add('info-block'));\n  }\n\n  // Editable vs static otomatik tespiti\n  function classifyBlocks(){\n    // Manuel override: data-block / data-readonly\n    q('[data-block]').forEach(el=>{\n      const type=(el.getAttribute('data-block')||'').toLowerCase();\n      el.classList.add(type==='editable' ? 'block--editable' : 'block--static');\n    });\n    q('[data-readonly=\"true\"]').forEach(el=>el.classList.add('is-readonly'));\n\n    // Ba≈ülƒ±klara g√∂re ipucu\n    q('h2,h3,h4,.block-title,.section-title').forEach(h=>{\n      const box=findContainer(h); if(!box) return;\n      if(box.matches('[data-block]')) return; // manuel ise dokunma\n      if(matchText(h,EDITABLE_HINT_KEYS)) box.classList.add('block--editable');\n      if(matchText(h,STATIC_HINT_KEYS))   box.classList.add('block--static');\n      if(box.classList.contains('block--editable')){\n        h.classList.add('heading--editable');\n      }else if(box.classList.contains('block--static')){\n        h.classList.add('heading--static');\n      }\n    });\n\n    // Form elemanƒ± i√ßeriyorsa ve disabled deƒüilse editable say\n    q('.card,.item-card,.section-box,.panel,.box,section').forEach(box=>{\n      if(box.matches('[data-block]')) return; // manuel ise atla\n      const inputs=q('input,select,textarea,[contenteditable=\"true\"]',box);\n      const hasActive = inputs.some(i=>!(i.disabled||i.readOnly||i.getAttribute('aria-disabled')==='true'));\n      if(hasActive){ box.classList.add('block--editable'); q('h2,h3,h4,.block-title,.section-title',box).forEach(h=>h.classList.add('heading--editable')); }\n      else { box.classList.add('block--static'); q('h2,h3,h4,.block-title,.section-title',box).forEach(h=>h.classList.add('heading--static')); }\n    });\n\n    // Role tabanlƒ± readonly: data-required-role ile\n    const currentRole=window.CURRENT_ROLE||'buyer';\n    q('[data-required-role]').forEach(box=>{\n      const need=box.getAttribute('data-required-role');\n      if(need && need!==currentRole){ box.classList.add('is-readonly'); }\n    });\n  }\n\n  function init(){ upgradeSectionHeaders(); tagTables(); tagItemBlocks(); classifyBlocks(); }\n  document.readyState==='loading' ? document.addEventListener('DOMContentLoaded',init) : init();\n})();\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\publish-demand.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\add-satfk-simple.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'query' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":61,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":66},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'where' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":68,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":73},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'orderBy' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":75,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":82}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\r\n\r\n/**\r\n * Simple SATFK generator for existing demands\r\n * This script generates SATFK codes for demands that don't have them\r\n */\r\n\r\nimport { initializeApp } from \"https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js\";\r\nimport { getFirestore, collection, getDocs, doc, updateDoc, query, where, orderBy } from \"https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js\";\r\n\r\nconst firebaseConfig = {\r\n  apiKey: \"AIzaSyAbX3UWRPpw-yo4I4HbSdTg82LxvM-fqTE\",\r\n  authDomain: \"teklifbul.firebaseapp.com\",\r\n  projectId: \"teklifbul\",\r\n  storageBucket: \"teklifbul.firebasestorage.app\",\r\n  messagingSenderId: \"123456789\",\r\n  appId: \"1:123456789:web:abcdef123456\"\r\n};\r\n\r\nconst app = initializeApp(firebaseConfig);\r\nconst db = getFirestore(app);\r\n\r\n/**\r\n * Generate SATFK for a demand\r\n */\r\nfunction generateSATFK(demandData, demandId) {\r\n  // Get creation date\r\n  let creationDate;\r\n  if (demandData.createdAt && demandData.createdAt.toDate) {\r\n    creationDate = demandData.createdAt.toDate();\r\n  } else if (demandData.createdAt && demandData.createdAt._seconds) {\r\n    creationDate = new Date(demandData.createdAt._seconds * 1000);\r\n  } else {\r\n    creationDate = new Date();\r\n  }\r\n\r\n  // Format date as YYYYMMDD\r\n  const dateStr = creationDate.toISOString().slice(0, 10).replace(/-/g, '');\r\n  \r\n  // Generate a simple counter based on demand ID hash\r\n  const hash = demandId.split('').reduce((a, b) => {\r\n    a = ((a << 5) - a) + b.charCodeAt(0);\r\n    return a & a;\r\n  }, 0);\r\n  \r\n  const counter = Math.abs(hash) % 1000; // 0-999\r\n  const base36 = counter.toString(36).toUpperCase();\r\n  const padded = base36.padStart(3, '0');\r\n  \r\n  return `SATFK-${dateStr}-${padded}`;\r\n}\r\n\r\n/**\r\n * Main function to add SATFK to demands\r\n */\r\nasync function addSATFKToDemands() {\r\n  console.log('üöÄ Starting SATFK addition process...');\r\n  \r\n  try {\r\n    // Get all demands\r\n    const demandsRef = collection(db, 'demands');\r\n    const snapshot = await getDocs(demandsRef);\r\n    \r\n    console.log(`üìä Found ${snapshot.docs.length} total demands`);\r\n    \r\n    let updatedCount = 0;\r\n    let skippedCount = 0;\r\n    \r\n    for (const docSnap of snapshot.docs) {\r\n      const demandData = docSnap.data();\r\n      const demandId = docSnap.id;\r\n      \r\n      // Skip if SATFK already exists\r\n      if (demandData.satfk) {\r\n        console.log(`‚è≠Ô∏è Skipping ${demandId} - already has SATFK: ${demandData.satfk}`);\r\n        skippedCount++;\r\n        continue;\r\n      }\r\n      \r\n      try {\r\n        // Generate SATFK\r\n        const satfk = generateSATFK(demandData, demandId);\r\n        \r\n        // Update the demand\r\n        await updateDoc(doc(db, 'demands', demandId), {\r\n          satfk: satfk\r\n        });\r\n        \r\n        console.log(`‚úÖ Updated ${demandId} with SATFK: ${satfk}`);\r\n        updatedCount++;\r\n        \r\n      } catch (error) {\r\n        console.error(`‚ùå Failed to update ${demandId}:`, error);\r\n      }\r\n    }\r\n    \r\n    console.log(`\\nüìà Summary:`);\r\n    console.log(`   - Updated: ${updatedCount} demands`);\r\n    console.log(`   - Skipped: ${skippedCount} demands`);\r\n    console.log(`   - Total: ${snapshot.docs.length} demands`);\r\n    \r\n  } catch (error) {\r\n    console.error('üí• Process failed:', error);\r\n  }\r\n}\r\n\r\n// Run the process\r\naddSATFKToDemands()\r\n  .then(() => {\r\n    console.log('‚úÖ SATFK addition completed successfully');\r\n  })\r\n  .catch((error) => {\r\n    console.error('üí• SATFK addition failed:', error);\r\n  });\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\backfill-categories.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":8,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":8,"endColumn":40},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":9,"column":18,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":9,"endColumn":37}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\r\n\r\n/**\r\n * Backfill script to normalize existing category data\r\n * Converts category names to slug format for both demands and users\r\n */\r\n\r\nconst admin = require('firebase-admin');\r\nconst readline = require('readline');\r\n\r\n// Initialize Firebase Admin\r\nif (!admin.apps.length) {\r\n  admin.initializeApp({\r\n    credential: admin.credential.applicationDefault(),\r\n  });\r\n}\r\n\r\nconst db = admin.firestore();\r\n\r\n/**\r\n * Convert category names to slugs\r\n * @param {string} name - Category name to convert\r\n * @returns {string} Slugified category name\r\n */\r\nfunction toSlug(name) {\r\n  if (!name || typeof name !== 'string') return '';\r\n  return name\r\n    .toLowerCase()\r\n    .trim()\r\n    .replace(/\\s+/g, '-')\r\n    .replace(/[^a-z0-9-]/g, '')\r\n    .replace(/-+/g, '-')\r\n    .replace(/^-|-$/g, '');\r\n}\r\n\r\n/**\r\n * Backfill demand categories\r\n */\r\nasync function backfillDemandCategories() {\r\n  console.log('üîÑ Starting demand categories backfill...');\r\n  \r\n  try {\r\n    const demandsSnapshot = await db.collection('demands').get();\r\n    let processed = 0;\r\n    let updated = 0;\r\n    const batch = db.batch();\r\n\r\n    for (const doc of demandsSnapshot.docs) {\r\n      const data = doc.data();\r\n      const categories = data.categories || [];\r\n      const normalizedCategories = categories.map(toSlug).filter(Boolean);\r\n\r\n      if (JSON.stringify(normalizedCategories) !== JSON.stringify(categories)) {\r\n        const demandRef = db.collection('demands').doc(doc.id);\r\n        batch.update(demandRef, { categories: normalizedCategories });\r\n        updated++;\r\n        console.log(`üìù Will update demand ${doc.id}:`, {\r\n          from: categories,\r\n          to: normalizedCategories\r\n        });\r\n      }\r\n      processed++;\r\n\r\n      // Commit batch every 500 operations\r\n      if (updated > 0 && updated % 500 === 0) {\r\n        await batch.commit();\r\n        console.log(`‚úÖ Committed batch: ${updated} demands updated`);\r\n      }\r\n    }\r\n\r\n    // Commit remaining operations\r\n    if (updated > 0) {\r\n      await batch.commit();\r\n    }\r\n\r\n    console.log(`‚úÖ Demand categories backfill completed: ${updated}/${processed} demands updated`);\r\n  } catch (error) {\r\n    console.error('‚ùå Error backfilling demand categories:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Backfill supplier categories\r\n */\r\nasync function backfillSupplierCategories() {\r\n  console.log('üîÑ Starting supplier categories backfill...');\r\n  \r\n  try {\r\n    const usersSnapshot = await db.collection('users')\r\n      .where('isSupplier', '==', true)\r\n      .get();\r\n    \r\n    let processed = 0;\r\n    let updated = 0;\r\n    const batch = db.batch();\r\n\r\n    for (const doc of usersSnapshot.docs) {\r\n      const data = doc.data();\r\n      const supplierCategories = data.supplierCategories || [];\r\n      const normalizedCategories = supplierCategories.map(toSlug).filter(Boolean);\r\n\r\n      if (JSON.stringify(normalizedCategories) !== JSON.stringify(supplierCategories)) {\r\n        const userRef = db.collection('users').doc(doc.id);\r\n        batch.update(userRef, { supplierCategories: normalizedCategories });\r\n        updated++;\r\n        console.log(`üìù Will update supplier ${doc.id}:`, {\r\n          from: supplierCategories,\r\n          to: normalizedCategories\r\n        });\r\n      }\r\n      processed++;\r\n\r\n      // Commit batch every 500 operations\r\n      if (updated > 0 && updated % 500 === 0) {\r\n        await batch.commit();\r\n        console.log(`‚úÖ Committed batch: ${updated} suppliers updated`);\r\n      }\r\n    }\r\n\r\n    // Commit remaining operations\r\n    if (updated > 0) {\r\n      await batch.commit();\r\n    }\r\n\r\n    console.log(`‚úÖ Supplier categories backfill completed: ${updated}/${processed} suppliers updated`);\r\n  } catch (error) {\r\n    console.error('‚ùå Error backfilling supplier categories:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Main backfill function\r\n */\r\nasync function main() {\r\n  console.log('üöÄ Starting category normalization backfill...');\r\n  console.log('This will normalize category names to slug format for all demands and suppliers.');\r\n  \r\n  const rl = readline.createInterface({\r\n    input: process.stdin,\r\n    output: process.stdout\r\n  });\r\n\r\n  const answer = await new Promise((resolve) => {\r\n    rl.question('Do you want to continue? (y/N): ', resolve);\r\n  });\r\n  \r\n  rl.close();\r\n\r\n  if (answer.toLowerCase() !== 'y' && answer.toLowerCase() !== 'yes') {\r\n    console.log('‚ùå Backfill cancelled by user');\r\n    process.exit(0);\r\n  }\r\n\r\n  try {\r\n    await backfillDemandCategories();\r\n    await backfillSupplierCategories();\r\n    console.log('üéâ All backfill operations completed successfully!');\r\n  } catch (error) {\r\n    console.error('üí• Backfill failed:', error);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// Run if called directly\r\nif (require.main === module) {\r\n  main().catch(console.error);\r\n}\r\n\r\nmodule.exports = {\r\n  backfillDemandCategories,\r\n  backfillSupplierCategories,\r\n  toSlug\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\backfill-satfk.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":27,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":27,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\r\n\r\n/**\r\n * Backfill script to generate SATFK for existing demands\r\n * Usage: node scripts/backfill-satfk.js\r\n */\r\n\r\nimport admin from 'firebase-admin';\r\nimport { readFileSync } from 'fs';\r\nimport { fileURLToPath } from 'url';\r\nimport { dirname, join } from 'path';\r\n\r\nconst __filename = fileURLToPath(import.meta.url);\r\nconst __dirname = dirname(__filename);\r\n\r\n// Initialize Firebase Admin\r\nif (!admin.apps.length) {\r\n  try {\r\n    // Try to use service account key if available\r\n    const serviceAccountPath = join(__dirname, '..', 'serviceAccountKey.json');\r\n    const serviceAccount = JSON.parse(readFileSync(serviceAccountPath, 'utf8'));\r\n    \r\n    admin.initializeApp({\r\n      credential: admin.credential.cert(serviceAccount),\r\n      projectId: 'teklifbul'\r\n    });\r\n  } catch (error) {\r\n    console.log('Service account key not found, using application default credentials');\r\n    admin.initializeApp({\r\n      credential: admin.credential.applicationDefault(),\r\n      projectId: 'teklifbul'\r\n    });\r\n  }\r\n}\r\n\r\nconst db = admin.firestore();\r\n\r\n/**\r\n * Generate SATFK for a demand\r\n * @param {Object} demandData - Demand document data\r\n * @param {string} demandId - Demand document ID\r\n * @returns {Promise<string>} Generated SATFK\r\n */\r\nasync function generateSATFK(demandData, demandId) {\r\n  try {\r\n    // Get creation date\r\n    let creationDate;\r\n    if (demandData.createdAt && demandData.createdAt.toDate) {\r\n      creationDate = demandData.createdAt.toDate();\r\n    } else if (demandData.createdAt && demandData.createdAt._seconds) {\r\n      creationDate = new Date(demandData.createdAt._seconds * 1000);\r\n    } else {\r\n      creationDate = new Date();\r\n    }\r\n\r\n    // Format date as YYYYMMDD\r\n    const dateStr = creationDate.toISOString().slice(0, 10).replace(/-/g, '');\r\n    \r\n    // Get daily counter\r\n    const counterRef = db.collection('counters').doc(`demandCode_${dateStr}`);\r\n    \r\n    const satfk = await db.runTransaction(async (transaction) => {\r\n      const counterDoc = await transaction.get(counterRef);\r\n      const currentCount = counterDoc.exists ? (counterDoc.data()?.count || 0) : 0;\r\n      const newCount = currentCount + 1;\r\n      \r\n      // Convert to Base36 and pad to 3-4 characters\r\n      const base36 = newCount.toString(36).toUpperCase();\r\n      const padded = base36.padStart(3, '0');\r\n      \r\n      // Update counter\r\n      transaction.set(counterRef, { count: newCount }, { merge: true });\r\n      \r\n      // Generate SATFK\r\n      return `SATFK-${dateStr}-${padded}`;\r\n    });\r\n\r\n    return satfk;\r\n  } catch (error) {\r\n    console.error(`Error generating SATFK for demand ${demandId}:`, error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Main backfill function\r\n */\r\nasync function backfillSATFK() {\r\n  console.log('üöÄ Starting SATFK backfill process...');\r\n  \r\n  try {\r\n    // Get all demands without SATFK (check for null, undefined, or empty string)\r\n    // Note: Firestore queries can't check for undefined or empty string, so we'll fetch all and filter\r\n    const demandsQuery = db.collection('demands');\r\n    const demandsSnap = await demandsQuery.get();\r\n    \r\n    // Filter demands without SATFK\r\n    const demandsWithoutSATFK = demandsSnap.docs.filter(doc => {\r\n      const data = doc.data();\r\n      return !data.satfk || data.satfk === '' || data.satfk === null;\r\n    });\r\n    \r\n    if (demandsWithoutSATFK.length === 0) {\r\n      console.log('‚úÖ No demands found without SATFK');\r\n      return;\r\n    }\r\n    \r\n    console.log(`üìä Found ${demandsWithoutSATFK.size || demandsWithoutSATFK.length} demands without SATFK (out of ${demandsSnap.size} total)`);\r\n    \r\n    const demands = demandsWithoutSATFK;\r\n    \r\n    let processed = 0;\r\n    let errors = 0;\r\n    \r\n    // Process demands in batches\r\n    const batchSize = 10;\r\n    \r\n    for (let i = 0; i < demands.length; i += batchSize) {\r\n      const batch = demands.slice(i, i + batchSize);\r\n      \r\n      console.log(`üì¶ Processing batch ${Math.floor(i / batchSize) + 1}/${Math.ceil(demands.length / batchSize)}`);\r\n      \r\n      const promises = batch.map(async (doc) => {\r\n        try {\r\n          const demandData = doc.data();\r\n          const demandId = doc.id;\r\n          \r\n          // Skip if SATFK already exists\r\n          if (demandData.satfk) {\r\n            console.log(`‚è≠Ô∏è  Skipping demand ${demandId} - already has SATFK: ${demandData.satfk}`);\r\n            return;\r\n          }\r\n          \r\n          // Generate SATFK\r\n          const satfk = await generateSATFK(demandData, demandId);\r\n          \r\n          // Update demand with SATFK\r\n          await doc.ref.update({ satfk });\r\n          \r\n          console.log(`‚úÖ Updated demand ${demandId} with SATFK: ${satfk}`);\r\n          processed++;\r\n          \r\n        } catch (error) {\r\n          console.error(`‚ùå Error processing demand ${doc.id}:`, error);\r\n          errors++;\r\n        }\r\n      });\r\n      \r\n      await Promise.all(promises);\r\n      \r\n      // Small delay between batches to avoid overwhelming Firestore\r\n      if (i + batchSize < demands.length) {\r\n        await new Promise(resolve => setTimeout(resolve, 100));\r\n      }\r\n    }\r\n    \r\n    console.log('üéâ Backfill completed!');\r\n    console.log(`üìä Processed: ${processed} demands`);\r\n    console.log(`‚ùå Errors: ${errors} demands`);\r\n    \r\n  } catch (error) {\r\n    console.error('üí• Backfill failed:', error);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// Run the backfill\r\nbackfillSATFK()\r\n  .then(() => {\r\n    console.log('‚úÖ Backfill script completed successfully');\r\n    process.exit(0);\r\n  })\r\n  .catch((error) => {\r\n    console.error('üí• Backfill script failed:', error);\r\n    process.exit(1);\r\n  });\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\build-il-ilce.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\build-mahalle.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\build-mahalle.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":4,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":4,"endColumn":29}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// scripts/build-mahalle.js\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst xlsx = require('xlsx');\r\n\r\nconst SRC = path.resolve(__dirname, '../data/Mahalle_Listesi.xls');\r\nconst OUTDIR = path.resolve(__dirname, '../public/assets/mahalle/');\r\n\r\nfunction slugTR(s) {\r\n  return String(s ?? '')\r\n    .trim()\r\n    .replace(/[ƒ±ƒ∞]/g, 'I')\r\n    .replace(/[≈ü≈û]/g, 'S')\r\n    .replace(/[ƒüƒû]/g, 'G')\r\n    .replace(/[√º√ú]/g, 'U')\r\n    .replace(/[√∂√ñ]/g, 'O')\r\n    .replace(/[√ß√á]/g, 'C')\r\n    .replace(/\\s+/g, '_')\r\n    .replace(/[^\\w]/g, '')\r\n    .toUpperCase();\r\n}\r\n\r\nfunction toTitle(s){\r\n  s = String(s ?? '').trim();\r\n  return s.charAt(0).toLocaleUpperCase('tr') + s.slice(1).toLocaleLowerCase('tr');\r\n}\r\n\r\n(function build(){\r\n  if (!fs.existsSync(SRC)) {\r\n    console.error('Excel bulunamadƒ±:', SRC);\r\n    process.exit(1);\r\n  }\r\n  const wb = xlsx.readFile(SRC);\r\n  const ws = wb.Sheets[wb.SheetNames[0]];\r\n  const rows = xlsx.utils.sheet_to_json(ws, { header: 1, raw: false });\r\n\r\n  // ['il', 'ilce', 'mahalle']\r\n  const header = rows[0].map(h => (h || '').toLowerCase());\r\n  const ilIdx = header.indexOf('il');\r\n  const ilceIdx = header.indexOf('ilce');\r\n  const mahalleIdx = header.indexOf('mahalle');\r\n  if (ilIdx < 0 || ilceIdx < 0 || mahalleIdx < 0)\r\n    throw new Error('Excel ba≈ülƒ±klarƒ± beklenmiyor!');\r\n\r\n  const mahByDistrict = {};\r\n\r\n  for (const r of rows.slice(1)) {\r\n    const il = r[ilIdx], ilce = r[ilceIdx], mahalle = r[mahalleIdx];\r\n    if (!(il && ilce && mahalle)) continue;\r\n    const districtId = slugTR(il) + '__' + slugTR(ilce);\r\n    if (!mahByDistrict[districtId]) {\r\n      mahByDistrict[districtId] = {\r\n        districtId,\r\n        districtName: toTitle(ilce),\r\n        neighborhoods: []\r\n      };\r\n    }\r\n    mahByDistrict[districtId].neighborhoods.push({\r\n      id: slugTR(mahalle),\r\n      name: toTitle(mahalle)\r\n    });\r\n  }\r\n\r\n  fs.mkdirSync(OUTDIR, { recursive: true });\r\n  for (const districtId in mahByDistrict) {\r\n    const entry = mahByDistrict[districtId];\r\n    const outPath = path.join(OUTDIR, `${districtId}.json`);\r\n    fs.writeFileSync(outPath, JSON.stringify(entry, null, 2), 'utf8');\r\n    console.log(`‚úÖ ${outPath} (${entry.neighborhoods.length}) mahalle`);\r\n  }\r\n})();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\fetch-streets-beykoz.cjs","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":25,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":25,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'provinceName' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":36,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":36,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// scripts/fetch-streets-beykoz.cjs\r\n// Fetch streets for all neighborhoods of ISTANBUL__BEYKOZ and save to public/assets/sokak/\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst fetch = require('node-fetch');\r\n\r\nconst MAHALLE_FILE = path.resolve('./public/assets/mahalle/ISTANBUL__BEYKOZ.json');\r\nconst OUT_DIR = path.resolve('./public/assets/sokak');\r\n\r\nconst sleep = (ms) => new Promise(r => setTimeout(r, ms));\r\n\r\nfunction slugTR(s){\r\n  const map = { 'ƒ±':'i','ƒ∞':'i','≈ü':'s','≈û':'s','ƒü':'g','ƒû':'g','√º':'u','√ú':'u','√∂':'o','√ñ':'o','√ß':'c','√á':'c' };\r\n  s = String(s ?? '').trim();\r\n  s = s.replace(/[ƒ±ƒ∞≈ü≈ûƒüƒû√º√ú√∂√ñ√ß√á]/g, ch => map[ch]);\r\n  s = s.replace(/\\s+/g, '_').replace(/[^\\w]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g,'');\r\n  return s.toUpperCase();\r\n}\r\n\r\nasync function safeFetchJSON(url){\r\n  try{\r\n    const r = await fetch(url, { headers: { 'accept':'application/json' } });\r\n    if (!r.ok) return { data: [] };\r\n    return await r.json();\r\n  }catch(e){ return { data: [] }; }\r\n}\r\n\r\nasync function main(){\r\n  if (!fs.existsSync(MAHALLE_FILE)){\r\n    console.error('Mahalle dosyasƒ± yok:', MAHALLE_FILE);\r\n    process.exit(1);\r\n  }\r\n  if (!fs.existsSync(OUT_DIR)) fs.mkdirSync(OUT_DIR, { recursive: true });\r\n\r\n  const j = JSON.parse(fs.readFileSync(MAHALLE_FILE, 'utf8'));\r\n  const provinceName = 'ƒ∞stanbul';\r\n  const districtName = 'Beykoz';\r\n  const districtId = 'ISTANBUL__BEYKOZ';\r\n  const neighborhoods = Array.isArray(j.neighborhoods) ? j.neighborhoods : [];\r\n  let saved = 0, empty = 0;\r\n  for (const n of neighborhoods){\r\n    const nId = n.id || slugTR(n.name);\r\n    const outFile = path.join(OUT_DIR, `${districtId}_mah-${nId}.json`);\r\n    if (fs.existsSync(outFile)) continue;\r\n    const url = `https://api.turkiyeapi.dev/v1/streets?district=${encodeURIComponent(districtName)}&neighborhood=${encodeURIComponent(n.name)}`;\r\n    const { data } = await safeFetchJSON(url);\r\n    const streets = (Array.isArray(data)? data:[]).map(s=>({ id: slugTR(s.name), name: s.name }));\r\n    if (streets.length){\r\n      const payload = { districtId, districtName, neighborhoodId: nId, neighborhoodName: n.name, streets };\r\n      fs.writeFileSync(outFile, JSON.stringify(payload, null, 2), 'utf8');\r\n      saved++;\r\n      console.log('‚úÖ yazƒ±ldƒ±:', path.basename(outFile), `(${streets.length})`);\r\n    } else {\r\n      empty++;\r\n      console.log('‚ö†Ô∏è bo≈ü:', n.name);\r\n    }\r\n    await sleep(150);\r\n  }\r\n  console.log(`\\nBitti. Kaydedilen mahalle dosyasƒ±: ${saved}, bo≈ü: ${empty}`);\r\n}\r\n\r\nmain().catch(e=>{ console.error(e); process.exit(1); });\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\fix-company-join-requests.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'query' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":36,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":41},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'where' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":43,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":48},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":61,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2055,2058],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2055,2058],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Bekleyen ≈üirket katƒ±lƒ±m isteklerini d√ºzelt\r\n * - userId eksik olan kayƒ±tlarƒ± d√ºzeltir\r\n * - requesterUserId varsa userId'ye kopyalar\r\n * - Eksik bilgileri doldurur\r\n */\r\n\r\nimport { initializeApp } from 'firebase/app';\r\nimport { getFirestore, collection, query, where, getDocs, updateDoc, doc, getDoc } from 'firebase/firestore';\r\nimport * as dotenv from 'dotenv';\r\n\r\ndotenv.config();\r\n\r\nconst firebaseConfig = {\r\n  apiKey: process.env.VITE_FIREBASE_API_KEY,\r\n  authDomain: process.env.VITE_FIREBASE_AUTH_DOMAIN,\r\n  projectId: process.env.VITE_FIREBASE_PROJECT_ID,\r\n  storageBucket: process.env.VITE_FIREBASE_STORAGE_BUCKET,\r\n  messagingSenderId: process.env.VITE_FIREBASE_MESSAGING_SENDER_ID,\r\n  appId: process.env.VITE_FIREBASE_APP_ID\r\n};\r\n\r\nconst app = initializeApp(firebaseConfig);\r\nconst db = getFirestore(app);\r\n\r\nasync function fixCompanyJoinRequests() {\r\n  try {\r\n    console.log('üîß Bekleyen ≈üirket katƒ±lƒ±m istekleri d√ºzeltiliyor...\\n');\r\n\r\n    // T√ºm bekleyen istekleri bul (status kontrol√º olmadan, t√ºm kayƒ±tlarƒ± √ßek)\r\n    // Bazƒ± kayƒ±tlarda status alanƒ± olmayabilir veya farklƒ± formatta olabilir\r\n    const requestsRef = collection(db, 'companyJoinRequests');\r\n    const requestsSnapshot = await getDocs(requestsRef);\r\n\r\n    if (requestsSnapshot.empty) {\r\n      console.log('‚úÖ Bekleyen istek bulunamadƒ±.');\r\n      return;\r\n    }\r\n\r\n    console.log(`üìã Toplam ${requestsSnapshot.size} bekleyen istek bulundu.\\n`);\r\n\r\n    let fixedCount = 0;\r\n    let skippedCount = 0;\r\n    let errorCount = 0;\r\n\r\n    for (const requestDoc of requestsSnapshot.docs) {\r\n      const requestId = requestDoc.id;\r\n      const requestData = requestDoc.data();\r\n\r\n      try {\r\n        // Status kontrol√º - pending olmayanlarƒ± atla\r\n        const status = requestData.status;\r\n        if (status && status !== 'pending') {\r\n          console.log(`‚ÑπÔ∏è ${requestId}: Status '${status}', atlanƒ±yor`);\r\n          continue;\r\n        }\r\n\r\n        // userId kontrol√º\r\n        let userId = requestData.userId;\r\n        let needsUpdate = false;\r\n        const updateData: any = {};\r\n\r\n        // Eƒüer userId yoksa, requesterUserId'yi kullan\r\n        if (!userId || typeof userId !== 'string' || userId.trim() === '') {\r\n          if (requestData.requesterUserId && typeof requestData.requesterUserId === 'string') {\r\n            userId = requestData.requesterUserId;\r\n            updateData.userId = userId;\r\n            needsUpdate = true;\r\n            console.log(`‚úÖ ${requestId}: requesterUserId ‚Üí userId kopyalandƒ±: ${userId}`);\r\n          } else {\r\n            console.warn(`‚ö†Ô∏è ${requestId}: userId ve requesterUserId bulunamadƒ±, atlanƒ±yor`);\r\n            skippedCount++;\r\n            continue;\r\n          }\r\n        }\r\n\r\n        // Kullanƒ±cƒ± bilgilerini kontrol et ve eksikleri doldur\r\n        let userEmail = requestData.userEmail;\r\n        let userDisplayName = requestData.userDisplayName || requestData.displayName;\r\n\r\n        if (userId) {\r\n          try {\r\n            const userDoc = await getDoc(doc(db, 'users', userId));\r\n            if (userDoc.exists()) {\r\n              const userData = userDoc.data();\r\n              \r\n              // Email eksikse kullanƒ±cƒ±dan al\r\n              if (!userEmail || userEmail === 'E-posta bulunamadƒ±') {\r\n                const userEmailFromDoc = userData.email || userData.userEmail;\r\n                if (userEmailFromDoc) {\r\n                  updateData.userEmail = userEmailFromDoc;\r\n                  userEmail = userEmailFromDoc;\r\n                  needsUpdate = true;\r\n                  console.log(`‚úÖ ${requestId}: Email d√ºzeltildi: ${userEmailFromDoc}`);\r\n                }\r\n              }\r\n\r\n              // Display name eksikse kullanƒ±cƒ±dan al\r\n              if (!userDisplayName) {\r\n                const userDisplayNameFromDoc = userData.displayName || userData.name;\r\n                if (userDisplayNameFromDoc) {\r\n                  updateData.userDisplayName = userDisplayNameFromDoc;\r\n                  userDisplayName = userDisplayNameFromDoc;\r\n                  needsUpdate = true;\r\n                  console.log(`‚úÖ ${requestId}: Display name d√ºzeltildi: ${userDisplayNameFromDoc}`);\r\n                }\r\n              }\r\n            } else {\r\n              console.warn(`‚ö†Ô∏è ${requestId}: Kullanƒ±cƒ± bulunamadƒ± (userId: ${userId})`);\r\n            }\r\n          } catch (userError) {\r\n            console.warn(`‚ö†Ô∏è ${requestId}: Kullanƒ±cƒ± bilgileri alƒ±nƒ±rken hata:`, userError);\r\n          }\r\n        }\r\n\r\n        // Rol bilgilerini kontrol et\r\n        let requestedRole = requestData.requestedRole;\r\n        let requestedCompanyRole = requestData.requestedCompanyRole;\r\n\r\n        // Eƒüer requestedRole yoksa, role objesinden √ßƒ±kar\r\n        if (!requestedRole && requestData.role) {\r\n          if (typeof requestData.role === 'string') {\r\n            requestedRole = requestData.role;\r\n            updateData.requestedRole = requestedRole;\r\n            needsUpdate = true;\r\n            console.log(`‚úÖ ${requestId}: requestedRole d√ºzeltildi: ${requestedRole}`);\r\n          } else if (typeof requestData.role === 'object') {\r\n            // Role objesi varsa, buyer veya supplier kontrol√º yap\r\n            const roleObj = requestData.role;\r\n            if (roleObj.supplier) {\r\n              requestedRole = 'supplier';\r\n            } else if (roleObj.buyer) {\r\n              requestedRole = 'buyer';\r\n            } else {\r\n              requestedRole = 'buyer'; // Varsayƒ±lan\r\n            }\r\n            updateData.requestedRole = requestedRole;\r\n            needsUpdate = true;\r\n            console.log(`‚úÖ ${requestId}: requestedRole objeden √ßƒ±karƒ±ldƒ±: ${requestedRole}`);\r\n          }\r\n        }\r\n\r\n        // requestedCompanyRole eksikse, requestedRole'dan olu≈ütur\r\n        if (!requestedCompanyRole && requestedRole) {\r\n          // Basit format (supplier/buyer) ise, detaylƒ± formata √ßevir\r\n          if (requestedRole === 'supplier') {\r\n            requestedCompanyRole = 'supplier:tedarikci';\r\n          } else if (requestedRole === 'buyer') {\r\n            requestedCompanyRole = 'buyer:satinalma_yetkilisi';\r\n          } else {\r\n            requestedCompanyRole = requestedRole;\r\n          }\r\n          updateData.requestedCompanyRole = requestedCompanyRole;\r\n          needsUpdate = true;\r\n          console.log(`‚úÖ ${requestId}: requestedCompanyRole olu≈üturuldu: ${requestedCompanyRole}`);\r\n        }\r\n\r\n        // companyCode eksikse, companyId'den ≈üirket bilgilerini al\r\n        if (!requestData.companyCode && requestData.companyId) {\r\n          try {\r\n            const companyDoc = await getDoc(doc(db, 'companies', requestData.companyId));\r\n            if (companyDoc.exists()) {\r\n              const companyData = companyDoc.data();\r\n              if (companyData.code) {\r\n                updateData.companyCode = companyData.code;\r\n                needsUpdate = true;\r\n                console.log(`‚úÖ ${requestId}: companyCode d√ºzeltildi: ${companyData.code}`);\r\n              }\r\n            }\r\n          } catch (companyError) {\r\n            console.warn(`‚ö†Ô∏è ${requestId}: ≈ûirket bilgileri alƒ±nƒ±rken hata:`, companyError);\r\n          }\r\n        }\r\n\r\n        // G√ºncelleme yap\r\n        if (needsUpdate) {\r\n          await updateDoc(doc(db, 'companyJoinRequests', requestId), updateData);\r\n          fixedCount++;\r\n          console.log(`‚úÖ ${requestId}: Kayƒ±t d√ºzeltildi\\n`);\r\n        } else {\r\n          console.log(`‚ÑπÔ∏è ${requestId}: D√ºzeltme gerekmiyor\\n`);\r\n        }\r\n\r\n      } catch (error) {\r\n        console.error(`‚ùå ${requestId}: Hata:`, error);\r\n        errorCount++;\r\n      }\r\n    }\r\n\r\n    console.log('\\nüìä √ñZET:');\r\n    console.log(`‚úÖ D√ºzeltilen: ${fixedCount}`);\r\n    console.log(`‚ö†Ô∏è Atlanan: ${skippedCount}`);\r\n    console.log(`‚ùå Hata: ${errorCount}`);\r\n    console.log(`üìã Toplam: ${requestsSnapshot.size}`);\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Genel hata:', error);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// Script'i √ßalƒ±≈ütƒ±r\r\nfixCompanyJoinRequests()\r\n  .then(() => {\r\n    console.log('\\n‚úÖ ƒ∞≈ülem tamamlandƒ±!');\r\n    process.exit(0);\r\n  })\r\n  .catch((error) => {\r\n    console.error('‚ùå Script hatasƒ±:', error);\r\n    process.exit(1);\r\n  });\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\fix-test-user-requests.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'emailQueryError' is defined but never used.","line":46,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":46,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":140,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":140,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4300,4303],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4300,4303],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * teklifbulalici@gmail.com kullanƒ±cƒ±sƒ±nƒ±n ≈üirketi i√ßin\r\n * bekleyen isteklerdeki eksik bilgileri d√ºzelt ve test ama√ßlƒ± doldur\r\n */\r\n\r\nimport { initializeApp } from 'firebase/app';\r\nimport { getFirestore, collection, query, where, getDocs, updateDoc, doc, getDoc } from 'firebase/firestore';\r\nimport * as dotenv from 'dotenv';\r\n\r\ndotenv.config();\r\n\r\nconst firebaseConfig = {\r\n  apiKey: process.env.VITE_FIREBASE_API_KEY,\r\n  authDomain: process.env.VITE_FIREBASE_AUTH_DOMAIN,\r\n  projectId: process.env.VITE_FIREBASE_PROJECT_ID,\r\n  storageBucket: process.env.VITE_FIREBASE_STORAGE_BUCKET,\r\n  messagingSenderId: process.env.VITE_FIREBASE_MESSAGING_SENDER_ID,\r\n  appId: process.env.VITE_FIREBASE_APP_ID\r\n};\r\n\r\nconst app = initializeApp(firebaseConfig);\r\nconst db = getFirestore(app);\r\n\r\nasync function fixTestUserRequests() {\r\n  try {\r\n    console.log('üîß teklifbulalici@gmail.com ≈üirketi i√ßin bekleyen istekler d√ºzeltiliyor...\\n');\r\n\r\n    // √ñnce kullanƒ±cƒ±yƒ± bul - email ile sorgu √ßalƒ±≈ümƒ±yorsa t√ºm kullanƒ±cƒ±larƒ± kontrol et\r\n    let userDoc = null;\r\n    let userData = null;\r\n    let companyId = null;\r\n    \r\n    try {\r\n      const usersQuery = query(\r\n        collection(db, 'users'),\r\n        where('email', '==', 'teklifbulalici@gmail.com')\r\n      );\r\n      \r\n      const usersSnapshot = await getDocs(usersQuery);\r\n      \r\n      if (!usersSnapshot.empty) {\r\n        userDoc = usersSnapshot.docs[0];\r\n        userData = userDoc.data();\r\n        companyId = userData.companyId || (userData.companies && userData.companies[0]);\r\n      }\r\n    } catch (emailQueryError) {\r\n      console.warn('‚ö†Ô∏è Email sorgusu ba≈üarƒ±sƒ±z, t√ºm kullanƒ±cƒ±lar kontrol ediliyor...');\r\n      \r\n      // T√ºm kullanƒ±cƒ±larƒ± √ßek ve email ile filtrele\r\n      const allUsersSnapshot = await getDocs(collection(db, 'users'));\r\n      for (const docSnap of allUsersSnapshot.docs) {\r\n        const data = docSnap.data();\r\n        if (data.email === 'teklifbulalici@gmail.com') {\r\n          userDoc = docSnap;\r\n          userData = data;\r\n          companyId = data.companyId || (data.companies && data.companies[0]);\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    \r\n    if (!userDoc || !userData) {\r\n      console.log('‚ùå teklifbulalici@gmail.com kullanƒ±cƒ±sƒ± bulunamadƒ±.');\r\n      return;\r\n    }\r\n    \r\n    if (!companyId) {\r\n      console.log('‚ùå ≈ûirket bilgisi bulunamadƒ±.');\r\n      return;\r\n    }\r\n    \r\n    if (!companyId) {\r\n      console.log('‚ùå ≈ûirket bilgisi bulunamadƒ±.');\r\n      return;\r\n    }\r\n    \r\n    console.log(`‚úÖ Kullanƒ±cƒ± bulundu: ${userDoc.id}`);\r\n    console.log(`‚úÖ ≈ûirket ID: ${companyId}\\n`);\r\n    \r\n    // ≈ûirket bilgilerini al\r\n    const companyDoc = await getDoc(doc(db, 'companies', companyId));\r\n    if (!companyDoc.exists()) {\r\n      console.log('‚ùå ≈ûirket bulunamadƒ±.');\r\n      return;\r\n    }\r\n    \r\n    const companyData = companyDoc.data();\r\n    const companyCode = companyData.code;\r\n    \r\n    if (!companyCode) {\r\n      console.log('‚ùå ≈ûirket kodu bulunamadƒ±.');\r\n      return;\r\n    }\r\n    \r\n    console.log(`‚úÖ ≈ûirket kodu: ${companyCode}\\n`);\r\n    \r\n    // Bu ≈üirkete ait bekleyen istekleri bul\r\n    const requestsQuery = query(\r\n      collection(db, 'companyJoinRequests'),\r\n      where('companyCode', '==', companyCode),\r\n      where('status', '==', 'pending')\r\n    );\r\n    \r\n    const requestsSnapshot = await getDocs(requestsQuery);\r\n    \r\n    if (requestsSnapshot.empty) {\r\n      console.log('‚úÖ Bekleyen istek bulunamadƒ±.');\r\n      return;\r\n    }\r\n    \r\n    console.log(`üìã Toplam ${requestsSnapshot.size} bekleyen istek bulundu.\\n`);\r\n    \r\n    let fixedCount = 0;\r\n    let skippedCount = 0;\r\n    let errorCount = 0;\r\n    \r\n    // Test ama√ßlƒ± email listesi (sƒ±rayla kullanƒ±lacak)\r\n    const testEmails = [\r\n      'test1@example.com',\r\n      'test2@example.com',\r\n      'test3@example.com',\r\n      'test4@example.com',\r\n      'test5@example.com',\r\n      'test6@example.com',\r\n      'test7@example.com',\r\n      'test8@example.com',\r\n      'test9@example.com',\r\n      'test10@example.com'\r\n    ];\r\n    \r\n    let emailIndex = 0;\r\n    \r\n    for (const requestDoc of requestsSnapshot.docs) {\r\n      const requestId = requestDoc.id;\r\n      const requestData = requestDoc.data();\r\n      \r\n      try {\r\n        let userId = requestData.userId;\r\n        let needsUpdate = false;\r\n        const updateData: any = {};\r\n        \r\n        // Eƒüer userId yoksa, requesterUserId'yi kullan\r\n        if (!userId || typeof userId !== 'string' || userId.trim() === '') {\r\n          if (requestData.requesterUserId && typeof requestData.requesterUserId === 'string') {\r\n            userId = requestData.requesterUserId;\r\n            updateData.userId = userId;\r\n            needsUpdate = true;\r\n            console.log(`‚úÖ ${requestId}: requesterUserId ‚Üí userId kopyalandƒ±: ${userId}`);\r\n          } else {\r\n            console.warn(`‚ö†Ô∏è ${requestId}: userId ve requesterUserId bulunamadƒ±, atlanƒ±yor`);\r\n            skippedCount++;\r\n            continue;\r\n          }\r\n        }\r\n        \r\n        // Kullanƒ±cƒ± bilgilerini kontrol et ve eksikleri doldur\r\n        let userEmail = requestData.userEmail;\r\n        let userDisplayName = requestData.userDisplayName || requestData.displayName;\r\n        \r\n        if (userId) {\r\n          try {\r\n            const userDocForRequest = await getDoc(doc(db, 'users', userId));\r\n            if (userDocForRequest.exists()) {\r\n              const userDataForRequest = userDocForRequest.data();\r\n              \r\n              // Email eksikse kullanƒ±cƒ±dan al veya test email kullan\r\n              if (!userEmail || userEmail === 'E-posta bulunamadƒ±') {\r\n                const userEmailFromDoc = userDataForRequest.email || userDataForRequest.userEmail;\r\n                if (userEmailFromDoc) {\r\n                  updateData.userEmail = userEmailFromDoc;\r\n                  userEmail = userEmailFromDoc;\r\n                  needsUpdate = true;\r\n                  console.log(`‚úÖ ${requestId}: Email kullanƒ±cƒ±dan alƒ±ndƒ±: ${userEmailFromDoc}`);\r\n                } else if (emailIndex < testEmails.length) {\r\n                  // Test ama√ßlƒ± email kullan\r\n                  updateData.userEmail = testEmails[emailIndex];\r\n                  userEmail = testEmails[emailIndex];\r\n                  emailIndex++;\r\n                  needsUpdate = true;\r\n                  console.log(`‚úÖ ${requestId}: Test email eklendi: ${testEmails[emailIndex - 1]}`);\r\n                }\r\n              }\r\n              \r\n              // Display name eksikse kullanƒ±cƒ±dan al veya test name olu≈ütur\r\n              if (!userDisplayName) {\r\n                const userDisplayNameFromDoc = userDataForRequest.displayName || userDataForRequest.name;\r\n                if (userDisplayNameFromDoc) {\r\n                  updateData.userDisplayName = userDisplayNameFromDoc;\r\n                  userDisplayName = userDisplayNameFromDoc;\r\n                  needsUpdate = true;\r\n                  console.log(`‚úÖ ${requestId}: Display name kullanƒ±cƒ±dan alƒ±ndƒ±: ${userDisplayNameFromDoc}`);\r\n                } else {\r\n                  // Test ama√ßlƒ± display name olu≈ütur\r\n                  const testName = `Test Kullanƒ±cƒ± ${emailIndex}`;\r\n                  updateData.userDisplayName = testName;\r\n                  userDisplayName = testName;\r\n                  needsUpdate = true;\r\n                  console.log(`‚úÖ ${requestId}: Test display name eklendi: ${testName}`);\r\n                }\r\n              }\r\n            } else {\r\n              console.warn(`‚ö†Ô∏è ${requestId}: Kullanƒ±cƒ± bulunamadƒ± (userId: ${userId})`);\r\n              // Kullanƒ±cƒ± yoksa test email ve name ekle\r\n              if (!userEmail || userEmail === 'E-posta bulunamadƒ±') {\r\n                if (emailIndex < testEmails.length) {\r\n                  updateData.userEmail = testEmails[emailIndex];\r\n                  emailIndex++;\r\n                  needsUpdate = true;\r\n                  console.log(`‚úÖ ${requestId}: Test email eklendi (kullanƒ±cƒ± yok): ${testEmails[emailIndex - 1]}`);\r\n                }\r\n              }\r\n              if (!userDisplayName) {\r\n                const testName = `Test Kullanƒ±cƒ± ${emailIndex}`;\r\n                updateData.userDisplayName = testName;\r\n                needsUpdate = true;\r\n                console.log(`‚úÖ ${requestId}: Test display name eklendi (kullanƒ±cƒ± yok): ${testName}`);\r\n              }\r\n            }\r\n          } catch (userError) {\r\n            console.warn(`‚ö†Ô∏è ${requestId}: Kullanƒ±cƒ± bilgileri alƒ±nƒ±rken hata:`, userError);\r\n          }\r\n        }\r\n        \r\n        // Rol bilgilerini kontrol et\r\n        let requestedRole = requestData.requestedRole;\r\n        let requestedCompanyRole = requestData.requestedCompanyRole;\r\n        \r\n        // Eƒüer requestedRole yoksa, role objesinden √ßƒ±kar\r\n        if (!requestedRole && requestData.role) {\r\n          if (typeof requestData.role === 'string') {\r\n            requestedRole = requestData.role;\r\n            updateData.requestedRole = requestedRole;\r\n            needsUpdate = true;\r\n            console.log(`‚úÖ ${requestId}: requestedRole d√ºzeltildi: ${requestedRole}`);\r\n          } else if (typeof requestData.role === 'object') {\r\n            const roleObj = requestData.role;\r\n            if (roleObj.supplier) {\r\n              requestedRole = 'supplier';\r\n            } else if (roleObj.buyer) {\r\n              requestedRole = 'buyer';\r\n            } else {\r\n              requestedRole = 'buyer'; // Varsayƒ±lan\r\n            }\r\n            updateData.requestedRole = requestedRole;\r\n            needsUpdate = true;\r\n            console.log(`‚úÖ ${requestId}: requestedRole objeden √ßƒ±karƒ±ldƒ±: ${requestedRole}`);\r\n          }\r\n        }\r\n        \r\n        // requestedCompanyRole eksikse, requestedRole'dan olu≈ütur\r\n        if (!requestedCompanyRole && requestedRole) {\r\n          if (requestedRole === 'supplier') {\r\n            requestedCompanyRole = 'supplier:tedarikci';\r\n          } else if (requestedRole === 'buyer') {\r\n            requestedCompanyRole = 'buyer:satinalma_yetkilisi';\r\n          } else {\r\n            requestedCompanyRole = requestedRole;\r\n          }\r\n          updateData.requestedCompanyRole = requestedCompanyRole;\r\n          needsUpdate = true;\r\n          console.log(`‚úÖ ${requestId}: requestedCompanyRole olu≈üturuldu: ${requestedCompanyRole}`);\r\n        }\r\n        \r\n        // companyCode eksikse ekle\r\n        if (!requestData.companyCode) {\r\n          updateData.companyCode = companyCode;\r\n          needsUpdate = true;\r\n          console.log(`‚úÖ ${requestId}: companyCode eklendi: ${companyCode}`);\r\n        }\r\n        \r\n        // G√ºncelleme yap\r\n        if (needsUpdate) {\r\n          await updateDoc(doc(db, 'companyJoinRequests', requestId), updateData);\r\n          fixedCount++;\r\n          console.log(`‚úÖ ${requestId}: Kayƒ±t d√ºzeltildi\\n`);\r\n        } else {\r\n          console.log(`‚ÑπÔ∏è ${requestId}: D√ºzeltme gerekmiyor\\n`);\r\n        }\r\n        \r\n      } catch (error) {\r\n        console.error(`‚ùå ${requestId}: Hata:`, error);\r\n        errorCount++;\r\n      }\r\n    }\r\n    \r\n    console.log('\\nüìä √ñZET:');\r\n    console.log(`‚úÖ D√ºzeltilen: ${fixedCount}`);\r\n    console.log(`‚ö†Ô∏è Atlanan: ${skippedCount}`);\r\n    console.log(`‚ùå Hata: ${errorCount}`);\r\n    console.log(`üìã Toplam: ${requestsSnapshot.size}`);\r\n    \r\n  } catch (error) {\r\n    console.error('‚ùå Genel hata:', error);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// Script'i √ßalƒ±≈ütƒ±r\r\nfixTestUserRequests()\r\n  .then(() => {\r\n    console.log('\\n‚úÖ ƒ∞≈ülem tamamlandƒ±!');\r\n    process.exit(0);\r\n  })\r\n  .catch((error) => {\r\n    console.error('‚ùå Script hatasƒ±:', error);\r\n    process.exit(1);\r\n  });\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\import-countries.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":23,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":23,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\r\n\r\n/**\r\n * Import world countries into Firestore: countries/{autoId} -> { name }\r\n * Data source: https://restcountries.com/v3.1/all?fields=name\r\n * Turkey should appear as \"T√ºrkiye\" and be preferred.\r\n * Usage: node scripts/import-countries.js\r\n */\r\n\r\nimport admin from 'firebase-admin';\r\nimport { readFileSync } from 'fs';\r\nimport { fileURLToPath } from 'url';\r\nimport { dirname, join } from 'path';\r\n\r\nconst __filename = fileURLToPath(import.meta.url);\r\nconst __dirname = dirname(__filename);\r\n\r\nif (!admin.apps.length) {\r\n  try {\r\n    const serviceAccountPath = join(__dirname, '..', 'serviceAccountKey.json');\r\n    const serviceAccount = JSON.parse(readFileSync(serviceAccountPath, 'utf8'));\r\n    admin.initializeApp({ credential: admin.credential.cert(serviceAccount) });\r\n  } catch (e) {\r\n    console.log('Service account not found, using application default credentials');\r\n    admin.initializeApp({ credential: admin.credential.applicationDefault() });\r\n  }\r\n}\r\n\r\nconst db = admin.firestore();\r\n\r\nasync function robustFetch(url) {\r\n  if (typeof fetch === 'function') {\r\n    const r = await fetch(url);\r\n    if (!r.ok) throw new Error(`HTTP ${r.status}`);\r\n    return await r.json();\r\n  }\r\n  const https = await import('node:https');\r\n  return await new Promise((resolve, reject) => {\r\n    https.default.get(url, (res) => {\r\n      if (res.statusCode !== 200) return reject(new Error(`HTTP ${res.statusCode}`));\r\n      let data = '';\r\n      res.on('data', (c) => (data += c));\r\n      res.on('end', () => {\r\n        try { resolve(JSON.parse(data)); } catch (e) { reject(e); }\r\n      });\r\n    }).on('error', reject);\r\n  });\r\n}\r\n\r\nfunction toTRName(entry) {\r\n  const common = entry?.name?.common || '';\r\n  // Map Turkey explicitly\r\n  if (common === 'Turkey') return 'T√ºrkiye';\r\n  // Prefer Turkish translation if present\r\n  const tur = entry?.translations?.tur?.common || entry?.translations?.tur?.official;\r\n  return (tur || common || '').trim();\r\n}\r\n\r\nasync function main() {\r\n  console.log('üîÑ Fetching countries dataset...');\r\n  const url = 'https://restcountries.com/v3.1/all?fields=name,translations';\r\n  const data = await robustFetch(url);\r\n  if (!Array.isArray(data)) throw new Error('Unexpected dataset shape');\r\n\r\n  const names = data.map(toTRName).filter(Boolean);\r\n  const unique = Array.from(new Set(names)).sort((a,b)=> a.localeCompare(b,'tr'));\r\n\r\n  console.log(`üì¶ Countries: ${unique.length}`);\r\n\r\n  // Clear existing (optional) ‚Äî skip to be idempotent\r\n  let added = 0;\r\n  const batch = db.batch();\r\n  unique.forEach((name) => {\r\n    const ref = db.collection('countries').doc(name);\r\n    batch.set(ref, { name, isPreferred: name === 'T√ºrkiye' });\r\n    added++;\r\n  });\r\n  await batch.commit();\r\n  console.log(`‚úÖ Upserted ${added} countries`);\r\n}\r\n\r\nmain().then(()=>process.exit(0)).catch((e)=>{ console.error('‚ùå Import failed:', e); process.exit(1); });\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\import-tr-districts.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":23,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":23,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\r\n\r\n/**\r\n * Import Turkey provinces/districts into Firestore: trDistricts/{province} -> { districts: string[] }\r\n * Data source: https://raw.githubusercontent.com/muhammederdem/il-ilce-json/master/il-ilce.json\r\n * Usage: node scripts/import-tr-districts.js\r\n */\r\n\r\nimport admin from 'firebase-admin';\r\nimport { readFileSync } from 'fs';\r\nimport { fileURLToPath } from 'url';\r\nimport { dirname, join } from 'path';\r\n\r\nconst __filename = fileURLToPath(import.meta.url);\r\nconst __dirname = dirname(__filename);\r\n\r\n// Initialize Firebase Admin (serviceAccountKey.json if present, else ADC)\r\nif (!admin.apps.length) {\r\n  try {\r\n    const serviceAccountPath = join(__dirname, '..', 'serviceAccountKey.json');\r\n    const serviceAccount = JSON.parse(readFileSync(serviceAccountPath, 'utf8'));\r\n    admin.initializeApp({ credential: admin.credential.cert(serviceAccount) });\r\n  } catch (e) {\r\n    console.log('Service account not found, using application default credentials');\r\n    admin.initializeApp({ credential: admin.credential.applicationDefault() });\r\n  }\r\n}\r\n\r\nconst db = admin.firestore();\r\n\r\nasync function robustFetch(url) {\r\n  if (typeof fetch === 'function') {\r\n    const r = await fetch(url);\r\n    if (!r.ok) throw new Error(`HTTP ${r.status}`);\r\n    return await r.json();\r\n  }\r\n  return await new Promise((resolve, reject) => {\r\n    const https = await import('node:https');\r\n    https.get(url, (res) => {\r\n      if (res.statusCode !== 200) return reject(new Error(`HTTP ${res.statusCode}`));\r\n      let data = '';\r\n      res.on('data', (c) => (data += c));\r\n      res.on('end', () => {\r\n        try { resolve(JSON.parse(data)); } catch (e) { reject(e); }\r\n      });\r\n    }).on('error', reject);\r\n  });\r\n}\r\n\r\nfunction normalizeName(s) {\r\n  return String(s || '').trim();\r\n}\r\n\r\nasync function main() {\r\n  console.log('üîÑ Fetching TR districts dataset...');\r\n  const url = 'https://raw.githubusercontent.com/muhammederdem/il-ilce-json/master/il-ilce.json';\r\n  const data = await robustFetch(url);\r\n  if (!Array.isArray(data)) throw new Error('Unexpected dataset shape');\r\n\r\n  console.log(`üì¶ Provinces found: ${data.length}`);\r\n  let written = 0;\r\n  for (const rec of data) {\r\n    const province = normalizeName(rec.il);\r\n    const districts = Array.isArray(rec.ilceleri) ? rec.ilceleri.map((d) => normalizeName(d)).filter(Boolean) : [];\r\n    if (!province) continue;\r\n    await db.collection('trDistricts').doc(province).set({ districts }, { merge: true });\r\n    written++;\r\n  }\r\n  console.log(`‚úÖ Imported ${written} provinces into trDistricts`);\r\n}\r\n\r\nmain().then(()=>process.exit(0)).catch((e)=>{ console.error('‚ùå Import failed:', e); process.exit(1); });\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\init-stock-data.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\inventory-cost.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\invoice-compare.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\invoice-import.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'auth' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getDoc' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":30,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'doc' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":41},{"ruleId":"no-undef","severity":1,"message":"'XLSX' is not defined.","line":87,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":87,"endColumn":28},{"ruleId":"no-undef","severity":1,"message":"'XLSX' is not defined.","line":90,"column":20,"nodeType":"Identifier","messageId":"undef","endLine":90,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'user' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":114,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":114,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db, auth, requireAuth } from '/firebase.js';\r\nimport { compareInvoice } from '/scripts/invoice-compare.js';\r\nimport { collection, addDoc, getDoc, doc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';\r\n\r\nconst qs = s => document.querySelector(s);\r\n\r\nconst state = {\r\n  invoiceLines: [],\r\n  expectedLines: [],\r\n  discrepancies: []\r\n};\r\n\r\nasync function compare() {\r\n  const quoteId = qs('#matchedQuoteId').value.trim();\r\n  if (!quoteId) {\r\n    alert('Teklif ID girin!');\r\n    return;\r\n  }\r\n  \r\n  if (!state.invoiceLines.length) {\r\n    alert('Fatura y√ºklenmedi!');\r\n    return;\r\n  }\r\n  \r\n  try {\r\n    // Load expected lines from quote\r\n    // TODO: Load from actual quote structure\r\n    state.expectedLines = []; // Placeholder\r\n    \r\n    state.discrepancies = compareInvoice(state.expectedLines, state.invoiceLines);\r\n    renderComparison();\r\n    qs('#btnSave').disabled = false;\r\n    \r\n  } catch (error) {\r\n    console.error('Compare error:', error);\r\n    alert('Kar≈üƒ±la≈ütƒ±rma hatasƒ±: ' + error.message);\r\n  }\r\n}\r\n\r\nfunction renderComparison() {\r\n  const table = qs('#compareTable');\r\n  const tbody = qs('#compareTable tbody');\r\n  const info = qs('#compareInfo');\r\n  \r\n  tbody.innerHTML = '';\r\n  \r\n  if (!state.discrepancies.length) {\r\n    table.style.display = 'none';\r\n    info.textContent = '‚úÖ Hi√ßbir fark bulunamadƒ±!';\r\n    return;\r\n  }\r\n  \r\n  table.style.display = 'table';\r\n  info.textContent = `${state.discrepancies.length} fark bulundu.`;\r\n  \r\n  state.discrepancies.forEach(disc => {\r\n    const tr = document.createElement('tr');\r\n    const badge = 'b-discrepancy';\r\n    const kindText = {\r\n      'QTY': 'Miktar Farkƒ±',\r\n      'PRICE': 'Fiyat Farkƒ±',\r\n      'MISSING': 'Eksik Kalem',\r\n      'UNEXPECTED': 'Beklenmeyen'\r\n    }[disc.kind] || disc.kind;\r\n    \r\n    tr.innerHTML = `\r\n      <td>${disc.lineNo}</td>\r\n      <td>${disc.sku || '-'}</td>\r\n      <td>${disc.name || '-'}</td>\r\n      <td>${disc.expected}</td>\r\n      <td>${disc.actual}</td>\r\n      <td>${disc.kind === 'QTY' ? Math.abs(disc.expected - disc.actual) : disc.kind === 'PRICE' ? Math.abs(disc.expected - disc.actual).toFixed(2) : '-'}</td>\r\n      <td><span class=\"badge ${badge}\">${kindText}</span></td>\r\n    `;\r\n    tbody.appendChild(tr);\r\n  });\r\n}\r\n\r\nqs('#invoiceFile').addEventListener('change', async (e) => {\r\n  const file = e.target.files[0];\r\n  if (!file) return;\r\n  \r\n  const reader = new FileReader();\r\n  reader.onload = (event) => {\r\n    try {\r\n      const data = new Uint8Array(event.target.result);\r\n      const workbook = XLSX.read(data, { type: 'array' });\r\n      const sheetName = workbook.SheetNames[0];\r\n      const sheet = workbook.Sheets[sheetName];\r\n      const json = XLSX.utils.sheet_to_json(sheet);\r\n      \r\n      state.invoiceLines = json.map(row => ({\r\n        sku: row['SKU'] || row['sku'] || '',\r\n        name: row['√úr√ºn Adƒ±'] || row['name'] || '',\r\n        qty: parseFloat(row['Miktar'] || row['qty'] || 0),\r\n        unit: row['Birim'] || row['unit'] || 'ADT',\r\n        unitPrice: parseFloat(row['Birim Fiyat'] || row['unitPrice'] || 0),\r\n        total: parseFloat(row['Toplam'] || row['total'] || 0)\r\n      }));\r\n      \r\n      alert(`${state.invoiceLines.length} satƒ±r y√ºklendi.`);\r\n      \r\n    } catch (error) {\r\n      console.error('File parse error:', error);\r\n      alert('Dosya okunamadƒ±: ' + error.message);\r\n    }\r\n  };\r\n  reader.readAsArrayBuffer(file);\r\n});\r\n\r\nqs('#btnCompare').addEventListener('click', compare);\r\n\r\nqs('#btnSave').addEventListener('click', async () => {\r\n  const user = await requireAuth();\r\n  \r\n  const invoiceNumber = qs('#invoiceNumber').value.trim();\r\n  const quoteId = qs('#matchedQuoteId').value.trim();\r\n  \r\n  if (!invoiceNumber) {\r\n    alert('Fatura numarasƒ± girin!');\r\n    return;\r\n  }\r\n  \r\n  try {\r\n    await addDoc(collection(db, 'invoices'), {\r\n      number: invoiceNumber,\r\n      matchedQuoteId: quoteId,\r\n      lines: state.invoiceLines,\r\n      discrepancies: state.discrepancies,\r\n      parsedFrom: 'excel',\r\n      createdAt: serverTimestamp()\r\n    });\r\n    \r\n    alert('Fatura kar≈üƒ±la≈ütƒ±rmasƒ± kaydedildi!');\r\n    location.reload();\r\n    \r\n  } catch (error) {\r\n    console.error('Save error:', error);\r\n    alert('Kayƒ±t ba≈üarƒ±sƒ±z: ' + error.message);\r\n  }\r\n});\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\lib\\normalize-tr.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\lib\\tr-utils.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\migrate-categories-to-ids.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'updateDoc' is defined but never used. Allowed unused vars must match /^_/u.","line":17,"column":45,"nodeType":null,"messageId":"unusedVar","endLine":17,"endColumn":54}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Migration Script: Convert legacy category formats (slug/name) to ID-based system\r\n * \r\n * Usage:\r\n *   node scripts/migrate-categories-to-ids.js --dry-run  (preview changes)\r\n *   node scripts/migrate-categories-to-ids.js --commit  (apply changes)\r\n * \r\n * This script:\r\n * 1. Reads all users (suppliers) from Firestore\r\n * 2. Normalizes their category fields to IDs using category-service\r\n * 3. Reads all demands from Firestore\r\n * 4. Normalizes their category fields to IDs\r\n * 5. Updates Firestore documents with new categoryIds\r\n */\r\n\r\nimport { initializeApp } from 'firebase/app';\r\nimport { getFirestore, collection, getDocs, updateDoc, doc, writeBatch } from 'firebase/firestore';\r\nimport { normalizeToIds, getNameById } from '../src/categories/category-service.js';\r\n\r\n// Firebase config (same as firebase.js)\r\nconst firebaseConfig = {\r\n  apiKey: \"AIzaSyAbX3UWRPpw-yo4I4HbSdTg82LxvM-fqTE\",\r\n  authDomain: \"teklifbul.firebaseapp.com\",\r\n  projectId: \"teklifbul\",\r\n  storageBucket: \"teklifbul.firebasestorage.app\",\r\n  appId: \"1:636669818119:web:9085962e660831c36941a2\"\r\n};\r\n\r\n// Initialize Firebase\r\nconst app = initializeApp(firebaseConfig);\r\nconst db = getFirestore(app);\r\n\r\nlet dryRun = false;\r\n\r\n// Parse command line arguments\r\nconst args = process.argv.slice(2);\r\nif (args.includes('--commit')) {\r\n  dryRun = false;\r\n  console.log('‚ö†Ô∏è COMMIT MODE: Changes will be written to Firestore');\r\n} else {\r\n  dryRun = true;\r\n  console.log('üîç DRY-RUN MODE: No changes will be written');\r\n}\r\n\r\n/**\r\n * Migrate suppliers collection\r\n */\r\nasync function migrateSuppliers() {\r\n  console.log('\\nüì¶ Starting supplier migration...');\r\n  \r\n  const usersRef = collection(db, 'users');\r\n  const snapshot = await getDocs(usersRef);\r\n  \r\n  let processed = 0;\r\n  let updated = 0;\r\n  let skipped = 0;\r\n  let errors = 0;\r\n  \r\n  // Process in batches of 500 (Firestore batch limit)\r\n  const batchSize = 500;\r\n  let currentBatch = writeBatch(db);\r\n  let batchCount = 0;\r\n  \r\n  for (const userDoc of snapshot.docs) {\r\n    processed++;\r\n    const userData = userDoc.data();\r\n    const userId = userDoc.id;\r\n    \r\n    // Skip if already has supplierCategoryIds\r\n    if (Array.isArray(userData.supplierCategoryIds) && userData.supplierCategoryIds.length > 0) {\r\n      skipped++;\r\n      continue;\r\n    }\r\n    \r\n    // Check if user is a supplier\r\n    const isSupplier = userData.roles?.includes('supplier');\r\n    if (!isSupplier) {\r\n      skipped++;\r\n      continue;\r\n    }\r\n    \r\n    // Collect all category tokens\r\n    const categoryTokens = [];\r\n    \r\n    // Add legacy formats\r\n    if (Array.isArray(userData.supplierCategoryKeys)) {\r\n      categoryTokens.push(...userData.supplierCategoryKeys);\r\n    }\r\n    if (Array.isArray(userData.supplierCategories)) {\r\n      categoryTokens.push(...userData.supplierCategories);\r\n    }\r\n    if (Array.isArray(userData.categories)) {\r\n      categoryTokens.push(...userData.categories);\r\n    }\r\n    \r\n    if (categoryTokens.length === 0) {\r\n      skipped++;\r\n      continue;\r\n    }\r\n    \r\n    // Normalize to IDs\r\n    const categoryIds = normalizeToIds(categoryTokens);\r\n    \r\n    if (categoryIds.length === 0) {\r\n      console.warn(`‚ö†Ô∏è Could not normalize categories for user ${userId}:`, categoryTokens);\r\n      errors++;\r\n      continue;\r\n    }\r\n    \r\n    // Prepare update\r\n    const updateData = {\r\n      supplierCategoryIds: categoryIds\r\n    };\r\n    \r\n    // Log change\r\n    const categoryNames = categoryIds.map(id => getNameById(id));\r\n    console.log(`‚úÖ User ${userId}:`, {\r\n      old: categoryTokens,\r\n      new: categoryIds,\r\n      names: categoryNames\r\n    });\r\n    \r\n    if (dryRun) {\r\n      updated++;\r\n    } else {\r\n      // Add to batch\r\n      const userRef = doc(db, 'users', userId);\r\n      currentBatch.update(userRef, updateData);\r\n      batchCount++;\r\n      updated++;\r\n      \r\n      // Commit batch if full\r\n      if (batchCount >= batchSize) {\r\n        await currentBatch.commit();\r\n        console.log(`üíæ Committed batch of ${batchCount} updates`);\r\n        currentBatch = writeBatch(db);\r\n        batchCount = 0;\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Commit remaining batch\r\n  if (!dryRun && batchCount > 0) {\r\n    await currentBatch.commit();\r\n    console.log(`üíæ Committed final batch of ${batchCount} updates`);\r\n  }\r\n  \r\n  console.log(`\\nüìä Supplier Migration Summary:`);\r\n  console.log(`   Processed: ${processed}`);\r\n  console.log(`   Updated: ${updated}`);\r\n  console.log(`   Skipped: ${skipped}`);\r\n  console.log(`   Errors: ${errors}`);\r\n  \r\n  return { processed, updated, skipped, errors };\r\n}\r\n\r\n/**\r\n * Migrate demands collection\r\n */\r\nasync function migrateDemands() {\r\n  console.log('\\nüì¶ Starting demand migration...');\r\n  \r\n  const demandsRef = collection(db, 'demands');\r\n  const snapshot = await getDocs(demandsRef);\r\n  \r\n  let processed = 0;\r\n  let updated = 0;\r\n  let skipped = 0;\r\n  let errors = 0;\r\n  \r\n  // Process in batches of 500\r\n  const batchSize = 500;\r\n  let currentBatch = writeBatch(db);\r\n  let batchCount = 0;\r\n  \r\n  for (const demandDoc of snapshot.docs) {\r\n    processed++;\r\n    const demandData = demandDoc.data();\r\n    const demandId = demandDoc.id;\r\n    \r\n    // Skip if already has categoryIds\r\n    if (Array.isArray(demandData.categoryIds) && demandData.categoryIds.length > 0) {\r\n      skipped++;\r\n      continue;\r\n    }\r\n    \r\n    // Collect all category tokens\r\n    const categoryTokens = [];\r\n    \r\n    // Add legacy formats\r\n    if (Array.isArray(demandData.categoryTags)) {\r\n      categoryTokens.push(...demandData.categoryTags);\r\n    }\r\n    if (Array.isArray(demandData.supplierCategoryKeys)) {\r\n      categoryTokens.push(...demandData.supplierCategoryKeys);\r\n    }\r\n    if (Array.isArray(demandData.categories)) {\r\n      categoryTokens.push(...demandData.categories);\r\n    }\r\n    if (demandData.category && typeof demandData.category === 'string') {\r\n      categoryTokens.push(demandData.category);\r\n    }\r\n    \r\n    if (categoryTokens.length === 0) {\r\n      skipped++;\r\n      continue;\r\n    }\r\n    \r\n    // Normalize to IDs\r\n    const categoryIds = normalizeToIds(categoryTokens);\r\n    \r\n    if (categoryIds.length === 0) {\r\n      console.warn(`‚ö†Ô∏è Could not normalize categories for demand ${demandId}:`, categoryTokens);\r\n      errors++;\r\n      continue;\r\n    }\r\n    \r\n    // Prepare update\r\n    const updateData = {\r\n      categoryIds: categoryIds\r\n    };\r\n    \r\n    // Log change\r\n    const categoryNames = categoryIds.map(id => getNameById(id));\r\n    console.log(`‚úÖ Demand ${demandId}:`, {\r\n      old: categoryTokens,\r\n      new: categoryIds,\r\n      names: categoryNames\r\n    });\r\n    \r\n    if (dryRun) {\r\n      updated++;\r\n    } else {\r\n      // Add to batch\r\n      const demandRef = doc(db, 'demands', demandId);\r\n      currentBatch.update(demandRef, updateData);\r\n      batchCount++;\r\n      updated++;\r\n      \r\n      // Commit batch if full\r\n      if (batchCount >= batchSize) {\r\n        await currentBatch.commit();\r\n        console.log(`üíæ Committed batch of ${batchCount} updates`);\r\n        currentBatch = writeBatch(db);\r\n        batchCount = 0;\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Commit remaining batch\r\n  if (!dryRun && batchCount > 0) {\r\n    await currentBatch.commit();\r\n    console.log(`üíæ Committed final batch of ${batchCount} updates`);\r\n  }\r\n  \r\n  console.log(`\\nüìä Demand Migration Summary:`);\r\n  console.log(`   Processed: ${processed}`);\r\n  console.log(`   Updated: ${updated}`);\r\n  console.log(`   Skipped: ${skipped}`);\r\n  console.log(`   Errors: ${errors}`);\r\n  \r\n  return { processed, updated, skipped, errors };\r\n}\r\n\r\n/**\r\n * Main migration function\r\n */\r\nasync function runMigration() {\r\n  console.log('üöÄ Starting category migration to ID-based system...\\n');\r\n  \r\n  try {\r\n    // Migrate suppliers\r\n    const supplierStats = await migrateSuppliers();\r\n    \r\n    // Migrate demands\r\n    const demandStats = await migrateDemands();\r\n    \r\n    // Final summary\r\n    console.log('\\n‚úÖ Migration completed!');\r\n    console.log('\\nüìä Final Summary:');\r\n    console.log(`   Suppliers: ${supplierStats.updated} updated, ${supplierStats.skipped} skipped`);\r\n    console.log(`   Demands: ${demandStats.updated} updated, ${demandStats.skipped} skipped`);\r\n    console.log(`   Total errors: ${supplierStats.errors + demandStats.errors}`);\r\n    \r\n    if (dryRun) {\r\n      console.log('\\nüí° This was a DRY-RUN. Run with --commit to apply changes.');\r\n    } else {\r\n      console.log('\\n‚úÖ Changes have been committed to Firestore.');\r\n    }\r\n    \r\n  } catch (error) {\r\n    console.error('\\n‚ùå Migration failed:', error);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// Run migration\r\nrunMigration();\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\migrate-demands-and-match-suppliers.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'updateDoc' is defined but never used. Allowed unused vars must match /^_/u.","line":21,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":12}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Migration Script: Migrate all demands to ID-based categories AND match suppliers\r\n * \r\n * Usage:\r\n *   node scripts/migrate-demands-and-match-suppliers.js --dry-run  (preview changes)\r\n *   node scripts/migrate-demands-and-match-suppliers.js --commit  (apply changes)\r\n * \r\n * This script:\r\n * 1. Migrates all demands to have categoryIds (if missing)\r\n * 2. For all published demands:\r\n *    - Finds matching suppliers using new ID-based matching\r\n *    - Updates viewerIds field\r\n *    - Creates demandRecipients records\r\n */\r\n\r\nimport { initializeApp } from 'firebase/app';\r\nimport { \r\n  getFirestore, \r\n  collection, \r\n  getDocs, \r\n  updateDoc, \r\n  doc, \r\n  writeBatch,\r\n  addDoc,\r\n  serverTimestamp,\r\n  query,\r\n  where\r\n} from 'firebase/firestore';\r\nimport { normalizeToIds, getNameById, getAllCategories } from '../src/categories/category-service.js';\r\nimport { matchSuppliers } from '../src/matching/match-service.js';\r\n\r\n// Firebase config (same as firebase.js)\r\nconst firebaseConfig = {\r\n  apiKey: \"AIzaSyAbX3UWRPpw-yo4I4HbSdTg82LxvM-fqTE\",\r\n  authDomain: \"teklifbul.firebaseapp.com\",\r\n  projectId: \"teklifbul\",\r\n  storageBucket: \"teklifbul.firebasestorage.app\",\r\n  appId: \"1:636669818119:web:9085962e660831c36941a2\"\r\n};\r\n\r\n// Initialize Firebase\r\nconst app = initializeApp(firebaseConfig);\r\nconst db = getFirestore(app);\r\n\r\nlet dryRun = false;\r\n\r\n// Parse command line arguments\r\nconst args = process.argv.slice(2);\r\nif (args.includes('--commit')) {\r\n  dryRun = false;\r\n  console.log('‚ö†Ô∏è COMMIT MODE: Changes will be written to Firestore');\r\n} else {\r\n  dryRun = true;\r\n  console.log('üîç DRY-RUN MODE: No changes will be written');\r\n}\r\n\r\n/**\r\n * Migrate demand categories and match suppliers\r\n */\r\nasync function migrateDemandsAndMatchSuppliers() {\r\n  console.log('\\nüì¶ Starting demand migration and supplier matching...');\r\n  \r\n  const demandsRef = collection(db, 'demands');\r\n  const snapshot = await getDocs(demandsRef);\r\n  \r\n  let processed = 0;\r\n  let migrated = 0;\r\n  let matched = 0;\r\n  let skipped = 0;\r\n  let errors = 0;\r\n  \r\n  // Process in batches of 100 (smaller batches for supplier matching)\r\n  const batchSize = 100;\r\n  let currentBatch = writeBatch(db);\r\n  let batchCount = 0;\r\n  \r\n  for (const demandDoc of snapshot.docs) {\r\n    processed++;\r\n    const demandData = demandDoc.data();\r\n    const demandId = demandDoc.id;\r\n    \r\n    try {\r\n      // Step 1: Migrate categoryIds if missing\r\n      let categoryIds = demandData.categoryIds || [];\r\n      let needsCategoryMigration = false;\r\n      \r\n      if (!Array.isArray(categoryIds) || categoryIds.length === 0) {\r\n        // Collect all category tokens from legacy fields\r\n        const categoryTokens = [];\r\n        \r\n        if (Array.isArray(demandData.categoryTags)) {\r\n          categoryTokens.push(...demandData.categoryTags);\r\n        }\r\n        if (Array.isArray(demandData.supplierCategoryKeys)) {\r\n          categoryTokens.push(...demandData.supplierCategoryKeys);\r\n        }\r\n        if (Array.isArray(demandData.categories)) {\r\n          categoryTokens.push(...demandData.categories);\r\n        }\r\n        if (demandData.category && typeof demandData.category === 'string') {\r\n          categoryTokens.push(demandData.category);\r\n        }\r\n        \r\n        if (categoryTokens.length > 0) {\r\n          categoryIds = normalizeToIds(categoryTokens);\r\n          needsCategoryMigration = true;\r\n        }\r\n      }\r\n      \r\n      // Step 2: For published demands, match suppliers\r\n      let matchingSupplierIds = [];\r\n      const isPublished = demandData.isPublished === true || demandData.published === true || \r\n                          demandData.status === 'published' || demandData.status === 'approved';\r\n      \r\n      if (isPublished && categoryIds.length > 0) {\r\n        try {\r\n          // Prepare legacy formats for backward compatibility\r\n          const allCategories = getAllCategories();\r\n          const legacySlugs = categoryIds.map(id => {\r\n            const cat = allCategories.find(c => c.id === id);\r\n            return cat ? cat.slug : null;\r\n          }).filter(Boolean);\r\n          const legacyNames = categoryIds.map(id => getNameById(id)).filter(Boolean);\r\n          \r\n          // Use match service to find suppliers\r\n          const matchedSuppliers = await matchSuppliers(db, {\r\n            categoryIds: categoryIds,\r\n            legacySlugs: legacySlugs,\r\n            legacyNames: legacyNames\r\n          });\r\n          \r\n          matchingSupplierIds = Array.from(new Set(matchedSuppliers.map(s => s.uid || s.id).filter(Boolean)));\r\n          \r\n          if (matchingSupplierIds.length > 0) {\r\n            console.log(`‚úÖ Demand ${demandId}: Matched ${matchingSupplierIds.length} suppliers`);\r\n            matched++;\r\n          }\r\n        } catch (matchError) {\r\n          console.warn(`‚ö†Ô∏è Supplier matching failed for demand ${demandId}:`, matchError.message);\r\n          errors++;\r\n        }\r\n      }\r\n      \r\n      // Step 3: Prepare update data\r\n      const updateData = {};\r\n      \r\n      if (needsCategoryMigration && categoryIds.length > 0) {\r\n        updateData.categoryIds = categoryIds;\r\n        migrated++;\r\n      }\r\n      \r\n      if (isPublished && matchingSupplierIds.length > 0) {\r\n        // Update viewerIds (include demand creator if available)\r\n        const currentViewerIds = Array.isArray(demandData.viewerIds) ? demandData.viewerIds : [];\r\n        const newViewerIds = Array.from(new Set([\r\n          ...currentViewerIds,\r\n          ...(demandData.createdBy ? [demandData.createdBy] : []),\r\n          ...matchingSupplierIds\r\n        ]));\r\n        updateData.viewerIds = newViewerIds;\r\n      }\r\n      \r\n      // Only update if there are changes\r\n      if (Object.keys(updateData).length > 0) {\r\n        if (dryRun) {\r\n          console.log(`üìù Demand ${demandId}: Would update`, updateData);\r\n        } else {\r\n          // Add to batch\r\n          const demandRef = doc(db, 'demands', demandId);\r\n          currentBatch.update(demandRef, updateData);\r\n          batchCount++;\r\n          \r\n          // Commit batch if full\r\n          if (batchCount >= batchSize) {\r\n            await currentBatch.commit();\r\n            console.log(`üíæ Committed batch of ${batchCount} updates`);\r\n            currentBatch = writeBatch(db);\r\n            batchCount = 0;\r\n          }\r\n        }\r\n      } else {\r\n        skipped++;\r\n      }\r\n      \r\n      // Step 4: Create demandRecipients records for matched suppliers (only for published demands)\r\n      if (!dryRun && isPublished && matchingSupplierIds.length > 0) {\r\n        // Get legacy slugs for demandRecipients\r\n        const allCategories = getAllCategories();\r\n        const legacySlugs = categoryIds.map(id => {\r\n          const cat = allCategories.find(c => c.id === id);\r\n          return cat ? cat.slug : null;\r\n        }).filter(Boolean);\r\n        \r\n        // Check existing demandRecipients to avoid duplicates\r\n        const existingRecipientsQuery = query(\r\n          collection(db, 'demandRecipients'),\r\n          where('demandId', '==', demandId)\r\n        );\r\n        const existingRecipientsSnap = await getDocs(existingRecipientsQuery);\r\n        const existingSupplierIds = new Set(\r\n          existingRecipientsSnap.docs.map(d => d.data().supplierId).filter(Boolean)\r\n        );\r\n        \r\n        // Create demandRecipients for new matches\r\n        for (const supplierId of matchingSupplierIds) {\r\n          if (!existingSupplierIds.has(supplierId)) {\r\n            try {\r\n              await addDoc(collection(db, 'demandRecipients'), {\r\n                demandId: demandId,\r\n                supplierId: supplierId,\r\n                buyerId: demandData.createdBy || null,\r\n                matchedAt: serverTimestamp(),\r\n                categories: categoryIds,\r\n                categoryTags: legacySlugs,\r\n                status: 'matched',\r\n                matchedCategories: categoryIds\r\n              });\r\n            } catch (recipientError) {\r\n              console.warn(`‚ö†Ô∏è Could not create demandRecipient for ${demandId} -> ${supplierId}:`, recipientError.message);\r\n            }\r\n          }\r\n        }\r\n      }\r\n      \r\n    } catch (error) {\r\n      console.error(`‚ùå Error processing demand ${demandId}:`, error.message);\r\n      errors++;\r\n    }\r\n  }\r\n  \r\n  // Commit remaining batch\r\n  if (!dryRun && batchCount > 0) {\r\n    await currentBatch.commit();\r\n    console.log(`üíæ Committed final batch of ${batchCount} updates`);\r\n  }\r\n  \r\n  console.log(`\\nüìä Migration Summary:`);\r\n  console.log(`   Processed: ${processed}`);\r\n  console.log(`   Migrated (categoryIds): ${migrated}`);\r\n  console.log(`   Matched suppliers: ${matched}`);\r\n  console.log(`   Skipped: ${skipped}`);\r\n  console.log(`   Errors: ${errors}`);\r\n  \r\n  return { processed, migrated, matched, skipped, errors };\r\n}\r\n\r\n/**\r\n * Main migration function\r\n */\r\nasync function runMigration() {\r\n  console.log('üöÄ Starting demand migration and supplier matching...\\n');\r\n  \r\n  try {\r\n    const stats = await migrateDemandsAndMatchSuppliers();\r\n    \r\n    console.log('\\n‚úÖ Migration completed!');\r\n    console.log('\\nüìä Final Summary:');\r\n    console.log(`   Demands processed: ${stats.processed}`);\r\n    console.log(`   Category migrations: ${stats.migrated}`);\r\n    console.log(`   Supplier matches: ${stats.matched}`);\r\n    console.log(`   Skipped: ${stats.skipped}`);\r\n    console.log(`   Errors: ${stats.errors}`);\r\n    \r\n    if (dryRun) {\r\n      console.log('\\nüí° This was a DRY-RUN. Run with --commit to apply changes.');\r\n    } else {\r\n      console.log('\\n‚úÖ Changes have been committed to Firestore.');\r\n      console.log('üí° Check demandRecipients collection for matched suppliers.');\r\n    }\r\n    \r\n  } catch (error) {\r\n    console.error('\\n‚ùå Migration failed:', error);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// Run migration\r\nrunMigration();\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\migrate-demands-refactor.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":14,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":14,"endColumn":40},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":18,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":18,"endColumn":62}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * REFACTORED: Demands Migration Script\r\n * \r\n * Migrates existing demands to the new refactored data model:\r\n * - Adds: status, creatorId, creatorCompanyId, supplierCategoryKeys, updatedAt\r\n * - Removes: visibility, isPublished, published (kept for backward compat temporarily)\r\n * \r\n * Usage:\r\n *   node scripts/migrate-demands-refactor.js\r\n * \r\n * Or run in Firebase Console ‚Üí Firestore ‚Üí Run migration\r\n */\r\n\r\nconst admin = require(\"firebase-admin\");\r\n\r\n// Initialize Firebase Admin\r\nif (!admin.apps.length) {\r\n  const serviceAccount = require(\"../serviceAccountKey.json\");\r\n  admin.initializeApp({\r\n    credential: admin.credential.cert(serviceAccount)\r\n  });\r\n}\r\n\r\nconst db = admin.firestore();\r\n\r\n// Slug normalize function (matches frontend)\r\nfunction toSlug(name) {\r\n  if (!name) return '';\r\n  return String(name)\r\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g, '')\r\n    .replace(/[≈ü≈û]/g, 's').replace(/[ƒ±ƒ∞]/g, 'i').replace(/[ƒüƒû]/g, 'g')\r\n    .replace(/[√ß√á]/g, 'c').replace(/[√∂√ñ]/g, 'o').replace(/[√º√ú]/g, 'u')\r\n    .toLowerCase().trim().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');\r\n}\r\n\r\nasync function migrateDemands() {\r\n  console.log(\"üöÄ Starting demands migration...\");\r\n  \r\n  try {\r\n    // Get all demands\r\n    const demandsSnapshot = await db.collection(\"demands\").get();\r\n    console.log(`üìÑ Found ${demandsSnapshot.size} demands to migrate`);\r\n    \r\n    const batch = db.batch();\r\n    let batchCount = 0;\r\n    const BATCH_SIZE = 500; // Firestore batch limit\r\n    \r\n    let migrated = 0;\r\n    let skipped = 0;\r\n    let errors = 0;\r\n    \r\n    for (const docSnap of demandsSnapshot.docs) {\r\n      try {\r\n        const data = docSnap.data();\r\n        const demandId = docSnap.id;\r\n        \r\n        // Skip if already migrated (has creatorId and creatorCompanyId)\r\n        if (data.creatorId && data.creatorCompanyId && data.status) {\r\n          console.log(`‚è≠Ô∏è  Skipping ${demandId} - already migrated`);\r\n          skipped++;\r\n          continue;\r\n        }\r\n        \r\n        const updateData = {};\r\n        let needsUpdate = false;\r\n        \r\n        // 1. Status √ºret\r\n        if (!data.status) {\r\n          if (data.published === true || data.isPublished === true || \r\n              data.published === 'true' || data.isPublished === 'true') {\r\n            updateData.status = 'published';\r\n          } else if (data.geriCekildi === true || data.geriCekildi === 'true') {\r\n            updateData.status = 'withdrawn';\r\n          } else {\r\n            updateData.status = 'draft';\r\n          }\r\n          needsUpdate = true;\r\n          console.log(`üìù ${demandId}: status = ${updateData.status}`);\r\n        }\r\n        \r\n        // 2. creatorId = createdBy\r\n        if (!data.creatorId && data.createdBy) {\r\n          updateData.creatorId = data.createdBy;\r\n          needsUpdate = true;\r\n        } else if (!data.creatorId && !data.createdBy) {\r\n          console.warn(`‚ö†Ô∏è  ${demandId}: No createdBy found, skipping creatorId`);\r\n        }\r\n        \r\n        // 3. creatorCompanyId = companyId (veya user'dan √ßek)\r\n        if (!data.creatorCompanyId) {\r\n          if (data.companyId) {\r\n            updateData.creatorCompanyId = data.companyId;\r\n            needsUpdate = true;\r\n          } else if (data.createdBy) {\r\n            // Try to get from user document\r\n            try {\r\n              const userDoc = await db.collection(\"users\").doc(data.createdBy).get();\r\n              if (userDoc.exists()) {\r\n                const userData = userDoc.data();\r\n                const userCompanyId = userData.companyId || \r\n                                     userData.currentCompanyId || \r\n                                     userData.activeCompanyId;\r\n                if (userCompanyId) {\r\n                  updateData.creatorCompanyId = userCompanyId;\r\n                  needsUpdate = true;\r\n                } else {\r\n                  console.warn(`‚ö†Ô∏è  ${demandId}: User ${data.createdBy} has no companyId`);\r\n                }\r\n              }\r\n            } catch (e) {\r\n              console.warn(`‚ö†Ô∏è  ${demandId}: Could not load user ${data.createdBy}:`, e.message);\r\n            }\r\n          }\r\n        }\r\n        \r\n        // 4. supplierCategoryKeys = categoryTags'dan normalize et\r\n        if (!data.supplierCategoryKeys || data.supplierCategoryKeys.length === 0) {\r\n          const categoryTags = data.categoryTags || [];\r\n          if (Array.isArray(categoryTags) && categoryTags.length > 0) {\r\n            // CategoryTags zaten slug formatƒ±nda olabilir, yine de normalize et\r\n            updateData.supplierCategoryKeys = categoryTags.map(cat => {\r\n              if (typeof cat === 'string') {\r\n                // Eƒüer zaten slug formatƒ±ndaysa olduƒüu gibi kullan\r\n                if (cat.match(/^[a-z0-9-]+$/)) {\r\n                  return cat;\r\n                }\r\n                // Deƒüilse normalize et\r\n                return toSlug(cat);\r\n              }\r\n              return toSlug(String(cat));\r\n            }).filter(Boolean);\r\n            needsUpdate = true;\r\n          } else {\r\n            // Kategori yok, bo≈ü array\r\n            updateData.supplierCategoryKeys = [];\r\n            needsUpdate = true;\r\n          }\r\n        }\r\n        \r\n        // 5. updatedAt ekle (yoksa)\r\n        if (!data.updatedAt) {\r\n          updateData.updatedAt = admin.firestore.FieldValue.serverTimestamp();\r\n          needsUpdate = true;\r\n        }\r\n        \r\n        if (needsUpdate) {\r\n          const demandRef = db.collection(\"demands\").doc(demandId);\r\n          batch.update(demandRef, updateData);\r\n          batchCount++;\r\n          migrated++;\r\n          \r\n          // Batch limit reached, commit and start new batch\r\n          if (batchCount >= BATCH_SIZE) {\r\n            await batch.commit();\r\n            console.log(`‚úÖ Committed batch of ${batchCount} updates`);\r\n            batchCount = 0;\r\n          }\r\n        } else {\r\n          skipped++;\r\n        }\r\n        \r\n      } catch (error) {\r\n        console.error(`‚ùå Error migrating demand ${docSnap.id}:`, error);\r\n        errors++;\r\n      }\r\n    }\r\n    \r\n    // Commit remaining batch\r\n    if (batchCount > 0) {\r\n      await batch.commit();\r\n      console.log(`‚úÖ Committed final batch of ${batchCount} updates`);\r\n    }\r\n    \r\n    console.log(\"\\n‚úÖ Migration complete!\");\r\n    console.log(`üìä Summary:`);\r\n    console.log(`   - Migrated: ${migrated}`);\r\n    console.log(`   - Skipped: ${skipped}`);\r\n    console.log(`   - Errors: ${errors}`);\r\n    \r\n  } catch (error) {\r\n    console.error(\"‚ùå Migration failed:\", error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n// Run migration\r\nif (require.main === module) {\r\n  migrateDemands()\r\n    .then(() => {\r\n      console.log(\"‚úÖ Migration script completed\");\r\n      process.exit(0);\r\n    })\r\n    .catch((error) => {\r\n      console.error(\"‚ùå Migration script failed:\", error);\r\n      process.exit(1);\r\n    });\r\n}\r\n\r\nmodule.exports = { migrateDemands };\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\migrate-postgres-to-firestore.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'collection' is defined but never used. Allowed unused vars must match /^_/u.","line":17,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":17,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setDoc' is defined but never used. Allowed unused vars must match /^_/u.","line":17,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":17,"endColumn":33},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":84,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1986,1989],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1986,1989],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":122,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":122,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3059,3062],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3059,3062],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":156,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":156,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4046,4049],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4046,4049],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":190,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":190,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4925,4928],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4925,4928],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":223,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":223,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5772,5775],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5772,5775],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":259,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":259,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6771,6774],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6771,6774],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":291,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":291,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7535,7538],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7535,7538],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * PostgreSQL ‚Üí Firestore Migration Script\r\n * Teklifbul Rule v1.0\r\n * \r\n * PostgreSQL'deki verileri Firestore'a aktarƒ±r\r\n * \r\n * Kullanƒ±m: tsx scripts/migrate-postgres-to-firestore.ts\r\n * \r\n * Gereksinimler:\r\n * - PostgreSQL √ßalƒ±≈üƒ±yor olmalƒ±\r\n * - Firestore baƒülantƒ±sƒ± kurulmu≈ü olmalƒ±\r\n * - .env dosyasƒ±nda PostgreSQL bilgileri olmalƒ±\r\n */\r\n\r\nimport { getPgPool } from '../src/db/connection';\r\nimport { db } from '../src/lib/firebase';\r\nimport { collection, doc, setDoc, batch } from 'firebase/firestore';\r\n\r\n// Logger helper\r\nfunction log(message: string, type: 'info' | 'success' | 'error' | 'warn' = 'info') {\r\n  const prefix = {\r\n    info: 'üì¶',\r\n    success: '‚úÖ',\r\n    error: '‚ùå',\r\n    warn: '‚ö†Ô∏è'\r\n  }[type];\r\n  console.log(`${prefix} ${message}`);\r\n}\r\n\r\ninterface Category {\r\n  id: number;\r\n  name: string;\r\n  short_desc?: string;\r\n  examples?: string[];\r\n  created_at?: Date;\r\n  updated_at?: Date;\r\n}\r\n\r\ninterface CategoryKeyword {\r\n  id: number;\r\n  category_id: number;\r\n  keyword: string;\r\n  weight: number;\r\n}\r\n\r\ninterface TaxOffice {\r\n  id: number;\r\n  province_name: string;\r\n  district_name?: string;\r\n  office_name: string;\r\n  office_code?: string;\r\n  office_type?: string;\r\n}\r\n\r\n/**\r\n * Categories migration\r\n */\r\nasync function migrateCategories() {\r\n  log('Migrating categories...', 'info');\r\n  \r\n  try {\r\n    // PostgreSQL baƒülantƒ± kontrol√º\r\n    const pool = getPgPool();\r\n    if (!pool) {\r\n      throw new Error('PostgreSQL connection pool is null');\r\n    }\r\n    \r\n    // Firestore baƒülantƒ± kontrol√º\r\n    if (!db) {\r\n      throw new Error('Firestore db is null');\r\n    }\r\n    \r\n    const result = await pool.query('SELECT * FROM categories ORDER BY id');\r\n    const categories = result.rows as Category[];\r\n    \r\n    log(`Found ${categories.length} categories`, 'info');\r\n    \r\n    if (categories.length === 0) {\r\n      log('No categories to migrate', 'warn');\r\n      return;\r\n    }\r\n    \r\n    // Batch write (Firestore limit: 500 per batch)\r\n    const batches: any[] = [];\r\n    let currentBatch = batch(db);\r\n    let batchCount = 0;\r\n    \r\n    for (let i = 0; i < categories.length; i++) {\r\n      const category = categories[i];\r\n      const categoryRef = doc(db, 'categories', category.id.toString());\r\n      \r\n      currentBatch.set(categoryRef, {\r\n        id: category.id,\r\n        name: category.name,\r\n        short_desc: category.short_desc || null,\r\n        examples: category.examples || [],\r\n        createdAt: category.created_at || new Date(),\r\n        updatedAt: category.updated_at || new Date()\r\n      });\r\n      \r\n      batchCount++;\r\n      \r\n      // Her 500'de bir yeni batch olu≈ütur\r\n      if (batchCount >= 500) {\r\n        batches.push(currentBatch);\r\n        currentBatch = batch(db);\r\n        batchCount = 0;\r\n      }\r\n    }\r\n    \r\n    // Son batch'i ekle\r\n    if (batchCount > 0) {\r\n      batches.push(currentBatch);\r\n    }\r\n    \r\n    // Batch'leri √ßalƒ±≈ütƒ±r\r\n    for (const b of batches) {\r\n      await b.commit();\r\n    }\r\n    \r\n    log(`Migrated ${categories.length} categories`, 'success');\r\n  } catch (error: any) {\r\n    if (error.code === 'ECONNREFUSED' || error.code === 'ENOTFOUND') {\r\n      log('PostgreSQL baƒülantƒ± hatasƒ±. PostgreSQL √ßalƒ±≈üƒ±yor mu?', 'error');\r\n      log('L√ºtfen PostgreSQL\\'i ba≈ülatƒ±n veya .env dosyasƒ±nƒ± kontrol edin.', 'warn');\r\n      process.exit(1);\r\n    }\r\n    log(`Migration error: ${error.message}`, 'error');\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Category Keywords migration\r\n */\r\nasync function migrateCategoryKeywords() {\r\n  log('Migrating category keywords...', 'info');\r\n  \r\n  try {\r\n    const pool = getPgPool();\r\n    if (!pool) {\r\n      throw new Error('PostgreSQL connection pool is null');\r\n    }\r\n    \r\n    const result = await pool.query('SELECT * FROM category_keywords ORDER BY id');\r\n    const keywords = result.rows as CategoryKeyword[];\r\n    \r\n    log(`Found ${keywords.length} keywords`, 'info');\r\n    \r\n    if (keywords.length === 0) {\r\n      log('No keywords to migrate', 'warn');\r\n      return;\r\n    }\r\n    \r\n    // Batch write\r\n    const batches: any[] = [];\r\n    let currentBatch = batch(db);\r\n    let batchCount = 0;\r\n    \r\n    for (let i = 0; i < keywords.length; i++) {\r\n      const keyword = keywords[i];\r\n      const keywordRef = doc(db, 'category_keywords', keyword.id.toString());\r\n      \r\n      currentBatch.set(keywordRef, {\r\n        id: keyword.id,\r\n        category_id: keyword.category_id,\r\n        keyword: keyword.keyword,\r\n        weight: keyword.weight,\r\n        createdAt: new Date()\r\n      });\r\n      \r\n      batchCount++;\r\n      \r\n      if (batchCount >= 500) {\r\n        batches.push(currentBatch);\r\n        currentBatch = batch(db);\r\n        batchCount = 0;\r\n      }\r\n    }\r\n    \r\n    if (batchCount > 0) {\r\n      batches.push(currentBatch);\r\n    }\r\n    \r\n    for (const b of batches) {\r\n      await b.commit();\r\n    }\r\n    \r\n    log(`Migrated ${keywords.length} keywords`, 'success');\r\n  } catch (error: any) {\r\n    if (error.code === 'ECONNREFUSED' || error.code === 'ENOTFOUND') {\r\n      log('PostgreSQL baƒülantƒ± hatasƒ±', 'error');\r\n      process.exit(1);\r\n    }\r\n    log(`Migration error: ${error.message}`, 'error');\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Tax Offices migration\r\n */\r\nasync function migrateTaxOffices() {\r\n  log('Migrating tax offices...', 'info');\r\n  \r\n  try {\r\n    const pool = getPgPool();\r\n    if (!pool) {\r\n      throw new Error('PostgreSQL connection pool is null');\r\n    }\r\n    \r\n    const result = await pool.query('SELECT * FROM tax_offices ORDER BY id');\r\n    const offices = result.rows as TaxOffice[];\r\n    \r\n    log(`Found ${offices.length} tax offices`, 'info');\r\n    \r\n    if (offices.length === 0) {\r\n      log('No tax offices to migrate', 'warn');\r\n      return;\r\n    }\r\n    \r\n    // Batch write\r\n    const batches: any[] = [];\r\n    let currentBatch = batch(db);\r\n    let batchCount = 0;\r\n    \r\n    for (let i = 0; i < offices.length; i++) {\r\n      const office = offices[i];\r\n      const officeRef = doc(db, 'tax_offices', office.id.toString());\r\n      \r\n      currentBatch.set(officeRef, {\r\n        id: office.id,\r\n        province_name: office.province_name,\r\n        district_name: office.district_name || null,\r\n        office_name: office.office_name,\r\n        office_code: office.office_code || null,\r\n        office_type: office.office_type || null,\r\n        createdAt: new Date()\r\n      });\r\n      \r\n      batchCount++;\r\n      \r\n      if (batchCount >= 500) {\r\n        batches.push(currentBatch);\r\n        currentBatch = batch(db);\r\n        batchCount = 0;\r\n      }\r\n    }\r\n    \r\n    if (batchCount > 0) {\r\n      batches.push(currentBatch);\r\n    }\r\n    \r\n    for (const b of batches) {\r\n      await b.commit();\r\n    }\r\n    \r\n    log(`Migrated ${offices.length} tax offices`, 'success');\r\n  } catch (error: any) {\r\n    if (error.code === 'ECONNREFUSED' || error.code === 'ENOTFOUND') {\r\n      log('PostgreSQL baƒülantƒ± hatasƒ±', 'error');\r\n      process.exit(1);\r\n    }\r\n    log(`Migration error: ${error.message}`, 'error');\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Main migration function\r\n */\r\nasync function main() {\r\n  log('Starting PostgreSQL ‚Üí Firestore migration...', 'info');\r\n  console.log('');\r\n  \r\n  try {\r\n    // 1. Categories\r\n    await migrateCategories();\r\n    console.log('');\r\n    \r\n    // 2. Category Keywords\r\n    await migrateCategoryKeywords();\r\n    console.log('');\r\n    \r\n    // 3. Tax Offices\r\n    await migrateTaxOffices();\r\n    console.log('');\r\n    \r\n    log('Migration completed successfully!', 'success');\r\n    process.exit(0);\r\n  } catch (error: any) {\r\n    log(`Migration failed: ${error.message}`, 'error');\r\n    if (error.stack) {\r\n      console.error('Stack trace:', error.stack);\r\n    }\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// Run migration (TypeScript/ESM compatible)\r\nif (import.meta.url === `file://${process.argv[1]}` || process.argv[1]?.includes('migrate-postgres-to-firestore')) {\r\n  main().catch((error) => {\r\n    log(`Fatal error: ${error.message}`, 'error');\r\n    process.exit(1);\r\n  });\r\n}\r\n\r\nexport { migrateCategories, migrateCategoryKeywords, migrateTaxOffices };\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\payment-module.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DEFAULT_FINANCE_BY_PLAN' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":21,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Payment Module (vanilla JS, single-file)\r\n// Initializes itself when a section with id \"payment-section\" exists.\r\n\r\n(function(){\r\n  const api = { init, setTotals, setRole, getPayload };\r\n  let bound = false;\r\n  let state = {\r\n    role: 'buyer',\r\n    paymentType: null,\r\n    totalIncl: 0,\r\n    pesinModel: null,\r\n    prepaymentRate: 30,\r\n    installments: 1,\r\n    financeRate: 0,\r\n    ccCampaign: '',\r\n    invoiceDate: '',\r\n    netDays: 15,\r\n    checks: []\r\n  };\r\n\r\n  const DEFAULT_FINANCE_BY_PLAN = { single: 0, '6': 3, '9': 5 };\r\n\r\n  function $(sel){ return document.querySelector(sel); }\r\n  function show(el, flag){ if (el) el.classList.toggle('hidden', !flag); }\r\n  function toNumber(val){ const n = Number(val); return Number.isFinite(n) ? n : 0; }\r\n\r\n  function calcFinance({ totalIncl, financeRate, installments = 1 }){\r\n    const baseAmt = totalIncl;\r\n    const financeAmt = baseAmt * (financeRate/100);\r\n    const grandIncl = totalIncl + financeAmt;\r\n    const monthly = installments > 1 ? grandIncl / installments : grandIncl;\r\n    return { baseAmt, financeAmt, grandIncl, monthly };\r\n  }\r\n  function addBusinessDaysFromInvoice(invoiceDateStr, netDays){\r\n    if (!invoiceDateStr) return { due:null, label:'‚Äî' };\r\n    const d = new Date(invoiceDateStr + 'T00:00:00');\r\n    d.setDate(d.getDate() + netDays);\r\n    const dow = d.getDay();\r\n    if (dow === 0) d.setDate(d.getDate() + 1);\r\n    if (dow === 6) d.setDate(d.getDate() + 2);\r\n    const label = d.toLocaleDateString('tr-TR', { weekday:'long', year:'numeric', month:'2-digit', day:'2-digit' });\r\n    return { due:d, label };\r\n  }\r\n  function updatePesinUI(model){ show($('#prepayment-config'), model === 'onodeme'); show($('#escrow-info'), model === 'escrow'); }\r\n\r\n  function bind(){\r\n    const root = $('#payment-section'); if (!root) return;\r\n    bound = true;\r\n    root.querySelectorAll('input[name=\"paymentType\"]').forEach(r => r.addEventListener('change', e => { state.paymentType = e.target.value; refresh(); }));\r\n    root.querySelectorAll('input[name=\"pesinModel\"]').forEach(r => r.addEventListener('change', e => { state.pesinModel = e.target.value; updatePesinUI(state.pesinModel); refresh(); }));\r\n    $('#prepaymentRate')?.addEventListener('input', e => { state.prepaymentRate = toNumber(e.target.value); refresh(); });\r\n    $('#installments')?.addEventListener('input', e => { state.installments = Math.max(1, toNumber(e.target.value)); refresh(); });\r\n    $('#ccCampaign')?.addEventListener('input', e => { state.ccCampaign = e.target.value; });\r\n    $('#financeRate')?.addEventListener('input', e => { state.financeRate = toNumber(e.target.value); refresh(); });\r\n    $('#invoiceDate')?.addEventListener('change', e => { state.invoiceDate = e.target.value; refresh(); });\r\n    $('#netDays')?.addEventListener('change', e => { state.netDays = toNumber(e.target.value); refresh(); });\r\n    $('#netDaysCustom')?.addEventListener('input', e => { const v = toNumber(e.target.value); if (v>0) { state.netDays = v; const sel = $('#netDays'); if (sel) sel.value = ''; } refresh(); });\r\n    $('#btnAddCheck')?.addEventListener('click', () => { state.checks.push({ amount: 0, days: 30 }); renderChecks(); refresh(); });\r\n    const checksBody = document.getElementById('checksBody');\r\n    checksBody?.addEventListener('input', (e) => {\r\n      const row = /** @type {HTMLElement} */(e.target).closest('[data-idx]'); if (!row) return;\r\n      const idx = Number(row.getAttribute('data-idx'));\r\n      if (/** @type {HTMLElement} */(e.target).classList.contains('chk-amount')) state.checks[idx].amount = toNumber(/** @type {HTMLInputElement} */(e.target).value);\r\n      if (/** @type {HTMLElement} */(e.target).classList.contains('chk-days')) state.checks[idx].days = toNumber(/** @type {HTMLInputElement} */(e.target).value);\r\n      refresh();\r\n    });\r\n    checksBody?.addEventListener('click', (e) => {\r\n      const btn = /** @type {HTMLElement} */(e.target).closest('.chk-del'); if (!btn) return;\r\n      const row = /** @type {HTMLElement} */(btn).closest('[data-idx]'); if (!row) return;\r\n      const idx = Number(row.getAttribute('data-idx'));\r\n      state.checks.splice(idx, 1);\r\n      renderChecks();\r\n      refresh();\r\n    });\r\n    $('#savePayment')?.addEventListener('click', onSave);\r\n    // Payment cards (Pe≈üin modelleri)\r\n    const cards = root.querySelectorAll('.payment-card');\r\n    cards.forEach((card)=>{\r\n      card.addEventListener('click', ()=>{\r\n        const model = card.getAttribute('data-model');\r\n        const input = root.querySelector(`input[name=\"pesinModel\"][value=\"${model}\"]`);\r\n        if (input) { input.checked = true; }\r\n        state.pesinModel = model;\r\n        updatePesinUI(state.pesinModel);\r\n        refresh();\r\n      });\r\n    });\r\n  }\r\n\r\n  function renderChecks(){\r\n    const host = document.getElementById('checksBody'); if (!host) return;\r\n    host.innerHTML = '';\r\n    state.checks.forEach((c, i) => {\r\n      const row = document.createElement('div');\r\n      row.setAttribute('data-idx', String(i));\r\n      row.style.cssText = 'display:grid; grid-template-columns: 1fr 140px 60px; gap:8px; align-items:center; margin-bottom:6px;';\r\n      row.innerHTML = `\r\n        <input class=\"chk-amount\" inputmode=\"decimal\" placeholder=\"Tutar (‚Ç∫)\" value=\"${c.amount || ''}\" style=\"padding:6px;border:1px solid #d1d5db;border-radius:6px;\" />\r\n        <input class=\"chk-days\" type=\"number\" min=\"1\" placeholder=\"G√ºn\" value=\"${c.days || 30}\" style=\"padding:6px;border:1px solid #d1d5db;border-radius:6px;\" />\r\n        <button type=\"button\" class=\"btn btn-secondary chk-del\" style=\"padding:6px 10px;\">Sil</button>\r\n      `;\r\n      host.appendChild(row);\r\n    });\r\n  }\r\n\r\n  function refresh(){\r\n    const root = $('#payment-section'); if (!root) return;\r\n    show($('#pesin-group'), state.paymentType === 'pesin');\r\n    show($('#kk-group'), state.paymentType === 'krediKarti');\r\n    show($('#ah-group'), state.paymentType === 'acikHesap');\r\n    show($('#evrak-group'), state.paymentType === 'evrak');\r\n    if (state.paymentType === 'pesin') updatePesinUI(state.pesinModel);\r\n    // highlight selected card\r\n    const cards = root.querySelectorAll('.payment-card');\r\n    cards.forEach((c)=>{ c.classList.toggle('selected', c.getAttribute('data-model') === state.pesinModel); });\r\n    if (state.paymentType === 'krediKarti'){\r\n      const installments = Math.max(1, state.installments);\r\n      const fin = calcFinance({ totalIncl: state.totalIncl, financeRate: state.financeRate, installments });\r\n      if ($('#ccBaseIncl')) $('#ccBaseIncl').textContent = state.totalIncl.toFixed(2) + ' ‚Ç∫';\r\n      if ($('#ccFinanceAmt')) $('#ccFinanceAmt').textContent = fin.financeAmt.toFixed(2) + ' ‚Ç∫';\r\n      if ($('#ccTotalIncl')) $('#ccTotalIncl').textContent = fin.grandIncl.toFixed(2) + ' ‚Ç∫';\r\n      if ($('#ccMonthly')) $('#ccMonthly').textContent = installments > 1 ? (fin.monthly.toFixed(2) + ' ‚Ç∫ x ' + installments) : '‚Äî';\r\n    } else {\r\n      if ($('#ccBaseIncl')) $('#ccBaseIncl').textContent = '‚Äî';\r\n      if ($('#ccFinanceAmt')) $('#ccFinanceAmt').textContent = '‚Äî';\r\n      if ($('#ccTotalIncl')) $('#ccTotalIncl').textContent = '‚Äî';\r\n      if ($('#ccMonthly')) $('#ccMonthly').textContent = '‚Äî';\r\n    }\r\n    if (state.paymentType === 'acikHesap') { const res = addBusinessDaysFromInvoice(state.invoiceDate, state.netDays); if ($('#dueDateHuman')) $('#dueDateHuman').textContent = res.label; } else { if ($('#dueDateHuman')) $('#dueDateHuman').textContent = '‚Äî'; }\r\n    if ($('#summary')) $('#summary').innerHTML = renderSummary({ state });\r\n  }\r\n\r\n  function renderSummary({ state }){\r\n    const rows = [];\r\n    rows.push(`<div><b>√ñdeme Tipi:</b> ${state.paymentType ?? '‚Äî'}</div>`);\r\n    rows.push(`<div><b>KDV Dahil Toplam:</b> ${state.totalIncl.toFixed(2)} ‚Ç∫</div>`);\r\n    if (state.paymentType === 'pesin') { rows.push(`<div><b>Pe≈üin Model:</b> ${state.pesinModel ?? '‚Äî'}</div>`); if (state.pesinModel === 'onodeme') rows.push(`<div><b>√ñn √∂deme oranƒ±:</b> %${state.prepaymentRate}</div>`); }\r\n    if (state.paymentType === 'krediKarti') { rows.push(`<div><b>Taksit:</b> ${Math.max(1,state.installments)} | <b>Vade Farkƒ±:</b> %${state.financeRate} | <b>Kampanya:</b> ${state.ccCampaign||'‚Äî'}</div>`); }\r\n    if (state.paymentType === 'acikHesap') { const label = ($('#dueDateHuman')?.textContent)||'‚Äî'; rows.push(`<div><b>Fatura Tarihi:</b> ${state.invoiceDate || '‚Äî'} | <b>Vade:</b> +${state.netDays} g√ºn ‚Üí <b>Son √ñdeme:</b> ${label}</div>`); }\r\n    if (state.paymentType === 'evrak') { rows.push(`<div><b>√áek Sayƒ±sƒ±:</b> ${state.checks.length} | <b>Toplam:</b> ${state.checks.reduce((s,c)=>s+Number(c.amount||0),0).toFixed(2)} ‚Ç∫</div>`); }\r\n    return rows.join('');\r\n  }\r\n\r\n  function onSave(){\r\n    const payload = getPayload();\r\n    const evt = new CustomEvent('payment:save', { detail: payload });\r\n    document.dispatchEvent(evt);\r\n    alert('√ñdeme tercihleri kaydedildi.');\r\n  }\r\n\r\n  function init(){ if (document.getElementById('payment-section') && !bound){ bind(); refresh(); } }\r\n  function setTotals({ totalIncl }){ if (typeof totalIncl === 'number') state.totalIncl = totalIncl; refresh(); }\r\n  function setRole(role){ if (role) state.role = role; refresh(); }\r\n  function getPayload(){\r\n    return {\r\n      role: state.role,\r\n      paymentType: state.paymentType,\r\n      totals: { incl: state.totalIncl },\r\n      pesin: state.paymentType === 'pesin' ? { model: state.pesinModel, prepaymentRate: state.pesinModel==='onodeme' ? state.prepaymentRate : null } : null,\r\n      krediKarti: state.paymentType === 'krediKarti' ? { installments: Math.max(1,state.installments), financeRate: state.financeRate, campaign: state.ccCampaign } : null,\r\n      acikHesap: state.paymentType === 'acikHesap' ? { invoiceDate: state.invoiceDate, netDays: state.netDays } : null,\r\n      evrak: state.paymentType === 'evrak' ? { checks: state.checks } : null\r\n    };\r\n  }\r\n\r\n  // Auto-init on load\r\n  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();\r\n  window.paymentModule = api;\r\n})();\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\price-update.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'auth' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'user' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":44,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":44,"endColumn":13},{"ruleId":"no-undef","severity":1,"message":"'XLSX' is not defined.","line":94,"column":14,"nodeType":"Identifier","messageId":"undef","endLine":94,"endColumn":18},{"ruleId":"no-undef","severity":1,"message":"'XLSX' is not defined.","line":95,"column":14,"nodeType":"Identifier","messageId":"undef","endLine":95,"endColumn":18},{"ruleId":"no-undef","severity":1,"message":"'XLSX' is not defined.","line":96,"column":3,"nodeType":"Identifier","messageId":"undef","endLine":96,"endColumn":7},{"ruleId":"no-undef","severity":1,"message":"'XLSX' is not defined.","line":97,"column":3,"nodeType":"Identifier","messageId":"undef","endLine":97,"endColumn":7}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db, auth, requireAuth } from '/firebase.js';\r\nimport { collection, getDocs, query, where, updateDoc, doc, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';\r\n\r\nconst qs = s => document.querySelector(s);\r\n\r\nconst state = {\r\n  stocks: [],\r\n  filteredStocks: []\r\n};\r\n\r\nfunction renderTable() {\r\n  const tbody = qs('#updateTable tbody');\r\n  const table = qs('#updateTable');\r\n  \r\n  tbody.innerHTML = '';\r\n  \r\n  if (!state.filteredStocks.length) {\r\n    table.style.display = 'none';\r\n    qs('#updateInfo').textContent = 'Stok bulunamadƒ±.';\r\n    qs('#btnApply').disabled = true;\r\n    return;\r\n  }\r\n  \r\n  table.style.display = 'table';\r\n  state.filteredStocks.forEach(stock => {\r\n    const tr = document.createElement('tr');\r\n    tr.innerHTML = `\r\n      <td>${stock.sku}</td>\r\n      <td>${stock.name}</td>\r\n      <td>${stock.unit || 'ADT'}</td>\r\n      <td>${stock.lastPurchasePrice || 0}</td>\r\n      <td><input type=\"number\" step=\"0.01\" data-sku=\"${stock.sku}\" data-field=\"lastPurchasePrice\" value=\"${stock.lastPurchasePrice || 0}\" /></td>\r\n      <td>${stock.salePrice || 0}</td>\r\n      <td><input type=\"number\" step=\"0.01\" data-sku=\"${stock.sku}\" data-field=\"salePrice\" value=\"${stock.salePrice || 0}\" /></td>\r\n    `;\r\n    tbody.appendChild(tr);\r\n  });\r\n  \r\n  qs('#updateInfo').textContent = `${state.filteredStocks.length} √ºr√ºn y√ºklendi.`;\r\n  qs('#btnApply').disabled = false;\r\n}\r\n\r\nasync function loadStocks() {\r\n  const user = await requireAuth();\r\n  \r\n  try {\r\n    const code1 = qs('#filterCode').value.trim();\r\n    const brand = qs('#filterBrand').value.trim();\r\n    const unit = qs('#filterUnit').value;\r\n    \r\n    let q = collection(db, 'stocks');\r\n    let constraints = [];\r\n    \r\n    if (code1) {\r\n      constraints.push(where('customCodes.code1', '==', code1));\r\n    }\r\n    \r\n    const snap = await getDocs(constraints.length ? query(q, ...constraints) : q);\r\n    state.stocks = [];\r\n    \r\n    snap.forEach(doc => {\r\n      const data = doc.data();\r\n      if (brand && data.brand !== brand) return;\r\n      if (unit && data.unit !== unit) return;\r\n      \r\n      state.stocks.push({ id: doc.id, ...data });\r\n    });\r\n    \r\n    state.filteredStocks = [...state.stocks];\r\n    renderTable();\r\n    \r\n    // Download Excel\r\n    if (state.filteredStocks.length > 0) {\r\n      downloadExcel();\r\n    }\r\n    \r\n  } catch (error) {\r\n    console.error('Load error:', error);\r\n    alert('Stoklar y√ºklenemedi: ' + error.message);\r\n  }\r\n}\r\n\r\nfunction downloadExcel() {\r\n  const rows = state.filteredStocks.map(s => ({\r\n    'Stok Kodu': s.sku,\r\n    '√úr√ºn Adƒ±': s.name,\r\n    'Birim': s.unit || 'ADT',\r\n    'Eski Alƒ±m Fiyatƒ±': s.lastPurchasePrice || 0,\r\n    'Yeni Alƒ±m Fiyatƒ±': s.lastPurchasePrice || 0,\r\n    'Eski Satƒ±≈ü Fiyatƒ±': s.salePrice || 0,\r\n    'Yeni Satƒ±≈ü Fiyatƒ±': s.salePrice || 0\r\n  }));\r\n  \r\n  const ws = XLSX.utils.json_to_sheet(rows);\r\n  const wb = XLSX.utils.book_new();\r\n  XLSX.utils.book_append_sheet(wb, ws, 'Fiyatlar');\r\n  XLSX.writeFile(wb, `fiyat-guncelleme-${Date.now()}.xlsx`);\r\n}\r\n\r\nasync function applyUpdates() {\r\n  const user = await requireAuth();\r\n  \r\n  const inputs = qs('#updateTable tbody').querySelectorAll('input[type=number]');\r\n  const updates = {};\r\n  \r\n  inputs.forEach(input => {\r\n    const sku = input.dataset.sku;\r\n    const field = input.dataset.field;\r\n    const newValue = parseFloat(input.value) || 0;\r\n    \r\n    if (!updates[sku]) {\r\n      updates[sku] = {};\r\n    }\r\n    updates[sku][field] = newValue;\r\n  });\r\n  \r\n  if (!Object.keys(updates).length) {\r\n    alert('G√ºncelleme yapƒ±lacak deƒüi≈üiklik yok!');\r\n    return;\r\n  }\r\n  \r\n  if (!confirm(`${Object.keys(updates).length} √ºr√ºn g√ºncellenecek. Devam edilsin mi?`)) {\r\n    return;\r\n  }\r\n  \r\n  qs('#btnApply').disabled = true;\r\n  qs('#btnApply').textContent = 'G√ºncelleniyor...';\r\n  \r\n  let success = 0;\r\n  let errors = 0;\r\n  \r\n  for (const sku in updates) {\r\n    try {\r\n      const stock = state.stocks.find(s => s.sku === sku);\r\n      if (!stock) continue;\r\n      \r\n      await updateDoc(doc(db, 'stocks', stock.id), {\r\n        ...updates[sku],\r\n        updatedAt: serverTimestamp()\r\n      });\r\n      success++;\r\n    } catch (error) {\r\n      console.error('Update error:', sku, error);\r\n      errors++;\r\n    }\r\n  }\r\n  \r\n  // Log price update\r\n  await addDoc(collection(db, 'price_updates'), {\r\n    fileName: `fiyat-guncelleme-${Date.now()}.xlsx`,\r\n    appliedBy: user.uid,\r\n    appliedAt: serverTimestamp(),\r\n    totalUpdated: success,\r\n    rules: { code: qs('#filterCode').value, brand: qs('#filterBrand').value, unit: qs('#filterUnit').value }\r\n  });\r\n  \r\n  alert(`G√ºncelleme tamamlandƒ±!\\nBa≈üarƒ±lƒ±: ${success}\\nHata: ${errors}`);\r\n  \r\n  qs('#btnApply').textContent = 'G√ºncelle';\r\n  qs('#btnApply').disabled = false;\r\n  \r\n  await loadStocks();\r\n}\r\n\r\nqs('#btnLoad').addEventListener('click', loadStocks);\r\nqs('#btnApply').addEventListener('click', applyUpdates);\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\purchase-form-detail.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\purchase-form.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'doc' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getDoc' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'qsa' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":6,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":10},{"ruleId":"no-undef","severity":1,"message":"'XLSX' is not defined.","line":127,"column":15,"nodeType":"Identifier","messageId":"undef","endLine":127,"endColumn":19},{"ruleId":"no-undef","severity":1,"message":"'XLSX' is not defined.","line":151,"column":14,"nodeType":"Identifier","messageId":"undef","endLine":151,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db, auth } from '/firebase.js';\r\nimport { normalizeTR, parseDateSmart } from '/scripts/lib/normalize-tr.js';\r\nimport { doc, getDoc, addDoc, collection, serverTimestamp, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-lite.js';\r\n\r\nconst qs = s => document.querySelector(s);\r\nconst qsa = s => Array.from(document.querySelectorAll(s));\r\n\r\nconst state = {\r\n  rows: [],\r\n  validation: [],\r\n};\r\n\r\nconst HEADMAP = {\r\n  'sƒ±ra no': 'lineNo', 'sira no': 'lineNo', 'no': 'lineNo',\r\n  'malzeme kodu': 'sku', 'stok kodu':'sku', 'sku':'sku',\r\n  'malzeme tanƒ±mƒ±': 'name', 'malzeme tanimi':'name', 'urun adi':'name', '√ºr√ºn adƒ±':'name', 'ad':'name',\r\n  'marka/model': 'brandModel', 'marka model': 'brandModel', 'marka':'brandModel', 'model':'brandModel',\r\n  'miktar': 'qty', 'qty':'qty',\r\n  'birim': 'unit', 'unit':'unit',\r\n  'ambardaki miktar': 'stockInWarehouse', 'depodaki miktar':'stockInWarehouse',\r\n  '√ºr√ºn g√∂rseli': 'imageUrl', 'urun gorseli':'imageUrl', 'gorsel':'imageUrl',\r\n  'istenilen teslim tarihi': 'requestedDate', 'teslim tarihi':'requestedDate',\r\n  'a√ßƒ±klama': 'note', 'aciklama':'note'\r\n};\r\n\r\nfunction mapHeaders(headers){\r\n  return headers.map(h => HEADMAP[normalizeTR(h)] || null);\r\n}\r\n\r\nfunction toNumber(v){\r\n  if (typeof v === 'number') return v;\r\n  const s = String(v ?? '').replace(',', '.').trim();\r\n  const n = parseFloat(s);\r\n  return isFinite(n) ? n : NaN;\r\n}\r\n\r\nfunction renderPreview(){\r\n  const tbody = qs('#previewTable tbody');\r\n  tbody.innerHTML = '';\r\n  state.rows.forEach(r => {\r\n    const tr = document.createElement('tr');\r\n    const badge = r.matchStatus === 'FOUND' ? 'b-found' : r.matchStatus === 'MULTI' ? 'b-multi' : 'b-new';\r\n    const badgeText = r.matchStatus === 'FOUND' ? '‚úÖ Bulundu' : r.matchStatus === 'MULTI' ? '‚ö†Ô∏è √áok Aday' : 'üÜï Yeni';\r\n    tr.innerHTML = `\r\n      <td>${r.lineNo ?? ''}</td>\r\n      <td>${r.sku ?? ''}</td>\r\n      <td>${r.name ?? ''}</td>\r\n      <td>${r.brandModel ?? ''}</td>\r\n      <td>${r.qty ?? ''}</td>\r\n      <td>${r.unit ?? ''}</td>\r\n      <td>${r.stockInWarehouse ?? ''}</td>\r\n      <td>${r.imageUrl ?? ''}</td>\r\n      <td>${r.requestedDate ?? ''}</td>\r\n      <td>${r.note ?? ''}</td>\r\n      <td><span class=\"badge ${badge}\">${badgeText}</span></td>\r\n    `;\r\n    tbody.appendChild(tr);\r\n  });\r\n}\r\n\r\nfunction renderValidation(){\r\n  const ul = qs('#validationList');\r\n  ul.innerHTML = '';\r\n  if (!state.validation.length){\r\n    ul.innerHTML = '<li>Hi√ß hata/uyarƒ± yok.</li>';\r\n    return;\r\n  }\r\n  state.validation.forEach(v => {\r\n    const li = document.createElement('li');\r\n    li.className = v.level === 'error' ? 'err' : 'warn';\r\n    li.textContent = v.msg;\r\n    ul.appendChild(li);\r\n  });\r\n}\r\n\r\nasync function findStocksBy(r){\r\n  try{\r\n    // 1) SKU ile\r\n    if (r.sku){\r\n      const q1 = query(collection(db,'stocks'), where('sku','==', String(r.sku)));\r\n      const s1 = await getDocs(q1);\r\n      if (s1.size === 1) return { status:'FOUND', sku: s1.docs[0].data().sku };\r\n      if (s1.size > 1) return { status:'MULTI', options: s1.docs.map(d=>d.data().sku) };\r\n    }\r\n    // 2) name + unit startsWith\r\n    const start = normalizeTR(r.name || '');\r\n    if (!start) return { status:'NEW' };\r\n    const snap = await getDocs(collection(db,'stocks'));\r\n    const candidates = [];\r\n    snap.forEach(d => {\r\n      const x = d.data();\r\n      if (normalizeTR(x.unit||'') === normalizeTR(r.unit||'') && normalizeTR(x.name||'').startsWith(start)){\r\n        candidates.push(x);\r\n      }\r\n    });\r\n    if (candidates.length === 1) return { status:'FOUND', sku: candidates[0].sku };\r\n    if (candidates.length > 1) return { status:'MULTI', options: candidates.map(c=>c.sku) };\r\n    return { status:'NEW' };\r\n  }catch(e){\r\n    console.warn('stock search failed', e); return { status:'NEW' };\r\n  }\r\n}\r\n\r\nasync function validateAndMatch(){\r\n  state.validation = [];\r\n  for (const r of state.rows){\r\n    if (!r.name) state.validation.push({level:'error', msg:`Satƒ±r ${r.lineNo}: Malzeme Tanƒ±mƒ± zorunlu`});\r\n    if (!(toNumber(r.qty) > 0)) state.validation.push({level:'error', msg:`Satƒ±r ${r.lineNo}: Miktar > 0 olmalƒ±`});\r\n    if (!r.unit) state.validation.push({level:'error', msg:`Satƒ±r ${r.lineNo}: Birim zorunlu`});\r\n    if (r.requestedDate){\r\n      const iso = parseDateSmart(r.requestedDate);\r\n      r.requestedDate = iso || r.requestedDate;\r\n      if (!iso) state.validation.push({level:'warn', msg:`Satƒ±r ${r.lineNo}: Tarih tanƒ±namadƒ±, olduƒüu gibi kaydedilecek`});\r\n    }\r\n    const match = await findStocksBy(r);\r\n    r.matchStatus = match.status;\r\n    if (match.status === 'FOUND') r.sku = r.sku || match.sku;\r\n    if (match.status === 'MULTI') state.validation.push({level:'warn', msg:`Satƒ±r ${r.lineNo}: Birden fazla stok adayƒ± bulundu`});\r\n  }\r\n  renderPreview();\r\n  renderValidation();\r\n  qs('#btnCreate').disabled = state.validation.some(v=>v.level==='error');\r\n  console.table(state.validation);\r\n}\r\n\r\nfunction parseSheet(ws){\r\n  const aoa = XLSX.utils.sheet_to_json(ws, { header:1, raw:false });\r\n  if (!aoa.length) return [];\r\n  const headerRow = aoa[0];\r\n  const map = mapHeaders(headerRow);\r\n  const rows = [];\r\n  for (let i=1;i<aoa.length;i++){\r\n    const row = aoa[i];\r\n    if (!row || row.every(c => (String(c||'').trim()===''))) continue;\r\n    const r = {};\r\n    map.forEach((k,idx)=>{ if(!k) return; r[k] = row[idx]; });\r\n    r.lineNo = r.lineNo ?? i;\r\n    if (r.qty != null) r.qty = toNumber(r.qty);\r\n    if (r.stockInWarehouse != null) r.stockInWarehouse = toNumber(r.stockInWarehouse);\r\n    r.unit = r.unit ? String(r.unit).trim().toLowerCase() : '';\r\n    r.name = r.name ? String(r.name).trim() : '';\r\n    rows.push(r);\r\n  }\r\n  return rows;\r\n}\r\n\r\nasync function onFile(e){\r\n  const f = e.target.files?.[0];\r\n  if (!f) return;\r\n  const data = await f.arrayBuffer();\r\n  const wb = XLSX.read(data, { type:'array' });\r\n  const ws = wb.Sheets[wb.SheetNames[0]];\r\n  // Detect SATFK template (H3 contains SATFK label, items from row 6, fixed columns)\r\n  const h3 = ws['H3']?.v ? String(ws['H3'].v).toUpperCase() : '';\r\n  if (h3.includes('SATFK')){\r\n    const rows = [];\r\n    for (let r=6; r<10000; r++){\r\n      const name = ws[`C${r}`]?.v;\r\n      const qty = ws[`E${r}`]?.v;\r\n      const unit = ws[`F${r}`]?.v;\r\n      const allEmpty = [ws[`B${r}`],name,qty,unit,ws[`I${r}`],ws[`J${r}`]].every(c=>!c || String(c.v).trim()==='');\r\n      if (allEmpty) break;\r\n      if (!name && !qty && !unit) continue;\r\n      rows.push({\r\n        lineNo: ws[`A${r}`]?.v ?? (r-5),\r\n        sku: ws[`B${r}`]?.v ?? null,\r\n        name: name ?? '',\r\n        brandModel: ws[`D${r}`]?.v ?? null,\r\n        qty: toNumber(qty),\r\n        unit: unit ? String(unit).toLowerCase() : '',\r\n        stockInWarehouse: toNumber(ws[`G${r}`]?.v),\r\n        imageUrl: ws[`H${r}`]?.v ?? null,\r\n        requestedDate: parseDateSmart(ws[`I${r}`]?.v) || ws[`I${r}`]?.v || null,\r\n        note: ws[`J${r}`]?.v ?? null,\r\n      });\r\n    }\r\n    state.rows = rows;\r\n  } else {\r\n    state.rows = parseSheet(ws);\r\n  }\r\n  qs('#previewInfo').textContent = `${state.rows.length} satƒ±r okundu.`;\r\n  await validateAndMatch();\r\n}\r\n\r\nasync function createRequest(){\r\n  const user = auth.currentUser;\r\n  if (!user) { alert('Oturum bulunamadƒ±'); return; }\r\n  const meta = {\r\n    type: qs('#pfType').value || 'IMTF',\r\n    title: qs('#pfTitle').value?.trim() || 'Satƒ±n Alma Talebi',\r\n    locationId: qs('#pfLocation').value?.trim() || null,\r\n    deliveryAddress: qs('#pfDelivery').value?.trim() || '',\r\n    deliveryIsFreightIncluded: !!qs('#pfFreight').checked,\r\n    requesterUserId: user.uid,\r\n    requesterName: qs('#pfRequester').value?.trim() || user.displayName || user.email,\r\n    note: qs('#pfNote').value?.trim() || '',\r\n    createdAt: serverTimestamp(),\r\n    status: 'DRAFT',\r\n  };\r\n\r\n  try{\r\n    const reqRef = await addDoc(collection(db,'internal_requests'), meta);\r\n    const linesCol = collection(reqRef, 'material_lines');\r\n    for (const r of state.rows){\r\n      const line = {\r\n        lineNo: r.lineNo ?? 0,\r\n        sku: r.sku || null,\r\n        name: r.name || '',\r\n        brandModel: r.brandModel || null,\r\n        qty: r.qty || 0,\r\n        unit: r.unit || '',\r\n        warehouseQty: r.stockInWarehouse ?? null,\r\n        imageUrl: r.imageUrl || null,\r\n        requestedDate: r.requestedDate || null,\r\n        note: r.note || null,\r\n        matchStatus: r.matchStatus || 'NEW'\r\n      };\r\n      await addDoc(linesCol, line);\r\n    }\r\n    alert('Talep olu≈üturuldu.');\r\n    location.href = `/pages/purchase-form-detail.html?id=${reqRef.id}`;\r\n  }catch(e){\r\n    console.error(e); alert('Kayƒ±t sƒ±rasƒ±nda hata: '+ e.message);\r\n  }\r\n}\r\n\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n  qs('#pfFile').addEventListener('change', onFile);\r\n  qs('#btnCreate').addEventListener('click', createRequest);\r\n});\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\reports.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'auth' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'where' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":43},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'s' is defined but never used. Allowed unused args must match /^_/u.","line":65,"column":41,"nodeType":null,"messageId":"unusedVar","endLine":65,"endColumn":42}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db, auth, requireAuth } from '/firebase.js';\r\nimport { collection, getDocs, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';\r\n\r\nconst qs = s => document.querySelector(s);\r\n\r\nconst state = {\r\n  stocks: [],\r\n  movements: [],\r\n  locations: []\r\n};\r\n\r\n// Tab switching\r\nqs('.tabs').addEventListener('click', (e) => {\r\n  const tab = e.target.closest('.tab');\r\n  if (!tab) return;\r\n  \r\n  qs('.tab.active').classList.remove('active');\r\n  tab.classList.add('active');\r\n  \r\n  const panelName = tab.dataset.tab + 'Panel';\r\n  document.querySelectorAll('[id$=\"Panel\"]').forEach(p => p.classList.add('hidden'));\r\n  qs('#' + panelName).classList.remove('hidden');\r\n  \r\n  // Load report data\r\n  if (tab.dataset.tab === 'minstock') loadMinStockReport();\r\n  else if (tab.dataset.tab === 'costsale') loadCostSaleReport();\r\n  else if (tab.dataset.tab === 'location') loadLocationReport();\r\n  else if (tab.dataset.tab === 'cost') loadCostReport();\r\n});\r\n\r\nasync function loadInitialData() {\r\n  try {\r\n    const stocksSnap = await getDocs(collection(db, 'stocks'));\r\n    state.stocks = [];\r\n    stocksSnap.forEach(doc => {\r\n      state.stocks.push({ id: doc.id, ...doc.data() });\r\n    });\r\n    \r\n    const movementsSnap = await getDocs(query(\r\n      collection(db, 'stock_movements'),\r\n      orderBy('createdAt', 'desc')\r\n    ));\r\n    state.movements = [];\r\n    movementsSnap.forEach(doc => {\r\n      state.movements.push({ id: doc.id, ...doc.data() });\r\n    });\r\n    \r\n    const locsSnap = await getDocs(collection(db, 'stock_locations'));\r\n    state.locations = [];\r\n    locsSnap.forEach(doc => {\r\n      state.locations.push({ id: doc.id, ...doc.data() });\r\n    });\r\n    \r\n    // Load first report\r\n    loadMinStockReport();\r\n    \r\n  } catch (error) {\r\n    console.error('Initial load error:', error);\r\n  }\r\n}\r\n\r\nasync function loadMinStockReport() {\r\n  // Filter stocks below minimum threshold\r\n  const minThreshold = 10; // TODO: add to stock data\r\n  const lowStocks = state.stocks.filter(s => {\r\n    const current = 0; // TODO: calculate from movements\r\n    return current < minThreshold;\r\n  });\r\n  \r\n  const stats = qs('#minstockStats');\r\n  stats.innerHTML = `\r\n    <div class=\"stat-card\">\r\n      <div class=\"stat-value\">${lowStocks.length}</div>\r\n      <div class=\"stat-label\">D√º≈ü√ºk Stok</div>\r\n    </div>\r\n  `;\r\n  \r\n  const tbody = qs('#minstockTable tbody');\r\n  tbody.innerHTML = '';\r\n  \r\n  if (!lowStocks.length) {\r\n    tbody.innerHTML = '<tr><td colspan=\"7\" style=\"text-align:center;color:#6b7280\">D√º≈ü√ºk stok bulunamadƒ±.</td></tr>';\r\n    return;\r\n  }\r\n  \r\n  lowStocks.forEach(stock => {\r\n    const tr = document.createElement('tr');\r\n    const current = 0; // TODO: calculate\r\n    tr.innerHTML = `\r\n      <td>${stock.sku}</td>\r\n      <td>${stock.name}</td>\r\n      <td>${stock.brand || '-'}</td>\r\n      <td>${stock.unit || 'ADT'}</td>\r\n      <td>${current}</td>\r\n      <td>${minThreshold}</td>\r\n      <td><span class=\"badge b-error\">‚ö†Ô∏è D√º≈ü√ºk</span></td>\r\n    `;\r\n    tbody.appendChild(tr);\r\n  });\r\n}\r\n\r\nasync function loadCostSaleReport() {\r\n  const belowCost = state.movements.filter(m => {\r\n    if (m.type !== 'OUT') return false;\r\n    const stock = state.stocks.find(s => s.id === m.stockId);\r\n    if (!stock) return false;\r\n    return stock.avgCost > 0 && m.unitCost > 0 && m.unitCost < stock.avgCost;\r\n  });\r\n  \r\n  const stats = qs('#costsaleStats');\r\n  stats.innerHTML = `\r\n    <div class=\"stat-card\">\r\n      <div class=\"stat-value\">${belowCost.length}</div>\r\n      <div class=\"stat-label\">Maliyet Altƒ±</div>\r\n    </div>\r\n  `;\r\n  \r\n  const tbody = qs('#costsaleTable tbody');\r\n  tbody.innerHTML = '';\r\n  \r\n  if (!belowCost.length) {\r\n    tbody.innerHTML = '<tr><td colspan=\"7\" style=\"text-align:center;color:#6b7280\">Maliyet altƒ± satƒ±≈ü bulunamadƒ±.</td></tr>';\r\n    return;\r\n  }\r\n  \r\n  belowCost.forEach(mv => {\r\n    const stock = state.stocks.find(s => s.id === mv.stockId);\r\n    const date = mv.createdAt ? new Date(mv.createdAt.toDate()).toLocaleDateString('tr-TR') : '-';\r\n    const diff = (stock?.avgCost || 0) - (mv.unitCost || 0);\r\n    \r\n    const tr = document.createElement('tr');\r\n    tr.innerHTML = `\r\n      <td>${date}</td>\r\n      <td>${mv.sku}</td>\r\n      <td>${stock?.name || '-'}</td>\r\n      <td>${mv.qty}</td>\r\n      <td>${stock?.avgCost?.toFixed(2) || 0}</td>\r\n      <td>${mv.unitCost?.toFixed(2) || 0}</td>\r\n      <td>${diff.toFixed(2)}</td>\r\n    `;\r\n    tbody.appendChild(tr);\r\n  });\r\n}\r\n\r\nasync function loadLocationReport() {\r\n  const select = qs('#locationFilter');\r\n  select.innerHTML = '<option value=\"\">T√ºm Lokasyonlar</option>';\r\n  state.locations.forEach(loc => {\r\n    const opt = document.createElement('option');\r\n    opt.value = loc.id;\r\n    opt.textContent = `${loc.name} (${loc.type})`;\r\n    select.appendChild(opt);\r\n  });\r\n  \r\n  select.addEventListener('change', () => {\r\n    const locationId = select.value;\r\n    renderLocationTable(locationId);\r\n  });\r\n  \r\n  renderLocationTable('');\r\n}\r\n\r\nfunction renderLocationTable(locationId) {\r\n  const stats = qs('#locationStats');\r\n  let filteredMovements = state.movements;\r\n  \r\n  if (locationId) {\r\n    filteredMovements = state.movements.filter(m => m.locationId === locationId);\r\n  }\r\n  \r\n  stats.innerHTML = `\r\n    <div class=\"stat-card\">\r\n      <div class=\"stat-value\">${filteredMovements.length}</div>\r\n      <div class=\"stat-label\">Toplam Hareket</div>\r\n    </div>\r\n  `;\r\n  \r\n  const tbody = qs('#locationTable tbody');\r\n  tbody.innerHTML = '';\r\n  \r\n  // TODO: aggregate by stock and location\r\n  if (!filteredMovements.length) {\r\n    tbody.innerHTML = '<tr><td colspan=\"5\" style=\"text-align:center;color:#6b7280\">Veri bulunamadƒ±.</td></tr>';\r\n    return;\r\n  }\r\n  \r\n  filteredMovements.slice(0, 50).forEach(mv => {\r\n    const stock = state.stocks.find(s => s.id === mv.stockId);\r\n    const loc = state.locations.find(l => l.id === mv.locationId);\r\n    \r\n    const tr = document.createElement('tr');\r\n    tr.innerHTML = `\r\n      <td>${mv.sku}</td>\r\n      <td>${stock?.name || '-'}</td>\r\n      <td>${loc?.name || '-'}</td>\r\n      <td>${mv.qty}</td>\r\n      <td>${mv.unit || 'ADT'}</td>\r\n    `;\r\n    tbody.appendChild(tr);\r\n  });\r\n}\r\n\r\nasync function loadCostReport() {\r\n  const inMovements = state.movements.filter(m => m.type === 'IN');\r\n  \r\n  const stats = qs('#costStats');\r\n  stats.innerHTML = `\r\n    <div class=\"stat-card\">\r\n      <div class=\"stat-value\">${inMovements.length}</div>\r\n      <div class=\"stat-label\">Giri≈ü Hareketi</div>\r\n    </div>\r\n  `;\r\n  \r\n  const tbody = qs('#costTable tbody');\r\n  tbody.innerHTML = '';\r\n  \r\n  if (!inMovements.length) {\r\n    tbody.innerHTML = '<tr><td colspan=\"8\" style=\"text-align:center;color:#6b7280\">Giri≈ü hareketi bulunamadƒ±.</td></tr>';\r\n    return;\r\n  }\r\n  \r\n  inMovements.slice(0, 50).forEach(mv => {\r\n    const stock = state.stocks.find(s => s.id === mv.stockId);\r\n    const date = mv.createdAt ? new Date(mv.createdAt.toDate()).toLocaleDateString('tr-TR') : '-';\r\n    const extras = mv.extras?.reduce((sum, e) => sum + (e.amount || 0), 0) || 0;\r\n    \r\n    const tr = document.createElement('tr');\r\n    tr.innerHTML = `\r\n      <td>${date}</td>\r\n      <td>${mv.sku}</td>\r\n      <td>${stock?.name || '-'}</td>\r\n      <td>üì• Giri≈ü</td>\r\n      <td>${mv.qty}</td>\r\n      <td>${mv.unitCost?.toFixed(2) || 0}</td>\r\n      <td>${extras.toFixed(2)}</td>\r\n      <td>${mv.totalCost?.toFixed(2) || 0}</td>\r\n    `;\r\n    tbody.appendChild(tr);\r\n  });\r\n}\r\n\r\n// Initialize\r\nawait requireAuth();\r\nloadInitialData();\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\request-detail.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\request-site.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'auth' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'normalizeTR' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'normalizeTRLower' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'initSkuAutocomplete' is defined but never used. Allowed unused vars must match /^_/u.","line":282,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":282,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused args must match /^_/u.","line":378,"column":35,"nodeType":null,"messageId":"unusedVar","endLine":378,"endColumn":36},{"ruleId":"no-undef","severity":1,"message":"'XLSX' is not defined.","line":733,"column":16,"nodeType":"Identifier","messageId":"undef","endLine":733,"endColumn":20},{"ruleId":"no-undef","severity":1,"message":"'XLSX' is not defined.","line":750,"column":17,"nodeType":"Identifier","messageId":"undef","endLine":750,"endColumn":21},{"ruleId":"no-undef","severity":1,"message":"'XLSX' is not defined.","line":758,"column":5,"nodeType":"Identifier","messageId":"undef","endLine":758,"endColumn":9},{"ruleId":"no-undef","severity":1,"message":"'XLSX' is not defined.","line":771,"column":17,"nodeType":"Identifier","messageId":"undef","endLine":771,"endColumn":21},{"ruleId":"no-undef","severity":1,"message":"'XLSX' is not defined.","line":784,"column":5,"nodeType":"Identifier","messageId":"undef","endLine":784,"endColumn":9},{"ruleId":"no-undef","severity":1,"message":"'XLSX' is not defined.","line":788,"column":5,"nodeType":"Identifier","messageId":"undef","endLine":788,"endColumn":9}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * REFACTORED: ≈ûMTF Form - Yeni Veri Modeli\r\n * \r\n * - ≈ûantiyeler: /companies/{companyId}/sites\r\n * - Stok Kartlarƒ±: /companies/{companyId}/inventory\r\n * - Searchable dropdown, otomatik adres doldurma, SKU autocomplete\r\n */\r\n\r\nimport { db, auth, requireAuth } from '/firebase.js';\r\nimport { normalizeTR, normalizeTRLower } from '/scripts/lib/tr-utils.js';\r\nimport { \r\n  collection, getDocs, query, where, addDoc, doc, getDoc, \r\n  orderBy, serverTimestamp \r\n} from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';\r\n\r\nconst qs = s => document.querySelector(s);\r\n\r\n// State\r\nconst state = {\r\n  sites: [],           // /companies/{companyId}/sites\r\n  inventory: [],       // /companies/{companyId}/inventory (cache)\r\n  selectedSite: null,  // Se√ßili ≈üantiye objesi\r\n  selectedAddress: null, // Se√ßili adres (defaultAddress veya addresses[i])\r\n  lines: [],           // Malzeme satƒ±rlarƒ±\r\n  companyId: null      // Kullanƒ±cƒ±nƒ±n companyId'si\r\n};\r\n\r\nlet lineCounter = 1;\r\n\r\n// ====================\r\n// Yardƒ±mcƒ± Fonksiyonlar\r\n// ====================\r\n\r\n/**\r\n * Adres objesini string formatƒ±na √ßevir\r\n */\r\nfunction formatAddress(addr) {\r\n  if (!addr) return '';\r\n  const parts = [\r\n    addr.line1,\r\n    addr.line2,\r\n    addr.district ? `${addr.district}/${addr.city}` : addr.city,\r\n    addr.postalCode,\r\n    addr.country\r\n  ].filter(Boolean);\r\n  return parts.join(' - ');\r\n}\r\n\r\n/**\r\n * ≈ûantiyeleri listele: /companies/{companyId}/sites\r\n */\r\nasync function listSites(companyId) {\r\n  try {\r\n    const q = query(\r\n      collection(db, 'companies', companyId, 'sites'),\r\n      where('isActive', '==', true),\r\n      orderBy('siteName', 'asc')\r\n    );\r\n    const snap = await getDocs(q);\r\n    return snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n  } catch (error) {\r\n    console.error('Sites load error:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\n/**\r\n * Stok kartlarƒ±nƒ± listele: /companies/{companyId}/inventory\r\n */\r\nasync function loadInventory(companyId) {\r\n  try {\r\n    const snap = await getDocs(collection(db, 'companies', companyId, 'inventory'));\r\n    state.inventory = snap.docs.map(d => ({ sku: d.id, ...d.data() }));\r\n    console.log(`‚úÖ Loaded ${state.inventory.length} inventory items`);\r\n  } catch (error) {\r\n    console.error('Inventory load error:', error);\r\n    state.inventory = [];\r\n  }\r\n}\r\n\r\n/**\r\n * SKU'ya g√∂re stok kartƒ± getir\r\n */\r\nasync function getInventoryItem(companyId, sku) {\r\n  try {\r\n    // √ñnce cache'den bak\r\n    const cached = state.inventory.find(inv => inv.sku === sku || inv.sku?.toUpperCase() === sku.toUpperCase());\r\n    if (cached) return cached;\r\n    \r\n    // Cache'de yoksa Firestore'dan √ßek\r\n    const ref = doc(db, 'companies', companyId, 'inventory', sku);\r\n    const snap = await getDoc(ref);\r\n    if (snap.exists()) {\r\n      const data = { sku: snap.id, ...snap.data() };\r\n      state.inventory.push(data); // Cache'e ekle\r\n      return data;\r\n    }\r\n    return null;\r\n  } catch (error) {\r\n    console.error('Inventory item load error:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n// ====================\r\n// ≈ûantiye Dropdown (Searchable)\r\n// ====================\r\n\r\nlet locationInput = null;\r\nlet locationDropdown = null;\r\n\r\nfunction initSiteDropdown() {\r\n  locationInput = qs('#reqLocation');\r\n  locationDropdown = qs('#locationDropdown');\r\n  \r\n  if (!locationInput || !locationDropdown) return;\r\n  \r\n  // Input'a yazarken filtrele\r\n  locationInput.addEventListener('input', (e) => {\r\n    const query = e.target.value.toLowerCase().trim();\r\n    filterAndShowSites(query);\r\n  });\r\n  \r\n  // Focus'ta dropdown g√∂ster\r\n  locationInput.addEventListener('focus', () => {\r\n    if (state.sites.length > 0) {\r\n      filterAndShowSites('');\r\n    }\r\n  });\r\n  \r\n  // Click outside to close\r\n  document.addEventListener('click', (e) => {\r\n    if (locationInput && locationDropdown && \r\n        !locationInput.parentElement.contains(e.target) && \r\n        !locationDropdown.contains(e.target)) {\r\n      locationDropdown.style.display = 'none';\r\n    }\r\n  });\r\n}\r\n\r\nfunction filterAndShowSites(query) {\r\n  if (!locationDropdown) return;\r\n  \r\n  const filtered = state.sites.filter(site => {\r\n    if (!query) return true;\r\n    const searchText = (site.siteName || '').toLowerCase();\r\n    return searchText.includes(query);\r\n  }).slice(0, 20); // ƒ∞lk 20 sonu√ß\r\n  \r\n  if (filtered.length === 0) {\r\n    locationDropdown.innerHTML = '<div style=\"padding:8px;color:#6b7280\">≈ûantiye bulunamadƒ±</div>';\r\n    locationDropdown.style.display = 'block';\r\n    return;\r\n  }\r\n  \r\n  locationDropdown.innerHTML = filtered.map(site => `\r\n    <div class=\"site-option\" data-site-id=\"${site.id}\" style=\"padding:8px;cursor:pointer;border-bottom:1px solid #e5e7eb\">\r\n      <strong>${site.siteName || 'ƒ∞simsiz ≈ûantiye'}</strong>\r\n    </div>\r\n  `).join('');\r\n  \r\n  // Click handler\r\n  locationDropdown.querySelectorAll('.site-option').forEach(opt => {\r\n    opt.addEventListener('click', () => {\r\n      const siteId = opt.getAttribute('data-site-id');\r\n      const site = state.sites.find(s => s.id === siteId);\r\n      if (site) {\r\n        selectSite(site);\r\n      }\r\n    });\r\n  });\r\n  \r\n  locationDropdown.style.display = 'block';\r\n}\r\n\r\nfunction selectSite(site) {\r\n  state.selectedSite = site;\r\n  locationInput.value = site.siteName || '';\r\n  locationDropdown.style.display = 'none';\r\n  \r\n  // Default adresi doldur\r\n  if (site.defaultAddress) {\r\n    fillAddress(site.defaultAddress);\r\n    state.selectedAddress = site.defaultAddress;\r\n  }\r\n  \r\n  // ƒ∞lave adres butonunu aktif et\r\n  const btnSelectAddress = qs('#btnSelectAddress');\r\n  if (btnSelectAddress) {\r\n    btnSelectAddress.disabled = !site.addresses || site.addresses.length === 0;\r\n  }\r\n  \r\n  // Validation kontrol√º\r\n  updateActions();\r\n}\r\n\r\nfunction fillAddress(addr) {\r\n  const textarea = qs('#reqDelivery');\r\n  if (textarea && addr) {\r\n    textarea.value = formatAddress(addr);\r\n    textarea.readOnly = true;\r\n    textarea.style.background = '#f9fafb';\r\n  }\r\n}\r\n\r\n// ====================\r\n// ƒ∞lave Adres Modal\r\n// ====================\r\n\r\nfunction initAddressModal() {\r\n  const modal = qs('#addressModal');\r\n  const btnSelectAddress = qs('#btnSelectAddress');\r\n  const btnCancelAddress = qs('#btnCancelAddress');\r\n  const addressList = qs('#addressList');\r\n  \r\n  if (!modal || !btnSelectAddress) return;\r\n  \r\n  btnSelectAddress.addEventListener('click', () => {\r\n    if (!state.selectedSite) return;\r\n    \r\n    // Default adresi de ekle\r\n    const allAddresses = [];\r\n    if (state.selectedSite.defaultAddress) {\r\n      allAddresses.push({\r\n        id: 'default',\r\n        label: 'Varsayƒ±lan Adres',\r\n        ...state.selectedSite.defaultAddress\r\n      });\r\n    }\r\n    \r\n    if (state.selectedSite.addresses && state.selectedSite.addresses.length > 0) {\r\n      allAddresses.push(...state.selectedSite.addresses);\r\n    }\r\n    \r\n    addressList.innerHTML = allAddresses.map((addr, idx) => `\r\n      <div class=\"address-option\" data-addr-idx=\"${idx}\" style=\"padding:12px;margin:8px 0;border:1px solid #e5e7eb;border-radius:6px;cursor:pointer\">\r\n        <strong>${addr.label || 'Varsayƒ±lan Adres'}</strong>\r\n        <div style=\"margin-top:4px;font-size:12px;color:#6b7280\">${formatAddress(addr)}</div>\r\n      </div>\r\n    `).join('');\r\n    \r\n    addressList.querySelectorAll('.address-option').forEach(opt => {\r\n      opt.addEventListener('click', () => {\r\n        const idx = parseInt(opt.getAttribute('data-addr-idx'));\r\n        const selectedAddr = allAddresses[idx];\r\n        if (selectedAddr) {\r\n          fillAddress(selectedAddr);\r\n          state.selectedAddress = selectedAddr;\r\n          modal.style.display = 'none';\r\n          updateActions();\r\n        }\r\n      });\r\n      opt.addEventListener('mouseenter', () => {\r\n        opt.style.background = '#f3f4f6';\r\n      });\r\n      opt.addEventListener('mouseleave', () => {\r\n        opt.style.background = '#fff';\r\n      });\r\n    });\r\n    \r\n    modal.style.display = 'flex';\r\n  });\r\n  \r\n  if (btnCancelAddress) {\r\n    btnCancelAddress.addEventListener('click', () => {\r\n      modal.style.display = 'none';\r\n    });\r\n  }\r\n  \r\n  // Modal dƒ±≈üƒ±na tƒ±klayƒ±nca kapat\r\n  modal.addEventListener('click', (e) => {\r\n    if (e.target === modal) {\r\n      modal.style.display = 'none';\r\n    }\r\n  });\r\n}\r\n\r\n// ====================\r\n// SKU Autocomplete\r\n// ====================\r\n\r\nfunction initSkuAutocomplete() {\r\n  // Tabloya satƒ±r eklendiƒüinde SKU input'larƒ±na autocomplete ekle\r\n  // Bu, renderLines i√ßinde √ßaƒürƒ±lacak\r\n}\r\n\r\nfunction attachSkuAutocomplete(input, rowIndex) {\r\n  if (!input || !state.companyId) return;\r\n  \r\n  // Her input i√ßin kendi dropdown'unu sakla\r\n  let dropdown = null;\r\n  \r\n  // Eski dropdown'u temizle\r\n  function removeDropdown() {\r\n    if (dropdown && dropdown.parentNode) {\r\n      dropdown.remove();\r\n      dropdown = null;\r\n    }\r\n  }\r\n  \r\n  input.addEventListener('input', async (e) => {\r\n    const query = e.target.value.trim().toUpperCase();\r\n    \r\n    // Eski dropdown'u temizle\r\n    removeDropdown();\r\n    \r\n    if (query.length < 1) {\r\n      return;\r\n    }\r\n    \r\n    // ƒ∞lk 20 sonu√ß (startsWith + contains)\r\n    const startsWith = state.inventory.filter(inv => \r\n      inv.sku?.startsWith(query)\r\n    ).slice(0, 10);\r\n    \r\n    const contains = state.inventory.filter(inv => \r\n      !inv.sku?.startsWith(query) && \r\n      (inv.sku?.includes(query) || inv.productName?.toUpperCase().includes(query))\r\n    ).slice(0, 10);\r\n    \r\n    const results = [...startsWith, ...contains].slice(0, 20);\r\n    \r\n    if (results.length === 0) {\r\n      return;\r\n    }\r\n    \r\n    // Dropdown olu≈ütur\r\n    dropdown = document.createElement('div');\r\n    dropdown.className = 'sku-dropdown';\r\n    dropdown.style.cssText = 'position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #d1d5db;border-radius:4px;max-height:200px;overflow-y:auto;z-index:1000;box-shadow:0 4px 6px rgba(0,0,0,0.1)';\r\n    dropdown.innerHTML = results.map(inv => `\r\n      <div class=\"sku-option\" data-sku=\"${inv.sku}\" style=\"padding:8px;cursor:pointer;border-bottom:1px solid #e5e7eb\">\r\n        <strong>${inv.sku || ''}</strong> - ${inv.productName || ''}\r\n      </div>\r\n    `).join('');\r\n    \r\n    // Position relative i√ßin input'un parent'ƒ±nƒ± bul\r\n    const wrapper = input.parentElement; // <td>\r\n    if (wrapper && wrapper.tagName === 'TD') {\r\n      // TD i√ßin position:relative ayarla\r\n      if (!wrapper.style.position || wrapper.style.position === 'static') {\r\n        wrapper.style.position = 'relative';\r\n      }\r\n      wrapper.appendChild(dropdown);\r\n    } else {\r\n      // Fallback: body'ye ekle\r\n      document.body.appendChild(dropdown);\r\n    }\r\n    \r\n    // Click handler\r\n    dropdown.querySelectorAll('.sku-option').forEach(opt => {\r\n      opt.addEventListener('click', async () => {\r\n        const sku = opt.getAttribute('data-sku');\r\n        input.value = sku;\r\n        removeDropdown();\r\n        \r\n        // Stok kartƒ± bilgilerini doldur\r\n        const invItem = await getInventoryItem(state.companyId, sku);\r\n        if (invItem && state.lines[rowIndex]) {\r\n          state.lines[rowIndex].sku = sku;\r\n          state.lines[rowIndex].name = invItem.productName || state.lines[rowIndex].name || '';\r\n          state.lines[rowIndex].brandModel = invItem.brandModel || state.lines[rowIndex].brandModel || '';\r\n          state.lines[rowIndex].unit = invItem.unit || state.lines[rowIndex].unit || 'ADT';\r\n          renderLines();\r\n          updateActions();\r\n        }\r\n      });\r\n      opt.addEventListener('mouseenter', () => {\r\n        opt.style.background = '#f3f4f6';\r\n      });\r\n      opt.addEventListener('mouseleave', () => {\r\n        opt.style.background = '#fff';\r\n      });\r\n    });\r\n  });\r\n  \r\n  // Blur event: input'tan √ßƒ±kƒ±nca dropdown'u kapat\r\n  input.addEventListener('blur', (e) => {\r\n    // Click event'ten √∂nce blur √ßalƒ±≈ümasƒ±n diye timeout\r\n    setTimeout(() => {\r\n      if (dropdown && !dropdown.contains(document.activeElement)) {\r\n        removeDropdown();\r\n      }\r\n    }, 200);\r\n  });\r\n  \r\n  // Click outside to close (sadece bir kez ekle)\r\n  if (!window.__skuDropdownCloseListener) {\r\n    window.__skuDropdownCloseListener = true;\r\n    document.addEventListener('click', (e) => {\r\n      // A√ßƒ±k olan t√ºm SKU dropdown'larƒ±nƒ± kontrol et\r\n      document.querySelectorAll('.sku-dropdown').forEach(dd => {\r\n        if (!dd.contains(e.target) && !e.target.closest('.sku-input')) {\r\n          dd.remove();\r\n        }\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\n// ====================\r\n// Satƒ±r Y√∂netimi\r\n// ====================\r\n\r\nfunction renderLines() {\r\n  const tbody = qs('#linesTable tbody');\r\n  if (!tbody) return;\r\n  \r\n  tbody.innerHTML = '';\r\n  \r\n  state.lines.forEach((line, idx) => {\r\n    const tr = document.createElement('tr');\r\n    tr.dataset.rowIndex = idx;\r\n    \r\n    const badge = line.matchStatus === 'FOUND' ? 'b-found' : \r\n                  line.matchStatus === 'MULTI' ? 'b-multi' : 'b-new';\r\n    const badgeText = line.matchStatus === 'FOUND' ? '‚úÖ' : \r\n                     line.matchStatus === 'MULTI' ? '‚ö†Ô∏è' : 'üÜï';\r\n    \r\n    tr.innerHTML = `\r\n      <td>\r\n        <input type=\"text\" class=\"sku-input\" value=\"${line.sku || ''}\" \r\n               placeholder=\"SKU ara...\" style=\"width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px\" />\r\n      </td>\r\n      <td>\r\n        <input type=\"text\" class=\"product-name-input\" value=\"${line.name || ''}\" \r\n               placeholder=\"√úr√ºn adƒ±\" required style=\"width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px\" />\r\n      </td>\r\n      <td>\r\n        <input type=\"text\" class=\"brand-input\" value=\"${line.brandModel || ''}\" \r\n               placeholder=\"Marka/Model\" style=\"width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px\" />\r\n      </td>\r\n      <td>\r\n        <input type=\"number\" class=\"qty-input\" value=\"${line.qty || ''}\" \r\n               placeholder=\"Miktar\" step=\"0.01\" min=\"0\" required style=\"width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px\" />\r\n      </td>\r\n      <td>\r\n        <input type=\"text\" class=\"unit-input\" value=\"${line.unit || ''}\" \r\n               placeholder=\"Birim\" required style=\"width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px\" />\r\n      </td>\r\n      <td>\r\n        <input type=\"date\" class=\"date-input\" value=\"${line.requestedDate || ''}\" \r\n               style=\"width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px\" />\r\n      </td>\r\n      <td><span class=\"badge ${badge}\">${badgeText}</span></td>\r\n      <td>\r\n        <button type=\"button\" class=\"btn btn-small btn-secondary\" onclick=\"removeLine(${idx})\">Sil</button>\r\n      </td>\r\n    `;\r\n    \r\n    tbody.appendChild(tr);\r\n    \r\n    // SKU autocomplete ekle\r\n    const skuInput = tr.querySelector('.sku-input');\r\n    if (skuInput) {\r\n      attachSkuAutocomplete(skuInput, idx);\r\n    }\r\n    \r\n    // Input change handlers\r\n    tr.querySelector('.product-name-input')?.addEventListener('input', (e) => {\r\n      state.lines[idx].name = e.target.value;\r\n      updateActions();\r\n    });\r\n    tr.querySelector('.brand-input')?.addEventListener('input', (e) => {\r\n      state.lines[idx].brandModel = e.target.value;\r\n    });\r\n    tr.querySelector('.qty-input')?.addEventListener('input', (e) => {\r\n      state.lines[idx].qty = parseFloat(e.target.value) || 0;\r\n      updateActions();\r\n    });\r\n    tr.querySelector('.unit-input')?.addEventListener('input', (e) => {\r\n      state.lines[idx].unit = e.target.value;\r\n      updateActions();\r\n    });\r\n    tr.querySelector('.date-input')?.addEventListener('input', (e) => {\r\n      state.lines[idx].requestedDate = e.target.value;\r\n    });\r\n  });\r\n  \r\n  if (state.lines.length === 0) {\r\n    tbody.innerHTML = '<tr><td colspan=\"8\" style=\"text-align:center;color:#6b7280;padding:20px\">Hen√ºz satƒ±r eklenmedi.</td></tr>';\r\n  }\r\n}\r\n\r\nwindow.removeLine = function(idx) {\r\n  state.lines.splice(idx, 1);\r\n  renderLines();\r\n  updateActions();\r\n};\r\n\r\n// ====================\r\n// Satƒ±r Ekleme\r\n// ====================\r\n\r\nqs('#btnAddLine')?.addEventListener('click', () => {\r\n  state.lines.push({\r\n    lineNo: lineCounter++,\r\n    sku: '',\r\n    name: '',\r\n    brandModel: '',\r\n    qty: 0,\r\n    unit: 'ADT',\r\n    requestedDate: '',\r\n    matchStatus: 'NEW'\r\n  });\r\n  renderLines();\r\n  updateActions();\r\n});\r\n\r\n// ====================\r\n// Zorunlu Alan Kontrol√º\r\n// ====================\r\n\r\nfunction isRowValid(row) {\r\n  const hasSkuOrName = (row.sku?.trim() || row.name?.trim());\r\n  return hasSkuOrName && row.qty > 0 && !!row.unit?.trim();\r\n}\r\n\r\nfunction canSubmit() {\r\n  const titleOk = qs('#reqTitle')?.value.trim().length > 0;\r\n  const siteOk = !!state.selectedSite;\r\n  const addressOk = qs('#reqDelivery')?.value.trim().length > 0;\r\n  const atLeastOneRow = state.lines.length > 0 && state.lines.every(isRowValid);\r\n  \r\n  return titleOk && siteOk && addressOk && atLeastOneRow;\r\n}\r\n\r\nfunction updateActions() {\r\n  const can = canSubmit();\r\n  const btnSaveDraft = qs('#btnSaveDraft');\r\n  const btnSend = qs('#btnSend');\r\n  const btnExportPDF = qs('#btnExportPDF');\r\n  const btnExportExcel = qs('#btnExportExcel');\r\n  \r\n  if (btnSaveDraft) btnSaveDraft.disabled = !can;\r\n  if (btnSend) btnSend.disabled = !can;\r\n  if (btnExportPDF) btnExportPDF.disabled = !can;\r\n  if (btnExportExcel) btnExportExcel.disabled = !can;\r\n}\r\n\r\n// Input'lara change listener ekle (async init'ten sonra √ßalƒ±≈üacak ≈üekilde)\r\n// Bu, async init i√ßinde √ßaƒürƒ±lacak\r\nfunction attachInputListeners() {\r\n  qs('#reqTitle')?.addEventListener('input', updateActions);\r\n  qs('#reqDelivery')?.addEventListener('input', updateActions);\r\n}\r\n\r\n// ====================\r\n// Kaydetme\r\n// ====================\r\n\r\nasync function saveRequest(status) {\r\n  const user = await requireAuth();\r\n  \r\n  if (!canSubmit()) {\r\n    alert('L√ºtfen zorunlu alanlarƒ± doldurun!');\r\n    return;\r\n  }\r\n  \r\n  try {\r\n    const requestData = {\r\n      type: '≈ûMTF',\r\n      title: qs('#reqTitle').value.trim(),\r\n      requesterUserId: user.uid,\r\n      requesterName: user.displayName || user.email,\r\n      siteId: state.selectedSite.id,\r\n      siteName: state.selectedSite.siteName,\r\n      selectedAddressId: state.selectedAddress?.id || 'default',\r\n      deliveryAddress: qs('#reqDelivery').value.trim(),\r\n      deliveryIsFreightIncluded: qs('#reqFreightIncluded')?.checked || false,\r\n      description: qs('#reqDescription')?.value.trim() || '',\r\n      createdAt: serverTimestamp(),\r\n      updatedAt: serverTimestamp(),\r\n      status\r\n    };\r\n    \r\n    const requestRef = await addDoc(collection(db, 'internal_requests'), requestData);\r\n    \r\n    // Add material_lines subcollection\r\n    for (const line of state.lines) {\r\n      await addDoc(collection(db, 'internal_requests', requestRef.id, 'material_lines'), {\r\n        lineNo: line.lineNo,\r\n        sku: line.sku || '',\r\n        name: line.name || '',\r\n        brandModel: line.brandModel || '',\r\n        qty: line.qty,\r\n        unit: line.unit,\r\n        requestedDate: line.requestedDate || '',\r\n        matchStatus: line.matchStatus || 'NEW',\r\n        createdAt: serverTimestamp()\r\n      });\r\n    }\r\n    \r\n    alert('‚úÖ Talep kaydedildi!');\r\n    location.href = '/pages/request-detail.html?id=' + requestRef.id;\r\n    \r\n  } catch (error) {\r\n    console.error('Save error:', error);\r\n    alert('‚ùå Talep kaydedilemedi: ' + error.message);\r\n  }\r\n}\r\n\r\nqs('#btnSaveDraft')?.addEventListener('click', () => saveRequest('DRAFT'));\r\nqs('#btnSend')?.addEventListener('click', () => saveRequest('SENT'));\r\n\r\n// ====================\r\n// PDF/Excel Export\r\n// ====================\r\n\r\nfunction exportPDF() {\r\n  if (!canSubmit()) {\r\n    alert('L√ºtfen zorunlu alanlarƒ± doldurun!');\r\n    return;\r\n  }\r\n  \r\n  try {\r\n    const { jsPDF } = window.jspdf;\r\n    if (!jsPDF) {\r\n      alert('PDF k√ºt√ºphanesi y√ºklenemedi');\r\n      return;\r\n    }\r\n    \r\n    const pdf = new jsPDF();\r\n    let y = 20;\r\n    \r\n    // Ba≈ülƒ±k - ≈ûantiye Adƒ±\r\n    pdf.setFontSize(16);\r\n    pdf.setFont(undefined, 'bold');\r\n    pdf.text(state.selectedSite?.siteName || '≈ûMTF Formu', 14, y);\r\n    y += 10;\r\n    \r\n    // Adres (se√ßili adres)\r\n    if (state.selectedAddress) {\r\n      pdf.setFontSize(10);\r\n      pdf.setFont(undefined, 'normal');\r\n      const addressLines = formatAddress(state.selectedAddress).split(' - ');\r\n      addressLines.forEach(line => {\r\n        if (line.trim()) {\r\n          pdf.text(line.trim(), 14, y);\r\n          y += 6;\r\n        }\r\n      });\r\n      y += 4;\r\n    }\r\n    \r\n    // Talep Bilgileri\r\n    pdf.setFontSize(12);\r\n    pdf.setFont(undefined, 'bold');\r\n    pdf.text('Talep Bilgileri', 14, y);\r\n    y += 8;\r\n    \r\n    pdf.setFontSize(10);\r\n    pdf.setFont(undefined, 'normal');\r\n    pdf.text(`Ba≈ülƒ±k: ${qs('#reqTitle')?.value || '-'}`, 14, y); y += 6;\r\n    pdf.text(`≈ûantiye: ${state.selectedSite?.siteName || '-'}`, 14, y); y += 6;\r\n    pdf.text(`Teslimat Adresi: ${qs('#reqDelivery')?.value || '-'}`, 14, y); y += 6;\r\n    if (qs('#reqDescription')?.value) {\r\n      pdf.text(`A√ßƒ±klama: ${qs('#reqDescription').value}`, 14, y); y += 6;\r\n    }\r\n    pdf.text(`Nakliye Dahil: ${qs('#reqFreightIncluded')?.checked ? 'Evet' : 'Hayƒ±r'}`, 14, y); y += 10;\r\n    \r\n    // Malzeme Satƒ±rlarƒ±\r\n    pdf.setFontSize(12);\r\n    pdf.setFont(undefined, 'bold');\r\n    pdf.text('Malzeme Satƒ±rlarƒ±', 14, y);\r\n    y += 8;\r\n    \r\n    pdf.setFontSize(9);\r\n    pdf.setFont(undefined, 'normal');\r\n    \r\n    // Tablo ba≈ülƒ±klarƒ±\r\n    pdf.setFont(undefined, 'bold');\r\n    pdf.text('Sƒ±ra', 14, y);\r\n    pdf.text('SKU', 30, y);\r\n    pdf.text('√úr√ºn Adƒ±', 60, y);\r\n    pdf.text('Marka/Model', 110, y);\r\n    pdf.text('Miktar', 145, y);\r\n    pdf.text('Birim', 160, y);\r\n    pdf.text('Teslim Tarihi', 175, y);\r\n    y += 6;\r\n    \r\n    pdf.setDrawColor(200, 200, 200);\r\n    pdf.line(14, y, 190, y);\r\n    y += 4;\r\n    \r\n    // Satƒ±rlar\r\n    pdf.setFont(undefined, 'normal');\r\n    state.lines.forEach((line, idx) => {\r\n      if (y > 280) {\r\n        pdf.addPage();\r\n        y = 20;\r\n      }\r\n      \r\n      pdf.text(String(line.lineNo || idx + 1), 14, y);\r\n      pdf.text(line.sku || '-', 30, y);\r\n      \r\n      // √úr√ºn adƒ± uzunsa kƒ±salt\r\n      const productName = (line.name || '').substring(0, 25);\r\n      pdf.text(productName, 60, y);\r\n      \r\n      pdf.text((line.brandModel || '').substring(0, 15), 110, y);\r\n      pdf.text(String(line.qty || 0), 145, y);\r\n      pdf.text(line.unit || '-', 160, y);\r\n      pdf.text(line.requestedDate || '-', 175, y);\r\n      \r\n      y += 6;\r\n    });\r\n    \r\n    // Dosya adƒ±\r\n    const filename = `${qs('#reqTitle')?.value || 'smtf'}-${new Date().toISOString().split('T')[0]}.pdf`;\r\n    pdf.save(filename);\r\n    \r\n    console.log('‚úÖ PDF exported:', filename);\r\n    \r\n  } catch (error) {\r\n    console.error('PDF export error:', error);\r\n    alert('‚ùå PDF olu≈üturulamadƒ±: ' + error.message);\r\n  }\r\n}\r\n\r\nfunction exportExcel() {\r\n  if (!canSubmit()) {\r\n    alert('L√ºtfen zorunlu alanlarƒ± doldurun!');\r\n    return;\r\n  }\r\n  \r\n  try {\r\n    if (!window.XLSX) {\r\n      alert('Excel k√ºt√ºphanesi y√ºklenemedi');\r\n      return;\r\n    }\r\n    \r\n    const wb = XLSX.utils.book_new();\r\n    \r\n    // √ñzet sayfasƒ±\r\n    const summary = [\r\n      ['≈ûMTF - ≈ûantiye Malzeme Talep Formu'],\r\n      [],\r\n      ['≈ûantiye:', state.selectedSite?.siteName || '-'],\r\n      ['Adres:', formatAddress(state.selectedAddress)],\r\n      [],\r\n      ['Talep Bilgileri'],\r\n      ['Ba≈ülƒ±k:', qs('#reqTitle')?.value || '-'],\r\n      ['A√ßƒ±klama:', qs('#reqDescription')?.value || '-'],\r\n      ['Nakliye Dahil:', qs('#reqFreightIncluded')?.checked ? 'Evet' : 'Hayƒ±r'],\r\n      ['Olu≈üturulma Tarihi:', new Date().toLocaleDateString('tr-TR')],\r\n      []\r\n    ];\r\n    \r\n    const ws1 = XLSX.utils.aoa_to_sheet(summary);\r\n    \r\n    // S√ºtun geni≈ülikleri\r\n    ws1['!cols'] = [\r\n      { wch: 20 },\r\n      { wch: 50 }\r\n    ];\r\n    \r\n    XLSX.utils.book_append_sheet(wb, ws1, '√ñzet');\r\n    \r\n    // Malzeme satƒ±rlarƒ± sayfasƒ±\r\n    const itemsData = state.lines.map((line, idx) => ({\r\n      'Sƒ±ra No': line.lineNo || idx + 1,\r\n      'SKU': line.sku || '',\r\n      '√úr√ºn Adƒ±': line.name || '',\r\n      'Marka/Model': line.brandModel || '',\r\n      'Miktar': line.qty || 0,\r\n      'Birim': line.unit || '',\r\n      'Teslim Tarihi': line.requestedDate || ''\r\n    }));\r\n    \r\n    const ws2 = XLSX.utils.json_to_sheet(itemsData);\r\n    \r\n    // S√ºtun geni≈ülikleri\r\n    ws2['!cols'] = [\r\n      { wch: 10 },\r\n      { wch: 15 },\r\n      { wch: 40 },\r\n      { wch: 20 },\r\n      { wch: 12 },\r\n      { wch: 10 },\r\n      { wch: 15 }\r\n    ];\r\n    \r\n    XLSX.utils.book_append_sheet(wb, ws2, 'Malzeme Satƒ±rlarƒ±');\r\n    \r\n    // Dosya adƒ±\r\n    const filename = `${qs('#reqTitle')?.value || 'smtf'}-${new Date().toISOString().split('T')[0]}.xlsx`;\r\n    XLSX.writeFile(wb, filename);\r\n    \r\n    console.log('‚úÖ Excel exported:', filename);\r\n    \r\n  } catch (error) {\r\n    console.error('Excel export error:', error);\r\n    alert('‚ùå Excel olu≈üturulamadƒ±: ' + error.message);\r\n  }\r\n}\r\n\r\nqs('#btnExportPDF')?.addEventListener('click', exportPDF);\r\nqs('#btnExportExcel')?.addEventListener('click', exportExcel);\r\n\r\n// ====================\r\n// Initialize\r\n// ====================\r\n\r\n(async () => {\r\n  try {\r\n    const user = await requireAuth();\r\n    \r\n    // Get user's companyId\r\n    const userDoc = await getDoc(doc(db, 'users', user.uid));\r\n    const userData = userDoc.exists() ? userDoc.data() : {};\r\n    state.companyId = userData.companyId;\r\n    \r\n    if (!state.companyId) {\r\n      alert('‚ö†Ô∏è ≈ûirket bilgisi bulunamadƒ±. L√ºtfen hesap ayarlarƒ±nƒ±zƒ± kontrol edin.');\r\n      return;\r\n    }\r\n    \r\n    // Load sites\r\n    state.sites = await listSites(state.companyId);\r\n    console.log(`‚úÖ Loaded ${state.sites.length} sites`);\r\n    \r\n    // Load inventory\r\n    await loadInventory(state.companyId);\r\n    \r\n    // Initialize UI\r\n    initSiteDropdown();\r\n    initAddressModal();\r\n    attachInputListeners();\r\n    updateActions();\r\n    \r\n    console.log('‚úÖ ≈ûMTF form initialized');\r\n    \r\n  } catch (error) {\r\n    console.error('Initialization error:', error);\r\n    alert('‚ùå Form y√ºklenemedi: ' + error.message);\r\n  }\r\n})();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\seed-categories.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":57,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1818,1821],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1818,1821],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":82,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2659,2662],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2659,2662],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Seed Categories: A√ßƒ±klamalar ve Keywords\r\n * Teklifbul Rule v1.0\r\n * \r\n * Usage: pnpm seed:categories\r\n */\r\n\r\nimport 'dotenv/config';\r\nimport { readFileSync } from 'fs';\r\nimport { join } from 'path';\r\nimport { getPgPool } from '../src/db/connection';\r\n\r\ninterface CategoryDesc {\r\n  id: number;\r\n  name: string;\r\n  short_desc: string;\r\n  examples: string[];\r\n}\r\n\r\ninterface CategoryKeyword {\r\n  category_id: number;\r\n  keyword: string;\r\n  weight: number;\r\n}\r\n\r\nasync function seedCategories() {\r\n  const pool = getPgPool();\r\n  \r\n  // Load JSON files\r\n  const descPath = join(process.cwd(), 'seed', 'categories.desc.json');\r\n  const keywordsPath = join(process.cwd(), 'seed', 'category_keywords.json');\r\n  \r\n  const categories: CategoryDesc[] = JSON.parse(readFileSync(descPath, 'utf-8'));\r\n  const keywords: CategoryKeyword[] = JSON.parse(readFileSync(keywordsPath, 'utf-8'));\r\n  \r\n  console.log(`Seeding ${categories.length} categories...`);\r\n  \r\n  // Create a map from JSON category_id to actual database ID\r\n  const categoryIdMap = new Map<number, number>();\r\n  \r\n  // Update categories with descriptions (by name, not ID)\r\n  for (const cat of categories) {\r\n    try {\r\n      // First, ensure category exists (INSERT if not exists)\r\n      const insertResult = await pool.query(\r\n        `INSERT INTO categories (name, short_desc, examples)\r\n         VALUES ($1, $2, $3)\r\n         ON CONFLICT (name) \r\n         DO UPDATE SET short_desc = EXCLUDED.short_desc, examples = EXCLUDED.examples, updated_at = now()\r\n         RETURNING id`,\r\n        [cat.name, cat.short_desc, cat.examples]\r\n      );\r\n      \r\n      const actualId = insertResult.rows[0].id;\r\n      categoryIdMap.set(cat.id, actualId);\r\n      console.log(`‚úÖ Updated category: ${cat.name} (JSON ID: ${cat.id} -> DB ID: ${actualId})`);\r\n    } catch (e: any) {\r\n      console.warn(`‚ö†Ô∏è  Category ${cat.name} update failed:`, e.message);\r\n    }\r\n  }\r\n  \r\n  console.log(`\\nSeeding ${keywords.length} keywords...`);\r\n  \r\n  // Insert keywords using mapped IDs\r\n  let successCount = 0;\r\n  for (const kw of keywords) {\r\n    const actualCategoryId = categoryIdMap.get(kw.category_id);\r\n    if (!actualCategoryId) {\r\n      console.warn(`‚ö†Ô∏è  Skipping keyword \"${kw.keyword}\": category_id ${kw.category_id} not found in map`);\r\n      continue;\r\n    }\r\n    \r\n    try {\r\n      await pool.query(\r\n        `INSERT INTO category_keywords (category_id, keyword, weight)\r\n         VALUES ($1, $2, $3)\r\n         ON CONFLICT (category_id, keyword) \r\n         DO UPDATE SET weight = EXCLUDED.weight`,\r\n        [actualCategoryId, kw.keyword.toLowerCase(), kw.weight]\r\n      );\r\n      successCount++;\r\n    } catch (e: any) {\r\n      console.warn(`‚ö†Ô∏è  Keyword insertion failed for category ${actualCategoryId}:`, e.message);\r\n    }\r\n  }\r\n  \r\n  console.log(`‚úÖ Inserted ${successCount}/${keywords.length} keywords`);\r\n  \r\n  console.log('\\n‚úÖ Seed completed!');\r\n}\r\n\r\nasync function main() {\r\n  try {\r\n    await seedCategories();\r\n    process.exit(0);\r\n  } catch (e) {\r\n    console.error('Seed failed:', e);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// ES module entry point\r\nmain().catch(console.error);\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\setup-and-run.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":56,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1764,1767],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1764,1767],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":94,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":94,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3058,3061],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3058,3061],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'seedCategories' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":115,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":115,"endColumn":25},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":131,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4218,4221],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4218,4221],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Complete Setup and Run Script\r\n * Teklifbul Rule v1.0\r\n * \r\n * Kurulum ve √ßalƒ±≈ütƒ±rma scripti\r\n */\r\n\r\nimport { testConnection, getRedisClient, closeConnections } from '../src/db/connection';\r\nimport { readFileSync } from 'fs';\r\nimport { join } from 'path';\r\nimport { getPgPool } from '../src/db/connection';\r\n\r\nasync function checkPostgreSQL() {\r\n  console.log('üîç PostgreSQL baƒülantƒ±sƒ± kontrol ediliyor...');\r\n  const isConnected = await testConnection();\r\n  if (isConnected) {\r\n    console.log('‚úÖ PostgreSQL baƒülantƒ±sƒ± ba≈üarƒ±lƒ±\\n');\r\n    return true;\r\n  } else {\r\n    console.log('‚ùå PostgreSQL baƒülantƒ±sƒ± ba≈üarƒ±sƒ±z\\n');\r\n    console.log('üí° PostgreSQL kurulumu i√ßin:');\r\n    console.log('   1. PostgreSQL indir: https://www.postgresql.org/download/windows/');\r\n    console.log('   2. Kurulum sƒ±rasƒ±nda ≈üifre belirleyin');\r\n    console.log('   3. .env dosyasƒ±na ekleyin:');\r\n    console.log('      POSTGRES_HOST=localhost');\r\n    console.log('      POSTGRES_PORT=5432');\r\n    console.log('      POSTGRES_DB=teklifbul');\r\n    console.log('      POSTGRES_USER=postgres');\r\n    console.log('      POSTGRES_PASSWORD=<≈üifreniz>\\n');\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function checkRedis() {\r\n  console.log('üîç Redis baƒülantƒ±sƒ± kontrol ediliyor...');\r\n  \r\n  if (process.env.CACHE_DISABLED === '1') {\r\n    console.log('‚ö†Ô∏è  Redis devre dƒ±≈üƒ± (CACHE_DISABLED=1)\\n');\r\n    return true;\r\n  }\r\n  \r\n  const redis = getRedisClient();\r\n  if (!redis) {\r\n    console.log('‚ö†Ô∏è  Redis client mevcut deƒüil\\n');\r\n    return true; // Opsiyonel\r\n  }\r\n  \r\n  try {\r\n    await redis.connect();\r\n    const pong = await redis.ping();\r\n    if (pong === 'PONG') {\r\n      console.log('‚úÖ Redis baƒülantƒ±sƒ± ba≈üarƒ±lƒ±\\n');\r\n      redis.disconnect();\r\n      return true;\r\n    }\r\n  } catch (e: any) {\r\n    console.log('‚ö†Ô∏è  Redis baƒülantƒ±sƒ± ba≈üarƒ±sƒ±z (cache devre dƒ±≈üƒ±)');\r\n    console.log('   Hata:', e.message);\r\n    console.log('üí° Redis kurulumu i√ßin:');\r\n    console.log('   - Docker: docker run -d -p 6379:6379 redis');\r\n    console.log('   - veya CACHE_DISABLED=1 ile devam edebilirsiniz\\n');\r\n    return false; // Sorun deƒüil, cache opsiyonel\r\n  }\r\n  \r\n  return true;\r\n}\r\n\r\nasync function runMigrations() {\r\n  console.log('üì¶ Migration\\'lar √ßalƒ±≈ütƒ±rƒ±lƒ±yor...\\n');\r\n  \r\n  const pool = getPgPool();\r\n  const client = await pool.connect();\r\n  \r\n  try {\r\n    // Categories migration\r\n    console.log('  1. Categories migration...');\r\n    const categoriesSql = readFileSync(\r\n      join(process.cwd(), 'src/modules/categories/migrations/001_create_categories_tables.sql'),\r\n      'utf-8'\r\n    );\r\n    await client.query(categoriesSql);\r\n    console.log('     ‚úÖ Categories tablosu olu≈üturuldu');\r\n    \r\n    // Tax Offices migration\r\n    console.log('  2. Tax Offices migration...');\r\n    const taxOfficesSql = readFileSync(\r\n      join(process.cwd(), 'src/modules/taxOffices/migrations/001_create_tax_offices_tables.sql'),\r\n      'utf-8'\r\n    );\r\n    await client.query(taxOfficesSql);\r\n    console.log('     ‚úÖ Tax Offices tablosu olu≈üturuldu\\n');\r\n    \r\n    return true;\r\n  } catch (e: any) {\r\n    if (e.code === '42P07' || e.message?.includes('already exists')) {\r\n      console.log('     ‚ö†Ô∏è  Tablolar zaten mevcut, atlanƒ±yor\\n');\r\n      return true;\r\n    }\r\n    console.error('     ‚ùå Migration hatasƒ±:', e.message);\r\n    return false;\r\n  } finally {\r\n    client.release();\r\n  }\r\n}\r\n\r\nasync function seedData() {\r\n  console.log('üå± Seed data y√ºkleniyor...\\n');\r\n  \r\n  try {\r\n    const pool = getPgPool();\r\n    const client = await pool.connect();\r\n    \r\n    // Categories seed\r\n    console.log('  1. Categories seed...');\r\n    const seedCategories = await import('../scripts/seed-categories');\r\n    // seedCategories fonksiyonu zaten √ßalƒ±≈ütƒ±rƒ±lƒ±yor, burada sadece kontrol edelim\r\n    \r\n    // Kontrol: Kategoriler var mƒ±?\r\n    const catCount = await client.query('SELECT COUNT(*) as count FROM categories');\r\n    const count = parseInt(catCount.rows[0].count);\r\n    \r\n    if (count === 0) {\r\n      console.log('     ‚ö†Ô∏è  Kategoriler bo≈ü, seed √ßalƒ±≈ütƒ±rƒ±lmalƒ±: npm run seed:categories');\r\n    } else {\r\n      console.log(`     ‚úÖ ${count} kategori mevcut`);\r\n    }\r\n    \r\n    client.release();\r\n    console.log('');\r\n    return true;\r\n  } catch (e: any) {\r\n    console.error('     ‚ùå Seed kontrol√º hatasƒ±:', e.message);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function main() {\r\n  console.log('üöÄ Teklifbul Setup ve Run Script\\n');\r\n  console.log('=' .repeat(50) + '\\n');\r\n  \r\n  // 1. PostgreSQL kontrol√º\r\n  const pgOk = await checkPostgreSQL();\r\n  if (!pgOk) {\r\n    console.log('‚ö†Ô∏è  PostgreSQL kurulu deƒüil, bazƒ± √∂zellikler √ßalƒ±≈ümayacak\\n');\r\n  }\r\n  \r\n  // 2. Redis kontrol√º\r\n  const redisOk = await checkRedis();\r\n  \r\n  // 3. PostgreSQL varsa migration √ßalƒ±≈ütƒ±r\r\n  if (pgOk) {\r\n    const migrationOk = await runMigrations();\r\n    if (migrationOk) {\r\n      await seedData();\r\n    }\r\n  }\r\n  \r\n  console.log('=' .repeat(50) + '\\n');\r\n  console.log('üìã √ñzet:');\r\n  console.log(`   PostgreSQL: ${pgOk ? '‚úÖ' : '‚ùå'}`);\r\n  console.log(`   Redis: ${redisOk ? '‚úÖ' : '‚ö†Ô∏è  (opsiyonel)'}`);\r\n  console.log(`   Migration: ${pgOk ? '‚úÖ' : '‚è≠Ô∏è  (PostgreSQL gerekli)'}`);\r\n  console.log('');\r\n  \r\n  if (pgOk) {\r\n    console.log('‚úÖ Sistem hazƒ±r!');\r\n    console.log('üí° API server\\'ƒ± ba≈ülatmak i√ßin: npm run dev:api');\r\n    console.log('üí° Frontend\\'i ba≈ülatmak i√ßin: npm run dev');\r\n  } else {\r\n    console.log('‚ö†Ô∏è  PostgreSQL kurulumu gerekiyor');\r\n    console.log('üí° Sistem PostgreSQL olmadan da √ßalƒ±≈üƒ±r ama kategori √∂nerisi ve vergi dairesi √∂zellikleri kullanƒ±lamaz');\r\n  }\r\n  \r\n  await closeConnections();\r\n}\r\n\r\nmain().catch(console.error);\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\stock-import.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'auth' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":18},{"ruleId":"no-undef","severity":1,"message":"'normalizeTR' is not defined.","line":29,"column":35,"nodeType":"Identifier","messageId":"undef","endLine":29,"endColumn":46},{"ruleId":"no-undef","severity":1,"message":"'XLSX' is not defined.","line":107,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":107,"endColumn":28},{"ruleId":"no-undef","severity":1,"message":"'XLSX' is not defined.","line":110,"column":20,"nodeType":"Identifier","messageId":"undef","endLine":110,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'user' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":151,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":151,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db, auth, requireAuth } from '/firebase.js';\r\nimport { normalizeTRLower, tokenizeForIndex } from '/scripts/lib/tr-utils.js';\r\nimport { collection, addDoc, getDocs, query, where, updateDoc, doc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';\r\n\r\nconst qs = s => document.querySelector(s);\r\n\r\nconst state = {\r\n  rows: [],\r\n  validRows: 0,\r\n  invalidRows: 0,\r\n  stats: { new: 0, updated: 0, error: 0 }\r\n};\r\n\r\nconst HEADMAP = {\r\n  'stok kodu': 'sku', 'stok kodu': 'sku', 'sku': 'sku', 'kod': 'sku',\r\n  '√ºr√ºn adƒ±': 'name', 'urun adi': 'name', 'ad': 'name', '√ºr√ºn adƒ±': 'name',\r\n  'marka': 'brand', 'brand': 'brand',\r\n  'model': 'model',\r\n  'birim': 'unit', 'unit': 'unit',\r\n  'kdv orani': 'vatRate', 'kdv oranƒ±': 'vatRate', 'kdv': 'vatRate',\r\n  'alim fiyati': 'lastPurchasePrice', 'alƒ±m fiyatƒ±': 'lastPurchasePrice',\r\n  'satis fiyati': 'salePrice', 'satƒ±≈ü fiyatƒ±': 'salePrice',\r\n  'ozel kod 1': 'customCode1', '√∂zel kod 1': 'customCode1',\r\n  'ozel kod 2': 'customCode2', '√∂zel kod 2': 'customCode2',\r\n  'ozel kod 3': 'customCode3', '√∂zel kod 3': 'customCode3'\r\n};\r\n\r\nfunction mapHeaders(headers) {\r\n  return headers.map(h => HEADMAP[normalizeTR(h)] || null);\r\n}\r\n\r\nfunction toNumber(v) {\r\n  if (typeof v === 'number') return v;\r\n  const s = String(v ?? '').replace(',', '.').trim();\r\n  const n = parseFloat(s);\r\n  return isFinite(n) ? n : 0;\r\n}\r\n\r\nfunction validateRow(row) {\r\n  const errors = [];\r\n  if (!row.sku) errors.push('SKU eksik');\r\n  if (!row.name) errors.push('√úr√ºn adƒ± eksik');\r\n  if (row.sku && row.sku.length > 50) errors.push('SKU √ßok uzun');\r\n  \r\n  if (row.vatRate !== undefined && (row.vatRate < 0 || row.vatRate > 100)) {\r\n    errors.push('KDV oranƒ± 0-100 arasƒ± olmalƒ±');\r\n  }\r\n  \r\n  row._errors = errors;\r\n  row._isValid = errors.length === 0;\r\n  return row._isValid;\r\n}\r\n\r\nfunction renderPreview() {\r\n  const tbody = qs('#previewTable tbody');\r\n  const table = qs('#previewTable');\r\n  tbody.innerHTML = '';\r\n  \r\n  if (!state.rows.length) {\r\n    qs('#previewInfo').textContent = 'Hen√ºz dosya se√ßilmedi.';\r\n    table.style.display = 'none';\r\n    return;\r\n  }\r\n  \r\n  table.style.display = 'table';\r\n  state.rows.forEach(r => {\r\n    const tr = document.createElement('tr');\r\n    const badge = r._isValid ? 'b-valid' : 'b-invalid';\r\n    const badgeText = r._isValid ? '‚úÖ Ge√ßerli' : `‚ùå ${r._errors.join(', ')}`;\r\n    \r\n    tr.innerHTML = `\r\n      <td>${r.sku || ''}</td>\r\n      <td>${r.name || ''}</td>\r\n      <td>${r.brand || ''}</td>\r\n      <td>${r.model || ''}</td>\r\n      <td>${r.unit || ''}</td>\r\n      <td>${r.vatRate || 0}</td>\r\n      <td>${r.lastPurchasePrice || 0}</td>\r\n      <td>${r.salePrice || ''}</td>\r\n      <td><span class=\"badge ${badge}\">${badgeText}</span></td>\r\n    `;\r\n    tbody.appendChild(tr);\r\n  });\r\n  \r\n  qs('#previewInfo').textContent = `Toplam ${state.rows.length} satƒ±r bulundu.`;\r\n}\r\n\r\nfunction renderStats() {\r\n  const div = qs('#statsInfo');\r\n  if (!state.rows.length) {\r\n    div.textContent = 'Hen√ºz dosya y√ºklenmedi.';\r\n    return;\r\n  }\r\n  \r\n  div.innerHTML = `\r\n    <strong>√ñzet:</strong><br>\r\n    Ge√ßerli: <strong>${state.validRows}</strong> | Ge√ßersiz: <strong>${state.invalidRows}</strong><br>\r\n    Yeni: ${state.stats.new} | G√ºncellenen: ${state.stats.updated} | Hata: ${state.stats.error}\r\n  `;\r\n}\r\n\r\nasync function processFile(file) {\r\n  const reader = new FileReader();\r\n  reader.onload = async (e) => {\r\n    try {\r\n      const data = new Uint8Array(e.target.result);\r\n      const workbook = XLSX.read(data, { type: 'array' });\r\n      const sheetName = workbook.SheetNames[0];\r\n      const sheet = workbook.Sheets[sheetName];\r\n      const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });\r\n      \r\n      if (json.length < 2) {\r\n        alert('Dosya √ßok kƒ±sa! En az 1 veri satƒ±rƒ± olmalƒ±.');\r\n        return;\r\n      }\r\n      \r\n      const headers = json[0];\r\n      const mappedHeaders = mapHeaders(headers);\r\n      \r\n      state.rows = json.slice(1).map((row, idx) => {\r\n        const obj = { _rowIndex: idx + 2 };\r\n        mappedHeaders.forEach((key, i) => {\r\n          if (key && row[i] !== undefined) {\r\n            if (key.includes('Price') || key.includes('Rate')) {\r\n              obj[key] = toNumber(row[i]);\r\n            } else {\r\n              obj[key] = String(row[i]).trim();\r\n            }\r\n          }\r\n        });\r\n        return obj;\r\n      }).filter(r => r.sku || r.name);\r\n      \r\n      state.rows.forEach(validateRow);\r\n      state.validRows = state.rows.filter(r => r._isValid).length;\r\n      state.invalidRows = state.rows.length - state.validRows;\r\n      \r\n      renderPreview();\r\n      renderStats();\r\n      qs('#btnImport').disabled = state.validRows === 0;\r\n      \r\n    } catch (error) {\r\n      console.error('File parse error:', error);\r\n      alert('Dosya okunamadƒ±: ' + error.message);\r\n    }\r\n  };\r\n  reader.readAsArrayBuffer(file);\r\n}\r\n\r\nasync function performImport() {\r\n  const user = await requireAuth();\r\n  const validRows = state.rows.filter(r => r._isValid);\r\n  \r\n  if (!validRows.length) {\r\n    alert('ƒ∞√ße aktarƒ±lacak ge√ßerli satƒ±r yok!');\r\n    return;\r\n  }\r\n  \r\n  if (!confirm(`${validRows.length} kayƒ±t i√ße aktarƒ±lacak. Devam edilsin mi?`)) {\r\n    return;\r\n  }\r\n  \r\n  qs('#btnImport').disabled = true;\r\n  qs('#btnImport').textContent = 'ƒ∞√ße aktarƒ±lƒ±yor...';\r\n  \r\n  state.stats = { new: 0, updated: 0, error: 0 };\r\n  \r\n  for (const row of validRows) {\r\n    try {\r\n      const existingQuery = query(collection(db, 'stocks'), where('sku', '==', row.sku));\r\n      const existingSnap = await getDocs(existingQuery);\r\n      \r\n      const stockData = {\r\n        sku: row.sku,\r\n        name: row.name,\r\n        brand: row.brand || '',\r\n        model: row.model || '',\r\n        unit: row.unit || 'ADT',\r\n        vatRate: row.vatRate || 0,\r\n        lastPurchasePrice: row.lastPurchasePrice || 0,\r\n        avgCost: 0,\r\n        salePrice: row.salePrice || 0,\r\n        customCodes: {\r\n          code1: row.customCode1 || '',\r\n          code2: row.customCode2 || '',\r\n          code3: row.customCode3 || ''\r\n        },\r\n        name_norm: normalizeTRLower(row.name),\r\n        search_keywords: tokenizeForIndex(row.name),\r\n        updatedAt: serverTimestamp()\r\n      };\r\n      \r\n      if (existingSnap.size > 0) {\r\n        const docId = existingSnap.docs[0].id;\r\n        await updateDoc(doc(db, 'stocks', docId), stockData);\r\n        state.stats.updated++;\r\n      } else {\r\n        stockData.createdAt = serverTimestamp();\r\n        await addDoc(collection(db, 'stocks'), stockData);\r\n        state.stats.new++;\r\n      }\r\n    } catch (error) {\r\n      console.error('Import error for row:', row, error);\r\n      state.stats.error++;\r\n    }\r\n  }\r\n  \r\n  renderStats();\r\n  alert(`ƒ∞√ße aktarma tamamlandƒ±!\\nYeni: ${state.stats.new}\\nG√ºncellenen: ${state.stats.updated}\\nHata: ${state.stats.error}`);\r\n  \r\n  qs('#btnImport').textContent = 'ƒ∞√ße Aktar';\r\n  qs('#btnImport').disabled = false;\r\n}\r\n\r\n// Event handlers\r\nqs('#stockFile').addEventListener('change', (e) => {\r\n  const file = e.target.files[0];\r\n  if (file) {\r\n    processFile(file);\r\n  }\r\n});\r\n\r\nqs('#btnImport').addEventListener('click', performImport);\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\stock-movements.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'auth' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'where' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":43}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db, auth, requireAuth } from '/firebase.js';\r\nimport { normalizeTRLower, matchesWildcard } from '/scripts/lib/tr-utils.js';\r\nimport { weightedAvgCost, allocateExtras } from '/scripts/inventory-cost.js';\r\nimport { collection, getDocs, query, where, orderBy, addDoc, updateDoc, doc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';\r\n\r\nconst qs = s => document.querySelector(s);\r\n\r\nconst state = {\r\n  currentType: 'IN',\r\n  selectedStock: null,\r\n  locations: [],\r\n  stocks: [],\r\n  movements: []\r\n};\r\n\r\n// Tab switching\r\nqs('.tabs').addEventListener('click', (e) => {\r\n  const tab = e.target.closest('.tab');\r\n  if (!tab) return;\r\n  \r\n  qs('.tab.active').classList.remove('active');\r\n  tab.classList.add('active');\r\n  \r\n  state.currentType = tab.dataset.tab;\r\n  \r\n  // Hide all forms\r\n  qs('#inForm').classList.add('hidden');\r\n  qs('#outForm').classList.add('hidden');\r\n  qs('#transferForm').classList.add('hidden');\r\n  \r\n  // Show relevant form\r\n  if (state.currentType === 'IN') {\r\n    qs('#inForm').classList.remove('hidden');\r\n    qs('#formTitle').textContent = 'üì• Giri≈ü Hareketi';\r\n  } else if (state.currentType === 'OUT') {\r\n    qs('#outForm').classList.remove('hidden');\r\n    qs('#formTitle').textContent = 'üì§ √áƒ±kƒ±≈ü Hareketi';\r\n  } else if (state.currentType === 'TRANSFER') {\r\n    qs('#transferForm').classList.remove('hidden');\r\n    qs('#formTitle').textContent = 'üîÑ Transfer Hareketi';\r\n  } else if (state.currentType === 'ADJUST') {\r\n    qs('#formTitle').textContent = '‚öñÔ∏è D√ºzeltme Hareketi';\r\n  }\r\n  \r\n  qs('#formCard').classList.remove('hidden');\r\n});\r\n\r\n// Load locations\r\nasync function loadLocations() {\r\n  try {\r\n    const snap = await getDocs(collection(db, 'stock_locations'));\r\n    state.locations = [];\r\n    snap.forEach(doc => {\r\n      state.locations.push({ id: doc.id, ...doc.data() });\r\n    });\r\n    \r\n    const select = qs('#mvLocation');\r\n    const toSelect = qs('#mvToLocation');\r\n    select.innerHTML = '<option value=\"\">Se√ßin...</option>';\r\n    toSelect.innerHTML = '<option value=\"\">Se√ßin...</option>';\r\n    \r\n    state.locations.forEach(loc => {\r\n      const opt = document.createElement('option');\r\n      opt.value = loc.id;\r\n      opt.textContent = `${loc.name} (${loc.type})`;\r\n      select.appendChild(opt.cloneNode(true));\r\n      toSelect.appendChild(opt);\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('Location load error:', error);\r\n  }\r\n}\r\n\r\n// Load all stocks for search\r\nasync function loadStocks() {\r\n  try {\r\n    const snap = await getDocs(collection(db, 'stocks'));\r\n    state.stocks = [];\r\n    snap.forEach(doc => {\r\n      state.stocks.push({ id: doc.id, ...doc.data() });\r\n    });\r\n  } catch (error) {\r\n    console.error('Stocks load error:', error);\r\n  }\r\n}\r\n\r\n// Stock search\r\nqs('#mvStockSKU').addEventListener('input', (e) => {\r\n  const query = e.target.value.trim();\r\n  const results = qs('#stockSearchResults');\r\n  \r\n  if (!query || query.length < 2) {\r\n    results.style.display = 'none';\r\n    return;\r\n  }\r\n  \r\n  const matches = state.stocks.filter(s => {\r\n    return matchesWildcard(s.name, query) || normalizeTRLower(s.sku).includes(normalizeTRLower(query));\r\n  }).slice(0, 5);\r\n  \r\n  if (matches.length === 0) {\r\n    results.style.display = 'none';\r\n    state.selectedStock = null;\r\n    return;\r\n  }\r\n  \r\n  results.style.display = 'block';\r\n  results.innerHTML = '';\r\n  matches.forEach(stock => {\r\n    const div = document.createElement('div');\r\n    div.style.padding = '4px 8px';\r\n    div.style.cursor = 'pointer';\r\n    div.style.borderBottom = '1px solid #e5e7eb';\r\n    div.textContent = `${stock.sku} - ${stock.name} (${stock.unit})`;\r\n    div.addEventListener('click', () => {\r\n      state.selectedStock = stock;\r\n      qs('#mvStockSKU').value = stock.sku;\r\n      qs('#mvUnit').value = stock.unit || 'ADT';\r\n      results.style.display = 'none';\r\n    });\r\n    results.appendChild(div);\r\n  });\r\n});\r\n\r\n// Load movement history\r\nasync function loadHistory() {\r\n  try {\r\n    const snap = await getDocs(query(\r\n      collection(db, 'stock_movements'),\r\n      orderBy('createdAt', 'desc')\r\n    ));\r\n    \r\n    state.movements = [];\r\n    snap.forEach(doc => {\r\n      state.movements.push({ id: doc.id, ...doc.data() });\r\n    });\r\n    \r\n    renderHistory();\r\n  } catch (error) {\r\n    console.error('History load error:', error);\r\n  }\r\n}\r\n\r\nfunction renderHistory() {\r\n  const tbody = qs('#historyTable');\r\n  tbody.innerHTML = '';\r\n  \r\n  if (!state.movements.length) {\r\n    tbody.innerHTML = '<tr><td colspan=\"8\">Hen√ºz hareket yok.</td></tr>';\r\n    return;\r\n  }\r\n  \r\n  state.movements.forEach(mv => {\r\n    const tr = document.createElement('tr');\r\n    const date = mv.createdAt ? new Date(mv.createdAt.toDate()).toLocaleDateString('tr-TR') : '-';\r\n    const typeBadge = `b-${mv.type}`;\r\n    const typeText = {\r\n      'IN': 'üì• Giri≈ü',\r\n      'OUT': 'üì§ √áƒ±kƒ±≈ü',\r\n      'TRANSFER': 'üîÑ Transfer',\r\n      'ADJUST': '‚öñÔ∏è D√ºzelt'\r\n    }[mv.type] || mv.type;\r\n    \r\n    tr.innerHTML = `\r\n      <td>${date}</td>\r\n      <td><span class=\"badge ${typeBadge}\">${typeText}</span></td>\r\n      <td>${mv.sku}</td>\r\n      <td>${mv.stockName || ''}</td>\r\n      <td>${state.locations.find(l => l.id === mv.locationId)?.name || '-'}</td>\r\n      <td>${mv.qty}</td>\r\n      <td>${mv.unitCost || 0}</td>\r\n      <td>${mv.totalCost || 0}</td>\r\n    `;\r\n    tbody.appendChild(tr);\r\n  });\r\n}\r\n\r\n// Save movement\r\nqs('#btnSave').addEventListener('click', async () => {\r\n  const user = await requireAuth();\r\n  \r\n  if (!state.selectedStock) {\r\n    alert('L√ºtfen bir √ºr√ºn se√ßin!');\r\n    return;\r\n  }\r\n  \r\n  const locationId = qs('#mvLocation').value;\r\n  if (!locationId) {\r\n    alert('L√ºtfen bir lokasyon se√ßin!');\r\n    return;\r\n  }\r\n  \r\n  const qty = parseFloat(qs('#mvQty').value);\r\n  if (!qty || qty <= 0) {\r\n    alert('Ge√ßerli bir miktar girin!');\r\n    return;\r\n  }\r\n  \r\n  try {\r\n    if (state.currentType === 'IN') {\r\n      const unitCost = parseFloat(qs('#mvUnitCost').value) || 0;\r\n      const extras = parseFloat(qs('#mvExtras').value) || 0;\r\n      const allocatedExtras = allocateExtras(extras, qty);\r\n      const finalUnitCost = unitCost + allocatedExtras;\r\n      \r\n      // Create movement\r\n      await addDoc(collection(db, 'stock_movements'), {\r\n        stockId: state.selectedStock.id,\r\n        sku: state.selectedStock.sku,\r\n        locationId,\r\n        type: 'IN',\r\n        qty,\r\n        unit: state.selectedStock.unit || 'ADT',\r\n        unitCost: finalUnitCost,\r\n        totalCost: finalUnitCost * qty,\r\n        extras: [{ name: 'ƒ∞lave', amount: extras }],\r\n        ref: { kind: 'MANUAL', id: '' },\r\n        stockName: state.selectedStock.name,\r\n        createdBy: user.uid,\r\n        createdAt: serverTimestamp()\r\n      });\r\n      \r\n      // Update stock avgCost\r\n      const stockDoc = await getDoc(doc(db, 'stocks', state.selectedStock.id));\r\n      const stockData = stockDoc.data();\r\n      const oldQty = 0; // TODO: implement stock_balances\r\n      const oldAvg = stockData.avgCost || 0;\r\n      const newAvg = weightedAvgCost(oldQty, oldAvg, qty, finalUnitCost);\r\n      \r\n      await updateDoc(doc(db, 'stocks', state.selectedStock.id), {\r\n        avgCost: newAvg,\r\n        lastPurchasePrice: unitCost,\r\n        updatedAt: serverTimestamp()\r\n      });\r\n      \r\n    } else if (state.currentType === 'OUT') {\r\n      const refKind = qs('#mvRefKind').value;\r\n      const refId = qs('#mvRefId').value;\r\n      \r\n      await addDoc(collection(db, 'stock_movements'), {\r\n        stockId: state.selectedStock.id,\r\n        sku: state.selectedStock.sku,\r\n        locationId,\r\n        type: 'OUT',\r\n        qty,\r\n        unit: state.selectedStock.unit || 'ADT',\r\n        unitCost: state.selectedStock.avgCost || 0,\r\n        totalCost: (state.selectedStock.avgCost || 0) * qty,\r\n        ref: { kind: refKind, id: refId },\r\n        stockName: state.selectedStock.name,\r\n        createdBy: user.uid,\r\n        createdAt: serverTimestamp()\r\n      });\r\n      \r\n    } else if (state.currentType === 'TRANSFER') {\r\n      const toLocationId = qs('#mvToLocation').value;\r\n      if (!toLocationId) {\r\n        alert('Hedef lokasyon se√ßin!');\r\n        return;\r\n      }\r\n      \r\n      // OUT movement\r\n      await addDoc(collection(db, 'stock_movements'), {\r\n        stockId: state.selectedStock.id,\r\n        sku: state.selectedStock.sku,\r\n        locationId,\r\n        type: 'TRANSFER',\r\n        qty,\r\n        unit: state.selectedStock.unit || 'ADT',\r\n        unitCost: state.selectedStock.avgCost || 0,\r\n        totalCost: (state.selectedStock.avgCost || 0) * qty,\r\n        ref: { kind: 'MANUAL', id: toLocationId },\r\n        stockName: state.selectedStock.name,\r\n        createdBy: user.uid,\r\n        createdAt: serverTimestamp()\r\n      });\r\n      \r\n    } else if (state.currentType === 'ADJUST') {\r\n      await addDoc(collection(db, 'stock_movements'), {\r\n        stockId: state.selectedStock.id,\r\n        sku: state.selectedStock.sku,\r\n        locationId,\r\n        type: 'ADJUST',\r\n        qty,\r\n        unit: state.selectedStock.unit || 'ADT',\r\n        unitCost: 0,\r\n        totalCost: 0,\r\n        ref: { kind: 'MANUAL', id: '' },\r\n        stockName: state.selectedStock.name,\r\n        createdBy: user.uid,\r\n        createdAt: serverTimestamp()\r\n      });\r\n    }\r\n    \r\n    alert('Hareket kaydedildi!');\r\n    \r\n    // Reset form\r\n    qs('#mvStockSKU').value = '';\r\n    qs('#mvUnit').value = '';\r\n    qs('#mvQty').value = '';\r\n    qs('#mvUnitCost').value = '';\r\n    qs('#mvExtras').value = '';\r\n    qs('#mvLocation').value = '';\r\n    qs('#mvToLocation').value = '';\r\n    state.selectedStock = null;\r\n    qs('#formCard').classList.add('hidden');\r\n    \r\n    await loadHistory();\r\n    \r\n  } catch (error) {\r\n    console.error('Save error:', error);\r\n    alert('Hareket kaydedilemedi: ' + error.message);\r\n  }\r\n});\r\n\r\n// Initialize\r\nloadLocations();\r\nloadStocks();\r\nloadHistory();\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\sync-streets.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\test-api-debug.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":17,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[409,412],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[409,412],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":32,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[929,932],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[929,932],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":47,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1431,1434],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1431,1434],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Debug API Test - Detailed error messages\r\n */\r\n\r\nimport fetch from 'node-fetch';\r\n\r\nconst API_BASE = 'http://localhost:5174';\r\n\r\nasync function test() {\r\n  console.log('üîç Testing API endpoints with detailed errors...\\n');\r\n  \r\n  // Test 1: Health\r\n  try {\r\n    const res = await fetch(`${API_BASE}/api/health`);\r\n    const data = await res.json();\r\n    console.log('‚úÖ Health:', data);\r\n  } catch (e: any) {\r\n    console.log('‚ùå Health failed:', e.message);\r\n  }\r\n  \r\n  // Test 2: Categories list\r\n  try {\r\n    const res = await fetch(`${API_BASE}/api/categories?withDesc=true&size=5`);\r\n    const text = await res.text();\r\n    console.log('\\nüìã Categories Response:');\r\n    console.log('Status:', res.status);\r\n    console.log('Body:', text.substring(0, 500));\r\n    try {\r\n      const data = JSON.parse(text);\r\n      console.log('Parsed:', JSON.stringify(data, null, 2).substring(0, 500));\r\n    } catch {}\r\n  } catch (e: any) {\r\n    console.log('‚ùå Categories failed:', e.message);\r\n  }\r\n  \r\n  // Test 3: Suggest\r\n  try {\r\n    const res = await fetch(`${API_BASE}/api/categories/suggest`, {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ text: 'elektrik kablosu' })\r\n    });\r\n    const text = await res.text();\r\n    console.log('\\nüí° Suggest Response:');\r\n    console.log('Status:', res.status);\r\n    console.log('Body:', text.substring(0, 500));\r\n  } catch (e: any) {\r\n    console.log('‚ùå Suggest failed:', e.message);\r\n  }\r\n}\r\n\r\ntest().catch(console.error);\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\test-categories-api.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[228,231],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[228,231],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":13,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[303,306],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[303,306],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":34,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[872,875],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[872,875],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Test Categories API\r\n * Teklifbul Rule v1.0\r\n */\r\n\r\nimport fetch from 'node-fetch';\r\n\r\nconst API_BASE = process.env.API_URL || 'http://localhost:5174';\r\n\r\nasync function testEndpoint(method: string, path: string, body?: any) {\r\n  try {\r\n    const url = `${API_BASE}${path}`;\r\n    const options: any = {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    };\r\n    \r\n    if (body) {\r\n      options.body = JSON.stringify(body);\r\n    }\r\n    \r\n    const response = await fetch(url, options);\r\n    const data = await response.json();\r\n    \r\n    console.log(`${method} ${path}: ${response.status}`);\r\n    if (response.ok) {\r\n      console.log('‚úÖ Success:', JSON.stringify(data, null, 2).substring(0, 200));\r\n    } else {\r\n      console.log('‚ùå Error:', data);\r\n    }\r\n    console.log('');\r\n    \r\n    return { ok: response.ok, data };\r\n  } catch (e: any) {\r\n    console.log(`‚ùå ${method} ${path}: ${e.message}\\n`);\r\n    return { ok: false, error: e.message };\r\n  }\r\n}\r\n\r\nasync function testAll() {\r\n  console.log('üß™ Testing Categories API...\\n');\r\n  console.log(`API Base: ${API_BASE}\\n`);\r\n  \r\n  // 1. GET /api/categories\r\n  await testEndpoint('GET', '/api/categories?withDesc=true&size=5');\r\n  \r\n  // 2. GET /api/categories/:id (assuming ID 1 exists)\r\n  await testEndpoint('GET', '/api/categories/1');\r\n  \r\n  // 3. POST /api/categories/suggest\r\n  await testEndpoint('POST', '/api/categories/suggest', {\r\n    text: 'elektrik kablosu sigorta'\r\n  });\r\n  \r\n  await testEndpoint('POST', '/api/categories/suggest', {\r\n    text: '√ßimento tuƒüla in≈üaat malzemesi'\r\n  });\r\n  \r\n  // 4. POST /api/categories/feedback\r\n  await testEndpoint('POST', '/api/categories/feedback', {\r\n    query: 'test query',\r\n    suggested_category_id: 1,\r\n    chosen_category_id: 1\r\n  });\r\n  \r\n  console.log('‚úÖ API tests completed');\r\n}\r\n\r\ntestAll().catch(console.error);\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\test-category-system.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":14,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[267,270],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[267,270],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":17,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[343,346],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[343,346],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":21,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[480,483],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[480,483],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":47,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1088,1091],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1088,1091],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Comprehensive Category System Test\r\n * Teklifbul Rule v1.0\r\n */\r\n\r\nimport fetch from 'node-fetch';\r\n\r\nconst API_BASE = process.env.API_URL || 'http://localhost:5174';\r\n\r\ninterface TestResult {\r\n  name: string;\r\n  passed: boolean;\r\n  error?: string;\r\n  data?: any;\r\n}\r\n\r\nasync function testEndpoint(method: string, path: string, body?: any): Promise<TestResult> {\r\n  const testName = `${method} ${path}`;\r\n  try {\r\n    const url = `${API_BASE}${path}`;\r\n    const options: any = {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    };\r\n    \r\n    if (body) {\r\n      options.body = JSON.stringify(body);\r\n    }\r\n    \r\n    const response = await fetch(url, options);\r\n    \r\n    if (!response.ok && response.status !== 404) {\r\n      return {\r\n        name: testName,\r\n        passed: false,\r\n        error: `HTTP ${response.status}: ${await response.text()}`\r\n      };\r\n    }\r\n    \r\n    const data = response.status === 404 ? null : await response.json();\r\n    \r\n    return {\r\n      name: testName,\r\n      passed: true,\r\n      data: data\r\n    };\r\n  } catch (e: any) {\r\n    return {\r\n      name: testName,\r\n      passed: false,\r\n      error: e.message\r\n    };\r\n  }\r\n}\r\n\r\nasync function runAllTests() {\r\n  console.log('üß™ Category System Test Suite\\n');\r\n  console.log(`API Base: ${API_BASE}\\n`);\r\n  \r\n  const results: TestResult[] = [];\r\n  \r\n  // Test 1: Health check\r\n  console.log('1. Testing API health...');\r\n  const health = await testEndpoint('GET', '/api/health');\r\n  results.push(health);\r\n  if (!health.passed) {\r\n    console.log('‚ùå API server is not running!\\n');\r\n    console.log('üí° Start the server with: npm run dev:api\\n');\r\n    return;\r\n  }\r\n  console.log('‚úÖ API server is running\\n');\r\n  \r\n  // Test 2: Get categories list\r\n  console.log('2. Testing GET /api/categories...');\r\n  const categories = await testEndpoint('GET', '/api/categories?withDesc=true&size=5');\r\n  results.push(categories);\r\n  if (categories.passed && Array.isArray(categories.data) && categories.data.length > 0) {\r\n    console.log(`‚úÖ Found ${categories.data.length} categories`);\r\n    if (categories.data[0].short_desc) {\r\n      console.log(`   Example: \"${categories.data[0].name}\" - ${categories.data[0].short_desc.substring(0, 50)}...`);\r\n    }\r\n    console.log('');\r\n  } else {\r\n    console.log('‚ö†Ô∏è  Categories list empty or error\\n');\r\n  }\r\n  \r\n  // Test 3: Get single category detail\r\n  console.log('3. Testing GET /api/categories/:id...');\r\n  if (categories.passed && Array.isArray(categories.data) && categories.data.length > 0) {\r\n    const firstCat = categories.data[0];\r\n    const detail = await testEndpoint('GET', `/api/categories/${firstCat.id}?withDesc=true`);\r\n    results.push(detail);\r\n    if (detail.passed && detail.data) {\r\n      console.log(`‚úÖ Category detail loaded: \"${detail.data.name}\"`);\r\n      if (detail.data.short_desc) {\r\n        console.log(`   Description: ${detail.data.short_desc.substring(0, 60)}...`);\r\n      }\r\n      if (detail.data.examples && detail.data.examples.length > 0) {\r\n        console.log(`   Examples: ${detail.data.examples.slice(0, 3).join(', ')}`);\r\n      }\r\n      console.log('');\r\n    } else {\r\n      console.log('‚ö†Ô∏è  Category detail failed\\n');\r\n    }\r\n  }\r\n  \r\n  // Test 4: Category suggestion\r\n  console.log('4. Testing POST /api/categories/suggest...');\r\n  const suggest1 = await testEndpoint('POST', '/api/categories/suggest', {\r\n    text: 'elektrik kablosu sigorta'\r\n  });\r\n  results.push(suggest1);\r\n  if (suggest1.passed && suggest1.data && Array.isArray(suggest1.data.suggestions)) {\r\n    console.log(`‚úÖ Suggestion returned ${suggest1.data.suggestions.length} results`);\r\n    if (suggest1.data.suggestions.length > 0) {\r\n      const top = suggest1.data.suggestions[0];\r\n      console.log(`   Top: \"${top.name}\" (${Math.round(top.score * 100)}%)`);\r\n      if (top.reasons && top.reasons.length > 0) {\r\n        console.log(`   Reasons: ${top.reasons.slice(0, 3).join(', ')}`);\r\n      }\r\n      if (suggest1.data.auto_select) {\r\n        console.log(`   Auto-select: \"${suggest1.data.auto_select}\"`);\r\n      }\r\n    }\r\n    console.log('');\r\n  } else {\r\n    console.log('‚ö†Ô∏è  Suggestion failed\\n');\r\n  }\r\n  \r\n  // Test 5: Another suggestion test\r\n  console.log('5. Testing suggestion with different text...');\r\n  const suggest2 = await testEndpoint('POST', '/api/categories/suggest', {\r\n    text: '√ßimento tuƒüla in≈üaat malzemesi'\r\n  });\r\n  results.push(suggest2);\r\n  if (suggest2.passed && suggest2.data) {\r\n    console.log(`‚úÖ Second suggestion: ${suggest2.data.suggestions?.length || 0} results\\n`);\r\n  }\r\n  \r\n  // Test 6: Feedback endpoint\r\n  console.log('6. Testing POST /api/categories/feedback...');\r\n  const feedback = await testEndpoint('POST', '/api/categories/feedback', {\r\n    query: 'test query',\r\n    suggested_category_id: 1,\r\n    chosen_category_id: 1\r\n  });\r\n  results.push(feedback);\r\n  if (feedback.passed) {\r\n    console.log('‚úÖ Feedback saved\\n');\r\n  } else {\r\n    console.log('‚ö†Ô∏è  Feedback save failed\\n');\r\n  }\r\n  \r\n  // Summary\r\n  console.log('\\nüìã Test Summary:');\r\n  const passed = results.filter(r => r.passed).length;\r\n  const failed = results.filter(r => !r.passed).length;\r\n  console.log(`   ‚úÖ Passed: ${passed}`);\r\n  console.log(`   ‚ùå Failed: ${failed}\\n`);\r\n  \r\n  if (failed > 0) {\r\n    console.log('‚ùå Failed tests:');\r\n    results.filter(r => !r.passed).forEach(r => {\r\n      console.log(`   - ${r.name}: ${r.error}`);\r\n    });\r\n    console.log('');\r\n    process.exit(1);\r\n  } else {\r\n    console.log('‚úÖ All tests passed!\\n');\r\n    process.exit(0);\r\n  }\r\n}\r\n\r\nrunAllTests().catch(error => {\r\n  console.error('Test suite error:', error);\r\n  process.exit(1);\r\n});\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\test-connections.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":46,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1510,1513],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1510,1513],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Test Database Connections\r\n * Teklifbul Rule v1.0\r\n */\r\n\r\nimport { testConnection, getRedisClient, closeConnections } from '../src/db/connection';\r\n\r\nasync function testAll() {\r\n  console.log('üîç Testing connections...\\n');\r\n  \r\n  // Test PostgreSQL\r\n  console.log('1. Testing PostgreSQL connection...');\r\n  const pgOk = await testConnection();\r\n  if (pgOk) {\r\n    console.log('‚úÖ PostgreSQL: Connected\\n');\r\n  } else {\r\n    console.log('‚ùå PostgreSQL: Connection failed');\r\n    console.log('   Please check:');\r\n    console.log('   - POSTGRES_HOST, POSTGRES_PORT, POSTGRES_DB, POSTGRES_USER, POSTGRES_PASSWORD');\r\n    console.log('   - PostgreSQL is running\\n');\r\n  }\r\n  \r\n  // Test Redis\r\n  console.log('2. Testing Redis connection...');\r\n  let redisOk = false;\r\n  \r\n  if (process.env.CACHE_DISABLED === '1') {\r\n    console.log('‚ö†Ô∏è  Redis: Cache disabled (CACHE_DISABLED=1)\\n');\r\n    redisOk = true; // Devre dƒ±≈üƒ± ama sorun deƒüil\r\n  } else {\r\n    try {\r\n      const redis = getRedisClient();\r\n      if (!redis) {\r\n        console.log('‚ö†Ô∏è  Redis: Client not available (cache disabled)\\n');\r\n        redisOk = true; // Sorun deƒüil, cache opsiyonel\r\n      } else {\r\n        await redis.connect(); // lazyConnect=true olduƒüu i√ßin manuel baƒülan\r\n        const pong = await redis.ping();\r\n        if (pong === 'PONG') {\r\n          redisOk = true;\r\n          console.log('‚úÖ Redis: Connected\\n');\r\n        } else {\r\n          console.log('‚ùå Redis: Unexpected response\\n');\r\n        }\r\n      }\r\n    } catch (e: any) {\r\n      console.log('‚ö†Ô∏è  Redis: Connection failed (cache will be disabled)');\r\n      console.log('   Error:', e.message);\r\n      console.log('   Tip: CACHE_DISABLED=1 ile cache\\'i devre dƒ±≈üƒ± bƒ±rakabilirsiniz\\n');\r\n      redisOk = false; // Uyarƒ± ama uygulama √ßalƒ±≈üƒ±r\r\n    }\r\n  }\r\n  \r\n  console.log('üìã Summary:');\r\n  console.log(`   PostgreSQL: ${pgOk ? '‚úÖ' : '‚ùå'}`);\r\n  console.log(`   Redis: ${redisOk ? '‚úÖ' : '‚ùå'}`);\r\n  \r\n  if (!pgOk || !redisOk) {\r\n    console.log('\\nüí° Setup Instructions:');\r\n    if (!pgOk) {\r\n      console.log('\\n   PostgreSQL:');\r\n      console.log('   - Install PostgreSQL: https://www.postgresql.org/download/');\r\n      console.log('   - Create database: CREATE DATABASE teklifbul;');\r\n      console.log('   - Set env vars: POSTGRES_HOST, POSTGRES_PORT, POSTGRES_DB, POSTGRES_USER, POSTGRES_PASSWORD');\r\n    }\r\n    if (!redisOk) {\r\n      console.log('\\n   Redis:');\r\n      console.log('   - Install Redis: https://redis.io/download');\r\n      console.log('   - Start Redis: redis-server');\r\n      console.log('   - Set env vars: REDIS_HOST, REDIS_PORT, REDIS_PASSWORD (optional)');\r\n    }\r\n  }\r\n}\r\n\r\ntestAll()\r\n  .then(() => closeConnections())\r\n  .catch((e) => {\r\n    console.error('Test failed:', e);\r\n    closeConnections();\r\n    process.exit(1);\r\n  });\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\test-mapping.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\test-migration-api.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":87,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":90,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[519,522],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[519,522],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-undef","severity":1,"message":"'RequestInit' is not defined.","line":26,"column":20,"nodeType":"Identifier","messageId":"undef","endLine":26,"endColumn":31},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":50,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1317,1320],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1317,1320],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Migration Sonrasƒ± API Test Script\r\n * Teklifbul Rule v1.0\r\n * \r\n * T√ºm API endpoint'lerini test eder\r\n */\r\n\r\nconst API_BASE = 'http://localhost:5174/api';\r\n\r\n// Logger helper\r\nfunction log(message: string, type: 'info' | 'success' | 'error' | 'warn' = 'info') {\r\n  const prefix = {\r\n    info: 'üì¶',\r\n    success: '‚úÖ',\r\n    error: '‚ùå',\r\n    warn: '‚ö†Ô∏è'\r\n  }[type];\r\n  console.log(`${prefix} ${message}`);\r\n}\r\n\r\n// Test helper\r\nasync function testEndpoint(name: string, url: string, method: string = 'GET', body?: any) {\r\n  try {\r\n    log(`Testing ${name}...`, 'info');\r\n    \r\n    const options: RequestInit = {\r\n      method,\r\n      headers: {\r\n        'Content-Type': 'application/json'\r\n      }\r\n    };\r\n    \r\n    if (body) {\r\n      options.body = JSON.stringify(body);\r\n    }\r\n    \r\n    const response = await fetch(url, options);\r\n    const data = await response.json();\r\n    \r\n    if (response.ok) {\r\n      log(`${name}: OK (${response.status})`, 'success');\r\n      if (data.data && Array.isArray(data.data)) {\r\n        log(`  ‚Üí ${data.data.length} items returned`, 'info');\r\n      }\r\n      return { success: true, data };\r\n    } else {\r\n      log(`${name}: FAILED (${response.status}) - ${data.error || 'Unknown error'}`, 'error');\r\n      return { success: false, error: data };\r\n    }\r\n  } catch (error: any) {\r\n    log(`${name}: ERROR - ${error.message}`, 'error');\r\n    return { success: false, error: error.message };\r\n  }\r\n}\r\n\r\nasync function main() {\r\n  log('Starting API tests...', 'info');\r\n  console.log('');\r\n  \r\n  // Wait for server to be ready\r\n  log('Waiting for API server to be ready...', 'info');\r\n  await new Promise(resolve => setTimeout(resolve, 2000));\r\n  \r\n  const results: { [key: string]: boolean } = {};\r\n  \r\n  // 1. Health Check\r\n  const health = await testEndpoint('Health Check', `${API_BASE}/health`);\r\n  results['health'] = health.success;\r\n  console.log('');\r\n  \r\n  // 2. Categories API\r\n  const categoriesList = await testEndpoint('Categories List', `${API_BASE}/categories`);\r\n  results['categories_list'] = categoriesList.success;\r\n  console.log('');\r\n  \r\n  const categoriesSearch = await testEndpoint('Categories Search', `${API_BASE}/categories?q=elektrik`);\r\n  results['categories_search'] = categoriesSearch.success;\r\n  console.log('');\r\n  \r\n  const categoriesSuggest = await testEndpoint(\r\n    'Categories Suggest',\r\n    `${API_BASE}/categories/suggest`,\r\n    'POST',\r\n    { text: 'elektrik kablosu' }\r\n  );\r\n  results['categories_suggest'] = categoriesSuggest.success;\r\n  console.log('');\r\n  \r\n  // 3. Tax Offices API\r\n  const taxProvinces = await testEndpoint('Tax Offices Provinces', `${API_BASE}/tax-offices/provinces`);\r\n  results['tax_provinces'] = taxProvinces.success;\r\n  console.log('');\r\n  \r\n  const taxOffices = await testEndpoint('Tax Offices List', `${API_BASE}/tax-offices?province=ANKARA`);\r\n  results['tax_offices'] = taxOffices.success;\r\n  console.log('');\r\n  \r\n  // Summary\r\n  console.log('');\r\n  log('Test Summary:', 'info');\r\n  console.log('');\r\n  \r\n  const total = Object.keys(results).length;\r\n  const passed = Object.values(results).filter(r => r).length;\r\n  const failed = total - passed;\r\n  \r\n  Object.entries(results).forEach(([name, success]) => {\r\n    log(`${name}: ${success ? 'PASS' : 'FAIL'}`, success ? 'success' : 'error');\r\n  });\r\n  \r\n  console.log('');\r\n  log(`Total: ${total} | Passed: ${passed} | Failed: ${failed}`, passed === total ? 'success' : 'warn');\r\n  \r\n  if (failed > 0) {\r\n    log('Some tests failed. Check API server logs.', 'warn');\r\n    process.exit(1);\r\n  } else {\r\n    log('All tests passed!', 'success');\r\n    process.exit(0);\r\n  }\r\n}\r\n\r\nmain().catch(error => {\r\n  log(`Fatal error: ${error.message}`, 'error');\r\n  process.exit(1);\r\n});\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\test-migration-complete.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[339,342],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[339,342],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":31,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[688,691],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[688,691],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":37,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[862,865],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[862,865],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":67,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1588,1591],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1588,1591],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":98,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2574,2577],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2574,2577],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Migration Sonrasƒ± Sistem Testi\r\n * Teklifbul Rule v1.0\r\n * \r\n * T√ºm migration sonrasƒ± sistemleri test eder\r\n */\r\n\r\nimport fetch from 'node-fetch';\r\n\r\nconst API_BASE = process.env.API_BASE || process.env.API_URL || 'http://localhost:5174';\r\n\r\ninterface TestResult {\r\n  name: string;\r\n  passed: boolean;\r\n  error?: string;\r\n  data?: any;\r\n  duration?: number;\r\n}\r\n\r\n// Logger helper\r\nfunction log(message: string, type: 'info' | 'success' | 'error' | 'warn' = 'info') {\r\n  const prefix = {\r\n    info: 'üì¶',\r\n    success: '‚úÖ',\r\n    error: '‚ùå',\r\n    warn: '‚ö†Ô∏è'\r\n  }[type];\r\n  console.log(`${prefix} ${message}`);\r\n}\r\n\r\nasync function testEndpoint(method: string, path: string, body?: any): Promise<TestResult> {\r\n  const testName = `${method} ${path}`;\r\n  const startTime = Date.now();\r\n  \r\n  try {\r\n    const url = `${API_BASE}${path}`;\r\n    const options: any = {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    };\r\n    \r\n    if (body) {\r\n      options.body = JSON.stringify(body);\r\n    }\r\n    \r\n    const response = await fetch(url, options);\r\n    const duration = Date.now() - startTime;\r\n    \r\n    if (!response.ok && response.status !== 404) {\r\n      const errorText = await response.text();\r\n      return {\r\n        name: testName,\r\n        passed: false,\r\n        error: `HTTP ${response.status}: ${errorText}`,\r\n        duration\r\n      };\r\n    }\r\n    \r\n    const data = response.status === 404 ? null : await response.json();\r\n    \r\n    return {\r\n      name: testName,\r\n      passed: true,\r\n      data: data,\r\n      duration\r\n    };\r\n  } catch (e: any) {\r\n    return {\r\n      name: testName,\r\n      passed: false,\r\n      error: e.message,\r\n      duration: Date.now() - startTime\r\n    };\r\n  }\r\n}\r\n\r\nasync function testCache() {\r\n  try {\r\n    // In-memory cache test (API √ºzerinden dolaylƒ±)\r\n    // Cache √ßalƒ±≈üƒ±yorsa aynƒ± istek hƒ±zlƒ± d√∂ner\r\n    const firstCall = await testEndpoint('GET', '/api/categories?size=5');\r\n    await new Promise(resolve => setTimeout(resolve, 100));\r\n    const secondCall = await testEndpoint('GET', '/api/categories?size=5');\r\n    \r\n    if (firstCall.passed && secondCall.passed) {\r\n      const cacheWorking = secondCall.duration! < firstCall.duration! * 0.8; // %20 daha hƒ±zlƒ±\r\n      return {\r\n        name: 'Cache Performance',\r\n        passed: true,\r\n        data: {\r\n          firstCall: firstCall.duration,\r\n          secondCall: secondCall.duration,\r\n          cacheWorking\r\n        }\r\n      };\r\n    }\r\n    return { name: 'Cache Performance', passed: false, error: 'API calls failed' };\r\n  } catch (e: any) {\r\n    return { name: 'Cache Performance', passed: false, error: e.message };\r\n  }\r\n}\r\n\r\nasync function runAllTests() {\r\n  console.log('üß™ Migration Sonrasƒ± Sistem Testi\\n');\r\n  console.log(`API Base: ${API_BASE}\\n`);\r\n  console.log('='.repeat(60));\r\n  console.log('');\r\n  \r\n  const results: TestResult[] = [];\r\n  \r\n  // Test 1: Health Check\r\n  log('1. Testing API health...', 'info');\r\n  const health = await testEndpoint('GET', '/api/health');\r\n  results.push(health);\r\n  if (!health.passed) {\r\n    log('API server is not running!', 'error');\r\n    log('Start the server with: npm run dev:api', 'warn');\r\n    console.log('');\r\n    return results;\r\n  }\r\n  log(`API server is running (${health.duration}ms)`, 'success');\r\n  console.log('');\r\n  \r\n  // Test 2: Categories List\r\n  log('2. Testing GET /api/categories...', 'info');\r\n  const categories = await testEndpoint('GET', '/api/categories?withDesc=true&size=5');\r\n  results.push(categories);\r\n  if (categories.passed) {\r\n    if (categories.data?.data && Array.isArray(categories.data.data)) {\r\n      log(`Found ${categories.data.data.length} categories (${categories.duration}ms)`, 'success');\r\n      if (categories.data.data.length > 0) {\r\n        log(`Example: \"${categories.data.data[0].name}\"`, 'info');\r\n      }\r\n    } else {\r\n      log('Categories list structure unexpected', 'warn');\r\n    }\r\n  } else {\r\n    log(`Categories list failed: ${categories.error}`, 'error');\r\n  }\r\n  console.log('');\r\n  \r\n  // Test 3: Category Detail\r\n  log('3. Testing GET /api/categories/:id...', 'info');\r\n  if (categories.passed && categories.data?.data && categories.data.data.length > 0) {\r\n    const categoryId = categories.data.data[0].id;\r\n    const categoryDetail = await testEndpoint('GET', `/api/categories/${categoryId}`);\r\n    results.push(categoryDetail);\r\n    if (categoryDetail.passed) {\r\n      log(`Category detail retrieved (${categoryDetail.duration}ms)`, 'success');\r\n    } else {\r\n      log(`Category detail failed: ${categoryDetail.error}`, 'error');\r\n    }\r\n  } else {\r\n    log('Skipping category detail test (no categories found)', 'warn');\r\n  }\r\n  console.log('');\r\n  \r\n  // Test 4: Category Suggest\r\n  log('4. Testing POST /api/categories/suggest...', 'info');\r\n  const suggest1 = await testEndpoint('POST', '/api/categories/suggest', {\r\n    text: 'elektrik kablosu sigorta'\r\n  });\r\n  results.push(suggest1);\r\n  if (suggest1.passed && suggest1.data?.suggestions) {\r\n    log(`Suggestions found: ${suggest1.data.suggestions.length} (${suggest1.duration}ms)`, 'success');\r\n    if (suggest1.data.suggestions.length > 0) {\r\n      log(`Top suggestion: \"${suggest1.data.suggestions[0].name}\" (score: ${suggest1.data.suggestions[0].score})`, 'info');\r\n    }\r\n  } else {\r\n    log(`Category suggest failed: ${suggest1.error}`, 'error');\r\n  }\r\n  console.log('');\r\n  \r\n  // Test 5: Tax Offices Provinces\r\n  log('5. Testing GET /api/tax-offices/provinces...', 'info');\r\n  const provinces = await testEndpoint('GET', '/api/tax-offices/provinces');\r\n  results.push(provinces);\r\n  if (provinces.passed && Array.isArray(provinces.data)) {\r\n    log(`Found ${provinces.data.length} provinces (${provinces.duration}ms)`, 'success');\r\n    if (provinces.data.length > 0) {\r\n      log(`Example: ${provinces.data[0]}`, 'info');\r\n    }\r\n  } else {\r\n    log(`Tax offices provinces failed: ${provinces.error}`, 'error');\r\n  }\r\n  console.log('');\r\n  \r\n  // Test 6: Tax Offices List\r\n  log('6. Testing GET /api/tax-offices?province=ANKARA...', 'info');\r\n  const taxOffices = await testEndpoint('GET', '/api/tax-offices?province=ANKARA');\r\n  results.push(taxOffices);\r\n  if (taxOffices.passed && Array.isArray(taxOffices.data)) {\r\n    log(`Found ${taxOffices.data.length} tax offices in ANKARA (${taxOffices.duration}ms)`, 'success');\r\n    if (taxOffices.data.length > 0) {\r\n      log(`Example: ${taxOffices.data[0].office_name}`, 'info');\r\n    }\r\n  } else {\r\n    log(`Tax offices list failed: ${taxOffices.error}`, 'error');\r\n  }\r\n  console.log('');\r\n  \r\n  // Test 7: Cache Performance\r\n  log('7. Testing cache performance...', 'info');\r\n  const cacheTest = await testCache();\r\n  results.push(cacheTest);\r\n  if (cacheTest.passed && cacheTest.data?.cacheWorking) {\r\n    log(`Cache is working (2nd call ${cacheTest.data.secondCall}ms vs 1st call ${cacheTest.data.firstCall}ms)`, 'success');\r\n  } else {\r\n    log('Cache performance test inconclusive', 'warn');\r\n  }\r\n  console.log('');\r\n  \r\n  // Summary\r\n  console.log('='.repeat(60));\r\n  console.log('');\r\n  log('TEST SUMMARY', 'info');\r\n  console.log('');\r\n  \r\n  const passed = results.filter(r => r.passed).length;\r\n  const failed = results.filter(r => !r.passed).length;\r\n  const total = results.length;\r\n  \r\n  log(`Total: ${total}`, 'info');\r\n  log(`Passed: ${passed}`, 'success');\r\n  if (failed > 0) {\r\n    log(`Failed: ${failed}`, 'error');\r\n  }\r\n  console.log('');\r\n  \r\n  // Failed tests details\r\n  if (failed > 0) {\r\n    log('Failed Tests:', 'error');\r\n    results.filter(r => !r.passed).forEach(r => {\r\n      console.log(`  ‚ùå ${r.name}: ${r.error}`);\r\n    });\r\n    console.log('');\r\n  }\r\n  \r\n  // Performance summary\r\n  const avgDuration = results\r\n    .filter(r => r.duration)\r\n    .reduce((sum, r) => sum + (r.duration || 0), 0) / results.filter(r => r.duration).length;\r\n  \r\n  if (avgDuration > 0) {\r\n    log(`Average response time: ${Math.round(avgDuration)}ms`, 'info');\r\n  }\r\n  \r\n  console.log('');\r\n  \r\n  if (failed === 0) {\r\n    log('üéâ All tests passed!', 'success');\r\n  } else {\r\n    log('‚ö†Ô∏è Some tests failed. Please check the errors above.', 'warn');\r\n  }\r\n  \r\n  return results;\r\n}\r\n\r\n// Run tests\r\nif (import.meta.url === `file://${process.argv[1]}` || process.argv[1]?.includes('test-migration-complete')) {\r\n  runAllTests().catch((error) => {\r\n    log(`Fatal error: ${error.message}`, 'error');\r\n    process.exit(1);\r\n  });\r\n}\r\n\r\nexport { runAllTests, testEndpoint };\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\test-tax-offices-api.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[229,232],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[229,232],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":13,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[304,307],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[304,307],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1129,1132],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1129,1132],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Test Tax Offices API\r\n * Teklifbul Rule v1.0\r\n */\r\n\r\nimport fetch from 'node-fetch';\r\n\r\nconst API_BASE = process.env.API_URL || 'http://localhost:5174';\r\n\r\nasync function testEndpoint(method: string, path: string, body?: any) {\r\n  try {\r\n    const url = `${API_BASE}${path}`;\r\n    const options: any = {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    };\r\n    \r\n    if (body) {\r\n      options.body = JSON.stringify(body);\r\n    }\r\n    \r\n    const response = await fetch(url, options);\r\n    const data = await response.json();\r\n    \r\n    console.log(`${method} ${path}: ${response.status}`);\r\n    if (response.ok) {\r\n      if (Array.isArray(data)) {\r\n        console.log(`‚úÖ Success: ${data.length} items`);\r\n        if (data.length > 0) {\r\n          console.log(`   Example: ${JSON.stringify(data[0], null, 2).substring(0, 150)}`);\r\n        }\r\n      } else {\r\n        console.log(`‚úÖ Success: ${JSON.stringify(data, null, 2).substring(0, 200)}`);\r\n      }\r\n    } else {\r\n      console.log('‚ùå Error:', data);\r\n    }\r\n    console.log('');\r\n    \r\n    return { ok: response.ok, data };\r\n  } catch (e: any) {\r\n    console.log(`‚ùå ${method} ${path}: ${e.message}\\n`);\r\n    return { ok: false, error: e.message };\r\n  }\r\n}\r\n\r\nasync function testAll() {\r\n  console.log('üß™ Testing Tax Offices API...\\n');\r\n  console.log(`API Base: ${API_BASE}\\n`);\r\n  \r\n  // 1. GET /api/tax-offices/provinces\r\n  await testEndpoint('GET', '/api/tax-offices/provinces');\r\n  \r\n  // 2. GET /api/tax-offices?province=ANKARA\r\n  await testEndpoint('GET', '/api/tax-offices?province=ANKARA');\r\n  \r\n  // 3. GET /api/tax-offices?province=ANKARA&district=Polatlƒ±\r\n  await testEndpoint('GET', '/api/tax-offices?province=ANKARA&district=Polatlƒ±');\r\n  \r\n  // 4. GET /api/tax-offices?province=ƒ∞STANBUL\r\n  await testEndpoint('GET', '/api/tax-offices?province=ƒ∞STANBUL');\r\n  \r\n  console.log('‚úÖ API tests completed');\r\n}\r\n\r\ntestAll().catch(console.error);\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\scripts\\update-turkiye-data.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\index.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'dirname' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'fileURLToPath' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'currency' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":91,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":91,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":126,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4908,4911],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4908,4911],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":2,"message":"Unexpected console statement. Only these console methods are allowed: groupCollapsed, groupEnd, info, warn, error.","line":214,"column":24,"nodeType":"MemberExpression","messageId":"limited","endLine":214,"endColumn":35}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import 'dotenv/config';\r\nimport express from 'express';\r\nimport { join, dirname } from 'path';\r\nimport { fileURLToPath } from 'url';\r\nimport fs from 'fs';\r\nimport cors from 'cors';\r\nimport importRouter from './routes/import';\r\nimport ExcelJS from 'exceljs';\r\n\r\n// Teklifbul Rule v1.0 - Categories router\r\nimport categoriesRouter from '../src/modules/categories/routes/categories';\r\n// Teklifbul Rule v1.0 - Tax Offices router\r\nimport taxOfficesRouter from '../src/modules/taxOffices/routes/taxOffices';\r\n// Teklifbul Rule v1.0 - Address router\r\nimport addrRouter from './routes/addr';\r\n\r\nconst app = express();\r\napp.use(cors());\r\napp.use(express.json({ limit: '10mb' }));\r\napp.use(express.urlencoded({ extended: true }));\r\n\r\n// Public (import.html vs.)\r\napp.use(express.static(join(process.cwd(), 'public')));\r\n\r\n// Routes\r\napp.use('/api/import', importRouter);\r\napp.use('/api/categories', categoriesRouter);\r\napp.use('/api/tax-offices', taxOfficesRouter);\r\napp.use('/api/addr', addrRouter); // Teklifbul Rule v1.0 - Adres sistemi\r\n\r\n// Export: Satƒ±n Alma Formu (Excel)\r\napp.get('/api/export/purchase-form', (_req, res) => {\r\n  res.status(405).json({ ok:false, error:'method_not_allowed', hint:'Use POST with meta, items' });\r\n});\r\napp.post('/api/export/purchase-form', async (req, res) => {\r\n  try {\r\n    const { meta = {}, items = [], userRole, userName, demandCode, demandData } = req.body || {};\r\n    const code = demandCode || `SATFK-${Date.now()}`;\r\n    // Resolve template path with fallbacks\r\n    const candidates = [\r\n      join(process.cwd(), 'backend', 'templates', '√∂rnek satƒ±n alma formu.xlsx'),\r\n      join(process.cwd(), 'backend', 'templates', 'ornek satin alma formu.xlsx'),\r\n      join(process.cwd(), 'assets', '√∂rnek satƒ±n alma formu.xlsx'),\r\n      join(process.cwd(), 'assets', 'ornek satin alma formu.xlsx'),\r\n    ];\r\n    const templatePath = candidates.find(p => fs.existsSync(p));\r\n\r\n    const wb = new ExcelJS.Workbook();\r\n    if (templatePath) {\r\n      await wb.xlsx.readFile(templatePath);\r\n    } else {\r\n      // Fallback: build minimal workbook if template missing\r\n      const ws = wb.addWorksheet('SATFK');\r\n      ws.getCell('H3').value = 'SATFK';\r\n      ws.getCell('I3').value = code;\r\n      ws.getRow(5).values = [,'No','Malzeme Kodu','Malzeme Tanƒ±mƒ±','Marka/Model','Miktar','Birim','Depo','G√∂rsel','Termin','A√ßƒ±klama'];\r\n    }\r\n    const ws = wb.worksheets[0];\r\n\r\n    // Header cells with all requested information\r\n    // I3: Talep Kodu (SATFK)\r\n    ws.getCell('I3').value = code;\r\n    \r\n    // I2: Ba≈ülƒ±k\r\n    if (demandData?.title) ws.getCell('I2').value = demandData.title;\r\n    \r\n    // K2: Talep Tarihi\r\n    if (demandData?.demandDate) ws.getCell('K2').value = demandData.demandDate;\r\n    \r\n    // I4: Alƒ±m Yeri (ƒ∞l)\r\n    if (demandData?.purchaseLocation) ws.getCell('I4').value = demandData.purchaseLocation;\r\n    \r\n    // I1: ≈ûantiye\r\n    if (demandData?.siteName) ws.getCell('I1').value = demandData.siteName;\r\n    \r\n    // K1: Talep Tipi\r\n    if (demandData?.biddingMode) {\r\n      const biddingModeText = getBiddingModeText(demandData.biddingMode);\r\n      ws.getCell('K1').value = biddingModeText;\r\n    }\r\n    \r\n    // K3: S√ºreli (Ba≈ülangƒ±√ß ve Biti≈ü Tarihi)\r\n    if (demandData?.phaseStart && demandData?.phaseEnd) {\r\n      ws.getCell('K3').value = `${demandData.phaseStart} / ${demandData.phaseEnd}`;\r\n    }\r\n    \r\n    // K4: √ñncelik\r\n    if (demandData?.priority) ws.getCell('K4').value = demandData.priority;\r\n    \r\n    // Para birimi (default TRY if not specified)\r\n    const currency = demandData?.currency || \"TRY\";\r\n    \r\n    // L6: √ñdeme ≈ûartlarƒ± (for first item)\r\n    if (demandData?.paymentTerms && items.length > 0) {\r\n      ws.getCell('L6').value = demandData.paymentTerms;\r\n    }\r\n    \r\n    // Role-dependent names\r\n    // K11: Onay Veren\r\n    if (userRole === 'approver') ws.getCell('K11').value = userName || '';\r\n    // H11: Genel M√ºd√ºr\r\n    if (demandData?.generalManager) ws.getCell('H11').value = demandData.generalManager;\r\n    // G11: Satƒ±n Alma Yetkilisi\r\n    if (userRole === 'satinalma_yetkilisi') ws.getCell('G11').value = userName || '';\r\n    // F11: Talep Eden\r\n    if (demandData?.requester) ws.getCell('F11').value = demandData.requester;\r\n    \r\n    // A11 and onwards: A√ßƒ±klamalar\r\n    if (Array.isArray(demandData?.descriptions)) {\r\n      demandData.descriptions.forEach((desc: string, index: number) => {\r\n        if (desc && desc.trim()) {\r\n          const row = 11 + index; // Start from A11\r\n          ws.getCell(`A${row}`).value = desc.trim();\r\n        }\r\n      });\r\n    } else if (demandData?.spec) {\r\n      ws.getCell('A11').value = demandData.spec;\r\n    }\r\n\r\n    // D12: Teslim ≈ûekli + Adres\r\n    const deliveryCombined = `${meta.deliveryMethod || ''} ${meta.deliveryAddress || ''}`.trim();\r\n    ws.getCell('D12').value = deliveryCombined || null;\r\n\r\n    // Items start at row 6\r\n    const rowIdx = 6;\r\n    items.forEach((it: any, i: number) => {\r\n      const r = ws.getRow(rowIdx + i);\r\n      r.getCell(1).value = it.lineNo ?? i + 1;          // A: No\r\n      r.getCell(2).value = it.sku || '';                // B: SKU\r\n      r.getCell(3).value = it.name || '';               // C: Ad\r\n      r.getCell(4).value = it.brandModel || '';         // D: Marka/Model\r\n      r.getCell(5).value = it.qty ?? null;              // E: Miktar\r\n      r.getCell(6).value = it.unit || '';               // F: Birim\r\n      r.getCell(7).value = it.warehouseQty ?? null;     // G: Depodaki\r\n      r.getCell(8).value = it.imageUrl || '';           // H: G√∂rsel\r\n      r.getCell(9).value = it.requestedDate || '';      // I: Termin\r\n      r.getCell(10).value = it.note || '';              // J: A√ßƒ±klama\r\n      r.commit();\r\n      \r\n      // For each item, set the delivery date in the appropriate cell\r\n      // I6 for first item, I7 for second item, etc.\r\n      if (it.requestedDate) {\r\n        ws.getCell(`I${6 + i}`).value = it.requestedDate;\r\n      }\r\n    });\r\n\r\n    res.setHeader('Content-Disposition', `attachment; filename=\"SATFK_${code}.xlsx\"`);\r\n    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\r\n    await wb.xlsx.write(res);\r\n    res.end();\r\n  } catch (e) {\r\n    console.error('export purchase-form error', e);\r\n    res.status(500).json({ ok:false, error:'export_failed' });\r\n  }\r\n});\r\n\r\n// Helper function to get bidding mode text\r\nfunction getBiddingModeText(mode: string) {\r\n  const modeMap: Record<string, string> = {\r\n    \"secret\": \"Gizli Teklif (tek tur)\",\r\n    \"open\": \"A√ßƒ±k Teklif (tek tur)\",\r\n    \"hybrid\": \"Hibrit (1. tur gizli, 2. tur a√ßƒ±k)\"\r\n  };\r\n  return modeMap[mode] || mode || \"-\";\r\n}\r\n\r\n// Save JSON helpers\r\nfunction ensureDirSync(p: string) {\r\n  if (!fs.existsSync(p)) fs.mkdirSync(p, { recursive: true });\r\n}\r\n\r\n// POST /save-mahalle-json { districtId, districtName, neighborhoods }\r\napp.post('/save-mahalle-json', (req, res) => {\r\n  try {\r\n    const { districtId, districtName, neighborhoods } = req.body || {};\r\n    if (!districtId || !Array.isArray(neighborhoods)) {\r\n      return res.status(400).json({ ok: false, error: 'invalid_body' });\r\n    }\r\n    const outDir = join(process.cwd(), 'public', 'assets', 'mahalle');\r\n    ensureDirSync(outDir);\r\n    const outPath = join(outDir, `${districtId}.json`);\r\n    const payload = { districtId, districtName, neighborhoods };\r\n    fs.writeFileSync(outPath, JSON.stringify(payload, null, 2), 'utf8');\r\n    return res.json({ ok: true, path: `/assets/mahalle/${districtId}.json` });\r\n  } catch (e) {\r\n    console.error('save-mahalle-json error', e);\r\n    return res.status(500).json({ ok: false });\r\n  }\r\n});\r\n\r\n// POST /save-street-json { districtId, districtName, neighborhoodId, neighborhoodName, streets }\r\napp.post('/save-street-json', (req, res) => {\r\n  try {\r\n    const { districtId, neighborhoodId, districtName, neighborhoodName, streets } = req.body || {};\r\n    if (!districtId || !neighborhoodId || !Array.isArray(streets)) {\r\n      return res.status(400).json({ ok: false, error: 'invalid_body' });\r\n    }\r\n    const outDir = join(process.cwd(), 'public', 'assets', 'sokak');\r\n    ensureDirSync(outDir);\r\n    const outPath = join(outDir, `${districtId}_mah-${neighborhoodId}.json`);\r\n    const payload = { districtId, districtName, neighborhoodId, neighborhoodName, streets };\r\n    fs.writeFileSync(outPath, JSON.stringify(payload, null, 2), 'utf8');\r\n    return res.json({ ok: true, path: `/assets/sokak/${districtId}_mah-${neighborhoodId}.json` });\r\n  } catch (e) {\r\n    console.error('save-street-json error', e);\r\n    return res.status(500).json({ ok: false });\r\n  }\r\n});\r\n\r\n// Health\r\napp.get('/api/health', (_req, res) => res.json({ ok: true }));\r\n\r\nconst PORT = process.env.API_PORT ? Number(process.env.API_PORT) : (process.env.PORT ? Number(process.env.PORT) : 5174);\r\napp.listen(PORT, () => console.log(`[API] listening on http://localhost:${PORT}`));\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\pdf-parse.d.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":6,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[182,185],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[182,185],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Type declaration for pdf-parse/lib/pdf-parse.js\r\ndeclare module 'pdf-parse/lib/pdf-parse.js' {\r\n  export interface PdfMeta {\r\n    text: string;\r\n    numpages: number;\r\n    info?: any;\r\n  }\r\n  \r\n  export default function pdfParse(\r\n    data: Buffer | Uint8Array\r\n  ): Promise<PdfMeta>;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\routes\\addr.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":19,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[492,495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[492,495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":34,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[966,969],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[966,969],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":43,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1172,1175],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1172,1175],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":84,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2519,2522],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2519,2522],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":88,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2687,2690],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2687,2690],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":94,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":94,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2851,2854],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2851,2854],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":106,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3205,3208],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3205,3208],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":154,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":154,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5011,5014],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5011,5014],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":169,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":169,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5644,5647],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5644,5647],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":187,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":187,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6222,6225],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6222,6225],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":201,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":201,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6590,6593],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6590,6593],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":11,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Adres API Routes\r\n * Teklifbul Rule v1.0 - ID tabanlƒ± adres sistemi\r\n */\r\n\r\nimport { Router, Request, Response } from 'express';\r\n\r\n// Node.js 18+ built-in fetch (native)\r\n// Eƒüer eski Node.js kullanƒ±yorsanƒ±z: npm install node-fetch@2\r\n\r\nconst router = Router();\r\n\r\n/**\r\n * Retry mekanizmasƒ± ile fetch\r\n * @param url - Fetch edilecek URL\r\n * @param tries - Maksimum deneme sayƒ±sƒ± (default: 3)\r\n * @returns Response\r\n */\r\nasync function fetchWithRetry(url: string, tries = 3): Promise<any> {\r\n  let lastErr: Error | null = null;\r\n  \r\n  for (let i = 0; i < tries; i++) {\r\n    try {\r\n      // AbortController ile timeout (Node.js 18+)\r\n      const controller = new AbortController();\r\n      const timeoutId = setTimeout(() => controller.abort(), 8000);\r\n      \r\n      const res = await fetch(url, { \r\n        signal: controller.signal,\r\n        headers: {\r\n          'Accept': 'application/json',\r\n          'User-Agent': 'Teklifbul/1.0'\r\n        }\r\n      } as any);\r\n      \r\n      clearTimeout(timeoutId);\r\n      \r\n      if (res.ok) {\r\n        return await res.json();\r\n      }\r\n      \r\n      lastErr = new Error(`${res.status} ${res.statusText}`);\r\n    } catch (e: any) {\r\n      lastErr = e;\r\n    }\r\n    \r\n    // Exponential backoff: 250ms, 500ms, 1000ms\r\n    if (i < tries - 1) {\r\n      await new Promise(resolve => setTimeout(resolve, 250 * Math.pow(2, i)));\r\n    }\r\n  }\r\n  \r\n  throw lastErr || new Error('Fetch failed after retries');\r\n}\r\n\r\n/**\r\n * GET /api/addr/streets?neighborhoodId=#\r\n * T√ºrkiyeAPI'den sokak listesini getir (retry'li, CORS g√ºvenli)\r\n */\r\nrouter.get('/streets', async (req: Request, res: Response) => {\r\n  try {\r\n    const neighborhoodId = req.query.neighborhoodId;\r\n    \r\n    if (!neighborhoodId) {\r\n      return res.status(400).json({ error: 'neighborhoodId required' });\r\n    }\r\n    \r\n    const neighborhoodIdNum = Number(neighborhoodId);\r\n    \r\n    if (isNaN(neighborhoodIdNum) || neighborhoodIdNum <= 0) {\r\n      return res.status(400).json({ error: 'Invalid neighborhoodId' });\r\n    }\r\n    \r\n    // T√ºrkiyeAPI endpoint: /v1/streets?neighborhoodId={id}\r\n    const apiUrl = `https://api.turkiyeapi.dev/v1/streets?neighborhoodId=${neighborhoodIdNum}`;\r\n    \r\n    try {\r\n      const data = await fetchWithRetry(apiUrl);\r\n      \r\n      // T√ºrkiyeAPI response formatƒ±: { data: [...], meta: {...} }\r\n      const streets = Array.isArray(data?.data) ? data.data : [];\r\n      \r\n      // Sokak formatƒ±nƒ± normalize et: { id, name, postalCode? }\r\n      const normalizedStreets = streets.map((s: any) => ({\r\n        id: s.id || s.neighborhoodId || null,\r\n        name: s.name || '',\r\n        postalCode: s.postalCode || s.postal_code || null\r\n      })).filter((s: any) => s.name); // Bo≈ü isimleri filtrele\r\n      \r\n      return res.json({ \r\n        ok: true,\r\n        data: normalizedStreets \r\n      });\r\n    } catch (apiError: any) {\r\n      console.warn('[addr] T√ºrkiyeAPI streets fetch failed', { \r\n        neighborhoodId: neighborhoodIdNum, \r\n        error: apiError.message || String(apiError) \r\n      });\r\n      \r\n      // Hata durumunda bo≈ü array d√∂nd√ºr (UI free-text'e d√º≈üs√ºn)\r\n      return res.json({ \r\n        ok: false,\r\n        data: [] \r\n      });\r\n    }\r\n  } catch (e: any) {\r\n    console.error('[addr] /streets endpoint error:', e);\r\n    return res.status(500).json({ \r\n      ok: false,\r\n      error: 'Internal server error',\r\n      data: [] \r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * GET /api/addr/resolve-ids?provinceName=...&districtName=...&neighborhoodName=...\r\n * ƒ∞l/ƒ∞l√ße/Mahalle isimlerinden ID'leri √ß√∂z√ºmle\r\n */\r\nrouter.get('/resolve-ids', async (req: Request, res: Response) => {\r\n  try {\r\n    const { provinceName, districtName, neighborhoodName } = req.query;\r\n    \r\n    if (!provinceName || !districtName || !neighborhoodName) {\r\n      return res.status(400).json({ error: 'provinceName, districtName, neighborhoodName required' });\r\n    }\r\n    \r\n    const baseUrl = 'https://api.turkiyeapi.dev/v1';\r\n    \r\n    try {\r\n      // 1. ƒ∞l ID'sini bul\r\n      const provinceRes = await fetchWithRetry(\r\n        `${baseUrl}/provinces?name=${encodeURIComponent(String(provinceName))}`\r\n      );\r\n      const provinceId = provinceRes?.data?.[0]?.id;\r\n      \r\n      if (!provinceId) {\r\n        return res.json({ ok: false, error: 'Province not found', data: null });\r\n      }\r\n      \r\n      // 2. ƒ∞l√ße ID'sini bul\r\n      const districtRes = await fetchWithRetry(\r\n        `${baseUrl}/districts?provinceId=${provinceId}`\r\n      );\r\n      const districts = Array.isArray(districtRes?.data) ? districtRes.data : [];\r\n      \r\n      // Normalize edilmi≈ü kar≈üƒ±la≈ütƒ±rma\r\n      const normalize = (s: string) => s.toLowerCase().replace(/[ƒ±ƒ∞≈ü≈ûƒüƒû√º√ú√∂√ñ√ß√á]/g, (m) => {\r\n        const map: Record<string, string> = { 'ƒ±': 'i', 'ƒ∞': 'i', '≈ü': 's', '≈û': 's', 'ƒü': 'g', 'ƒû': 'g', '√º': 'u', '√ú': 'u', '√∂': 'o', '√ñ': 'o', '√ß': 'c', '√á': 'c' };\r\n        return map[m] || m;\r\n      });\r\n      \r\n      const normalizedDistrictName = normalize(String(districtName));\r\n      const district = districts.find((d: any) => normalize(d.name) === normalizedDistrictName);\r\n      \r\n      if (!district) {\r\n        return res.json({ ok: false, error: 'District not found', data: { provinceId } });\r\n      }\r\n      \r\n      const districtId = district.id;\r\n      \r\n      // 3. Mahalle ID'sini bul\r\n      const neighborhoodRes = await fetchWithRetry(\r\n        `${baseUrl}/neighborhoods?districtId=${districtId}`\r\n      );\r\n      const neighborhoods = Array.isArray(neighborhoodRes?.data) ? neighborhoodRes.data : [];\r\n      \r\n      const normalizedNeighborhoodName = normalize(String(neighborhoodName));\r\n      const neighborhood = neighborhoods.find((n: any) => normalize(n.name) === normalizedNeighborhoodName);\r\n      \r\n      if (!neighborhood) {\r\n        return res.json({ ok: false, error: 'Neighborhood not found', data: { provinceId, districtId } });\r\n      }\r\n      \r\n      const neighborhoodId = neighborhood.id;\r\n      const defaultPostalCode = neighborhood.postalCode || neighborhood.postal_code || null;\r\n      \r\n      return res.json({\r\n        ok: true,\r\n        data: {\r\n          provinceId,\r\n          districtId,\r\n          neighborhoodId,\r\n          defaultPostalCode\r\n        }\r\n      });\r\n    } catch (apiError: any) {\r\n      console.warn('[addr] T√ºrkiyeAPI resolve-ids failed', { \r\n        provinceName, \r\n        districtName, \r\n        neighborhoodName,\r\n        error: apiError.message || String(apiError) \r\n      });\r\n      \r\n      return res.status(500).json({ \r\n        ok: false,\r\n        error: 'API request failed',\r\n        data: null \r\n      });\r\n    }\r\n  } catch (e: any) {\r\n    console.error('[addr] /resolve-ids endpoint error:', e);\r\n    return res.status(500).json({ \r\n      ok: false,\r\n      error: 'Internal server error',\r\n      data: null \r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\routes\\import.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":70,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2330,2333],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2330,2333],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":80,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":80,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2638,2641],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2638,2641],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":81,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":81,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2687,2690],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2687,2690],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":122,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":122,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4158,4161],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4158,4161],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":140,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":140,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4601,4604],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4601,4604],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":153,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":153,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4990,4993],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4990,4993],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":160,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":160,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5338,5341],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5338,5341],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Router } from 'express';\r\nimport multer from 'multer';\r\nimport { commitDemand } from '../services/commit';\r\nimport { matchSuppliers } from '../services/supplierMatch';\r\nimport { mapDocument, FieldResult } from '../services/mappingService';\r\n// Teklifbul Rule v1.0 - Kategori √∂neri sistemi\r\nimport { suggestCategory } from '../../src/modules/categories/services/categorySuggest';\r\n\r\nconst upload = multer({ storage: multer.memoryStorage(), limits: { fileSize: 10 * 1024 * 1024 } });\r\nconst r = Router();\r\n\r\n// Magic sniff helper\r\nfunction sniffFormat(buf: Buffer, name: string): string {\r\n  const head = buf.subarray(0, 8).toString('hex');\r\n  const lower = name.toLowerCase();\r\n  \r\n  // Office docs (ZIP magic: PK\\x03\\x04)\r\n  if (head.startsWith('504b03') || lower.endsWith('.xlsx') || lower.endsWith('.docx')) {\r\n    if (lower.endsWith('.xlsx')) return 'xlsx';\r\n    if (lower.endsWith('.docx')) return 'docx';\r\n    return 'unknown-zip';\r\n  }\r\n  \r\n  // PDF magic: %PDF\r\n  if (head.startsWith('25504446') || lower.endsWith('.pdf')) return 'pdf';\r\n  \r\n  return 'unknown';\r\n}\r\n\r\nr.post('/preview', upload.single('file'), async (req, res) => {\r\n  try {\r\n    // 1. Dosya kontrol√º\r\n    if (!req.file) {\r\n      return res.status(400).json({ \r\n        ok: false, \r\n        error: 'file_missing', \r\n        details: 'FormData ile \"file\" alanƒ± bekleniyor.' \r\n      });\r\n    }\r\n    \r\n    if (!req.file.buffer || req.file.buffer.length === 0) {\r\n      return res.status(400).json({ \r\n        ok: false, \r\n        error: 'empty_file', \r\n        details: 'Dosya bo≈ü g√∂r√ºn√ºyor.' \r\n      });\r\n    }\r\n    \r\n    // 2. Format tespit et\r\n    const name = req.file.originalname || '';\r\n    const format = sniffFormat(req.file.buffer, name);\r\n    \r\n  console.info(`[Import] ${name} (${format}) - ${req.file.buffer.length} bytes`);\r\n    \r\n    if (format === 'unknown') {\r\n      return res.status(415).json({\r\n        ok: false,\r\n        error: 'unsupported_format',\r\n        details: `Desteklenen formatlar: .xlsx, .docx, .pdf. Algƒ±lanan: ${format}`\r\n      });\r\n    }\r\n\r\n    let mapping;\r\n    try {\r\n      mapping = await mapDocument(req.file.buffer, {\r\n        filename: name,\r\n        mimeType: req.file.mimetype,\r\n        supplierId: (req.body?.supplierId || req.query?.supplierId) as string | undefined,\r\n      });\r\n    } catch (parseError: any) {\r\n      console.error('[Import] Parse error:', parseError);\r\n      return res.status(400).json({\r\n        ok: false,\r\n        error: 'parse_error',\r\n        details: parseError.message || String(parseError),\r\n        stack: parseError.stack,\r\n      });\r\n    }\r\n\r\n    const demandValues: Record<string, any> = {};\r\n    const demandMeta: Record<string, any> = {};\r\n    Object.entries(mapping.demand).forEach(([field, result]) => {\r\n      const fieldResult = result as FieldResult;\r\n      demandValues[field] = fieldResult.value;\r\n      demandMeta[field] = {\r\n        confidence: fieldResult.confidence,\r\n        needsReview: fieldResult.needsReview,\r\n        sourceLabel: fieldResult.sourceLabel,\r\n      };\r\n    });\r\n\r\n    const items = mapping.items.map((item) => item.value);\r\n    const itemMeta = mapping.items.map((item) => ({\r\n      confidence: item.confidence,\r\n      needsReview: item.needsReview,\r\n    }));\r\n\r\n    if (!items.length) {\r\n      mapping.warnings.push('Dosyadan kalem √ßƒ±karƒ±lamadƒ±. Dosya formatƒ±nƒ± kontrol edin.');\r\n    }\r\n\r\n    // Teklifbul Rule v1.0 - Her item i√ßin kategori √∂nerisi\r\n    const itemsWithSuggestions = await Promise.all(items.map(async (item) => {\r\n      // √úr√ºn adƒ± ve a√ßƒ±klamadan kategori √∂nerisi olu≈ütur\r\n      const text = [item.itemName || '', item.note || ''].filter(Boolean).join(' ').trim();\r\n      \r\n      if (!text || text.length < 3) {\r\n        return {\r\n          ...item,\r\n          categorySuggestions: [],\r\n          suggestedCategory: null\r\n        };\r\n      }\r\n      \r\n      try {\r\n        const suggestion = await suggestCategory(text);\r\n        return {\r\n          ...item,\r\n          categorySuggestions: suggestion.suggestions.slice(0, 3), // Top-3\r\n          suggestedCategory: suggestion.auto_select // Skor ‚â•0.70 ise otomatik se√ßim\r\n        };\r\n      } catch (e: any) {\r\n    console.warn('[Import] Category suggestion failed for item:', item.itemName, e.message);\r\n        return {\r\n          ...item,\r\n          categorySuggestions: [],\r\n          suggestedCategory: null\r\n        };\r\n      }\r\n    }));\r\n\r\n    return res.json({\r\n      ok: true,\r\n      demand: demandValues,\r\n      items: itemsWithSuggestions,\r\n      demandMeta,\r\n      itemMeta,\r\n      warnings: mapping.warnings,\r\n    });\r\n  } catch (e: any) {\r\n    console.error('[Import] General error:', e);\r\n    return res.status(500).json({ \r\n      ok: false, \r\n      error: 'server_error', \r\n      details: e.message || String(e),\r\n      stack: process.env.NODE_ENV === 'development' ? e.stack : undefined\r\n    });\r\n  }\r\n});\r\n\r\nr.post('/commit', async (req, res) => {\r\n  try {\r\n    const { demand, items, options } = (req.body || {}) as any;\r\n    if (!demand || !Array.isArray(items)) return res.status(400).json({ error: 'Eksik g√∂vde' });\r\n\r\n    const saved = await commitDemand({ demand, items });\r\n    const matches = await matchSuppliers(items);\r\n\r\n    return res.json({ ok: true, demandId: saved.demandId, satfk: saved.satfk, matchedSuppliers: matches, options });\r\n  } catch (e: any) {\r\n    return res.status(400).json({ error: e.message || 'Commit hatasƒ±' });\r\n  }\r\n});\r\n\r\nexport default r;\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\services\\category.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[723,726],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[723,726],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const RULES: Record<string,string[]> = {\r\n  'Elektrik Malzemeleri': ['kablo','priz','sigorta','pano','kontakt√∂r','≈üalter','led','ampul','aydƒ±nlatma'],\r\n  'El Aletleri': ['matkap','≈üarjlƒ±','testere','ta≈ülama','kumpas','pense','√ßeki√ß'],\r\n  'Ofis Sarf': ['kaƒüƒ±t','toner','kartu≈ü','zƒ±mba','dosya','kalem'],\r\n  'BT Donanƒ±m': ['laptop','sunucu','ssd','ram','switch','router','modem','monitor','ekran'],\r\n  'Hƒ±rdavat': ['vida','civata','somun','pul','rondela']\r\n};\r\nexport function categorizeItemName(name:string=''){\r\n  const t = (name||'').toLowerCase();\r\n  for (const [cat,keys] of Object.entries(RULES)){\r\n    if (keys.some(k => t.includes(k))) return cat;\r\n  }\r\n  return 'Genel';\r\n}\r\nexport function categoriesForItems(items:any[]){\r\n  const set = new Set<string>();\r\n  items.forEach(it => set.add(categorizeItemName(it.itemName)));\r\n  return Array.from(set);\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\services\\commit.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":24,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[674,677],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[674,677],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":24,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[707,710],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[707,710],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":31,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1061,1064],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1061,1064],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":31,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1072,1075],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1072,1075],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":2,"message":"Unexpected console statement. Only these console methods are allowed: groupCollapsed, groupEnd, info, warn, error.","line":41,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":41,"endColumn":20,"suggestions":[{"fix":{"range":[1508,1592],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1577,1580],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1577,1580],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":69,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2467,2470],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2467,2470],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { v4 as uuid } from 'uuid';\r\nimport admin from 'firebase-admin';\r\n\r\n// Initialize Firebase Admin if not already initialized\r\nif (!admin.apps.length) {\r\n  try {\r\n    admin.initializeApp({\r\n      credential: admin.credential.applicationDefault(),\r\n      projectId: 'teklifbul'\r\n    });\r\n  } catch (err) {\r\n    console.info('[Firebase Admin] Using fallback auth', err);\r\n    // Fallback to in-memory DB if Firebase Admin fails\r\n  }\r\n}\r\n\r\nlet db: FirebaseFirestore.Firestore | null = null;\r\ntry {\r\n  db = admin.apps.length ? admin.firestore() : null;\r\n} catch (err) {\r\n  console.info('[Firestore] Disabled, falling back to in-memory DB', err);\r\n  db = null;\r\n}\r\nconst DB:any = { demands: new Map<string, any>(), bySATFK: new Map<string,string>() };\r\n\r\nfunction genSATFK(){\r\n  const d = new Date(); const id = Math.floor(Math.random()*999).toString().padStart(3,'0');\r\n  return `SATFK-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${id}`;\r\n}\r\n\r\nexport async function commitDemand({ demand, items }:{ demand:any, items:any[] }){\r\n  let satfk = (demand.satfk||'').toString().trim();\r\n  if (satfk){\r\n    // Check in DB or Firestore\r\n    if (DB.bySATFK.has(satfk)) throw new Error('Bu SATFK daha √∂nce kullanƒ±lmƒ±≈ü');\r\n    if (db) {\r\n      try {\r\n        const snapshot = await db.collection('demands').where('satfk', '==', satfk).limit(1).get();\r\n        if (!snapshot.empty) throw new Error('Bu SATFK daha √∂nce kullanƒ±lmƒ±≈ü');\r\n      } catch (err) {\r\n        console.log('[Firestore] SATFK check failed, using mock DB', (err as any)?.message);\r\n        db = null;\r\n      }\r\n    }\r\n  } else {\r\n    do { satfk = genSATFK(); } while (DB.bySATFK.has(satfk));\r\n  }\r\n\r\n  const demandId = uuid();\r\n  const payload = {\r\n    demandId, satfk,\r\n    title: demand.title,\r\n    currency: demand.currency || 'TRY',\r\n    requester: demand.requester || null,\r\n    demandDate: demand.demandDate || null,\r\n    dueDate: demand.dueDate || null,\r\n    visibility: demand.visibility || 'public',\r\n    createdAt: new Date().toISOString(),\r\n    items: items.map((x,i)=>({ row:i+1, ...x })),\r\n    status: 'opened'\r\n  };\r\n\r\n  // Save to Firestore (if available) or fallback to in-memory DB\r\n  if (db) {\r\n      try {\r\n      await db.collection('demands').doc(demandId).set(payload);\r\n      console.info(`[Firestore] Saved demand ${demandId} (${satfk})`);\r\n    } catch (err) {\r\n      console.info('[Firestore] write failed, using mock DB', (err as any)?.message);\r\n      db = null;\r\n      DB.demands.set(demandId, payload);\r\n      DB.bySATFK.set(satfk, demandId);\r\n      console.info(`[Mock DB] Saved demand ${demandId} (${satfk})`);\r\n    }\r\n  } else {\r\n  DB.demands.set(demandId, payload);\r\n  DB.bySATFK.set(satfk, demandId);\r\n  console.info(`[Mock DB] Saved demand ${demandId} (${satfk})`);\r\n  }\r\n  \r\n  return { demandId, satfk };\r\n}\r\n\r\nexport const __DB = DB;\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\services\\docxParser.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":25,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[921,924],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[921,924],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":54,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2024,2027],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2024,2027],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as mammoth from 'mammoth';\r\nimport { z } from 'zod';\r\nimport { parseNumberTR, detectCurrency } from './normalization';\r\n\r\nconst demandSchema = z.object({\r\n  title: z.string().min(1),\r\n  requester: z.string().nullable().optional(),\r\n  demandDate: z.string().nullable().optional(),\r\n  dueDate: z.string().nullable().optional(),\r\n  currency: z.enum(['TRY','USD','EUR','GBP']).default('TRY'),\r\n  satfk: z.string().nullable().optional()\r\n});\r\n\r\nexport async function previewDocx(buf: Buffer){\r\n  const result = await mammoth.extractRawText({ buffer: buf });\r\n  const text = result.value;\r\n  const lines = text.split('\\n').filter(l => l.trim());\r\n  \r\n  // ƒ∞lk satƒ±rlar talep ba≈ülƒ±ƒüƒ± olabilir\r\n  const title = lines[0]?.trim() || 'Ba≈ülƒ±ksƒ±z Talep';\r\n  const requester = lines[1]?.trim() || null;\r\n  const currency = detectCurrency(text) ?? 'TRY';\r\n  \r\n  // Tablo benzeri yapƒ±lar i√ßin satƒ±rlarƒ± parse et\r\n  const items: any[] = [];\r\n  const matrix: string[][] = [];\r\n  const fieldCandidates: { label: string; value: string }[] = [];\r\n  for (let i = 2; i < lines.length; i++) {\r\n    const line = lines[i].trim();\r\n    if (!line || line.length < 3) continue;\r\n    \r\n    const colonSplit = line.split(/[:=]/);\r\n    if (colonSplit.length === 2) {\r\n      const label = colonSplit[0].trim();\r\n      const value = colonSplit[1].trim();\r\n      if (label && value) fieldCandidates.push({ label, value });\r\n    }\r\n\r\n    // Basit parsing: virg√ºl/sekme ile ayrƒ±lmƒ±≈ü alanlar\r\n    const parts = line.split(/,|\\t|\\s{2,}/).map(p => p.trim()).filter(Boolean);\r\n    if (parts.length) matrix.push(parts);\r\n    if (parts.length >= 3) {\r\n      const qty = parseNumberTR(parts[1]);\r\n      const unitPriceExcl = parseNumberTR(parts[5]);\r\n      const vatPct = parseNumberTR(parts[6]) ?? 18;\r\n      items.push({\r\n        itemName: parts[0],\r\n        qty: qty,\r\n        unit: parts[2],\r\n        brand: parts[3] || null,\r\n        model: parts[4] || null,\r\n        unitPriceExcl: unitPriceExcl,\r\n        vatPct: vatPct,\r\n        currency: currency as any,\r\n        deliveryDate: null,\r\n        note: null\r\n      });\r\n    }\r\n  }\r\n  \r\n  return {\r\n    profileHint: 'docx',\r\n    headerRow: 1,\r\n    headers: ['√úr√ºn Adƒ±', 'Miktar', 'Birim', 'Marka', 'Model', 'Birim Fiyat', 'KDV'],\r\n    colIdx: { itemName: 0, qty: 1, unit: 2, brand: 3, model: 4, unitPriceExcl: 5, vatPct: 6 },\r\n    confidence: items.length > 0 ? 70 : 30,\r\n    demand: demandSchema.parse({ title, requester, currency }),\r\n    items,\r\n    matrix,\r\n    fieldCandidates,\r\n    requiredItemFields: ['itemName', 'qty', 'unit'],\r\n    warnings: items.length === 0 ? ['DOCX formatƒ± basit parsing kullanƒ±yor. Excel formatƒ± √∂nerilir.'] : []\r\n  };\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\services\\importParser.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":30,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1032,1035],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1032,1035],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":45,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1652,1655],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1652,1655],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":45,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1658,1661],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1658,1661],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":52,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1938,1941],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1938,1941],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":52,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1959,1962],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1959,1962],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":56,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2069,2072],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2069,2072],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":57,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2115,2118],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2115,2118],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":61,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2225,2228],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2225,2228],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":66,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2285,2288],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2285,2288],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":76,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2700,2703],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2700,2703],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":114,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":114,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3941,3944],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3941,3944],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":121,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4224,4227],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4224,4227],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":130,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4598,4601],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4598,4601],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":149,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":149,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5420,5423],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5420,5423],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":176,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":176,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6553,6556],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6553,6556],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":183,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":183,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6845,6848],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6845,6848],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":197,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":197,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7378,7381],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7378,7381],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":17,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import ExcelJS from 'exceljs';\r\nimport levenshtein from 'fast-levenshtein';\r\nimport { parse as parseDate, isValid } from 'date-fns';\r\nimport { z } from 'zod';\r\n\r\nconst DICT: Record<string,string[]> = {\r\n  itemName: ['√ºr√ºn adƒ±','√ºr√ºn ismi','malzeme','stok adƒ±','a√ßƒ±klama','√ºr√ºn'],\r\n  qty: ['miktar','qty','adet'],\r\n  unit: ['birim','unit'],\r\n  unitPriceExcl: ['birim fiyat','net fiyat','b.fiyat','bf'],\r\n  vatPct: ['kdv','kdv %','kdv oranƒ±'],\r\n  currency: ['para birimi','pb','currency','d√∂viz','doviz'],\r\n  deliveryDate: ['teslim tarihi','sevk tarihi','termin'],\r\n  brand: ['marka'],\r\n  model: ['model'],\r\n  note: ['not','a√ßƒ±klama']\r\n};\r\n\r\nconst REQUIRED_ITEM = ['itemName','qty','unit'] as const;\r\n\r\nconst demandSchema = z.object({\r\n  title: z.string().min(1),\r\n  requester: z.string().nullable().optional(),\r\n  demandDate: z.string().nullable().optional(),\r\n  dueDate: z.string().nullable().optional(),\r\n  currency: z.enum(['TRY','USD','EUR','GBP']).default('TRY'),\r\n  satfk: z.string().nullable().optional()\r\n});\r\n\r\nconst N = (s:any)=> String(s??'').trim().toLowerCase();\r\nconst sim = (a:string,b:string)=>{ a=N(a); b=N(b); if(!a||!b) return 0; const d=levenshtein.get(a,b); return 1 - d/Math.max(a.length,b.length); };\r\n\r\nfunction pick(headers: string[], key: string){\r\n  let best = { idx: -1, score: 0 };\r\n  headers.forEach((h,i) => {\r\n    const terms = DICT[key] || [];\r\n    const s = Math.max(sim(h,key), ...terms.map(t=>sim(h,t)));\r\n    if (s > best.score) best = { idx:i, score:s };\r\n  });\r\n  return best.score >= 0.55 ? best.idx : -1;\r\n}\r\n\r\n// ---- Helpers: cell reading, numbers, dates, currency ---------------------\r\n\r\nfunction readCell(v:any): any {\r\n  // ExcelJS cell.value √ße≈üitli tiplerde olabilir\r\n  if (v == null) return undefined;\r\n  if (typeof v === 'string' || typeof v === 'number' || v instanceof Date) return v;\r\n\r\n  // Formula\r\n  if (typeof v === 'object' && 'formula' in v && 'result' in v) {\r\n    return (v as any).result ?? (v as any).formula;\r\n  }\r\n  // RichText\r\n  if (typeof v === 'object' && 'richText' in v) {\r\n    const parts = (v as any).richText || [];\r\n    return parts.map((p:any)=>p.text).join('');\r\n  }\r\n  // Hyperlink\r\n  if (typeof v === 'object' && 'text' in v) {\r\n    return (v as any).text;\r\n  }\r\n  return String(v);\r\n}\r\n\r\nfunction toISO(v:any){\r\n  const raw = readCell(v);\r\n  if (!raw) return undefined;\r\n  if (raw instanceof Date) return raw.toISOString().slice(0,10);\r\n  const s = String(raw).trim();\r\n  const fmts = ['yyyy-MM-dd','dd.MM.yyyy','dd/MM/yyyy','MM/dd/yyyy'];\r\n  for (const f of fmts){ const d = parseDate(s, f, new Date()); if (isValid(d)) return d.toISOString().slice(0,10); }\r\n  return s || undefined;\r\n}\r\n\r\nfunction parseNumberTR(input:any): number | undefined {\r\n  const raw = readCell(input);\r\n  if (raw == null || raw === '') return undefined;\r\n  if (typeof raw === 'number') return isFinite(raw) ? raw : undefined;\r\n  const s0 = String(raw).trim();\r\n  if (!s0) return undefined;\r\n\r\n  const hasDot = s0.includes('.');\r\n  const hasComma = s0.includes(',');\r\n  let s = s0;\r\n\r\n  if (hasDot && hasComma) {\r\n    // son g√∂r√ºlen ayƒ±rƒ±cƒ±yƒ± ondalƒ±k kabul et\r\n    if (s0.lastIndexOf(',') > s0.lastIndexOf('.')) {\r\n      s = s0.replace(/\\./g, '').replace(',', '.'); // 1.234,56 -> 1234.56\r\n    } else {\r\n      s = s0.replace(/,/g, ''); // 1,234.56 -> 1234.56\r\n    }\r\n  } else if (hasComma && !hasDot) {\r\n    s = s0.replace(',', '.'); // 1234,56 -> 1234.56\r\n  } else {\r\n    // 1.234 -> 1234 (binlik olabilir)\r\n    const m = s0.match(/^(\\d{1,3}(\\.\\d{3})+)(\\.\\d+)?$/);\r\n    if (m && !m[3]) s = s0.replace(/\\./g, '');\r\n  }\r\n\r\n  const n = Number(s);\r\n  return isFinite(n) ? n : undefined;\r\n}\r\n\r\ntype EnumCurrency = z.infer<typeof demandSchema>['currency'];\r\nconst CURRENCY_MAP: Record<string, EnumCurrency> = {\r\n  TL: 'TRY', TRY: 'TRY', '‚Ç∫': 'TRY',\r\n  USD: 'USD', $: 'USD', DOLAR: 'USD',\r\n  EUR: 'EUR', EURO: 'EUR', '‚Ç¨': 'EUR',\r\n  GBP: 'GBP', '¬£': 'GBP'\r\n};\r\n\r\nfunction normalizeCurrency(v:any): EnumCurrency | undefined {\r\n  const raw = readCell(v);\r\n  const s = String(raw ?? '').trim().toUpperCase();\r\n  const cleaned = s.replace(/[^A-Z¬£$‚Ç¨‚Ç∫]/g,''); // bo≈üluk/simge temizliƒüi\r\n  return CURRENCY_MAP[cleaned as keyof typeof CURRENCY_MAP];\r\n}\r\n\r\nfunction isRowMeaningful(i:any){\r\n  // en azƒ±ndan itemName var ve qty veya unit‚Äôten biri doluysa anlamlƒ± say\r\n  return !!(i.itemName && (i.qty != null || (i.unit && String(i.unit).trim().length>0)));\r\n}\r\n\r\n// -------------------------------------------------------------------------\r\n\r\nexport async function previewXlsx(buf: Buffer){\r\n  const wb = new ExcelJS.Workbook();\r\n  await wb.xlsx.load(buf as any);\r\n\r\n  const names = wb.worksheets.map(s=>s.name.toLowerCase());\r\n  const ws0 = wb.worksheets[0];\r\n  if (!ws0) throw new Error('Excel sayfasƒ± bo≈ü g√∂r√ºn√ºyor');\r\n\r\n  const byName = wb.worksheets.find(s => /kalem|malzeme|item|urun|satir|rows?/.test((s.name||'').toLowerCase()));\r\n  const second = wb.worksheets[1];\r\n  const wsItems = byName || second || ws0; // tek sayfa ise ws0 kullan\r\n\r\n  // ---- √úst bilgi alanlarƒ±\r\n  const rawCurrency = readCell(ws0.getCell('B6')?.value);\r\n  const currency = normalizeCurrency(rawCurrency) ?? 'TRY';\r\n\r\n  let title = String(readCell(ws0.getCell('B2')?.value) || readCell(ws0.getCell('C2')?.value) || '').trim();\r\n  if (!title) {\r\n    title = String(readCell(ws0.getCell('A1')?.value) || readCell(ws0.getCell('B1')?.value) || '').trim() || 'Talep Ba≈ülƒ±ƒüƒ±';\r\n  }\r\n\r\n  const demandRaw:any = {\r\n    satfk: readCell(ws0.getCell('B1')?.value) ?? null,\r\n    title,\r\n    requester: (String(readCell(ws0.getCell('B3')?.value) || '').trim()) || null,\r\n    demandDate: toISO(ws0.getCell('B4')?.value),\r\n    dueDate: toISO(ws0.getCell('B5')?.value),\r\n    currency\r\n  };\r\n  const demand = demandSchema.parse({ ...demandRaw });\r\n\r\n  // Prepare field candidates before pushing into it\r\n  const fieldCandidates: { label: string; value: string }[] = [];\r\n  // Collect high-level field candidates from the first sheet (label/value pairs)\r\n  for (let r = 1; r <= Math.min(40, ws0.rowCount); r++) {\r\n    const row = ws0.getRow(r);\r\n    const label = String(readCell(row.getCell(1).value) || \"\").trim();\r\n    const value = String(readCell(row.getCell(2).value) || \"\").trim();\r\n    if (label && value) {\r\n      fieldCandidates.push({ label, value });\r\n    }\r\n  }\r\n\r\n  if (!wsItems || wsItems.rowCount === 0) throw new Error('Kalem sayfasƒ± bulunamadƒ± veya bo≈ü');\r\n\r\n  // ---- Header satƒ±rƒ±nƒ± bul\r\n  let headerRow = 1, maxScore = -1;\r\n  for (let r=1; r<=Math.min(30, wsItems.rowCount); r++){\r\n    const vals = (wsItems.getRow(r).values as any[]).map(v=> String(readCell(v) || ''));\r\n    const score = Object.values(DICT)\r\n      .flat()\r\n      .reduce((acc,k)=> acc + (vals.some(h=>sim(h,k)>0.7)?1:0), 0);\r\n    if (score > maxScore){ maxScore = score; headerRow = r; }\r\n  }\r\n\r\n  const headers = (wsItems.getRow(headerRow).values as any[]).map(v=> String(readCell(v) || ''));\r\n  const colIdx = {\r\n    itemName:      pick(headers,'itemName'),\r\n    brand:         pick(headers,'brand'),\r\n    model:         pick(headers,'model'),\r\n    qty:           pick(headers,'qty'),\r\n    unit:          pick(headers,'unit'),\r\n    unitPriceExcl: pick(headers,'unitPriceExcl'),\r\n    vatPct:        pick(headers,'vatPct'),\r\n    currency:      pick(headers,'currency'),\r\n    deliveryDate:  pick(headers,'deliveryDate'),\r\n    note:          pick(headers,'note')\r\n  };\r\n\r\n  const items:any[] = [];\r\n  const matrix:string[][] = [];\r\n  const invalidRows:number[] = [];\r\n\r\n  for (let r=headerRow+1; r<=wsItems.rowCount; r++){\r\n    const row = wsItems.getRow(r);\r\n    // collect raw row values (first 25 columns) for mapping UI\r\n    const rawVals:string[] = [];\r\n    for (let c=1; c<=Math.min(25, row.cellCount || 25); c++){\r\n      rawVals.push(String(readCell(row.getCell(c).value) ?? ''));\r\n    }\r\n    if (rawVals.some(v=>v && v.trim())) matrix.push(rawVals);\r\n    const get = (k:keyof typeof colIdx)=> colIdx[k]===-1 ? undefined : readCell(row.getCell(colIdx[k]+1).value);\r\n\r\n    const rowCurrency = normalizeCurrency(get('currency')) ?? demand.currency;\r\n    const i = {\r\n      itemName: get('itemName'),\r\n      brand: get('brand') ?? null,\r\n      model: get('model') ?? null,\r\n      qty: parseNumberTR(get('qty')),\r\n      unit: (get('unit') ? String(get('unit')).trim() : null),\r\n      unitPriceExcl: parseNumberTR(get('unitPriceExcl')),\r\n      vatPct: parseNumberTR(get('vatPct')) ?? 18,\r\n      currency: rowCurrency,\r\n      deliveryDate: toISO(get('deliveryDate')) ?? null,\r\n      note: get('note') ?? null\r\n    };\r\n\r\n    // tamamen bo≈ü/g√ºr√ºlt√º satƒ±rlarƒ± atla\r\n    const hasAny = Object.values(i).some(v => v != null && String(v).trim() !== '');\r\n    if (!hasAny) continue;\r\n\r\n    if (isRowMeaningful(i)) {\r\n      items.push(i);\r\n    } else {\r\n      invalidRows.push(r);\r\n    }\r\n  }\r\n\r\n  // kolon bulunurluƒüu\r\n  const found = Object.values(colIdx).filter(v=>v!==-1).length;\r\n  const total = Object.keys(colIdx).length;\r\n\r\n  // confidence: kolon e≈üle≈üme * ve ge√ßerli item sayƒ±sƒ±\r\n  const columnScore = found / total;\r\n  const itemScore = Math.min(items.length / 5, 1); // 5+ satƒ±r varsa tam puan\r\n  const confidence = Math.round(100 * (0.6 * columnScore + 0.4 * itemScore));\r\n\r\n  const warnings: string[] = [];\r\n  if (confidence < 60) warnings.push('D√º≈ü√ºk e≈üle≈üme: Mapping ekranƒ± √∂nerilir');\r\n  if (invalidRows.length) warnings.push(`Bazƒ± satƒ±rlar eksik alanlardan dolayƒ± atlandƒ±: ${invalidRows.slice(0,10).join(', ')}${invalidRows.length>10?'‚Ä¶':''}`);\r\n  if (!items.length) warnings.push('Kalem tespit edilemedi. Ba≈ülƒ±k satƒ±rlarƒ±nƒ± belirginle≈ütirin veya Excel ≈üablonunu kullanƒ±n.');\r\n  if (!normalizeCurrency(currency)) warnings.push('Para birimi algƒ±lanamadƒ±/normalize edilemedi; TRY varsayƒ±ldƒ±.');\r\n\r\n  return {\r\n    profileHint: names.join(','),\r\n    headerRow, headers, colIdx, confidence,\r\n    demand, items,\r\n    matrix,\r\n    fieldCandidates,\r\n    requiredItemFields: REQUIRED_ITEM,\r\n    warnings\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\services\\mappingService.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'path' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'mapSynonymToField' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":43,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":60},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":19,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[753,756],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[753,756],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":20,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[768,771],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[768,771],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":34,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1065,1068],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1065,1068],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1204,1207],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1204,1207],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":71,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2157,2160],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2157,2160],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":74,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":74,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2251,2254],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2251,2254],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":166,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":166,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5142,5145],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5142,5145],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":212,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":212,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6696,6699],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6696,6699],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":10,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Mapping service orchestrates document parsing ‚Üí field mapping.\r\n * Summary: reuse existing parsers (xlsx/docx/pdf) and apply normalization/scoring/supplier-memory\r\n * to produce demand/items with confidence and review flags.\r\n */\r\n\r\nimport path from \"path\";\r\nimport { previewXlsx } from \"./importParser\";\r\nimport { previewDocx } from \"./docxParser\";\r\nimport { previewPdf } from \"./pdfParser\";\r\nimport { CandidateValue, enrichCandidate, mapSynonymToField, normalizeKey, parseDateTR, parseNumberTR } from \"./normalization\";\r\nimport { getSupplierMemoryStore } from \"./supplierMemory\";\r\nimport { scoreCandidate, TargetField } from \"./scorers\";\r\n\r\ntype SourceType = \"xlsx\" | \"docx\" | \"pdf\";\r\n\r\ninterface RawDocument {\r\n  type: SourceType;\r\n  demand: any;\r\n  items: any[];\r\n  headers?: string[];\r\n  matrix?: string[][];\r\n  fieldCandidates?: { label: string; value: string }[];\r\n  warnings?: string[];\r\n}\r\n\r\nexport interface MappingOptions {\r\n  filename?: string;\r\n  mimeType?: string;\r\n  supplierId?: string | null;\r\n}\r\n\r\nexport interface FieldResult {\r\n  value: any;\r\n  confidence: number;\r\n  needsReview: boolean;\r\n  sourceLabel?: string;\r\n}\r\n\r\nexport interface ItemResult {\r\n  value: Record<string, any>;\r\n  confidence: number;\r\n  needsReview: boolean;\r\n}\r\n\r\nexport interface MappingResult {\r\n  demand: Record<string, FieldResult>;\r\n  items: ItemResult[];\r\n  warnings: string[];\r\n}\r\n\r\nfunction detectType(opts: MappingOptions): SourceType {\r\n  const ext = (opts.filename || \"\").toLowerCase();\r\n  if (ext.endsWith(\".xlsx\")) return \"xlsx\";\r\n  if (ext.endsWith(\".docx\")) return \"docx\";\r\n  if (ext.endsWith(\".pdf\")) return \"pdf\";\r\n  const mime = (opts.mimeType || \"\").toLowerCase();\r\n  if (mime.includes(\"spreadsheet\")) return \"xlsx\";\r\n  if (mime.includes(\"word\")) return \"docx\";\r\n  return \"pdf\";\r\n}\r\n\r\nasync function parseRawDocument(buffer: Buffer, options: MappingOptions): Promise<RawDocument> {\r\n  const type = detectType(options);\r\n  if (type === \"xlsx\") {\r\n    const parsed = await previewXlsx(buffer);\r\n    return { type, ...parsed };\r\n  }\r\n  if (type === \"docx\") {\r\n    const parsed = await previewDocx(buffer);\r\n    return { type, ...parsed } as any;\r\n  }\r\n  const parsed = await previewPdf(buffer);\r\n  return { type: \"pdf\", ...parsed } as any;\r\n}\r\n\r\nconst ITEM_FIELDS: TargetField[] = [\r\n  \"itemName\",\r\n  \"qty\",\r\n  \"unit\",\r\n  \"brand\",\r\n  \"model\",\r\n  \"unitPriceExcl\",\r\n  \"vatPct\",\r\n];\r\n\r\nconst DEMAND_FIELDS: TargetField[] = [\r\n  \"title\",\r\n  \"requester\",\r\n  \"demandDate\",\r\n  \"dueDate\",\r\n  \"currency\",\r\n  \"note\",\r\n];\r\n\r\ninterface ColumnAssignment {\r\n  field: TargetField;\r\n  column: number;\r\n  score: number;\r\n}\r\n\r\nfunction gatherColumnLabels(doc: RawDocument): string[] {\r\n  if (doc.headers && doc.headers.length) return doc.headers;\r\n  if (doc.matrix && doc.matrix.length) return doc.matrix[0];\r\n  return [];\r\n}\r\n\r\nfunction pickSampleValue(doc: RawDocument, column: number): CandidateValue {\r\n  if (doc.matrix && doc.matrix.length) {\r\n    for (const row of doc.matrix) {\r\n      if (row[column] && row[column].trim()) {\r\n        return enrichCandidate(row[column]);\r\n      }\r\n    }\r\n  }\r\n  return enrichCandidate(\"\");\r\n}\r\n\r\nfunction assignColumns(doc: RawDocument, supplierAliases: string[]): ColumnAssignment[] {\r\n  const labels = gatherColumnLabels(doc);\r\n  const assignments: ColumnAssignment[] = [];\r\n  const usedColumns = new Set<number>();\r\n\r\n  for (const field of ITEM_FIELDS) {\r\n    let best: ColumnAssignment | null = null;\r\n    labels.forEach((label, idx) => {\r\n      const candidateValue = pickSampleValue(doc, idx);\r\n      const baseScore = scoreCandidate(field, label, candidateValue).score;\r\n      const aliasBoost = supplierAliases.some((alias) => normalizeKey(alias) === normalizeKey(label)) ? 0.1 : 0;\r\n      const total = Math.min(1, baseScore + aliasBoost);\r\n      if (!best || total > best.score) {\r\n        best = { field, column: idx, score: total };\r\n      }\r\n    });\r\n    if (best) assignments.push(best);\r\n  }\r\n\r\n  // Greedy unique assignment by descending score\r\n  assignments.sort((a, b) => b.score - a.score);\r\n  const unique: ColumnAssignment[] = [];\r\n  for (const a of assignments) {\r\n    if (usedColumns.has(a.column)) continue;\r\n    usedColumns.add(a.column);\r\n    unique.push(a);\r\n  }\r\n  return unique;\r\n}\r\n\r\nfunction mapDemandFields(doc: RawDocument, supplierAliases: string[]): Record<string, FieldResult> {\r\n  const fieldResults: Record<string, FieldResult> = {};\r\n  const candidates = doc.fieldCandidates || [];\r\n  const aliasNormalized = supplierAliases.map((a) => normalizeKey(a));\r\n\r\n  for (const target of DEMAND_FIELDS) {\r\n    let best: { score: number; candidate: { label: string; value: string } } | null = null;\r\n    candidates.forEach((cand) => {\r\n      const enriched = enrichCandidate(cand.value);\r\n      const score = scoreCandidate(target, cand.label, enriched).score;\r\n      const aliasBoost = aliasNormalized.includes(normalizeKey(cand.label)) ? 0.1 : 0;\r\n      const total = Math.min(1, score + aliasBoost);\r\n      if (!best || total > best.score) best = { score: total, candidate: cand };\r\n    });\r\n\r\n    if (best) {\r\n      const { candidate, score } = best;\r\n      let value: any = candidate.value;\r\n      if (target === \"demandDate\" || target === \"dueDate\") value = parseDateTR(value) || value;\r\n      if (target === \"currency\") value = (candidate.value || doc.demand?.currency || \"TRY\").toString().toUpperCase();\r\n      if (target === \"note\") value = candidate.value;\r\n      if (target === \"title\" && !value) value = doc.demand?.title || \"\";\r\n      fieldResults[target] = {\r\n        value,\r\n        confidence: score,\r\n        needsReview: score < 0.55,\r\n        sourceLabel: candidate.label,\r\n      };\r\n    }\r\n  }\r\n\r\n  if (doc.demand?.title && !fieldResults.title) {\r\n    fieldResults.title = {\r\n      value: doc.demand.title,\r\n      confidence: 0.9,\r\n      needsReview: false,\r\n      sourceLabel: \"title\",\r\n    };\r\n  }\r\n\r\n  if (doc.demand?.currency && !fieldResults.currency) {\r\n    fieldResults.currency = {\r\n      value: doc.demand.currency,\r\n      confidence: 0.6,\r\n      needsReview: false,\r\n      sourceLabel: \"currency\",\r\n    };\r\n  }\r\n\r\n  return fieldResults;\r\n}\r\n\r\nfunction mapItems(doc: RawDocument, assignments: ColumnAssignment[]): ItemResult[] {\r\n  if (!doc.matrix || !doc.matrix.length) {\r\n    // Fallback to parser-provided items\r\n    return (doc.items || []).map((item) => ({ value: item, confidence: 0.4, needsReview: true }));\r\n  }\r\n  const results: ItemResult[] = [];\r\n  const headerRow = gatherColumnLabels(doc);\r\n  const fieldByColumn = new Map<number, TargetField>();\r\n  assignments.forEach((a) => fieldByColumn.set(a.column, a.field));\r\n\r\n  for (const row of doc.matrix) {\r\n    const item: Record<string, any> = {};\r\n    const confidences: number[] = [];\r\n    fieldByColumn.forEach((field, column) => {\r\n      const raw = row[column] || \"\";\r\n      const enriched = enrichCandidate(raw);\r\n      item[field] = raw;\r\n      switch (field) {\r\n        case \"qty\":\r\n        case \"unitPriceExcl\":\r\n        case \"vatPct\": {\r\n          const num = parseNumberTR(raw);\r\n          if (num != null) item[field] = num;\r\n          break;\r\n        }\r\n        case \"demandDate\":\r\n        case \"dueDate\": {\r\n          const date = parseDateTR(raw);\r\n          if (date) item[field] = date;\r\n          break;\r\n        }\r\n        case \"currency\": {\r\n          item[field] = (raw || doc.demand?.currency || \"TRY\").toString().toUpperCase();\r\n          break;\r\n        }\r\n        default:\r\n          item[field] = raw;\r\n      }\r\n      const label = headerRow[column] || field;\r\n      const sc = scoreCandidate(field, label, enriched);\r\n      confidences.push(sc.score);\r\n    });\r\n    if (Object.values(item).some((val) => String(val || \"\").trim())) {\r\n      const avgConfidence = confidences.length ? confidences.reduce((a, b) => a + b, 0) / confidences.length : 0.3;\r\n      results.push({ value: item, confidence: avgConfidence, needsReview: avgConfidence < 0.55 });\r\n    }\r\n  }\r\n  return results;\r\n}\r\n\r\nexport async function mapDocument(buffer: Buffer, options: MappingOptions = {}): Promise<MappingResult> {\r\n  const raw = await parseRawDocument(buffer, options);\r\n  const supplierStore = getSupplierMemoryStore();\r\n  const aliases = supplierStore.getAliases(options.supplierId || null).map((a) => a.alias);\r\n\r\n  const assignments = assignColumns(raw, aliases);\r\n  const demandFields = mapDemandFields(raw, aliases);\r\n  const items = mapItems(raw, assignments);\r\n\r\n  // Persist memory from matched columns\r\n  assignments.forEach((assign) => {\r\n    const label = gatherColumnLabels(raw)[assign.column];\r\n    if (label) supplierStore.remember(options.supplierId || null, label, assign.field, assign.score);\r\n  });\r\n  Object.entries(demandFields).forEach(([field, result]) => {\r\n    if (result.sourceLabel) supplierStore.remember(options.supplierId || null, result.sourceLabel, field, result.confidence);\r\n  });\r\n\r\n  return {\r\n    demand: demandFields,\r\n    items,\r\n    warnings: raw.warnings || [],\r\n  };\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\services\\normalization.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\services\\pdfParser.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[452,455],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[452,455],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[697,700],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[697,700],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":23,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1064,1067],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1064,1067],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":23,"column":105,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":108,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1103,1106],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1103,1106],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":28,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1300,1303],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1300,1303],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":28,"column":105,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":108,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1339,1342],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1339,1342],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":38,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1725,1728],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1725,1728],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":39,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1753,1756],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1753,1756],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":53,"column":84,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":87,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2207,2210],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2207,2210],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":56,"column":98,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":101,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2405,2408],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2405,2408],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":64,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2740,2743],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2740,2743],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":11,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { z } from \"zod\";\r\nimport { createRequire } from 'module';\r\n\r\nconst require = createRequire(import.meta.url);\r\n\r\nlet __pdfParseFn: null | ((buf: Buffer | Uint8Array) => Promise<{ text: string }>) = null;\r\nasync function getPdfParse(): Promise<((buf: Buffer | Uint8Array) => Promise<{ text: string }>) | null> {\r\n  if (__pdfParseFn) return __pdfParseFn;\r\n  // Prefer dynamic import to let Node/tsx resolve ESM/CJS shapes\r\n  try {\r\n    const sub: any = await import('pdf-parse/lib/pdf-parse.js');\r\n    const fn = typeof sub === 'function' ? sub : (typeof sub?.default === 'function' ? sub.default : null);\r\n    if (fn) { __pdfParseFn = fn; return fn; }\r\n  } catch {}\r\n  try {\r\n    const mod: any = await import('pdf-parse');\r\n    const fn = typeof mod === 'function' ? mod : (typeof mod?.default === 'function' ? mod.default : null);\r\n    if (fn) { __pdfParseFn = fn; return fn; }\r\n  } catch {}\r\n  // Last resort: require (CJS)\r\n  try {\r\n    const sub = require('pdf-parse/lib/pdf-parse.js');\r\n    const fn = typeof sub === 'function' ? sub : (typeof (sub as any)?.default === 'function' ? (sub as any).default : null);\r\n    if (fn) { __pdfParseFn = fn; return fn; }\r\n  } catch {}\r\n  try {\r\n    const mod = require('pdf-parse');\r\n    const fn = typeof mod === 'function' ? mod : (typeof (mod as any)?.default === 'function' ? (mod as any).default : null);\r\n    if (fn) { __pdfParseFn = fn; return fn; }\r\n  } catch {}\r\n  // Could not resolve pdf-parse; signal null so caller can fallback\r\n  return null;\r\n}\r\n\r\n// Fallback parser using pdfjs-dist (no external native deps)\r\nasync function parseWithPdfJs(buf: Buffer | Uint8Array): Promise<{ text: string }>{\r\n  // Try multiple build entrypoints for node/esm\r\n  let pdfjs: any = null;\r\n  let lastErr: any = null;\r\n  const candidates = [\r\n    'pdfjs-dist/legacy/build/pdf.mjs',\r\n    'pdfjs-dist/legacy/build/pdf.js',\r\n    'pdfjs-dist/build/pdf.mjs',\r\n    'pdfjs-dist/build/pdf.js'\r\n  ];\r\n  for (const id of candidates) {\r\n    try {\r\n      pdfjs = await import(id);\r\n      if (pdfjs?.getDocument) break;\r\n    } catch (e) { lastErr = e; }\r\n  }\r\n  if (!pdfjs?.getDocument) {\r\n    throw new Error(`[pdfParser] Unable to load pdfjs-dist fallback: ${(lastErr as any)?.message || lastErr}`);\r\n  }\r\n  // Ensure plain Uint8Array (Buffer subclasses may be rejected)\r\n  const u8 = buf instanceof Uint8Array ? new Uint8Array(buf) : new Uint8Array(Buffer.from(buf as any));\r\n  const loadingTask = pdfjs.getDocument({ data: u8 });\r\n  const pdf = await loadingTask.promise;\r\n  let out = '';\r\n  const total = pdf.numPages || 0;\r\n  for (let p = 1; p <= total; p++) {\r\n    const page = await pdf.getPage(p);\r\n    const content = await page.getTextContent();\r\n    const text = (content.items || []).map((it: any) => it.str || '').join(' ');\r\n    out += (out ? '\\n' : '') + text;\r\n  }\r\n  try { await pdf?.destroy?.(); } catch{}\r\n  return { text: out };\r\n}\r\n\r\nconst demandSchema = z.object({\r\n  title: z.string().min(1),\r\n  requester: z.string().nullable().optional(),\r\n  demandDate: z.string().nullable().optional(),\r\n  dueDate: z.string().nullable().optional(),\r\n  currency: z.enum([\"TRY\", \"USD\", \"EUR\", \"GBP\"]).default(\"TRY\"),\r\n  satfk: z.string().nullable().optional(),\r\n});\r\n\r\ntype Demand = z.infer<typeof demandSchema>;\r\n\r\ntype Item = {\r\n  itemName: string;\r\n  qty: number | null;\r\n  unit: string | null;\r\n  brand?: string | null;\r\n  model?: string | null;\r\n  unitPriceExcl?: number | null;\r\n  vatPct?: number | null;\r\n  currency?: \"TRY\" | \"USD\" | \"EUR\" | \"GBP\";\r\n  deliveryDate?: string | null;\r\n  note?: string | null;\r\n};\r\n\r\n// --- Helpers --------------------------------------------------------------\r\n\r\nconst CURRENCY_MAP: Record<string, Demand[\"currency\"]> = {\r\n  TL: \"TRY\",\r\n  TRY: \"TRY\",\r\n  \"‚Ç∫\": \"TRY\",\r\n  USD: \"USD\",\r\n  $: \"USD\",\r\n  DOLAR: \"USD\",\r\n  EUR: \"EUR\",\r\n  EURO: \"EUR\",\r\n  \"‚Ç¨\": \"EUR\",\r\n  GBP: \"GBP\",\r\n  \"¬£\": \"GBP\",\r\n};\r\n\r\nfunction normalizeCurrency(s: unknown): Demand[\"currency\"] | undefined {\r\n  const raw = String(s ?? \"\").trim().toUpperCase();\r\n  const cleaned = raw.replace(/[^A-Z¬£$‚Ç¨‚Ç∫]/g, \"\");\r\n  return CURRENCY_MAP[cleaned as keyof typeof CURRENCY_MAP];\r\n}\r\n\r\n/** TR ve EN sayƒ± bi√ßimlerini destekler: \"1.234,56\" | \"1,234.56\" | \"1234,56\" | \"1234.56\" | \"1234\" */\r\nfunction parseNumberTR(input?: string | number | null): number | null {\r\n  if (input == null) return null;\r\n  if (typeof input === \"number\") return isFinite(input) ? input : null;\r\n  const s = input.toString().trim();\r\n  if (!s) return null;\r\n\r\n  // hem nokta hem virg√ºl varsa -> hangisi ondalƒ±k?\r\n  const hasDot = s.includes(\".\");\r\n  const hasComma = s.includes(\",\");\r\n  let normalized = s;\r\n\r\n  if (hasDot && hasComma) {\r\n    // Son g√∂r√ºlen ayƒ±rƒ±cƒ±yƒ± ondalƒ±k kabul et\r\n    if (s.lastIndexOf(\",\") > s.lastIndexOf(\".\")) {\r\n      // \"1.234,56\" -> \"1234.56\"\r\n      normalized = s.replace(/\\./g, \"\").replace(\",\", \".\");\r\n    } else {\r\n      // \"1,234.56\" -> \"1234.56\"\r\n      normalized = s.replace(/,/g, \"\");\r\n    }\r\n  } else if (hasComma && !hasDot) {\r\n    // \"1234,56\" -> \"1234.56\"\r\n    normalized = s.replace(\",\", \".\");\r\n  } else {\r\n    // \"1.234\" -> \"1234\" (muhtemelen binlik)\r\n    // eƒüer sadece tek nokta varsa ve 3 haneli grupsa kaldƒ±r\r\n    const m = s.match(/^(\\d{1,3}(\\.\\d{3})+)(\\.\\d+)?$/);\r\n    if (m && !m[3]) normalized = s.replace(/\\./g, \"\");\r\n  }\r\n\r\n  const n = Number(normalized);\r\n  return isFinite(n) ? n : null;\r\n}\r\n\r\nfunction pickCurrencyFromText(text: string): Demand[\"currency\"] | undefined {\r\n  // metinde ge√ßen ilk para birimini yakala\r\n  const token = (text.match(/(TRY|TL|USD|\\$|EUR|‚Ç¨|GBP|¬£)/i) || [])[1];\r\n  return normalizeCurrency(token);\r\n}\r\n\r\n// Ba≈ülƒ±k/alan √ßƒ±karƒ±mlarƒ± i√ßin regex‚Äôler\r\nconst RX = {\r\n  requester: /(Satƒ±nalma\\s*Personeli|Talep Eden|ƒ∞stek Sahibi)\\s*[:\\n]\\s*([^\\n]+)/i,\r\n  demandDate: /(Talep\\s*Tarihi|Tarih)\\s*[:\\n]\\s*([0-3]?\\d[./-][01]?\\d[./-](?:20)?\\d{2})/i,\r\n  dueDate: /(Termin|Teslim|Son Tarih)\\s*[:\\n]\\s*([0-3]?\\d[./-][01]?\\d[./-](?:20)?\\d{2})/i,\r\n  pnSnLine: /(?:^|\\s)(?:P\\/?N|PN)\\s*[: ]\\s*([^\\n]+?)\\s+(?:S\\/?N|SN)\\s*[: ]\\s*([^\\n]+)/i,\r\n};\r\n\r\n// --- Core -----------------------------------------------------------------\r\n\r\nexport async function previewPdf(buf: Buffer) {\r\n  const pdfParse = await getPdfParse();\r\n  const data = pdfParse ? await pdfParse(buf) : await parseWithPdfJs(buf);\r\n  const text = (data.text || \"\").replace(/\\r/g, \"\");\r\n  const lines = text.split(\"\\n\").map((l) => l.trim()).filter(Boolean);\r\n\r\n  // ---- Header alanlarƒ±\r\n  const title = lines[0] || \"Ba≈ülƒ±ksƒ±z Talep\";\r\n  const requester =\r\n    (text.match(RX.requester)?.[2] || lines[1] || \"\").trim() || null;\r\n  const demandDate = (text.match(RX.demandDate)?.[2] || null);\r\n  const dueDate = (text.match(RX.dueDate)?.[2] || null);\r\n  const currency = pickCurrencyFromText(text) ?? \"TRY\";\r\n\r\n  // ---- Kalem √ßƒ±karƒ±mƒ±\r\n  const items: Item[] = [];\r\n  const warnings: string[] = [];\r\n  const matrix: string[][] = [];\r\n  const fieldCandidates: { label: string; value: string }[] = [];\r\n\r\n  // 1) PN/SN tabanlƒ± kalemler\r\n  for (const line of lines) {\r\n    const m = line.match(RX.pnSnLine);\r\n    if (m) {\r\n      items.push({\r\n        itemName: `P/N: ${m[1].trim()} S/N: ${m[2].trim()}`,\r\n        qty: 1,\r\n        unit: \"ADET\",\r\n        currency,\r\n        vatPct: 18,\r\n      });\r\n    }\r\n  }\r\n\r\n  // 2) Tablo benzeri (virg√ºl/sekme/√ßoklu bo≈üluk) satƒ±rlar\r\n  // Ba≈ülƒ±klarƒ± dƒ±≈üla\r\n  const headerLike = /√úR√úN|KALEM|MALZEME|Bƒ∞Rƒ∞M|Mƒ∞KTAR|Fƒ∞YAT|KDV/i;\r\n  for (let i = 0; i < lines.length; i++) {\r\n    const line = lines[i];\r\n    if (headerLike.test(line)) continue;\r\n    const colonSplit = line.split(/[:=]/);\r\n    if (colonSplit.length === 2) {\r\n      const label = colonSplit[0].trim();\r\n      const value = colonSplit[1].trim();\r\n      if (label && value) fieldCandidates.push({ label, value });\r\n    }\r\n    // min 3 h√ºcre bekliyoruz: ad, miktar, birim\r\n    const parts = line\r\n      .split(/,|\\t| {2,}/)\r\n      .map((p) => p.trim())\r\n      .filter(Boolean);\r\n\r\n    if (parts.length >= 3) {\r\n      matrix.push(parts);\r\n      const [name, qtyRaw, unit, brand, model, priceRaw, vatRaw] = parts;\r\n      // Eƒüer bu satƒ±r PN/SN i√ßeriyorsa, zaten eklenmi≈ütir.\r\n      if (RX.pnSnLine.test(line)) continue;\r\n\r\n      const qty = parseNumberTR(qtyRaw);\r\n      const unitPriceExcl = parseNumberTR(priceRaw);\r\n      const vatPct = parseNumberTR(vatRaw) ?? 18;\r\n\r\n      // isim √ßok kƒ±sa ise (g√ºr√ºlt√º) atla\r\n      if (name.length < 3) continue;\r\n\r\n      items.push({\r\n        itemName: name,\r\n        qty,\r\n        unit: unit || null,\r\n        brand: brand || null,\r\n        model: model || null,\r\n        unitPriceExcl,\r\n        vatPct,\r\n        currency,\r\n        deliveryDate: null,\r\n        note: null,\r\n      });\r\n    }\r\n  }\r\n\r\n  // tekrarlarƒ± temizle (aynƒ± itemName + qty + unit)\r\n  const dedupKey = (i: Item) => `${i.itemName}__${i.qty ?? \"\"}__${i.unit ?? \"\"}`;\r\n  const seen = new Set<string>();\r\n  const uniqueItems = items.filter((i) => {\r\n    const k = dedupKey(i);\r\n    if (seen.has(k)) return false;\r\n    seen.add(k);\r\n    return true;\r\n  });\r\n\r\n  if (uniqueItems.length === 0) {\r\n    warnings.push(\r\n      \"PDF metninden tablo tespit edilemedi. PN/SN ya da s√ºtunlar arasƒ± √ßift bo≈üluk/sekme kullanƒ±mƒ± √∂nerilir. Excel formatƒ± daha saƒülƒ±klƒ±dƒ±r.\"\r\n    );\r\n  }\r\n\r\n  // ---- Demand olu≈ütur & doƒürula\r\n  const demand: Demand = demandSchema.parse({\r\n    title,\r\n    requester,\r\n    demandDate,\r\n    dueDate,\r\n    currency,\r\n  });\r\n\r\n  // g√ºven puanƒ±\r\n  const confidence =\r\n    uniqueItems.length >= 3 ? 85 :\r\n    uniqueItems.length > 0 ? 65 :\r\n    25;\r\n\r\n  return {\r\n    profileHint: \"pdf\",\r\n    headerRow: 1,\r\n    headers: [\"√úr√ºn Adƒ±\", \"Miktar\", \"Birim\", \"Marka\", \"Model\", \"Birim Fiyat\", \"KDV\"],\r\n    colIdx: { itemName: 0, qty: 1, unit: 2, brand: 3, model: 4, unitPriceExcl: 5, vatPct: 6 },\r\n    confidence,\r\n    demand,\r\n    items: uniqueItems,\r\n    matrix,\r\n    fieldCandidates,\r\n    requiredItemFields: [\"itemName\", \"qty\", \"unit\"],\r\n    warnings,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\services\\scorers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\services\\supplierMatch.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[95,98],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[95,98],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { categoriesForItems } from './category';\r\n\r\nexport async function matchSuppliers(items:any[]){\r\n  const cats = categoriesForItems(items);\r\n  // TODO: DB‚Äôden kategori etiketine g√∂re firma listesi √ßek\r\n  return cats.map((c,i)=>({\r\n    category: c,\r\n    suppliers: [\r\n      { id: `sup-${i+1}-A`, title: `${c} A.≈û.` },\r\n      { id: `sup-${i+1}-B`, title: `${c} Tic.` },\r\n      { id: `sup-${i+1}-C`, title: `${c} Ltd.` }\r\n    ]\r\n  }));\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\services\\supplierMemory.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\src\\api\\offers.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":50,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1526,1529],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1526,1529],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":88,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2498,2501],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2498,2501],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":191,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":191,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5145,5148],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5145,5148],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'offerId' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":215,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":215,"endColumn":18},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":263,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":263,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7108,7111],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7108,7111],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":287,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":287,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7871,7874],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7871,7874],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Teklif API Endpoints\r\n * \r\n * POST /api/offers/parse ‚Üí raw UI/Excel ‚Üí schema\r\n * POST /api/offers/validate ‚Üí schema ‚Üí rapor\r\n * POST /api/offers ‚Üí kalƒ±cƒ± kaydet + ili≈ükilendir (satfkCode)\r\n * POST /api/offers/:id/submit ‚Üí kontrol ‚Üí g√∂nder\r\n */\r\n\r\nimport express, { Request, Response } from 'express';\r\nimport multer from 'multer';\r\nimport { OfferSchema, Offer } from '../../../src/domain/offer/schema';\r\nimport { importSupplierOffer } from '../../../src/import/excel/supplierOfferImport';\r\nimport { exportSupplierOffer } from '../../../src/export/excel/supplierOfferExport';\r\nimport { ZodError } from 'zod';\r\n\r\nconst router = express.Router();\r\nconst upload = multer({ storage: multer.memoryStorage(), limits: { fileSize: 10 * 1024 * 1024 } });\r\n\r\n/**\r\n * POST /api/offers/parse\r\n * Excel veya JSON'dan teklif ≈üemasƒ±na parse et\r\n */\r\nrouter.post('/parse', upload.single('file'), async (req: Request, res: Response) => {\r\n  try {\r\n    // Excel dosyasƒ± y√ºklenmi≈üse\r\n    if (req.file) {\r\n      const buffer = req.file.buffer;\r\n      const offer = await importSupplierOffer(buffer);\r\n      \r\n      return res.json({\r\n        ok: true,\r\n        offer,\r\n      });\r\n    }\r\n    \r\n    // JSON body varsa\r\n    if (req.body && req.body.offer) {\r\n      const parsed = OfferSchema.parse(req.body.offer);\r\n      return res.json({\r\n        ok: true,\r\n        offer: parsed,\r\n      });\r\n    }\r\n    \r\n    return res.status(400).json({\r\n      ok: false,\r\n      error: 'Excel dosyasƒ± veya JSON body gerekli',\r\n    });\r\n  } catch (error: any) {\r\n    console.error('Parse error:', error);\r\n    return res.status(400).json({\r\n      ok: false,\r\n      error: error.message || 'Parse hatasƒ±',\r\n      details: error instanceof ZodError ? error.errors : undefined,\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/offers/validate\r\n * Teklif ≈üemasƒ±nƒ± doƒürula ve rapor d√∂nd√ºr\r\n */\r\nrouter.post('/validate', async (req: Request, res: Response) => {\r\n  try {\r\n    const offerData = req.body.offer || req.body;\r\n    \r\n    // Zod validation\r\n    const result = OfferSchema.safeParse(offerData);\r\n    \r\n    if (!result.success) {\r\n      return res.json({\r\n        ok: false,\r\n        valid: false,\r\n        errors: result.error.errors,\r\n      });\r\n    }\r\n    \r\n    // ƒ∞≈ü kurallarƒ± kontrol√º\r\n    const businessRules = validateBusinessRules(result.data);\r\n    \r\n    return res.json({\r\n      ok: true,\r\n      valid: businessRules.valid,\r\n      offer: result.data,\r\n      businessRules: businessRules.issues,\r\n    });\r\n  } catch (error: any) {\r\n    console.error('Validate error:', error);\r\n    return res.status(500).json({\r\n      ok: false,\r\n      error: error.message || 'Validation hatasƒ±',\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * ƒ∞≈ü kurallarƒ± doƒürulama\r\n */\r\nfunction validateBusinessRules(offer: Offer): { valid: boolean; issues: string[] } {\r\n  const issues: string[] = [];\r\n  \r\n  // Zorunlu alanlar\r\n  if (!offer.header.satfkCode) {\r\n    issues.push('SATFK kodu zorunludur');\r\n  }\r\n  \r\n  if (!offer.header.title) {\r\n    issues.push('Ba≈ülƒ±k zorunludur');\r\n  }\r\n  \r\n  if (offer.lines.length === 0) {\r\n    issues.push('En az 1 satƒ±r zorunludur');\r\n  }\r\n  \r\n  // Tarih kontrolleri\r\n  if (offer.header.dueDate) {\r\n    const dueDate = new Date(offer.header.dueDate);\r\n    const now = new Date();\r\n    if (dueDate < now) {\r\n      issues.push('Termin tarihi ge√ßmi≈ü olamaz');\r\n    }\r\n  }\r\n  \r\n  if (offer.validUntil) {\r\n    const validUntil = new Date(offer.validUntil);\r\n    const now = new Date();\r\n    if (validUntil < now) {\r\n      issues.push('Ge√ßerlilik tarihi bug√ºnden √∂nce olamaz');\r\n    }\r\n  }\r\n  \r\n  // Satƒ±r kontrolleri\r\n  offer.lines.forEach((line, index) => {\r\n    if (line.quantity <= 0) {\r\n      issues.push(`Satƒ±r ${index + 1}: Miktar 0'dan b√ºy√ºk olmalƒ±`);\r\n    }\r\n    \r\n    if (line.unitPrice < 0) {\r\n      issues.push(`Satƒ±r ${index + 1}: Birim fiyat negatif olamaz`);\r\n    }\r\n    \r\n    if (line.deliveryDate) {\r\n      const deliveryDate = new Date(line.deliveryDate);\r\n      const now = new Date();\r\n      if (deliveryDate < now) {\r\n        issues.push(`Satƒ±r ${index + 1}: Teslim tarihi ge√ßmi≈ü olamaz`);\r\n      }\r\n    }\r\n  });\r\n  \r\n  // Gizli teklif kontrol√º\r\n  if (offer.header.isSealedBid && offer.status !== 'draft' && offer.status !== 'submitted') {\r\n    issues.push('Gizli teklifler sadece draft veya submitted durumunda olabilir');\r\n  }\r\n  \r\n  return {\r\n    valid: issues.length === 0,\r\n    issues,\r\n  };\r\n}\r\n\r\n/**\r\n * POST /api/offers\r\n * Teklifi kalƒ±cƒ± kaydet\r\n */\r\nrouter.post('/', async (req: Request, res: Response) => {\r\n  try {\r\n    const offerData = req.body.offer || req.body;\r\n    \r\n    // Validation\r\n    const validated = OfferSchema.parse(offerData);\r\n    \r\n    // Mock: Firestore/DB'ye kaydet\r\n    // TODO: Ger√ßek Firestore adapt√∂r√º ekle\r\n    const savedOffer = {\r\n      ...validated,\r\n      id: `offer_${Date.now()}`,\r\n      createdAt: new Date().toISOString(),\r\n      updatedAt: new Date().toISOString(),\r\n    };\r\n    \r\n    // Mock: Firestore collection'a ekle\r\n    // await db.collection('offers').add(savedOffer);\r\n    \r\n    return res.json({\r\n      ok: true,\r\n      offer: savedOffer,\r\n      message: 'Teklif kaydedildi',\r\n    });\r\n  } catch (error: any) {\r\n    console.error('Save error:', error);\r\n    \r\n    if (error instanceof ZodError) {\r\n      return res.status(400).json({\r\n        ok: false,\r\n        error: 'Validation hatasƒ±',\r\n        details: error.errors,\r\n      });\r\n    }\r\n    \r\n    return res.status(500).json({\r\n      ok: false,\r\n      error: error.message || 'Kaydetme hatasƒ±',\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/offers/:id/submit\r\n * Teklifi g√∂nder (kontroller + durum g√ºncelleme)\r\n */\r\nrouter.post('/:id/submit', async (req: Request, res: Response) => {\r\n  try {\r\n    const offerId = req.params.id;\r\n    \r\n    // Mock: Firestore'dan teklifi getir\r\n    // const offerDoc = await db.collection('offers').doc(offerId).get();\r\n    // if (!offerDoc.exists) {\r\n    //   return res.status(404).json({ ok: false, error: 'Teklif bulunamadƒ±' });\r\n    // }\r\n    // const offer = offerDoc.data() as Offer;\r\n    \r\n    // ≈ûimdilik mock offer\r\n    const offer = req.body.offer as Offer;\r\n    \r\n    // Validation\r\n    const validated = OfferSchema.parse(offer);\r\n    \r\n    // ƒ∞≈ü kurallarƒ±\r\n    const businessRules = validateBusinessRules(validated);\r\n    if (!businessRules.valid) {\r\n      return res.status(400).json({\r\n        ok: false,\r\n        error: 'ƒ∞≈ü kurallarƒ± ihlali',\r\n        issues: businessRules.issues,\r\n      });\r\n    }\r\n    \r\n    // Gizli teklif kontrol√º\r\n    if (validated.header.isSealedBid && validated.status !== 'draft') {\r\n      return res.status(400).json({\r\n        ok: false,\r\n        error: 'Gizli teklifler d√ºzenlenemez',\r\n      });\r\n    }\r\n    \r\n    // Durum g√ºncelleme\r\n    const submittedOffer = {\r\n      ...validated,\r\n      status: 'submitted' as const,\r\n      updatedAt: new Date().toISOString(),\r\n    };\r\n    \r\n    // Mock: Firestore'a kaydet\r\n    // await db.collection('offers').doc(offerId).update(submittedOffer);\r\n    \r\n    return res.json({\r\n      ok: true,\r\n      offer: submittedOffer,\r\n      message: 'Teklif ba≈üarƒ±yla g√∂nderildi',\r\n    });\r\n  } catch (error: any) {\r\n    console.error('Submit error:', error);\r\n    return res.status(500).json({\r\n      ok: false,\r\n      error: error.message || 'G√∂nderme hatasƒ±',\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/offers/export\r\n * Excel export\r\n */\r\nrouter.post('/export', async (req: Request, res: Response) => {\r\n  try {\r\n    const offerData = req.body.offer || req.body;\r\n    const validated = OfferSchema.parse(offerData);\r\n    \r\n    const buffer = await exportSupplierOffer(validated);\r\n    \r\n    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\r\n    res.setHeader('Content-Disposition', `attachment; filename=\"Teklif_${validated.header.satfkCode}_${Date.now()}.xlsx\"`);\r\n    \r\n    return res.send(buffer);\r\n  } catch (error: any) {\r\n    console.error('Export error:', error);\r\n    return res.status(500).json({\r\n      ok: false,\r\n      error: error.message || 'Export hatasƒ±',\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\src\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\src\\routes\\demands.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":27,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[848,851],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[848,851],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import express from \"express\";\r\nimport { DemandInput } from \"../types/demand\";\r\nimport { computeInvitedSupplierIds } from \"../services/inviteService\";\r\n\r\nconst router = express.Router();\r\n\r\nrouter.post(\"/\", async (req, res) => {\r\n  try {\r\n    const body = req.body as DemandInput;\r\n    if (!body?.demandVisibility || !body?.bidVisibility) {\r\n      return res.status(400).json({ error: \"Eksik alanlar\" });\r\n    }\r\n\r\n    // Sunucu tarafƒ± DOƒûRULAMA\r\n    const invited = await computeInvitedSupplierIds(body);\r\n\r\n    const demandDoc = {\r\n      ...body,\r\n      invitedSupplierIds: invited,\r\n      createdAt: new Date().toISOString(),\r\n    };\r\n\r\n    // TODO: Firestore/DB'ye kaydet\r\n    // const saved = await db.collection(\"demands\").add(demandDoc);\r\n\r\n    return res.status(201).json({ ok: true, demand: demandDoc /* id: saved.id */ });\r\n  } catch (e: any) {\r\n    console.error(e);\r\n    return res.status(500).json({ error: \"Sunucu hatasƒ±\" });\r\n  }\r\n});\r\n\r\nexport default router;\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\src\\routes\\escrow.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[99,102],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[99,102],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[337,340],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[337,340],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Router } from 'express';\r\n\r\ntype Audit = { at: string; by: string; action: string; meta?: any };\r\ntype Escrow = { id: string; status: string; audit: Audit[]; demandId?: string; bidId?: string };\r\n\r\nconst escrows = new Map<string, Escrow>();\r\nconst router = Router();\r\n\r\nfunction createAudit(action: string, by = 'system', meta: any = {}): Audit {\r\n  return { at: new Date().toISOString(), by, action, meta };\r\n}\r\n\r\nrouter.post('/create', (req, res) => {\r\n  const id = Math.random().toString(36).slice(2, 10);\r\n  const e: Escrow = { id, status: 'awaiting_funds', audit: [createAudit('create')], demandId: req.body?.demandId, bidId: req.body?.bidId };\r\n  escrows.set(id, e);\r\n  res.json(e);\r\n});\r\n\r\nrouter.post('/upload-proof', (req, res) => {\r\n  const { id } = req.body || {};\r\n  const e = escrows.get(id);\r\n  if (!e) return res.status(404).send('not found');\r\n  e.audit.push(createAudit('upload-proof'));\r\n  res.json(e);\r\n});\r\n\r\nrouter.post('/webhook/bank', (req, res) => {\r\n  const { id } = req.body || {};\r\n  const e = escrows.get(id);\r\n  if (!e) return res.status(404).send('not found');\r\n  e.status = 'in_escrow';\r\n  e.audit.push(createAudit('bank-ok', 'bank'));\r\n  res.json(e);\r\n});\r\n\r\nrouter.post('/ship-docs', (req, res) => {\r\n  const { id } = req.body || {};\r\n  const e = escrows.get(id);\r\n  if (!e) return res.status(404).send('not found');\r\n  e.status = 'shipped';\r\n  e.audit.push(createAudit('ship-docs', 'seller'));\r\n  res.json(e);\r\n});\r\n\r\nrouter.post('/approve-delivery', (req, res) => {\r\n  const { id } = req.body || {};\r\n  const e = escrows.get(id);\r\n  if (!e) return res.status(404).send('not found');\r\n  e.status = 'released';\r\n  e.audit.push(createAudit('approve-delivery', 'buyer'));\r\n  res.json(e);\r\n});\r\n\r\nrouter.post('/dispute', (req, res) => {\r\n  const { id } = req.body || {};\r\n  const e = escrows.get(id);\r\n  if (!e) return res.status(404).send('not found');\r\n  e.status = 'dispute';\r\n  e.audit.push(createAudit('dispute'));\r\n  res.json(e);\r\n});\r\n\r\nrouter.get('/:id', (req, res) => {\r\n  const e = escrows.get(req.params.id);\r\n  if (!e) return res.status(404).send('not found');\r\n  res.json(e);\r\n});\r\n\r\nexport default router;\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\src\\routes\\groups.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\src\\routes\\payment-preference.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[72,75],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[72,75],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Router } from 'express';\r\n\r\ntype Pref = { id: string; payload: any; at: string };\r\nconst prefs: Pref[] = [];\r\nconst router = Router();\r\n\r\nrouter.post('/', (req, res) => {\r\n  const id = Math.random().toString(36).slice(2, 10);\r\n  const rec: Pref = { id, payload: req.body, at: new Date().toISOString() };\r\n  prefs.push(rec);\r\n  res.json({ id, ok: true });\r\n});\r\n\r\nrouter.get('/', (_req, res) => { res.json(prefs); });\r\n\r\nexport default router;\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\src\\services\\inviteService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\src\\types\\demand.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\server\\test-env.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\App.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\__tests__\\offer.spec.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Currency' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":40,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":48},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'expected' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":95,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":95,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":131,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4284,4287],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4284,4287],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":149,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":149,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4730,4733],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4730,4733],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":169,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":169,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5295,5298],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5295,5298],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":187,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":187,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5749,5752],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5749,5752],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":199,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":199,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6092,6095],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6092,6095],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Teklif Mod√ºl√º Testleri\r\n */\r\n\r\nimport { describe, it, expect } from '@jest/globals';\r\nimport { OfferSchema, Offer, Priority, Currency } from '../domain/offer/schema';\r\nimport { mapPriority, mapCurrency, mapDemandToOfferHeader, mapDemandItemsToOfferLines, calculateDifference } from '../domain/offer/mapping';\r\nimport { requiresCurrencyInfo, getCurrencyNameTR } from '../services/currency';\r\n\r\ndescribe('Offer Module Tests', () => {\r\n  \r\n  describe('Mapping', () => {\r\n    \r\n    it('should map priority EN‚ÜíTR correctly', () => {\r\n      expect(mapPriority('price')).toBe('price');\r\n      expect(mapPriority('speed')).toBe('date');\r\n      expect(mapPriority('quality')).toBe('quality');\r\n      expect(mapPriority('fiyat')).toBe('price');\r\n      expect(mapPriority('hƒ±z')).toBe('date');\r\n      expect(mapPriority('kalite')).toBe('quality');\r\n      expect(mapPriority(undefined)).toBeUndefined();\r\n    });\r\n    \r\n    it('should map currency correctly', () => {\r\n      expect(mapCurrency('TRY')).toBe('TRY');\r\n      expect(mapCurrency('USD')).toBe('USD');\r\n      expect(mapCurrency('TL')).toBe('TRY');\r\n      expect(mapCurrency('$')).toBe('USD');\r\n      expect(mapCurrency('‚Ç¨')).toBe('EUR');\r\n      expect(mapCurrency('')).toBe('TRY');\r\n      expect(mapCurrency(undefined)).toBe('TRY');\r\n    });\r\n    \r\n    it('should map demand to offer header', () => {\r\n      const demand = {\r\n        satfk: 'SATFK-20251024-00C9',\r\n        title: 'Test Talep',\r\n        siteName: 'Test ≈ûantiye',\r\n        purchaseLocation: 'ƒ∞stanbul',\r\n        priority: 'price' as Priority,\r\n        dueDate: '2025-12-31',\r\n        currency: 'TRY',\r\n        biddingMode: 'secret' as const,\r\n      };\r\n      \r\n      const header = mapDemandToOfferHeader(demand);\r\n      \r\n      expect(header.satfkCode).toBe('SATFK-20251024-00C9');\r\n      expect(header.title).toBe('Test Talep');\r\n      expect(header.site).toBe('Test ≈ûantiye');\r\n      expect(header.purchaseCity).toBe('ƒ∞stanbul');\r\n      expect(header.priority).toBe('price');\r\n      expect(header.currency).toBe('TRY');\r\n      expect(header.isSealedBid).toBe(true);\r\n    });\r\n    \r\n    it('should map demand items to offer lines', () => {\r\n      const demand = {\r\n        items: [\r\n          {\r\n            name: '√úr√ºn 1',\r\n            qty: 10,\r\n            unit: 'adet',\r\n            unitPrice: 100,\r\n            brand: 'Marka A',\r\n            deliveryDate: '2025-12-31',\r\n          },\r\n          {\r\n            name: '√úr√ºn 2',\r\n            qty: 5,\r\n            unit: 'kg',\r\n            unitPrice: 50,\r\n          },\r\n        ],\r\n      };\r\n      \r\n      const lines = mapDemandItemsToOfferLines(demand);\r\n      \r\n      expect(lines.length).toBe(2);\r\n      expect(lines[0].itemName).toBe('√úr√ºn 1');\r\n      expect(lines[0].quantity).toBe(10);\r\n      expect(lines[0].uom).toBe('adet');\r\n      expect(lines[0].unitPrice).toBe(100);\r\n      expect(lines[0].brand).toBe('Marka A');\r\n      expect(lines[0].demandQuantity).toBe(10);\r\n    });\r\n    \r\n  });\r\n  \r\n  describe('KDV/Net Hesaplamalarƒ±', () => {\r\n    \r\n    it('should calculate net unit with VAT correctly', () => {\r\n      const unitPrice = 100;\r\n      const vatRate = 18;\r\n      const expected = 100 * (1 + 18 / 100); // 118\r\n      \r\n      // Bu fonksiyon OfferTab.tsx'te tanƒ±mlƒ±, burada test ediyoruz\r\n      const calculateNetUnitWithVat = (up: number, vr: number) => up * (1 + vr / 100);\r\n      expect(calculateNetUnitWithVat(unitPrice, vatRate)).toBe(118);\r\n    });\r\n    \r\n    it('should calculate totals correctly', () => {\r\n      const quantity = 10;\r\n      const unitPrice = 100;\r\n      const vatRate = 18;\r\n      \r\n      const netUnitWithVat = unitPrice * (1 + vatRate / 100); // 118\r\n      const totalExVat = quantity * unitPrice; // 1000\r\n      const totalWithVat = quantity * netUnitWithVat; // 1180\r\n      \r\n      expect(totalExVat).toBe(1000);\r\n      expect(totalWithVat).toBe(1180);\r\n    });\r\n    \r\n  });\r\n  \r\n  describe('Termin/Miktar Fark Uyarƒ±larƒ±', () => {\r\n    \r\n    it('should detect quantity difference', () => {\r\n      const demandLine = {\r\n        demandQuantity: 10,\r\n      };\r\n      \r\n      const offerLine = {\r\n        quantity: 12,\r\n        unitPrice: 100,\r\n        vatRate: 18,\r\n        uom: 'adet',\r\n      };\r\n      \r\n      const diff = calculateDifference(demandLine, offerLine as any);\r\n      \r\n      expect(diff.hasDifference).toBe(true);\r\n      expect(diff.quantityDiff).toBe(2);\r\n    });\r\n    \r\n    it('should detect price difference', () => {\r\n      const demandLine = {\r\n        demandUnitPrice: 100,\r\n      };\r\n      \r\n      const offerLine = {\r\n        quantity: 10,\r\n        unitPrice: 120,\r\n        vatRate: 18,\r\n        uom: 'adet',\r\n      };\r\n      \r\n      const diff = calculateDifference(demandLine, offerLine as any);\r\n      \r\n      expect(diff.hasDifference).toBe(true);\r\n      expect(diff.unitPriceDiff).toBe(20);\r\n      expect(diff.pricePercentDiff).toBe(20); // %20 artƒ±≈ü\r\n    });\r\n    \r\n    it('should detect delivery date difference', () => {\r\n      const demandLine = {\r\n        demandDeliveryDate: '2025-12-31',\r\n      };\r\n      \r\n      const offerLine = {\r\n        quantity: 10,\r\n        unitPrice: 100,\r\n        vatRate: 18,\r\n        uom: 'adet',\r\n        deliveryDate: '2026-01-05',\r\n      };\r\n      \r\n      const diff = calculateDifference(demandLine, offerLine as any);\r\n      \r\n      expect(diff.hasDifference).toBe(true);\r\n      expect(diff.deliveryDateDiff).toBeGreaterThan(0);\r\n    });\r\n    \r\n    it('should detect UOM difference', () => {\r\n      const demandLine = {\r\n        demandUom: 'adet',\r\n      };\r\n      \r\n      const offerLine = {\r\n        quantity: 10,\r\n        unitPrice: 100,\r\n        vatRate: 18,\r\n        uom: 'kg',\r\n      };\r\n      \r\n      const diff = calculateDifference(demandLine, offerLine as any);\r\n      \r\n      expect(diff.hasDifference).toBe(true);\r\n      expect(diff.uomDiff).toBe(true);\r\n    });\r\n    \r\n  });\r\n  \r\n  describe('√ñdeme ≈ûartlarƒ±', () => {\r\n    \r\n    it('should format payment terms correctly', () => {\r\n      // OfferTab.tsx'teki formatPaymentTerms fonksiyonunu test ediyoruz\r\n      const formatPaymentTerms = (terms: any): string => {\r\n        if (!terms || !terms.type) return '';\r\n        \r\n        switch (terms.type) {\r\n          case 'pesin_escrow':\r\n            return `Pe≈üin (Escrow${terms.escrowDays ? ` / ${terms.escrowDays} g√ºn` : ''})`;\r\n          case 'pesin_teslim_onay':\r\n            return `Pe≈üin (Teslim&Onay${terms.deliveryConfirmDays ? ` / ${terms.deliveryConfirmDays} g√ºn` : ''})`;\r\n          case 'pesin_on_odeme':\r\n            return `Pe≈üin (√ñn √ñdeme %${terms.advancePercent || 0})`;\r\n          case 'kredi_karti':\r\n            return `Kredi Kartƒ± (${terms.installments || 1} taksit${terms.financeRate ? ` / %${terms.financeRate} faiz` : ''})`;\r\n          case 'acik_hesap':\r\n            return `A√ßƒ±k Hesap (${terms.dueDays || 30} g√ºn)`;\r\n          case 'evrak_cek':\r\n            return `Evrak/√áek (${terms.checkCount || 1} adet)`;\r\n          default:\r\n            return '';\r\n        }\r\n      };\r\n      \r\n      expect(formatPaymentTerms({ type: 'pesin_escrow', escrowDays: 7 })).toBe('Pe≈üin (Escrow / 7 g√ºn)');\r\n      expect(formatPaymentTerms({ type: 'pesin_teslim_onay' })).toBe('Pe≈üin (Teslim&Onay)');\r\n      expect(formatPaymentTerms({ type: 'pesin_on_odeme', advancePercent: 30 })).toBe('Pe≈üin (√ñn √ñdeme %30)');\r\n      expect(formatPaymentTerms({ type: 'kredi_karti', installments: 6, financeRate: 2.5 })).toBe('Kredi Kartƒ± (6 taksit / %2.5 faiz)');\r\n      expect(formatPaymentTerms({ type: 'acik_hesap', dueDays: 45 })).toBe('A√ßƒ±k Hesap (45 g√ºn)');\r\n      expect(formatPaymentTerms({ type: 'evrak_cek', checkCount: 3 })).toBe('Evrak/√áek (3 adet)');\r\n    });\r\n    \r\n  });\r\n  \r\n  describe('Excel Export Form√ºlleri ve Alan Yerle≈üimi', () => {\r\n    \r\n    it('should have correct cell formulas', () => {\r\n      // Excel export'ta kullanƒ±lan form√ºllerin doƒüru olduƒüunu test ediyoruz\r\n      const rowNum = 6;\r\n      \r\n      // P s√ºtunu: KDV Dahil Birim Fiyat = H*(1+N/100)\r\n      const formulaP = `H${rowNum}*(1+N${rowNum}/100)`;\r\n      expect(formulaP).toBe('H6*(1+N6/100)');\r\n      \r\n      // O s√ºtunu: KDV Dahil Toplam = F*P\r\n      const formulaO = `F${rowNum}*P${rowNum}`;\r\n      expect(formulaO).toBe('F6*P6');\r\n      \r\n      // Toplam satƒ±rƒ±: SUM\r\n      const totalRow = 10;\r\n      const formulaK = `SUM(K6:L${totalRow - 1})`;\r\n      expect(formulaK).toBe('SUM(K6:L9)');\r\n    });\r\n    \r\n    it('should have correct header cell addresses', () => {\r\n      // Excel'deki h√ºcre adreslerinin doƒüru olduƒüunu kontrol ediyoruz\r\n      expect('H5').toBe('H5'); // Bƒ∞Rƒ∞M Fƒ∞YAT (KDV Hari√ß)\r\n      expect('K5').toBe('K5'); // KDV HARƒ∞√á TOPLAM TL (ba≈ülangƒ±√ß)\r\n      expect('L5').toBe('L5'); // KDV HARƒ∞√á TOPLAM TL (merge)\r\n      expect('N5').toBe('N5'); // KDV ORANI (%)\r\n      expect('P5').toBe('P5'); // KDV DAHƒ∞L Bƒ∞Rƒ∞M Fƒ∞YAT\r\n      expect('O5').toBe('O5'); // KDV DAHƒ∞L TOPLAM TL\r\n      expect('M5').toBe('M5'); // √ñDEME ≈ûARTLARI\r\n    });\r\n    \r\n  });\r\n  \r\n  describe('Currency Service', () => {\r\n    \r\n    it('should require currency info for non-TRY currencies', () => {\r\n      expect(requiresCurrencyInfo('TRY')).toBe(false);\r\n      expect(requiresCurrencyInfo('USD')).toBe(true);\r\n      expect(requiresCurrencyInfo('EUR')).toBe(true);\r\n      expect(requiresCurrencyInfo('GBP')).toBe(true);\r\n    });\r\n    \r\n    it('should get Turkish currency names', () => {\r\n      expect(getCurrencyNameTR('TRY')).toBe('T√ºrk Lirasƒ±');\r\n      expect(getCurrencyNameTR('USD')).toBe('Amerikan Dolarƒ±');\r\n      expect(getCurrencyNameTR('EUR')).toBe('Euro');\r\n      expect(getCurrencyNameTR('GBP')).toBe('ƒ∞ngiliz Sterlini');\r\n    });\r\n    \r\n  });\r\n  \r\n  describe('Offer Schema Validation', () => {\r\n    \r\n    it('should validate correct offer', () => {\r\n      const validOffer: Offer = {\r\n        header: {\r\n          satfkCode: 'SATFK-20251024-00C9',\r\n          title: 'Test Talep',\r\n          currency: 'TRY',\r\n        },\r\n        lines: [\r\n          {\r\n            itemName: '√úr√ºn 1',\r\n            uom: 'adet',\r\n            quantity: 10,\r\n            unitPrice: 100,\r\n            vatRate: 18,\r\n          },\r\n        ],\r\n        attachments: [],\r\n        status: 'draft',\r\n      };\r\n      \r\n      const result = OfferSchema.safeParse(validOffer);\r\n      expect(result.success).toBe(true);\r\n    });\r\n    \r\n    it('should reject offer without satfkCode', () => {\r\n      const invalidOffer = {\r\n        header: {\r\n          title: 'Test',\r\n          currency: 'TRY',\r\n        },\r\n        lines: [\r\n          {\r\n            itemName: '√úr√ºn 1',\r\n            uom: 'adet',\r\n            quantity: 10,\r\n            unitPrice: 100,\r\n          },\r\n        ],\r\n      };\r\n      \r\n      const result = OfferSchema.safeParse(invalidOffer);\r\n      expect(result.success).toBe(false);\r\n    });\r\n    \r\n    it('should reject offer without lines', () => {\r\n      const invalidOffer = {\r\n        header: {\r\n          satfkCode: 'SATFK-20251024-00C9',\r\n          title: 'Test',\r\n          currency: 'TRY',\r\n        },\r\n        lines: [],\r\n      };\r\n      \r\n      const result = OfferSchema.safeParse(invalidOffer);\r\n      expect(result.success).toBe(false);\r\n    });\r\n    \r\n  });\r\n  \r\n});\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\categories\\category-service.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":67,"column":20,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":67,"endColumn":33},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":68,"column":22,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":68,"endColumn":37},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":72,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":72,"endColumn":17}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Category Service - ID-based category management\r\n * CRITICAL: E≈üle≈üme sadece ID √ºzerinden yapƒ±lƒ±r. Name/slug sadece UI/arama i√ßin kullanƒ±lƒ±r.\r\n */\r\n\r\n// Teklifbul Rule v1.0 - Structured Logging\r\nimport { logger } from '../shared/log/logger.js';\r\n\r\n// Import slugifyTr with absolute path from root\r\nimport { slugifyTr } from '/utils/slugify-tr.js';\r\n\r\n// Hardcoded categories (fallback - always available)\r\nconst FALLBACK_CATEGORIES = [\r\n  {\"id\":\"CAT.SACMETAL\",\"slug\":\"sac-metal\",\"name\":\"Sac/Metal\",\"group\":\"End√ºstriyel\",\"synonyms\":[\"sac\",\"metal\",\"√ßelik i≈üleme\"],\"isActive\":true},\r\n  {\"id\":\"CAT.ELEKTRIK\",\"slug\":\"elektrik\",\"name\":\"Elektrik\",\"group\":\"Elektrik-ELK\",\"synonyms\":[\"elektrik malzemeleri\"],\"isActive\":true},\r\n  {\"id\":\"CAT.ELEKTRONIK\",\"slug\":\"elektronik\",\"name\":\"Elektronik\",\"group\":\"Elektrik-ELK\",\"synonyms\":[\"plc\",\"sensor\"],\"isActive\":true},\r\n  {\"id\":\"CAT.MAKINEIMALAT\",\"slug\":\"makine-imalat\",\"name\":\"Makine-ƒ∞malat\",\"group\":\"End√ºstriyel\",\"synonyms\":[\"imalat\",\"cnc\"],\"isActive\":true},\r\n  {\"id\":\"CAT.HIRDAVAT\",\"slug\":\"hirdavat\",\"name\":\"Hƒ±rdavat\",\"group\":\"End√ºstriyel\",\"synonyms\":[\"vida\",\"somun\"],\"isActive\":true},\r\n  {\"id\":\"CAT.AMBALAJ\",\"slug\":\"ambalaj\",\"name\":\"Ambalaj\",\"group\":\"Genel\",\"synonyms\":[\"koli\",\"stre√ß\"],\"isActive\":true},\r\n  {\"id\":\"CAT.KIMYASAL\",\"slug\":\"kimyasal\",\"name\":\"Kimyasal\",\"group\":\"End√ºstriyel\",\"synonyms\":[\"solvent\"],\"isActive\":true},\r\n  {\"id\":\"CAT.INSAAT\",\"slug\":\"insaat-malzemeleri\",\"name\":\"ƒ∞n≈üaat Malzemeleri\",\"group\":\"ƒ∞n≈üaat\",\"synonyms\":[\"yapƒ±\"],\"isActive\":true},\r\n  {\"id\":\"CAT.MOBILYA\",\"slug\":\"mobilya\",\"name\":\"Mobilya\",\"group\":\"Genel\",\"synonyms\":[\"ofis mobilyasƒ±\"],\"isActive\":true},\r\n  {\"id\":\"CAT.BOYA\",\"slug\":\"boya\",\"name\":\"Boya\",\"group\":\"End√ºstriyel\",\"synonyms\":[\"end√ºstriyel boya\"],\"isActive\":true},\r\n  {\"id\":\"CAT.PLASTIK\",\"slug\":\"plastik\",\"name\":\"Plastik\",\"group\":\"End√ºstriyel\",\"synonyms\":[\"plastik hammadde\"],\"isActive\":true},\r\n  {\"id\":\"CAT.OTOMOTIVYS\",\"slug\":\"otomotiv-yan-sanayi\",\"name\":\"Otomotiv Yan Sanayi\",\"group\":\"End√ºstriyel\",\"synonyms\":[\"otomotiv par√ßa\"],\"isActive\":true},\r\n  {\"id\":\"CAT.ISG\",\"slug\":\"is-guvenligi\",\"name\":\"ƒ∞≈ü G√ºvenliƒüi\",\"group\":\"ƒ∞SG\",\"synonyms\":[\"kkd\",\"baret\"],\"isActive\":true},\r\n  {\"id\":\"CAT.TEMIZLIK\",\"slug\":\"temizlik\",\"name\":\"Temizlik\",\"group\":\"Genel\",\"synonyms\":[\"temizlik ekipmanƒ±\"],\"isActive\":true},\r\n  {\"id\":\"CAT.GIDA\",\"slug\":\"gida\",\"name\":\"Gƒ±da\",\"group\":\"Genel\",\"synonyms\":[\"ikram\"],\"isActive\":true},\r\n  {\"id\":\"CAT.HIZMET\",\"slug\":\"hizmet\",\"name\":\"Hizmet\",\"group\":\"Hizmet\",\"synonyms\":[\"bakƒ±m\",\"i≈ü√ßilik\"],\"isActive\":true},\r\n  {\"id\":\"CAT.LOJISTIK\",\"slug\":\"lojistik\",\"name\":\"Lojistik\",\"group\":\"Hizmet\",\"synonyms\":[\"nakliye\"],\"isActive\":true},\r\n  {\"id\":\"CAT.AYDINLATMA\",\"slug\":\"aydinlatma\",\"name\":\"Aydƒ±nlatma\",\"group\":\"Elektrik-ELK\",\"synonyms\":[\"armatur\",\"projektor\"],\"isActive\":true},\r\n  {\"id\":\"CAT.AGMG\",\"slug\":\"alcak-orta-gerilim\",\"name\":\"Al√ßak/Orta Gerilim\",\"group\":\"Elektrik-ELK\",\"synonyms\":[\"pano\",\"≈üalt\",\"trafo\"],\"isActive\":true},\r\n  {\"id\":\"CAT.OTOMASYON\",\"slug\":\"otomasyon-plc-scada\",\"name\":\"Otomasyon (PLC/SCADA)\",\"group\":\"Elektrik-ELK\",\"synonyms\":[\"plc\",\"hmi\",\"s√ºr√ºc√º\"],\"isActive\":true},\r\n  {\"id\":\"CAT.KAYNAK\",\"slug\":\"kaynak-sarf\",\"name\":\"Kaynak & Sarf\",\"group\":\"End√ºstriyel\",\"synonyms\":[\"mig\",\"tig\",\"kaynak teli\"],\"isActive\":true},\r\n  {\"id\":\"CAT.RULMAN\",\"slug\":\"rulman-guc-aktarim\",\"name\":\"Rulman & G√º√ß Aktarƒ±m\",\"group\":\"End√ºstriyel\",\"synonyms\":[\"kayƒ±≈ü\",\"kaplin\",\"red√ºkt√∂r\"],\"isActive\":true},\r\n  {\"id\":\"CAT.HVAC\",\"slug\":\"iklimlendirme-havalandirma\",\"name\":\"HVAC\",\"group\":\"MEP\",\"synonyms\":[\"vrf\",\"kanal\",\"fan\"],\"isActive\":true},\r\n  {\"id\":\"CAT.YANGIN\",\"slug\":\"yangin-guvenligi\",\"name\":\"Yangƒ±n G√ºvenliƒüi\",\"group\":\"MEP\",\"synonyms\":[\"sprinkler\",\"algƒ±lama\"],\"isActive\":true},\r\n  {\"id\":\"CAT.KIRALAMA\",\"slug\":\"ekipman-kiralama\",\"name\":\"Ekipman Kiralama\",\"group\":\"Hizmet\",\"synonyms\":[\"forklift\",\"vin√ß\"],\"isActive\":true}\r\n];\r\n\r\n// Dictionary data - try to load from JSON, fallback to hardcoded\r\nlet dictionaryData = null;\r\n\r\n// Initialize dictionaryData with fallback (simplified for Vite compatibility)\r\n// Technifire Rule v1.0: Using hardcoded fallback to avoid async issues\r\ndictionaryData = FALLBACK_CATEGORIES;\r\n\r\n// Cache dictionary\r\nlet categoryDictionary = null;\r\nlet categoryMapById = null;\r\nlet categoryMapBySlug = null;\r\nlet categoryMapByName = null;\r\n\r\n/**\r\n * Load and cache category dictionary\r\n */\r\nexport function loadDictionary() {\r\n  if (categoryDictionary) {\r\n    return categoryDictionary;\r\n  }\r\n\r\n  // Ensure dictionaryData is loaded\r\n  if (!dictionaryData) {\r\n    // Try synchronous load first (for Node.js)\r\n    if (typeof require !== 'undefined' && typeof process !== 'undefined') {\r\n      try {\r\n        const fs = require('fs');\r\n        const path = require('path');\r\n        const dictPath = path.join(__dirname, 'CATEGORY_DICTIONARY.json');\r\n        const data = fs.readFileSync(dictPath, 'utf8');\r\n        dictionaryData = JSON.parse(data);\r\n      } catch (e) {\r\n        dictionaryData = FALLBACK_CATEGORIES;\r\n      }\r\n    } else {\r\n      // Browser: use fallback (will be async loaded later if needed)\r\n      dictionaryData = FALLBACK_CATEGORIES;\r\n    }\r\n  }\r\n\r\n  categoryDictionary = dictionaryData.filter(cat => cat.isActive !== false);\r\n  \r\n  // Build lookup maps\r\n  categoryMapById = new Map();\r\n  categoryMapBySlug = new Map();\r\n  categoryMapByName = new Map();\r\n  \r\n  categoryDictionary.forEach(cat => {\r\n    categoryMapById.set(cat.id, cat);\r\n    categoryMapBySlug.set(cat.slug, cat);\r\n    categoryMapByName.set(cat.name.toLowerCase(), cat);\r\n    \r\n    // Also map normalized names\r\n    const normalizedName = cat.name.toLowerCase().trim();\r\n    categoryMapByName.set(normalizedName, cat);\r\n  });\r\n  \r\n  return categoryDictionary;\r\n}\r\n\r\n/**\r\n * Get category by ID\r\n */\r\nexport function getById(id) {\r\n  if (!categoryMapById) loadDictionary();\r\n  return categoryMapById.get(id) || null;\r\n}\r\n\r\n/**\r\n * Get category ID by name (case-insensitive)\r\n */\r\nexport function getIdByName(name) {\r\n  if (!name) return null;\r\n  if (!categoryMapByName) loadDictionary();\r\n  const cat = categoryMapByName.get(name.toLowerCase().trim());\r\n  return cat ? cat.id : null;\r\n}\r\n\r\n/**\r\n * Get category ID by slug\r\n */\r\nexport function getIdBySlug(slug) {\r\n  if (!slug) return null;\r\n  if (!categoryMapBySlug) loadDictionary();\r\n  const cat = categoryMapBySlug.get(slug);\r\n  return cat ? cat.id : null;\r\n}\r\n\r\n/**\r\n * Get category name by ID (for UI display)\r\n */\r\nexport function getNameById(id) {\r\n  const cat = getById(id);\r\n  return cat ? cat.name : id;\r\n}\r\n\r\n/**\r\n * Get category slug by ID (for URL/search)\r\n */\r\nexport function getSlugById(id) {\r\n  const cat = getById(id);\r\n  return cat ? cat.slug : null;\r\n}\r\n\r\n/**\r\n * Search categories by text (name + synonyms)\r\n * Returns array of category IDs\r\n */\r\nexport function search(text) {\r\n  if (!text || typeof text !== 'string') return [];\r\n  if (!categoryDictionary) loadDictionary();\r\n  \r\n  const searchLower = text.toLowerCase().trim();\r\n  const results = new Set();\r\n  \r\n  categoryDictionary.forEach(cat => {\r\n    // Match name\r\n    if (cat.name.toLowerCase().includes(searchLower)) {\r\n      results.add(cat.id);\r\n      return;\r\n    }\r\n    \r\n    // Match slug\r\n    if (cat.slug.includes(searchLower)) {\r\n      results.add(cat.id);\r\n      return;\r\n    }\r\n    \r\n    // Match synonyms\r\n    if (cat.synonyms && Array.isArray(cat.synonyms)) {\r\n      for (const synonym of cat.synonyms) {\r\n        if (synonym.toLowerCase().includes(searchLower)) {\r\n          results.add(cat.id);\r\n          return;\r\n        }\r\n      }\r\n    }\r\n  });\r\n  \r\n  return Array.from(results);\r\n}\r\n\r\n/**\r\n * CRITICAL: Normalize input tokens to category IDs\r\n * This is the core function for converting any format (ID/name/slug) to IDs\r\n * \r\n * @param {string[]} inputTokens - Array of category IDs, names, or slugs\r\n * @returns {string[]} Array of valid category IDs\r\n */\r\nexport function normalizeToIds(inputTokens) {\r\n  if (!Array.isArray(inputTokens)) {\r\n    logger.warn('normalizeToIds: inputTokens must be an array', inputTokens);\r\n    return [];\r\n  }\r\n  \r\n  if (!categoryDictionary) loadDictionary();\r\n  \r\n  // Legacy incorrect slug map (for fixing old data)\r\n  const incorrectSlugMap = {\r\n    'gda': 'CAT.GIDA',\r\n    'hrdavat': 'CAT.HIRDAVAT',\r\n    'inaat-malzemeleri': 'CAT.INSAAT',\r\n    'i-gvenlii': 'CAT.ISG',\r\n    'sacmetal': 'CAT.SACMETAL',\r\n    'makine-imalat': 'CAT.MAKINEIMALAT',\r\n    'insaat-malzemeleri': 'CAT.INSAAT',\r\n    'is-guvenligi': 'CAT.ISG',\r\n    'otomotiv-yan-sanayi': 'CAT.OTOMOTIVYS',\r\n    // CRITICAL: Fix incorrect Turkish character normalization in category groups\r\n    'aydnlatma': 'CAT.AYDINLATMA',           // ƒ± eksik -> aydinlatma\r\n    'alakorta-gerilim': 'CAT.AGMG',          // √ß eksik -> alcak-orta-gerilim\r\n    'otomasyon-plcscada': 'CAT.OTOMASYON',   // tire eksik -> otomasyon-plc-scada\r\n    'rulman-g-aktarm': 'CAT.RULMAN',         // √º ve u eksik -> rulman-guc-aktarim\r\n    'yangn-gvenlii': 'CAT.YANGIN',           // i ve √º eksik -> yangin-guvenligi\r\n    'cat_sac_metal': 'CAT.SACMETAL',\r\n    'cat_elektrik': 'CAT.ELEKTRIK',\r\n    'cat_elektronik': 'CAT.ELEKTRONIK',\r\n    'cat_makine_imalat': 'CAT.MAKINEIMALAT',\r\n    'cat_hirdavat': 'CAT.HIRDAVAT',\r\n    'cat_ambalaj': 'CAT.AMBALAJ',\r\n    'cat_kimyasal': 'CAT.KIMYASAL',\r\n    'cat_insaat_malzemeleri': 'CAT.INSAAT',\r\n    'cat_mobilya': 'CAT.MOBILYA',\r\n    'cat_boya': 'CAT.BOYA',\r\n    'cat_plastik': 'CAT.PLASTIK',\r\n    'cat_otomotiv_yan_sanayi': 'CAT.OTOMOTIVYS',\r\n    'cat_is_guvenligi': 'CAT.ISG',\r\n    'cat_temizlik': 'CAT.TEMIZLIK',\r\n    'cat_gida': 'CAT.GIDA',\r\n    'cat_hizmet': 'CAT.HIZMET',\r\n    'cat_lojistik': 'CAT.LOJISTIK'\r\n  };\r\n  \r\n  const resultIds = new Set();\r\n  \r\n  for (const token of inputTokens) {\r\n    if (!token || typeof token !== 'string') continue;\r\n    \r\n    const tokenTrimmed = token.trim();\r\n    if (!tokenTrimmed) continue;\r\n    \r\n    // 1. Direct ID check (if it starts with CAT.)\r\n    if (tokenTrimmed.startsWith('CAT.')) {\r\n      const cat = getById(tokenTrimmed);\r\n      if (cat) {\r\n        resultIds.add(cat.id);\r\n        continue;\r\n      }\r\n    }\r\n    \r\n    // 2. Check old ID format (cat_xxx)\r\n    if (tokenTrimmed.startsWith('cat_')) {\r\n      const mappedId = incorrectSlugMap[tokenTrimmed];\r\n      if (mappedId) {\r\n        resultIds.add(mappedId);\r\n        continue;\r\n      }\r\n    }\r\n    \r\n    // 3. Try name lookup (case-insensitive)\r\n    const idByName = getIdByName(tokenTrimmed);\r\n    if (idByName) {\r\n      resultIds.add(idByName);\r\n      continue;\r\n    }\r\n    \r\n    // 4. Try slug lookup\r\n    const idBySlug = getIdBySlug(tokenTrimmed);\r\n    if (idBySlug) {\r\n      resultIds.add(idBySlug);\r\n      continue;\r\n    }\r\n    \r\n    // 5. Try legacy incorrect slug map\r\n    const mappedId = incorrectSlugMap[tokenTrimmed.toLowerCase()];\r\n    if (mappedId) {\r\n      resultIds.add(mappedId);\r\n      continue;\r\n    }\r\n    \r\n    // 6. Try normalized slug (slugify input and match)\r\n    const normalizedSlug = slugifyTr(tokenTrimmed);\r\n    if (normalizedSlug) {\r\n      const idByNormalizedSlug = getIdBySlug(normalizedSlug);\r\n      if (idByNormalizedSlug) {\r\n        resultIds.add(idByNormalizedSlug);\r\n        continue;\r\n      }\r\n    }\r\n    \r\n    // 7. Not found - warn but don't fail\r\n    logger.warn('Unknown category token', { token: tokenTrimmed });\r\n  }\r\n  \r\n  return Array.from(resultIds);\r\n}\r\n\r\n/**\r\n * Get all active categories\r\n */\r\nexport function getAllCategories() {\r\n  if (!categoryDictionary) loadDictionary();\r\n  return [...categoryDictionary];\r\n}\r\n\r\n/**\r\n * Get all category IDs\r\n */\r\nexport function getAllIds() {\r\n  if (!categoryDictionary) loadDictionary();\r\n  return categoryDictionary.map(cat => cat.id);\r\n}\r\n\r\n/**\r\n * Get categories by group\r\n */\r\nexport function getByGroup(group) {\r\n  if (!categoryDictionary) loadDictionary();\r\n  return categoryDictionary.filter(cat => cat.group === group);\r\n}\r\n\r\n/**\r\n * Get all unique groups\r\n */\r\nexport function getAllGroups() {\r\n  if (!categoryDictionary) loadDictionary();\r\n  const groups = new Set(categoryDictionary.map(cat => cat.group));\r\n  return Array.from(groups);\r\n}\r\n\r\n/**\r\n * Create new category (with auto-generated ID)\r\n * Note: In a production system, this would also save to Firestore or update JSON file\r\n * \r\n * @param {object} params - {name, group, synonyms?, slug?}\r\n * @returns {object} Created category with ID\r\n */\r\nexport function createCategory({ name, group, synonyms = [], slug = null }) {\r\n  if (!name || !group) {\r\n    throw new Error('name and group are required');\r\n  }\r\n  \r\n  // Generate ID: CAT. + 6-digit sequential number\r\n  // In production, get next sequence from Firestore or persistent storage\r\n  const existingIds = getAllIds();\r\n  const maxNum = existingIds.reduce((max, id) => {\r\n    const match = id.match(/^CAT\\.(\\d+)$/);\r\n    if (match) {\r\n      const num = parseInt(match[1], 10);\r\n      return num > max ? num : max;\r\n    }\r\n    return max;\r\n  }, 0);\r\n  \r\n  const nextNum = maxNum + 1;\r\n  const newId = `CAT.${String(nextNum).padStart(6, '0')}`;\r\n  \r\n  // Generate slug if not provided\r\n  const categorySlug = slug || slugifyTr(name);\r\n  \r\n  const newCategory = {\r\n    id: newId,\r\n    slug: categorySlug,\r\n    name: name,\r\n    group: group,\r\n    synonyms: Array.isArray(synonyms) ? synonyms : [],\r\n    isActive: true\r\n  };\r\n  \r\n  // In production: Save to Firestore or update JSON file\r\n  // For now, just add to cache (will be lost on reload)\r\n  if (categoryDictionary) {\r\n    categoryDictionary.push(newCategory);\r\n    categoryMapById.set(newId, newCategory);\r\n    categoryMapBySlug.set(categorySlug, newCategory);\r\n    categoryMapByName.set(name.toLowerCase(), newCategory);\r\n  }\r\n  \r\n  logger.info('Created new category', { id: newId, name });\r\n  \r\n  return newCategory;\r\n}\r\n\r\n// Initialize on module load\r\nloadDictionary();\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\common-company.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'db' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'doc' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":6},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getDoc' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// public/common-company.js\r\nimport { db, auth } from \"../firebase.js\";\r\nimport { \r\n  doc, getDoc \r\n} from \"https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js\";\r\nimport { signOut } from \"https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js\";\r\n\r\nexport async function setupHeader() {\r\n  // Setup universal logout buttons\r\n  function wireLogoutButtons() {\r\n    document.querySelectorAll(\".btn-logout, .logout-btn, #logoutBtn\").forEach(btn => {\r\n      btn.addEventListener(\"click\", async () => {\r\n        try {\r\n          await signOut(auth);\r\n          window.location.href = \"./index.html\";\r\n        } catch (e) {\r\n          alert(\"√áƒ±kƒ±≈ü yapƒ±lamadƒ±: \" + (e?.message || e));\r\n        }\r\n      });\r\n    });\r\n  }\r\n  \r\n  // Wire logout buttons when DOM is loaded\r\n  if (document.readyState === \"loading\") {\r\n    document.addEventListener(\"DOMContentLoaded\", wireLogoutButtons);\r\n  } else {\r\n    wireLogoutButtons();\r\n  }\r\n\r\n  // Firma adƒ± g√∂sterimi kaldƒ±rƒ±ldƒ± - sistemde hata olduƒüu i√ßin\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\components\\Map.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":223,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":223,"endColumn":24}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * OpenStreetMap Component (Leaflet.js)\r\n * Teklifbul Rule v1.0\r\n * \r\n * Google Maps alternatifi - $0 maliyet, sƒ±nƒ±rsƒ±z kullanƒ±m\r\n */\r\n\r\nimport { useEffect, useRef, useState } from 'react';\r\nimport L from 'leaflet';\r\nimport 'leaflet/dist/leaflet.css';\r\n\r\n// Leaflet default icon sorunu i√ßin fix\r\nimport icon from 'leaflet/dist/images/marker-icon.png';\r\nimport iconShadow from 'leaflet/dist/images/marker-shadow.png';\r\n\r\nconst DefaultIcon = L.icon({\r\n  iconUrl: icon,\r\n  shadowUrl: iconShadow,\r\n  iconSize: [25, 41],\r\n  iconAnchor: [12, 41],\r\n  popupAnchor: [1, -34],\r\n  shadowSize: [41, 41]\r\n});\r\n\r\nL.Marker.prototype.options.icon = DefaultIcon;\r\n\r\ninterface MapProps {\r\n  address: string;\r\n  lat?: number;\r\n  lng?: number;\r\n  height?: string;\r\n  zoom?: number;\r\n  showMarker?: boolean;\r\n  className?: string;\r\n}\r\n\r\ninterface GeocodeResult {\r\n  lat: string;\r\n  lon: string;\r\n  display_name: string;\r\n}\r\n\r\n/**\r\n * Nominatim Geocoding API (OpenStreetMap)\r\n * Rate limit: 1 request/second\r\n */\r\nasync function geocodeAddress(address: string): Promise<GeocodeResult | null> {\r\n  try {\r\n    // Cache kontrol√º\r\n    const cacheKey = `geocode:${encodeURIComponent(address)}`;\r\n    const cached = sessionStorage.getItem(cacheKey);\r\n    if (cached) {\r\n      return JSON.parse(cached);\r\n    }\r\n    \r\n    // Nominatim API √ßaƒürƒ±sƒ±\r\n    const response = await fetch(\r\n      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`,\r\n      {\r\n        headers: {\r\n          'User-Agent': 'Teklifbul/1.0' // Nominatim policy gereƒüi\r\n        }\r\n      }\r\n    );\r\n    \r\n    if (!response.ok) {\r\n      throw new Error(`Geocoding failed: ${response.statusText}`);\r\n    }\r\n    \r\n    const data = await response.json();\r\n    \r\n    if (data.length === 0) {\r\n      return null;\r\n    }\r\n    \r\n    const result: GeocodeResult = {\r\n      lat: data[0].lat,\r\n      lon: data[0].lon,\r\n      display_name: data[0].display_name\r\n    };\r\n    \r\n    // Cache'e kaydet (session storage - sayfa kapanana kadar)\r\n    sessionStorage.setItem(cacheKey, JSON.stringify(result));\r\n    \r\n    // Rate limiting i√ßin bekle (1 saniye)\r\n    await new Promise(resolve => setTimeout(resolve, 1000));\r\n    \r\n    return result;\r\n  } catch (error) {\r\n    console.error('‚ùå Geocoding error:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport function Map({ \r\n  address, \r\n  lat, \r\n  lng, \r\n  height = '400px', \r\n  zoom = 13,\r\n  showMarker = true,\r\n  className = ''\r\n}: MapProps) {\r\n  const mapRef = useRef<HTMLDivElement>(null);\r\n  const mapInstanceRef = useRef<L.Map | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  \r\n  useEffect(() => {\r\n    if (!mapRef.current) return;\r\n    \r\n    // Harita olu≈ütur\r\n    const map = L.map(mapRef.current, {\r\n      zoomControl: true,\r\n      attributionControl: true\r\n    });\r\n    \r\n    // OpenStreetMap tile layer\r\n    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\r\n      attribution: '¬© <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors',\r\n      maxZoom: 19,\r\n      tileSize: 256\r\n    }).addTo(map);\r\n    \r\n    mapInstanceRef.current = map;\r\n    \r\n    // Koordinat varsa direkt g√∂ster\r\n    if (lat && lng) {\r\n      map.setView([lat, lng], zoom);\r\n      \r\n      if (showMarker) {\r\n        L.marker([lat, lng])\r\n          .addTo(map)\r\n          .bindPopup(address)\r\n          .openPopup();\r\n      }\r\n      \r\n      setLoading(false);\r\n    } else if (address) {\r\n      // Geocoding yap\r\n      setLoading(true);\r\n      geocodeAddress(address)\r\n        .then(result => {\r\n          if (result) {\r\n            const latNum = parseFloat(result.lat);\r\n            const lngNum = parseFloat(result.lon);\r\n            \r\n            map.setView([latNum, lngNum], zoom);\r\n            \r\n            if (showMarker) {\r\n              L.marker([latNum, lngNum])\r\n                .addTo(map)\r\n                .bindPopup(`<strong>${address}</strong><br>${result.display_name}`)\r\n                .openPopup();\r\n            }\r\n            \r\n            setLoading(false);\r\n          } else {\r\n            // Default: ƒ∞stanbul\r\n            map.setView([41.0082, 28.9784], 10);\r\n            setError('Adres bulunamadƒ±');\r\n            setLoading(false);\r\n          }\r\n        })\r\n        .catch(err => {\r\n          console.error('Geocoding error:', err);\r\n          // Default: ƒ∞stanbul\r\n          map.setView([41.0082, 28.9784], 10);\r\n          setError('Harita y√ºklenemedi');\r\n          setLoading(false);\r\n        });\r\n    } else {\r\n      // Default: ƒ∞stanbul\r\n      map.setView([41.0082, 28.9784], 10);\r\n      setLoading(false);\r\n    }\r\n    \r\n    return () => {\r\n      map.remove();\r\n    };\r\n  }, [address, lat, lng, zoom, showMarker]);\r\n  \r\n  return (\r\n    <div className={`map-container ${className}`} style={{ position: 'relative', width: '100%', height }}>\r\n      {loading && (\r\n        <div style={{\r\n          position: 'absolute',\r\n          top: '50%',\r\n          left: '50%',\r\n          transform: 'translate(-50%, -50%)',\r\n          zIndex: 1000,\r\n          background: 'white',\r\n          padding: '10px 20px',\r\n          borderRadius: '4px',\r\n          boxShadow: '0 2px 4px rgba(0,0,0,0.2)'\r\n        }}>\r\n          Harita y√ºkleniyor...\r\n        </div>\r\n      )}\r\n      {error && (\r\n        <div style={{\r\n          position: 'absolute',\r\n          top: '10px',\r\n          left: '10px',\r\n          zIndex: 1000,\r\n          background: '#fee',\r\n          color: '#c33',\r\n          padding: '8px 16px',\r\n          borderRadius: '4px',\r\n          fontSize: '14px'\r\n        }}>\r\n          ‚ö†Ô∏è {error}\r\n        </div>\r\n      )}\r\n      <div ref={mapRef} style={{ width: '100%', height: '100%', zIndex: 1 }} />\r\n    </div>\r\n  );\r\n}\r\n\r\n/**\r\n * Standalone HTML/JS kullanƒ±mƒ± i√ßin\r\n */\r\nexport function initMap(elementId: string, address: string, lat?: number, lng?: number) {\r\n  const mapElement = document.getElementById(elementId);\r\n  if (!mapElement) {\r\n    console.error(`Map element not found: ${elementId}`);\r\n    return;\r\n  }\r\n  \r\n  const map = L.map(elementId);\r\n  \r\n  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\r\n    attribution: '¬© OpenStreetMap contributors',\r\n    maxZoom: 19\r\n  }).addTo(map);\r\n  \r\n  if (lat && lng) {\r\n    map.setView([lat, lng], 13);\r\n    L.marker([lat, lng])\r\n      .addTo(map)\r\n      .bindPopup(address)\r\n      .openPopup();\r\n  } else if (address) {\r\n    geocodeAddress(address).then(result => {\r\n      if (result) {\r\n        const latNum = parseFloat(result.lat);\r\n        const lngNum = parseFloat(result.lon);\r\n        map.setView([latNum, lngNum], 13);\r\n        L.marker([latNum, lngNum])\r\n          .addTo(map)\r\n          .bindPopup(`<strong>${address}</strong><br>${result.display_name}`)\r\n          .openPopup();\r\n      }\r\n    });\r\n  }\r\n  \r\n  return map;\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\components\\ProtectedRoute.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\components\\PublicRoute.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\context\\AuthContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":32,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":32,"endColumn":24}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createContext, useContext, useEffect, useState, ReactNode } from 'react';\r\nimport { User, onAuthStateChanged } from 'firebase/auth';\r\nimport { auth } from '../lib/firebase';\r\n\r\ninterface AuthContextType {\r\n  user: User | null;\r\n  loading: boolean;\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\r\n\r\nexport function AuthProvider({ children }: { children: ReactNode }) {\r\n  const [user, setUser] = useState<User | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  useEffect(() => {\r\n    const unsubscribe = onAuthStateChanged(auth, (user) => {\r\n      setUser(user);\r\n      setLoading(false);\r\n    });\r\n\r\n    return unsubscribe;\r\n  }, []);\r\n\r\n  return (\r\n    <AuthContext.Provider value={{ user, loading }}>\r\n      {children}\r\n    </AuthContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useAuth() {\r\n  const context = useContext(AuthContext);\r\n  if (context === undefined) {\r\n    throw new Error('useAuth must be used within an AuthProvider');\r\n  }\r\n  return context;\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\db\\connection.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":50,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1560,1563],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1560,1563],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * PostgreSQL Connection Pool\r\n * Teklifbul Rule v1.0\r\n */\r\n\r\nimport pkg from 'pg';\r\nconst { Pool } = pkg;\r\nimport type { Pool as PGPool, PoolConfig } from 'pg';\r\nimport Redis from 'ioredis';\r\n\r\nlet pgPool: PGPool | null = null;\r\nlet redisClient: Redis | null = null;\r\n\r\n// PostgreSQL connection config\r\nfunction createPgPool(): PGPool {\r\n  const config: PoolConfig = {\r\n    host: process.env.POSTGRES_HOST || 'localhost',\r\n    port: Number(process.env.POSTGRES_PORT) || 5432,\r\n    database: process.env.POSTGRES_DB || 'teklifbul',\r\n    user: process.env.POSTGRES_USER || 'postgres',\r\n    password: process.env.POSTGRES_PASSWORD || '',\r\n    max: 20, // Connection pool size\r\n    idleTimeoutMillis: 30000,\r\n    connectionTimeoutMillis: 2000,\r\n  };\r\n\r\n  return new Pool(config);\r\n}\r\n\r\n// Redis connection\r\nfunction createRedisClient(): Redis {\r\n  // REDIS_URL varsa onu kullan, yoksa host/port/password kombinasyonu\r\n  const redisUrl = process.env.REDIS_URL || process.env.REDIS_HOST\r\n    ? `redis://${process.env.REDIS_PASSWORD ? `:${process.env.REDIS_PASSWORD}@` : ''}${process.env.REDIS_HOST || 'localhost'}:${process.env.REDIS_PORT || 6379}`\r\n    : 'redis://127.0.0.1:6379';\r\n  \r\n  return new Redis(redisUrl, {\r\n    maxRetriesPerRequest: 3,\r\n    retryStrategy: (times) => Math.min(times * 200, 2000),\r\n    lazyConnect: true, // Otomatik baƒülanma, manuel ping() ile test edelim\r\n  });\r\n}\r\n\r\nexport function getPgPool(): PGPool {\r\n  if (!pgPool) {\r\n    const pool = createPgPool();\r\n    pgPool = pool;\r\n\r\n    // Error handling\r\n    pool.on('error', (err: any) => {\r\n      console.error('Unexpected PostgreSQL pool error:', err);\r\n    });\r\n  }\r\n  // pgPool is guaranteed to be set here\r\n  return pgPool as PGPool;\r\n}\r\n\r\nexport function getRedisClient(): Redis | null {\r\n  // Cache disabled kontrol√º\r\n  if (process.env.CACHE_DISABLED === '1') {\r\n    return null;\r\n  }\r\n  \r\n  if (!redisClient) {\r\n    redisClient = createRedisClient();\r\n    \r\n    redisClient.on('error', (err) => {\r\n      // Geli≈ütirme modunda sadece uyarƒ± ver, uygulamayƒ± durdurma\r\n      if (process.env.NODE_ENV !== 'production') {\r\n        console.warn('‚ö†Ô∏è  Redis client error (cache disabled):', err.message);\r\n      } else {\r\n        console.error('Redis client error:', err);\r\n      }\r\n    });\r\n    \r\n    redisClient.on('connect', () => {\r\n      console.info('‚úÖ Redis connected');\r\n    });\r\n  }\r\n  return redisClient;\r\n}\r\n\r\n// Graceful shutdown\r\nexport async function closeConnections(): Promise<void> {\r\n  if (pgPool) {\r\n    await pgPool.end();\r\n    pgPool = null;\r\n  }\r\n  if (redisClient) {\r\n    redisClient.disconnect();\r\n    redisClient = null;\r\n  }\r\n}\r\n\r\n// Test connection\r\nexport async function testConnection(): Promise<boolean> {\r\n  try {\r\n    const pool = getPgPool();\r\n    await pool.query('SELECT 1');\r\n    return true;\r\n  } catch (e) {\r\n    console.error('PostgreSQL connection test failed:', e);\r\n    return false;\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\db\\migrations\\run-migrations.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[571,574],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[571,574],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Migration Runner\r\n * Teklifbul Rule v1.0\r\n * \r\n * Usage: tsx src/db/migrations/run-migrations.ts [migration-file]\r\n */\r\n\r\nimport 'dotenv/config';\r\nimport { readFileSync } from 'fs';\r\nimport { join } from 'path';\r\nimport { getPgPool } from '../connection';\r\n\r\nasync function runMigration(filePath: string): Promise<void> {\r\n  const pool = getPgPool();\r\n  const sql = readFileSync(filePath, 'utf-8');\r\n  \r\n  console.info(`Running migration: ${filePath}`);\r\n  \r\n  try {\r\n  await pool.query(sql);\r\n  console.info(`‚úÖ Migration completed: ${filePath}`);\r\n  } catch (e: any) {\r\n      if (e.code === '42P07' || e.message?.includes('already exists')) {\r\n      console.info(`‚ö†Ô∏è  Table/index already exists, skipping: ${filePath}`);\r\n    } else {\r\n      console.error(`‚ùå Migration failed: ${filePath}`, e);\r\n      throw e;\r\n    }\r\n  }\r\n}\r\n\r\nasync function main() {\r\n  const migrationFile = process.argv[2];\r\n  \r\n  if (!migrationFile) {\r\n    console.error('Usage: tsx run-migrations.ts <migration-file>');\r\n    process.exit(1);\r\n  }\r\n  \r\n  const fullPath = join(process.cwd(), migrationFile);\r\n  \r\n  try {\r\n    await runMigration(fullPath);\r\n    process.exit(0);\r\n  } catch (e) {\r\n    console.error('Migration execution failed:', e);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\n// ES module entry point\r\nmain().catch(console.error);\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\demand-status.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\domain\\offer\\mapping.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'synonyms' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'mapField' is defined but never used. Allowed unused vars must match /^_/u.","line":13,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":18},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[360,363],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[360,363],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":89,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":92,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[405,408],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[405,408],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'key' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":22,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":18},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":199,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":199,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5379,5382],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5379,5382],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":202,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":202,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5533,5536],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5533,5536],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Teklif Mod√ºl√º - Alan E≈üleme (Mapping)\r\n * \r\n * Talep detay sayfasƒ±ndaki DOM/JSON alanlarƒ±nƒ± ≈üemaya e≈üleyen deterministik baƒülantƒ±lar.\r\n */\r\n\r\nimport { DemandData, OfferHeader, OfferLine, Priority } from './schema';\r\nimport synonyms from './synonyms.tr.json';\r\n\r\n/**\r\n * S√∂zl√ºk tabanlƒ± e≈üleme fonksiyonu\r\n */\r\nfunction mapField(fieldKey: string, value: any, synonymsMap: Record<string, string[]>): any {\r\n  const normalizedKey = fieldKey.toLowerCase().trim();\r\n  \r\n  // Direkt e≈üle≈üme kontrol√º\r\n  if (synonymsMap[normalizedKey]) {\r\n    return value;\r\n  }\r\n  \r\n  // S√∂zl√ºk e≈üle≈ümesi\r\n  for (const [key, aliases] of Object.entries(synonymsMap)) {\r\n    if (aliases.includes(normalizedKey)) {\r\n      return value;\r\n    }\r\n  }\r\n  \r\n  return value;\r\n}\r\n\r\n/**\r\n * √ñncelik √ßevirisi (EN ‚Üí TR)\r\n */\r\nexport function mapPriority(priority: string | undefined): Priority | undefined {\r\n  if (!priority) return undefined;\r\n  \r\n  const priorityMap: Record<string, Priority> = {\r\n    'price': 'price',\r\n    'fiyat': 'price',\r\n    'speed': 'date',\r\n    'hƒ±z': 'date',\r\n    'date': 'date',\r\n    'tarih': 'date',\r\n    'quality': 'quality',\r\n    'kalite': 'quality',\r\n  };\r\n  \r\n  const normalized = priority.toLowerCase().trim();\r\n  return priorityMap[normalized];\r\n}\r\n\r\n/**\r\n * Para birimi normalize etme\r\n */\r\nexport function mapCurrency(currency: string | undefined): 'TRY' | 'USD' | 'EUR' | 'GBP' {\r\n  if (!currency) return 'TRY';\r\n  \r\n  const currencyMap: Record<string, 'TRY' | 'USD' | 'EUR' | 'GBP'> = {\r\n    'try': 'TRY',\r\n    'tl': 'TRY',\r\n    '‚Ç∫': 'TRY',\r\n    't√ºrk lirasƒ±': 'TRY',\r\n    'turkish lira': 'TRY',\r\n    'usd': 'USD',\r\n    '$': 'USD',\r\n    'dolar': 'USD',\r\n    'dollar': 'USD',\r\n    'eur': 'EUR',\r\n    '‚Ç¨': 'EUR',\r\n    'euro': 'EUR',\r\n    'gbp': 'GBP',\r\n    '¬£': 'GBP',\r\n    'sterlin': 'GBP',\r\n    'pound': 'GBP',\r\n  };\r\n  \r\n  const normalized = currency.toLowerCase().trim();\r\n  return currencyMap[normalized] || 'TRY';\r\n}\r\n\r\n/**\r\n * Tarih normalize etme\r\n */\r\nexport function mapDate(date: string | Date | undefined): string | undefined {\r\n  if (!date) return undefined;\r\n  \r\n  if (date instanceof Date) {\r\n    return date.toISOString();\r\n  }\r\n  \r\n  if (typeof date === 'string') {\r\n    // ISO format zaten ise\r\n    if (date.includes('T') || date.includes('Z')) {\r\n      return date;\r\n    }\r\n    \r\n    // T√ºrk√ße tarih formatlarƒ±\r\n    const turkishFormats = [\r\n      /^(\\d{2})\\.(\\d{2})\\.(\\d{4})$/, // DD.MM.YYYY\r\n      /^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/, // DD/MM/YYYY\r\n      /^(\\d{4})-(\\d{2})-(\\d{2})$/, // YYYY-MM-DD\r\n    ];\r\n    \r\n    for (const format of turkishFormats) {\r\n      const match = date.match(format);\r\n      if (match) {\r\n        if (format === turkishFormats[0] || format === turkishFormats[1]) {\r\n          // DD.MM.YYYY veya DD/MM/YYYY\r\n          const [, day, month, year] = match;\r\n          return new Date(`${year}-${month}-${day}`).toISOString();\r\n        } else {\r\n          // YYYY-MM-DD\r\n          return new Date(date).toISOString();\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  return undefined;\r\n}\r\n\r\n/**\r\n * Talep verilerinden Teklif Ba≈ülƒ±ƒüƒ± olu≈üturma\r\n */\r\nexport function mapDemandToOfferHeader(demand: DemandData): OfferHeader {\r\n  return {\r\n    satfkCode: demand.satfk || '',\r\n    title: demand.title || '',\r\n    site: demand.siteName,\r\n    purchaseCity: demand.purchaseLocation,\r\n    priority: mapPriority(demand.priority),\r\n    dueDate: mapDate(demand.dueDate),\r\n    currency: mapCurrency(demand.currency),\r\n    paymentTerms: demand.paymentTerms ? {\r\n      type: 'pesin_teslim_onay' as const,\r\n      ...demand.paymentTerms,\r\n    } : undefined,\r\n    isSealedBid: demand.biddingMode === 'secret',\r\n  };\r\n}\r\n\r\n/**\r\n * Talep kalemlerinden Teklif Satƒ±rlarƒ± olu≈üturma\r\n */\r\nexport function mapDemandItemsToOfferLines(demand: DemandData): OfferLine[] {\r\n  if (!demand.items || demand.items.length === 0) {\r\n    return [];\r\n  }\r\n  \r\n  return demand.items.map((item) => ({\r\n    itemName: item.name || '',\r\n    spec: item.spec,\r\n    uom: item.unit || '',\r\n    quantity: item.qty || 0,\r\n    unitPrice: item.targetUnitPrice || 0,\r\n    vatRate: 18, // Default KDV\r\n    deliveryDate: mapDate(item.deliveryDate),\r\n    brand: item.brand,\r\n    notes: '',\r\n    // Hesaplanan alanlar ba≈ülangƒ±√ßta bo≈ü\r\n    netUnitWithVat: undefined,\r\n    totalExVat: undefined,\r\n    totalWithVat: undefined,\r\n    // Talep referanslarƒ±\r\n    demandQuantity: item.qty,\r\n    demandUnitPrice: item.targetUnitPrice,\r\n    demandDeliveryDate: item.deliveryDate ? mapDate(item.deliveryDate) : undefined,\r\n    demandUom: item.unit,\r\n  }));\r\n}\r\n\r\n/**\r\n * DOM'dan deƒüer √ßekme yardƒ±mcƒ±larƒ±\r\n */\r\nexport function extractFromDOM(selector: string): string | undefined {\r\n  const element = document.querySelector(selector);\r\n  if (!element) return undefined;\r\n  \r\n  // Input, select, textarea\r\n  if (element instanceof HTMLInputElement || \r\n      element instanceof HTMLSelectElement || \r\n      element instanceof HTMLTextAreaElement) {\r\n    return element.value;\r\n  }\r\n  \r\n  // Text i√ßerik\r\n  return element.textContent?.trim() || undefined;\r\n}\r\n\r\n/**\r\n * Talep detay sayfasƒ±ndan veri √ßekme\r\n */\r\nexport function extractDemandFromPage(): DemandData {\r\n  return {\r\n    satfk: extractFromDOM('#d-satfk'),\r\n    title: extractFromDOM('#d-title'),\r\n    siteName: extractFromDOM('#d-site'),\r\n    purchaseLocation: extractFromDOM('#d-purchase-location'),\r\n    priority: extractFromDOM('#d-priority') as any,\r\n    dueDate: extractFromDOM('#d-duedate'),\r\n    currency: extractFromDOM('#d-currency'),\r\n    biddingMode: extractFromDOM('[data-bidding-mode]') as any,\r\n  };\r\n}\r\n\r\n/**\r\n * Fark hesaplama (Talep vs Teklif)\r\n */\r\nexport interface DifferenceResult {\r\n  quantityDiff?: number;\r\n  unitPriceDiff?: number;\r\n  pricePercentDiff?: number;\r\n  deliveryDateDiff?: number; // g√ºn cinsinden\r\n  uomDiff?: boolean;\r\n  hasDifference: boolean;\r\n}\r\n\r\nexport function calculateDifference(\r\n  demandLine: Partial<OfferLine>,\r\n  offerLine: OfferLine\r\n): DifferenceResult {\r\n  const result: DifferenceResult = {\r\n    hasDifference: false,\r\n  };\r\n  \r\n  // Miktar farkƒ±\r\n  if (demandLine.demandQuantity !== undefined && offerLine.quantity !== undefined) {\r\n    result.quantityDiff = offerLine.quantity - demandLine.demandQuantity;\r\n    if (result.quantityDiff !== 0) result.hasDifference = true;\r\n  }\r\n  \r\n  // Birim fiyat farkƒ±\r\n  if (demandLine.demandUnitPrice !== undefined && offerLine.unitPrice !== undefined) {\r\n    result.unitPriceDiff = offerLine.unitPrice - demandLine.demandUnitPrice;\r\n    if (demandLine.demandUnitPrice > 0) {\r\n      result.pricePercentDiff = (result.unitPriceDiff / demandLine.demandUnitPrice) * 100;\r\n    }\r\n    if (result.unitPriceDiff !== 0) result.hasDifference = true;\r\n  }\r\n  \r\n  // Termin farkƒ±\r\n  if (demandLine.demandDeliveryDate && offerLine.deliveryDate) {\r\n    const demandDate = new Date(demandLine.demandDeliveryDate);\r\n    const offerDate = new Date(offerLine.deliveryDate);\r\n    result.deliveryDateDiff = Math.floor((offerDate.getTime() - demandDate.getTime()) / (1000 * 60 * 60 * 24));\r\n    if (result.deliveryDateDiff !== 0) result.hasDifference = true;\r\n  }\r\n  \r\n  // Birim farkƒ±\r\n  if (demandLine.demandUom && offerLine.uom) {\r\n    result.uomDiff = demandLine.demandUom.toLowerCase() !== offerLine.uom.toLowerCase();\r\n    if (result.uomDiff) result.hasDifference = true;\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\domain\\offer\\schema.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":181,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":181,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5482,5485],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5482,5485],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { z } from 'zod';\r\n\r\n/**\r\n * Teklif Mod√ºl√º - Merkezi TypeScript ≈ûemasƒ±\r\n * \r\n * Bu ≈üema, satƒ±n alma talebi ve tedarik√ßi tekliflerini tanƒ±mlar.\r\n * Excel ≈üablonu ile birebir uyumlu olacak ≈üekilde tasarlandƒ±.\r\n */\r\n\r\n// √ñncelik deƒüerleri ve T√ºrk√ße √ßevirileri\r\nexport const PriorityEnum = z.enum(['price', 'date', 'quality'], {\r\n  errorMap: () => ({ message: '√ñncelik: Fiyat, Tarih veya Kalite olmalƒ±' })\r\n});\r\n\r\nexport type Priority = z.infer<typeof PriorityEnum>;\r\n\r\n// Para birimi enum\r\nexport const CurrencyEnum = z.enum(['TRY', 'USD', 'EUR', 'GBP'], {\r\n  errorMap: () => ({ message: 'Para birimi: TRY, USD, EUR veya GBP olmalƒ±' })\r\n});\r\n\r\nexport type Currency = z.infer<typeof CurrencyEnum>;\r\n\r\n// √ñdeme ≈üartlarƒ± tipleri\r\nexport const PaymentTypeEnum = z.enum([\r\n  'pesin_escrow',\r\n  'pesin_teslim_onay',\r\n  'pesin_on_odeme',\r\n  'kredi_karti',\r\n  'acik_hesap',\r\n  'evrak_cek'\r\n]);\r\n\r\nexport type PaymentType = z.infer<typeof PaymentTypeEnum>;\r\n\r\n/**\r\n * √ñdeme ≈ûartlarƒ± Detay ≈ûemasƒ±\r\n */\r\nexport const PaymentTermsSchema = z.object({\r\n  type: PaymentTypeEnum,\r\n  // Pe≈üin Escrow\r\n  escrowDays: z.number().optional(),\r\n  // Pe≈üin Teslim&Onay\r\n  deliveryConfirmDays: z.number().optional(),\r\n  // Pe≈üin √ñn √ñdeme\r\n  advancePercent: z.number().min(0).max(100).optional(),\r\n  // Kredi Kartƒ±\r\n  installments: z.number().min(1).optional(),\r\n  financeRate: z.number().min(0).optional(),\r\n  // A√ßƒ±k Hesap\r\n  invoiceDate: z.string().optional(), // ISO date string\r\n  dueDays: z.number().min(0).optional(),\r\n  // Evrak/√áek\r\n  checkCount: z.number().min(1).optional(),\r\n  checkAmount: z.number().optional(),\r\n  checkDays: z.array(z.number()).optional(), // Her √ßek i√ßin vade g√ºnleri\r\n});\r\n\r\nexport type PaymentTerms = z.infer<typeof PaymentTermsSchema>;\r\n\r\n/**\r\n * Ekler (Attachments)\r\n */\r\nexport const AttachmentSchema = z.object({\r\n  name: z.string(),\r\n  url: z.string().url(),\r\n  type: z.enum(['image', 'document', 'other']).optional(),\r\n  uploadedAt: z.string().datetime().optional(),\r\n});\r\n\r\nexport type Attachment = z.infer<typeof AttachmentSchema>;\r\n\r\n/**\r\n * Teklif Satƒ±rƒ± (Line Item)\r\n */\r\nexport const OfferLineSchema = z.object({\r\n  // Temel bilgiler\r\n  category: z.string().optional(),\r\n  itemName: z.string().min(1, '√úr√ºn adƒ± zorunludur'),\r\n  spec: z.string().optional(),\r\n  uom: z.string().min(1, 'Birim zorunludur'), // Unit of Measure (Birim)\r\n  \r\n  // Miktar ve fiyat\r\n  quantity: z.number().positive('Miktar 0\\'dan b√ºy√ºk olmalƒ±'),\r\n  unitPrice: z.number().min(0, 'Birim fiyat 0 veya pozitif olmalƒ±'), // KDV hari√ß\r\n  vatRate: z.number().min(0).max(100).default(18), // KDV oranƒ± (%)\r\n  \r\n  // Tarih\r\n  deliveryDate: z.string().optional(), // ISO date string\r\n  \r\n  // Ek bilgiler\r\n  brand: z.string().optional(),\r\n  notes: z.string().optional(),\r\n  \r\n  // Hesaplanan alanlar (derived)\r\n  netUnitWithVat: z.number().optional(), // unitPrice * (1 + vatRate/100)\r\n  totalExVat: z.number().optional(), // quantity * unitPrice\r\n  totalWithVat: z.number().optional(), // quantity * netUnitWithVat\r\n  \r\n  // Talep ile kar≈üƒ±la≈ütƒ±rma i√ßin\r\n  demandQuantity: z.number().optional(),\r\n  demandUnitPrice: z.number().optional(),\r\n  demandDeliveryDate: z.string().optional(),\r\n  demandUom: z.string().optional(),\r\n});\r\n\r\nexport type OfferLine = z.infer<typeof OfferLineSchema>;\r\n\r\n/**\r\n * Kur Bilgileri (Currency Exchange)\r\n */\r\nexport const CurrencyInfoSchema = z.object({\r\n  fxCurrency: CurrencyEnum,\r\n  fxRate: z.number().positive('Kur pozitif olmalƒ±'),\r\n  fxDate: z.string().datetime('Ge√ßerli bir tarih olmalƒ±'),\r\n  source: z.string().optional(), // Kur kaynaƒüƒ± (TCMB, XE, vb.)\r\n});\r\n\r\nexport type CurrencyInfo = z.infer<typeof CurrencyInfoSchema>;\r\n\r\n/**\r\n * Teklif Ba≈ülƒ±k Bilgileri (Header)\r\n */\r\nexport const OfferHeaderSchema = z.object({\r\n  satfkCode: z.string().min(1, 'SATFK kodu zorunludur'),\r\n  title: z.string().min(1, 'Ba≈ülƒ±k zorunludur'),\r\n  site: z.string().optional(), // ≈ûantiye adƒ±\r\n  purchaseCity: z.string().optional(), // Alƒ±m yeri (ƒ∞l)\r\n  priority: PriorityEnum.optional(),\r\n  dueDate: z.string().datetime().optional(), // ISO date string\r\n  currency: CurrencyEnum.default('TRY'),\r\n  paymentTerms: PaymentTermsSchema.optional(),\r\n  isSealedBid: z.boolean().default(false), // Gizli teklif (tek tur)\r\n  \r\n  // Ek bilgiler\r\n  validUntil: z.string().datetime().optional(), // Teklif ge√ßerlilik tarihi\r\n});\r\n\r\nexport type OfferHeader = z.infer<typeof OfferHeaderSchema>;\r\n\r\n/**\r\n * Tam Teklif ≈ûemasƒ±\r\n */\r\nexport const OfferSchema = z.object({\r\n  // Ba≈ülƒ±k\r\n  header: OfferHeaderSchema,\r\n  \r\n  // Satƒ±rlar\r\n  lines: z.array(OfferLineSchema).min(1, 'En az 1 satƒ±r zorunludur'),\r\n  \r\n  // Ekler\r\n  attachments: z.array(AttachmentSchema).optional().default([]),\r\n  \r\n  // Kur bilgileri (TRY dƒ±≈üƒ± para birimi i√ßin)\r\n  currencyInfo: CurrencyInfoSchema.optional(),\r\n  \r\n  // Ge√ßerlilik\r\n  validUntil: z.string().datetime().optional(),\r\n  \r\n  // Meta\r\n  supplierId: z.string().optional(),\r\n  supplierName: z.string().optional(),\r\n  createdAt: z.string().datetime().optional(),\r\n  updatedAt: z.string().datetime().optional(),\r\n  status: z.enum(['draft', 'submitted', 'accepted', 'rejected']).default('draft'),\r\n});\r\n\r\nexport type Offer = z.infer<typeof OfferSchema>;\r\n\r\n/**\r\n * Talep verilerinden teklif olu≈üturma i√ßin yardƒ±mcƒ± tip\r\n */\r\nexport interface DemandData {\r\n  satfk?: string;\r\n  title?: string;\r\n  siteName?: string;\r\n  purchaseLocation?: string;\r\n  priority?: 'price' | 'speed' | 'quality';\r\n  dueDate?: string | Date;\r\n  currency?: string;\r\n  paymentTerms?: any;\r\n  biddingMode?: 'secret' | 'open' | 'hybrid';\r\n  items?: Array<{\r\n    name?: string;\r\n    spec?: string;\r\n    qty?: number;\r\n    unit?: string;\r\n    brand?: string;\r\n    deliveryDate?: string;\r\n    targetUnitPrice?: number;\r\n  }>;\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\export\\excel\\supplierOfferExport.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":65,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1863,1866],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1863,1866],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Tedarik√ßi Teklif Excel Export\r\n * \r\n * assets/SATINALMAVETEKLƒ∞FFORMU.xlsx ≈üablonunu kullanarak teklif Excel dosyasƒ± olu≈üturur.\r\n */\r\n\r\nimport ExcelJS from 'exceljs';\r\nimport type { Offer } from '../../domain/offer/schema';\r\nimport * as path from 'path';\r\nimport * as fs from 'fs';\r\n\r\nconst TEMPLATE_PATH = path.join(process.cwd(), 'assets', 'SATINALMAVETEKLƒ∞FFORMU.xlsx');\r\nconst SHEET_NAME = 'SATIN ALMA VE TEKLIF FORMU';\r\n\r\n/**\r\n * Excel export fonksiyonu\r\n */\r\nexport async function exportSupplierOffer(offer: Offer): Promise<ExcelJS.Buffer> {\r\n  const workbook = new ExcelJS.Workbook();\r\n  \r\n  // ≈ûablon varsa y√ºkle, yoksa yeni olu≈ütur\r\n  let templateExists = false;\r\n  try {\r\n    if (fs.existsSync(TEMPLATE_PATH)) {\r\n      await workbook.xlsx.readFile(TEMPLATE_PATH);\r\n      templateExists = true;\r\n    }\r\n  } catch (error) {\r\n    console.warn('≈ûablon y√ºklenemedi, yeni dosya olu≈üturuluyor:', error);\r\n  }\r\n  \r\n  // Worksheet al veya olu≈ütur\r\n  let worksheet = workbook.getWorksheet(SHEET_NAME);\r\n  if (!worksheet) {\r\n    worksheet = workbook.addWorksheet(SHEET_NAME);\r\n  }\r\n  \r\n  // ≈ûablon yoksa ba≈ülƒ±k satƒ±rlarƒ±nƒ± olu≈ütur\r\n  if (!templateExists) {\r\n    setupHeaders(worksheet);\r\n  }\r\n  \r\n  // Ba≈ülƒ±k bilgilerini doldur (N1..P4 b√∂lgesi)\r\n  fillHeaderSection(worksheet, offer);\r\n  \r\n  // Satƒ±r bilgilerini doldur (satƒ±r 6 ve sonrasƒ±)\r\n  const startRow = 6;\r\n  offer.lines.forEach((line, index) => {\r\n    const row = startRow + index;\r\n    fillLineRow(worksheet, row, line, index + 1);\r\n  });\r\n  \r\n  // Toplam satƒ±rƒ± (satƒ±r 9 veya son satƒ±rdan sonra)\r\n  const totalRow = startRow + offer.lines.length;\r\n  fillTotalRow(worksheet, totalRow);\r\n  \r\n  // Buffer olarak d√∂nd√ºr\r\n  const buffer = await workbook.xlsx.writeBuffer();\r\n  return buffer as ExcelJS.Buffer;\r\n}\r\n\r\n/**\r\n * √ñdeme ≈üartlarƒ± formatlama (utility)\r\n */\r\nfunction formatPaymentTerms(terms: any): string {\r\n  if (!terms || !terms.type) return '';\r\n  \r\n  switch (terms.type) {\r\n    case 'pesin_escrow':\r\n      return `Pe≈üin (Escrow${terms.escrowDays ? ` / ${terms.escrowDays} g√ºn` : ''})`;\r\n    case 'pesin_teslim_onay':\r\n      return `Pe≈üin (Teslim&Onay${terms.deliveryConfirmDays ? ` / ${terms.deliveryConfirmDays} g√ºn` : ''})`;\r\n    case 'pesin_on_odeme':\r\n      return `Pe≈üin (√ñn √ñdeme %${terms.advancePercent || 0})`;\r\n    case 'kredi_karti':\r\n      return `Kredi Kartƒ± (${terms.installments || 1} taksit${terms.financeRate ? ` / %${terms.financeRate} faiz` : ''})`;\r\n    case 'acik_hesap':\r\n      return `A√ßƒ±k Hesap (${terms.dueDays || 30} g√ºn)`;\r\n    case 'evrak_cek':\r\n      return `Evrak/√áek (${terms.checkCount || 1} adet)`;\r\n    default:\r\n      return '';\r\n  }\r\n}\r\n\r\n/**\r\n * Ba≈ülƒ±k satƒ±rlarƒ±nƒ± olu≈ütur\r\n */\r\nfunction setupHeaders(worksheet: ExcelJS.Worksheet) {\r\n  // Satƒ±r 5: S√ºtun ba≈ülƒ±klarƒ±\r\n  \r\n  // H5: Bƒ∞Rƒ∞M Fƒ∞YAT (KDV Hari√ß)\r\n  worksheet.getCell('H5').value = 'Bƒ∞Rƒ∞M Fƒ∞YAT (KDV Hari√ß)';\r\n  \r\n  // K5-L5 (merge): KDV HARƒ∞√á TOPLAM TL\r\n  worksheet.mergeCells('K5:L5');\r\n  worksheet.getCell('K5').value = 'KDV HARƒ∞√á TOPLAM TL';\r\n  worksheet.getCell('K5').alignment = { horizontal: 'center', vertical: 'middle' };\r\n  \r\n  // N5: KDV ORANI (%)\r\n  worksheet.getCell('N5').value = 'KDV ORANI (%)';\r\n  \r\n  // P5: KDV DAHƒ∞L Bƒ∞Rƒ∞M Fƒ∞YAT\r\n  worksheet.getCell('P5').value = 'KDV DAHƒ∞L Bƒ∞Rƒ∞M Fƒ∞YAT';\r\n  \r\n  // O5: KDV DAHƒ∞L TOPLAM TL\r\n  worksheet.getCell('O5').value = 'KDV DAHƒ∞L TOPLAM TL';\r\n  \r\n  // M5: √ñDEME ≈ûARTLARI\r\n  worksheet.getCell('M5').value = '√ñDEME ≈ûARTLARI';\r\n  \r\n  // Ba≈ülƒ±k stilleri\r\n  [5].forEach(rowNum => {\r\n    const row = worksheet.getRow(rowNum);\r\n    row.font = { bold: true };\r\n    row.alignment = { horizontal: 'center', vertical: 'middle' };\r\n    row.fill = {\r\n      type: 'pattern',\r\n      pattern: 'solid',\r\n      fgColor: { argb: 'FFE5E7EB' },\r\n    };\r\n  });\r\n}\r\n\r\n/**\r\n * Ba≈ülƒ±k b√∂lgesini doldur (N1..P4)\r\n */\r\nfunction fillHeaderSection(worksheet: ExcelJS.Worksheet, offer: Offer) {\r\n  const header = offer.header;\r\n  \r\n  // N1: SATFK\r\n  worksheet.getCell('N1').value = header.satfkCode;\r\n  \r\n  // N2: Ba≈ülƒ±k\r\n  worksheet.getCell('N2').value = header.title;\r\n  \r\n  // N3: ≈ûantiye\r\n  worksheet.getCell('N3').value = header.site || '';\r\n  \r\n  // N4: Alƒ±m Yeri\r\n  worksheet.getCell('N4').value = header.purchaseCity || '';\r\n  \r\n  // P1: Para Birimi\r\n  worksheet.getCell('P1').value = header.currency;\r\n  \r\n  // P2: √ñncelik\r\n  const priorityMap: Record<string, string> = {\r\n    'price': 'Fiyat',\r\n    'date': 'Tarih',\r\n    'quality': 'Kalite',\r\n  };\r\n  worksheet.getCell('P2').value = priorityMap[header.priority || 'price'] || '';\r\n  \r\n  // P3: Termin Tarihi\r\n  if (header.dueDate) {\r\n    const date = new Date(header.dueDate);\r\n    worksheet.getCell('P3').value = date;\r\n    worksheet.getCell('P3').numFmt = 'dd.mm.yyyy';\r\n  }\r\n  \r\n  // P4: √ñdeme ≈ûartlarƒ±\r\n  if (header.paymentTerms) {\r\n    worksheet.getCell('P4').value = formatPaymentTerms(header.paymentTerms);\r\n  }\r\n}\r\n\r\n/**\r\n * Satƒ±r bilgilerini doldur\r\n */\r\nfunction fillLineRow(worksheet: ExcelJS.Worksheet, rowNum: number, line: Offer['lines'][0], lineNo: number) {\r\n  const row = worksheet.getRow(rowNum);\r\n  \r\n  // A: No\r\n  row.getCell(1).value = lineNo;\r\n  \r\n  // B: √úr√ºn Adƒ± (itemName)\r\n  row.getCell(2).value = line.itemName;\r\n  \r\n  // C: Spec (varsa)\r\n  row.getCell(3).value = line.spec || '';\r\n  \r\n  // D: Marka\r\n  row.getCell(4).value = line.brand || '';\r\n  \r\n  // E: Birim\r\n  row.getCell(5).value = line.uom;\r\n  \r\n  // F: Miktar\r\n  row.getCell(6).value = line.quantity;\r\n  row.getCell(6).numFmt = '#,##0.00';\r\n  \r\n  // G: (bo≈ü - Depodaki Miktar yazma)\r\n  \r\n  // H: Birim Fiyat (KDV Hari√ß)\r\n  row.getCell(8).value = line.unitPrice;\r\n  row.getCell(8).numFmt = '#,##0.00';\r\n  \r\n  // I: (g√∂rsel - bo≈ü)\r\n  \r\n  // J: Termin\r\n  if (line.deliveryDate) {\r\n    const date = new Date(line.deliveryDate);\r\n    row.getCell(10).value = date;\r\n    row.getCell(10).numFmt = 'dd.mm.yyyy';\r\n  }\r\n  \r\n  // K-L: KDV Hari√ß Toplam (merge)\r\n  worksheet.mergeCells(`K${rowNum}:L${rowNum}`);\r\n  row.getCell(11).value = line.totalExVat || 0;\r\n  row.getCell(11).numFmt = '#,##0.00';\r\n  row.getCell(11).alignment = { horizontal: 'center', vertical: 'middle' };\r\n  \r\n  // M: √ñdeme ≈ûartlarƒ± (satƒ±r bazlƒ±)\r\n  row.getCell(13).value = line.notes || '';\r\n  \r\n  // N: KDV Oranƒ± (%)\r\n  row.getCell(14).value = line.vatRate;\r\n  row.getCell(14).numFmt = '0.00';\r\n  \r\n  // O: KDV Dahil Toplam\r\n  row.getCell(15).value = line.totalWithVat || 0;\r\n  row.getCell(15).numFmt = '#,##0.00';\r\n  \r\n  // P: KDV Dahil Birim Fiyat (form√ºl)\r\n  row.getCell(16).value = {\r\n    formula: `H${rowNum}*(1+N${rowNum}/100)`,\r\n  };\r\n  row.getCell(16).numFmt = '#,##0.00';\r\n  \r\n  // O h√ºcresini de form√ºlle hesapla\r\n  row.getCell(15).value = {\r\n    formula: `F${rowNum}*P${rowNum}`,\r\n  };\r\n}\r\n\r\n/**\r\n * Toplam satƒ±rƒ±nƒ± doldur\r\n */\r\nfunction fillTotalRow(worksheet: ExcelJS.Worksheet, rowNum: number) {\r\n  const row = worksheet.getRow(rowNum);\r\n  \r\n  // A: \"TOPLAM\" etiketi\r\n  row.getCell(1).value = 'TOPLAM';\r\n  row.getCell(1).font = { bold: true };\r\n  \r\n  // K-L: KDV Hari√ß Toplam (merge + form√ºl)\r\n  worksheet.mergeCells(`K${rowNum}:L${rowNum}`);\r\n  row.getCell(11).value = {\r\n    formula: `SUM(K6:L${rowNum - 1})`,\r\n  };\r\n  row.getCell(11).numFmt = '#,##0.00';\r\n  row.getCell(11).font = { bold: true };\r\n  row.getCell(11).alignment = { horizontal: 'center', vertical: 'middle' };\r\n  \r\n  // O: KDV Dahil Toplam (form√ºl)\r\n  row.getCell(15).value = {\r\n    formula: `SUM(O6:O${rowNum - 1})`,\r\n  };\r\n  row.getCell(15).numFmt = '#,##0.00';\r\n  row.getCell(15).font = { bold: true };\r\n  \r\n  // Stil\r\n  row.fill = {\r\n    type: 'pattern',\r\n    pattern: 'solid',\r\n    fgColor: { argb: 'FFFEF3C7' },\r\n  };\r\n}\r\n\r\n/**\r\n * Tarayƒ±cƒ±da √ßalƒ±≈üan versiyon (browser)\r\n */\r\nexport async function exportSupplierOfferBrowser(offerData: Offer): Promise<Blob> {\r\n  // Node.js ortamƒ±nda √ßalƒ±≈ütƒ±rƒ±lacak, tarayƒ±cƒ± i√ßin API endpoint kullan\r\n  const response = await fetch('/api/offers/export', {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify({ offer: offerData }),\r\n  });\r\n  \r\n  if (!response.ok) {\r\n    throw new Error('Excel export ba≈üarƒ±sƒ±z');\r\n  }\r\n  \r\n  return await response.blob();\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\features\\demand\\DemandForm.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1242,1245],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1242,1245],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2836,2839],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2836,2839],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { InviteSection } from \"./InviteSection\";\r\nimport { BidVisibility, DemandPayload, DemandVisibility, Group, InviteMode, Supplier } from \"./types\";\r\nimport { createDemand } from \"./api\";\r\n\r\nexport function DemandForm({ allGroups, supplierSearch }:{ allGroups: Group[]; supplierSearch:(q:string)=>Promise<Supplier[]> }) {\r\n  const [title, setTitle] = useState(\"\");\r\n  const [bidVisibility, setBidVisibility] = useState<BidVisibility>(\"gizli\");\r\n  const [demandVisibility, setDemandVisibility] = useState<DemandVisibility>(\"genel\");\r\n  const [selectedGroupIds, setSelectedGroupIds] = useState<string[]>([]);\r\n  const [inviteMode, setInviteMode] = useState<InviteMode>(\"auto\");\r\n  const [customInvitees, setCustomInvitees] = useState<Supplier[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  async function onSubmit(e: React.FormEvent) {\r\n    e.preventDefault();\r\n    const payload: DemandPayload = {\r\n      title,\r\n      bidVisibility,\r\n      demandVisibility,\r\n      selectedGroupIds,\r\n      inviteMode,\r\n      invitedSupplierIds: customInvitees.map(s=>s.id),\r\n    };\r\n    setLoading(true);\r\n    try {\r\n      await createDemand(payload);\r\n      alert(\"Talep olu≈üturuldu\");\r\n    } catch (e:any) {\r\n      alert(e.message || \"Hata\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  return (\r\n    <form onSubmit={onSubmit} className=\"grid gap-4\">\r\n      <div>\r\n        <label className=\"text-sm\">Ba≈ülƒ±k</label>\r\n        <input className=\"border rounded p-2 w-full\" value={title} onChange={e=>setTitle(e.target.value)} />\r\n      </div>\r\n\r\n      <fieldset className=\"border rounded p-3\">\r\n        <legend className=\"font-medium\">Talep Tipi (Tekliflerin g√∂r√ºn√ºrl√ºƒü√º)</legend>\r\n        <Radio name=\"bidVis\" label=\"Gizli\" value=\"gizli\" checked={bidVisibility===\"gizli\"} onChange={()=>setBidVisibility(\"gizli\")} />\r\n        <Radio name=\"bidVis\" label=\"A√ßƒ±k\" value=\"acik\" checked={bidVisibility===\"acik\"} onChange={()=>setBidVisibility(\"acik\")} />\r\n        <Radio name=\"bidVis\" label=\"Hibrit\" value=\"hibrit\" checked={bidVisibility===\"hibrit\"} onChange={()=>setBidVisibility(\"hibrit\")} />\r\n      </fieldset>\r\n\r\n      <InviteSection\r\n        allGroups={allGroups}\r\n        visibility={demandVisibility}\r\n        onVisibilityChange={setDemandVisibility}\r\n        selectedGroupIds={selectedGroupIds}\r\n        onSelectedGroupIdsChange={setSelectedGroupIds}\r\n        inviteMode={inviteMode}\r\n        onInviteModeChange={setInviteMode}\r\n        customInvitees={customInvitees}\r\n        onCustomInviteesChange={setCustomInvitees}\r\n        supplierSearch={supplierSearch}\r\n      />\r\n\r\n      <div>\r\n        <button className=\"px-4 py-2 rounded bg-blue-600 text-white\" disabled={loading}>{loading?\"Kaydediliyor‚Ä¶\":\"Kaydet\"}</button>\r\n      </div>\r\n    </form>\r\n  );\r\n}\r\n\r\nfunction Radio(props: any) { return (\r\n  <label className=\"flex items-center gap-2 cursor-pointer\">\r\n    <input type=\"radio\" {...props} className=\"h-4 w-4\" />\r\n    <span>{props.label}</span>\r\n  </label>\r\n);}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\features\\demand\\InviteSection.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":102,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4221,4224],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4221,4224],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useMemo, useState } from \"react\";\r\nimport { Group, Supplier, DemandVisibility, InviteMode } from \"./types\";\r\nimport { fetchGroupMembers } from \"./api\";\r\n\r\nexport function InviteSection({\r\n  allGroups,\r\n  visibility,\r\n  onVisibilityChange,\r\n  selectedGroupIds,\r\n  onSelectedGroupIdsChange,\r\n  inviteMode,\r\n  onInviteModeChange,\r\n  customInvitees,\r\n  onCustomInviteesChange,\r\n  supplierSearch,\r\n}: {\r\n  allGroups: Group[];\r\n  visibility: DemandVisibility;\r\n  onVisibilityChange: (v: DemandVisibility) => void;\r\n  selectedGroupIds: string[];\r\n  onSelectedGroupIdsChange: (ids: string[]) => void;\r\n  inviteMode: InviteMode;\r\n  onInviteModeChange: (m: InviteMode) => void;\r\n  customInvitees: Supplier[];\r\n  onCustomInviteesChange: (list: Supplier[]) => void;\r\n  supplierSearch: (q: string) => Promise<Supplier[]>;\r\n}) {\r\n  const isPrivate = visibility === \"ozel\";\r\n  const [autoMembers, setAutoMembers] = useState<Supplier[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (isPrivate && inviteMode === \"auto\" && selectedGroupIds.length) {\r\n      setLoading(true);\r\n      fetchGroupMembers(selectedGroupIds).then(setAutoMembers).finally(() => setLoading(false));\r\n    } else if (inviteMode === \"auto\") {\r\n      setAutoMembers([]);\r\n    }\r\n  }, [isPrivate, inviteMode, selectedGroupIds]);\r\n\r\n  const finalInvitees = useMemo(\r\n    () => (inviteMode === \"auto\" ? autoMembers : customInvitees),\r\n    [inviteMode, autoMembers, customInvitees]\r\n  );\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <fieldset className=\"border rounded p-3\">\r\n        <legend className=\"font-medium\">Talep G√∂r√ºn√ºrl√ºƒü√º (Talebi kimler g√∂rebilir?)</legend>\r\n        <Radio name=\"vis\" label=\"√ñzel (davetli)\" value=\"ozel\" checked={isPrivate} onChange={() => onVisibilityChange(\"ozel\")} />\r\n        <p className=\"text-xs text-gray-500 ml-6\">Se√ßtiƒüiniz gruplardaki t√ºm firmalar otomatik davet edilir. ƒ∞sterseniz √∂zelle≈ütirebilirsiniz.</p>\r\n        <Radio name=\"vis\" label=\"Liste dƒ±≈üƒ± (link ile)\" value=\"liste-disi\" checked={visibility===\"liste-disi\"} onChange={() => onVisibilityChange(\"liste-disi\")} />\r\n        <Radio name=\"vis\" label=\"Genel (t√ºm kullanƒ±cƒ±lar)\" value=\"genel\" checked={visibility===\"genel\"} onChange={() => onVisibilityChange(\"genel\")} />\r\n      </fieldset>\r\n\r\n      {isPrivate && (\r\n        <fieldset className=\"border rounded p-3 space-y-3\">\r\n          <legend className=\"font-medium\">Davetliler</legend>\r\n\r\n          <MultiSelect\r\n            label=\"Tedarik√ßi Gruplarƒ±\"\r\n            options={allGroups.map(g => ({ value: g.id, label: `${g.name} (${g.memberCount})` }))}\r\n            value={selectedGroupIds}\r\n            onChange={onSelectedGroupIdsChange}\r\n            placeholder=\"Grup se√ßin\"\r\n          />\r\n\r\n          <div className=\"flex gap-6\">\r\n            <Radio name=\"mode\" value=\"auto\" label=\"Gruba g√∂re otomatik\" checked={inviteMode===\"auto\"} onChange={() => onInviteModeChange(\"auto\")} />\r\n            <Radio name=\"mode\" value=\"custom\" label=\"√ñzelle≈ütir (firma se√ß)\" checked={inviteMode===\"custom\"} onChange={() => onInviteModeChange(\"custom\")} />\r\n          </div>\r\n\r\n          {inviteMode === \"auto\" ? (\r\n            <div className=\"text-sm text-gray-700\">\r\n              {loading ? \"Grup √ºyeleri y√ºkleniyor...\" : `Otomatik davetli sayƒ±sƒ±: ${finalInvitees.length}`}\r\n              <details className=\"mt-2\">\r\n                <summary className=\"cursor-pointer text-blue-600\">Listeyi g√∂r</summary>\r\n                <ul className=\"list-disc ml-5\">\r\n                  {finalInvitees.map(s => <li key={s.id}>{s.name}</li>)}\r\n                </ul>\r\n              </details>\r\n            </div>\r\n          ) : (\r\n            <CustomInviteEditor\r\n              value={customInvitees}\r\n              onChange={onCustomInviteesChange}\r\n              search={supplierSearch}\r\n              seedFromGroups={async () => {\r\n                const seed = await fetchGroupMembers(selectedGroupIds);\r\n                onCustomInviteesChange(seed);\r\n              }}\r\n            />\r\n          )}\r\n        </fieldset>\r\n      )}\r\n\r\n      <input type=\"hidden\" name=\"invitedSupplierIds\" value={finalInvitees.map(s=>s.id).join(\",\")} />\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction Radio(props: any) { return (\r\n  <label className=\"flex items-center gap-2 cursor-pointer\">\r\n    <input type=\"radio\" {...props} className=\"h-4 w-4\" />\r\n    <span>{props.label}</span>\r\n  </label>\r\n);}\r\n\r\nfunction MultiSelect({ label, options, value, onChange, placeholder }:{\r\n  label:string; options:{value:string; label:string}[]; value:string[]; onChange:(v:string[])=>void; placeholder?:string;\r\n}) {\r\n  return (\r\n    <div className=\"grid gap-1\">\r\n      <label className=\"text-sm\">{label}</label>\r\n      <select multiple className=\"border rounded p-2\"\r\n        value={value}\r\n        onChange={(e)=>onChange(Array.from(e.target.selectedOptions).map(o=>o.value))}>\r\n        {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}\r\n      </select>\r\n      <p className=\"text-xs text-gray-500\">{placeholder}</p>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction CustomInviteEditor({\r\n  value, onChange, search, seedFromGroups\r\n}:{\r\n  value: Supplier[]; onChange:(v:Supplier[])=>void;\r\n  search:(q:string)=>Promise<Supplier[]>; seedFromGroups:()=>Promise<void>;\r\n}) {\r\n  const [q, setQ] = useState(\"\"); const [results, setResults] = useState<Supplier[]>([]);\r\n  return (\r\n    <div className=\"grid gap-2\">\r\n      <div className=\"flex gap-2\">\r\n        <input className=\"border rounded px-2 py-1 flex-1\" placeholder=\"Firma ara‚Ä¶\" value={q} onChange={e=>setQ(e.target.value)} />\r\n        <button className=\"px-3 py-1 rounded bg-blue-600 text-white\" onClick={async ()=>{\r\n          const r = await search(q); setResults(r);\r\n        }}>Ara</button>\r\n        <button className=\"px-3 py-1 rounded bg-gray-600 text-white\" onClick={seedFromGroups}>Gruplardan ba≈ülat</button>\r\n      </div>\r\n      <div className=\"flex gap-4\">\r\n        <div className=\"flex-1\">\r\n          <div className=\"font-medium text-sm mb-1\">Sonu√ßlar</div>\r\n          <ul className=\"border rounded p-2 h-40 overflow-auto\">\r\n            {results.map(s => (\r\n              <li key={s.id} className=\"flex justify-between items-center py-1\">\r\n                <span>{s.name}</span>\r\n                <button className=\"text-blue-600 text-sm\" onClick={()=>onChange([...value, s])}>Ekle</button>\r\n              </li>\r\n            ))}\r\n          </ul>\r\n        </div>\r\n        <div className=\"flex-1\">\r\n          <div className=\"font-medium text-sm mb-1\">Davetliler</div>\r\n          <ul className=\"border rounded p-2 h-40 overflow-auto\">\r\n            {value.map(s => (\r\n              <li key={s.id} className=\"flex justify-between items-center py-1\">\r\n                <span>{s.name}</span>\r\n                <button className=\"text-red-600 text-sm\" onClick={()=>onChange(value.filter(x=>x.id!==s.id))}>Kaldƒ±r</button>\r\n              </li>\r\n            ))}\r\n          </ul>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\features\\demand\\api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\features\\demand\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\import\\excel\\supplierOfferImport.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'paymentTermsRaw' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":74,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":74,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'rowNum' is defined but never used. Allowed unused args must match /^_/u.","line":127,"column":41,"nodeType":null,"messageId":"unusedVar","endLine":127,"endColumn":47},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":219,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":219,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5801,5804],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5801,5804],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":244,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":244,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6480,6483],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6480,6483],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Tedarik√ßi Teklif Excel Import\r\n * \r\n * Tedarik√ßinin y√ºklediƒüi Excel dosyasƒ±nƒ± parse eder ve ≈üemaya d√∂n√º≈üt√ºr√ºr.\r\n */\r\n\r\nimport ExcelJS from 'exceljs';\r\nimport { Offer, OfferLine, OfferHeader } from '../../domain/offer/schema';\r\nimport { mapCurrency, mapDate, mapPriority } from '../../domain/offer/mapping';\r\n\r\nconst SHEET_NAME = 'SATIN ALMA VE TEKLIF FORMU';\r\n\r\n/**\r\n * Excel dosyasƒ±nƒ± parse et\r\n */\r\nexport async function importSupplierOffer(buffer: ArrayBuffer | Buffer): Promise<Offer> {\r\n  const workbook = new ExcelJS.Workbook();\r\n  await workbook.xlsx.load(buffer);\r\n  \r\n  // Worksheet bul\r\n  let worksheet = workbook.getWorksheet(SHEET_NAME);\r\n  if (!worksheet) {\r\n    // ƒ∞lk worksheet'i kullan\r\n    worksheet = workbook.worksheets[0];\r\n    if (!worksheet) {\r\n      throw new Error('Excel dosyasƒ±nda worksheet bulunamadƒ±');\r\n    }\r\n  }\r\n  \r\n  // Ba≈ülƒ±k bilgilerini oku (N1..P4)\r\n  const header = parseHeaderSection(worksheet);\r\n  \r\n  // Satƒ±r bilgilerini oku (6. satƒ±rdan itibaren)\r\n  const lines = parseLineRows(worksheet);\r\n  \r\n  // Toplam satƒ±rƒ±nƒ± atla\r\n  \r\n  return {\r\n    header,\r\n    lines,\r\n    attachments: [],\r\n    status: 'draft',\r\n  };\r\n}\r\n\r\n/**\r\n * Ba≈ülƒ±k b√∂l√ºm√ºn√º parse et\r\n */\r\nfunction parseHeaderSection(worksheet: ExcelJS.Worksheet): OfferHeader {\r\n  // N1: SATFK\r\n  const satfkCode = getCellValue(worksheet, 'N1') || '';\r\n  \r\n  // N2: Ba≈ülƒ±k\r\n  const title = getCellValue(worksheet, 'N2') || '';\r\n  \r\n  // N3: ≈ûantiye\r\n  const site = getCellValue(worksheet, 'N3') || undefined;\r\n  \r\n  // N4: Alƒ±m Yeri\r\n  const purchaseCity = getCellValue(worksheet, 'N4') || undefined;\r\n  \r\n  // P1: Para Birimi\r\n  const currency = mapCurrency(getCellValue(worksheet, 'P1') || 'TRY');\r\n  \r\n  // P2: √ñncelik\r\n  const priorityRaw = getCellValue(worksheet, 'P2');\r\n  const priority = mapPriority(priorityRaw);\r\n  \r\n  // P3: Termin Tarihi\r\n  const dueDateRaw = worksheet.getCell('P3').value;\r\n  const dueDate = dueDateRaw instanceof Date ? dueDateRaw.toISOString() : mapDate(dueDateRaw?.toString());\r\n  \r\n  // P4: √ñdeme ≈ûartlarƒ± (basit parse, detaylƒ± parsing gerekirse geli≈ütirilebilir)\r\n  const paymentTermsRaw = getCellValue(worksheet, 'P4');\r\n  \r\n  return {\r\n    satfkCode,\r\n    title,\r\n    site,\r\n    purchaseCity,\r\n    currency,\r\n    priority,\r\n    dueDate,\r\n    isSealedBid: false, // Excel'den okunamazsa false\r\n  };\r\n}\r\n\r\n/**\r\n * Satƒ±r bilgilerini parse et\r\n */\r\nfunction parseLineRows(worksheet: ExcelJS.Worksheet): OfferLine[] {\r\n  const lines: OfferLine[] = [];\r\n  let rowNum = 6; // Ba≈ülangƒ±√ß satƒ±rƒ±\r\n  \r\n  // Toplam satƒ±rƒ±na kadar oku (TOPLAM yazan satƒ±ra kadar veya bo≈ü satƒ±ra kadar)\r\n  while (rowNum <= worksheet.rowCount) {\r\n    const row = worksheet.getRow(rowNum);\r\n    \r\n    // A s√ºtununda \"TOPLAM\" yazƒ±yorsa dur\r\n    const firstCell = row.getCell(1).value;\r\n    if (typeof firstCell === 'string' && firstCell.toUpperCase().includes('TOPLAM')) {\r\n      break;\r\n    }\r\n    \r\n    // Bo≈ü satƒ±r kontrol√º\r\n    const itemName = getCellValue(row, 2); // B s√ºtunu\r\n    if (!itemName || itemName.trim() === '') {\r\n      rowNum++;\r\n      continue;\r\n    }\r\n    \r\n    // Satƒ±rƒ± parse et\r\n    const line = parseLineRow(row, rowNum);\r\n    if (line) {\r\n      lines.push(line);\r\n    }\r\n    \r\n    rowNum++;\r\n  }\r\n  \r\n  return lines;\r\n}\r\n\r\n/**\r\n * Tek satƒ±rƒ± parse et\r\n */\r\nfunction parseLineRow(row: ExcelJS.Row, rowNum: number): OfferLine | null {\r\n  // B: √úr√ºn Adƒ±\r\n  const itemName = getCellValue(row, 2);\r\n  if (!itemName || itemName.trim() === '') {\r\n    return null;\r\n  }\r\n  \r\n  // C: Spec\r\n  const spec = getCellValue(row, 3) || undefined;\r\n  \r\n  // D: Marka\r\n  const brand = getCellValue(row, 4) || undefined;\r\n  \r\n  // E: Birim\r\n  const uom = getCellValue(row, 5) || '';\r\n  \r\n  // F: Miktar\r\n  const quantity = parseNumber(row, 6) || 0;\r\n  \r\n  // H: Birim Fiyat (KDV Hari√ß)\r\n  const unitPrice = parseNumber(row, 8) || 0;\r\n  \r\n  // N: KDV Oranƒ± (%)\r\n  const vatRate = parseNumber(row, 14) || 18;\r\n  \r\n  // J: Termin\r\n  const deliveryDateRaw = row.getCell(10).value;\r\n  const deliveryDate = deliveryDateRaw instanceof Date ? deliveryDateRaw.toISOString() : mapDate(deliveryDateRaw?.toString());\r\n  \r\n  // M: √ñdeme ≈ûartlarƒ± / Notlar\r\n  const notes = getCellValue(row, 13) || undefined;\r\n  \r\n  // P: KDV Dahil Birim Fiyat (hesaplanan veya form√ºlden)\r\n  const pCell = row.getCell(16);\r\n  let netUnitWithVat: number | undefined;\r\n  if (pCell.value && typeof pCell.value === 'number') {\r\n    netUnitWithVat = pCell.value;\r\n  } else {\r\n    // Hesapla\r\n    netUnitWithVat = unitPrice * (1 + vatRate / 100);\r\n  }\r\n  \r\n  // O: KDV Dahil Toplam\r\n  const oCell = row.getCell(15);\r\n  let totalWithVat: number | undefined;\r\n  if (oCell.value && typeof oCell.value === 'number') {\r\n    totalWithVat = oCell.value;\r\n  } else {\r\n    // Hesapla\r\n    totalWithVat = quantity * (netUnitWithVat || 0);\r\n  }\r\n  \r\n  // K-L: KDV Hari√ß Toplam\r\n  const kCell = row.getCell(11);\r\n  let totalExVat: number | undefined;\r\n  if (kCell.value && typeof kCell.value === 'number') {\r\n    totalExVat = kCell.value;\r\n  } else {\r\n    // Hesapla\r\n    totalExVat = quantity * unitPrice;\r\n  }\r\n  \r\n  return {\r\n    itemName: itemName.trim(),\r\n    spec,\r\n    uom,\r\n    quantity,\r\n    unitPrice,\r\n    vatRate,\r\n    deliveryDate,\r\n    brand,\r\n    notes,\r\n    netUnitWithVat,\r\n    totalExVat,\r\n    totalWithVat,\r\n  };\r\n}\r\n\r\n/**\r\n * H√ºcre deƒüerini string olarak al\r\n */\r\nfunction getCellValue(worksheet: ExcelJS.Worksheet | ExcelJS.Row, col: string | number): string {\r\n  const cell = typeof col === 'string' \r\n    ? worksheet.getCell(col) \r\n    : (worksheet as ExcelJS.Row).getCell(col);\r\n  \r\n  if (!cell || cell.value === null || cell.value === undefined) {\r\n    return '';\r\n  }\r\n  \r\n  // Form√ºl sonucunu al\r\n  if (cell.value && typeof cell.value === 'object' && 'result' in cell.value) {\r\n    return String((cell.value as any).result || '');\r\n  }\r\n  \r\n  // Tarih kontrol√º\r\n  if (cell.value instanceof Date) {\r\n    return cell.value.toISOString();\r\n  }\r\n  \r\n  return String(cell.value);\r\n}\r\n\r\n/**\r\n * H√ºcre deƒüerini number olarak al\r\n */\r\nfunction parseNumber(worksheet: ExcelJS.Worksheet | ExcelJS.Row, col: string | number): number | null {\r\n  const cell = typeof col === 'string' \r\n    ? worksheet.getCell(col) \r\n    : (worksheet as ExcelJS.Row).getCell(col);\r\n  \r\n  if (!cell || cell.value === null || cell.value === undefined) {\r\n    return null;\r\n  }\r\n  \r\n  // Form√ºl sonucunu al\r\n  if (cell.value && typeof cell.value === 'object' && 'result' in cell.value) {\r\n    const result = (cell.value as any).result;\r\n    return typeof result === 'number' ? result : null;\r\n  }\r\n  \r\n  if (typeof cell.value === 'number') {\r\n    return cell.value;\r\n  }\r\n  \r\n  if (typeof cell.value === 'string') {\r\n    const parsed = parseFloat(cell.value.replace(/[^\\d.,-]/g, '').replace(',', '.'));\r\n    return isNaN(parsed) ? null : parsed;\r\n  }\r\n  \r\n  return null;\r\n}\r\n\r\n/**\r\n * Tarayƒ±cƒ±da √ßalƒ±≈üan versiyon\r\n */\r\nexport async function importSupplierOfferBrowser(file: File): Promise<Offer> {\r\n  const arrayBuffer = await file.arrayBuffer();\r\n  return importSupplierOffer(arrayBuffer);\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\lib\\address\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\lib\\firebase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\matching\\match-service.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'debugErr' is defined but never used.","line":154,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":154,"endColumn":28}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Match Service - Firestore-based supplier matching using category IDs\n * CRITICAL: E≈üle≈üme sadece ID √ºzerinden yapƒ±lƒ±r.\n */\n\n// Teklifbul Rule v1.0 - Structured Logging\nimport { logger } from '../shared/log/logger.js';\n\nimport { collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';\n\n/**\n * Chunk array into batches of max size\n */\nfunction chunkArray(arr, chunkSize) {\n  const chunks = [];\n  for (let i = 0; i < arr.length; i += chunkSize) {\n    chunks.push(arr.slice(i, i + chunkSize));\n  }\n  return chunks;\n}\n\n/**\n * Get unique values from array\n */\nfunction uniq(arr) {\n  return Array.from(new Set(arr));\n}\n\n/**\n * Match suppliers by category IDs\n * \n * @param {Firestore} db - Firestore database instance\n * @param {object} options - Matching options\n * @param {string[]} options.categoryIds - Required: Array of category IDs (e.g., ['CAT.ELEKTRIK', 'CAT.AYDINLATMA'])\n * @param {string[]} [options.legacySlugs] - Optional: Array of legacy slugs for backward compatibility\n * @param {string[]} [options.legacyNames] - Optional: Array of legacy names for backward compatibility\n * @returns {Promise<Array>} Array of matched supplier documents\n * \n * @example\n * const suppliers = await matchSuppliers(db, {\n *   categoryIds: ['CAT.ELEKTRIK', 'CAT.AYDINLATMA'],\n *   legacySlugs: ['elektrik'], // optional backward compatibility\n *   legacyNames: ['Elektrik']  // optional backward compatibility\n * });\n */\nexport async function matchSuppliers(db, { categoryIds, legacySlugs = [], legacyNames = [] }) {\n  if (!db) {\n    throw new Error('Firestore database instance is required');\n  }\n  \n  if (!Array.isArray(categoryIds) || categoryIds.length === 0) {\n    logger.warn('matchSuppliers: categoryIds is empty, returning empty result');\n    return [];\n  }\n  \n  // Result set (Map to avoid duplicates)\n  const resultMap = new Map();\n  \n  /**\n   * Run query for a specific field\n   */\n  async function runQuery(fieldName, values, fieldLabel) {\n    if (!values || values.length === 0) {\n      return;\n    }\n    \n    const uniqueValues = uniq(values).filter(Boolean);\n    if (uniqueValues.length === 0) {\n      return;\n    }\n    \n    // Firestore limitation: array-contains-any supports max 10 values\n    const batches = chunkArray(uniqueValues, 10);\n    \n    logger.info(`Processing ${uniqueValues.length} ${fieldLabel} values in ${batches.length} batch(es)`);\n    \n    for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {\n      const batch = batches[batchIndex];\n      \n      try {\n        // CRITICAL: Firestore allows only ONE array-contains/array-contains-any per query\n        // So we must query without roles filter, then filter in JavaScript\n        // Note: We query without isActive first, then filter - some users may not have isActive set yet\n        const q = query(\n          collection(db, 'users'),\n          where(fieldName, 'array-contains-any', batch)\n        );\n        \n        const snap = await getDocs(q);\n        const totalUsers = snap.docs.length;\n        \n        // Filter results in JavaScript to check for supplier role\n        let foundCount = 0;\n        let nonSupplierCount = 0;\n        \n        snap.forEach(doc => {\n          const data = doc.data();\n          \n          // Check if user is active (default to true if field is missing)\n          const isActive = data.isActive !== false; // Only exclude if explicitly false\n          \n          // Check if user is a supplier (multiple role formats supported)\n          const isSupplier = \n            (Array.isArray(data.roles) && data.roles.includes('supplier')) ||\n            (data.roles && typeof data.roles === 'object' && data.roles.supplier === true) ||\n            (data.role === 'supplier');\n          \n          // Only add if supplier AND active\n          if (isSupplier && isActive) {\n            foundCount++;\n            // CRITICAL: Store both doc.id and doc.data() so we can return IDs\n            resultMap.set(doc.id, {\n              ...data,\n              uid: doc.id,\n              id: doc.id\n            });\n          } else {\n            nonSupplierCount++;\n          }\n        });\n        \n        // Enhanced logging for debugging\n        if (totalUsers > 0) {\n          logger.info(`Query ${batchIndex + 1}/${batches.length} [${fieldName}]: Found ${foundCount} suppliers (filtered from ${totalUsers} active users, ${nonSupplierCount} non-suppliers)`);\n        } else {\n          logger.warn(`Query ${batchIndex + 1}/${batches.length} [${fieldName}]: No active users found with matching ${fieldName} values`, { batch });\n          // Try querying without isActive filter to see if there are any users with these categories\n          try {\n            const debugQ = query(\n              collection(db, 'users'),\n              where(fieldName, 'array-contains-any', batch)\n            );\n            const debugSnap = await getDocs(debugQ);\n            if (debugSnap.docs.length > 0) {\n              const sampleData = debugSnap.docs[0].data();\n              logger.info(`Debug: Found ${debugSnap.docs.length} users with matching ${fieldName}`);\n              logger.info('Debug: Sample user data', {\n                uid: debugSnap.docs[0].id,\n                isActive: sampleData.isActive,\n                roles: sampleData.roles,\n                role: sampleData.role,\n                [fieldName]: sampleData[fieldName]?.slice(0, 3) // First 3 categories\n              });\n              logger.info(`Debug: Active users: ${debugSnap.docs.filter(d => d.data().isActive !== false).length}`);\n              logger.info(`Debug: Supplier users: ${debugSnap.docs.filter(d => {\n                const data = d.data();\n                return (Array.isArray(data.roles) && data.roles.includes('supplier')) ||\n                       (data.roles && typeof data.roles === 'object' && data.roles.supplier === true) ||\n                       (data.role === 'supplier');\n              }).length}`);\n            } else {\n              logger.info(`Debug: No users found with ${fieldName} values at all. Suppliers may need to update their categories to ID format.`);\n            }\n          } catch (debugErr) {\n            // Ignore debug query errors\n          }\n        }\n        \n      } catch (err) {\n        logger.error(`Supplier query failed [${fieldName}] batch ${batchIndex + 1}`, {\n          code: err?.code || 'unknown',\n          message: err?.message || String(err),\n          error: err\n        });\n        \n        // If it's an index error, provide helpful message\n        if (err?.code === 'failed-precondition') {\n          logger.error('This query requires a Firestore composite index');\n          logger.error(`Index needed: users collection, fields: roles (array-contains), isActive (==), ${fieldName} (array-contains-any)`);\n          if (err?.message && err.message.includes('https://')) {\n            logger.error('Index creation link (check console for full URL)', { url: err.message });\n          }\n        }\n        \n        // Re-throw to stop processing (or continue with next batch if you prefer)\n        throw err;\n      }\n    }\n  }\n  \n  // Run queries for ID-based matching (primary)\n  await runQuery('supplierCategoryIds', categoryIds, 'category IDs');\n  \n  // Run queries for backward compatibility (optional)\n  if (legacySlugs && legacySlugs.length > 0) {\n    await runQuery('supplierCategoryKeys', legacySlugs, 'legacy slugs');\n  }\n  \n  if (legacyNames && legacyNames.length > 0) {\n    await runQuery('supplierCategories', legacyNames, 'legacy names');\n  }\n  \n  const results = Array.from(resultMap.values());\n  logger.info(`Total unique suppliers matched: ${results.length}`);\n  \n  return results;\n}\n\n/**\n * Match suppliers by category IDs and return only IDs\n * \n * @param {Firestore} db - Firestore database instance\n * @param {string[]} categoryIds - Array of category IDs\n * @returns {Promise<string[]>} Array of supplier user IDs\n */\nexport async function matchSupplierIds(db, categoryIds) {\n  const suppliers = await matchSuppliers(db, { categoryIds });\n  return suppliers.map(s => s.uid || s.id).filter(Boolean);\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\modules\\categories\\routes\\categories.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":26,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[742,745],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[742,745],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1223,1226],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1223,1226],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":72,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2211,2214],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2211,2214],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":89,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2718,2721],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2718,2721],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":103,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3226,3229],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3226,3229],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Categories API Routes\r\n * Teklifbul Rule v1.0\r\n * \r\n * Firestore kullanƒ±yor - $0 maliyet\r\n */\r\n\r\nimport { Router, Request, Response } from 'express';\r\nimport { getCategories, getCategoryById, suggestCategory, saveFeedback } from '../../../services/firestore-categories';\r\n\r\nconst router = Router();\r\n\r\n// GET /api/categories - Liste\r\nrouter.get('/', async (req: Request, res: Response) => {\r\n  try {\r\n    const { q, withDesc = 'true', page = '1', size = '100' } = req.query;\r\n    \r\n    const result = await getCategories({\r\n      search: q as string | undefined,\r\n      withDesc: withDesc === 'true',\r\n      page: Number(page) || 1,\r\n      size: Math.min(Number(size) || 100, 200)\r\n    });\r\n    \r\n    res.json(result);\r\n  } catch (e: any) {\r\n    console.error('Categories list error:', e);\r\n    res.status(500).json({ error: e.message || 'Internal server error' });\r\n  }\r\n});\r\n\r\n// GET /api/categories/:id - Detay\r\nrouter.get('/:id', async (req: Request, res: Response) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const category = await getCategoryById(id);\r\n    \r\n    if (!category) {\r\n      return res.status(404).json({ error: 'Category not found' });\r\n    }\r\n    \r\n    res.json(category);\r\n  } catch (e: any) {\r\n    console.error('Category detail error:', e);\r\n    res.status(500).json({ error: e.message || 'Internal server error' });\r\n  }\r\n});\r\n\r\n// POST /api/categories/:id/desc - A√ßƒ±klama g√ºncelle (admin)\r\nrouter.post('/:id/desc', async (req: Request, res: Response) => {\r\n  try {\r\n    // TODO: Auth middleware - admin/ops kontrol√º\r\n    const { id } = req.params;\r\n    const { short_desc, examples } = req.body;\r\n    \r\n    // Firestore update\r\n    const { doc, updateDoc } = await import('firebase/firestore');\r\n    const { db } = await import('../../../lib/firebase');\r\n    \r\n    await updateDoc(doc(db, 'categories', id), {\r\n      short_desc: short_desc || null,\r\n      examples: examples || null,\r\n      updatedAt: new Date()\r\n    });\r\n    \r\n    // Cache'i temizle\r\n    const { cache } = await import('../../../services/in-memory-cache');\r\n    await cache.del(`category:${id}`);\r\n    await cache.delPattern('categories:list:*');\r\n    \r\n    res.json({ success: true });\r\n  } catch (e: any) {\r\n    console.error('Category desc update error:', e);\r\n    res.status(500).json({ error: e.message });\r\n  }\r\n});\r\n\r\n// POST /api/categories/suggest - Kategori √∂ner\r\nrouter.post('/suggest', async (req: Request, res: Response) => {\r\n  try {\r\n    const { text } = req.body;\r\n    \r\n    if (!text || typeof text !== 'string') {\r\n      return res.status(400).json({ error: 'text parameter is required' });\r\n    }\r\n    \r\n    const result = await suggestCategory(text);\r\n    res.json(result);\r\n  } catch (e: any) {\r\n    console.error('Category suggest error:', e);\r\n    res.status(500).json({ error: e.message || 'Internal server error' });\r\n  }\r\n});\r\n\r\n// POST /api/categories/feedback - Geri bildirim kaydet\r\nrouter.post('/feedback', async (req: Request, res: Response) => {\r\n  try {\r\n    const { query, suggested_category_id, chosen_category_id, user_id } = req.body;\r\n    \r\n    await saveFeedback(query, suggested_category_id, chosen_category_id, user_id);\r\n    \r\n    res.json({ success: true });\r\n  } catch (e: any) {\r\n    console.error('Category feedback error:', e);\r\n    res.status(500).json({ error: e.message || 'Internal server error' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\modules\\categories\\services\\categorySuggest.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\modules\\taxOffices\\etl-tax-offices.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":45,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1602,1605],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1602,1605],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":183,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":183,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6630,6633],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6630,6633],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":217,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":217,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7549,7552],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7549,7552],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Vergi Daireleri ETL Script\r\n * Teklifbul Rule v1.0\r\n * \r\n * Gƒ∞B PDF'den vergi dairelerini parse edip Postgres'e y√ºkler\r\n * Usage: tsx src/modules/taxOffices/etl-tax-offices.ts --input=./data/gib_tax_offices.pdf\r\n */\r\n\r\nimport 'dotenv/config';\r\nimport { readFileSync } from 'fs';\r\nimport { join } from 'path';\r\nimport { createRequire } from 'module';\r\nimport { getPgPool } from '../../db/connection';\r\n\r\n// pdfjs-dist kullanarak PDF parse (pdf-parse √ßalƒ±≈ümadƒ±ƒüƒ± i√ßin)\r\nconst require = createRequire(import.meta.url);\r\nconst pdfjsLib = require('pdfjs-dist/legacy/build/pdf.js');\r\n\r\ninterface TaxOffice {\r\n  province_name: string;\r\n  district_name: string;\r\n  office_name: string;\r\n  office_code: string;\r\n  office_type: 'VD' | 'MALMUDURLUGU';\r\n}\r\n\r\n// PDF'den tablo parse etme (pdfjs-dist kullanarak)\r\nasync function parsePdfToOffices(pdfPath: string): Promise<TaxOffice[]> {\r\n  const buffer = readFileSync(pdfPath);\r\n  const data = new Uint8Array(buffer);\r\n  const loadingTask = pdfjsLib.getDocument({ data });\r\n  const pdf = await loadingTask.promise;\r\n  \r\n  // T√ºm sayfalarƒ± oku - Y koordinatƒ±na g√∂re satƒ±r bazƒ±nda grupla (daha hassas)\r\n  const offices: TaxOffice[] = [];\r\n  let currentProvince = ''; // ƒ∞l bilgisini sayfalar arasƒ± ta≈üƒ±\r\n  \r\n  for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {\r\n    const page = await pdf.getPage(pageNum);\r\n    const textContent = await page.getTextContent();\r\n    \r\n    // Y koordinatƒ±na g√∂re item'larƒ± grupla (satƒ±rlar) - daha hassas yuvarlama\r\n    const rows: Map<string, string[]> = new Map();\r\n    \r\n    for (const item of textContent.items as any[]) {\r\n      // Y koordinatƒ±nƒ± daha hassas yuvarla (0.5 tolerance)\r\n      const y = Math.round(item.transform[5] * 2) / 2;\r\n      const yKey = y.toFixed(1);\r\n      \r\n      if (!rows.has(yKey)) {\r\n        rows.set(yKey, []);\r\n      }\r\n      if (item.str && item.str.trim().length > 0) {\r\n        rows.get(yKey)!.push(item.str);\r\n      }\r\n    }\r\n    \r\n    // Y koordinatƒ±na g√∂re sƒ±rala (yukarƒ±dan a≈üaƒüƒ±ya)\r\n    const sortedRows = Array.from(rows.entries()).sort((a, b) => parseFloat(b[0]) - parseFloat(a[0]));\r\n    \r\n    // Debug: ƒ∞lk 20 satƒ±rƒ± g√∂ster (sadece ilk sayfa)\r\n    if (pageNum === 1) {\r\n      console.info(`\\nüìã ƒ∞lk sayfa - ƒ∞lk 20 satƒ±r (debug):`);\r\n      sortedRows.slice(0, 20).forEach(([yKey, items], idx) => {\r\n        const lineText = items.join(' ').trim();\r\n        if (lineText.length > 20) {\r\n          console.info(`${idx + 1}. [Y:${yKey}] ${lineText.substring(0, 120)}`);\r\n        }\r\n      });\r\n      console.info('---\\n');\r\n    }\r\n    \r\n    // Her satƒ±rƒ± parse et\r\n  for (const [_yKey, items] of sortedRows) {\r\n      const lineText = items.join(' ').trim();\r\n      \r\n      // √áok kƒ±sa satƒ±rlarƒ± atla\r\n      if (lineText.length < 20) continue;\r\n      \r\n      // Ba≈ülƒ±k satƒ±rlarƒ±nƒ± atla\r\n      if (lineText.includes('DEFTERDARLIK') || lineText.includes('SIRA ƒ∞L') || (lineText.includes('GENEL') && lineText.includes('SIRA'))) {\r\n        continue;\r\n      }\r\n      \r\n      // √áoklu bo≈üluklarƒ± tek bo≈üluƒüa indir\r\n      const normalized = lineText.replace(/\\s+/g, ' ').trim();\r\n      \r\n      // Format 1: \"[sƒ±ra] [plaka] [ƒ∞L] [ƒ∞L√áE] [kod] [Daire]\"\r\n      // √ñrnek: \"1 01 ADANA Merkez 01250 Adana ƒ∞htisas Vergi Dairesi M√ºd√ºrl√ºƒü√º\"\r\n      let match = normalized.match(/^(\\d{1,4})\\s+(\\d{2})\\s+([A-Z√áƒûƒ∞√ñ≈û√ú\\s]{2,30})\\s+([A-Z√áƒûƒ∞√ñ≈û√ú\\w\\s\\(\\)\\*\\*\\s]{0,60})\\s+(\\d{5})\\s+(.+)$/);\r\n      \r\n      let province = '';\r\n      let district = 'Merkez';\r\n      let officeCode = '';\r\n      let officeName = '';\r\n      \r\n      if (match) {\r\n  const [, _sƒ±raNo, _plaka, il, il√ße, kod, daireAdƒ±] = match;\r\n        province = normalizeProvinceName(il.trim());\r\n        district = normalizeDistrictName(il√ße.replace(/\\*\\*/g, '').replace(/\\(6360.*?\\)/gi, '').trim() || 'Merkez');\r\n        officeName = normalizeOfficeName(daireAdƒ±.trim());\r\n        officeCode = kod.trim();\r\n      } else {\r\n        // Format 2: \"[ƒ∞L√áE] [kod] [Daire]\" (sƒ±ra ve il eksik, √∂nceki il kullanƒ±lƒ±r)\r\n        // √ñrnek: \"Merkez 01251 5 Ocak Vergi Dairesi M√ºd√ºrl√ºƒü√º\"\r\n        match = normalized.match(/^([A-Z√áƒûƒ∞√ñ≈û√ú\\w\\s\\(\\)\\*\\*\\s]{1,60})\\s+(\\d{5})\\s+(.+)$/);\r\n        if (match && currentProvince) {\r\n          const [, il√ße, kod, daireAdƒ±] = match;\r\n          province = currentProvince;\r\n          district = normalizeDistrictName(il√ße.replace(/\\*\\*/g, '').replace(/\\(6360.*?\\)/gi, '').trim() || 'Merkez');\r\n          officeName = normalizeOfficeName(daireAdƒ±.trim());\r\n          officeCode = kod.trim();\r\n        } else {\r\n          continue; // Parse edilemedi\r\n        }\r\n      }\r\n      \r\n      // Office type tespiti\r\n      const officeType: 'VD' | 'MALMUDURLUGU' = \r\n        officeName.toUpperCase().includes('MALM√úD√úRL√úƒû√ú') || officeName.toUpperCase().includes('MALMUDURLUGU')\r\n          ? 'MALMUDURLUGU'\r\n          : 'VD';\r\n      \r\n      if (officeCode && /^\\d{5}$/.test(officeCode) && province && officeName && officeName.length > 5) {\r\n        offices.push({\r\n          province_name: province,\r\n          district_name: district,\r\n          office_name: officeName,\r\n          office_code: officeCode,\r\n          office_type: officeType\r\n        });\r\n        // ƒ∞l bilgisini g√ºncelle (bir sonraki satƒ±rlar i√ßin)\r\n        currentProvince = province;\r\n      }\r\n    }\r\n  }\r\n  \r\n  return offices;\r\n}\r\n\r\nfunction normalizeProvinceName(name: string): string {\r\n  return name.trim().toUpperCase()\r\n    .replace(/ƒ∞/g, 'ƒ∞')\r\n    .replace(/ƒ±/g, 'I');\r\n}\r\n\r\nfunction normalizeDistrictName(name: string): string {\r\n  return name.trim()\r\n    .replace(/\\s+/g, ' ');\r\n}\r\n\r\nfunction normalizeOfficeName(name: string): string {\r\n  return name.trim()\r\n    .replace(/\\s+/g, ' ')\r\n    .replace(/MALM√úD√úRL√úƒû√ú/gi, 'Malm√ºd√ºrl√ºƒü√º')\r\n    .replace(/VERGƒ∞ DAƒ∞RESƒ∞/gi, 'Vergi Dairesi');\r\n}\r\n\r\nasync function upsertOffices(offices: TaxOffice[]): Promise<void> {\r\n  const pool = getPgPool();\r\n  const client = await pool.connect();\r\n  \r\n  try {\r\n    await client.query('BEGIN');\r\n    \r\n    for (const office of offices) {\r\n      await client.query(\r\n        `INSERT INTO tax_offices (province_name, district_name, office_name, office_code, office_type, updated_at)\r\n         VALUES ($1, $2, $3, $4, $5, now())\r\n         ON CONFLICT (office_code) \r\n         DO UPDATE SET \r\n           province_name = $1,\r\n           district_name = $2,\r\n           office_name = $3,\r\n           office_type = $5,\r\n           updated_at = now()`,\r\n        [office.province_name, office.district_name, office.office_name, office.office_code, office.office_type]\r\n      );\r\n    }\r\n    \r\n  await client.query('COMMIT');\r\n  console.info(`‚úÖ ${offices.length} vergi dairesi upsert edildi`);\r\n  } catch (e: any) {\r\n    await client.query('ROLLBACK');\r\n    throw e;\r\n  } finally {\r\n    client.release();\r\n  }\r\n}\r\n\r\nasync function main() {\r\n  const args = process.argv.slice(2);\r\n  const inputArg = args.find(arg => arg.startsWith('--input='));\r\n  \r\n  if (!inputArg) {\r\n    console.error('Usage: tsx etl-tax-offices.ts --input=./data/gib_tax_offices.pdf');\r\n    process.exit(1);\r\n  }\r\n  \r\n  const inputPath = inputArg.split('=')[1];\r\n  const fullPath = join(process.cwd(), inputPath);\r\n  \r\n  console.info(`üìÑ PDF okunuyor: ${fullPath}`);\r\n  \r\n  try {\r\n    const offices = await parsePdfToOffices(fullPath);\r\n  console.info(`üìä ${offices.length} vergi dairesi parse edildi`);\r\n    \r\n    if (offices.length === 0) {\r\n      console.warn('‚ö†Ô∏è  Hi√ß vergi dairesi bulunamadƒ±. PDF formatƒ±nƒ± kontrol edin.');\r\n      process.exit(1);\r\n    }\r\n    \r\n  await upsertOffices(offices);\r\n  console.info('‚úÖ ETL tamamlandƒ±');\r\n    \r\n  } catch (e: any) {\r\n    console.error('‚ùå ETL hatasƒ±:', e);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nmain().catch(console.error);\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\modules\\taxOffices\\routes\\taxOffices.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[505,508],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[505,508],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":45,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1376,1379],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1376,1379],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Tax Offices API Routes\r\n * Teklifbul Rule v1.0\r\n * \r\n * Firestore + In-Memory Cache kullanƒ±yor - $0 maliyet\r\n */\r\n\r\nimport { Router, Request, Response } from 'express';\r\nimport { getProvinces, getTaxOffices } from '../../../services/firestore-tax-offices';\r\n\r\nconst router = Router();\r\n\r\n// GET /api/tax-offices/provinces - ƒ∞l listesi\r\nrouter.get('/provinces', async (req: Request, res: Response) => {\r\n  try {\r\n    const provinces = await getProvinces();\r\n    res.json(provinces);\r\n  } catch (e: any) {\r\n    console.error('Tax offices provinces error:', e);\r\n    res.status(500).json({ error: e.message || 'Internal server error' });\r\n  }\r\n});\r\n\r\n// GET /api/tax-offices - ƒ∞l/ƒ∞l√ße bazlƒ± vergi daireleri listesi\r\nrouter.get('/', async (req: Request, res: Response) => {\r\n  try {\r\n    let { province, district } = req.query;\r\n    \r\n    if (!province || typeof province !== 'string') {\r\n      return res.status(400).json({ error: 'province parameter is required' });\r\n    }\r\n    \r\n    // URL decode ve normalize - Teklifbul Rule v1.0\r\n    province = decodeURIComponent(province).trim();\r\n    if (district && typeof district === 'string') {\r\n      district = decodeURIComponent(district).trim();\r\n    }\r\n    \r\n    const offices = await getTaxOffices({\r\n      province,\r\n      district: district as string | undefined\r\n    });\r\n    \r\n    res.json(offices);\r\n  } catch (e: any) {\r\n    console.error('Tax offices list error:', e);\r\n    res.status(500).json({ error: e.message || 'Internal server error' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\pages\\Dashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\pages\\Login.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'user' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":11,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1090,1093],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1090,1093],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from \"react\";\r\nimport { auth } from \"../lib/firebase\";\r\nimport { signInWithEmailAndPassword, createUserWithEmailAndPassword } from \"firebase/auth\";\r\nimport { useAuth } from \"../context/AuthContext\";\r\n\r\nexport default function Login() {\r\n  const [email, setEmail] = useState(\"\");\r\n  const [password, setPassword] = useState(\"\");\r\n  const [isLogin, setIsLogin] = useState(true);\r\n  const [loading, setLoading] = useState(false);\r\n  const { user } = useAuth();\r\n\r\n  // Kullanƒ±cƒ± varsa guard zaten y√∂nlendirecek, burada navigate etmeye gerek yok\r\n  // PublicRoute zaten kontrol ediyor\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n    try {\r\n      if (isLogin) {\r\n        // Giri≈ü yap\r\n        await signInWithEmailAndPassword(auth, email, password);\r\n        // Guard otomatik y√∂nlendirecek, navigate gerekmez\r\n      } else {\r\n        // Kayƒ±t ol\r\n        await createUserWithEmailAndPassword(auth, email, password);\r\n        // Guard otomatik y√∂nlendirecek, navigate gerekmez\r\n      }\r\n    } catch (err: any) {\r\n      alert(\"‚ö†Ô∏è Hata: \" + err.message);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div style={{ maxWidth: 320, margin: \"80px auto\", textAlign: \"center\" }}>\r\n      <h2>{isLogin ? \"Giri≈ü Yap\" : \"Kayƒ±t Ol\"}</h2>\r\n      <form onSubmit={handleSubmit}>\r\n        <input\r\n          type=\"email\"\r\n          placeholder=\"E-posta\"\r\n          value={email}\r\n          onChange={(e) => setEmail(e.target.value)}\r\n          required\r\n          style={{ padding: 8, width: \"100%\", marginBottom: 10 }}\r\n        />\r\n        <input\r\n          type=\"password\"\r\n          placeholder=\"≈ûifre\"\r\n          value={password}\r\n          onChange={(e) => setPassword(e.target.value)}\r\n          required\r\n          style={{ padding: 8, width: \"100%\", marginBottom: 10 }}\r\n        />\r\n        <button\r\n          type=\"submit\"\r\n          disabled={loading}\r\n          style={{ padding: 10, width: \"100%\", cursor: \"pointer\" }}\r\n        >\r\n          {loading ? \"ƒ∞≈üleniyor...\" : isLogin ? \"Giri≈ü Yap\" : \"Kayƒ±t Ol\"}\r\n        </button>\r\n      </form>\r\n\r\n      <p\r\n        onClick={() => setIsLogin(!isLogin)}\r\n        style={{ cursor: \"pointer\", color: \"blue\", marginTop: 12 }}\r\n      >\r\n        {isLogin ? \"Hesabƒ±n yok mu? Kayƒ±t ol\" : \"Zaten √ºye misin? Giri≈ü yap\"}\r\n      </p>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\pages\\demands\\[id]\\OfferTab.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Controller' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":34,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":44},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'OfferLine' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":30,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'OfferHeader' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":41,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":52},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'createCurrencyInfo' is defined but never used. Allowed unused vars must match /^_/u.","line":12,"column":32,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'formatPaymentTerms' is defined but never used. Allowed unused vars must match /^_/u.","line":77,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":77,"endColumn":28},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":77,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2705,2708],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2705,2708],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'demandId' is defined but never used. Allowed unused args must match /^_/u.","line":98,"column":36,"nodeType":null,"messageId":"unusedVar","endLine":98,"endColumn":44},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":100,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3703,3706],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3703,3706],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'errors' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":132,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":132,"endColumn":24},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":195,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":195,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6591,6594],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6591,6594],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Teklif Sekmesi - React Komponenti\r\n * \r\n * Talep detay sayfasƒ±nda tedarik√ßinin tek ekranda teklif doldurmasƒ±nƒ± saƒülar.\r\n */\r\n\r\nimport React, { useState, useEffect, useMemo } from 'react';\r\nimport { useForm, useFieldArray, Controller } from 'react-hook-form';\r\nimport { zodResolver } from '@hookform/resolvers/zod';\r\nimport { OfferSchema, Offer, OfferLine, OfferHeader, Currency } from '../../../domain/offer/schema';\r\nimport { mapDemandToOfferHeader, mapDemandItemsToOfferLines, calculateDifference, DifferenceResult } from '../../../domain/offer/mapping';\r\nimport { requiresCurrencyInfo, createCurrencyInfo, getCurrencyNameTR } from '../../../services/currency';\r\nimport type { DemandData } from '../../../domain/offer/schema';\r\n\r\ninterface OfferTabProps {\r\n  demandId: string;\r\n  demandData: DemandData;\r\n  onSubmit?: (offer: Offer) => Promise<void>;\r\n}\r\n\r\n/**\r\n * Hesaplama fonksiyonlarƒ±\r\n */\r\nfunction calculateNetUnitWithVat(unitPrice: number, vatRate: number): number {\r\n  return unitPrice * (1 + vatRate / 100);\r\n}\r\n\r\nfunction calculateTotalExVat(quantity: number, unitPrice: number): number {\r\n  return quantity * unitPrice;\r\n}\r\n\r\nfunction calculateTotalWithVat(quantity: number, netUnitWithVat: number): number {\r\n  return quantity * netUnitWithVat;\r\n}\r\n\r\n/**\r\n * Fark g√∂sterimi komponenti\r\n */\r\nfunction DifferenceBadge({ diff }: { diff: DifferenceResult }) {\r\n  if (!diff.hasDifference) return null;\r\n  \r\n  const badges: JSX.Element[] = [];\r\n  \r\n  if (diff.quantityDiff !== undefined && diff.quantityDiff !== 0) {\r\n    const sign = diff.quantityDiff > 0 ? '+' : '';\r\n    badges.push(\r\n      <span key=\"qty\" style={{ backgroundColor: '#fef3c7', padding: '2px 6px', borderRadius: '4px', fontSize: '11px', marginLeft: '4px' }}>\r\n        {sign}{diff.quantityDiff}\r\n      </span>\r\n    );\r\n  }\r\n  \r\n  if (diff.pricePercentDiff !== undefined && diff.pricePercentDiff !== 0) {\r\n    const sign = diff.pricePercentDiff > 0 ? '+' : '';\r\n    badges.push(\r\n      <span key=\"price\" style={{ backgroundColor: diff.pricePercentDiff > 0 ? '#fee2e2' : '#d1fae5', padding: '2px 6px', borderRadius: '4px', fontSize: '11px', marginLeft: '4px' }}>\r\n        %{sign}{diff.pricePercentDiff.toFixed(1)}\r\n      </span>\r\n    );\r\n  }\r\n  \r\n  if (diff.deliveryDateDiff !== undefined && diff.deliveryDateDiff !== 0) {\r\n    const sign = diff.deliveryDateDiff > 0 ? '+' : '';\r\n    badges.push(\r\n      <span key=\"date\" style={{ backgroundColor: '#dbeafe', padding: '2px 6px', borderRadius: '4px', fontSize: '11px', marginLeft: '4px' }}>\r\n        {sign}{diff.deliveryDateDiff} g√ºn\r\n      </span>\r\n    );\r\n  }\r\n  \r\n  return <>{badges}</>;\r\n}\r\n\r\n/**\r\n * √ñdeme ≈üartlarƒ± metni olu≈ütur\r\n */\r\nfunction formatPaymentTerms(terms: any): string {\r\n  if (!terms || !terms.type) return '';\r\n  \r\n  switch (terms.type) {\r\n    case 'pesin_escrow':\r\n      return `Pe≈üin (Escrow${terms.escrowDays ? ` / ${terms.escrowDays} g√ºn` : ''})`;\r\n    case 'pesin_teslim_onay':\r\n      return `Pe≈üin (Teslim&Onay${terms.deliveryConfirmDays ? ` / ${terms.deliveryConfirmDays} g√ºn` : ''})`;\r\n    case 'pesin_on_odeme':\r\n      return `Pe≈üin (√ñn √ñdeme %${terms.advancePercent || 0})`;\r\n    case 'kredi_karti':\r\n      return `Kredi Kartƒ± (${terms.installments || 1} taksit${terms.financeRate ? ` / %${terms.financeRate} faiz` : ''})`;\r\n    case 'acik_hesap':\r\n      return `A√ßƒ±k Hesap (${terms.dueDays || 30} g√ºn)`;\r\n    case 'evrak_cek':\r\n      return `Evrak/√áek (${terms.checkCount || 1} adet)`;\r\n    default:\r\n      return '';\r\n  }\r\n}\r\n\r\nexport default function OfferTab({ demandId, demandData, onSubmit }: OfferTabProps) {\r\n  const [showCurrencySection, setShowCurrencySection] = useState(false);\r\n  const [currencyInfo, setCurrencyInfo] = useState<any>(null);\r\n  \r\n  // Form ba≈ülangƒ±√ß deƒüerleri\r\n  const defaultValues = useMemo(() => {\r\n    const header = mapDemandToOfferHeader(demandData);\r\n    const lines = mapDemandItemsToOfferLines(demandData);\r\n    \r\n    // Hesaplanan deƒüerleri doldur\r\n    const linesWithCalculations = lines.map(line => ({\r\n      ...line,\r\n      netUnitWithVat: calculateNetUnitWithVat(line.unitPrice || 0, line.vatRate || 18),\r\n      totalExVat: calculateTotalExVat(line.quantity || 0, line.unitPrice || 0),\r\n      totalWithVat: calculateTotalWithVat(\r\n        line.quantity || 0,\r\n        calculateNetUnitWithVat(line.unitPrice || 0, line.vatRate || 18)\r\n      ),\r\n    }));\r\n    \r\n    return {\r\n      header,\r\n      lines: linesWithCalculations,\r\n      currencyInfo: null,\r\n      validUntil: undefined,\r\n    };\r\n  }, [demandData]);\r\n  \r\n  const {\r\n    register,\r\n    control,\r\n    handleSubmit,\r\n    watch,\r\n    setValue,\r\n    formState: { errors },\r\n  } = useForm<Offer>({\r\n    resolver: zodResolver(OfferSchema),\r\n    defaultValues,\r\n  });\r\n  \r\n  const { fields, append, remove } = useFieldArray({\r\n    control,\r\n    name: 'lines',\r\n  });\r\n  \r\n  const watchedLines = watch('lines');\r\n  const watchedCurrency = watch('header.currency');\r\n  \r\n  // Para birimi deƒüi≈ütiƒüinde kur b√∂l√ºm√ºn√º g√∂ster/gizle\r\n  useEffect(() => {\r\n    if (watchedCurrency && requiresCurrencyInfo(watchedCurrency as Currency)) {\r\n      setShowCurrencySection(true);\r\n    } else {\r\n      setShowCurrencySection(false);\r\n      setCurrencyInfo(null);\r\n    }\r\n  }, [watchedCurrency]);\r\n  \r\n  // Satƒ±r deƒüi≈ütiƒüinde hesaplamalarƒ± g√ºncelle\r\n  useEffect(() => {\r\n    watchedLines.forEach((line, index) => {\r\n      const quantity = line.quantity || 0;\r\n      const unitPrice = line.unitPrice || 0;\r\n      const vatRate = line.vatRate || 18;\r\n      \r\n      const netUnitWithVat = calculateNetUnitWithVat(unitPrice, vatRate);\r\n      const totalExVat = calculateTotalExVat(quantity, unitPrice);\r\n      const totalWithVat = calculateTotalWithVat(quantity, netUnitWithVat);\r\n      \r\n      setValue(`lines.${index}.netUnitWithVat`, netUnitWithVat);\r\n      setValue(`lines.${index}.totalExVat`, totalExVat);\r\n      setValue(`lines.${index}.totalWithVat`, totalWithVat);\r\n    });\r\n  }, [watchedLines, setValue]);\r\n  \r\n  const onSubmitForm = async (data: Offer) => {\r\n    try {\r\n      if (currencyInfo) {\r\n        data.currencyInfo = currencyInfo;\r\n      }\r\n      \r\n      if (onSubmit) {\r\n        await onSubmit(data);\r\n      } else {\r\n        // Default: API'ye g√∂nder\r\n        const response = await fetch('/api/offers', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify(data),\r\n        });\r\n        \r\n        if (!response.ok) {\r\n          throw new Error('Teklif g√∂nderilemedi');\r\n        }\r\n        \r\n        alert('Teklif ba≈üarƒ±yla g√∂nderildi!');\r\n      }\r\n    } catch (error: any) {\r\n      alert(`Hata: ${error.message}`);\r\n    }\r\n  };\r\n  \r\n  return (\r\n    <div style={{ padding: '20px', maxWidth: '1400px', margin: '0 auto' }}>\r\n      <h2 style={{ marginBottom: '20px' }}>Teklif Formu</h2>\r\n      \r\n      <form onSubmit={handleSubmit(onSubmitForm)}>\r\n        {/* Ba≈ülƒ±k Bilgileri */}\r\n        <div style={{ backgroundColor: '#fff', padding: '20px', borderRadius: '8px', marginBottom: '20px', border: '1px solid #e5e7eb' }}>\r\n          <h3 style={{ marginBottom: '16px' }}>Ba≈ülƒ±k Bilgileri</h3>\r\n          \r\n          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '16px' }}>\r\n            <div>\r\n              <label>SATFK Kodu</label>\r\n              <input {...register('header.satfkCode')} readOnly style={{ width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '4px' }} />\r\n            </div>\r\n            <div>\r\n              <label>Ba≈ülƒ±k</label>\r\n              <input {...register('header.title')} readOnly style={{ width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '4px' }} />\r\n            </div>\r\n            <div>\r\n              <label>≈ûantiye</label>\r\n              <input {...register('header.site')} style={{ width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '4px' }} />\r\n            </div>\r\n            <div>\r\n              <label>Alƒ±m Yeri (ƒ∞l)</label>\r\n              <input {...register('header.purchaseCity')} style={{ width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '4px' }} />\r\n            </div>\r\n            <div>\r\n              <label>Para Birimi</label>\r\n              <select {...register('header.currency')} style={{ width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '4px' }}>\r\n                <option value=\"TRY\">TRY - T√ºrk Lirasƒ±</option>\r\n                <option value=\"USD\">USD - Dolar</option>\r\n                <option value=\"EUR\">EUR - Euro</option>\r\n                <option value=\"GBP\">GBP - Sterlin</option>\r\n              </select>\r\n            </div>\r\n            <div>\r\n              <label>Termin Tarihi</label>\r\n              <input\r\n                type=\"date\"\r\n                {...register('header.dueDate')}\r\n                style={{ width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '4px' }}\r\n              />\r\n            </div>\r\n          </div>\r\n        </div>\r\n        \r\n        {/* Kur Bilgileri (TRY dƒ±≈üƒ± i√ßin) */}\r\n        {showCurrencySection && (\r\n          <div style={{ backgroundColor: '#f0f9ff', padding: '20px', borderRadius: '8px', marginBottom: '20px', border: '1px solid #bae6fd' }}>\r\n            <h3 style={{ marginBottom: '16px' }}>Kur Bilgileri</h3>\r\n            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px' }}>\r\n              <div>\r\n                <label>Para Birimi</label>\r\n                <input value={getCurrencyNameTR(watchedCurrency as Currency)} readOnly style={{ width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '4px' }} />\r\n              </div>\r\n              <div>\r\n                <label>Kur</label>\r\n                <input\r\n                  type=\"number\"\r\n                  step=\"0.0001\"\r\n                  onChange={(e) => setCurrencyInfo({ ...currencyInfo, fxRate: parseFloat(e.target.value) })}\r\n                  style={{ width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '4px' }}\r\n                />\r\n              </div>\r\n              <div>\r\n                <label>Kur Tarihi</label>\r\n                <input\r\n                  type=\"date\"\r\n                  onChange={(e) => setCurrencyInfo({ ...currencyInfo, fxDate: new Date(e.target.value).toISOString() })}\r\n                  style={{ width: '100%', padding: '8px', border: '1px solid #d1d5db', borderRadius: '4px' }}\r\n                />\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n        \r\n        {/* √úr√ºn Satƒ±rlarƒ± */}\r\n        <div style={{ backgroundColor: '#fff', padding: '20px', borderRadius: '8px', marginBottom: '20px', border: '1px solid #e5e7eb', overflowX: 'auto' }}>\r\n          <h3 style={{ marginBottom: '16px' }}>√úr√ºn Satƒ±rlarƒ±</h3>\r\n          \r\n          <table style={{ width: '100%', borderCollapse: 'collapse', minWidth: '1200px' }}>\r\n            <thead>\r\n              <tr style={{ backgroundColor: '#f9fafb', borderBottom: '2px solid #e5e7eb' }}>\r\n                <th style={{ padding: '12px', textAlign: 'left', border: '1px solid #e5e7eb' }}>√úr√ºn Adƒ±</th>\r\n                <th style={{ padding: '12px', textAlign: 'left', border: '1px solid #e5e7eb' }}>Miktar</th>\r\n                <th style={{ padding: '12px', textAlign: 'left', border: '1px solid #e5e7eb' }}>Birim</th>\r\n                <th style={{ padding: '12px', textAlign: 'left', border: '1px solid #e5e7eb' }}>Birim Fiyat (KDV Hari√ß)</th>\r\n                <th style={{ padding: '12px', textAlign: 'left', border: '1px solid #e5e7eb' }}>KDV Oranƒ± (%)</th>\r\n                <th style={{ padding: '12px', textAlign: 'left', border: '1px solid #e5e7eb' }}>KDV Dahil Birim Fiyat</th>\r\n                <th style={{ padding: '12px', textAlign: 'left', border: '1px solid #e5e7eb' }}>KDV Hari√ß Toplam</th>\r\n                <th style={{ padding: '12px', textAlign: 'left', border: '1px solid #e5e7eb' }}>KDV Dahil Toplam</th>\r\n                <th style={{ padding: '12px', textAlign: 'left', border: '1px solid #e5e7eb' }}>√ñdeme ≈ûartlarƒ±</th>\r\n                <th style={{ padding: '12px', textAlign: 'left', border: '1px solid #e5e7eb' }}>Termin</th>\r\n                <th style={{ padding: '12px', textAlign: 'left', border: '1px solid #e5e7eb' }}>Aksiyon</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              {fields.map((field, index) => {\r\n                const line = watchedLines[index];\r\n                const diff = calculateDifference(\r\n                  { demandQuantity: line.demandQuantity, demandUnitPrice: line.demandUnitPrice, demandDeliveryDate: line.demandDeliveryDate, demandUom: line.demandUom },\r\n                  line\r\n                );\r\n                const bgColor = diff.hasDifference ? '#fef3c7' : 'transparent';\r\n                \r\n                return (\r\n                  <tr key={field.id} style={{ backgroundColor: bgColor }}>\r\n                    <td style={{ padding: '8px', border: '1px solid #e5e7eb' }}>\r\n                      <input\r\n                        {...register(`lines.${index}.itemName`)}\r\n                        style={{ width: '100%', padding: '6px', border: '1px solid #d1d5db', borderRadius: '4px' }}\r\n                      />\r\n                    </td>\r\n                    <td style={{ padding: '8px', border: '1px solid #e5e7eb' }}>\r\n                      <input\r\n                        type=\"number\"\r\n                        step=\"0.01\"\r\n                        {...register(`lines.${index}.quantity`, { valueAsNumber: true })}\r\n                        style={{ width: '100%', padding: '6px', border: '1px solid #d1d5db', borderRadius: '4px' }}\r\n                      />\r\n                      <DifferenceBadge diff={diff} />\r\n                    </td>\r\n                    <td style={{ padding: '8px', border: '1px solid #e5e7eb' }}>\r\n                      <input\r\n                        {...register(`lines.${index}.uom`)}\r\n                        style={{ width: '100%', padding: '6px', border: '1px solid #d1d5db', borderRadius: '4px' }}\r\n                      />\r\n                    </td>\r\n                    <td style={{ padding: '8px', border: '1px solid #e5e7eb' }}>\r\n                      <input\r\n                        type=\"number\"\r\n                        step=\"0.01\"\r\n                        {...register(`lines.${index}.unitPrice`, { valueAsNumber: true })}\r\n                        style={{ width: '100%', padding: '6px', border: '1px solid #d1d5db', borderRadius: '4px' }}\r\n                      />\r\n                    </td>\r\n                    <td style={{ padding: '8px', border: '1px solid #e5e7eb' }}>\r\n                      <input\r\n                        type=\"number\"\r\n                        step=\"0.01\"\r\n                        {...register(`lines.${index}.vatRate`, { valueAsNumber: true })}\r\n                        style={{ width: '100%', padding: '6px', border: '1px solid #d1d5db', borderRadius: '4px' }}\r\n                      />\r\n                    </td>\r\n                    <td style={{ padding: '8px', border: '1px solid #e5e7eb', backgroundColor: '#f9fafb' }}>\r\n                      {line.netUnitWithVat?.toFixed(2) || '0.00'}\r\n                    </td>\r\n                    <td style={{ padding: '8px', border: '1px solid #e5e7eb', backgroundColor: '#f9fafb' }}>\r\n                      {line.totalExVat?.toFixed(2) || '0.00'}\r\n                    </td>\r\n                    <td style={{ padding: '8px', border: '1px solid #e5e7eb', backgroundColor: '#f9fafb' }}>\r\n                      {line.totalWithVat?.toFixed(2) || '0.00'}\r\n                    </td>\r\n                    <td style={{ padding: '8px', border: '1px solid #e5e7eb' }}>\r\n                      <input\r\n                        placeholder=\"Pe≈üin, Kredi Kartƒ±, vb.\"\r\n                        style={{ width: '100%', padding: '6px', border: '1px solid #d1d5db', borderRadius: '4px', fontSize: '12px' }}\r\n                      />\r\n                    </td>\r\n                    <td style={{ padding: '8px', border: '1px solid #e5e7eb' }}>\r\n                      <input\r\n                        type=\"date\"\r\n                        {...register(`lines.${index}.deliveryDate`)}\r\n                        style={{ width: '100%', padding: '6px', border: '1px solid #d1d5db', borderRadius: '4px' }}\r\n                      />\r\n                    </td>\r\n                    <td style={{ padding: '8px', border: '1px solid #e5e7eb' }}>\r\n                      <button type=\"button\" onClick={() => remove(index)} style={{ padding: '6px 12px', backgroundColor: '#ef4444', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>\r\n                        Sil\r\n                      </button>\r\n                    </td>\r\n                  </tr>\r\n                );\r\n              })}\r\n            </tbody>\r\n          </table>\r\n          \r\n          <button\r\n            type=\"button\"\r\n            onClick={() => append({\r\n              itemName: '',\r\n              uom: '',\r\n              quantity: 0,\r\n              unitPrice: 0,\r\n              vatRate: 18,\r\n              netUnitWithVat: 0,\r\n              totalExVat: 0,\r\n              totalWithVat: 0,\r\n            })}\r\n            style={{ marginTop: '12px', padding: '10px 20px', backgroundColor: '#10b981', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}\r\n          >\r\n            + Satƒ±r Ekle\r\n          </button>\r\n        </div>\r\n        \r\n        {/* G√∂nder Butonu */}\r\n        <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '12px' }}>\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => {/* Excel export */}}\r\n            style={{ padding: '12px 24px', backgroundColor: '#6b7280', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}\r\n          >\r\n            Excel ƒ∞ndir\r\n          </button>\r\n          <button\r\n            type=\"submit\"\r\n            style={{ padding: '12px 24px', backgroundColor: '#2563eb', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontWeight: 'bold' }}\r\n          >\r\n            Teklifi G√∂nder\r\n          </button>\r\n        </div>\r\n      </form>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\price-comparison.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\services\\currency.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\services\\firestore-categories.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'where' is defined but never used. Allowed unused vars must match /^_/u.","line":12,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setDoc' is defined but never used. Allowed unused vars must match /^_/u.","line":16,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":16,"endColumn":9},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'limit' is defined but never used. Allowed unused vars must match /^_/u.","line":19,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":19,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'startAfter' is defined but never used. Allowed unused vars must match /^_/u.","line":20,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'QueryDocumentSnapshot' is defined but never used. Allowed unused vars must match /^_/u.","line":21,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DocumentData' is defined but never used. Allowed unused vars must match /^_/u.","line":22,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[550,553],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[550,553],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":32,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[570,573],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[570,573],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1283,1286],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1283,1286],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":77,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1553,1556],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1553,1556],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'short_desc' is defined but never used. Allowed unused args must match /^_/u.","line":110,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":110,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'examples' is defined but never used. Allowed unused args must match /^_/u.","line":110,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":110,"endColumn":46},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":125,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":125,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2888,2891],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2888,2891],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":159,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":159,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3689,3692],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3689,3692],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":251,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":251,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6564,6567],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6564,6567],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":274,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":274,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7185,7188],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7185,7188],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Firestore Categories Service\r\n * Teklifbul Rule v1.0\r\n * \r\n * PostgreSQL alternatifi - $0 maliyet, otomatik yedekleme\r\n */\r\n\r\nimport { db } from '../lib/firebase';\r\nimport { \r\n  collection, \r\n  query, \r\n  where, \r\n  getDocs, \r\n  doc, \r\n  getDoc, \r\n  setDoc, \r\n  addDoc,\r\n  orderBy,\r\n  limit,\r\n  startAfter,\r\n  QueryDocumentSnapshot,\r\n  DocumentData\r\n} from 'firebase/firestore';\r\nimport { cache } from './in-memory-cache';\r\n\r\ninterface Category {\r\n  id: string;\r\n  name: string;\r\n  short_desc?: string;\r\n  examples?: string[];\r\n  createdAt?: any;\r\n  updatedAt?: any;\r\n}\r\n\r\ninterface CategoryKeyword {\r\n  id: string;\r\n  category_id: number;\r\n  keyword: string;\r\n  weight: number;\r\n}\r\n\r\ninterface Suggestion {\r\n  category_id: number;\r\n  name: string;\r\n  score: number;\r\n  reasons: string[];\r\n}\r\n\r\n/**\r\n * T√ºrk√ße normalizasyon\r\n */\r\nfunction normalizeTurkish(text: string): string {\r\n  return text\r\n    .toLowerCase()\r\n    .normalize('NFD')\r\n    .replace(/[\\u0300-\\u036f]/g, '') // Diacritics\r\n    .replace(/[^\\w\\s]/g, ' ')\r\n    .replace(/\\s+/g, ' ')\r\n    .trim();\r\n}\r\n\r\n/**\r\n * Kategorileri listele\r\n */\r\nexport async function getCategories(options?: {\r\n  search?: string;\r\n  withDesc?: boolean;\r\n  page?: number;\r\n  size?: number;\r\n}): Promise<{ data: Category[]; pagination: any }> {\r\n  const { search, withDesc = true, page = 1, size = 100 } = options || {};\r\n  \r\n  // Cache key\r\n  const cacheKey = `categories:list:${search || 'all'}:${page}:${size}`;\r\n  \r\n  // Cache kontrol√º\r\n  const cached = await cache.get<{ data: Category[]; pagination: any }>(cacheKey);\r\n  if (cached) {\r\n    return cached;\r\n  }\r\n  \r\n  try {\r\n    const categoriesRef = collection(db, 'categories');\r\n    const q = query(categoriesRef, orderBy('name', 'asc'));\r\n    \r\n    // Search filter (Firestore'da case-insensitive search yok, client-side filter)\r\n    const snapshot = await getDocs(q);\r\n    let categories = snapshot.docs.map(doc => ({\r\n      id: doc.id,\r\n      ...doc.data()\r\n    })) as Category[];\r\n    \r\n    // Client-side search filter\r\n    if (search) {\r\n      const searchLower = search.toLowerCase();\r\n      categories = categories.filter(cat => \r\n        cat.name.toLowerCase().includes(searchLower) ||\r\n        cat.short_desc?.toLowerCase().includes(searchLower)\r\n      );\r\n    }\r\n    \r\n    // Pagination\r\n    const startIndex = (page - 1) * size;\r\n    const endIndex = startIndex + size;\r\n    const paginated = categories.slice(startIndex, endIndex);\r\n    \r\n    // withDesc kontrol√º\r\n    const result = withDesc \r\n      ? paginated \r\n      : paginated.map(({ short_desc, examples, ...rest }) => rest);\r\n    \r\n    const response = {\r\n      data: result,\r\n      pagination: {\r\n        page,\r\n        size,\r\n        total: categories.length\r\n      }\r\n    };\r\n    \r\n    // Cache'e kaydet (5 dakika)\r\n    await cache.set(cacheKey, response, 300);\r\n    \r\n    return response;\r\n  } catch (error: any) {\r\n    console.error('‚ùå Firestore getCategories error:', error);\r\n    throw new Error(`Kategoriler y√ºklenemedi: ${error.message}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Kategori detayƒ±\r\n */\r\nexport async function getCategoryById(id: string): Promise<Category | null> {\r\n  const cacheKey = `category:${id}`;\r\n  \r\n  // Cache kontrol√º\r\n  const cached = await cache.get<Category>(cacheKey);\r\n  if (cached) {\r\n    return cached;\r\n  }\r\n  \r\n  try {\r\n    const categoryDoc = await getDoc(doc(db, 'categories', id));\r\n    \r\n    if (!categoryDoc.exists()) {\r\n      return null;\r\n    }\r\n    \r\n    const category = {\r\n      id: categoryDoc.id,\r\n      ...categoryDoc.data()\r\n    } as Category;\r\n    \r\n    // Cache'e kaydet (1 saat)\r\n    await cache.set(cacheKey, category, 3600);\r\n    \r\n    return category;\r\n  } catch (error: any) {\r\n    console.error('‚ùå Firestore getCategoryById error:', error);\r\n    throw new Error(`Kategori y√ºklenemedi: ${error.message}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Kategori √∂ner\r\n */\r\nexport async function suggestCategory(text: string): Promise<{\r\n  query: string;\r\n  suggestions: Suggestion[];\r\n  auto_select: string | null;\r\n}> {\r\n  const normalized = normalizeTurkish(text.toLowerCase());\r\n  const words = normalized.split(/\\s+/).filter(w => w.length > 2);\r\n  \r\n  if (words.length === 0) {\r\n    return { query: text, suggestions: [], auto_select: null };\r\n  }\r\n  \r\n  // Cache key\r\n  const cacheKey = `cat:suggest:${normalized}`;\r\n  \r\n  // Cache kontrol√º\r\n  const cached = await cache.get<{ query: string; suggestions: Suggestion[]; auto_select: string | null }>(cacheKey);\r\n  if (cached) {\r\n    return cached;\r\n  }\r\n  \r\n  try {\r\n    // T√ºm keywords'leri al\r\n    const keywordsRef = collection(db, 'category_keywords');\r\n    const keywordsSnapshot = await getDocs(keywordsRef);\r\n    const keywords = keywordsSnapshot.docs.map(doc => ({\r\n      id: doc.id,\r\n      ...doc.data()\r\n    })) as CategoryKeyword[];\r\n    \r\n    // Keyword matching\r\n    const matches = keywords.filter(kw => {\r\n      const kwLower = kw.keyword.toLowerCase();\r\n      return words.some(word => kwLower.includes(word) || word.includes(kwLower));\r\n    });\r\n    \r\n    // Category scores hesapla\r\n    const categoryScores = new Map<number, { score: number; keywords: string[] }>();\r\n    \r\n    matches.forEach(match => {\r\n      const catId = match.category_id;\r\n      const current = categoryScores.get(catId) || { score: 0, keywords: [] };\r\n      current.score += match.weight;\r\n      current.keywords.push(match.keyword);\r\n      categoryScores.set(catId, current);\r\n    });\r\n    \r\n    // Top 5 kategori al ve detaylarƒ±nƒ± getir\r\n    const topCategories = Array.from(categoryScores.entries())\r\n      .sort((a, b) => b[1].score - a[1].score)\r\n      .slice(0, 5);\r\n    \r\n    const suggestions: Suggestion[] = await Promise.all(\r\n      topCategories.map(async ([catId, data]) => {\r\n        // Kategori detayƒ±nƒ± al\r\n        const category = await getCategoryById(catId.toString());\r\n        \r\n        const ruleScore = Math.min(data.score / 10, 1.0); // Normalize to 0-1\r\n        \r\n        return {\r\n          category_id: catId,\r\n          name: category?.name || '',\r\n          score: Math.round(ruleScore * 100) / 100,\r\n          reasons: data.keywords.slice(0, 3) // Top 3 keywords\r\n        };\r\n      })\r\n    );\r\n    \r\n    // Auto-select if score >= 0.70\r\n    const autoSelect = suggestions.length > 0 && suggestions[0].score >= 0.70\r\n      ? suggestions[0].name\r\n      : null;\r\n    \r\n    const result = {\r\n      query: text,\r\n      suggestions,\r\n      auto_select: autoSelect\r\n    };\r\n    \r\n    // Cache'e kaydet (24 saat)\r\n    await cache.set(cacheKey, result, 86400);\r\n    \r\n    return result;\r\n  } catch (error: any) {\r\n    console.error('‚ùå Firestore suggestCategory error:', error);\r\n    throw new Error(`Kategori √∂nerisi olu≈üturulamadƒ±: ${error.message}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Feedback kaydet\r\n */\r\nexport async function saveFeedback(\r\n  query: string,\r\n  suggestedCategoryId: number | null,\r\n  chosenCategoryId: number | null,\r\n  userId?: string\r\n): Promise<void> {\r\n  try {\r\n    await addDoc(collection(db, 'category_feedback'), {\r\n      query,\r\n      suggested_category_id: suggestedCategoryId,\r\n      chosen_category_id: chosenCategoryId,\r\n      user_id: userId || null,\r\n      createdAt: new Date()\r\n    });\r\n  } catch (error: any) {\r\n    console.error('‚ùå Firestore saveFeedback error:', error);\r\n    throw new Error(`Feedback kaydedilemedi: ${error.message}`);\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\services\\firestore-tax-offices.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'query' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'where' is defined but never used. Allowed unused vars must match /^_/u.","line":12,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'orderBy' is defined but never used. Allowed unused vars must match /^_/u.","line":14,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":10},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":79,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1768,1771],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1768,1771],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":137,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":137,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3524,3527],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3524,3527],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Firestore Tax Offices Service\r\n * Teklifbul Rule v1.0\r\n * \r\n * PostgreSQL alternatifi - $0 maliyet, otomatik yedekleme\r\n */\r\n\r\nimport { db } from '../lib/firebase';\r\nimport { \r\n  collection, \r\n  query, \r\n  where, \r\n  getDocs, \r\n  orderBy\r\n} from 'firebase/firestore';\r\nimport { cache } from './in-memory-cache';\r\n\r\ninterface TaxOffice {\r\n  id: string;\r\n  province_name: string;\r\n  district_name?: string;\r\n  office_name: string;\r\n  office_code?: string;\r\n  office_type?: string;\r\n}\r\n\r\n/**\r\n * T√ºrk√ße karakter normalizasyonu\r\n */\r\nfunction normalizeTurkish(text: string): string {\r\n  return text\r\n    .toUpperCase()\r\n    .replace(/ƒ∞/g, 'I')\r\n    .replace(/ƒ±/g, 'I')\r\n    .replace(/≈ü/g, 'S')\r\n    .replace(/≈û/g, 'S')\r\n    .replace(/ƒü/g, 'G')\r\n    .replace(/ƒû/g, 'G')\r\n    .replace(/√º/g, 'U')\r\n    .replace(/√ú/g, 'U')\r\n    .replace(/√∂/g, 'O')\r\n    .replace(/√ñ/g, 'O')\r\n    .replace(/√ß/g, 'C')\r\n    .replace(/√á/g, 'C')\r\n    .trim();\r\n}\r\n\r\n/**\r\n * ƒ∞l listesi\r\n */\r\nexport async function getProvinces(): Promise<string[]> {\r\n  const cacheKey = 'tax_offices:provinces';\r\n  \r\n  // Cache kontrol√º\r\n  const cached = await cache.get<string[]>(cacheKey);\r\n  if (cached) {\r\n    return cached;\r\n  }\r\n  \r\n  try {\r\n    const officesRef = collection(db, 'tax_offices');\r\n    const snapshot = await getDocs(officesRef);\r\n    \r\n    // T√ºm illeri al ve unique yap\r\n    const provinces = new Set<string>();\r\n    snapshot.docs.forEach(doc => {\r\n      const data = doc.data();\r\n      if (data.province_name) {\r\n        provinces.add(data.province_name);\r\n      }\r\n    });\r\n    \r\n    const provincesArray = Array.from(provinces).sort();\r\n    \r\n    // Cache'e kaydet (24 saat)\r\n    await cache.set(cacheKey, provincesArray, 86400);\r\n    \r\n    return provincesArray;\r\n  } catch (error: any) {\r\n    console.error('‚ùå Firestore getProvinces error:', error);\r\n    throw new Error(`ƒ∞ller y√ºklenemedi: ${error.message}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Vergi daireleri listesi\r\n */\r\nexport async function getTaxOffices(options: {\r\n  province: string;\r\n  district?: string;\r\n}): Promise<TaxOffice[]> {\r\n  const { province, district } = options;\r\n  \r\n  // Cache key\r\n  const cacheKey = `tax_offices:${normalizeTurkish(province)}:${district ? normalizeTurkish(district) : 'all'}`;\r\n  \r\n  // Cache kontrol√º\r\n  const cached = await cache.get<TaxOffice[]>(cacheKey);\r\n  if (cached) {\r\n    return cached;\r\n  }\r\n  \r\n  try {\r\n    const officesRef = collection(db, 'tax_offices');\r\n    \r\n    // T√ºm vergi dairelerini al (Firestore'da case-insensitive search yok, client-side filter)\r\n    const snapshot = await getDocs(officesRef);\r\n    \r\n    // Client-side filter\r\n    let offices = snapshot.docs\r\n      .map(doc => ({\r\n        id: doc.id,\r\n        ...doc.data()\r\n      })) as TaxOffice[];\r\n    \r\n    // Province filter (case-insensitive, Turkish character aware)\r\n    const normalizedProvince = normalizeTurkish(province);\r\n    offices = offices.filter(office => \r\n      normalizeTurkish(office.province_name) === normalizedProvince\r\n    );\r\n    \r\n    // District filter (eƒüer varsa)\r\n    if (district) {\r\n      const normalizedDistrict = normalizeTurkish(district);\r\n      offices = offices.filter(office => \r\n        office.district_name && normalizeTurkish(office.district_name) === normalizedDistrict\r\n      );\r\n    }\r\n    \r\n    // Sort by office_name\r\n    offices.sort((a, b) => a.office_name.localeCompare(b.office_name, 'tr'));\r\n    \r\n    // Cache'e kaydet (24 saat)\r\n    await cache.set(cacheKey, offices, 86400);\r\n    \r\n    return offices;\r\n  } catch (error: any) {\r\n    console.error('‚ùå Firestore getTaxOffices error:', error);\r\n    throw new Error(`Vergi daireleri y√ºklenemedi: ${error.message}`);\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\services\\in-memory-cache.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\shared\\constants\\colors.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\shared\\constants\\messages.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\shared\\constants\\timing.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\shared\\constants\\ui.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\shared\\log\\logger.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\shared\\log\\logger.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\shared\\ui\\toast.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\src\\units.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\test-serverTimestamp-fix.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\test-simple.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\test-supplier-matching-final.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\test-supplier-matching-v2.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'toSlug' is defined but never used.","line":6,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":16}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Test script to verify supplier matching functionality\r\nimport { db } from \"./firebase.js\";\r\nimport { collection, query, where, getDocs } from \"https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js\";\r\n\r\n// Helper: Convert string to slug format\r\nfunction toSlug(name) {\r\n  return name.toLowerCase().trim().replace(/\\s+/g, '-').replace(/[^a-z0-9-]/g, '');\r\n}\r\n\r\nasync function testSupplierMatching() {\r\n  try {\r\n    console.log(\"Testing supplier matching functionality...\");\r\n    \r\n    // Test 1: Find all active suppliers\r\n    console.log(\"\\n--- Test 1: All active suppliers ---\");\r\n    const allSuppliersQuery = query(\r\n      collection(db, \"users\"),\r\n      where(\"isSupplier\", \"==\", true),\r\n      where(\"isActive\", \"==\", true)\r\n    );\r\n    \r\n    const allSuppliersSnapshot = await getDocs(allSuppliersQuery);\r\n    console.log(`Found ${allSuppliersSnapshot.size} active suppliers`);\r\n    \r\n    // Test 2: Test category matching\r\n    const testCategories = [\"elektrik\", \"mobilya\", \"in≈üaat-malzemeleri\"];\r\n    \r\n    for (const category of testCategories) {\r\n      console.log(`\\n--- Test 2: Searching for suppliers in category '${category}' ---`);\r\n      \r\n      const categoryQuery = query(\r\n        collection(db, \"users\"),\r\n        where(\"isSupplier\", \"==\", true),\r\n        where(\"isActive\", \"==\", true),\r\n        where(\"supplierCategories\", \"array-contains\", category)\r\n      );\r\n      \r\n      try {\r\n        const categorySnapshot = await getDocs(categoryQuery);\r\n        console.log(`Found ${categorySnapshot.size} suppliers for category '${category}':`);\r\n        \r\n        categorySnapshot.docs.forEach(doc => {\r\n          const data = doc.data();\r\n          console.log(`  - ${doc.id}: ${data.companyName || data.displayName || 'Unknown'}`);\r\n          console.log(`    Categories: ${JSON.stringify(data.supplierCategories)}`);\r\n        });\r\n      } catch (error) {\r\n        console.error(`Error searching for suppliers with category '${category}':`, error.message);\r\n      }\r\n    }\r\n    \r\n    // Test 3: Test multi-category matching\r\n    console.log(\"\\n--- Test 3: Multi-category matching ---\");\r\n    const demandCategories = [\"elektrik\", \"kablo\"];\r\n    console.log(\"Demand categories:\", demandCategories);\r\n    \r\n    const multiCategoryQuery = query(\r\n      collection(db, \"users\"),\r\n      where(\"isSupplier\", \"==\", true),\r\n      where(\"isActive\", \"==\", true),\r\n      where(\"supplierCategories\", \"array-contains-any\", demandCategories.slice(0, 10))\r\n    );\r\n    \r\n    try {\r\n      const multiCategorySnapshot = await getDocs(multiCategoryQuery);\r\n      console.log(`Found ${multiCategorySnapshot.size} matching suppliers for demand:`);\r\n      \r\n      multiCategorySnapshot.docs.forEach(doc => {\r\n        const data = doc.data();\r\n        const matchingCategories = data.supplierCategories.filter(cat => demandCategories.includes(cat));\r\n        console.log(`  - ${doc.id}: ${data.companyName || data.displayName || 'Unknown'}`);\r\n        console.log(`    Matching categories: ${JSON.stringify(matchingCategories)}`);\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Error searching for multi-category suppliers:\", error.message);\r\n    }\r\n    \r\n    console.log(\"\\nTest completed.\");\r\n    \r\n  } catch (error) {\r\n    console.error(\"Test failed:\", error);\r\n  }\r\n}\r\n\r\n// Run test\r\ntestSupplierMatching();","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\test-supplier-matching.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'db' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'collection' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'addDoc' is defined but never used.","line":4,"column":22,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":28}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Test script to verify supplier matching functionality\r\nimport { publishDemandAndMatchSuppliers } from './publish-demand.js';\r\nimport { db } from './firebase.js';\r\nimport { collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';\r\n\r\n/**\r\n * Test script to verify supplier matching functionality\r\n */\r\nasync function testSupplierMatching() {\r\n  try {\r\n    // Create a test demand\r\n    const testDemand = {\r\n      id: 'test-demand-' + Date.now(),\r\n      title: 'Test Demand for Supplier Matching',\r\n      description: 'This is a test demand to verify supplier matching functionality',\r\n      categories: ['electronics', 'computers'], // Assuming these categories exist\r\n      isPublished: true,\r\n      visibility: 'public',\r\n      createdBy: 'test-user-id', // This would be a real user ID in practice\r\n      createdAt: serverTimestamp()\r\n    };\r\n\r\n    console.log('Creating test demand...');\r\n    \r\n    // Publish the demand and match with suppliers\r\n    await publishDemandAndMatchSuppliers(testDemand);\r\n    \r\n    console.log('Demand published and suppliers matched successfully!');\r\n    console.log('Check the demandRecipients collection in Firestore to verify matches.');\r\n    \r\n  } catch (error) {\r\n    console.error('Error testing supplier matching:', error);\r\n  }\r\n}\r\n\r\n// Run the test if this script is executed directly\r\nif (typeof window === 'undefined') {\r\n  // Node.js environment\r\n  testSupplierMatching();\r\n}\r\n\r\nexport { testSupplierMatching };\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\test-teklifbul-system.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\test\\category-groups.test.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getFirestore' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'collection' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":24,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":34},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'addDoc' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":36,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":42},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getDocs' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":44,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":51},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'query' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":80,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":85},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'where' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":87,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":92}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Category Groups Tests\r\n * Tests for user category groups functionality\r\n */\r\n\r\nimport { initializeTestEnvironment, assertFails, assertSucceeds } from '@firebase/rules-unit-testing';\r\nimport { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, setDoc, getDoc } from 'firebase/firestore';\r\n\r\nlet testEnv;\r\nlet alice, bob;\r\n\r\nbeforeAll(async () => {\r\n  testEnv = await initializeTestEnvironment({\r\n    projectId: 'test-project',\r\n    firestore: {\r\n      rules: `\r\n        rules_version = '2';\r\n        service cloud.firestore {\r\n          match /databases/{database}/documents {\r\n            function isSignedIn() {\r\n              return request.auth != null;\r\n            }\r\n            \r\n            function isSelf(uid) {\r\n              return request.auth != null && request.auth.uid == uid;\r\n            }\r\n            \r\n            match /users/{uid} {\r\n              allow read, write: if isSelf(uid);\r\n            }\r\n            \r\n            match /users/{uid}/categoryGroups/{groupId} {\r\n              allow read, create, update, delete: if isSignedIn() && request.auth.uid == uid;\r\n            }\r\n          }\r\n        }\r\n      `\r\n    }\r\n  });\r\n  \r\n  alice = testEnv.authenticatedContext('alice');\r\n  bob = testEnv.authenticatedContext('bob');\r\n});\r\n\r\nafterAll(async () => {\r\n  await testEnv.cleanup();\r\n});\r\n\r\ndescribe('Category Groups Security Rules', () => {\r\n  test('should allow user to create their own category group', async () => {\r\n    const groupData = {\r\n      name: 'Test Group',\r\n      categories: ['elektrik', 'mobilya'],\r\n      createdAt: new Date(),\r\n      updatedAt: new Date()\r\n    };\r\n    \r\n    const groupRef = doc(alice.firestore(), 'users', 'alice', 'categoryGroups', 'test-group');\r\n    await assertSucceeds(setDoc(groupRef, groupData));\r\n  });\r\n\r\n  test('should prevent user from accessing another user\\'s category groups', async () => {\r\n    const groupData = {\r\n      name: 'Alice Group',\r\n      categories: ['elektrik'],\r\n      createdAt: new Date(),\r\n      updatedAt: new Date()\r\n    };\r\n    \r\n    // Alice creates a group\r\n    const groupRef = doc(alice.firestore(), 'users', 'alice', 'categoryGroups', 'alice-group');\r\n    await setDoc(groupRef, groupData);\r\n    \r\n    // Bob tries to read Alice's group\r\n    const bobGroupRef = doc(bob.firestore(), 'users', 'alice', 'categoryGroups', 'alice-group');\r\n    await assertFails(getDoc(bobGroupRef));\r\n  });\r\n\r\n  test('should allow user to update their own category group', async () => {\r\n    const groupData = {\r\n      name: 'Test Group',\r\n      categories: ['elektrik'],\r\n      createdAt: new Date(),\r\n      updatedAt: new Date()\r\n    };\r\n    \r\n    const groupRef = doc(alice.firestore(), 'users', 'alice', 'categoryGroups', 'update-test');\r\n    await setDoc(groupRef, groupData);\r\n    \r\n    // Update the group\r\n    await assertSucceeds(updateDoc(groupRef, {\r\n      name: 'Updated Group',\r\n      categories: ['elektrik', 'mobilya'],\r\n      updatedAt: new Date()\r\n    }));\r\n  });\r\n\r\n  test('should prevent user from updating another user\\'s category group', async () => {\r\n    const groupData = {\r\n      name: 'Alice Group',\r\n      categories: ['elektrik'],\r\n      createdAt: new Date(),\r\n      updatedAt: new Date()\r\n    };\r\n    \r\n    // Alice creates a group\r\n    const groupRef = doc(alice.firestore(), 'users', 'alice', 'categoryGroups', 'alice-group');\r\n    await setDoc(groupRef, groupData);\r\n    \r\n    // Bob tries to update Alice's group\r\n    const bobGroupRef = doc(bob.firestore(), 'users', 'alice', 'categoryGroups', 'alice-group');\r\n    await assertFails(updateDoc(bobGroupRef, {\r\n      name: 'Hacked Group',\r\n      updatedAt: new Date()\r\n    }));\r\n  });\r\n\r\n  test('should allow user to delete their own category group', async () => {\r\n    const groupData = {\r\n      name: 'Delete Test Group',\r\n      categories: ['elektrik'],\r\n      createdAt: new Date(),\r\n      updatedAt: new Date()\r\n    };\r\n    \r\n    const groupRef = doc(alice.firestore(), 'users', 'alice', 'categoryGroups', 'delete-test');\r\n    await setDoc(groupRef, groupData);\r\n    \r\n    // Delete the group\r\n    await assertSucceeds(deleteDoc(groupRef));\r\n  });\r\n\r\n  test('should prevent user from deleting another user\\'s category group', async () => {\r\n    const groupData = {\r\n      name: 'Alice Group',\r\n      categories: ['elektrik'],\r\n      createdAt: new Date(),\r\n      updatedAt: new Date()\r\n    };\r\n    \r\n    // Alice creates a group\r\n    const groupRef = doc(alice.firestore(), 'users', 'alice', 'categoryGroups', 'alice-group');\r\n    await setDoc(groupRef, groupData);\r\n    \r\n    // Bob tries to delete Alice's group\r\n    const bobGroupRef = doc(bob.firestore(), 'users', 'alice', 'categoryGroups', 'alice-group');\r\n    await assertFails(deleteDoc(bobGroupRef));\r\n  });\r\n});\r\n\r\ndescribe('Category Groups Data Model', () => {\r\n  test('should store categories as slugs', async () => {\r\n    const groupData = {\r\n      name: 'Slug Test Group',\r\n      categories: ['Elektrik Kablo', 'Mobilya Ah≈üap', 'ƒ∞n≈üaat Malzemeleri'],\r\n      createdAt: new Date(),\r\n      updatedAt: new Date()\r\n    };\r\n    \r\n    const groupRef = doc(alice.firestore(), 'users', 'alice', 'categoryGroups', 'slug-test');\r\n    await setDoc(groupRef, groupData);\r\n    \r\n    const docSnap = await getDoc(groupRef);\r\n    const data = docSnap.data();\r\n    \r\n    // Categories should be stored as slugs\r\n    expect(data.categories).toEqual(['elektrik-kablo', 'mobilya-ahsap', 'insaat-malzemeleri']);\r\n  });\r\n\r\n  test('should require name field', async () => {\r\n    const groupData = {\r\n      categories: ['elektrik'],\r\n      createdAt: new Date(),\r\n      updatedAt: new Date()\r\n    };\r\n    \r\n    const groupRef = doc(alice.firestore(), 'users', 'alice', 'categoryGroups', 'no-name');\r\n    await assertFails(setDoc(groupRef, groupData));\r\n  });\r\n\r\n  test('should require categories array', async () => {\r\n    const groupData = {\r\n      name: 'No Categories Group',\r\n      createdAt: new Date(),\r\n      updatedAt: new Date()\r\n    };\r\n    \r\n    const groupRef = doc(alice.firestore(), 'users', 'alice', 'categoryGroups', 'no-categories');\r\n    await assertFails(setDoc(groupRef, groupData));\r\n  });\r\n});\r\n\r\ndescribe('Category Groups Integration', () => {\r\n  test('should apply group categories to demand form', async () => {\r\n    // This would be an integration test with the demand form\r\n    // For now, we'll test the data structure\r\n    \r\n    const groupData = {\r\n      name: 'Integration Test Group',\r\n      categories: ['elektrik', 'mobilya', 'insaat'],\r\n      createdAt: new Date(),\r\n      updatedAt: new Date()\r\n    };\r\n    \r\n    const groupRef = doc(alice.firestore(), 'users', 'alice', 'categoryGroups', 'integration-test');\r\n    await setDoc(groupRef, groupData);\r\n    \r\n    const docSnap = await getDoc(groupRef);\r\n    const data = docSnap.data();\r\n    \r\n    expect(data.name).toBe('Integration Test Group');\r\n    expect(data.categories).toHaveLength(3);\r\n    expect(data.categories).toContain('elektrik');\r\n    expect(data.categories).toContain('mobilya');\r\n    expect(data.categories).toContain('insaat');\r\n  });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\test\\demands.test.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getFirestore' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setDoc' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":49,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":55}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Demands Service Tests\r\n * Tests for demand-related functionality\r\n */\r\n\r\nimport { getPublicDemands, getUserDemands, createDemand, publishDemand } from '../assets/js/services/demands.js';\r\nimport { getFirestore, collection, addDoc, doc, setDoc, getDoc } from 'firebase/firestore';\r\n\r\ndescribe('Demands Service', () => {\r\n  let db;\r\n\r\n  beforeAll(() => {\r\n    db = global.firebaseDb;\r\n  });\r\n\r\n  beforeEach(async () => {\r\n    // Create test data\r\n    await createTestDemands();\r\n  });\r\n\r\n  afterEach(async () => {\r\n    // Clean up test data\r\n    await cleanupTestData();\r\n  });\r\n\r\n  describe('getPublicDemands', () => {\r\n    test('should return only published public demands', async () => {\r\n      const demands = await getPublicDemands(10);\r\n      \r\n      expect(demands).toBeDefined();\r\n      expect(Array.isArray(demands)).toBe(true);\r\n      \r\n      // All demands should be published and public\r\n      demands.forEach(demand => {\r\n        expect(demand.isPublished).toBe(true);\r\n        expect(demand.visibility).toBe('public');\r\n      });\r\n    });\r\n\r\n    test('should respect limit parameter', async () => {\r\n      const demands = await getPublicDemands(5);\r\n      expect(demands.length).toBeLessThanOrEqual(5);\r\n    });\r\n  });\r\n\r\n  describe('getUserDemands', () => {\r\n    test('should return demands created by specific user', async () => {\r\n      const testUserId = 'test-user-123';\r\n      const demands = await getUserDemands(testUserId, 10);\r\n      \r\n      expect(demands).toBeDefined();\r\n      expect(Array.isArray(demands)).toBe(true);\r\n      \r\n      // All demands should be created by the test user\r\n      demands.forEach(demand => {\r\n        expect(demand.createdBy).toBe(testUserId);\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('createDemand', () => {\r\n    test('should create a new demand with required fields', async () => {\r\n      const demandData = {\r\n        title: 'Test Demand',\r\n        description: 'Test Description',\r\n        createdBy: 'test-user-123',\r\n        isPublished: false,\r\n        visibility: 'private'\r\n      };\r\n\r\n      const demandId = await createDemand(demandData);\r\n      \r\n      expect(demandId).toBeDefined();\r\n      expect(typeof demandId).toBe('string');\r\n      expect(demandId.length).toBeGreaterThan(0);\r\n    });\r\n\r\n    test('should generate SATFK for new demands', async () => {\r\n      const demandData = {\r\n        title: 'Test Demand with SATFK',\r\n        description: 'Test Description',\r\n        createdBy: 'test-user-123',\r\n        isPublished: false,\r\n        visibility: 'private'\r\n      };\r\n\r\n      const demandId = await createDemand(demandData);\r\n      \r\n      // Wait a bit for the Cloud Function to generate SATFK\r\n      await new Promise(resolve => setTimeout(resolve, 1000));\r\n      \r\n      // Get the demand to check SATFK\r\n      const demandDoc = await getDoc(doc(db, 'demands', demandId));\r\n      const demand = demandDoc.data();\r\n      \r\n      expect(demand.satfk).toBeDefined();\r\n      expect(demand.satfk).toMatch(/^SATFK-\\d{8}-[0-9A-Z]+$/);\r\n    });\r\n  });\r\n\r\n  describe('publishDemand', () => {\r\n    test('should publish a demand with correct visibility', async () => {\r\n      // First create a demand\r\n      const demandData = {\r\n        title: 'Test Demand for Publishing',\r\n        description: 'Test Description',\r\n        createdBy: 'test-user-123',\r\n        isPublished: false,\r\n        visibility: 'private'\r\n      };\r\n\r\n      const demandId = await createDemand(demandData);\r\n      \r\n      // Then publish it\r\n      await publishDemand(demandId, 'public', 'test-user-123');\r\n      \r\n      // Verify the demand was published\r\n      const demands = await getPublicDemands(10);\r\n      const publishedDemand = demands.find(d => d.id === demandId);\r\n      \r\n      expect(publishedDemand).toBeDefined();\r\n      expect(publishedDemand.isPublished).toBe(true);\r\n      expect(publishedDemand.visibility).toBe('public');\r\n    });\r\n  });\r\n\r\n  // Helper functions\r\n  async function createTestDemands() {\r\n    const testDemands = [\r\n      {\r\n        title: 'Public Demand 1',\r\n        description: 'A public demand',\r\n        createdBy: 'test-user-123',\r\n        isPublished: true,\r\n        visibility: 'public',\r\n        createdAt: new Date()\r\n      },\r\n      {\r\n        title: 'Public Demand 2',\r\n        description: 'Another public demand',\r\n        createdBy: 'test-user-456',\r\n        isPublished: true,\r\n        visibility: 'public',\r\n        createdAt: new Date()\r\n      },\r\n      {\r\n        title: 'Private Demand',\r\n        description: 'A private demand',\r\n        createdBy: 'test-user-123',\r\n        isPublished: false,\r\n        visibility: 'private',\r\n        createdAt: new Date()\r\n      },\r\n      {\r\n        title: 'Company Demand',\r\n        description: 'A company demand',\r\n        createdBy: 'test-user-123',\r\n        isPublished: true,\r\n        visibility: 'company',\r\n        createdAt: new Date()\r\n      }\r\n    ];\r\n\r\n    for (const demand of testDemands) {\r\n      await addDoc(collection(db, 'demands'), demand);\r\n    }\r\n  }\r\n\r\n  async function cleanupTestData() {\r\n    // In a real implementation, this would clean up test data\r\n    // For now, we'll just log that cleanup would happen\r\n    console.log('Test cleanup: Demand test data would be cleared');\r\n  }\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\test\\firestore-rules.test.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getFirestore' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'collection' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":24,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":34},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'deleteDoc' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":68,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":77}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Firestore Rules Tests\r\n * Tests for security rules and access control\r\n */\r\n\r\nimport { initializeTestEnvironment, assertFails, assertSucceeds } from '@firebase/rules-unit-testing';\r\nimport { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc } from 'firebase/firestore';\r\n\r\nlet testEnv;\r\n\r\nbeforeAll(async () => {\r\n  testEnv = await initializeTestEnvironment({\r\n    projectId: 'test-project',\r\n    firestore: {\r\n      rules: `\r\n        rules_version = '2';\r\n        service cloud.firestore {\r\n          match /databases/{database}/documents {\r\n            function isSignedIn() {\r\n              return request.auth != null;\r\n            }\r\n\r\n            function isOwner(resource) {\r\n              return isSignedIn() && resource.data.createdBy == request.auth.uid;\r\n            }\r\n\r\n            function isAdmin(uid) {\r\n              return isSignedIn() && \r\n                get(/databases/$(database)/documents/users/$(uid)).data.role == 'admin';\r\n            }\r\n\r\n            function isMember(companyId, uid) {\r\n              return isSignedIn() && \r\n                exists(/databases/$(database)/documents/companies/$(companyId)/memberships/$(uid));\r\n            }\r\n\r\n            function isPublic(d) {\r\n              return d.isPublished == true && d.visibility == \"public\";\r\n            }\r\n\r\n            match /demands/{id} {\r\n              allow read: if isSignedIn() && (\r\n                isPublic(resource.data) ||\r\n                isOwner(resource) ||\r\n                (resource.data.companyId is string && isMember(resource.data.companyId, request.auth.uid)) ||\r\n                isAdmin(request.auth.uid)\r\n              );\r\n              allow create: if isSignedIn();\r\n              allow update: if (isOwner(resource) || isAdmin(request.auth.uid)) && \r\n                // SATFK is immutable after creation\r\n                (request.resource.data.satfk == resource.data.satfk || resource.data.satfk == null);\r\n              allow delete: if isOwner(resource) || isAdmin(request.auth.uid);\r\n            }\r\n\r\n            match /users/{uid} {\r\n              allow read, write: if isSignedIn() && request.auth.uid == uid;\r\n            }\r\n          }\r\n        }\r\n      `,\r\n      host: 'localhost',\r\n      port: 8080\r\n    }\r\n  });\r\n});\r\n\r\nafterAll(async () => {\r\n  await testEnv.cleanup();\r\n});\r\n\r\ndescribe('Firestore Security Rules', () => {\r\n  let alice, bob, admin;\r\n  let aliceDemand, bobDemand, publicDemand;\r\n\r\n  beforeAll(async () => {\r\n    // Create test users\r\n    alice = testEnv.authenticatedContext('alice');\r\n    bob = testEnv.authenticatedContext('bob');\r\n    admin = testEnv.authenticatedContext('admin', { role: 'admin' });\r\n\r\n    // Create test demands\r\n    aliceDemand = {\r\n      title: 'Alice Private Demand',\r\n      createdBy: 'alice',\r\n      isPublished: false,\r\n      visibility: 'private'\r\n    };\r\n\r\n    bobDemand = {\r\n      title: 'Bob Private Demand',\r\n      createdBy: 'bob',\r\n      isPublished: false,\r\n      visibility: 'private'\r\n    };\r\n\r\n    publicDemand = {\r\n      title: 'Public Demand',\r\n      createdBy: 'alice',\r\n      isPublished: true,\r\n      visibility: 'public'\r\n    };\r\n  });\r\n\r\n  describe('Demand Access Control', () => {\r\n    test('should allow owner to read their own private demand', async () => {\r\n      const demandRef = doc(alice.firestore(), 'demands', 'alice-demand');\r\n      await setDoc(demandRef, aliceDemand);\r\n\r\n      await assertSucceeds(getDoc(demandRef));\r\n    });\r\n\r\n    test('should deny other users from reading private demands', async () => {\r\n      const demandRef = doc(bob.firestore(), 'demands', 'alice-demand');\r\n      await setDoc(demandRef, aliceDemand);\r\n\r\n      await assertFails(getDoc(demandRef));\r\n    });\r\n\r\n    test('should allow any authenticated user to read public demands', async () => {\r\n      const demandRef = doc(alice.firestore(), 'demands', 'public-demand');\r\n      await setDoc(demandRef, publicDemand);\r\n\r\n      // Alice should be able to read\r\n      await assertSucceeds(getDoc(demandRef));\r\n\r\n      // Bob should also be able to read\r\n      const bobDemandRef = doc(bob.firestore(), 'demands', 'public-demand');\r\n      await assertSucceeds(getDoc(bobDemandRef));\r\n    });\r\n\r\n    test('should allow admin to read any demand', async () => {\r\n      const demandRef = doc(admin.firestore(), 'demands', 'bob-demand');\r\n      await setDoc(demandRef, bobDemand);\r\n\r\n      await assertSucceeds(getDoc(demandRef));\r\n    });\r\n\r\n    test('should allow owner to update their demand', async () => {\r\n      const demandRef = doc(alice.firestore(), 'demands', 'alice-demand');\r\n      await setDoc(demandRef, aliceDemand);\r\n\r\n      await assertSucceeds(updateDoc(demandRef, { title: 'Updated Title' }));\r\n    });\r\n\r\n    test('should deny other users from updating demands they do not own', async () => {\r\n      const demandRef = doc(bob.firestore(), 'demands', 'alice-demand');\r\n      await setDoc(demandRef, aliceDemand);\r\n\r\n      await assertFails(updateDoc(demandRef, { title: 'Hacked Title' }));\r\n    });\r\n\r\n    test('should allow admin to update any demand', async () => {\r\n      const demandRef = doc(admin.firestore(), 'demands', 'bob-demand');\r\n      await setDoc(demandRef, bobDemand);\r\n\r\n      await assertSucceeds(updateDoc(demandRef, { title: 'Admin Updated Title' }));\r\n    });\r\n\r\n    test('should prevent changing SATFK after creation', async () => {\r\n      const demandRef = doc(alice.firestore(), 'demands', 'alice-demand');\r\n      const demandWithSATFK = {\r\n        ...aliceDemand,\r\n        satfk: 'SATFK-20251024-001'\r\n      };\r\n      \r\n      await setDoc(demandRef, demandWithSATFK);\r\n\r\n      // Should fail when trying to change SATFK\r\n      await assertFails(updateDoc(demandRef, { satfk: 'SATFK-20251024-002' }));\r\n    });\r\n\r\n    test('should allow setting SATFK on new demand', async () => {\r\n      const demandRef = doc(alice.firestore(), 'demands', 'new-demand');\r\n      \r\n      // Should succeed when setting SATFK for the first time\r\n      await assertSucceeds(setDoc(demandRef, { \r\n        ...aliceDemand, \r\n        satfk: 'SATFK-20251024-001' \r\n      }));\r\n    });\r\n  });\r\n\r\n  describe('User Access Control', () => {\r\n    test('should allow users to read their own profile', async () => {\r\n      const userRef = doc(alice.firestore(), 'users', 'alice');\r\n      await setDoc(userRef, { name: 'Alice', email: 'alice@test.com' });\r\n\r\n      await assertSucceeds(getDoc(userRef));\r\n    });\r\n\r\n    test('should deny users from reading other users profiles', async () => {\r\n      const userRef = doc(bob.firestore(), 'users', 'alice');\r\n      await setDoc(userRef, { name: 'Alice', email: 'alice@test.com' });\r\n\r\n      await assertFails(getDoc(userRef));\r\n    });\r\n  });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\test\\setup.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\test\\suppliers.test.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getFirestore' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Suppliers Service Tests\r\n * Tests for supplier matching and category functionality\r\n */\r\n\r\nimport { findMatchingSuppliers, getActiveSuppliers, hasMatchingCategories } from '../assets/js/services/suppliers.js';\r\nimport { getFirestore, collection, addDoc } from 'firebase/firestore';\r\n\r\ndescribe('Suppliers Service', () => {\r\n  let db;\r\n\r\n  beforeAll(() => {\r\n    db = global.firebaseDb;\r\n  });\r\n\r\n  beforeEach(async () => {\r\n    await createTestSuppliers();\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await cleanupTestData();\r\n  });\r\n\r\n  describe('findMatchingSuppliers', () => {\r\n    test('should find suppliers with matching categories', async () => {\r\n      const demandCategories = ['electronics', 'computers'];\r\n      const suppliers = await findMatchingSuppliers(demandCategories, 10);\r\n      \r\n      expect(suppliers).toBeDefined();\r\n      expect(Array.isArray(suppliers)).toBe(true);\r\n      \r\n      // All returned suppliers should have at least one matching category\r\n      suppliers.forEach(supplier => {\r\n        const hasMatch = demandCategories.some(category => \r\n          supplier.supplierCategories?.includes(category)\r\n        );\r\n        expect(hasMatch).toBe(true);\r\n      });\r\n    });\r\n\r\n    test('should return empty array for no matching categories', async () => {\r\n      const demandCategories = ['non-existent-category'];\r\n      const suppliers = await findMatchingSuppliers(demandCategories, 10);\r\n      \r\n      expect(suppliers).toBeDefined();\r\n      expect(Array.isArray(suppliers)).toBe(true);\r\n      expect(suppliers.length).toBe(0);\r\n    });\r\n\r\n    test('should respect limit parameter', async () => {\r\n      const demandCategories = ['electronics'];\r\n      const suppliers = await findMatchingSuppliers(demandCategories, 2);\r\n      \r\n      expect(suppliers.length).toBeLessThanOrEqual(2);\r\n    });\r\n  });\r\n\r\n  describe('getActiveSuppliers', () => {\r\n    test('should return only active suppliers', async () => {\r\n      const suppliers = await getActiveSuppliers(10);\r\n      \r\n      expect(suppliers).toBeDefined();\r\n      expect(Array.isArray(suppliers)).toBe(true);\r\n      \r\n      // All suppliers should be active\r\n      suppliers.forEach(supplier => {\r\n        expect(supplier.isActive).toBe(true);\r\n        expect(supplier.isSupplier).toBe(true);\r\n      });\r\n    });\r\n\r\n    test('should respect limit parameter', async () => {\r\n      const suppliers = await getActiveSuppliers(3);\r\n      expect(suppliers.length).toBeLessThanOrEqual(3);\r\n    });\r\n  });\r\n\r\n  describe('hasMatchingCategories', () => {\r\n    test('should return true for matching categories', () => {\r\n      const supplier = {\r\n        supplierCategories: ['electronics', 'computers', 'phones']\r\n      };\r\n      const categories = ['electronics', 'books'];\r\n      \r\n      expect(hasMatchingCategories(supplier, categories)).toBe(true);\r\n    });\r\n\r\n    test('should return false for no matching categories', () => {\r\n      const supplier = {\r\n        supplierCategories: ['electronics', 'computers']\r\n      };\r\n      const categories = ['books', 'clothing'];\r\n      \r\n      expect(hasMatchingCategories(supplier, categories)).toBe(false);\r\n    });\r\n\r\n    test('should handle empty supplier categories', () => {\r\n      const supplier = {\r\n        supplierCategories: []\r\n      };\r\n      const categories = ['electronics'];\r\n      \r\n      expect(hasMatchingCategories(supplier, categories)).toBe(false);\r\n    });\r\n\r\n    test('should handle null supplier categories', () => {\r\n      const supplier = {};\r\n      const categories = ['electronics'];\r\n      \r\n      expect(hasMatchingCategories(supplier, categories)).toBe(false);\r\n    });\r\n  });\r\n\r\n  // Helper functions\r\n  async function createTestSuppliers() {\r\n    const testSuppliers = [\r\n      {\r\n        displayName: 'Electronics Supplier',\r\n        email: 'electronics@test.com',\r\n        isActive: true,\r\n        isSupplier: true,\r\n        supplierCategories: ['electronics', 'computers'],\r\n        createdAt: new Date()\r\n      },\r\n      {\r\n        displayName: 'Computer Supplier',\r\n        email: 'computer@test.com',\r\n        isActive: true,\r\n        isSupplier: true,\r\n        supplierCategories: ['computers', 'laptops'],\r\n        createdAt: new Date()\r\n      },\r\n      {\r\n        displayName: 'Book Supplier',\r\n        email: 'books@test.com',\r\n        isActive: true,\r\n        isSupplier: true,\r\n        supplierCategories: ['books', 'education'],\r\n        createdAt: new Date()\r\n      },\r\n      {\r\n        displayName: 'Inactive Supplier',\r\n        email: 'inactive@test.com',\r\n        isActive: false,\r\n        isSupplier: true,\r\n        supplierCategories: ['electronics'],\r\n        createdAt: new Date()\r\n      },\r\n      {\r\n        displayName: 'Non-Supplier User',\r\n        email: 'user@test.com',\r\n        isActive: true,\r\n        isSupplier: false,\r\n        supplierCategories: [],\r\n        createdAt: new Date()\r\n      }\r\n    ];\r\n\r\n    for (const supplier of testSuppliers) {\r\n      await addDoc(collection(db, 'users'), supplier);\r\n    }\r\n  }\r\n\r\n  async function cleanupTestData() {\r\n    // In a real implementation, this would clean up test data\r\n    console.log('Test cleanup: Supplier test data would be cleared');\r\n  }\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\utils\\build-address.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\utils\\slug-tr.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\utils\\slugify-tr.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\faruk\\OneDrive\\Desktop\\teklifbul-web\\vite.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]