<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yeni Talep</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%233b82f6' rx='6'/%3E%3Ctext x='16' y='22' font-family='Arial' font-size='18' font-weight='bold' text-anchor='middle' fill='white'%3ET%3C/text%3E%3C/svg%3E" />
  <script type="importmap">
  {
    "imports": {
      "categories": "/categories.js"
    }
  }
  </script>
  <link rel="stylesheet" href="/utils.css" />
  <link rel="stylesheet" href="/assets/css/layout.css" />
  <link rel="stylesheet" href="/css/ui-standard.css" />
  <style>
    .items-table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 13px; table-layout: fixed; }
    .items-table th, .items-table td { border: 1px solid #ddd; padding: 6px; }
    
    /* Tablo sütun genişlikleri */
    .items-table th:nth-child(1), .items-table td:nth-child(1) { width: 5%; }   /* Sıra No */
    .items-table th:nth-child(2), .items-table td:nth-child(2) { width: 8%; }   /* Malzeme Kodu (küçük) */
    .items-table th:nth-child(3), .items-table td:nth-child(3) { width: 25%; }  /* Malzeme Tanımı (en uzun) */
    .items-table th:nth-child(4), .items-table td:nth-child(4) { width: 12%; }  /* Marka/Model */
    .items-table th:nth-child(5), .items-table td:nth-child(5) { width: 8%; }   /* Miktar */
    .items-table th:nth-child(6), .items-table td:nth-child(6) { width: 7%; }   /* Birim */
    .items-table th:nth-child(7), .items-table td:nth-child(7) { width: 8%; }   /* Ambar */
    .items-table th:nth-child(8), .items-table td:nth-child(8) { width: 8%; }   /* Hedef */
    .items-table th:nth-child(9), .items-table td:nth-child(9) { width: 10%; }  /* Teslim Tarihi */
    .items-table th:nth-child(10), .items-table td:nth-child(10) { width: 9%; } /* Sil */
    .items-table input, .items-table select { width: 100%; padding: 4px; box-sizing: border-box; margin: 0; }
    
    /* Miktar alanı özel boyutları */
    .items-table .qty {
      width: 100px !important;
      height: 32px !important;
      min-width: 80px;
      max-width: 120px;
    }
    
    /* Diğer input alanları için boyut ayarları */
    .items-table .sku {
      width: 72px !important;  /* %40 küçültüldü: 120px * 0.6 = 72px */
      height: 32px !important;
    }
    
    .items-table .itemName {
      width: 200px !important;  /* En uzun alan - Malzeme Tanımı */
      height: 32px !important;
      min-width: 150px;
      max-width: 300px;
    }
    
    .items-table .unit {
      width: 80px !important;
      height: 32px !important;
    }
    
    .items-table .stockQty,
    .items-table .targetPrice {
      width: 90px !important;
      height: 32px !important;
    }
    
    .items-table .itemDueDate {
      width: 110px !important;
      height: 32px !important;
    }
    .btn-sm { padding: 6px 10px; margin: 4px 0; }
    .badge { display:inline-block; margin:4px 6px 0 0; padding:4px 8px; border-radius:12px; background:#eef2ff; font-size:12px; cursor:pointer; }
    
    /* SATFK Input Responsive Design */
    #satfk {
      min-width: 294px;
      max-width: 100%;
    }
    
    @media (max-width: 768px) {
      #satfk {
        min-width: 200px;
        width: 100% !important;
      }
      
      /* Mobile için input alanları */
      .items-table .qty {
        width: 80px !important;
        height: 30px !important;
        min-width: 60px;
        max-width: 100px;
      }
      
      .items-table .sku {
        width: 60px !important;  /* Mobile'da da %40 küçük */
        height: 30px !important;
      }
      
      .items-table .itemName {
        width: 150px !important;  /* Mobile'da en uzun alan */
        height: 30px !important;
        min-width: 120px;
        max-width: 200px;
      }
      
      .items-table .unit {
        width: 70px !important;
        height: 30px !important;
      }
      
      .items-table .stockQty,
      .items-table .targetPrice {
        width: 80px !important;
        height: 30px !important;
      }
      
      .items-table .itemDueDate {
        width: 100px !important;
        height: 30px !important;
      }
      
      /* Mobile için tablo sütun genişlikleri */
      .items-table th:nth-child(1), .items-table td:nth-child(1) { width: 6%; }   /* Sıra No */
      .items-table th:nth-child(2), .items-table td:nth-child(2) { width: 10%; }  /* Malzeme Kodu */
      .items-table th:nth-child(3), .items-table td:nth-child(3) { width: 30%; }  /* Malzeme Tanımı (en uzun) */
      .items-table th:nth-child(4), .items-table td:nth-child(4) { width: 15%; }  /* Marka/Model */
      .items-table th:nth-child(5), .items-table td:nth-child(5) { width: 10%; }  /* Miktar */
      .items-table th:nth-child(6), .items-table td:nth-child(6) { width: 8%; }   /* Birim */
      .items-table th:nth-child(7), .items-table td:nth-child(7) { width: 10%; }  /* Ambar */
      .items-table th:nth-child(8), .items-table td:nth-child(8) { width: 10%; }  /* Hedef */
      .items-table th:nth-child(9), .items-table td:nth-child(9) { width: 12%; }  /* Teslim Tarihi */
      .items-table th:nth-child(10), .items-table td:nth-child(10) { width: 9%; } /* Sil */
    }
    label { font-weight:600; font-size:14px; }
    #catChips { margin-top: 8px; }
    
    /* === Açıklama Alanı (Teknik Şart / Açıklama) === */
    #descriptionsContainer {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .description-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .description-item textarea {
      min-height: 70px !important;
      width: 100% !important;
      padding: 10px !important;
      font-size: 14px !important;
      line-height: 1.4 !important;
      border: 1px solid #ccc !important;
      border-radius: 6px !important;
      background: #fff !important;
      cursor: text !important;
      transition: all 0.2s ease-in-out !important;
      resize: vertical;
    }
    
    .description-number {
      font-weight: 600;
      color: #374151;
      font-size: 14px;
      min-width: 40px;
      padding-top: 0;
      flex-shrink: 0;
    }
    
    .description-item textarea:focus {
      border-color: #007bff !important;  /* Odaklanınca mavi kenar */
      box-shadow: 0 0 4px rgba(0, 123, 255, 0.3);
      outline: none;
    }
    
    /* === Delete Butonu (Sil ×) === */
    .description-item .delete-btn {
      width: 24px !important;
      height: 24px !important;
      font-size: 14px !important;
      line-height: 20px !important;
      border-radius: 50% !important;
      background: #f8d7da !important;
      color: #d32f2f !important;
      border: none !important;
      cursor: pointer !important;
      transition: all 0.2s ease-in-out !important;
      flex-shrink: 0;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
    
    .description-item .delete-btn:hover {
      background: #d32f2f !important;
      color: #fff !important;
      transform: scale(1.1) !important;
    }
    /* ==== TB util styles (framework-free) ==== */
    .tb-card { border:1px solid #e5e7eb; border-radius:10px; padding:12px; background:#fff; }
    .tb-legend { font-weight:700; color:#1f2937; }
    .tb-check-row { display:grid; grid-template-columns:28px 1fr; gap:12px; align-items:start; cursor:pointer; }
    .tb-check-row input[type="checkbox"]{ width:18px; height:18px; margin-top:2px; }
    .tb-check-title { font-weight:600; color:#111827; }
    .tb-check-desc  { display:block; margin-top:2px; color:#4b5563; font-size:12px; }
    .tb-schedule-fields { margin-top:10px; }
    .tb-field { display:grid; gap:6px; }
    .tb-label { font-size:12px; color:#4b5563; }
    .tb-input { border:1px solid #d1d5db; border-radius:8px; padding:8px 10px; width:100%; }
    .tb-vis-option{ display:grid; grid-template-columns:28px 1fr; gap:12px; align-items:start; padding:10px 8px; border-radius:8px; cursor:pointer; border:1px solid #e5e7eb; margin:4px 0; }
    .tb-vis-option + .tb-vis-option{ margin-top:8px; }
    .tb-vis-option input[type="radio"]{ width:18px; height:18px; margin-top:2px; accent-color:#2563eb; }
    .tb-vis-title{ font-weight:600; color:#111827; line-height:1.2; }
    .tb-vis-desc{ margin-top:4px; color:#4b5563; line-height:1.4; font-size:13px; }
    .tb-vis-option:hover{ background:#f9fafb; }
    .tb-vis-option:has(input[type="radio"]:checked){ background:#E0EDFF; border-color:#2563EB; }
    .tb-vis-option:has(input[type="radio"]:checked) .tb-vis-title,
    .tb-vis-option:has(input[type="radio"]:checked) .tb-vis-desc{ color:#1E3A8A; }
    /* Talep Tipi (biddingMode) seçimlerini kolay tıklanır ve seçili vurgulu yap */
    label:has(> input[name="biddingMode"]) { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid #e5e7eb; border-radius:8px; cursor:pointer; margin:4px 6px 4px 0; }
    label:has(> input[name="biddingMode"]:checked) { background:#E0EDFF; border-color:#2563EB; color:#1E3A8A; }
    input[name="biddingMode"]{ width:16px; height:16px; accent-color:#2563eb; }
    /* Süre seçiliyse aynı vurguyu uygula */
    fieldset.tb-card:has(#isTimeBound:checked){ background:#E0EDFF; border-color:#2563EB; }
    fieldset.tb-card:has(#isTimeBound:checked) .tb-legend, 
    fieldset.tb-card:has(#isTimeBound:checked) .tb-check-title,
    fieldset.tb-card:has(#isTimeBound:checked) label { color:#1E3A8A; }
    /* Advanced item editor overrides inside items table */
    .items-table .adv-input{ width:auto !important; }
    .items-table .adv-key{ width:160px !important; }
    .items-table .adv-val{ min-width:180px !important; }
    .items-table .quickCert, .items-table .addPair, .items-table .addCert{ width:auto !important; display:inline-block; }
    .items-table .quickCert{ color:#111827 !important; background:#f9fafb !important; border:1px solid #d1d5db !important; border-radius:12px !important; padding:4px 8px !important; font-size:12px !important; }
  </style>
</head>
<body>
  <!-- Common Header -->
  <header id="app-header"></header>

  <div class="container--wide" style="padding:20px 0">
    <h1 id="pageTitle">Yeni Talep Oluştur</h1>
    <p>
      <a href="./demands.html">← Talepler</a> • 
      <a href="./dashboard.html">← Dashboard</a> • 
      <a href="./bids.html">Gelen Teklifler</a> • 
      <a href="./main-demands.html">Ana Talep Ekranı</a>
    </p>

  <h3>Başlık Bilgileri</h3>
  <div class="row">
    <div>
      <label for="satfk">Satın Alma Talep Formu Kodu (SATFK)</label>
      <div style="display: flex; align-items: center; gap: 8px;">
        <input id="satfk" type="text" readonly style="background:#f9fafb; color:#6b7280; flex: 1; width: 294px;" placeholder="Kod oluşturuluyor..." />
        <button id="copySatfkBtn" class="btn-sm" style="padding: 4px 8px; font-size: 11px; display: none;">📋 Kopyala</button>
        <button id="refreshSatfkBtn" class="btn-sm" style="padding: 4px 8px; font-size: 11px; background: #10b981; color: white;">🔄 Yenile</button>
      </div>
      <div id="satfkPreview" style="font-size: 12px; color: #6b7280; margin-top: 4px;">
        <span id="satfkStatus">Kod oluşturuluyor...</span>
      </div>
    </div>
  </div>

  <div class="row">
    <div>
      <label for="demandDate">Talep Tarihi *</label>
      <input id="demandDate" type="date" autocomplete="off" required />
    </div>
    <div>
      <label for="siteName">Şantiye *</label>
      <input id="siteName" placeholder="Şantiye/Saha adı" autocomplete="off" required />
    </div>
  </div>

  <div class="row">
    <div>
      <label for="purchaseLocation">Alım Yeri (İl) *</label>
      <input id="purchaseLocation" list="provinceList" placeholder="İl seçiniz" required />
      <datalist id="provinceList">
        <option value="Adana"></option>
        <option value="Adıyaman"></option>
        <option value="Afyonkarahisar"></option>
        <option value="Ağrı"></option>
        <option value="Amasya"></option>
        <option value="Ankara"></option>
        <option value="Antalya"></option>
        <option value="Artvin"></option>
        <option value="Aydın"></option>
        <option value="Balıkesir"></option>
        <option value="Bilecik"></option>
        <option value="Bingöl"></option>
        <option value="Bitlis"></option>
        <option value="Bolu"></option>
        <option value="Burdur"></option>
        <option value="Bursa"></option>
        <option value="Çanakkale"></option>
        <option value="Çankırı"></option>
        <option value="Çorum"></option>
        <option value="Denizli"></option>
        <option value="Diyarbakır"></option>
        <option value="Edirne"></option>
        <option value="Elazığ"></option>
        <option value="Erzincan"></option>
        <option value="Erzurum"></option>
        <option value="Eskişehir"></option>
        <option value="Gaziantep"></option>
        <option value="Giresun"></option>
        <option value="Gümüşhane"></option>
        <option value="Hakkari"></option>
        <option value="Hatay"></option>
        <option value="Isparta"></option>
        <option value="Mersin"></option>
        <option value="İstanbul"></option>
        <option value="İzmir"></option>
        <option value="Kars"></option>
        <option value="Kastamonu"></option>
        <option value="Kayseri"></option>
        <option value="Kırklareli"></option>
        <option value="Kırşehir"></option>
        <option value="Kocaeli"></option>
        <option value="Konya"></option>
        <option value="Kütahya"></option>
        <option value="Malatya"></option>
        <option value="Manisa"></option>
        <option value="Kahramanmaraş"></option>
        <option value="Mardin"></option>
        <option value="Muğla"></option>
        <option value="Muş"></option>
        <option value="Nevşehir"></option>
        <option value="Niğde"></option>
        <option value="Ordu"></option>
        <option value="Rize"></option>
        <option value="Sakarya"></option>
        <option value="Samsun"></option>
        <option value="Siirt"></option>
        <option value="Sinop"></option>
        <option value="Sivas"></option>
        <option value="Tekirdağ"></option>
        <option value="Tokat"></option>
        <option value="Trabzon"></option>
        <option value="Tunceli"></option>
        <option value="Şanlıurfa"></option>
        <option value="Uşak"></option>
        <option value="Van"></option>
        <option value="Yozgat"></option>
        <option value="Zonguldak"></option>
        <option value="Aksaray"></option>
        <option value="Bayburt"></option>
        <option value="Karaman"></option>
        <option value="Kırıkkale"></option>
        <option value="Batman"></option>
        <option value="Şırnak"></option>
        <option value="Bartın"></option>
        <option value="Ardahan"></option>
        <option value="Iğdır"></option>
        <option value="Yalova"></option>
        <option value="Karabük"></option>
        <option value="Kilis"></option>
        <option value="Osmaniye"></option>
        <option value="Düzce"></option>
      </datalist>
    </div>
    <div>
      <label for="title">Başlık *</label>
      <input id="title" placeholder="Talep başlığı" required />
    </div>
  </div>



  <label for="catInput">Kategori(ler)</label>
  <div id="catWrap">
    <!-- Kategori Grupları -->
    <div id="categoryGroups" style="margin-bottom: 16px;">
      <h4 style="margin: 8px 0; font-size: 14px; color: #374151;">📁 Kategori Grupları</h4>
      
      <!-- Group Management -->
      <div style="display: flex; justify-content: flex-end; margin-bottom: 12px;">
        <button id="btnGroupHub" type="button"
          style="display:flex;align-items:center;gap:8px;padding:10px 14px;border:0;border-radius:8px;
                 background:#2563eb;color:#fff;font-weight:600;cursor:pointer;">
          🗂️ Yeni Grup Oluştur / 🛠️ Grupları Yönet
        </button>
      </div>
      
      
      <!-- Group Buttons (Legacy) -->
      <div id="groupButtons" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
        <!-- Grup butonları buraya eklenecek -->
      </div>
    </div>
    
    
    <!-- Seçilen Kategoriler -->
    <div id="catChips"></div>
  </div>

  <!-- Talep Görünürlüğü kaldırıldı: UI gizlendi -->
  <div style="margin-bottom: 16px; display:none;">
    <h4 style="margin: 8px 0; font-size: 18px; color: #111827;">👁️ Talep Görünürlüğü</h4>
    <div style="display: flex; gap: 16px; margin-bottom: 12px;">
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="demandVisibility" value="genel" checked style="margin: 0;">
        <span>Genel (tüm kullanıcılar)</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="demandVisibility" value="ozel" style="margin: 0;">
        <span>Özel (davetli)</span>
      </label>
    </div>

    <!-- Özel görünürlük ayarları: Grup seçimi + davet modu -->
    <div id="privateVisibilitySettings" style="display: none; margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 6px;">
      <h5 style="margin: 0 0 8px 0; font-size: 13px; color: #374151;">Davetliler</h5>

      <!-- Grup seçimi (chip/pill çoklu seçim) -->
      <div style="margin-bottom: 8px;">
        <div style="font-size:12px; color:#374151; margin-bottom:4px;">Tedarikçi Grupları</div>
        <div id="inviteGroupPicker" style="display:flex; flex-wrap: wrap; gap:8px;"></div>
        <div style="font-size:12px; color:#6b7280; margin-top:4px;">Seçtiğiniz gruplardaki firmalar otomatik davet edilir.</div>
      </div>

      <!-- Davet modu seçimleri -->
      <div style="display:flex; gap:16px; align-items:center; margin: 8px 0;">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
          <input type="radio" name="inviteMode" value="auto" checked style="margin:0;" />
          <span>Gruba göre otomatik</span>
        </label>
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
          <input type="radio" name="inviteMode" value="custom" style="margin:0;" />
          <span>Özelleştir (firma seç)</span>
        </label>
      </div>

      <!-- Otomatik özet (sadece sayı) -->
      <div id="autoInviteSummary" style="display:block; font-size:12px; color:#374151;">
        Otomatik davetli sayısı: <span id="autoInviteCount">0</span>
        <button type="button" id="loadGroupMembersBtn" class="btn-sm" style="margin-left:8px;">Grup Üyelerini Yükle</button>
      </div>

      <!-- Özelleştir: mevcut tedarikçi seçimi bileşeni -->
      <div id="customInviteEditor" style="display:none; margin-top:8px;">
        <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">Grup listesini başlangıç olarak kullanmak için "Grup Üyelerini Yükle" deyip aşağıdan düzenleyin.</div>
        <button type="button" id="selectSuppliersBtn" style="padding: 8px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
          👥 Tedarikçi Seç
        </button>
        <div id="selectedSuppliers" style="margin-top: 8px; font-size: 12px; color: #6b7280;">
          Henüz tedarikçi seçilmedi
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div>
      <label for="dueDate">Termin Tarihi *</label>
      <input id="dueDate" type="date" required />
    </div>
    <div>
      <label for="priority">Öncelik *</label>
      <select id="priority" required>
        <option value="price">Fiyat</option>
        <option value="speed">Hız</option>
        <option value="quality">Kalite</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div>
      <label for="currency">Para Birimi *</label>
      <select id="currency" required>
        <option>TRY</option><option>USD</option><option>EUR</option>
      </select>
    </div>
    <div>
      <label for="paymentTerms">Ödeme Şartları</label>
      <input id="paymentTerms" placeholder="örn. %50 peşin" />
    </div>
    <div style="align-self:end;">
      <button id="btnOpenPaymentBuyer" type="button" class="btn btn-primary">Ödeme Seçenekleri…</button>
    </div>
  </div>

  <!-- Payment Modal (Buyer) -->
  <div id="paymentModalBuyer" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1100;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:min(900px,96vw); max-height:90vh; overflow:auto; background:#fff; border-radius:8px; padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center; margin-bottom:8px;">
        <h3 style="margin:0;">Ödeme Seçenekleri</h3>
        <button id="closePaymentBuyer" class="btn" style="padding:6px 10px; background:#ef4444; color:#fff;">Kapat</button>
      </div>
      <section id="payment-section" class="payment">
        <style>
          .hidden{display:none!important}
          #payment-section .row{display:grid;grid-template-columns:180px 1fr;gap:12px;align-items:center;margin:8px 0}
          #payment-section fieldset{border:1px solid #e5e7eb;border-radius:8px;padding:8px;margin:10px 0}
          #payment-section fieldset legend{font-weight:600}
          #payment-section #payment-type{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:8px 12px;align-items:center}
          #payment-section label{font-size:14px;color:#111827}
          #payment-section #payment-type label{display:inline-flex;align-items:center;gap:8px;margin:0;font-size:16px;font-weight:600}
          #payment-section input[type="radio"]{width:16px;height:16px;accent-color:#2563eb}
          #payment-section h4{margin:8px 0 6px 0}
          #payment-section .group{padding:10px;border:1px solid #f3f4f6;border-radius:8px;background:#fafafa;margin-top:8px}
          #payment-section #pesin-group label{display:inline-flex;align-items:center;gap:8px;margin:4px 12px 4px 0;font-weight:600;font-size:15px}
          #payment-section .desc{font-size:12.5px;color:#4b5563;margin-top:6px;line-height:1.4}
          #payment-section .hint{font-size:12px;color:#6b7280}
          @media (max-width:640px){#payment-section #payment-type{grid-template-columns:repeat(2,minmax(140px,1fr))}}
        </style>
        <h3>Ödeme Seçenekleri</h3>
        <fieldset id="payment-type"><legend>Ödeme Tipi</legend><label><input type="radio" name="paymentType" value="pesin" /> Peşin</label><label><input type="radio" name="paymentType" value="krediKarti" /> Kredi Kartı</label><label><input type="radio" name="paymentType" value="acikHesap" /> Açık Hesap</label><label><input type="radio" name="paymentType" value="evrak" /> Evrak (çek/senet)</label></fieldset>
        <div class="row"><label>KDV Dahil Toplam</label><span id="ccBaseIncl">—</span></div>
        <div id="pesin-group" class="group hidden"><h4>Peşin Alt Model</h4><label><input type="radio" name="pesinModel" value="escrow"> (a) Escrow</label><label><input type="radio" name="pesinModel" value="onayli"> (b) Teslim & Onay</label><label><input type="radio" name="pesinModel" value="onodeme"> (c) Ön Ödeme</label><div class="desc">(a) Escrow: Ödeme blokeli hesapta tutulur; alıcı teslim onayı sonrası serbest kalır.<br>(b) Teslim & Onay: Alıcı teslimi onayladıktan sonra ödeme yapılır.<br>(c) Ön Ödeme: Belirtilen oran kadar ön ödeme sonrası üretim/sevkiyat başlar.</div><div id="prepayment-config" class="row hidden"><label>Ön Ödeme Oranı (%)</label><input type="number" id="prepaymentRate" min="0" max="100" step="1" value="30"></div></div>
        <div id="kk-group" class="group hidden"><h4>Kredi Kartı</h4><div class="row"><label>Taksit Sayısı</label><input id="installments" type="number" min="1" value="1" style="width:100px"><label>Vade Farkı (%)</label><input type="number" id="financeRate" value="0" min="0" step="0.01"><label>Kampanya / Açıklama</label><input id="ccCampaign" placeholder="…"></div><div class="row calc"><div>Vade Tutarı: <span id="ccFinanceAmt">—</span></div><div>Toplam (KDV Dahil): <span id="ccTotalIncl">—</span></div><div>Aylık Taksit: <span id="ccMonthly">—</span></div></div></div>
        <div id="ah-group" class="group hidden"><h4>Açık Hesap</h4><div class="row"><label>Fatura Tarihi</label><input type="date" id="invoiceDate"><label>Vade (Gün)</label><select id="netDays"><option value="7">+7 gün</option><option value="15">+15 gün</option><option value="30">+30 gün</option><option value="45">+45 gün</option><option value="60">+60 gün</option></select><input id="netDaysCustom" type="number" min="1" placeholder="Özel vade günü (örn. 53)" style="width:160px"><span class="hint" style="font-size:13px;">Özel vade günü yazınca tarih otomatik hesaplanır (hafta sonu Pazartesi).</span></div><div class="row calc"><div>Vade Tarihi: <span id="dueDateHuman">—</span></div></div></div>
        <div id="evrak-group" class="group hidden"><h4>Evrak (çek/senet)</h4><div style="margin-bottom:8px;"><button id="btnAddCheck" class="btn btn-secondary" style="padding:6px 10px;">+ Çek Ekle</button></div><div id="checksBody"></div></div>
        <hr><div id="summary" class="summary"></div><button id="savePayment" class="btn btn-primary" style="margin-top:8px;">Kaydet</button>
      </section>
    </div>
  </div>

  <script type="module">
    const openBtn = document.getElementById('btnOpenPaymentBuyer');
    const modal = document.getElementById('paymentModalBuyer');
    const closeBtn = document.getElementById('closePaymentBuyer');
    let selectedPaymentPrefBuyer = null;
    openBtn?.addEventListener('click', async ()=>{ modal.style.display = 'block'; if (!window.paymentModule){ try{ await import('/scripts/payment-module.js'); }catch(_){} } if (window.paymentModule){ window.paymentModule.setRole('buyer'); try{ window.paymentModule.setTotals({ totalIncl: 0 }); }catch(_){} } });
    closeBtn?.addEventListener('click', ()=> modal.style.display = 'none');
    document.addEventListener('payment:save', (e)=>{ selectedPaymentPrefBuyer = e.detail; modal.style.display='none'; });
    // Expose to header builder
    window.__getBuyerPaymentPref = ()=> selectedPaymentPrefBuyer;
  </script>



  <h3>Talep Tipi</h3>
  <div style="margin:16px 0; padding:16px; background:#f9fafb; border-radius:6px;">
    <div style="margin-bottom:12px;">
      <label style="display:block; margin-bottom:8px;">
        <input type="radio" name="biddingMode" value="secret" checked /> 
        <strong>Gizli Teklif (tek tur)</strong>
      </label>
      <p style="margin:0 0 12px 24px; font-size:13px; color:#6b7280;">Tedarikçiler yalnız kendi tekliflerini görebilir. Diğer teklifleri göremez.</p>
      
      <label style="display:block; margin-bottom:8px;">
        <input type="radio" name="biddingMode" value="open" /> 
        <strong>Açık Teklif (tek tur)</strong>
      </label>
      <p style="margin:0 0 12px 24px; font-size:13px; color:#6b7280;">Tüm fiyatlar ve tedarikçi isimleri görünür. Tam şeffaflık sağlar.</p>
      
      <label style="display:block; margin-bottom:8px;">
        <input type="radio" name="biddingMode" value="hybrid" /> 
        <strong>Hibrit (1. tur gizli, 2. tur açık)</strong>
      </label>
      <p style="margin:0 0 12px 24px; font-size:13px; color:#6b7280;">İlk turda gizli teklifler alınır, ikinci turda açık artırma yapılır. En iyi sonuçlar için.</p>
      
      <!-- Hibrit mod için 1. tur süresi -->
      <div id="hybridSettings" style="display:none; margin-left:24px; padding:12px; background:#f0f9ff; border-radius:6px; border:1px solid #0ea5e9;">
        <h4 style="margin:0 0 8px 0; font-size:14px; color:#0c4a6e;">1. Tur Ayarları</h4>
        <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px;">
          <label style="font-size:13px; color:#0c4a6e;">1. Tur Süresi:</label>
          <input type="number" id="firstRoundDays" min="1" max="30" value="7" style="width:60px; padding:4px; border:1px solid #0ea5e9; border-radius:4px;" />
          <span style="font-size:13px; color:#0c4a6e;">gün</span>
        </div>
        <div style="display:flex; gap:12px; align-items:center;">
          <label style="font-size:13px; color:#0c4a6e;">2. Turda Tedarikçi İsimleri:</label>
          <select id="secondRoundSupplierVisibility" style="padding:4px; border:1px solid #0ea5e9; border-radius:4px;">
            <option value="visible">Görünür</option>
            <option value="hidden">Gizli</option>
          </select>
        </div>
        <div style="display:flex; gap:12px; align-items:center; margin-top:8px;">
          <label style="font-size:13px; color:#0c4a6e;">2. Tur Süresi:</label>
          <input type="number" id="secondRoundDays" min="1" max="30" value="7" style="width:60px; padding:4px; border:1px solid #0ea5e9; border-radius:4px;" />
          <span style="font-size:13px; color:#0c4a6e;">gün</span>
        </div>
        <p style="margin:8px 0 0 0; font-size:12px; color:#0c4a6e;">1. tur bitince otomatik olarak 2. tur açılır ve açık artırma başlar.</p>
      </div>
    </div>
    
    <fieldset class="tb-card" style="margin-top:16px;">
      <legend class="tb-legend">Süre</legend>
      <label class="tb-check-row">
        <input type="checkbox" id="isTimeBound" />
        <span class="tb-check-body">
          <span class="tb-check-title">Süreli (Başlangıç ve Bitiş Tarihi Belirle)</span>
          <span id="scheduleHint" class="tb-check-desc">Seçilmezse talep şimdi başlar ve manuel olarak kapatılana kadar devam eder.</span>
        </span>
      </label>

      <div id="timeBoundFields" class="tb-schedule-fields" hidden>
        <!-- For secret/open modes -->
        <div id="singlePhaseTime" style="margin-top:12px;">
          <div class="row">
            <div>
              <label for="phaseStart">Başlangıç</label>
              <input type="datetime-local" id="phaseStart" />
            </div>
            <div>
              <label for="phaseEnd">Bitiş</label>
              <input type="datetime-local" id="phaseEnd" />
            </div>
          </div>
        </div>
        
        <!-- For hybrid mode -->
        <div id="hybridPhaseTime" style="display:none; margin-top:12px;">
          <h4 style="margin:0 0 8px 0; font-size:14px;">1. Tur (Gizli)</h4>
          <div class="row">
            <div>
              <label for="round1Start">Başlangıç</label>
              <input type="datetime-local" id="round1Start" />
            </div>
            <div>
              <label for="round1End">Bitiş</label>
              <input type="datetime-local" id="round1End" />
            </div>
          </div>
          
          <h4 style="margin:12px 0 8px 0; font-size:14px;">2. Tur (Açık)</h4>
          <div class="row">
            <div>
              <label for="round2Start">Başlangıç</label>
              <input type="datetime-local" id="round2Start" />
            </div>
            <div>
              <label for="round2End">Bitiş</label>
              <input type="datetime-local" id="round2End" />
            </div>
          </div>
        </div>
      </div>
    </fieldset>

    <!-- Hariç tut alanı kaldırıldı -->

  <fieldset class="tb-card" style="margin-top:12px;">
    <legend class="tb-legend">Ana Talep Ekranında Görünürlük</legend>
    <label class="tb-vis-option">
      <input type="radio" name="mainDemandVisibility" value="private" checked />
      <div class="tb-vis-body">
        <div class="tb-vis-title">Özel Talep: Sadece belirtilen tedarikçiler görebilir</div>
        <p class="tb-vis-desc">Talep sadece size özel olarak belirtilen tedarikçilere gönderilir.</p>
      </div>
    </label>
    <label class="tb-vis-option">
      <input type="radio" name="mainDemandVisibility" value="main" />
      <div class="tb-vis-body">
        <div class="tb-vis-title">Ana Ekranda Göster: Tüm tedarikçiler ana talep ekranında görebilir</div>
        <p class="tb-vis-desc">Talep ana talep ekranında görünür ve tedarikçiler ürün bazlı arama yaparak bulabilir.</p>
      </div>
    </label>
  </fieldset>

  <h3>Ürün Kalemleri</h3>
  <button type="button" id="addLineBtn" class="btn-sm">+ Satır Ekle</button>
  <div class="table-responsive">
    <table class="items-table" id="itemsTable">
    <thead>
      <tr>
        <th style="width: 60px;">Sıra No</th>
        <th style="width: 120px;">Malzeme Kodu</th>
        <th style="width: 300px;">Malzeme Tanımı *</th>
        <th style="width: 120px;">Marka/Model</th>
        <th style="width: 108px;">Miktar *</th>
        <th style="width: 136px;">Birim *</th>
        <th style="width: 100px;">Ambardaki Miktar</th>
        <th style="width: 100px;">Hedef Fiyat (TL)</th>
        <th style="width: 160px;">Ürün Görseli</th>
        <th style="width: 120px;">İstenilen Teslim Tarihi</th>
        <th style="width: 60px;">Sil</th>
      </tr>
    </thead>
    <tbody id="itemsBody"></tbody>
    </table>
  </div>

  <!-- Açıklama Bölümü (Ürün Kalemlerinin Altında) -->
  <h3>Açıklama</h3>
  <div style="margin-bottom: 16px;">
    <label for="spec">Teknik Şart / Açıklama</label>
    <div style="margin-bottom: 12px;">
      <div style="display: flex; gap: 8px; margin-bottom: 8px;">
        <button type="button" id="addDescriptionBtn" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
          ➕ Açıklama Ekle
        </button>
        <button type="button" id="clearDescriptionsBtn" style="padding: 6px 12px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
          🗑️ Temizle
        </button>
      </div>
      <div id="descriptionsContainer">
        <!-- Dinamik açıklama alanları buraya eklenecek -->
      </div>
    </div>
  </div>

  <!-- Onay Kişileri Bölümü -->
  <h3>Onay Kişileri</h3>
  <div class="row">
    <div>
      <label for="requester">Talep Eden *</label>
      <input id="requester" placeholder="Talep eden kişinin adı soyadı" required />
    </div>
    <div>
      <label for="purchaseManager">Satın Alma Müdürü</label>
      <input id="purchaseManager" placeholder="Satın alma müdürü adı soyadı" />
    </div>
  </div>
  
  <div class="row">
    <div>
      <label for="generalManager">Genel Müdür</label>
      <input id="generalManager" placeholder="Genel müdür adı soyadı" />
    </div>
    <div>
      <label for="approver">Onay Veren</label>
      <input id="approver" placeholder="Onay veren kişinin adı soyadı" />
    </div>
  </div>

  <!-- Teslim Şekli Bölümü -->
  <h3>Teslim Şekli *</h3>
  <div style="margin-bottom: 16px;">
    <div style="display: flex; gap: 16px; margin-bottom: 12px; flex-wrap: wrap;">
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="deliveryMethod" value="nakliye_dahil" style="margin: 0;">
        <span>🚚 Nakliye Dahil</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="deliveryMethod" value="nakliye_haric" style="margin: 0;">
        <span>📦 Nakliye Hariç</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="deliveryMethod" value="custom" style="margin: 0;">
        <span>✏️ Özel Teslimat</span>
      </label>
    </div>
    <div id="customDeliveryContainer" style="display: none; margin-top: 12px;">
      <label for="customDelivery">Özel Teslimat Açıklaması *</label>
      <input id="customDelivery" placeholder="Özel teslimat talebinizi yazın" />
    </div>
    <div style="margin-top: 12px;">
      <label for="deliveryMethodCustom">Teslim Şekli (Elle Yaz) *</label>
      <input id="deliveryMethodCustom" placeholder="Teslim şeklini elle yazın" required />
      <p class="muted" style="margin-top:4px; font-size: 12px; color: #6b7280;">Yukarıdaki seçeneklerden birini seçin veya elle yazın</p>
    </div>
  </div>

  <!-- Teslimat Adresi Bölümü -->
  <h3>Teslimat Adresi</h3>
  <div style="margin-bottom: 16px;">
    <div style="display: flex; gap: 12px; margin-bottom: 12px; align-items: center; flex-wrap: wrap;">
      <label for="deliveryAddressSelect" style="font-weight: 600; min-width: 120px;">Adres Seçimi:</label>
      <select id="deliveryAddressSelect" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; min-width: 250px; flex: 1;">
        <option value="">Başlık seçin</option>
      </select>
      <button type="button" id="refreshAddressesBtn" style="padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
        🔄 Yenile
      </button>
    </div>
    <div id="deliveryAddressContainer">
      <textarea id="deliveryAddress" placeholder="Teslimat adresini yazın veya yukarıdan seçin" rows="3" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;"></textarea>
    </div>
  </div>

  <!-- Talep Oluştur Butonu -->
  <div style="margin: 32px 0; text-align: center;">
    <button type="button" id="createBtn" class="btn btn-primary" style="padding: 16px 32px; font-size: 18px; font-weight: 600;">
      📝 Talep Oluştur
    </button>
  </div>


  <!-- Onay Modal -->
  <div id="approvalModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
      <div style="text-align: center; margin-bottom: 20px;">
        <h2 style="margin: 0 0 10px 0; color: #1f2937;">🎉 Talep Başarıyla Oluşturuldu!</h2>
        <p style="margin: 0; color: #6b7280;">SATFK: <strong id="approvalDemandCode">-</strong></p>
      </div>
      
      <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
        <h3 style="margin: 0 0 12px 0; color: #0c4a6e; font-size: 16px;">📋 Son Kontrol</h3>
        <p style="margin: 0; color: #0c4a6e; font-size: 14px;">
          Talebinizi son kez kontrol edin. Onayladıktan sonra talep ilgili tedarikçi firmalara gönderilecektir.
        </p>
      </div>
      
      <div style="display: flex; gap: 12px; justify-content: center;">
        <button id="approveDemandBtn" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
          ✅ Talebi Onayla ve Gönder
        </button>
        <button id="saveAsDraftBtn" style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
          💾 Taslak Olarak Kaydet
        </button>
        <button id="editDemandBtn" style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
          ✏️ Düzenle
        </button>
      </div>
      
      <div style="margin-top: 16px; text-align: center;">
        <button id="closeApprovalModalBtn" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">
          ✕ Kapat
        </button>
      </div>
    </div>
  </div>

  <!-- Main Script -->
  <script type="module">
    import { db, auth, requireAuth } from "./firebase.js";
    import { setupHeader } from "./src/common-company.js";
    
    // Setup common header functionality (logout and company name)
    await setupHeader();

    // Handle main demand visibility radio buttons
    document.querySelectorAll('input[name="mainDemandVisibility"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const mainDemandFields = document.getElementById('mainDemandFields');
        if (!mainDemandFields) return; // Opsiyonel alan yoksa atla
        if (this.value === 'main') {
          mainDemandFields.style.display = 'block';
        } else {
          mainDemandFields.style.display = 'none';
        }
      });
    });
  </script>

  <datalist id="unitList">
    <option>adet</option><option>paket</option><option>kutu</option><option>koli</option>
    <option>set</option><option>çift</option><option>parça</option><option>kg</option>
    <option>g</option><option>ton</option><option>lt</option><option>ml</option>
    <option>m</option><option>cm</option><option>mm</option><option>m²</option>
  <option>m³</option><option>rulo</option><option>sac</option><option>tabaka</option>
  <option>sheet</option><option>kangal</option><option>varil</option><option>kova</option>
  <option>bidon</option><option>kase</option><option>torba</option><option>çarşaf</option>
</datalist>

<!-- Tedarikçi Seçim Modalı -->
<div id="supplierSelectionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; padding: 24px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0; font-size: 18px; color: #1f2937;">👥 Tedarikçi Seçimi</h3>
      <button type="button" id="closeSupplierModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
    </div>
    
    <div style="margin-bottom: 16px;">
      <input type="text" id="supplierSearch" placeholder="Tedarikçi ara..." style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
    </div>
    
    <div id="supplierList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px;">
      <!-- Tedarikçi listesi buraya eklenecek -->
    </div>
    
    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span id="selectedCount" style="font-size: 14px; color: #6b7280;">Seçilen: 0 tedarikçi</span>
        <div style="display: flex; gap: 8px;">
          <button type="button" id="cancelSupplierSelection" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">İptal</button>
          <button type="button" id="confirmSupplierSelection" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">Seçimi Onayla</button>
        </div>
      </div>
    </div>
  </div>
</div>

  <script type="module">
    import { initGlobalHeader } from './assets/js/ui/header.js';
    import { initAutoResize, reinitAutoResize } from './assets/js/ui/auto-resize.js';
    import { requireAuth, db } from "./firebase.js";
    
    // Initialize global header
    initGlobalHeader({ mount: '#app-header', activeRoute: 'new' });
    import { CATEGORIES } from "./categories.js";
    import { addDoc, collection, serverTimestamp, updateDoc, doc, query, where, getDocs, getDoc, deleteDoc, orderBy, arrayUnion } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { listGroupsForUser, createGroup, updateGroup, deleteGroup } from "./assets/js/services/category-groups.js";
    // Modal artık otomatik olarak yükleniyor - import gerekmiyor
    // SATFK generation moved to Cloud Functions

    const user = await requireAuth();

    const el = id => {
      const element = document.getElementById(id);
      if (!element) {
        console.warn(`Element bulunamadı: ${id}`);
        return null;
      }
      return element;
    };
    const createBtn = el("createBtn");
    const addLineBtn = el("addLineBtn");
    // SATFK field (readonly, auto-generated)
    const satfkField = el("satfk");
    const itemsBody = el("itemsBody");
    const pageTitle = el("pageTitle");

    // Category Groups system
    const btnGroupHub = el("btnGroupHub");
    
    // Dropdown'ı tamamen kaldır (artık sadece butonlar kullanılacak)
    // Opsiyonel olduğu için uyarı üretmemek adına doğrudan native API kullan
    const categoryGroupSelect = document.getElementById("categoryGroupSelect");
    if (categoryGroupSelect) categoryGroupSelect.remove();
    
    // Modal artık otomatik olarak yükleniyor - window.categoryGroupsModal kullan

    let lineCounter = 0;

    // Check for edit mode
    const params = new URLSearchParams(location.search);
    const editId = params.get("id");
    let editing = false;
    let demandRef = null;

    // Set today as default demand date
    el("demandDate").valueAsDate = new Date();

    // Category chip system
    const chips = new Set();

    // Category Groups system
    const categoryGroups = new Map(); // groupName -> Set of categories
    let currentGroupName = null;

    // Private demand system
    let selectedSuppliers = new Set(); // Set of supplier IDs
    let allSuppliers = []; // All available suppliers

    function renderChips() {
      const box = el("catChips");
      box.innerHTML = "";
      [...chips].forEach(v => {
        const span = document.createElement("span");
        span.className = "badge";
        span.textContent = v + " ✕";
        span.onclick = () => { chips.delete(v); renderChips(); };
        box.appendChild(span);
      });
    }

    function renderGroupButtons() {
      const container = el("groupButtons");
      container.innerHTML = "";
      
      // Varsayılan gruplar
      const defaultGroups = [
        { name: "İnşaat Malzemeleri", categories: ["İnşaat Malzemeleri", "Hırdavat", "Boya"] },
        { name: "Elektrik", categories: ["Elektrik", "Elektronik"] },
        { name: "Makine-İmalat", categories: ["Makine-İmalat", "Sac/Metal", "Otomotiv Yan Sanayi"] },
        { name: "Diğer", categories: ["Ambalaj", "Kimyasal", "Mobilya", "Plastik", "İş Güvenliği", "Temizlik", "Gıda", "Hizmet", "Lojistik"] }
      ];

      // Varsayılan grupları ekle
      defaultGroups.forEach(group => {
        if (!categoryGroups.has(group.name)) {
          categoryGroups.set(group.name, new Set(group.categories));
        }
      });

      // Grup butonlarını render et
      categoryGroups.forEach((categories, groupName) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "group-btn";
        button.style.cssText = `
          padding: 8px 12px; 
          margin: 4px; 
          background: ${currentGroupName === groupName ? '#10b981' : '#f3f4f6'}; 
          color: ${currentGroupName === groupName ? 'white' : '#374151'}; 
          border: 1px solid #d1d5db; 
          border-radius: 6px; 
          cursor: pointer; 
          font-size: 12px;
          transition: all 0.2s;
        `;
        button.textContent = `${groupName} (${categories.size})`;
        button.title = `Kategoriler: ${[...categories].join(', ')}`;
        
        button.addEventListener("click", () => {
          if (currentGroupName === groupName) {
            // Grup seçimini kaldır
            currentGroupName = null;
            button.style.background = '#f3f4f6';
            button.style.color = '#374151';
          } else {
            // Grup seç
            currentGroupName = groupName;
            // Önceki seçimi temizle
            container.querySelectorAll('.group-btn').forEach(btn => {
              btn.style.background = '#f3f4f6';
              btn.style.color = '#374151';
            });
            button.style.background = '#10b981';
            button.style.color = 'white';
            
            // Grup kategorilerini ekle
            categories.forEach(cat => chips.add(cat));
            renderChips();
          }
        });
        
        // Sağ tık menüsü ekle
        button.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          const action = confirm(`"${groupName}" grubunu düzenlemek istiyor musunuz?\n\nTamam = Düzenle\nİptal = Sil`);
          if (action) {
            editGroup(groupName);
          } else {
            if (confirm(`"${groupName}" grubunu silmek istediğinizden emin misiniz?`)) {
              categoryGroups.delete(groupName);
              if (currentGroupName === groupName) {
                currentGroupName = null;
              }
              renderGroupButtons();
            }
          }
        });
        
        container.appendChild(button);
      });
    }

    // SATFK is auto-generated by Cloud Function

    // Private Demand Functions
    async function loadSuppliers() {
      try {
        const supplierMap = new Map();

        const queriesToRun = [
          // New roles object format: roles.supplier === true
          query(
            collection(db, 'users'),
            where('roles.supplier', '==', true)
          ),
          // Legacy single role field: role === 'supplier'
          query(
            collection(db, 'users'),
            where('role', '==', 'supplier')
          ),
          // Legacy roles array: roles array-contains 'supplier'
          query(
            collection(db, 'users'),
            where('roles', 'array-contains', 'supplier')
          )
        ];

        for (const qRef of queriesToRun) {
          try {
            const snap = await getDocs(qRef);
            snap.docs.forEach(doc => {
              const data = doc.data();
              supplierMap.set(doc.id, { id: doc.id, ...data });
            });
          } catch (e) {
            console.warn('⚠️ Supplier query failed:', e?.message || e);
          }
        }

        // isActive alanı false olanları hariç tut; undefined/true olanlar dahil
        allSuppliers = Array.from(supplierMap.values()).filter(s => s?.isActive !== false);
        console.log(`✅ ${allSuppliers.length} tedarikçi yüklendi`);
      } catch (error) {
        console.error('❌ Tedarikçi yükleme hatası:', error);
        allSuppliers = [];
      }
    }

    function renderSupplierList(searchTerm = '') {
      const supplierList = el('supplierList');
      supplierList.innerHTML = '';
      
      const filteredSuppliers = allSuppliers.filter(supplier => 
        supplier.companyName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        supplier.email?.toLowerCase().includes(searchTerm.toLowerCase())
      );
      
      if (filteredSuppliers.length === 0) {
        supplierList.innerHTML = '<div style="padding: 16px; text-align: center; color: #6b7280;">Tedarikçi bulunamadı</div>';
        return;
      }
      
      filteredSuppliers.forEach(supplier => {
        const div = document.createElement('div');
        div.style.cssText = `
          padding: 12px; 
          border-bottom: 1px solid #e5e7eb; 
          display: grid; 
          grid-template-columns: 24px 1fr;
          align-items: start; 
          column-gap: 12px;
          cursor: pointer;
          transition: background-color 0.2s;
        `;
        
        div.innerHTML = `
          <input type="checkbox" ${selectedSuppliers.has(supplier.id) ? 'checked' : ''} style="margin: 0;">
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; color: #1f2937; word-break: break-word;">${supplier.companyName || 'İsimsiz Firma'}</div>
            <div style="font-size: 12px; color: #6b7280; word-break: break-word;">${supplier.email || 'E-posta yok'}</div>
            <div style="font-size: 11px; color: #9ca3af; word-break: break-word; white-space: normal;">Kategoriler: ${(supplier.supplierCategories || supplier.categories || []).join(', ') || 'Belirtilmemiş'}</div>
          </div>
        `;
        
        div.addEventListener('click', (e) => {
          if (e.target.type === 'checkbox') return;
          
          const checkbox = div.querySelector('input[type="checkbox"]');
          checkbox.checked = !checkbox.checked;
          
          if (checkbox.checked) {
            selectedSuppliers.add(supplier.id);
            div.style.backgroundColor = '#f0f9ff';
          } else {
            selectedSuppliers.delete(supplier.id);
            div.style.backgroundColor = '';
          }
          
          updateSelectedCount();
        });
        
        const checkbox = div.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            selectedSuppliers.add(supplier.id);
            div.style.backgroundColor = '#f0f9ff';
          } else {
            selectedSuppliers.delete(supplier.id);
            div.style.backgroundColor = '';
          }
          updateSelectedCount();
        });
        
        supplierList.appendChild(div);
      });
    }

    function updateSelectedCount() {
      const count = selectedSuppliers.size;
      el('selectedCount').textContent = `Seçilen: ${count} tedarikçi`;
    }

    function updateSelectedSuppliersDisplay() {
      const display = el('selectedSuppliers');
      
      if (selectedSuppliers.size === 0) {
        display.innerHTML = 'Henüz tedarikçi seçilmedi';
        return;
      }
      
      const selectedNames = Array.from(selectedSuppliers).map(id => {
        const supplier = allSuppliers.find(s => s.id === id);
        return supplier?.companyName || 'Bilinmeyen';
      });
      
      display.innerHTML = `
        <div style="margin-bottom: 4px;"><strong>Seçilen Tedarikçiler:</strong></div>
        <div style="font-size: 11px;">${selectedNames.join(', ')}</div>
      `;
    }

    function showSupplierModal() {
      el('supplierSelectionModal').style.display = 'block';
      renderSupplierList();
      updateSelectedCount();
    }

    function hideSupplierModal() {
      el('supplierSelectionModal').style.display = 'none';
    }


    function editGroup(groupName) {
      const categories = categoryGroups.get(groupName);
      const currentCategories = [...categories].join(', ');
      
      const newCategories = prompt(
        `"${groupName}" grubu için kategorileri girin (virgülle ayırın):\n\nMevcut: ${currentCategories}`,
        currentCategories
      );
      
      if (newCategories === null) return; // İptal edildi
      
      // Kategorileri güncelle
      const categoryArray = newCategories.split(',').map(cat => cat.trim()).filter(cat => cat);
      categories.clear();
      categoryArray.forEach(cat => categories.add(cat));
      
      // UI'yi güncelle
      renderGroupButtons();
    }
    

    
    // Termin tarihi değiştiğinde tüm ürün kalemlerine otomatik doldur
    el("dueDate").addEventListener('change', function() {
      const selectedDate = this.value;
      if (selectedDate) {
        // Tüm mevcut ürün kalemlerinin termin tarihlerini güncelle
        const itemDueDates = document.querySelectorAll('.itemDueDate');
        itemDueDates.forEach(input => {
          if (!input.value) { // Sadece boş olanları doldur
            input.value = selectedDate;
          }
        });
        console.log(`📅 Termin tarihi tüm ürün kalemlerine uygulandı: ${selectedDate}`);
      }
    });

    
    
    // SATFK will be auto-generated by Cloud Function
    
    // Private demand event listeners (custom invite editor)
    el("selectSuppliersBtn").addEventListener("click", showSupplierModal);
    el("closeSupplierModal").addEventListener("click", hideSupplierModal);
    el("cancelSupplierSelection").addEventListener("click", hideSupplierModal);
    el("confirmSupplierSelection").addEventListener("click", () => {
      updateSelectedSuppliersDisplay();
      hideSupplierModal();
    });
    
    // Supplier search
    el("supplierSearch").addEventListener("input", (e) => {
      renderSupplierList(e.target.value);
    });

    // ====================
    // Demand Visibility + Invite Mode (new)
    // ====================
    let autoInvitees = [];

    const selectedInviteGroups = new Set();

    function renderInviteGroupPicker() {
      const host = el('inviteGroupPicker');
      if (!host) return;
      host.innerHTML = '';
      categoryGroups.forEach((_, groupName) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = groupName;
        btn.style.padding = '6px 10px';
        btn.style.borderRadius = '16px';
        btn.style.border = '1px solid #d1d5db';
        btn.style.background = selectedInviteGroups.has(groupName) ? '#2563eb' : '#ffffff';
        btn.style.color = selectedInviteGroups.has(groupName) ? '#ffffff' : '#111827';
        btn.addEventListener('click', () => {
          if (selectedInviteGroups.has(groupName)) selectedInviteGroups.delete(groupName);
          else selectedInviteGroups.add(groupName);
          renderInviteGroupPicker();
          const mode = document.querySelector('input[name="inviteMode"]:checked')?.value || 'auto';
          if (document.querySelector('input[name="demandVisibility"]:checked')?.value === 'ozel' && mode === 'auto') {
            loadGroupMembers();
          }
        });
        host.appendChild(btn);
      });
    }

    function getSelectedGroupIds() {
      return Array.from(selectedInviteGroups);
    }

    async function loadGroupMembers() {
      const ids = getSelectedGroupIds();
      if (!ids.length) {
        autoInvitees = [];
        el('autoInviteCount').textContent = '0';
        return;
      }
      try {
        const res = await fetch(`/api/groups/members?ids=${ids.join(',')}`);
        const list = await res.json();
        autoInvitees = Array.isArray(list) ? list : [];
        el('autoInviteCount').textContent = String(autoInvitees.length);
      } catch (e) {
        console.error('Grup üyeleri alınamadı', e);
        autoInvitees = [];
        el('autoInviteCount').textContent = '0';
      }
    }

    const visibilityRadios = document.querySelectorAll('input[name="demandVisibility"]');
    const inviteModeRadios = document.querySelectorAll('input[name="inviteMode"]');

    function updateVisibilitySections() {
      const v = document.querySelector('input[name="demandVisibility"]:checked')?.value;
      const isPrivate = v === 'ozel';
      const container = el('privateVisibilitySettings');
      container.style.display = isPrivate ? 'block' : 'none';
      if (isPrivate && allSuppliers.length === 0) {
        // preload supplier list for custom editor
        loadSuppliers();
      }
      updateInviteModeSections();
    }

    function updateInviteModeSections() {
      const mode = document.querySelector('input[name="inviteMode"]:checked')?.value || 'auto';
      el('autoInviteSummary').style.display = mode === 'auto' ? 'block' : 'none';
      el('customInviteEditor').style.display = mode === 'custom' ? 'block' : 'none';
    }

    visibilityRadios.forEach(r => r.addEventListener('change', updateVisibilitySections));
    inviteModeRadios.forEach(r => r.addEventListener('change', updateInviteModeSections));
    el('loadGroupMembersBtn').addEventListener('click', loadGroupMembers);
    // group picker events bağlama render sırasında yapılacak
    // initial (görünürlük alanı kaldırıldı)
    
    // SATFK Preview System
    let previewSatfk = null;
    
    function generatePreviewSATFK() {
      const today = new Date();
      const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
      const randomSuffix = Math.random().toString(36).substring(2, 6).toUpperCase().padStart(4, '0');
      return `SATFK-${dateStr}-${randomSuffix}`;
    }
    
    function updateSATFKPreview() {
      previewSatfk = generatePreviewSATFK();
      el("satfk").value = previewSatfk;
      el("satfkStatus").textContent = `Önizleme: ${previewSatfk} (Talep kaydedilene kadar değişebilir)`;
      el("copySatfkBtn").style.display = "inline-block";
    }
    
    // SATFK Copy functionality
    el("copySatfkBtn").addEventListener("click", async () => {
      const satfkValue = el("satfk").value;
      if (satfkValue) {
        try {
          await navigator.clipboard.writeText(satfkValue);
          el("satfkStatus").textContent = "✅ Kod panoya kopyalandı!";
          setTimeout(() => {
            el("satfkStatus").textContent = `Önizleme: ${satfkValue} (Talep kaydedilene kadar değişebilir)`;
          }, 2000);
        } catch (error) {
          console.error('Kopyalama hatası:', error);
          el("satfkStatus").textContent = "❌ Kopyalama başarısız";
        }
      }
    });
    
    // SATFK Refresh functionality
    el("refreshSatfkBtn").addEventListener("click", () => {
      updateSATFKPreview();
    });
    
    // Initial SATFK preview
    updateSATFKPreview();
    
    // Sayfa yüklendiğinde grup butonlarını render et
    renderGroupButtons();

    // ====================
    // Bidding Mode & Time-Bound Logic
    // ====================
    const isTimeBoundCheckbox = el("isTimeBound");
    const timeBoundFields = el("timeBoundFields");
    const singlePhaseTime = el("singlePhaseTime");
    const hybridPhaseTime = el("hybridPhaseTime");
    const biddingModeRadios = document.getElementsByName("biddingMode");

    // Toggle time-bound fields (hidden + dynamic hint)
    const scheduleHint = document.getElementById('scheduleHint');
    function updateScheduleUI(){
      const on = !!isTimeBoundCheckbox.checked;
      if (timeBoundFields) timeBoundFields.hidden = !on;
      if (on) updateTimeFieldsVisibility();
      if (scheduleHint) scheduleHint.textContent = on
        ? 'Süreli seçilirse talep başlangıç tarihi ile başlar, bitiş tarihi ile kapanır.'
        : 'Seçilmezse talep şimdi başlar ve manuel olarak kapatılana kadar devam eder.';
    }
    isTimeBoundCheckbox.addEventListener("change", updateScheduleUI);
    updateScheduleUI();

    // Toggle between single/hybrid time fields based on mode
    biddingModeRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        if (isTimeBoundCheckbox.checked) {
          updateTimeFieldsVisibility();
        }

        // Hibrit mod ayarlarını göster/gizle
        updateHybridSettingsVisibility();
      });
    });

    function updateHybridSettingsVisibility() {
      const hybridSettings = el("hybridSettings");
      const selectedMode = document.querySelector('input[name="biddingMode"]:checked').value;
      
      if (selectedMode === 'hybrid') {
        hybridSettings.style.display = 'block';
      } else {
        hybridSettings.style.display = 'none';
      }
    }

    function updateTimeFieldsVisibility() {
      const mode = document.querySelector('input[name="biddingMode"]:checked').value;
      if (mode === "hybrid") {
        singlePhaseTime.style.display = "none";
        hybridPhaseTime.style.display = "";
      } else {
        singlePhaseTime.style.display = "";
        hybridPhaseTime.style.display = "none";
      }
    }

    // ====================
    // Edit Mode: Load Existing Demand
    // ====================
    if (editId) {
      editing = true;
      pageTitle.textContent = "Talebi Düzenle";
      createBtn.textContent = "Değişiklikleri Kaydet";

      try {
        demandRef = doc(db, "demands", editId);
        const snap = await getDoc(demandRef);
        
        if (!snap.exists()) {
          alert("❌ Talep bulunamadı.");
          location.href = "./demands.html";
          throw new Error("NOT_FOUND");
        }

        const d = snap.data();

        // Check ownership
        if (d.createdBy !== user.uid) {
          alert("❌ Bu talebi düzenleyemezsiniz.");
          location.href = "./demands.html";
          throw new Error("UNAUTHORIZED");
        }

        // Check if published
        if (d.published) {
          alert("⚠️ Yayınlanmış talepler düzenlenemez. Önce 'Geri Çek' yapın.");
          location.href = `./demand-detail.html?id=${editId}`;
          throw new Error("PUBLISHED");
        }

        // Load header data into form
        el("satfk").value = d.satfk || "";
        el("demandDate").value = d.demandDate || d.createdAt?.toDate?.()?.toISOString?.()?.split('T')[0] || "";
        el("siteName").value = d.siteName || "";
        el("purchaseLocation").value = d.purchaseLocation || "";
        el("title").value = d.title || "";
        const _specEl = document.getElementById("spec"); if (_specEl) _specEl.value = d.spec || "";
        el("dueDate").value = d.dueDate || "";
        el("priority").value = d.priority || "price";
        el("currency").value = d.currency || "TRY";
        el("paymentTerms").value = d.paymentTerms || "";
        // paymentSchedule kaldırıldı
        const _deliveryCityEl = document.getElementById("deliveryCity"); if (_deliveryCityEl) _deliveryCityEl.value = d.deliveryCity || "";
        el("deliveryAddress").value = d.deliveryAddress || "";
        
        // SATFK is always readonly
        el("satfk").readOnly = true;
        el("satfk").style.background = "#f9fafb";

        // Load categories
        (Array.isArray(d.categoryTags) ? d.categoryTags : []).forEach(c => chips.add(c));
        if (d.customCategory) el("catInput").value = d.customCategory;
        renderChips();

        // Load bidding mode and time-bound settings
        const mode = d.biddingMode || "secret";
        document.querySelector(`input[name="biddingMode"][value="${mode}"]`).checked = true;
        
        // Hibrit ayarlarını yükle
        if (d.hybridSettings) {
          if (d.hybridSettings.firstRoundDays) {
            el("firstRoundDays").value = d.hybridSettings.firstRoundDays;
          }
          if (d.hybridSettings.secondRoundSupplierVisibility) {
            el("secondRoundSupplierVisibility").value = d.hybridSettings.secondRoundSupplierVisibility;
          }
          if (d.hybridSettings.secondRoundDays) {
            el("secondRoundDays").value = d.hybridSettings.secondRoundDays;
          }
        }
        
        // Hibrit ayarlarını göster/gizle
        updateHybridSettingsVisibility();
        
        if (d.isTimeBound) {
          isTimeBoundCheckbox.checked = true;
          timeBoundFields.style.display = "";
          
          if (mode === "hybrid") {
            hybridPhaseTime.style.display = "";
            singlePhaseTime.style.display = "none";
            if (d.round1Start) el("round1Start").value = timestampToDatetimeLocal(d.round1Start);
            if (d.round1End) el("round1End").value = timestampToDatetimeLocal(d.round1End);
            if (d.round2Start) el("round2Start").value = timestampToDatetimeLocal(d.round2Start);
            if (d.round2End) el("round2End").value = timestampToDatetimeLocal(d.round2End);
          } else {
            singlePhaseTime.style.display = "";
            hybridPhaseTime.style.display = "none";
            if (d.phaseStartAt) el("phaseStart").value = timestampToDatetimeLocal(d.phaseStartAt);
            if (d.phaseEndAt) el("phaseEnd").value = timestampToDatetimeLocal(d.phaseEndAt);
          }
        }

        // Load items
        const itemsQ = query(collection(db, "demands", editId, "items"), orderBy("lineNo", "asc"));
        const itemsSnap = await getDocs(itemsQ);
        
        itemsSnap.docs.forEach(docSnap => {
          const item = docSnap.data();
          addRow(item);
        });

      } catch (error) {
        console.error("Yeni talep yükleme hatası:", error);
        // Already redirected
      }
    }

    // Helper: Add row with data
    function addRow(data = {}) {
      lineCounter++;
      const tr = document.createElement("tr");
      tr.dataset.lineNo = data.lineNo || lineCounter;
      tr.innerHTML = `
        <td>${data.lineNo || lineCounter}</td>
        <td><input type="text" class="sku" placeholder="SKU" value="${data.sku || ""}" /></td>
        <td><textarea class="itemName auto-resize" placeholder="Malzeme tanımı" required rows="2" data-min-height="32" data-max-height="120">${data.name || ""}</textarea></td>
        <td><input type="text" class="brandModel" placeholder="Marka/Model" value="${data.brandModel || ""}" /></td>
        <td><input type="number" class="qty" min="1" step="0.01" placeholder="Miktar" required value="${data.qty || ""}" /></td>
        <td><input type="text" class="unit" list="unitList" placeholder="Birim" required value="${data.unit || ""}" /></td>
        <td><input type="number" class="stockQty" min="0" step="0.01" placeholder="Ambar" value="${data.stockQty || ""}" /></td>
        <td><input type="number" class="targetPrice" min="0" step="0.01" placeholder="Hedef" value="${data.targetPrice || ""}" /></td>
        <td>
          <input type="file" class="itemImage" accept="image/*" style="max-width:150px;">
          <input type="hidden" class="itemImageData" value="${data.productImage || ""}">
          <div class="itemImagePreview" style="font-size:11px;color:#6b7280;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${data.productImage ? 'Seçildi' : 'Seçilmedi'}</div>
        </td>
        <td><input type="date" class="itemDueDate" value="${data.itemDueDate || el("dueDate").value || ""}" /></td>
        <td>
          <button type="button" class="delBtn btn-sm">×</button>
          <input type="hidden" class="featuresJson" value='${JSON.stringify(Array.isArray(data.ozellikler)?data.ozellikler:[])}'>
          <input type="hidden" class="certsJson" value='${JSON.stringify(Array.isArray(data.kaliteSertifika)?data.kaliteSertifika:[])}'>
          <input type="hidden" class="altAcceptVal" value='${typeof data.alternatifKabul === "boolean" ? String(data.alternatifKabul) : ""}'>
        </td>
      `;
      itemsBody.appendChild(tr);

      // Advanced editor row (collapsible) tied to this item row
      const advTr = document.createElement('tr');
      advTr.dataset.parent = tr.dataset.lineNo;
      advTr.innerHTML = `
        <td colspan="11">
          <details style="margin-top:6px;">
            <summary style="cursor:pointer; font-size:13px; font-weight:600;">Varyant / Alternatif / Sertifika</summary>
            <div style="display:grid; grid-template-columns: 1fr 0.6fr 0.6fr; gap:12px; margin-top:8px;">
              <div>
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
                  <label style="font-size:12px; color:#6b7280;">Varyant / Özellikler</label>
                  <button type="button" class="btn-sm addPair">+ Satır</button>
                </div>
                <div class="pairs"></div>
                <p style="font-size:11px; color:#6b7280; margin-top:4px;">Renk, ölçü gibi teknik/lojistik özellikleri anahtar–değer olarak ekleyin.</p>
              </div>
              <div>
                <label style="font-size:12px; color:#6b7280; display:block; margin-bottom:6px;">Alternatif Ürün Kabulü?</label>
                <div style="display:flex; align-items:center; gap:12px;">
                  <label style="display:flex; align-items:center; gap:6px; cursor:pointer;"><input type="radio" name="alt-${tr.dataset.lineNo}" class="altYes"> Evet</label>
                  <label style="display:flex; align-items:center; gap:6px; cursor:pointer;"><input type="radio" name="alt-${tr.dataset.lineNo}" class="altNo"> Hayır</label>
                </div>
                <p style="font-size:11px; color:#6b7280; margin-top:4px;">Evet seçilirse tedarikçi teknik olarak uyumlu alternatif önerebilir.</p>
              </div>
              <div>
                <label style="font-size:12px; color:#6b7280; display:block;">Kalite / Sertifika</label>
                <div style="display:flex; gap:6px; margin-top:4px;">
                  <input type="text" class="certInput" placeholder="ISO 9001, CE, RoHS… (Enter)" style="border:1px solid #d1d5db; border-radius:4px; padding:4px 8px; flex:1;" />
                  <button type="button" class="btn-sm addCert">Ekle</button>
                </div>
                <div class="certTags" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;"></div>
                <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;">
                  ${["ISO 9001","ISO 14001","CE","RoHS","REACH"].map(s=>`<button type="button" class="btn-sm quickCert" data-cert="${s}" style="display:inline-block;">${s}</button>`).join('')}
                </div>
              </div>
            </div>
          </details>
        </td>`;
      itemsBody.appendChild(advTr);

      // Initialize auto-resize for new textarea
      reinitAutoResize(tr);

      // Görsel seçimi
      const fileInput = tr.querySelector('.itemImage');
      const hidden = tr.querySelector('.itemImageData');
      const preview = tr.querySelector('.itemImagePreview');
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        if (!file.type.startsWith('image/')) { alert('Lütfen bir resim dosyası seçin.'); e.target.value=''; return; }
        if (file.size > 5*1024*1024) { alert('Maksimum dosya boyutu 5MB.'); e.target.value=''; return; }
        const reader = new FileReader();
        reader.onload = () => { hidden.value = reader.result; preview.textContent = file.name; };
        reader.readAsDataURL(file);
      });

      // Delete row
      tr.querySelector(".delBtn").onclick = () => { advTr.remove(); tr.remove(); };

      // Advanced editors bindings
      const featuresHidden = tr.querySelector('.featuresJson');
      const certsHidden = tr.querySelector('.certsJson');
      const altHidden = tr.querySelector('.altAcceptVal');

      let features = Array.isArray(data.ozellikler) ? data.ozellikler.filter(p => (p.key||'').trim() || (p.value||'').trim()) : [];
      let certs = Array.isArray(data.kaliteSertifika) ? Array.from(new Set(data.kaliteSertifika)) : [];
      let alt = typeof data.alternatifKabul === 'boolean' ? data.alternatifKabul : false;
      featuresHidden.value = JSON.stringify(features);
      certsHidden.value = JSON.stringify(certs);
      altHidden.value = String(alt);

      const pairsHost = advTr.querySelector('.pairs');
      const addPairBtn = advTr.querySelector('.addPair');
      const altYes = advTr.querySelector('.altYes');
      const altNo = advTr.querySelector('.altNo');
      const certInput = advTr.querySelector('.certInput');
      const certTagsHost = advTr.querySelector('.certTags');
      const addCertBtn = advTr.querySelector('.addCert');
      const quickCertBtns = advTr.querySelectorAll('.quickCert');

      function syncFeatures() {
        const cleaned = features.filter(p => (p.key||'').trim() || (p.value||'').trim());
        featuresHidden.value = JSON.stringify(cleaned);
      }
      function renderPairs() {
        pairsHost.innerHTML = '';
        features.forEach((r, idx) => {
          const rowDiv = document.createElement('div');
          rowDiv.style.display = 'flex'; rowDiv.style.gap = '6px'; rowDiv.style.marginBottom = '6px';
          rowDiv.innerHTML = `
            <input class="adv-input adv-key pairKey" placeholder="Özellik (renk)" value="${r.key||''}" style="border:1px solid #d1d5db; border-radius:4px; padding:4px 8px;" />
            <input class="adv-input adv-val pairVal" placeholder="Değer (mavi)" value="${r.value||''}" style="border:1px solid #d1d5db; border-radius:4px; padding:4px 8px; flex:1;" />
            <button type="button" class="btn-sm del" style="display:inline-block;">Sil</button>`;
          const keyEl = rowDiv.querySelector('.pairKey');
          const valEl = rowDiv.querySelector('.pairVal');
          const delEl = rowDiv.querySelector('.del');
          keyEl.addEventListener('input', () => { features[idx].key = keyEl.value; syncFeatures(); });
          valEl.addEventListener('input', () => { features[idx].value = valEl.value; syncFeatures(); });
          delEl.addEventListener('click', () => { features.splice(idx,1); syncFeatures(); renderPairs(); });
          pairsHost.appendChild(rowDiv);
        });
      }
      addPairBtn.addEventListener('click', () => { features.push({key:'', value:''}); renderPairs(); syncFeatures(); });
      renderPairs();

      function syncAlt(val) { alt = val; altHidden.value = String(alt); }
      if (alt) altYes.checked = true; else altNo.checked = true;
      altYes.addEventListener('change', () => syncAlt(true));
      altNo.addEventListener('change', () => syncAlt(false));

      function syncCerts() { certsHidden.value = JSON.stringify(Array.from(new Set(certs))); }
      function renderCerts() {
        certTagsHost.innerHTML = '';
        Array.from(new Set(certs)).forEach(t => {
          const tag = document.createElement('span');
          tag.style.fontSize = '12px'; tag.style.padding = '2px 8px'; tag.style.border = '1px solid #1E40AF'; tag.style.borderRadius = '12px';
          tag.style.display = 'inline-flex'; tag.style.alignItems = 'center'; tag.style.gap = '6px'; tag.style.background = '#2563EB'; tag.style.color = '#fff';
          tag.textContent = t;
          const rm = document.createElement('button'); rm.type = 'button'; rm.textContent = '×';
          rm.style.color = '#dc2626'; rm.style.fontSize = '14px'; rm.style.marginLeft = '0';
          rm.style.background = 'rgba(255,255,255,.2)'; rm.style.border = '1px solid rgba(255,255,255,.6)'; rm.style.borderRadius = '50%'; rm.style.width = '18px'; rm.style.height = '18px'; rm.style.display = 'inline-flex'; rm.style.alignItems = 'center'; rm.style.justifyContent = 'center'; rm.style.padding = '0'; rm.style.lineHeight = '1'; rm.style.cursor = 'pointer'; rm.style.fontWeight = '800';
          rm.addEventListener('click', () => { certs = certs.filter(x => x !== t); syncCerts(); renderCerts(); });
          tag.appendChild(rm);
          certTagsHost.appendChild(tag);
        });
      }
      function tryAddCert(v) { const s = (v||'').trim(); if (!s) return; if (!certs.includes(s)) certs.push(s); certInput.value=''; syncCerts(); renderCerts(); }
      certInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); tryAddCert(certInput.value); } });
      addCertBtn.addEventListener('click', () => tryAddCert(certInput.value));
      quickCertBtns.forEach(btn => btn.addEventListener('click', () => tryAddCert(btn.getAttribute('data-cert'))));
      renderCerts();
    }

    // Hariç tut alanı kaldırıldı

    // Helper: Convert Firestore Timestamp to datetime-local format
    function timestampToDatetimeLocal(timestamp) {
      if (!timestamp) return "";
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // Helper: Convert datetime-local to Firestore Timestamp
    function datetimeLocalToTimestamp(datetimeStr) {
      if (!datetimeStr) return null;
      return new Date(datetimeStr);
    }

    // Helper: Convert string to slug format
    function toSlug(name) {
      if (!name) return '';
      const s = String(name)
        .normalize('NFD')                          // split accents
        .replace(/[\u0300-\u036f]/g, '')          // remove accents
        .replace(/[şŞ]/g, 's')
        .replace(/[ıİ]/g, 'i')
        .replace(/[ğĞ]/g, 'g')
        .replace(/[çÇ]/g, 'c')
        .replace(/[öÖ]/g, 'o')
        .replace(/[üÜ]/g, 'u')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, '-')               // non-alnum -> -
        .replace(/^-+|-+$/g, '');                   // trim dashes
      return s;
    }

    // SATFK is auto-generated by Cloud Function

    // Category Groups Management - moved to new implementation below

    // === Kategori Grubu Oluştur Sihirbazı & Grup Render ===
    
    // Ekranda açık tutulan grupları hatırlamak için
    const expandedGroups = new Set(); // groupId => açık

    // ==== Grupları ekranda göster ve tıkla-aç/kapat ====

    async function loadCategoryGroups() {
      try {
        const userGroups = await listGroupsForUser(user.uid);
        
        // Varsayılan gruplar (hard-coded)
        const defaultGroups = [
          { 
            name: "İnşaat Malzemeleri", 
            categories: ["İnşaat Malzemeleri", "Hırdavat", "Boya"],
            id: "default-insaat",
            isDefault: true
          },
          { 
            name: "Elektrik", 
            categories: ["Elektrik", "Elektronik"],
            id: "default-elektrik", 
            isDefault: true
          },
          { 
            name: "Makine-İmalat", 
            categories: ["Makine-İmalat", "Sac/Metal", "Otomotiv Yan Sanayi"],
            id: "default-makine",
            isDefault: true
          },
          { 
            name: "Diğer", 
            categories: ["Ambalaj", "Kimyasal", "Mobilya", "Plastik", "İş Güvenliği", "Temizlik", "Gıda", "Hizmet", "Lojistik"],
            id: "default-diger",
            isDefault: true
          }
        ];

        // Kullanıcı grupları + varsayılan gruplar
        const allGroups = [...defaultGroups, ...userGroups];

        // Grup butonlarını render et
        renderGroupButtonsFromData(allGroups);
      } catch (error) {
        console.error('Grup listesi yüklenemedi:', error);
      }
    }

    function renderGroupButtonsFromData(groups) {
      const container = document.getElementById('groupButtons');
      container.innerHTML = "";

      groups.forEach(g => {
        const count = (g.categories || []).length;
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "group-btn";
        
        // Varsayılan gruplar için farklı stil
        if (g.isDefault) {
          btn.style.cssText = `
            padding:8px 12px; margin:4px; background:#e0f2fe; color:#0277bd;
            border:1px solid #81d4fa; border-radius:6px; cursor:pointer; font-size:12px;
            font-weight:500;`;
        } else {
          // Kullanıcı grupları için yeşil tema
          btn.style.cssText = `
            padding:8px 12px; margin:4px; background:#ecfdf5; color:#065f46;
            border:1px solid #86efac; border-radius:6px; cursor:pointer; font-size:12px;
            font-weight:500;`;
        }
        
        btn.textContent = `${g.name} (${count})`;
        btn.title = (g.categories || []).join(", ");

        btn.addEventListener("click", () => toggleGroupOnChips(g));

        // Sağ tık: varsayılan gruplar için farklı mesaj
        btn.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          if (g.isDefault) {
            alert('Bu varsayılan grup düzenlenemez. Kendi gruplarınızı oluşturmak için "Kategori Grubu Oluştur" butonunu kullanın.');
          } else {
            alert('Grup düzenleme/silme için şu an sadece "Grup Yönet" modali kullanılmaktadır.');
          }
        });

        container.appendChild(btn);
      });
    }

    // Tıkla-aç / tıkla-kapat (chips alanında göster/gizle)
    function toggleGroupOnChips(group) {
      const cats = new Set(group.categories || []);
      const isOpen = expandedGroups.has(group.id || group.name);

      if (isOpen) {
        // kapat → bu grubun kategorilerini çiplerden kaldır
        cats.forEach(c => chips.delete(c));
        expandedGroups.delete(group.id || group.name);
      } else {
        // aç → çiplere ekle (kümülatif)
        cats.forEach(c => chips.add(c));
        expandedGroups.add(group.id || group.name);
      }
      renderChips();
    }

    // Apply selected group to category chips - dropdown kaldırıldığı için artık gerekli değil

    // === Çoklu-Sekmeli Grup Hub Sistemi ===
    
    // Giriş butonu
    document.getElementById('btnGroupHub')?.addEventListener('click', () => {
      document.getElementById('groupHubModal').style.display = 'block';
      showTab('create'); // varsayılan Oluştur
      resetCreatePane();
      renderManageList(); // Yönet sekmesi için önceden yükle
    });
    document.getElementById('ghClose')?.addEventListener('click', () => {
      document.getElementById('groupHubModal').style.display = 'none';
    });

    // Sekme geçişi
    document.getElementById('tabCreate')?.addEventListener('click', () => showTab('create'));
    document.getElementById('tabManage')?.addEventListener('click', () => { showTab('manage'); renderManageList(); });

    function showTab(which){
      const cBtn = document.getElementById('tabCreate');
      const mBtn = document.getElementById('tabManage');
      const cPane= document.getElementById('paneCreate');
      const mPane= document.getElementById('paneManage');
      if(which==='create'){
        cBtn.classList.add('gh-active'); mBtn.classList.remove('gh-active');
        cPane.style.display=''; mPane.style.display='none';
      }else{
        mBtn.classList.add('gh-active'); cBtn.classList.remove('gh-active');
        mPane.style.display=''; cPane.style.display='none';
      }
    }

    // Yönet toolbar'ındaki boş/adsız sol elemanı kaldır
    (() => {
      const tb = document.querySelector('#paneManage > div'); // toolbar
      if (!tb) return;
      const first = tb.firstElementChild;
      if (first && first.textContent.trim()==='' && first.querySelectorAll('*').length===0) {
        first.remove();
      }
    })();

    // === Normalizasyon (duplicate engelleme)
    function normalizeName(s=''){
      return s.toLocaleLowerCase('tr')
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/\s+/g,' ').trim();
    }
    async function getTakenGroupNames(){
        const groups = await listGroupsForUser(user.uid);
      return { set:new Set(groups.map(g=>normalizeName(g.name))), list:groups };
    }

    // === Oluştur sekmesi
    const ghCreateName   = document.getElementById('ghCreateName');
    const ghCreateStep   = document.getElementById('ghCreateStepCats');
    const ghCreateSearch = document.getElementById('ghCreateSearch');
    const ghCreateCount  = document.getElementById('ghCreateCount');
    const ghCreateCats   = document.getElementById('ghCreateCats');

    function resetCreatePane(){
      ghCreateName.value = '';
      ghCreateStep.style.display = 'none';
      document.getElementById('ghCreateNext').style.display='inline-block';
      document.getElementById('ghCreateSave').style.display='none';
      ghCreateCats.innerHTML = '';
      ghCreateSearch.value = '';
      ghCreateCount.textContent = '';
    }

    function renderChecklist(container, countEl, filter='', prechecked=new Set()){
      const all = (Array.isArray(CATEGORIES)? CATEGORIES.map(c=>typeof c==='string'?c:c.name):[]).filter(Boolean);
      const list = all.filter(n=>n.toLowerCase().includes(filter.toLowerCase())).sort((a,b)=>a.localeCompare(b,'tr'));
      container.innerHTML = list.map(n=>`
        <label>
          <input type="checkbox" value="${n}" ${prechecked.has(n)?'checked':''}>
          <span>${n}</span>
        </label>`).join('');
      countEl.textContent = `${list.length} kategori`;
    }

    document.getElementById('ghCreateCancel')?.addEventListener('click', ()=>{
      document.getElementById('groupHubModal').style.display='none';
    });

    document.getElementById('ghCreateNext')?.addEventListener('click', async ()=>{
      const raw = ghCreateName.value;
      const key = normalizeName(raw);
      if(!key){ alert('Lütfen grup adını yazın.'); return; }
      const {set:taken} = await getTakenGroupNames();
      if(taken.has(key)){ alert(`"${raw}" isminde bir grup zaten var.`); return; }
      ghCreateStep.style.display = '';
      document.getElementById('ghCreateCats').classList.add('gh-grid');
      document.getElementById('ghCreateCats').parentElement.style.maxHeight = '48vh';
      document.getElementById('ghCreateCats').parentElement.style.overflow = 'auto';
      renderChecklist(document.getElementById('ghCreateCats'), document.getElementById('ghCreateCount'));
      document.getElementById('ghCreateNext').style.display='none';
      document.getElementById('ghCreateSave').style.display='inline-block';
      ghCreateSearch.focus();
    });
    ghCreateSearch?.addEventListener('input', e=>{
      renderChecklist(document.getElementById('ghCreateCats'), document.getElementById('ghCreateCount'), e.target.value);
    });

    document.getElementById('ghCreateSave')?.addEventListener('click', async ()=>{
      const raw = ghCreateName.value;
      const key = normalizeName(raw);
      const selected = [...ghCreateCats.querySelectorAll('input[type="checkbox"]:checked')].map(i=>i.value);
      if(!key){ alert('Geçerli bir grup adı girin.'); return; }
      if(selected.length===0){ alert('En az bir kategori seçin.'); return; }

      const {set:taken} = await getTakenGroupNames();
      if(taken.has(key)){ alert(`"${raw}" isminde bir grup zaten var.`); return; }

      await createGroup(user.uid, {name: raw.trim(), categories: selected});
      await loadCategoryGroups?.();
      showTab('manage');        // otomatik olarak Yönet sekmesine geç
      renderManageList();       // listeyi tazele
    });

    // === Yönet sekmesi
    const ghManageList   = document.getElementById('ghManageList');

    let ghGroups = []; // {id,name,categories}
    let ghSelectedIds = new Set();

    // --- Yönet liste davranışı
    function refreshRowStates(){
      const rows = document.querySelectorAll('#ghManageList .row');
      const single = ghSelectedIds.size === 1 ? [...ghSelectedIds][0] : null;
      rows.forEach(row => {
        const id = row.getAttribute('data-id');
        const btn = row.querySelector('.btn-edit');
        if (!btn) return;
        if (single && id === single){
          btn.classList.add('enabled');
          btn.disabled = false;
        } else {
          btn.classList.remove('enabled');
          btn.disabled = true;
        }
      });

      // üstteki "Düzenle" butonu
      const topEdit = document.getElementById('ghEdit');
      if (topEdit){
        const on = ghSelectedIds.size === 1;
        topEdit.disabled = !on;
        topEdit.style.background = on ? '#10b981' : '#f59e0b';
        topEdit.style.color = '#fff';
      }
    }

    async function renderManageList(){
      const {list} = await getTakenGroupNames();
      ghGroups = list;
      ghSelectedIds.clear();
      drawManageList();
      // düzenleme panelini kapat
      document.getElementById('ghEditPanel').style.display='none';
    }

    function drawManageList(){
      const searchEl = document.getElementById('ghManageSearch');
      const q = (searchEl?.value||'').toLocaleLowerCase('tr');
      const html = ghGroups
        .filter(g => g.name.toLocaleLowerCase('tr').includes(q))
        .map(g => `
          <div class="row" data-id="${g.id}">
            <input type="checkbox" class="gh-row-check" ${ghSelectedIds.has(g.id)?'checked':''}>
            <div><strong>${g.name}</strong> <small style="color:#6b7280;">(${(g.categories||[]).length})</small></div>
            <button class="btn-edit" disabled>Düzenle</button>
          </div>`
        ).join('');
      ghManageList.innerHTML = html || `<div style="padding:12px;color:#6b7280;">Henüz grup yok.</div>`;
      refreshRowStates();
    }
    document.getElementById('ghManageSearch')?.addEventListener('input', drawManageList);

    // satır checkbox change handler (liste çiziminden sonra bağla)
    document.getElementById('ghManageList')?.addEventListener('change',(e)=>{
      if(!e.target.classList.contains('gh-row-check')) return;
      const row = e.target.closest('.row'); const id = row?.dataset.id;
      if (!id) return;
      if (e.target.checked) ghSelectedIds.add(id); else ghSelectedIds.delete(id);
      refreshRowStates();
    });

    // satır "Düzenle" tık
    document.getElementById('ghManageList')?.addEventListener('click',(e)=>{
      if(!e.target.classList.contains('btn-edit')) return;
      if (e.target.disabled) return;
      const id = e.target.closest('.row')?.dataset.id;
      if (id) openEditPanel(id);
    });

    // Çoklu Sil
    document.getElementById('ghDelete')?.addEventListener('click', async ()=>{
      if(ghSelectedIds.size===0){ alert('Lütfen silmek için en az bir grup seçin.'); return; }
      if(!confirm(`${ghSelectedIds.size} grup silinsin mi?`)) return;
      
      try {
        // Her grup için ayrı ayrı silme işlemi
        for (const groupId of ghSelectedIds) {
          await deleteGroup(user.uid, groupId);
        }
        await loadCategoryGroups?.();
        await renderManageList();
        alert('✅ Gruplar başarıyla silindi!');
      } catch (error) {
        console.error('Silme hatası:', error);
        alert('❌ Silme işlemi başarısız: ' + error.message);
      }
    });

    // Tekli Düzenle butonu
    document.getElementById('ghEdit')?.addEventListener('click', ()=>{
      if(ghSelectedIds.size!==1){ alert('Düzenlemek için bir (1) grup seçin.'); return; }
      const id = [...ghSelectedIds][0];
      openEditPanel(id);
    });

    // --- İsim/kat normalizasyonu
    function normalizeCat(s=''){
      return s
        .toLocaleLowerCase('tr')
        .replace(/ı/g,'i')
        .replace(/ş/g,'s')
        .replace(/ğ/g,'g')
        .replace(/ç/g,'c')
        .replace(/ö/g,'o')
        .replace(/ü/g,'u')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9]+/g,'')   // boşluk, tire, eğik çizgi vb. tüm ayırıcıları kaldır
        .trim();
    }

    // Basit Levenshtein mesafesi: küçük diziler için yeterli
    function editDistance(a, b){
      const m = a.length, n = b.length;
      const dp = Array.from({length:m+1},()=>Array(n+1).fill(0));
      for(let i=0;i<=m;i++) dp[i][0]=i;
      for(let j=0;j<=n;j++) dp[0][j]=j;
      for(let i=1;i<=m;i++){
        for(let j=1;j<=n;j++){
          const cost = a[i-1]===b[j-1]?0:1;
          dp[i][j] = Math.min(
            dp[i-1][j]+1,
            dp[i][j-1]+1,
            dp[i-1][j-1]+cost
          );
        }
      }
      return dp[m][n];
    }

    // Reusable: grid checklist renderer (prechecked korumalı)
    function renderChecklistGrid(container, countEl, { filter='', prechecked=new Set() } = {}){
      const all = (Array.isArray(CATEGORIES) ? CATEGORIES.map(c => typeof c === 'string' ? c : c.name) : [])
                  .filter(Boolean);
      const preN = new Set([...prechecked].map(normalizeCat));    // normalize for compare
      const list = all
        .filter(n => n.toLowerCase().includes(filter.toLowerCase()))
        .sort((a,b)=>a.localeCompare(b,'tr'));

      container.innerHTML = list.map(n => {
        const checked = preN.has(normalizeCat(n)) ? 'checked' : '';
        return `
          <label class="gh-grid-row">
            <input type="checkbox" value="${n}" ${checked}>
            <span>${n}</span>
          </label>`;
      }).join('');

      if (countEl) countEl.textContent = `${list.length} kategori`;
    }

    // === Düzenleme paneli ===
    let editingGroup = null;            // {id,name,categories}
    let editingSelected = new Set();    // canlı seçim (preselected + kullanıcı değişiklikleri)

    function openEditPanel(id){
      // grubu bul ve başlığı yaz
      editingGroup = ghGroups.find(g => g.id === id);
      if (!editingGroup) return;

      document.getElementById('ghEditTitle').textContent = `Grup Düzenle: ${editingGroup.name}`;
      const nameInput = document.getElementById('ghEditName');
      if (nameInput) nameInput.value = editingGroup.name || '';

      // PRESELECT: gruptaki kategorileri kanonik isimlere eşleyerek set'e yükle
      const allNames = (Array.isArray(CATEGORIES) ? CATEGORIES.map(c => typeof c === 'string' ? c : c.name) : []).filter(Boolean);
      const nameByNorm = new Map(allNames.map(n => [normalizeCat(n), n]));
      const allNorms = Array.from(nameByNorm.keys());
      const mapped = (editingGroup.categories || [])
        .filter(Boolean)
        .map(c => {
          const norm = normalizeCat(c);
          // Özel alias eşleşmeler (bozuk kayıtlara tolerans)
          const aliasTargets = [
            { match: (n) => n.includes('gvenlik') || n.startsWith('isg') || n.startsWith('isguven'), target: 'isguvenligi' },
          ];
          for (const a of aliasTargets){
            if (a.match(norm) && nameByNorm.has(a.target)){
              return nameByNorm.get(a.target);
            }
          }
          if (nameByNorm.has(norm)) return nameByNorm.get(norm);
          // En yakın eşi bul (mesafe <= 2 veya uzunluğun %25'i)
          let best = null, bestDist = Infinity;
          for (const candidate of allNorms){
            const d = editDistance(norm, candidate);
            if (d < bestDist){ bestDist = d; best = candidate; }
            if (bestDist === 0) break;
          }
          const threshold = Math.max(3, Math.floor(Math.max(norm.length, (best||'').length)*0.35));
          return (best && bestDist <= threshold) ? nameByNorm.get(best) : c;
        });
      editingSelected = new Set(mapped);

      // ilk çizim
      const catsBox = document.getElementById('ghEditCats');
      catsBox.classList.add('gh-grid'); // düzenli grid
      renderChecklistGrid(catsBox, document.getElementById('ghEditCount'), {
        filter: '',
        prechecked: editingSelected
      });

      // checkbox değişimlerini canlı olarak editingSelected'a yansıt
      catsBox.onchange = (e) => {
        if (e.target.type === 'checkbox'){
          const val = e.target.value;
          if (e.target.checked) editingSelected.add(val);
          else editingSelected.delete(val);
        }
      };

      // aramada listeyi yeniden çizerken mevcut seçimleri KORU
      const search = document.getElementById('ghEditSearch');
      search.value = '';
      search.oninput = (e) => {
        renderChecklistGrid(catsBox, document.getElementById('ghEditCount'), {
          filter: e.target.value || '',
          prechecked: editingSelected
        });
        // yeniden çizim sonrası değişimleri yakalamaya devam etsin
        catsBox.onchange = (ev) => {
          if (ev.target.type === 'checkbox'){
            const v = ev.target.value;
            if (ev.target.checked) editingSelected.add(v);
            else editingSelected.delete(v);
          }
        };
      };

      // paneli göster
      document.getElementById('ghEditPanel').style.display = '';
    }

    // Kaydet → editingSelected set'inden gönder
    document.getElementById('ghEditSave')?.addEventListener('click', async ()=>{
      if (!editingGroup) return;
      const newCats = [...editingSelected];
      const nameInput = document.getElementById('ghEditName');
      const newNameRaw = (nameInput?.value || '').trim();
      const newNameKey = normalizeName(newNameRaw);
      if (!newNameKey){ alert('Geçerli bir grup adı yazın.'); return; }

      // Duplicate kontrol (kendi grubu hariç)
      const { list } = await getTakenGroupNames();
      const exists = list.some(g => g.id !== editingGroup.id && normalizeName(g.name) === newNameKey);
      if (exists){ alert(`"${newNameRaw}" isminde bir grup zaten var.`); return; }

      await updateGroup(user.uid, editingGroup.id, { name: newNameRaw, categories: newCats });
      await loadCategoryGroups?.();
      await renderManageList();
      // panel açık kalabilir; istersen kapat:
      // document.getElementById('ghEditPanel').style.display = 'none';
    });

    // Vazgeç → paneli kapat
    document.getElementById('ghEditCancel')?.addEventListener('click', ()=>{
      document.getElementById('ghEditPanel').style.display = 'none';
      editingGroup = null;
      editingSelected = new Set();
    });


    // Load category groups on page load
    await loadCategoryGroups();
    // Render invite group picker with same groups
    renderInviteGroupPicker();

    // Add line item (use helper)
    if (addLineBtn) {
      addLineBtn.onclick = () => {
        addRow();
      };
    }

    if (createBtn) {
      console.log("✅ createBtn bulundu, event listener ekleniyor");
      createBtn.onclick = async () => {
        try {
          // Header validation
          const demandDate = el("demandDate").value;
          const title = el("title").value.trim();
          const dueDate = el("dueDate").value;
          const priority = el("priority").value;
          const currency = el("currency").value;
          // New visibility model
          const demandVisibility = document.querySelector('input[name="demandVisibility"]:checked')?.value || 'genel';
          const inviteMode = document.querySelector('input[name="inviteMode"]:checked')?.value || 'auto';
          const selectedGroupIds = getSelectedGroupIds();

          const siteNameVal = el("siteName").value.trim();
          const purchaseVal = el("purchaseLocation").value.trim();
          if (!demandDate || !title || !dueDate || !siteNameVal || !purchaseVal) {
            throw new Error("Talep Tarihi, Şantiye, Alım Yeri, Başlık ve Termin zorunlu.");
          }

          // Validate purchase city from datalist
          const provinceOptions = Array.from(document.querySelectorAll('#provinceList option')).map(o => (o.value||'').trim());
          if (!provinceOptions.includes(purchaseVal)) {
            throw new Error("Lütfen Alım Yeri için listeden geçerli bir il seçin.");
          }

          // Özel + custom ise en az bir tedarikçi şart
          if (demandVisibility === 'ozel' && inviteMode === 'custom' && selectedSuppliers.size === 0) {
            throw new Error("Özel (Özelleştir) için en az bir tedarikçi seçmelisiniz.");
          }

          // Get companyId from profile with fallback strategy
          let companyId = null;
          try {
            // Try multiple collections in order of preference
            const collections = ["publicProfiles", "profiles", "users"];
            
            for (const collection of collections) {
              try {
                const profileSnap = await getDoc(doc(db, collection, user.uid));
                if (profileSnap.exists()) {
                  const profile = profileSnap.data();
                  companyId = profile.currentCompanyId || profile.companyId || profile.activeCompanyId || `solo-${user.uid}`;
                  console.log(`✅ Found companyId from ${collection}:`, companyId);
                  break;
                }
              } catch (collectionError) {
                console.warn(`⚠️ Could not read from ${collection}:`, collectionError.message);
                continue;
              }
            }
            
            // Fallback if no collection worked
            if (!companyId) {
              companyId = `solo-${user.uid}`;
              console.log("🔄 Using fallback companyId:", companyId);
            }
          } catch (e) {
            console.warn("Profile read error, using fallback:", e);
            companyId = `solo-${user.uid}`;
          }

          // Prepare header data
          // Teklif modu ve hibrit ayarları
          const biddingMode = document.querySelector('input[name="biddingMode"]:checked').value;
          const hybridSettings = {
            firstRoundDays: biddingMode === 'hybrid' ? parseInt(el("firstRoundDays").value) || 7 : null,
            secondRoundSupplierVisibility: biddingMode === 'hybrid' ? el("secondRoundSupplierVisibility").value : null,
            secondRoundDays: biddingMode === 'hybrid' ? parseInt(el("secondRoundDays").value) || 7 : null
          };

          const specValue = document.getElementById("spec")?.value?.trim() || null;
          const deliveryCityValue = document.getElementById("deliveryCity")?.value?.trim() || null;

          // Exclude suppliers (chips)
          const excludeSuppliers = Array.from(document.querySelectorAll('#excludeChips span[data-val]')).map(el => ({ nameOrCode: el.getAttribute('data-val') }));

          // Backward compatibility for legacy fields
          const demandType = demandVisibility === 'ozel' ? 'private' : 'public';
          const invitedSupplierIds = (demandVisibility === 'ozel')
            ? (inviteMode === 'custom' ? Array.from(selectedSuppliers) : (autoInvitees.map(s => s.id)))
            : [];

          const headerData = {
            demandDate,
            siteName: siteNameVal,
            purchaseLocation: purchaseVal,
            title,
            spec: specValue,
            categoryTags: [...chips].map(toSlug), // Convert to slug format
            customCategory: document.getElementById("catInput")?.value?.trim() || null,
            dueDate,
            priority,
            currency,
            paymentTerms: el("paymentTerms").value.trim() || null,
            paymentPreference: (window.__getBuyerPaymentPref && window.__getBuyerPaymentPref()) || null,
            deliveryCity: deliveryCityValue,
            deliveryAddress: el("deliveryAddress").value.trim() || null,
            // paymentSchedule kaldırıldı
            // SATFK: kalıcı alan (CF henüz yazmadan taslakta da görünsün)
            satfk: (document.getElementById('satfk')?.value || (typeof previewSatfk !== 'undefined' ? previewSatfk : null)),
            // Yayın/Görünürlük kaldırıldı - otomatik gönderim
            demandType, // 'public' veya 'private' (uyumluluk)
            selectedSuppliers: null,
            excludeSuppliers,
            biddingMode, // 'secret', 'open', 'hybrid'
            hybridSettings, // Hibrit mod ayarları
            updatedAt: serverTimestamp(),
            companyId: companyId, // Set companyId from profile with fallback
            // New fields for publish functionality
            isPublished: true,
            visibility: 'private',
            // Yeni eklenen alanlar
            descriptions: getDescriptions(), // 1-2-3-4-5 numaralı açıklamalar
            requester: el("requester").value.trim() || null, // Talep Eden
            purchaseManager: el("purchaseManager").value.trim() || null, // Satın Alma Müdürü
            generalManager: el("generalManager").value.trim() || null, // Genel Müdür
            approver: el("approver").value.trim() || null, // Onay Veren
            deliveryMethod: getDeliveryMethod(), // Teslim Şekli
            deliveryAddress: el("deliveryAddress").value.trim() || null // Teslimat Adresi
          };

          if (!editing) {
            // ====================
            // CREATE MODE
            // ====================
            headerData.createdBy = user.uid;
            headerData.createdAt = serverTimestamp();
            headerData.viewerIds = [user.uid];
            // Keep published field for backward compatibility
            headerData.published = false; // Başlangıçta yayınlanmamış
            headerData.filesCount = 0;
            
            // Talep durumu sistemi
            headerData.status = 'draft'; // Başlangıçta taslak
            headerData.statusHistory = [{
              status: 'draft',
              timestamp: Date.now(),
              userId: user.uid,
              note: 'Talep oluşturuldu'
            }];

            // Main demand visibility data
            const mainDemandVisibility = document.querySelector('input[name="mainDemandVisibility"]:checked')?.value || 'normal';
            headerData.isMainDemand = mainDemandVisibility === 'main';
            // Header-level target price is deprecated; keep null (item-level targetPrice is used)
            headerData.targetPrice = null;
            headerData.deliveryLocation = `${deliveryCityValue || ''} ${el("deliveryAddress").value.trim()}`.trim();

            console.log("Creating new demand...");
            console.log("payload.createdBy:", user.uid);
            console.log("categoryTags:", headerData.categoryTags);
            console.log("companyId:", headerData.companyId);
            console.log("isPublished:", headerData.isPublished);
            console.log("visibility:", headerData.visibility);

            // Create demand header
            let newDemandRef;
            try {
              newDemandRef = await addDoc(collection(db, "demands"), headerData);
              console.log("✅ Demand created successfully:", newDemandRef.id);
            } catch (createError) {
              console.error("❌ Error creating demand:", createError);
              if (createError.message && createError.message.includes("Missing or insufficient permissions")) {
                throw new Error("Yetki reddedildi. İlgili şirketin sahibi/üyesi misiniz?");
              } else {
                throw new Error("Talep oluşturulurken hata oluştu: " + (createError.message || createError));
              }
            }
            const demandId = newDemandRef.id;

            // Find matching suppliers or use selected suppliers
            let supplierUids = [];
            
            if (demandType === 'private') {
              // Özel talep: seçilen tedarikçileri kullan
              supplierUids = Array.from(selectedSuppliers);
              console.log('Özel talep - seçilen tedarikçiler:', supplierUids.length);
            } else {
              // Genel talep: kategorilerdeki tedarikçileri bul
              if (headerData.categoryTags.length) {
                try {
                  console.log('Searching suppliers for categories:', headerData.categoryTags);
                  
                  // Önce tüm aktif tedarikçileri çek, sonra filtrele
                  const q = query(
                    collection(db, "users"),
                    where("roles.supplier", "==", true),
                    where("isActive", "==", true)
                  );
                  const snap = await getDocs(q);
                  console.log(`Found ${snap.docs.length} active suppliers`);
                  
                  // Debug: Tüm tedarikçilerin kategorilerini logla
                  snap.docs.forEach((doc, index) => {
                    const userData = doc.data();
                    const userCategories = userData.categories || [];
                    const supplierCategories = userData.supplierCategories || [];
                    console.log(`Supplier ${index + 1} (${doc.id}):`, {
                      email: userData.email,
                      categories: userCategories,
                      supplierCategories: supplierCategories,
                      roles: userData.roles
                    });
                  });
                  
                  // Manuel filtreleme: kategori eşleşmesi
                  supplierUids = snap.docs
                    .filter(doc => {
                      const userData = doc.data();
                      // Önce supplierCategories'ı kontrol et, yoksa categories'ı kullan
                      const userCategories = userData.supplierCategories || userData.categories || [];
                      // Kategorilerden en az biri eşleşiyorsa ekle
                      const hasMatch = headerData.categoryTags.some(cat => userCategories.includes(cat));
                      if (hasMatch) {
                        console.log(`✅ Match found for supplier ${doc.id}:`, {
                          supplierCategories: userCategories,
                          matchingCategories: headerData.categoryTags.filter(cat => userCategories.includes(cat))
                        });
                      }
                      return hasMatch;
                    })
                    .map(d => d.id)
                    .filter(uid => uid !== user.uid);
                  
                  console.log("Supplier query returned:", supplierUids.length, "suppliers");
                  console.log("Supplier IDs:", supplierUids);
                  
                  // Log unmatched demands for debugging
                  if (supplierUids.length === 0) {
                    console.warn("No matching suppliers found for categories:", headerData.categoryTags);
                    // Log to unmatchedDemands collection for analysis
                    try {
                      await addDoc(collection(db, "unmatchedDemands"), {
                        demandId: demandId,
                        categories: headerData.categoryTags,
                        createdAt: serverTimestamp()
                      });
                    } catch (logError) {
                      console.warn("Could not log unmatched demand:", logError.message);
                    }
                  }
                } catch (supplierError) {
                  console.warn("⚠️ Could not find suppliers:", supplierError.message);
                }
              }
            }

            // Update viewerIds
            if (supplierUids.length) {
              const allViewers = Array.from(new Set([user.uid, ...supplierUids]));
              await updateDoc(newDemandRef, { viewerIds: allViewers });
              console.log("Updated viewerIds:", allViewers.length);
            }

            // Collect items data from form
            const itemsData = [];
            const rows = itemsBody.querySelectorAll("tr");
            rows.forEach((row, index) => {
              const sku = row.querySelector(".sku")?.value?.trim() || "";
              const itemName = row.querySelector(".itemName")?.value?.trim() || "";
              const brandModel = row.querySelector(".brandModel")?.value?.trim() || "";
              const qty = parseFloat(row.querySelector(".qty")?.value) || 0;
              const unit = row.querySelector(".unit")?.value?.trim() || "";
              const itemDueDate = row.querySelector(".itemDueDate")?.value || "";

              if (itemName && qty > 0 && unit) {
                const stockQty = parseFloat(row.querySelector(".stockQty")?.value) || 0;
                const targetPrice = parseFloat(row.querySelector(".targetPrice")?.value) || 0;
                const productImage = row.querySelector('.itemImageData')?.value || '';
                const featuresJson = row.querySelector('.featuresJson')?.value || '[]';
                const certsJson = row.querySelector('.certsJson')?.value || '[]';
                const altVal = row.querySelector('.altAcceptVal')?.value || '';
                let ozellikler = [];
                let kaliteSertifika = [];
                try { ozellikler = JSON.parse(featuresJson).filter(p => (p.key||'').trim() || (p.value||'').trim()); } catch {}
                try { kaliteSertifika = Array.from(new Set(JSON.parse(certsJson) || [])); } catch {}
                const alternatifKabul = altVal === 'true' ? true : (altVal === 'false' ? false : null);
                
                itemsData.push({
                  lineNo: parseInt(row.dataset.lineNo || (itemsData.length + 1)),
                  sku,
                  name: itemName,
                  brandModel,
                  qty,
                  unit,
                  itemDueDate: itemDueDate || null,
                  stockQty: stockQty > 0 ? stockQty : null, // Ambardaki Miktar
                  targetPrice: targetPrice > 0 ? targetPrice : null, // Hedef Fiyat
                  productImage: productImage || null,
                  ozellikler: ozellikler.length ? ozellikler : null,
                  alternatifKabul: typeof alternatifKabul === 'boolean' ? alternatifKabul : null,
                  kaliteSertifika: (kaliteSertifika && kaliteSertifika.length) ? kaliteSertifika : null
                });
              }
            });

            // Add items
            for (const item of itemsData) {
              await addDoc(collection(db, "demands", demandId, "items"), {
                ...item,
                createdAt: serverTimestamp()
              });
            }

            localStorage.setItem("lastDemandId", demandId);
            
            // Onay ekranı göster
            showApprovalModal(demandId);

          } else {
            // ====================
            // EDIT MODE
            // ====================
            console.log("Updating existing demand:", editId);
            
            // Add companyId for multi-company support
            headerData.companyId = companyId;
            // Keep published field for backward compatibility
            headerData.published = headerData.isPublished;

            // Update header (keep published=false for safety)
            await updateDoc(demandRef, headerData);

            // Collect items data from form
            const itemsData = [];
            const rows = itemsBody.querySelectorAll("tr");
            rows.forEach((row, index) => {
              const sku = row.querySelector(".sku")?.value?.trim() || "";
              const itemName = row.querySelector(".itemName")?.value?.trim() || "";
              const brandModel = row.querySelector(".brandModel")?.value?.trim() || "";
              const qty = parseFloat(row.querySelector(".qty")?.value) || 0;
              const unit = row.querySelector(".unit")?.value?.trim() || "";
              const itemDueDate = row.querySelector(".itemDueDate")?.value || "";

              if (itemName && qty > 0 && unit) {
                const stockQty = parseFloat(row.querySelector(".stockQty")?.value) || 0;
                const targetPrice = parseFloat(row.querySelector(".targetPrice")?.value) || 0;
                const productImage = row.querySelector('.itemImageData')?.value || '';
                const featuresJson = row.querySelector('.featuresJson')?.value || '[]';
                const certsJson = row.querySelector('.certsJson')?.value || '[]';
                const altVal = row.querySelector('.altAcceptVal')?.value || '';
                let ozellikler = [];
                let kaliteSertifika = [];
                try { ozellikler = JSON.parse(featuresJson).filter(p => (p.key||'').trim() || (p.value||'').trim()); } catch {}
                try { kaliteSertifika = Array.from(new Set(JSON.parse(certsJson) || [])); } catch {}
                const alternatifKabul = altVal === 'true' ? true : (altVal === 'false' ? false : null);
                
                itemsData.push({
                  lineNo: parseInt(row.dataset.lineNo || (itemsData.length + 1)),
                  sku,
                  name: itemName,
                  brandModel,
                  qty,
                  unit,
                  itemDueDate: itemDueDate || null,
                  stockQty: stockQty > 0 ? stockQty : null, // Ambardaki Miktar
                  targetPrice: targetPrice > 0 ? targetPrice : null, // Hedef Fiyat
                  productImage: productImage || null,
                  ozellikler: ozellikler.length ? ozellikler : null,
                  alternatifKabul: typeof alternatifKabul === 'boolean' ? alternatifKabul : null,
                  kaliteSertifika: (kaliteSertifika && kaliteSertifika.length) ? kaliteSertifika : null
                });
              }
            });

            // Delete old items
            const oldItems = await getDocs(collection(db, "demands", editId, "items"));
            await Promise.all(oldItems.docs.map(d => deleteDoc(doc(db, "demands", editId, "items", d.id))));

            // Add new items
            for (const item of itemsData) {
              await addDoc(collection(db, "demands", editId, "items"), {
                ...item,
                createdAt: serverTimestamp()
              });
            }

            alert("✅ Talep güncellendi.");
            location.href = `./demand-detail.html?id=${editId}`;
          }
        } catch (e) {
          console.error(e);
          const code = e?.code || "";
          if (code === "permission-denied") alert("Yetki reddedildi. İlgili şirketin sahibi/üyesi misiniz?");
          else if (code === "not-found") alert("Kayıt bulunamadı.");
          else alert("İşlem başarısız: " + (e?.message || e));
        }
      };
    }

    // ====================
    // Onay Modal Fonksiyonları
    // ====================
    function showApprovalModal(demandId) {
      const modal = document.getElementById('approvalModal');
      const demandCodeEl = document.getElementById('approvalDemandCode');
      
      // SATFK'yi göster
      const satfk = document.getElementById('satfk').value;
      demandCodeEl.textContent = satfk || "Oluşturulacak...";
      
      // Modalı göster
      modal.style.display = 'block';
      
      // Event listener'ları ekle
      const approveBtn = document.getElementById('approveDemandBtn');
      const saveDraftBtn = document.getElementById('saveAsDraftBtn');
      const editBtn = document.getElementById('editDemandBtn');
      const closeBtn = document.getElementById('closeApprovalModalBtn');
      
      if (approveBtn) approveBtn.onclick = () => approveDemand(demandId);
      if (saveDraftBtn) saveDraftBtn.onclick = () => saveAsDraft(demandId);
      if (editBtn) editBtn.onclick = () => editDemand(demandId);
      if (closeBtn) closeBtn.onclick = () => closeApprovalModal();
    }
    
    function closeApprovalModal() {
      document.getElementById('approvalModal').style.display = 'none';
    }
    
    async function approveDemand(demandId) {
      try {
        // Talep durumunu 'approved' yap ve yayınla
        await updateDoc(doc(db, 'demands', demandId), {
          status: 'approved',
          published: true,
          statusHistory: arrayUnion({
            status: 'approved',
            timestamp: Date.now(),
            userId: user.uid,
            note: 'Talep onaylandı ve yayınlandı'
          }),
          updatedAt: serverTimestamp()
        });
        
        // Tedarikçi eşleştirmesi yap
        await publishDemandAndMatchSuppliers(demandId);
        
        closeApprovalModal();
        alert('✅ Talep onaylandı ve tedarikçi firmalara gönderildi!');
        location.href = `./demand-detail.html?id=${demandId}`;
        
      } catch (error) {
        console.error('Talep onaylama hatası:', error);
        alert('❌ Talep onaylanırken hata oluştu: ' + error.message);
      }
    }
    
    async function saveAsDraft(demandId) {
      try {
        // Talep durumunu 'draft' olarak bırak
        await updateDoc(doc(db, 'demands', demandId), {
          status: 'draft',
          published: false,
          isPublished: false, // Yeni sistem için
          visibility: 'private', // Taslaklar özel olmalı
          statusHistory: arrayUnion({
            status: 'draft',
            timestamp: Date.now(),
            userId: user.uid,
            note: 'Talep taslak olarak kaydedildi'
          }),
          updatedAt: serverTimestamp()
        });
        
        closeApprovalModal();
        alert('✅ Talep taslak olarak kaydedildi. İstediğiniz zaman düzenleyebilirsiniz.');
        location.href = `./demand-detail.html?id=${demandId}`;
        
      } catch (error) {
        console.error('Taslak kaydetme hatası:', error);
        alert('❌ Taslak kaydedilirken hata oluştu: ' + error.message);
      }
    }
    
    function editDemand(demandId) {
      // Modalı kapat ama sayfada kal - form verileri kaybolmasın
      closeApprovalModal();
      // Sayfayı yenileme veya yönlendirme yapma
      // Kullanıcı form üzerinde kalır ve istediği değişiklikleri yapabilir
    }

    // ====================
    // Tedarikçi Eşleştirme Fonksiyonu
    // ====================
    async function publishDemandAndMatchSuppliers(demandId) {
      try {
        console.log("Publishing demand and matching suppliers:", demandId);
        
        // Talep verilerini al
        const demandDoc = await getDoc(doc(db, 'demands', demandId));
        if (!demandDoc.exists()) {
          throw new Error('Talep bulunamadı');
        }
        
        const demandData = demandDoc.data();
        const categories = demandData.categoryTags || [];
        const groups = demandData.groupIds || [];
        
        console.log('Demand categories:', categories);
        console.log('Demand groups:', groups);
        
        // Belirlenecek tedarikçiler
        const allSuppliers = new Set();

        {
          // Genel talep: kategori/grup bazlı eşleştirme
          const supplierQueries = [];

          // Kategori bazlı tedarikçi sorgusu (10'luk batch'ler)
          if (categories.length > 0) {
            const categoryBatches = [];
            for (let i = 0; i < categories.length; i += 10) {
              categoryBatches.push(categories.slice(i, i + 10));
            }
            console.log(`📦 Processing ${categories.length} categories in ${categoryBatches.length} batches`);
            for (const batch of categoryBatches) {
              supplierQueries.push(
                query(
                  collection(db, 'users'),
                  where('isActive', '==', true),
                  where('supplierCategories', 'array-contains-any', batch)
                )
              );
            }
          }

          // Grup bazlı tedarikçi sorgusu
          if (groups.length > 0) {
            supplierQueries.push(
              query(
                collection(db, 'users'),
                where('isActive', '==', true),
                where('groupIds', 'array-contains-any', groups)
              )
            );
          }

          for (const q of supplierQueries) {
            try {
              const snap = await getDocs(q);
              snap.docs.forEach(doc => {
                if (doc.id !== demandData.createdBy) {
                  allSuppliers.add(doc.id);
                }
              });
            } catch (queryError) {
              console.warn('Supplier query failed:', queryError);
            }
          }
        }
        
        console.log('Found suppliers:', allSuppliers.size);

        // Exclude suppliers by name/code if provided (privacy-safe client filter; server can also enforce)
        const excludes = Array.isArray(demandData.excludeSuppliers) ? demandData.excludeSuppliers.map(x => (x?.nameOrCode||'').toLowerCase()).filter(Boolean) : [];
        if (excludes.length) {
          const kept = new Set();
          for (const sid of allSuppliers) {
            try {
              const sDoc = await getDoc(doc(db, 'users', sid));
              const d = sDoc.data() || {};
              const haystack = [d.displayName, d.companyName, d.taxNo, d.code, d.email].filter(Boolean).join(' ').toLowerCase();
              const match = excludes.some(x => haystack.includes(x));
              if (!match) kept.add(sid);
            } catch (e) { kept.add(sid); }
          }
          console.log(`Excluding ${allSuppliers.size - kept.size} suppliers by user-provided exclude list`);
          allSuppliers.clear(); kept.forEach(id => allSuppliers.add(id));
        }
        
        // demandRecipients kayıtları oluştur
        const recipientPromises = Array.from(allSuppliers).map(supplierId => 
          addDoc(collection(db, 'demandRecipients'), {
            demandId: demandId,
            buyerId: demandData.createdBy,
            supplierId: supplierId,
            matchedAt: serverTimestamp(),
            status: 'pending',
            createdAt: serverTimestamp()
          })
        );
        
        await Promise.all(recipientPromises);
        
        console.log(`✅ Created ${recipientPromises.length} demandRecipients records`);
        
      } catch (error) {
        console.error('Error in publishDemandAndMatchSuppliers:', error);
        throw error;
      }
    }

    // ====================
    // Yeni Özellikler - JavaScript Fonksiyonları
    // ====================
    
    // Açıklama yönetimi
    let descriptionCounter = 0;
    
    function addDescription() {
      const container = document.getElementById("descriptionsContainer");
      const index = container.children.length + 1;
      
      // Create description item row
      const row = document.createElement("div");
      row.className = "description-item";
      row.dataset.descriptionIndex = index;

      // Number label
      const numberLabel = document.createElement("span");
      numberLabel.className = "description-number";
      numberLabel.textContent = `${index}.`;
      row.appendChild(numberLabel);

      // Textarea
      const ta = document.createElement("textarea");
      ta.rows = 3;
      ta.id = `description_${index}`;
      ta.name = `description_${index}`;
      ta.placeholder = `${index}. Açıklama girin...`;
      row.appendChild(ta);

      // Delete button
      const del = document.createElement("button");
      del.className = "delete-btn";
      del.textContent = "×";
      del.title = "Sil";
      del.onclick = () => {
        row.remove();
        // Renumber remaining descriptions
        updateDescriptionNumbers();
      };
      row.appendChild(del);

      container.appendChild(row);
    }
    
    function updateDescriptionNumbers() {
      const container = document.getElementById("descriptionsContainer");
      const items = container.querySelectorAll('.description-item');
      items.forEach((item, index) => {
        const number = index + 1;
        item.dataset.descriptionIndex = number;
        const numberLabel = item.querySelector('.description-number');
        if (numberLabel) {
          numberLabel.textContent = `${number}.`;
        }
        const textarea = item.querySelector('textarea');
        if (textarea) {
          textarea.id = `description_${number}`;
          textarea.name = `description_${number}`;
          textarea.placeholder = `${number}. Açıklama girin...`;
        }
      });
    }
    
    function clearDescriptions() {
      const container = document.getElementById("descriptionsContainer");
      container.innerHTML = "";
    }
    
    
    function getDescriptions() {
      const textareas = document.querySelectorAll('#descriptionsContainer textarea');
      return Array.from(textareas).map(textarea => textarea.value.trim()).filter(val => val);
    }
    
    // Teslim şekli yönetimi
    function setupDeliveryMethodHandlers() {
      const radioButtons = document.querySelectorAll('input[name="deliveryMethod"]');
      const customContainer = document.getElementById('customDeliveryContainer');
      const customInput = document.getElementById('customDelivery');
      const customTextInput = document.getElementById('deliveryMethodCustom');
      
      radioButtons.forEach(radio => {
        radio.addEventListener('change', () => {
          if (radio.value === 'custom') {
            customContainer.style.display = 'block';
            customInput.required = true;
          } else {
            customContainer.style.display = 'none';
            customInput.required = false;
            customInput.value = '';
          }
          
          // Radio button seçildiğinde elle yazma alanını güncelle
          if (customTextInput) {
            if (radio.value === 'nakliye_dahil') {
              customTextInput.value = 'Nakliye Dahil';
            } else if (radio.value === 'nakliye_haric') {
              customTextInput.value = 'Nakliye Hariç';
            } else if (radio.value === 'custom') {
              customTextInput.value = '';
              customTextInput.placeholder = 'Özel teslimat açıklamasını yazın';
            }
          }
        });
      });
      
      // Elle yazma alanı değiştiğinde radio button'ları temizle
      if (customTextInput) {
        customTextInput.addEventListener('input', () => {
          if (customTextInput.value.trim()) {
            radioButtons.forEach(radio => radio.checked = false);
          }
        });
      }
    }
    
    function getDeliveryMethod() {
      // Önce elle yazılan değeri kontrol et
      const customInput = document.getElementById('deliveryMethodCustom');
      if (customInput && customInput.value.trim()) {
        return customInput.value.trim();
      }
      
      // Sonra radio button'ları kontrol et
      const selected = document.querySelector('input[name="deliveryMethod"]:checked');
      if (!selected) return null;
      
      if (selected.value === 'custom') {
        const customValue = document.getElementById('customDelivery').value.trim();
        return customValue || null;
      }
      
      return selected.value;
    }
    
    // Teslimat adresi yönetimi
    function setupDeliveryAddressHandlers() {
      const select = document.getElementById('deliveryAddressSelect');
      const textarea = document.getElementById('deliveryAddress');
      const refreshBtn = document.getElementById('refreshAddressesBtn');
      
      // Yenile butonu - Yeni sistem
      refreshBtn.addEventListener('click', async () => {
        try {
          const user = await requireAuth();
          
          // Mevcut seçenekleri temizle
          select.innerHTML = '<option value="">Başlık seçin</option>';
          
          // Kullanıcı verilerini yükle
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists()) {
            const userData = userDoc.data();
            console.log("📋 Kullanıcı verileri:", userData);
            
            // Fatura adresini seçenek olarak ekle (varsa)
            if (userData.invoiceAddress) {
              const opt = document.createElement("option");
              opt.value = "invoice";
              opt.textContent = "Fatura Adresi";
              select.appendChild(opt);
              console.log("✅ Fatura adresi seçeneği eklendi");
            } else {
              console.log("⚠️ Fatura adresi bulunamadı");
            }
            
            // İlave adresleri başlıkla listele
            const additionalAddresses = userData.additionalAddresses || [];
            console.log("📋 İlave adresler:", additionalAddresses);
            
            additionalAddresses.forEach((a, i) => {
              const opt = document.createElement("option");
              opt.value = `addr:${i}`;
              opt.textContent = a.title || `Adres ${i + 1}`;
              select.appendChild(opt);
              console.log(`✅ Adres seçeneği eklendi: ${a.title}`);
            });
            
            console.log(`✅ ${additionalAddresses.length} adet ilave adres yüklendi`);
          } else {
            console.error("❌ Kullanıcı verisi bulunamadı!");
          }
        } catch (error) {
          console.error("❌ Adresler yüklenemedi:", error);
        }
      });
      
      // Select değişikliği - Yeni sistem
      select.addEventListener('change', async () => {
        if (!select.value) { 
          textarea.value = ""; 
          textarea.disabled = false;
          textarea.placeholder = "Teslimat adresini yazın veya yukarıdan seçin";
          return; 
        }
        
        if (select.value === "invoice") {
          try {
            const user = await requireAuth();
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
              const userData = userDoc.data();
              textarea.value = userData.invoiceAddress || "";
              textarea.disabled = true;
              textarea.placeholder = "Fatura adresi seçildi";
            }
          } catch (error) {
            console.error("❌ Fatura adresi yüklenemedi:", error);
          }
          return;
        }
        
        if (select.value.startsWith("addr:")) {
          try {
            const user = await requireAuth();
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
              const userData = userDoc.data();
              const idx = Number(select.value.split(":")[1]);
              const addr = userData.additionalAddresses?.[idx];
              if (addr) {
                textarea.value = addr.content || "";
                textarea.disabled = true;
                textarea.placeholder = `Seçilen adres: ${addr.title}`;
              }
            }
          } catch (error) {
            console.error("❌ İlave adres yüklenemedi:", error);
          }
          return;
        }
        
        // Varsayılan durum
        textarea.value = "";
        textarea.disabled = false;
        textarea.placeholder = "Teslimat adresini yazın veya yukarıdan seçin";
      });
      
      // İlk yükleme
      refreshBtn.click();
    }
    
    // Event listener'ları ekle
    function initDemandPageMain() {
      // Açıklama butonları
      const addDescBtn = document.getElementById('addDescriptionBtn');
      const clearDescBtn = document.getElementById('clearDescriptionsBtn');
      
      if (addDescBtn) addDescBtn.onclick = addDescription;
      if (clearDescBtn) clearDescBtn.onclick = clearDescriptions;
      
      // Teslim şekli
      setupDeliveryMethodHandlers();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDemandPageMain);
    } else {
      initDemandPageMain();
    }
  </script>

  <!-- DEMAND PAGE: Descriptions + Delivery Address wiring -->
  <script type="module">
    import { auth, db } from "./firebase.js";
    import {
      doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import {
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

    // ---------- helpers ----------
    async function getCurrentUser() {
      if (auth.currentUser) return auth.currentUser;
      return await new Promise((resolve, reject) => {
        const unsub = onAuthStateChanged(auth, (u) => { unsub(); u ? resolve(u) : reject(new Error("not signed in")); });
      });
    }

    function $(sel) { return document.querySelector(sel); }
    function el(html) { const d = document.createElement("div"); d.innerHTML = html.trim(); return d.firstElementChild; }

    // ---------- AÇIKLAMA EKLE ----------
    function bindDescriptions() {
      const addBtn = $("#addDescriptionBtn");
      const clearBtn = $("#clearDescriptionsBtn");
      const wrap = $("#descriptionsContainer");

      if (!addBtn || !wrap) return;

      addBtn.onclick = () => {
        const container = document.getElementById("descriptionsContainer");
        const index = container.children.length + 1;
        
        // Create description item row
        const row = document.createElement("div");
        row.className = "description-item";
        row.dataset.descriptionIndex = index;

        // Number label
        const numberLabel = document.createElement("span");
        numberLabel.className = "description-number";
        numberLabel.textContent = `${index}.`;
        row.appendChild(numberLabel);

        // Textarea
        const ta = document.createElement("textarea");
        ta.rows = 3;
        ta.id = `description_${index}`;
        ta.name = `description_${index}`;
        ta.placeholder = `${index}. Açıklama girin...`;
        row.appendChild(ta);

        // Delete button
        const del = document.createElement("button");
        del.className = "delete-btn";
        del.textContent = "×";
        del.title = "Sil";
        del.onclick = () => {
          row.remove();
          // Renumber remaining descriptions
          updateDescriptionNumbers();
        };
        row.appendChild(del);

        container.appendChild(row);
      };
      
      if (clearBtn) {
        clearBtn.onclick = () => { wrap.innerHTML = ""; };
      }
    }

    // ---------- ADRES SEÇİMİ ----------
    async function loadAddressesForDemand() {
      const sel = $("#deliveryAddressSelect");
      const ta  = $("#deliveryAddress");
      if (!sel || !ta) return;

      // varsayılan
      sel.innerHTML = `<option value="">Başlık seçin</option>`;

      try {
        const user = await getCurrentUser();
        const uref = doc(db, "users", user.uid);
        const data = (await getDoc(uref)).data() || {};

        // list: fatura + ilave adresler
        const list = [];
        if (data.invoiceAddress) list.push({ title: "Fatura Adresi", content: data.invoiceAddress });
        (Array.isArray(data.additionalAddresses) ? data.additionalAddresses : []).forEach(a => {
          if (a?.title && a?.content) list.push({ title: a.title, content: a.content });
        });

        // select'i doldur
        sel.innerHTML = `<option value="">Başlık seçin</option>` +
          list.map((a, i) => `<option value="${i}">${a.title}</option>`).join("");

        // change → textarea doldur
        sel.onchange = () => {
          const v = sel.value;
          ta.value = v === "" ? "" : (list[Number(v)]?.content || "");
        };

        // debug
        console.log("📦 Teslimat adres listesi yüklendi:", list);
      } catch (e) {
        console.warn("⚠️ Adresler yüklenemedi:", e);
      }
    }

    function bindRefreshButton() {
      const btn = $("#refreshAddressesBtn");
      if (btn) btn.onclick = loadAddressesForDemand;
    }

    // ---------- init ----------
    function initDemandPageWiring() {
      bindDescriptions();
      bindRefreshButton();
      loadAddressesForDemand(); // sayfa açılışında bir kez yükle
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDemandPageWiring);
    } else {
      initDemandPageWiring();
    }
  </script>

  <!-- Category Groups Modal Script -->
  <script src="/assets/js/ui/category-groups-modal.js" defer></script>

  <!-- Theme Script -->
  <script src="/assets/js/theme.js" defer></script>

  <!-- Çoklu-Sekmeli Grup Hub Modal -->
  <div id="groupHubModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1100;">
    <div class="gh-modal" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
                background:#fff;width:95%;max-width:880px;border-radius:12px;padding:20px;">
      <div class="gh-body">
      <div class="gh-header">
        <h3 class="gh-title">Kategori Grupları — Oluştur & Yönet</h3>
        <button id="ghClose" class="gh-close" aria-label="Kapat" title="Kapat">×</button>
      </div>

      <!-- Sekme başlıkları -->
      <div style="display:flex;gap:6px;margin-bottom:12px;">
        <button id="tabCreate" class="gh-tab gh-active">🗂️ Yeni Grup Oluştur</button>
        <button id="tabManage" class="gh-tab">🛠️ Grupları Yönet</button>
      </div>

      <!-- Sekme içerikleri -->
      <div id="paneCreate">
        <label style="font-weight:600;">Grup Adı *</label>
        <input id="ghCreateName" placeholder="Örn: İnşaat Malzemeleri"
          style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;margin:8px 0 12px;">
        <div id="ghCreateStepCats" style="display:none;margin-top:8px;">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
            <input id="ghCreateSearch" placeholder="Kategori ara..."
              style="flex:1;padding:8px;border:1px solid #d1d5db;border-radius:8px;">
            <small id="ghCreateCount" style="color:#6b7280;"></small>
          </div>
          <div id="ghCreateCats" style="border:1px solid #e5e7eb;border-radius:8px;max-height:36vh;overflow:auto;padding:8px;"></div>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
          <button id="ghCreateCancel">İptal</button>
          <button id="ghCreateNext" style="background:#3b82f6;color:#fff;border:0;border-radius:6px;padding:8px 12px;">İlerle</button>
          <button id="ghCreateSave" style="display:none;background:#10b981;color:#fff;border:0;border-radius:6px;padding:8px 12px;">Kaydet</button>
        </div>
      </div>

      <div id="paneManage" style="display:none;">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
          <input id="ghManageSearch" placeholder="Gruplarda ara..." style="flex:1;padding:8px;border:1px solid #d1d5db;border-radius:8px;">
          <button id="ghDelete"  style="background:#ef4444;color:#fff;border:0;border-radius:6px;padding:8px 12px;">Seçilenleri Sil</button>
          <button id="ghEdit"    style="background:#f59e0b;color:#fff;border:0;border-radius:6px;padding:8px 12px;">Düzenle</button>
        </div>

        <div id="ghManageList" style="border:1px solid #e5e7eb;border-radius:8px;max-height:40vh;overflow:auto;"></div>

        <!-- Düzenleme paneli -->
        <div id="ghEditPanel" style="display:none;margin-top:12px;border-top:1px dashed #e5e7eb;">
          <h4 id="ghEditTitle" style="margin:12px 0 8px 0;">Grup Düzenle</h4>

          <!-- Grup adı düzenleme -->
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
            <input id="ghEditName" placeholder="Grup adı (örn: Tüm Tedarikçi Gruplarım)" style="flex:1;padding:8px;border:1px solid #d1d5db;border-radius:8px;">
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
            <input id="ghEditSearch" placeholder="Kategori ara..." style="flex:1;padding:8px;border:1px solid #d1d5db;border-radius:8px;">
            <small id="ghEditCount" style="color:#6b7280;"></small>
          </div>

          <div id="ghEditScroll" style="max-height:48vh;overflow:auto;border:1px solid #e5e7eb;border-radius:8px;padding:10px;">
            <div id="ghEditCats" class="gh-grid"></div>
          </div>

          <div class="gh-footer" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
            <button id="ghEditCancel">Vazgeç</button>
            <button id="ghEditSave" style="background:#10b981;color:#fff;border:0;border-radius:8px;padding:8px 12px;">Kaydet</button>
          </div>
        </div>
      </div>
      <div class="gh-footer">
        <!-- Alt buton barları buraya -->
      </div>
    </div>
  </div>

  <style>
    .gh-header{
      position:relative; display:flex; align-items:center; justify-content:center;
      margin-bottom:12px; padding:12px 64px 8px 12px; border-bottom:1px solid #e5e7eb;
      min-height:56px; /* header yüksek, X alt çizgiye hiç yaklaşmaz */
    }
    .gh-title{ margin:0; font-size:18px; font-weight:700; color:#1f2937; letter-spacing:.2px; }

    /* Sağ-üst X */
    .gh-close{
      position:absolute; top:4px; right:10px; z-index:2; /* sabit konum, hover'da kaymaz */
      width:36px; height:36px; border-radius:9999px;
      background:#ef4444; border:1px solid #d1d5db;
      color:#fff; font-size:22px; line-height:1;
      display:flex; align-items:center; justify-content:center; cursor:pointer;
    }
    .gh-close:hover{ background:#ef4444 }
    .gh-close:focus{ outline:2px solid #2563eb; outline-offset:2px }

    .gh-tab{
      border:1px solid #d1d5db;border-radius:10px;padding:10px 14px;
      background:#e5e7eb;color:#1f2937;font-weight:600;cursor:pointer;opacity:1
    }
    .gh-tab.gh-active{background:#2563eb;color:#fff;border-color:#2563eb}
    /* seçili değilken de okunaklı kalsın */
    .gh-tab:not(.gh-active){background:#e5e7eb;color:#1f2937}

    /* Modal düzeni: iç scroll + sticky footer */
    .gh-modal{display:flex;flex-direction:column;height:86vh}
    .gh-body{flex:1;overflow:auto;padding-bottom:12px}
    .gh-footer{position:sticky;bottom:0;background:#fff;padding-top:8px}

    /* Yönet listesi satırı */
    #ghManageList .row{display:grid;grid-template-columns:28px 1fr 140px;align-items:center;
      gap:10px;padding:10px;border-bottom:1px solid #f1f5f9}

    /* Düzenle paneli - basit flex düzeni */
    .gh-grid{
      display:flex !important;
      flex-direction:column !important;
      gap:8px !important;
    }
    
    .gh-grid-row{
      display:flex !important;
      align-items:center !important;
      gap:12px !important;
      padding:8px 12px !important;
      border:1px solid #e5e7eb !important;
      border-radius:6px !important;
      background:#f9fafb !important;
      min-height:40px !important;
    }
    
    .gh-grid-row input[type="checkbox"]{
      width:18px !important;
      height:18px !important;
      margin:0 !important;
      flex-shrink:0 !important;
    }
    
    .gh-grid-row span{
      flex:1 !important;
      font-size:14px !important;
      color:#374151 !important;
      line-height:1.4 !important;
    }

    /* Düzenle butonu renk durumları */
    .btn-edit{background:#e5e7eb;border:0;border-radius:8px;padding:8px 10px;color:#6b7280}
    .btn-edit.enabled{background:#10b981;color:#fff;cursor:pointer}
    .btn-edit.enabled:hover{filter:brightness(.95)}
  </style>

  <script type="module" src="/js/ui-standard.js"></script>
</body>
</html>