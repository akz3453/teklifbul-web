<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug Information</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .info-box { background: #e3f2fd; padding: 15px; border-radius: 4px; margin: 10px 0; }
    .error-box { background: #ffebee; padding: 15px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #f44336; }
    .success-box { background: #e8f5e9; padding: 15px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #4caf50; }
    button { background: #2196f3; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; }
    button:hover { background: #1976d2; }
    pre { background: #f1f1f1; padding: 10px; border-radius: 4px; overflow-x: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ Sistem Debug Bilgileri</h1>
    <p>Bu sayfa sistemdeki potansiyel sorunlarÄ± teÅŸhis etmek iÃ§in oluÅŸturulmuÅŸtur.</p>
    
    <div class="info-box">
      <h3>Auth Durumu</h3>
      <div id="auth-status">YÃ¼kleniyor...</div>
    </div>
    
    <div class="info-box">
      <h3>KullanÄ±cÄ± Bilgileri</h3>
      <div id="user-info">YÃ¼kleniyor...</div>
    </div>
    
    <div class="info-box">
      <h3>Åirket Bilgileri</h3>
      <div id="company-info">YÃ¼kleniyor...</div>
    </div>
    
    <div class="info-box">
      <h3>TedarikÃ§i Kategorileri</h3>
      <div id="supplier-categories">YÃ¼kleniyor...</div>
    </div>
    
    <div class="info-box">
      <h3>VeritabanÄ± EriÅŸimi</h3>
      <div id="db-access">YÃ¼kleniyor...</div>
    </div>
    
    <button id="refresh-btn">Bilgileri Yenile</button>
    
    <div style="margin-top: 20px;">
      <h3>DetaylÄ± Loglar</h3>
      <pre id="logs"></pre>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './firebase.js';
    import { 
      doc, 
      getDoc, 
      collection, 
      getDocs, 
      query, 
      where,
      limit
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    
    const logElement = document.getElementById('logs');
    
    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      logElement.textContent += `[${timestamp}] ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
      console.log(message);
    }
    
    async function checkAuthStatus() {
      log("Auth durumu kontrol ediliyor...");
      const authStatusEl = document.getElementById('auth-status');
      
      if (auth.currentUser) {
        authStatusEl.innerHTML = `
          <div class="success-box">
            <strong>âœ… KullanÄ±cÄ± oturumu aÃ§Ä±k</strong><br>
            UID: ${auth.currentUser.uid}<br>
            Email: ${auth.currentUser.email || 'Yok'}
          </div>
        `;
        log("KullanÄ±cÄ± oturumu aÃ§Ä±k: " + auth.currentUser.uid);
        return auth.currentUser;
      } else {
        authStatusEl.innerHTML = `
          <div class="error-box">
            <strong>âŒ KullanÄ±cÄ± oturumu kapalÄ±</strong><br>
            GiriÅŸ yapmanÄ±z gerekiyor.
          </div>
        `;
        log("KullanÄ±cÄ± oturumu kapalÄ±");
        return null;
      }
    }
    
    async function checkUserInfo(user) {
      log("KullanÄ±cÄ± bilgileri kontrol ediliyor...");
      const userInfoEl = document.getElementById('user-info');
      
      if (!user) {
        userInfoEl.innerHTML = '<div class="error-box">KullanÄ±cÄ± bilgisi alÄ±namadÄ±</div>';
        return;
      }
      
      try {
        // users collection'Ä±ndan bilgileri al
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          userInfoEl.innerHTML = `
            <div class="success-box">
              <strong>KullanÄ±cÄ± Profili:</strong><br>
              Ad: ${userData.name || userData.displayName || 'BelirtilmemiÅŸ'}<br>
              Email: ${userData.email || user.email || 'BelirtilmemiÅŸ'}<br>
              Rol: ${userData.role || 'BelirtilmemiÅŸ'}<br>
              Aktif: ${userData.isActive ? 'Evet' : 'HayÄ±r'}<br>
              Åirket ID: ${userData.companyId || 'BelirtilmemiÅŸ'}
            </div>
          `;
          log("KullanÄ±cÄ± profili yÃ¼klendi");
          return userData;
        } else {
          userInfoEl.innerHTML = '<div class="error-box">KullanÄ±cÄ± profili bulunamadÄ±</div>';
          log("KullanÄ±cÄ± profili bulunamadÄ±");
          return null;
        }
      } catch (error) {
        userInfoEl.innerHTML = `<div class="error-box">Hata: ${error.message}</div>`;
        log("KullanÄ±cÄ± bilgisi alÄ±nÄ±rken hata: " + error.message);
        return null;
      }
    }
    
    async function checkCompanyInfo(user, userData) {
      log("Åirket bilgileri kontrol ediliyor...");
      const companyInfoEl = document.getElementById('company-info');
      
      if (!userData || !userData.companyId) {
        companyInfoEl.innerHTML = '<div class="error-box">Åirket bilgisi bulunamadÄ±. Ayarlar sayfasÄ±ndan ÅŸirket bilgilerinizi girin.</div>';
        log("Åirket ID bulunamadÄ±");
        return;
      }
      
      try {
        const companyDoc = await getDoc(doc(db, 'companies', userData.companyId));
        if (companyDoc.exists()) {
          const companyData = companyDoc.data();
          companyInfoEl.innerHTML = `
            <div class="success-box">
              <strong>Åirket Bilgileri:</strong><br>
              ID: ${userData.companyId}<br>
              Ad: ${companyData.name || 'BelirtilmemiÅŸ'}<br>
              Vergi No: ${companyData.taxNumber || 'BelirtilmemiÅŸ'}<br>
              Ä°lÃ§e: ${companyData.district || 'BelirtilmemiÅŸ'}<br>
              Ä°lÃ§e Kodu: ${companyData.ilceKodu || 'BelirtilmemiÅŸ'}
            </div>
          `;
          log("Åirket bilgileri yÃ¼klendi");
        } else {
          companyInfoEl.innerHTML = '<div class="error-box">Åirket kaydÄ± bulunamadÄ±</div>';
          log("Åirket kaydÄ± bulunamadÄ±");
        }
      } catch (error) {
        companyInfoEl.innerHTML = `<div class="error-box">Hata: ${error.message}</div>`;
        log("Åirket bilgisi alÄ±nÄ±rken hata: " + error.message);
      }
    }
    
    async function checkSupplierCategories(user, userData) {
      log("TedarikÃ§i kategorileri kontrol ediliyor...");
      const categoriesEl = document.getElementById('supplier-categories');
      
      if (!userData) {
        categoriesEl.innerHTML = '<div class="error-box">KullanÄ±cÄ± bilgisi eksik</div>';
        return;
      }
      
      try {
        // supplierCategoryKeys veya supplierCategories alanlarÄ±nÄ± kontrol et
        const supplierCategoryKeys = Array.isArray(userData.supplierCategoryKeys) 
          ? userData.supplierCategoryKeys 
          : [];
          
        const supplierCategories = Array.isArray(userData.supplierCategories) 
          ? userData.supplierCategories 
          : [];
        
        if (supplierCategoryKeys.length > 0) {
          categoriesEl.innerHTML = `
            <div class="success-box">
              <strong>TedarikÃ§i Kategorileri (supplierCategoryKeys):</strong><br>
              ${supplierCategoryKeys.join(', ')}<br>
              <small>Toplam: ${supplierCategoryKeys.length} kategori</small>
            </div>
          `;
          log(`TedarikÃ§i kategorileri yÃ¼klendi (${supplierCategoryKeys.length} adet)`);
        } else if (supplierCategories.length > 0) {
          categoriesEl.innerHTML = `
            <div class="success-box">
              <strong>TedarikÃ§i Kategorileri (supplierCategories):</strong><br>
              ${supplierCategories.join(', ')}<br>
              <small>Toplam: ${supplierCategories.length} kategori</small>
            </div>
          `;
          log(`TedarikÃ§i kategorileri yÃ¼klendi (${supplierCategories.length} adet)`);
        } else {
          categoriesEl.innerHTML = `
            <div class="error-box">
              <strong>TedarikÃ§i kategorisi seÃ§ilmemiÅŸ</strong><br>
              Ayarlar sayfasÄ±ndan tedarikÃ§i kategorilerinizi seÃ§melisiniz.
            </div>
          `;
          log("TedarikÃ§i kategorisi bulunamadÄ±");
        }
      } catch (error) {
        categoriesEl.innerHTML = `<div class="error-box">Hata: ${error.message}</div>`;
        log("TedarikÃ§i kategorileri alÄ±nÄ±rken hata: " + error.message);
      }
    }
    
    async function checkDatabaseAccess(user) {
      log("VeritabanÄ± eriÅŸimi kontrol ediliyor...");
      const dbAccessEl = document.getElementById('db-access');
      
      if (!user) {
        dbAccessEl.innerHTML = '<div class="error-box">KullanÄ±cÄ± oturumu kapalÄ±</div>';
        return;
      }
      
      try {
        // Basit bir sorgu ile veritabanÄ± eriÅŸimini test et - limit kaldÄ±rÄ±ldÄ±, basit test yapÄ±lÄ±yor
        const testQuery = query(collection(db, 'demands'), limit(1));
        const testSnapshot = await getDocs(testQuery);
        
        dbAccessEl.innerHTML = `
          <div class="success-box">
            <strong>âœ… VeritabanÄ± eriÅŸimi baÅŸarÄ±lÄ±</strong><br>
            Firestore baÄŸlantÄ±sÄ± Ã§alÄ±ÅŸÄ±yor.<br>
            <small>Test sorgusu: ${testSnapshot.size} sonuÃ§ dÃ¶ndÃ¼</small>
          </div>
        `;
        log("VeritabanÄ± eriÅŸimi baÅŸarÄ±lÄ±");
      } catch (error) {
        if (error.message.includes('Missing or insufficient permissions')) {
          dbAccessEl.innerHTML = `
            <div class="error-box">
              <strong>âŒ Yetki hatasÄ±</strong><br>
              Firestore gÃ¼venlik kurallarÄ± nedeniyle eriÅŸim reddedildi.<br>
              Hata: ${error.message}
            </div>
          `;
          log("VeritabanÄ± yetki hatasÄ±: " + error.message);
        } else {
          dbAccessEl.innerHTML = `
            <div class="error-box">
              <strong>âŒ VeritabanÄ± eriÅŸim hatasÄ±</strong><br>
              Hata: ${error.message}
            </div>
          `;
          log("VeritabanÄ± eriÅŸim hatasÄ±: " + error.message);
        }
      }
    }
    
    async function runDiagnostics() {
      log("=== Sistem teÅŸhisi baÅŸlatÄ±lÄ±yor ===");
      
      try {
        // Auth durumunu kontrol et
        const user = await checkAuthStatus();
        
        // KullanÄ±cÄ± bilgilerini al
        const userData = await checkUserInfo(user);
        
        // Åirket bilgilerini kontrol et
        await checkCompanyInfo(user, userData);
        
        // TedarikÃ§i kategorilerini kontrol et
        await checkSupplierCategories(user, userData);
        
        // VeritabanÄ± eriÅŸimini test et
        await checkDatabaseAccess(user);
        
        log("=== Sistem teÅŸhisi tamamlandÄ± ===");
      } catch (error) {
        log("TeÅŸhis sÄ±rasÄ±nda hata oluÅŸtu: " + error.message);
        console.error(error);
      }
    }
    
    // Sayfa yÃ¼klendiÄŸinde teÅŸhisi baÅŸlat
    document.addEventListener('DOMContentLoaded', runDiagnostics);
    
    // Yenile butonu
    document.getElementById('refresh-btn').addEventListener('click', runDiagnostics);
  </script>
</body>
</html>