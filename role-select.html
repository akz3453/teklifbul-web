<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rol SeÃ§imi</title>
  <link rel="stylesheet" href="./utils.css" />
  <style>
    body { font-family: system-ui, Arial; max-width: 720px; margin: 40px auto; padding: 0 20px; }
    .role-buttons { display: flex; gap: 12px; margin: 20px 0; }
    .role-btn { flex: 1; padding: 20px; cursor: pointer; border: 2px solid #ddd; border-radius: 8px; background: white; transition: all 0.2s; }
    .role-btn:hover { border-color: #3b82f6; background: #eff6ff; }
    .role-btn.selected { border-color: #3b82f6; background: #dbeafe; }
    .form-section { display: none; margin-top: 24px; padding: 24px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; }
    .form-section.visible { display: block; }
    .form-group { margin-bottom: 16px; }
    label { display: block; font-weight: 600; font-size: 14px; margin-bottom: 6px; color: #374151; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="url"], textarea {
      width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;
    }
    .chip-input { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; min-height: 42px; background: white; }
    .chip-input input { border: none; outline: none; flex: 1; min-width: 150px; }
    .badge { display: inline-block; padding: 6px 10px; background: #3b82f6; color: white; border-radius: 16px; font-size: 12px; cursor: pointer; }
    .badge:hover { background: #2563eb; }
    .checkbox-group { display: flex; align-items: start; gap: 8px; margin: 12px 0; }
    .checkbox-group input[type="checkbox"] { margin-top: 3px; }
    .checkbox-group label { margin: 0; font-weight: 400; }
    .required { color: #ef4444; }
    .kvkk-text { 
      font-size: 13px; 
      color: #374151; 
      padding: 16px; 
      background: #f9fafb; 
      border: 1px solid #e5e7eb;
      border-radius: 8px; 
      margin: 16px 0; 
      line-height: 1.7; 
      text-align: left;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .kvkk-text strong {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
    }
    .kvkk-text a { 
      color: #3b82f6; 
      text-decoration: none; 
      font-weight: 500;
    }
    .kvkk-text a:hover { 
      text-decoration: underline; 
    }
    .btn-primary { background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; }
    .btn-primary:hover { background: #2563eb; }
    .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; }
    .file-upload { padding: 12px; border: 2px dashed #d1d5db; border-radius: 6px; background: white; cursor: pointer; }
    .file-upload:hover { border-color: #3b82f6; background: #eff6ff; }
  </style>
</head>
<body>
  <h1>Profil OluÅŸtur</h1>
  <p style="color:#6b7280; margin-bottom:24px;">Teklifbul'da nasÄ±l devam edeceksiniz?</p>
  
  <div class="role-buttons">
    <button class="role-btn" id="buyerBtn" type="button">
      <h3 style="margin:0 0 8px 0;">ğŸ›’ AlÄ±cÄ±</h3>
      <p style="margin:0; font-size:13px; color:#6b7280;">Talep oluÅŸtur ve teklif al</p>
      <span id="buyerCheck" style="display:none; color:#3b82f6; font-weight:bold;">âœ“ SeÃ§ildi</span>
    </button>
    <button class="role-btn" id="supplierBtn" type="button">
      <h3 style="margin:0 0 8px 0;">TedarikÃ§i</h3>
      <p style="margin:0; font-size:13px; color:#6b7280;">Taleplere teklif ver</p>
      <span id="supplierCheck" style="display:none; color:#3b82f6; font-weight:bold;">âœ“ SeÃ§ildi</span>
    </button>
  </div>
  <p style="font-size:12px; color:#6b7280; margin-top:8px; text-align:center;">
    ğŸ’¡ Hem alÄ±cÄ± hem tedarikÃ§i olabilirsiniz. Her iki rol iÃ§in de ÅŸirket iÃ§indeki rolÃ¼nÃ¼zÃ¼ seÃ§meniz gerekecek.
  </p>
  
  <div id="formSection" class="form-section">
    <h2 style="margin-top:0;">Åirket Bilgileri</h2>
    
    <!-- Company Setup Mode Selection -->
    <div class="form-group" style="background:#f0f9ff; padding:16px; border-radius:8px; border:2px solid #3b82f6; margin-bottom:24px;">
      <label style="font-weight:600; margin-bottom:12px; display:block;">Åirket Kurulum Modu <span class="required">*</span></label>
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <label style="flex:1; min-width:200px; padding:12px; border:2px solid #3b82f6; border-radius:6px; cursor:pointer; background:white; transition:all 0.2s;">
          <input type="radio" name="companyMode" value="new" checked style="margin-right:8px;" />
          <strong>Yeni Åirket OluÅŸtur</strong>
          <p style="margin:4px 0 0 0; font-size:12px; color:#6b7280;">Sistem otomatik olarak ÅŸirket kodu oluÅŸturur</p>
        </label>
        <label style="flex:1; min-width:200px; padding:12px; border:2px solid #d1d5db; border-radius:6px; cursor:pointer; background:white; transition:all 0.2s;">
          <input type="radio" name="companyMode" value="join" style="margin-right:8px;" />
          <strong>Mevcut Åirkete KatÄ±l</strong>
          <p style="margin:4px 0 0 0; font-size:12px; color:#6b7280;">Åirket kodunu girip onay bekleyin</p>
        </label>
      </div>
      
      <!-- Join Company Fields (hidden by default) -->
      <div id="joinCompanySection" style="display:none; margin-top:16px; padding:12px; background:white; border-radius:6px; border:1px solid #d1d5db;">
        <div class="form-group" style="margin-bottom:12px;">
          <label for="companyCode">Åirket Kodu <span class="required">*</span></label>
          <input type="text" id="companyCode" placeholder="Åirket kodunu girin" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; text-transform:uppercase;" maxlength="8" />
          <p style="font-size:12px; color:#6b7280; margin-top:4px;">Mevcut ÅŸirketin kodunu girin. Onay iÃ§in ÅŸirket yÃ¶neticilerine bildirim gÃ¶nderilecek.</p>
        </div>
        <div class="form-group">
          <label for="joinRoleSelect">Åirket Ä°Ã§indeki RolÃ¼nÃ¼z <span class="required">*</span></label>
          <select id="joinRoleSelect" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
            <option value="">Rol seÃ§in</option>
            <optgroup label="AlÄ±cÄ± Rolleri">
              <option value="buyer:satinalma_yetkilisi">SatÄ±n Alma Yetkilisi</option>
              <option value="buyer:santiye_yetkilisi">Åantiye Yetkilisi</option>
              <option value="buyer:stok_depo">Stok / Depo Yetkilisi</option>
              <option value="buyer:muhasebe">Muhasebe</option>
              <option value="buyer:alici">AlÄ±cÄ±</option>
              <option value="buyer:genel_mudur">Genel MÃ¼dÃ¼r</option>
              <option value="buyer:genel_mudur_yardimcisi">Genel MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±</option>
              <option value="buyer:yonetim_kurulu_baskani">YÃ¶netim Kurulu BaÅŸkanÄ±</option>
              <option value="buyer:isveren">Ä°ÅŸveren (Åirket Sahibi)</option>
              <option value="buyer:ceo">CEO</option>
            </optgroup>
            <optgroup label="TedarikÃ§i Rolleri">
              <option value="supplier:satis_personeli">SatÄ±ÅŸ Personeli</option>
              <option value="supplier:pazarlama_muduru">Pazarlama MÃ¼dÃ¼rÃ¼</option>
              <option value="supplier:genel_mudur">Genel MÃ¼dÃ¼r</option>
              <option value="supplier:yonetim_kurulu_baskani">YÃ¶netim Kurulu BaÅŸkanÄ±</option>
              <option value="supplier:ceo">CEO</option>
              <option value="supplier:sirket_sahibi">Åirket Sahibi</option>
            </optgroup>
          </select>
        </div>
      </div>
      
      <!-- New Company Auto Code Display -->
      <div id="newCompanyCodeSection" style="margin-top:16px; padding:12px; background:#dbeafe; border-radius:6px;">
        <p style="margin:0; font-size:14px; font-weight:600; color:#1e40af;">
          ğŸ“ OluÅŸturulacak Åirket Kodu: <span id="generatedCompanyCode" style="font-family:monospace; font-size:16px; color:#1e3a8a;">-</span>
        </p>
        <p style="margin:4px 0 0 0; font-size:12px; color:#1e40af;">Bu kod otomatik oluÅŸturulacak ve kayÄ±t sonrasÄ± size bildirilecek.</p>
      </div>
      
      <!-- New Company Role Selection -->
      <div id="newCompanyRoleSection" style="margin-top:16px; padding:12px; background:white; border-radius:6px; border:1px solid #d1d5db;">
        <!-- Buyer Role Selection (if buyer is selected) -->
        <div id="newCompanyBuyerRoleSection" style="display:none; margin-bottom:16px; padding-bottom:16px; border-bottom:1px solid #e5e7eb;">
          <div class="form-group">
            <label for="newCompanyBuyerRoleSelect">AlÄ±cÄ± RolÃ¼nÃ¼z - Åirket Ä°Ã§indeki RolÃ¼nÃ¼z <span class="required">*</span></label>
            <select id="newCompanyBuyerRoleSelect" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
              <option value="">Rol seÃ§in</option>
              <option value="buyer:satinalma_yetkilisi">SatÄ±n Alma Yetkilisi</option>
              <option value="buyer:santiye_yetkilisi">Åantiye Yetkilisi</option>
              <option value="buyer:stok_depo">Stok / Depo Yetkilisi</option>
              <option value="buyer:muhasebe">Muhasebe</option>
              <option value="buyer:alici">AlÄ±cÄ±</option>
              <option value="buyer:genel_mudur">Genel MÃ¼dÃ¼r</option>
              <option value="buyer:genel_mudur_yardimcisi">Genel MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±</option>
              <option value="buyer:yonetim_kurulu_baskani">YÃ¶netim Kurulu BaÅŸkanÄ±</option>
              <option value="buyer:isveren" selected>Ä°ÅŸveren (Åirket Sahibi)</option>
              <option value="buyer:ceo">CEO</option>
            </select>
          </div>
        </div>
        
        <!-- Supplier Role Selection (if supplier is selected) -->
        <div id="newCompanySupplierRoleSection" style="display:none;">
          <div class="form-group">
            <label for="newCompanySupplierRoleSelect">TedarikÃ§i RolÃ¼nÃ¼z - Åirket Ä°Ã§indeki RolÃ¼nÃ¼z <span class="required">*</span></label>
            <select id="newCompanySupplierRoleSelect" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
              <option value="">Rol seÃ§in</option>
              <option value="supplier:satis_personeli">SatÄ±ÅŸ Personeli</option>
              <option value="supplier:pazarlama_muduru">Pazarlama MÃ¼dÃ¼rÃ¼</option>
              <option value="supplier:genel_mudur">Genel MÃ¼dÃ¼r</option>
              <option value="supplier:yonetim_kurulu_baskani">YÃ¶netim Kurulu BaÅŸkanÄ±</option>
              <option value="supplier:ceo">CEO</option>
              <option value="supplier:sirket_sahibi" selected>Åirket Sahibi</option>
            </select>
          </div>
        </div>
        
        <div style="margin-top:12px; padding:12px; background:#f0f9ff; border-radius:6px;">
          <p style="font-size:12px; color:#1e40af; margin:0; line-height:1.6;">
            ğŸ’¡ <strong>Rol Yetkileri:</strong><br>
            <strong>Ä°Ã§ Talep:</strong> Åantiye Yetkilisi, Stok/Depo, Genel MÃ¼dÃ¼r, Genel MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±, YÃ¶netim Kurulu BaÅŸkanÄ±, Ä°ÅŸveren, CEO<br>
            <strong>DÄ±ÅŸ Talep:</strong> SatÄ±n Alma Yetkilisi<br>
            <strong>TAM YETKÄ°:</strong> Ä°ÅŸveren (kurucu), Genel MÃ¼dÃ¼r (AlÄ±cÄ±), SatÄ±n Alma Yetkilisi, Genel MÃ¼dÃ¼r/Pazarlama MÃ¼dÃ¼rÃ¼ (TedarikÃ§i), SatÄ±ÅŸ Personeli
          </p>
        </div>
      </div>
    </div>
    
    <!-- Company Info -->
    <div class="form-group">
      <label for="companyName">Åirket AdÄ± <span class="required">*</span></label>
      <input type="text" id="companyName" placeholder="Åirket AdÄ±" autocomplete="organization" required />
    </div>
    
    <div class="form-group">
      <label for="taxNumber">Vergi No <span class="required">*</span></label>
      <input type="text" id="taxNumber" placeholder="1234567890" autocomplete="off" required />
    </div>
    
    <div class="form-group">
      <label for="mersisNo">MERSÄ°S No</label>
      <input type="text" id="mersisNo" placeholder="0123456789012345" autocomplete="off" />
    </div>
    
    <!-- Ana adres kaldÄ±rÄ±ldÄ± - Sadece fatura adresi kullanÄ±lÄ±yor - Teklifbul Rule v1.0 -->
    
    <div class="form-group">
      <label for="website">Web Sitesi</label>
      <input type="url" id="website" placeholder="https://www.ornek.com" autocomplete="url" />
    </div>
    
    <hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;" />
    
    <!-- Contact Info -->
    <h3>Ä°letiÅŸim Bilgileri</h3>
    
    <div class="form-group">
      <label for="emailInput">E-posta Adresleri <span class="required" id="emailRequired" style="display:none;">*</span></label>
      <div class="chip-input" id="emailChipInput">
        <input type="email" id="emailInput" placeholder="E-posta ekle ve Enter'a basÄ±n" autocomplete="email" />
      </div>
      <p style="font-size:12px; color:#6b7280; margin-top:4px;">Birden fazla e-posta ekleyebilirsiniz</p>
    </div>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:16px;">
      <div class="form-group" style="margin-bottom:0;">
        <label for="companyPhone">Åirket Sabit Telefon</label>
        <input type="text" id="companyPhone" placeholder="Ã–rn: 0 (212) 555 00 00" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;" />
      </div>
      <div class="form-group" style="margin-bottom:0;">
        <label for="mobilePhone">Cep Telefonu</label>
        <input type="text" id="mobilePhone" placeholder="Ã–rn: 0 (5XX) 555 00 00" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;" />
      </div>
    </div>
    
    <div class="form-group" style="margin-bottom:16px;">
      <label for="whatsappPhone">WhatsApp HattÄ±</label>
      <input type="text" id="whatsappPhone" placeholder="Varsa Ã¶zel WhatsApp hattÄ±" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;" />
    </div>
    
    <div class="form-group">
      <label for="phoneInput">DiÄŸer Telefonlar</label>
      <div class="chip-input" id="phoneChipInput">
        <input type="tel" id="phoneInput" placeholder="DiÄŸer numaralarÄ± ekle ve Enter'a basÄ±n" autocomplete="tel" />
      </div>
      <p style="font-size:12px; color:#6b7280; margin-top:4px;">Ek numaralarÄ± serbestÃ§e ekleyebilirsiniz</p>
    </div>
    
    <hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;" />
    
    <!-- Fatura Adresi -->
    <h3>Fatura Adresi <span class="required">*</span></h3>
    <p style="font-size:13px; color:#6b7280; margin-bottom:12px;">Bu adres tedarikÃ§i firmalarÄ±n fatura kesmesi iÃ§in kullanÄ±lacak</p>
    
    <div class="form-group">
      <label for="invoiceAddress">Fatura Adresi <span class="required">*</span></label>
      <textarea id="invoiceAddress" placeholder="Fatura adresi otomatik olarak oluÅŸturulacak" rows="3" readonly style="background:#f3f4f6;" required></textarea>
      <p style="font-size:12px; color:#6b7280; margin-top:4px;">AÅŸaÄŸÄ±daki alanlarÄ± doldurarak fatura adresinizi oluÅŸturun</p>
    </div>
    
    <!-- Structured Invoice Address Parts -->
    <div style="background:#f9fafb; padding:16px; border-radius:6px; margin-bottom:16px;">
      <div class="form-group" style="margin-bottom:12px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
          <div>
            <label for="inv_ulke">Ãœlke</label>
            <select id="inv_ulke" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
              <option value="TÃ¼rkiye" selected>TÃ¼rkiye</option>
              <option value="Almanya">Almanya</option>
              <option value="Amerika BirleÅŸik Devletleri">Amerika BirleÅŸik Devletleri</option>
              <option value="BirleÅŸik KrallÄ±k">BirleÅŸik KrallÄ±k</option>
              <option value="Fransa">Fransa</option>
              <option value="Hollanda">Hollanda</option>
              <option value="Ä°spanya">Ä°spanya</option>
              <option value="Ä°talya">Ä°talya</option>
              <option value="DiÄŸer">DiÄŸer</option>
            </select>
          </div>
          <div>
            <label for="inv_il">Ä°l</label>
            <select id="inv_il" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
              <option value="">Ä°l seÃ§in</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="form-group" style="margin-bottom:12px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
          <div>
            <label for="inv_ilce">Ä°lÃ§e</label>
            <select id="inv_ilce" disabled style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
              <option value="">Ã–nce il seÃ§in</option>
            </select>
          </div>
          <div>
            <label for="inv_mahalle">Mahalle</label>
            <select id="inv_mahalle" disabled style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
              <option value="">Ã–nce ilÃ§e seÃ§in</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="form-group" style="margin-bottom:12px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
          <div>
            <label for="inv_cadde">Cadde</label>
            <input type="text" id="inv_cadde" placeholder="Cadde" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
          </div>
          <div>
            <label for="inv_sokak">Sokak</label>
            <select id="inv_sokak" disabled style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; display:block;">
              <option value="">(Opsiyonel) Mahalle seÃ§in</option>
            </select>
            <input type="text" id="inv_sokak_manual" placeholder="Sokak (elle yazÄ±n)" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-top:6px; display:none;">
          </div>
        </div>
      </div>
      
      <div class="form-group" style="margin-bottom:12px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
          <div>
            <label for="inv_kapi">KapÄ± No</label>
            <input type="text" id="inv_kapi" placeholder="KapÄ± No" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
          </div>
          <div>
            <label for="inv_daire">Daire</label>
            <input type="text" id="inv_daire" placeholder="Daire (varsa)" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
          <div>
            <label for="inv_postakodu">Posta Kodu</label>
            <input type="text" id="inv_postakodu" placeholder="Posta Kodu" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
          </div>
          <div></div>
        </div>
      </div>
    </div>
    
    <div class="form-group">
      <label for="taxOffice">Vergi Dairesi</label>
      <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items:center; flex-wrap: wrap;">
        <select id="taxOfficeSelect" style="flex: 1 1 auto; min-width: 220px; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
          <option value="">Vergi dairesi seÃ§in</option>
          <option value="__MANUAL__">Elle yaz</option>
        </select>
        <button type="button" id="refreshTaxOfficesBtn" style="flex:0 0 auto; padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; white-space: nowrap;">
          ğŸ”„ Yenile
        </button>
      </div>
      <input type="text" id="taxOffice" placeholder="Vergi dairesi adÄ± (seÃ§im yapÄ±n veya elle yazÄ±n)" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;" />
    </div>
    
    <hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;" />
    
    <!-- Bank Accounts -->
    <h3>Banka HesaplarÄ±</h3>
    <p style="font-size:13px; color:#6b7280; margin-bottom:12px;">Ã–deme alacaÄŸÄ±nÄ±z banka hesaplarÄ±nÄ±zÄ± ekleyin</p>
    
    <div id="bankAccountsList" style="margin-bottom:16px;">
      <!-- Bank accounts will be added here dynamically -->
    </div>
    
    <button type="button" id="addBankAccountBtn" style="padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px; margin-bottom:16px;">
      â• Hesap Ekle
    </button>
    
    <hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;" />
    
    <!-- Categories Section -->
    <div id="categoriesSection" style="display:none;">
      <h3>Kategori SeÃ§imi</h3>
      
      <!-- Buyer Categories -->
      <div id="buyerCategoriesSection" style="display:none;">
        <h4 style="margin:16px 0 8px 0; color:#3b82f6;">ğŸ›’ AlÄ±cÄ± Kategorileri</h4>
        <p style="font-size:13px; color:#6b7280; margin-bottom:12px;">Hangi alanlarda talep oluÅŸturacaksÄ±nÄ±z?</p>
        
        <div style="margin-bottom:16px;">
          <button type="button" id="selectAllBuyer" style="padding:6px 12px; background:#e5e7eb; border:none; border-radius:4px; cursor:pointer; font-size:12px; margin-right:8px;">TÃ¼mÃ¼nÃ¼ SeÃ§</button>
          <button type="button" id="clearAllBuyer" style="padding:6px 12px; background:#fee2e2; border:none; border-radius:4px; cursor:pointer; font-size:12px;">TÃ¼mÃ¼nÃ¼ Temizle</button>
        </div>
        
        <div class="chip-input" id="buyerCategoryChipInput" style="min-height:60px; max-height:120px; overflow-y:auto;">
          <input type="text" id="buyerCategoryInput" placeholder="Kategori ekle veya seÃ§..." list="buyerCategoryList" autocomplete="off" />
          <datalist id="buyerCategoryList"></datalist>
        </div>
      </div>
      
      <!-- Supplier Categories -->
      <div id="supplierCategoriesSection" style="display:none;">
        <h4 style="margin:16px 0 8px 0; color:#dc2626;">TedarikÃ§i Kategorileri</h4>
        <p style="font-size:13px; color:#6b7280; margin-bottom:12px;">Hangi alanlarda teklif vereceksiniz?</p>
        
        <div style="margin-bottom:16px;">
          <button type="button" id="selectAllSupplier" style="padding:6px 12px; background:#e5e7eb; border:none; border-radius:4px; cursor:pointer; font-size:12px; margin-right:8px;">TÃ¼mÃ¼nÃ¼ SeÃ§</button>
          <button type="button" id="clearAllSupplier" style="padding:6px 12px; background:#fee2e2; border:none; border-radius:4px; cursor:pointer; font-size:12px;">TÃ¼mÃ¼nÃ¼ Temizle</button>
        </div>
        
        <div class="chip-input" id="supplierCategoryChipInput" style="min-height:60px; max-height:120px; overflow-y:auto;">
          <input type="text" id="supplierCategoryInput" placeholder="Kategori ekle veya seÃ§..." list="supplierCategoryList" autocomplete="off" />
          <datalist id="supplierCategoryList"></datalist>
        </div>
      </div>
      
      <hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;" />
    </div>
    
    <!-- Tax Certificate -->
    <div class="form-group">
      <label for="taxCertFile">Vergi LevhasÄ±</label>
      <div class="file-upload">
        <input type="file" id="taxCertFile" accept=".pdf,.png,.jpg,.jpeg" style="display:none;" />
        <div id="fileUploadTrigger">
          <p style="margin:0; font-size:14px; color:#3b82f6;">ğŸ“ Dosya SeÃ§ (PDF, PNG, JPG - Maks. 10 MB)</p>
          <p id="fileName" style="margin:4px 0 0 0; font-size:12px; color:#6b7280;"></p>
        </div>
      </div>
    </div>
    
    <hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;" />
    
    <!-- KVKK Consents -->
    <h3>Onaylar</h3>
    
    <div class="kvkk-text">
      <strong>KVKK AydÄ±nlatma ve AÃ§Ä±k RÄ±za:</strong> Teklifbul BiliÅŸim A.Å. tarafÄ±ndan sunulan hizmetler kapsamÄ±nda, kimlik ve iletiÅŸim bilgilerim ile firma bilgilerimin; tedarikÃ§i eÅŸleÅŸtirme, talep iletimi, teklif sÃ¼reÃ§ yÃ¶netimi ve yasal yÃ¼kÃ¼mlÃ¼lÃ¼klerin yerine getirilmesi amaÃ§larÄ±yla iÅŸlenmesini; yurt iÃ§i/yurt dÄ±ÅŸÄ± hizmet saÄŸlayÄ±cÄ±larÄ±na aktarÄ±lmasÄ±nÄ± kabul ediyorum. 
      <a href="#" target="_blank">DetaylÄ± AydÄ±nlatma Metni</a>
    </div>
    
    <div class="checkbox-group">
      <input type="checkbox" id="kvkkConsent" required />
      <label for="kvkkConsent">KVKK AydÄ±nlatma Metni'ni okudum ve AÃ§Ä±k RÄ±za veriyorum. <span class="required">*</span></label>
    </div>
    
    <div class="checkbox-group">
      <input type="checkbox" id="marketingConsent" />
      <label for="marketingConsent">Ticari elektronik ileti almayÄ± kabul ediyorum.</label>
    </div>
    
    <button class="btn-primary" id="saveBtn" style="width:100%; margin-top:20px;">Kaydet ve Devam Et</button>
  </div>
  
  <p style="margin-top:24px;"><a href="./index.html">â† GiriÅŸ sayfasÄ±na dÃ¶n</a></p>

  <script type="module">
    import { auth, db, app } from "./firebase.js";
    // Teklifbul Rule v1.0 - Structured Logging
    import { logger } from './src/shared/log/logger.js';
    // Teklifbul Rule v1.0 - Toast Notification System
    import { toast } from './src/shared/ui/toast.js';
    // Teklifbul Rule v1.1 - MESSAGES constants (i18n hazÄ±rlÄ±ÄŸÄ±)
    import { MESSAGES } from './src/shared/constants/messages.js';
    // CRITICAL: Import new ID-based category system
    import { 
      getAllCategories, 
      getIdByName, 
      getNameById,
      normalizeToIds 
    } from "./src/categories/category-service.js";
    import {
      doc, getDoc, setDoc, updateDoc, addDoc, serverTimestamp, collection, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

    const storage = getStorage(app);
    let selectedRole = null;
    let bankAccounts = []; // Bank account storage
    let generatedCompanyCode = null; // Generated company code
    
    // === Tax Office Management ===
    // Teklifbul Rule v1.0 - Vergi dairesi sistemi (settings.html'den entegre edildi)
    const LOCAL_TAX_OFFICES = [
      // Ä°stanbul
      "Beykoz Vergi Dairesi","Ãœmraniye Vergi Dairesi","ÃœskÃ¼dar Vergi Dairesi",
      "KadÄ±kÃ¶y Vergi Dairesi","Maltepe Vergi Dairesi","Kartal Vergi Dairesi",
      "BeÅŸiktaÅŸ Vergi Dairesi","ÅiÅŸli Vergi Dairesi","BeyoÄŸlu Vergi Dairesi",
      "BakÄ±rkÃ¶y Vergi Dairesi","Pendik Vergi Dairesi","AtaÅŸehir Vergi Dairesi",
      // Ankara
      "Ã‡ankaya Vergi Dairesi","KeÃ§iÃ¶ren Vergi Dairesi","Yenimahalle Vergi Dairesi",
      "Mamak Vergi Dairesi","Sincan Vergi Dairesi",
      // Ä°zmir
      "Konak Vergi Dairesi","Bornova Vergi Dairesi","KarÅŸÄ±yaka Vergi Dairesi",
      // Genel
      "Kurumlar Vergi Dairesi","BÃ¼yÃ¼k MÃ¼kellefler Vergi Dairesi"
    ];

    // Teklifbul Rule v1.0 - Yeni API tabanlÄ± vergi dairesi sistemi
    async function fetchTaxOfficesFromAPI(province = null, district = null) {
      try {
        if (!province) {
          // Ä°l listesi al
          const res = await fetch('/api/tax-offices/provinces');
          if (res.ok) {
            const provinces = await res.json();
            return { type: 'provinces', data: provinces };
          }
          throw new Error('Provinces API failed');
        }
        
        // Ä°l bazlÄ± vergi daireleri
        // Ä°l adÄ±nÄ± normalize et (bÃ¼yÃ¼k harf, TÃ¼rkÃ§e karakter korunur)
        const normalizedProvince = province.toUpperCase().trim();
        const url = district 
          ? `/api/tax-offices?province=${encodeURIComponent(normalizedProvince)}&district=${encodeURIComponent(district)}`
          : `/api/tax-offices?province=${encodeURIComponent(normalizedProvince)}`;
        const res = await fetch(url);
        
        if (res.ok) {
          const offices = await res.json();
          if (Array.isArray(offices) && offices.length > 0) {
            return { type: 'offices', data: offices };
          }
          // BoÅŸ array dÃ¶nerse fallback'e geÃ§
          logger.warn('API returned empty array, using Firestore fallback');
          return await fetchTaxOfficesFromFirestore();
        }
        
        // 503 hatasÄ± (PostgreSQL yok) - Firestore fallback
        if (res.status === 503) {
          logger.warn('API unavailable (503), using Firestore fallback');
          return await fetchTaxOfficesFromFirestore();
        }
        
        // 500 hatasÄ± - Database hatasÄ± olabilir, fallback kullan
        if (res.status === 500) {
          logger.warn('API server error (500), using Firestore fallback');
          return await fetchTaxOfficesFromFirestore();
        }
        
        throw new Error(`Tax offices API failed: ${res.status}`);
      } catch (e) {
        logger.error("Tax offices API fetch failed", e);
        // Fallback: Firestore
        return await fetchTaxOfficesFromFirestore();
      }
    }
    
    async function fetchTaxOfficesFromFirestore() {
      try {
        console.debug("ğŸ”„ Vergi dairesi listesi Firestore'dan yÃ¼kleniyor...");
        const snap = await getDocs(collection(db, "taxOffices"));
        const list = [];
        snap.forEach(d => {
          const name = d.data()?.name;
          if (name) list.push(name);
        });
        return list.filter(Boolean);
      } catch (e) {
        logger.error("Tax offices Firestore fetch failed", e);
        return LOCAL_TAX_OFFICES; // Son Ã§are: yerel liste
      }
    }

    function populateTaxOfficeSelect(list) {
      const sel = document.getElementById("taxOfficeSelect");
      if (!sel) return;

      sel.innerHTML = "";
      const opts = [
        { v: "", t: "Vergi Dairesi SeÃ§in" },
        ...list.map(n => ({ v: n, t: n })),
        { v: "__MANUAL__", t: "Elle yaz" }
      ];

      for (const o of opts) {
        const op = document.createElement('option');
        op.value = o.v;
        op.textContent = o.t;
        sel.appendChild(op);
      }
    }

    async function buildTaxOfficeSelect() {
      // Ä°l seÃ§imi varsa il bazlÄ± yÃ¼kle
      const invoiceIl = document.getElementById('inv_il')?.value || document.getElementById('invoiceIl')?.value;
      
      if (invoiceIl) {
        const result = await fetchTaxOfficesFromAPI(invoiceIl);
        if (result && result.type === 'offices') {
          const officeList = result.data.map((o) => o.office_name || o.name || '').filter(Boolean);
          if (officeList.length > 0) {
            populateTaxOfficeSelect(officeList);
            return;
          }
        }
      }
      
      // Fallback: Firestore veya yerel liste
      let list = await fetchTaxOfficesFromFirestore();
      if (!list || list.length === 0) {
        console.debug("â„¹ï¸ API ve Firestore'dan veri alÄ±namadÄ±, yerel liste kullanÄ±lÄ±yor (normal durum)");
        list = LOCAL_TAX_OFFICES;
      }
      populateTaxOfficeSelect(list);
    }
    
    // Tax office select change handler
    function setupTaxOfficeSelect() {
      const taxOfficeSelect = document.getElementById("taxOfficeSelect");
      const taxOfficeInput = document.getElementById("taxOffice");
      const refreshBtn = document.getElementById("refreshTaxOfficesBtn");
      
      if (!taxOfficeSelect || !taxOfficeInput) return;
      
      // Select deÄŸiÅŸtiÄŸinde
      taxOfficeSelect.addEventListener('change', () => {
        const selected = taxOfficeSelect.value;
        if (selected && selected !== "" && selected !== "__MANUAL__") {
          taxOfficeInput.value = selected;
          taxOfficeInput.readOnly = true;
          taxOfficeInput.style.background = "#f3f4f6";
        } else if (selected === "__MANUAL__") {
          taxOfficeInput.value = "";
          taxOfficeInput.readOnly = false;
          taxOfficeInput.style.background = "white";
          taxOfficeInput.focus();
        } else {
          taxOfficeInput.value = "";
          taxOfficeInput.readOnly = false;
          taxOfficeInput.style.background = "white";
        }
      });
      
      // Manuel giriÅŸ yapÄ±ldÄ±ÄŸÄ±nda select'i sÄ±fÄ±rla
      taxOfficeInput.addEventListener('input', () => {
        if (!taxOfficeInput.readOnly && taxOfficeInput.value) {
          // KullanÄ±cÄ± manuel giriÅŸ yapÄ±yorsa, select'i "Elle yaz" olarak ayarla
          if (taxOfficeSelect.value !== "__MANUAL__") {
            taxOfficeSelect.value = "__MANUAL__";
          }
        }
      });
      
      // Yenile butonu - Optimize edildi (cache ve timeout ile)
      if (refreshBtn) {
        refreshBtn.addEventListener('click', async () => {
          refreshBtn.disabled = true;
          refreshBtn.textContent = "â³ YÃ¼kleniyor...";
          
          // Ä°l seÃ§ilmiÅŸse sadece o ile ait olanlarÄ± yÃ¼kle (daha hÄ±zlÄ±)
          const invoiceIl = document.getElementById('inv_il')?.value;
          if (invoiceIl) {
            const result = await fetchTaxOfficesFromAPI(invoiceIl);
            if (result && result.type === 'offices') {
              const officeList = result.data.map((o) => o.office_name || o.name || '').filter(Boolean);
              if (officeList.length > 0) {
                populateTaxOfficeSelect(officeList);
                refreshBtn.disabled = false;
                refreshBtn.textContent = "ğŸ”„ Yenile";
                return;
              }
            }
          }
          
          // Fallback: TÃ¼m listeyi yÃ¼kle
          await buildTaxOfficeSelect();
          refreshBtn.disabled = false;
          refreshBtn.textContent = "ğŸ”„ Yenile";
        });
      }
      
      // Teklifbul Rule v1.0 - Ä°l seÃ§imi deÄŸiÅŸtiÄŸinde vergi dairelerini yeniden yÃ¼kle
      // Debounce ile optimize edildi (300ms bekle, Ã§ok hÄ±zlÄ± deÄŸiÅŸiklikleri Ã¶nle)
      const invoiceIlSelect = document.getElementById('inv_il');
      if (invoiceIlSelect) {
        let taxOfficeLoadTimeout = null;
        invoiceIlSelect.addEventListener('change', async () => {
          const ilValue = invoiceIlSelect.value;
          
          // Ã–nceki timeout'u iptal et
          if (taxOfficeLoadTimeout) {
            clearTimeout(taxOfficeLoadTimeout);
          }
          
          if (!ilValue) {
            // Ä°l seÃ§imi kaldÄ±rÄ±ldÄ±, fallback listeye geÃ§
            await buildTaxOfficeSelect();
            return;
          }
          
          // YÃ¼kleniyor gÃ¶stergesi
          if (taxOfficeSelect) {
            taxOfficeSelect.disabled = true;
            taxOfficeSelect.innerHTML = '<option value="">â³ YÃ¼kleniyor...</option>';
          }
          
          // 300ms bekle (debounce)
          taxOfficeLoadTimeout = setTimeout(async () => {
            try {
              const result = await fetchTaxOfficesFromAPI(ilValue);
              if (result && result.type === 'offices') {
                const officeList = result.data.map((o) => o.office_name || o.name || '').filter(Boolean);
                if (officeList.length > 0) {
                  populateTaxOfficeSelect(officeList);
                  // Ä°l deÄŸiÅŸti, seÃ§imi sÄ±fÄ±rla
                  if (taxOfficeInput) taxOfficeInput.value = '';
                  if (taxOfficeSelect) taxOfficeSelect.value = '';
                } else {
                  // BoÅŸ liste - Firestore fallback
                  await buildTaxOfficeSelect();
                }
              } else {
                // Firestore fallback
                await buildTaxOfficeSelect();
              }
            } catch (e) {
              logger.warn('Vergi dairesi yÃ¼kleme hatasÄ±', e);
              await buildTaxOfficeSelect();
            } finally {
              if (taxOfficeSelect) taxOfficeSelect.disabled = false;
            }
          }, 300);
        });
      }
    }
    
    // Sayfa yÃ¼klendiÄŸinde vergi dairesi listesini yÃ¼kle
    buildTaxOfficeSelect().then(() => {
      setupTaxOfficeSelect();
    });
    
    // === Company Code Generation ===
    // Teklifbul Rule v1.0 - Åirket kodu otomatik oluÅŸturma
    function generateCompanyCode() {
      const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // I, O, Q, 0, 1 hariÃ§
      let code = '';
      for (let i = 0; i < 8; i++) {
        code += alphabet[Math.floor(Math.random() * alphabet.length)];
      }
      return code;
    }
    
    // Generate code on page load if new company mode
    generatedCompanyCode = generateCompanyCode();
    const codeDisplay = document.getElementById('generatedCompanyCode');
    if (codeDisplay) codeDisplay.textContent = generatedCompanyCode;
    
    // === Company Mode Toggle ===
    // Helper function to toggle company mode sections
    function toggleCompanyMode(mode) {
      const joinSection = document.getElementById('joinCompanySection');
      const newSection = document.getElementById('newCompanyCodeSection');
      const newRoleSection = document.getElementById('newCompanyRoleSection');
      
      if (mode === 'join') {
        joinSection.style.display = 'block';
        newSection.style.display = 'none';
        if (newRoleSection) newRoleSection.style.display = 'none';
        // Hide new company required fields (only hide if joining existing company)
        const companyNameGroup = document.getElementById('companyName')?.closest('.form-group');
        const taxNumberGroup = document.getElementById('taxNumber')?.closest('.form-group');
        if (companyNameGroup) companyNameGroup.style.display = 'none';
        if (taxNumberGroup) taxNumberGroup.style.display = 'none';
      } else {
        joinSection.style.display = 'none';
        newSection.style.display = 'block';
        if (newRoleSection) newRoleSection.style.display = 'block';
        const companyNameGroup = document.getElementById('companyName')?.closest('.form-group');
        const taxNumberGroup = document.getElementById('taxNumber')?.closest('.form-group');
        if (companyNameGroup) companyNameGroup.style.display = 'block';
        if (taxNumberGroup) taxNumberGroup.style.display = 'block';
      }
    }
    
    // Set initial state based on checked radio button
    const initialMode = document.querySelector('input[name="companyMode"]:checked')?.value || 'new';
    toggleCompanyMode(initialMode);
    
    // Listen for changes
    document.querySelectorAll('input[name="companyMode"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        toggleCompanyMode(e.target.value);
      });
    });
    
    // === Address System Helper Functions ===
    // Teklifbul Rule v1.0 - Address system integration from settings.html
    const TR_PROVINCES = [
      "Adana","AdÄ±yaman","Afyonkarahisar","AÄŸrÄ±","Amasya","Ankara","Antalya","Artvin","AydÄ±n","BalÄ±kesir","Bilecik","BingÃ¶l","Bitlis","Bolu","Burdur","Bursa","Ã‡anakkale","Ã‡ankÄ±rÄ±","Ã‡orum","Denizli","DiyarbakÄ±r","Edirne","ElazÄ±ÄŸ","Erzincan","Erzurum","EskiÅŸehir","Gaziantep","Giresun","GÃ¼mÃ¼ÅŸhane","Hakkari","Hatay","Isparta","Mersin","Ä°stanbul","Ä°zmir","Kars","Kastamonu","Kayseri","KÄ±rklareli","KÄ±rÅŸehir","Kocaeli","Konya","KÃ¼tahya","Malatya","Manisa","KahramanmaraÅŸ","Mardin","MuÄŸla","MuÅŸ","NevÅŸehir","NiÄŸde","Ordu","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas","TekirdaÄŸ","Tokat","Trabzon","Tunceli","ÅanlÄ±urfa","UÅŸak","Van","Yozgat","Zonguldak","Aksaray","Bayburt","Karaman","KÄ±rÄ±kkale","Batman","ÅÄ±rnak","BartÄ±n","Ardahan","IÄŸdÄ±r","Yalova","KarabÃ¼k","Kilis","Osmaniye","DÃ¼zce"
    ];
    
    async function __fetchJSON(url){
      try {
        const r = await fetch(url, { headers: { 'accept': 'application/json' } });
        if (!r.ok) {
          // 404 hatasÄ± normal bir durum (sokak listesi dosyasÄ± yoksa)
          // Ã–zel hata kodu ile fÄ±rlat, Ã¼st seviyede handle edilecek
          if (r.status === 404) {
            const notFoundError = new Error(`FILE_NOT_FOUND`);
            notFoundError.name = 'FileNotFoundError'; // Konsol loglamayÄ± engellemek iÃ§in
            throw notFoundError;
          }
          throw new Error(`HTTP ${r.status} for ${url}`);
        }
        return await r.json();
      } catch (e) {
        // Network hatalarÄ± veya 404 durumunda Ã¶zel hata kodu
        if (e.name === 'TypeError' && e.message.includes('fetch')) {
          // Network hatasÄ±
          const networkError = new Error(`NETWORK_ERROR`);
          networkError.name = 'NetworkError';
          throw networkError;
        }
        // DiÄŸer hatalarÄ± olduÄŸu gibi fÄ±rlat
        throw e;
      }
    }
    
    function __trNorm(s){ return (s ?? '').toString().trim().toLocaleLowerCase('tr').replace(/\s+/g,' '); }
    
    function __findByNameOrCode(list, val){
      if (val == null) return null;
      if (!isNaN(Number(val))) {
        const code = Number(val);
        return list.find(x => Number(x.id ?? x.code ?? x.plaka_kodu) === code) || null;
      }
      const needle = __trNorm(val);
      return list.find(x => __trNorm(x.name ?? x.il ?? x.text) === needle) || null;
    }
    
    function fillSelectLocal(sel, items, placeholder){
      if (!sel) return;
      sel.innerHTML = '';
      const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent = placeholder; sel.appendChild(opt0);
      (items||[]).sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'tr')).forEach(it=>{
        const o = document.createElement('option');
        o.value = String(it.id ?? it.code ?? it.value ?? it.name ?? '');
        o.textContent = it.name ?? it.label ?? String(it);
        if (it.id ?? it.code) o.dataset.code = String(it.id ?? it.code);
        sel.appendChild(o);
      });
      sel.disabled = (sel.options.length <= 1);
    }
    
    function getSelText(sel){ return sel?.options?.[sel.selectedIndex]?.text || sel?.value || ''; }
    
    async function __loadProvinceDistrictData(){
      const sources = [
        '/public/assets/tr-il-ilce.json',
        './assets/tr-il-ilce.json',
        '/assets/tr-il-ilce.json',
        'https://raw.githubusercontent.com/muhammederdem/il-ilce-json/main/il-ilce.json',
        'https://cdn.jsdelivr.net/gh/muhammederdem/il-ilce-json@main/il-ilce.json'
      ];
      for (const u of sources){
        try { return await __fetchJSON(u); }
        catch(e){ logger.info('Ä°l-ilÃ§e datasÄ± bu kaynaktan okunamadÄ±', { url: u }); }
      }
      // Fallback: TR_PROVINCES as plain list
      return TR_PROVINCES.map(name => ({ il: name, ilceleri: [] }));
    }
    
    function __mapDistricts(p){
      const raw = p?.districts ?? p?.ilceleri ?? [];
      return raw.map(d => ({ id: d.id ?? d.code ?? d.ilce_kodu ?? d, name: d.name ?? d.ilce ?? String(d) }));
    }
    
    function slugTR(s){
      const map = { 'Ä±':'i','Ä°':'i','ÅŸ':'s','Å':'s','ÄŸ':'g','Ä':'g','Ã¼':'u','Ãœ':'u','Ã¶':'o','Ã–':'o','Ã§':'c','Ã‡':'c' };
      s = String(s ?? '').trim();
      s = s.replace(/[Ä±Ä°ÅŸÅÄŸÄÃ¼ÃœÃ¶Ã–Ã§Ã‡]/g, ch => map[ch]);
      s = s.replace(/\s+/g, '_').replace(/[^\w]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g,'');
      return s.toUpperCase();
    }
    
    function districtId(il, ilce){
      return slugTR(il) + '__' + slugTR(ilce);
    }
    
    function cleanIlceValue(val) {
      if (typeof val !== 'string') return val;
      if (val.includes('__')) return val.split('__').pop();
      if (val.includes('_')) return val.split('_').pop();
      return val;
    }
    
    function pickTextOrValue(sel){
      if (!sel) return '';
      if (sel && sel.options && typeof sel.selectedIndex === 'number') {
        return sel.options[sel.selectedIndex]?.text || sel.value || '';
      }
      if (typeof sel === 'string') return sel;
      return String(sel || '');
    }
    
    async function __loadNeighborhoods(selectedIlSel, selectedIlceSel){
      const il   = pickTextOrValue(selectedIlSel);
      let ilce = pickTextOrValue(selectedIlceSel);
      ilce = cleanIlceValue(ilce);
      if (!il || !ilce) return { neighborhoods: [] };
      const dId = districtId(il, ilce);
      const urls = [ `/assets/mahalle/${dId}.json` ];
      for (const u of urls){
        try { return await __fetchJSON(u); } catch { /* sessizce boÅŸ dÃ¶n */ }
      }
      // API fallback (TÃ¼rkiyeAPI)
      try {
        const api = await fetch(`https://api.turkiyeapi.dev/v1/neighborhoods?district=${encodeURIComponent(ilce)}`, { headers: { 'accept':'application/json' } });
        if (api.ok) {
          const { data } = await api.json();
          const neighborhoods = (Array.isArray(data)? data:[]).map(n => ({ id: slugTR(n.name), name: n.name }));
          if (neighborhoods.length) {
            return { districtId: dId, districtName: ilce, neighborhoods };
          }
        }
      } catch {}
      return { neighborhoods: [] };
    }
    
    async function __loadStreets(selectedIlSel, selectedIlceSel, neighborhoodId){
      const il   = pickTextOrValue(selectedIlSel);
      let ilce = pickTextOrValue(selectedIlceSel);
      ilce = cleanIlceValue(ilce);
      if (!il || !ilce || !neighborhoodId) return { streets: [] };
      const dId = districtId(il, ilce);
      const nId = slugTR(neighborhoodId);
      const urls = [ `/assets/sokak/${dId}_mah-${nId}.json` ];
      for (const u of urls){
        try { 
          return await __fetchJSON(u); 
        } catch (e) { 
          // TÃ¼m hatalarÄ± sessizce handle et - konsola hiÃ§bir ÅŸey yazma
          // 404, network veya diÄŸer hatalar iÃ§in sessizce boÅŸ array dÃ¶n
          return { streets: [] };
        }
      }
      return { streets: [] };
    }
    
    // Ana adres kaldÄ±rÄ±ldÄ± - Sadece fatura adresi kullanÄ±lÄ±yor - Teklifbul Rule v1.0
    
    // Invoice Address composition function
    function composeInvoiceAddress(){
      const invoiceTa = document.getElementById('invoiceAddress');
      if (!invoiceTa) return;
      
      const ulke = document.getElementById('inv_ulke')?.value || '';
      const il = getSelText(document.getElementById('inv_il'));
      const ilce = getSelText(document.getElementById('inv_ilce'));
      const mah = getSelText(document.getElementById('inv_mahalle'));
      const cad = document.getElementById('inv_cadde')?.value?.trim() || '';
      const sokSel = document.getElementById('inv_sokak');
      const sokManual = document.getElementById('inv_sokak_manual');
      const sok = (sokSel && sokSel.style.display !== 'none' ? getSelText(sokSel) : '') || (sokManual?.value?.trim() || '');
      const kap = document.getElementById('inv_kapi')?.value?.trim() || '';
      const dai = document.getElementById('inv_daire')?.value?.trim() || '';
      const pk = document.getElementById('inv_postakodu')?.value?.trim() || '';
      
      const parts = [
        mah ? `${mah} Mahalle` : null,
        cad ? `${cad} Cadde` : null,
        sok ? `${sok} Sokak` : null,
        kap ? `KapÄ± No: ${kap}` : null,
        dai ? `Daire: ${dai}` : null,
        ilce ? `Ä°lÃ§e: ${ilce}` : null,
        il ? `Ä°l: ${il}` : null,
        pk ? `Posta Kodu: ${pk}` : null,
        ulke ? `${ulke}` : null,
      ].filter(Boolean);
      
      invoiceTa.value = parts.join(' - ');
    }
    
    // === Bank Accounts Management ===
    // Teklifbul Rule v1.0 - Banka hesaplarÄ± yÃ¶netimi
    function addBankAccountRow(index = bankAccounts.length) {
      const container = document.getElementById('bankAccountsList');
      if (!container) return;
      
      const row = document.createElement('div');
      row.style.cssText = 'display:grid; grid-template-columns: 2fr 3fr 2fr 1fr auto; gap:8px; align-items:end; margin-bottom:12px; padding:12px; background:#f9fafb; border-radius:6px;';
      row.innerHTML = `
        <div>
          <label style="font-size:12px; font-weight:600; display:block; margin-bottom:4px;">Banka AdÄ±</label>
          <input type="text" class="bank-name" placeholder="Banka adÄ±" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px; font-size:13px;" />
        </div>
        <div>
          <label style="font-size:12px; font-weight:600; display:block; margin-bottom:4px;">IBAN</label>
          <input type="text" class="bank-iban" placeholder="TR00 0000 0000 0000 0000 0000 00" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px; font-size:13px; font-family:monospace;" maxlength="34" />
        </div>
        <div>
          <label style="font-size:12px; font-weight:600; display:block; margin-bottom:4px;">Hesap AdÄ±</label>
          <input type="text" class="bank-account-name" placeholder="Hesap sahibi adÄ±" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px; font-size:13px;" value="${document.getElementById('companyName')?.value || ''}" />
        </div>
        <div>
          <label style="font-size:12px; font-weight:600; display:block; margin-bottom:4px;">Para Birimi</label>
          <select class="bank-currency" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px; font-size:13px;">
            <option value="TRY">TRY</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
          </select>
        </div>
        <div>
          <button type="button" class="remove-bank" style="padding:8px 12px; background:#ef4444; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;">âœ•</button>
        </div>
      `;
      
      row.querySelector('.remove-bank').addEventListener('click', () => {
        row.remove();
        bankAccounts = bankAccounts.filter((_, i) => i !== index);
      });
      
      container.appendChild(row);
      bankAccounts.push({ index, row });
    }
    
    document.getElementById('addBankAccountBtn')?.addEventListener('click', () => {
      addBankAccountRow();
      // Yeni eklenen hesap adÄ± alanÄ±na ÅŸirket adÄ±nÄ± otomatik doldur - Teklifbul Rule v1.0
      const companyName = document.getElementById('companyName')?.value?.trim();
      if (companyName) {
        const lastRow = bankAccounts[bankAccounts.length - 1];
        if (lastRow && lastRow.row) {
          const accountNameInput = lastRow.row.querySelector('.bank-account-name');
          if (accountNameInput && !accountNameInput.value) {
            accountNameInput.value = companyName;
          }
        }
      }
    });
    
    // Åirket adÄ± deÄŸiÅŸtiÄŸinde mevcut banka hesap adÄ± alanlarÄ±nÄ± gÃ¼ncelle (isteÄŸe baÄŸlÄ±)
    document.getElementById('companyName')?.addEventListener('input', (e) => {
      const companyName = e.target.value.trim();
      if (companyName) {
        document.querySelectorAll('.bank-account-name').forEach(input => {
          if (!input.value) {
            input.value = companyName;
          }
        });
      }
    });
    
    // Elements
    const buyerBtn = document.getElementById("buyerBtn");
    const supplierBtn = document.getElementById("supplierBtn");
    const formSection = document.getElementById("formSection");
    const categoriesSection = document.getElementById("categoriesSection");
    const buyerCategoriesSection = document.getElementById("buyerCategoriesSection");
    const supplierCategoriesSection = document.getElementById("supplierCategoriesSection");
    const emailRequired = document.getElementById("emailRequired");
    const saveBtn = document.getElementById("saveBtn");
    const taxCertFile = document.getElementById("taxCertFile");
    const fileName = document.getElementById("fileName");
    
    // Chip systems
    const emailChips = new Set();
    const phoneChips = new Set();
    const buyerCatChips = new Set();
    const supplierCatChips = new Set();
    
    // Helper: Convert string to slug format
    function toSlug(name) {
      return name.toLowerCase().trim().replace(/\s+/g, '-');
    }
    
    // Populate category datalists with new ID-based system
    const buyerDataList = document.getElementById("buyerCategoryList");
    const supplierDataList = document.getElementById("supplierCategoryList");
    const allCategories = getAllCategories();
    allCategories.forEach(cat => {
      const categoryName = cat.name; // Display name
      
      const buyerOption = document.createElement("option"); 
      buyerOption.value = categoryName; 
      buyerOption.dataset.categoryId = cat.id; // Store ID for later
      buyerDataList.appendChild(buyerOption);
      
      const supplierOption = document.createElement("option"); 
      supplierOption.value = categoryName; 
      supplierOption.dataset.categoryId = cat.id; // Store ID for later
      supplierDataList.appendChild(supplierOption);
    });
    
    // Multi-role selection system - Teklifbul Rule v1.0
    let selectedRoles = new Set(); // Array yerine Set kullanÄ±yoruz
    
    buyerBtn.onclick = () => {
      if (selectedRoles.has("buyer")) {
        selectedRoles.delete("buyer");
        buyerBtn.classList.remove("selected");
        document.getElementById("buyerCheck").style.display = "none";
        buyerCategoriesSection.style.display = "none";
      } else {
        selectedRoles.add("buyer");
        buyerBtn.classList.add("selected");
        document.getElementById("buyerCheck").style.display = "inline";
        buyerCategoriesSection.style.display = "block";
      }
      
      // Form'u gÃ¶ster
      if (selectedRoles.size > 0) {
        formSection.classList.add("visible");
        categoriesSection.style.display = "block";
        if (selectedRoles.has("buyer")) {
          buyerCategoriesSection.style.display = "block";
        }
        if (selectedRoles.has("supplier")) {
          supplierCategoriesSection.style.display = "block";
          emailRequired.style.display = "inline";
        } else {
          emailRequired.style.display = "none";
        }
        updateRoleSelectionUI();
      } else {
        formSection.classList.remove("visible");
      }
    };
    
    supplierBtn.onclick = () => {
      if (selectedRoles.has("supplier")) {
        selectedRoles.delete("supplier");
        supplierBtn.classList.remove("selected");
        document.getElementById("supplierCheck").style.display = "none";
        supplierCategoriesSection.style.display = "none";
        emailRequired.style.display = "none";
      } else {
        selectedRoles.add("supplier");
        supplierBtn.classList.add("selected");
        document.getElementById("supplierCheck").style.display = "inline";
        supplierCategoriesSection.style.display = "block";
        emailRequired.style.display = "inline";
      }
      
      // Form'u gÃ¶ster
      if (selectedRoles.size > 0) {
        formSection.classList.add("visible");
        categoriesSection.style.display = "block";
        if (selectedRoles.has("buyer")) {
          buyerCategoriesSection.style.display = "block";
        }
        if (selectedRoles.has("supplier")) {
          supplierCategoriesSection.style.display = "block";
        }
        updateRoleSelectionUI();
      } else {
        formSection.classList.remove("visible");
      }
    };
    
    // Update role selection UI based on selected roles
    function updateRoleSelectionUI() {
      const buyerRoleSection = document.getElementById("newCompanyBuyerRoleSection");
      const supplierRoleSection = document.getElementById("newCompanySupplierRoleSection");
      const newCompanyRoleSection = document.getElementById("newCompanyRoleSection");
      
      if (buyerRoleSection) {
        buyerRoleSection.style.display = selectedRoles.has("buyer") ? "block" : "none";
      }
      if (supplierRoleSection) {
        supplierRoleSection.style.display = selectedRoles.has("supplier") ? "block" : "none";
      }
      if (newCompanyRoleSection && selectedRoles.size > 0) {
        // Company mode toggle iÃ§inde gÃ¶sterilmesi iÃ§in parent'a bak
        const companyMode = document.querySelector('input[name="companyMode"]:checked')?.value || 'new';
        if (companyMode === 'new') {
          newCompanyRoleSection.style.display = 'block';
        }
      }
    }
    
    // Email chip input
    const emailInput = document.getElementById("emailInput");
    const emailChipInput = document.getElementById("emailChipInput");
    let primaryEmail = null; // KayÄ±t olurken kullanÄ±lan email (silinemez) - Teklifbul Rule v1.0
    
    function renderEmailChips() {
      const existing = emailChipInput.querySelectorAll(".badge");
      existing.forEach(el => el.remove());
      
      [...emailChips].forEach(v => {
        const span = document.createElement("span");
        span.className = "badge";
        // KayÄ±t email'i ise silinemez iÅŸareti
        if (primaryEmail && v.toLowerCase() === primaryEmail.toLowerCase()) {
          span.textContent = v + " (KayÄ±t email'i)";
          span.style.cursor = 'not-allowed';
          span.style.opacity = '0.8';
          span.title = 'Bu email kayÄ±t olurken kullanÄ±lan email\'dir ve silinemez';
        } else {
          span.textContent = v + " âœ•";
          span.onclick = () => { 
            // Primary email silinemez
            if (!primaryEmail || v.toLowerCase() !== primaryEmail.toLowerCase()) {
              emailChips.delete(v); 
              renderEmailChips(); 
            }
          };
        }
        emailChipInput.insertBefore(span, emailInput);
      });
    }
    
    emailInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        const v = e.target.value.trim();
        if (v && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)) {
          emailChips.add(v);
          renderEmailChips();
          e.target.value = "";
        } else if (v) {
          toast.error(MESSAGES.ERROR_EMAIL_INVALID);
        }
      }
    });
    
    // Phone chip input
    const phoneInput = document.getElementById("phoneInput");
    const phoneChipInput = document.getElementById("phoneChipInput");
    
    function renderPhoneChips() {
      const existing = phoneChipInput.querySelectorAll(".badge");
      existing.forEach(el => el.remove());
      
      [...phoneChips].forEach(v => {
        const span = document.createElement("span");
        span.className = "badge";
        span.textContent = v + " âœ•";
        span.onclick = () => { phoneChips.delete(v); renderPhoneChips(); };
        phoneChipInput.insertBefore(span, phoneInput);
      });
    }
    
    phoneInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        const v = e.target.value.trim();
        if (v) {
          phoneChips.add(v);
          renderPhoneChips();
          e.target.value = "";
        }
      }
    });
    
    // Buyer Category chip input
    const buyerCategoryInput = document.getElementById("buyerCategoryInput");
    const buyerCategoryChipInput = document.getElementById("buyerCategoryChipInput");
    
    function renderBuyerCatChips() {
      const existing = buyerCategoryChipInput.querySelectorAll(".badge");
      existing.forEach(el => el.remove());
      
      [...buyerCatChips].forEach(v => {
        const span = document.createElement("span");
        span.className = "badge";
        span.textContent = v + " âœ•";
        span.onclick = () => { buyerCatChips.delete(v); renderBuyerCatChips(); };
        buyerCategoryChipInput.insertBefore(span, buyerCategoryInput);
      });
    }
    
    buyerCategoryInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        const v = e.target.value.trim();
        if (v) {
          buyerCatChips.add(v);
          renderBuyerCatChips();
          e.target.value = "";
        }
      }
    });
    
    // Supplier Category chip input
    const supplierCategoryInput = document.getElementById("supplierCategoryInput");
    const supplierCategoryChipInput = document.getElementById("supplierCategoryChipInput");
    
    function renderSupplierCatChips() {
      const existing = supplierCategoryChipInput.querySelectorAll(".badge");
      existing.forEach(el => el.remove());
      
      [...supplierCatChips].forEach(v => {
        const span = document.createElement("span");
        span.className = "badge";
        span.textContent = v + " âœ•";
        span.onclick = () => { supplierCatChips.delete(v); renderSupplierCatChips(); };
        supplierCategoryChipInput.insertBefore(span, supplierCategoryInput);
      });
    }
    
    supplierCategoryInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        const v = e.target.value.trim();
        if (v) {
          supplierCatChips.add(v);
          renderSupplierCatChips();
          e.target.value = "";
        }
      }
    });
    
    // Bulk selection buttons
    document.getElementById("selectAllBuyer").onclick = () => {
      const allCategories = getAllCategories();
      allCategories.forEach(cat => buyerCatChips.add(cat.name)); // Store display names
      renderBuyerCatChips();
    };
    
    document.getElementById("clearAllBuyer").onclick = () => {
      buyerCatChips.clear();
      renderBuyerCatChips();
    };
    
    document.getElementById("selectAllSupplier").onclick = () => {
      const allCategories = getAllCategories();
      allCategories.forEach(cat => supplierCatChips.add(cat.name)); // Store display names
      renderSupplierCatChips();
    };
    
    document.getElementById("clearAllSupplier").onclick = () => {
      supplierCatChips.clear();
      renderSupplierCatChips();
    };
    
    // File upload trigger
    document.getElementById("fileUploadTrigger").addEventListener("click", () => {
      document.getElementById("taxCertFile").click();
    });
    
    // File upload
    taxCertFile.addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        if (file.size > 10 * 1024 * 1024) {
          toast.error(MESSAGES.ERROR_FILE_SIZE_10MB);
          e.target.value = "";
          return;
        }
        fileName.textContent = `âœ… SeÃ§ili: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
      }
    });
    
    // === Initialize Address System ===
    // Teklifbul Rule v1.0 - Address system initialization
    (async function initAddressSystem(){
      const ulkeSel = document.getElementById('addr_ulke');
      const ilSel = document.getElementById('addr_il');
      const ilceSel = document.getElementById('addr_ilce');
      const mahSel = document.getElementById('addr_mahalle');
      const sokSel = document.getElementById('addr_sokak');
      const sokManual = document.getElementById('addr_sokak_manual');
      const caddeInp = document.getElementById('addr_cadde');
      const kapiInp = document.getElementById('addr_kapi');
      const daireInp = document.getElementById('addr_daire');
      const postaInp = document.getElementById('addr_postakodu');
      
      if (!ilSel || !ilceSel) return;
      
      try {
        const raw = await __loadProvinceDistrictData();
        const provinces = (Array.isArray(raw)? raw : raw?.data || []).map(p=>({ id: p.id ?? p.code ?? p.plaka_kodu ?? p.il, name: p.name ?? p.il ?? String(p), raw:p }))
          .sort((a,b)=> a.name.localeCompare(b.name,'tr'));
        fillSelectLocal(ilSel, provinces, 'Ä°l seÃ§iniz');
        
        // Ä°l deÄŸiÅŸtiÄŸinde ilÃ§eleri yÃ¼kle
        ilSel?.addEventListener('change', async ()=>{
          const chosen = __findByNameOrCode(provinces, ilSel.value);
          if (!chosen || !chosen.raw) {
            fillSelectLocal(ilceSel, [], 'Ä°lÃ§e seÃ§iniz');
            ilceSel.disabled = true;
            fillSelectLocal(mahSel, [], 'Mahalle seÃ§iniz'); 
            mahSel.disabled = true;
            fillSelectLocal(sokSel, [], 'Sokak/Cadde seÃ§iniz'); 
            sokSel.disabled = true;
            if (sokManual) {
              sokManual.style.display = 'none';
              sokManual.value = '';
            }
            composeAddress();
            return;
          }
          
          const dlist = __mapDistricts(chosen.raw);
          fillSelectLocal(ilceSel, dlist, 'Ä°lÃ§e seÃ§iniz');
          ilceSel.disabled = dlist.length === 0;
          
          // Ä°l deÄŸiÅŸtiÄŸinde mahalle ve sokaklarÄ± temizle
          fillSelectLocal(mahSel, [], 'Mahalle seÃ§iniz'); 
          mahSel.disabled = true;
          fillSelectLocal(sokSel, [], 'Sokak/Cadde seÃ§iniz'); 
          sokSel.disabled = true;
          if (sokManual) {
            sokManual.style.display = 'none';
            sokManual.value = '';
          }
          
          composeAddress();
        });
        
        ilceSel?.addEventListener('change', async ()=>{
          composeAddress();
          const districtId = ilceSel.value;
          const districtName = getSelText(ilceSel);
          
          if (!districtId || !ilSel.value){ 
            fillSelectLocal(mahSel, [], 'Mahalle seÃ§iniz'); 
            mahSel.disabled = true; 
            fillSelectLocal(sokSel, [], 'Sokak/Cadde seÃ§iniz'); 
            sokSel.disabled = true;
            if (sokManual) {
              sokManual.style.display = 'none';
              sokManual.value = '';
            }
            return; 
          }
          
          mahSel.disabled = true; 
          mahSel.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
          
          try {
            const data = await __loadNeighborhoods(ilSel.value, ilceSel.value);
            const neighborhoods = (data?.neighborhoods||[]).map(n=>({id:n.id ?? n.code ?? n.name, name:n.name}));
            fillSelectLocal(mahSel, neighborhoods, 'Mahalle seÃ§iniz');
            mahSel.disabled = neighborhoods.length === 0;
            
            // Sokak dropdown'unu temizle
            fillSelectLocal(sokSel, [], 'Sokak/Cadde seÃ§iniz'); 
            sokSel.disabled = true;
            if (sokSel) sokSel.style.display = '';
            if (sokManual) {
              sokManual.style.display = 'none';
              sokManual.value = '';
            }
            
            composeAddress();
          } catch (err) { 
            logger.error('Mahalle yÃ¼kleme hatasÄ±', err);
            fillSelectLocal(mahSel, [], 'Mahalleler yok'); 
            mahSel.disabled = true;
          }
        });
        
        mahSel?.addEventListener('change', async ()=>{
          composeAddress();
          const districtId = ilceSel.value; const neighborhoodId = mahSel.value;
          const districtName = getSelText(ilceSel); const neighborhoodName = getSelText(mahSel);
          fillSelectLocal(sokSel, [], 'Sokak/Cadde seÃ§iniz'); 
          if(!districtId||!neighborhoodId){ 
            sokSel.disabled=true; 
            return; 
          }
          sokSel.disabled = true; 
          sokSel.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
          try {
            const data = await __loadStreets(ilSel.value, ilceSel.value, neighborhoodId);
            const streets = (data?.streets||[]).map(s=>({id:s.id ?? s.code ?? s.name, name:s.name}));
            fillSelectLocal(sokSel, streets, 'Sokak/Cadde seÃ§iniz');
            if (streets.length > 0){ 
              sokSel.style.display=''; 
              if (sokManual){ 
                sokManual.style.display='none'; 
                sokManual.value=''; 
              } 
            }
            else { 
              sokSel.style.display='none'; 
              if (sokManual){ 
                sokManual.style.display=''; 
              } 
            }
            sokSel.disabled = streets.length === 0;
            composeAddress();
          } catch { 
            fillSelectLocal(sokSel, [], 'Sokaklar yok'); 
            sokSel.disabled = true;
            if (sokManual) {
              sokManual.style.display = '';
            }
          }
        });
        
        // TÃ¼m adres alanlarÄ±nda deÄŸiÅŸiklik olduÄŸunda adresi birleÅŸtir
        [ulkeSel, ilSel, ilceSel, mahSel, sokSel, sokManual, caddeInp, kapiInp, daireInp, postaInp].forEach(el=>{
          el?.addEventListener('input', composeAddress);
          el?.addEventListener('change', composeAddress);
        });
        
        composeAddress();
      } catch (err) {
        logger.warn('Adres sistemi baÅŸlatÄ±lamadÄ±', err);
      }
    })();
    
    // === Initialize Invoice Address System ===
    // Teklifbul Rule v1.0 - Fatura adresi sistemi baÅŸlatma
    (async function initInvoiceAddressSystem(){
      const invUlkeSel = document.getElementById('inv_ulke');
      const invIlSel = document.getElementById('inv_il');
      const invIlceSel = document.getElementById('inv_ilce');
      const invMahSel = document.getElementById('inv_mahalle');
      const invSokSel = document.getElementById('inv_sokak');
      const invSokManual = document.getElementById('inv_sokak_manual');
      const invCaddeInp = document.getElementById('inv_cadde');
      const invKapiInp = document.getElementById('inv_kapi');
      const invDaireInp = document.getElementById('inv_daire');
      const invPostaInp = document.getElementById('inv_postakodu');
      
      if (!invIlSel || !invIlceSel) return;
      
      try {
        const raw = await __loadProvinceDistrictData();
        const provinces = (Array.isArray(raw)? raw : raw?.data || []).map(p=>({ id: p.id ?? p.code ?? p.plaka_kodu ?? p.il, name: p.name ?? p.il ?? String(p), raw:p }))
          .sort((a,b)=> a.name.localeCompare(b.name,'tr'));
        fillSelectLocal(invIlSel, provinces, 'Ä°l seÃ§iniz');
        
        // Ä°l deÄŸiÅŸtiÄŸinde ilÃ§eleri yÃ¼kle
        invIlSel?.addEventListener('change', async ()=>{
          const chosen = __findByNameOrCode(provinces, invIlSel.value);
          if (!chosen || !chosen.raw) {
            fillSelectLocal(invIlceSel, [], 'Ä°lÃ§e seÃ§iniz');
            invIlceSel.disabled = true;
            fillSelectLocal(invMahSel, [], 'Mahalle seÃ§iniz'); 
            invMahSel.disabled = true;
            fillSelectLocal(invSokSel, [], 'Sokak/Cadde seÃ§iniz'); 
            invSokSel.disabled = true;
            if (invSokManual) {
              invSokManual.style.display = 'none';
              invSokManual.value = '';
            }
            composeInvoiceAddress();
            return;
          }
          
          const dlist = __mapDistricts(chosen.raw);
          fillSelectLocal(invIlceSel, dlist, 'Ä°lÃ§e seÃ§iniz');
          invIlceSel.disabled = dlist.length === 0;
          
          fillSelectLocal(invMahSel, [], 'Mahalle seÃ§iniz'); 
          invMahSel.disabled = true;
          fillSelectLocal(invSokSel, [], 'Sokak/Cadde seÃ§iniz'); 
          invSokSel.disabled = true;
          if (invSokManual) {
            invSokManual.style.display = 'none';
            invSokManual.value = '';
          }
          
          composeInvoiceAddress();
        });
        
        invIlceSel?.addEventListener('change', async ()=>{
          composeInvoiceAddress();
          const districtId = invIlceSel.value;
          
          if (!districtId || !invIlSel.value){ 
            fillSelectLocal(invMahSel, [], 'Mahalle seÃ§iniz'); 
            invMahSel.disabled = true; 
            fillSelectLocal(invSokSel, [], 'Sokak/Cadde seÃ§iniz'); 
            invSokSel.disabled = true;
            if (invSokManual) {
              invSokManual.style.display = 'none';
              invSokManual.value = '';
            }
            return; 
          }
          
          invMahSel.disabled = true; 
          invMahSel.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
          
          try {
            const data = await __loadNeighborhoods(invIlSel.value, invIlceSel.value);
            const neighborhoods = (data?.neighborhoods||[]).map(n=>({id:n.id ?? n.code ?? n.name, name:n.name}));
            fillSelectLocal(invMahSel, neighborhoods, 'Mahalle seÃ§iniz');
            invMahSel.disabled = neighborhoods.length === 0;
            
            fillSelectLocal(invSokSel, [], 'Sokak/Cadde seÃ§iniz'); 
            invSokSel.disabled = true;
            if (invSokSel) invSokSel.style.display = '';
            if (invSokManual) {
              invSokManual.style.display = 'none';
              invSokManual.value = '';
            }
            
            composeInvoiceAddress();
          } catch (err) { 
            logger.error('Mahalle yÃ¼kleme hatasÄ±', err);
            fillSelectLocal(invMahSel, [], 'Mahalleler yok'); 
            invMahSel.disabled = true;
          }
        });
        
        invMahSel?.addEventListener('change', async ()=>{
          composeInvoiceAddress();
          const provinceName = invIlSel.options[invIlSel.selectedIndex]?.text || '';
          const districtName = invIlceSel.options[invIlceSel.selectedIndex]?.text || '';
          const districtId = invIlceSel.value; 
          const neighborhoodId = invMahSel.value;
          const neighborhoodName = invMahSel.options[invMahSel.selectedIndex]?.text || '';
          
          fillSelectLocal(invSokSel, [], 'Sokak/Cadde seÃ§iniz'); 
          if(!districtName || !neighborhoodName){ 
            invSokSel.disabled=true; 
            if (invSokManual) invSokManual.style.display='none';
            return; 
          }
          
          invSokSel.disabled = true; 
          invSokSel.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
          invSokSel.style.display = '';
          if (invSokManual) {
            invSokManual.style.display = 'none';
            invSokManual.value = '';
            invSokManual.required = false;
          }
          
          try {
            // ID tabanlÄ± sokak yÃ¼kleme - Teklifbul Rule v1.0
            const { loadStreets } = await import('/assets/js/address-service.js');
            const streets = await loadStreets({
              provinceName,
              districtName,
              neighborhoodName,
              neighborhoodIdFromState: neighborhoodId ? Number(neighborhoodId) : undefined,
              districtIdFromState: districtId ? Number(districtId) : undefined
            });
            
            if (streets.length > 0){ 
              fillSelectLocal(invSokSel, streets, 'Sokak/Cadde seÃ§iniz');
              invSokSel.style.display=''; 
              invSokSel.disabled = false;
              if (invSokManual){ 
                invSokManual.style.display='none'; 
                invSokManual.value=''; 
                invSokManual.required = false;
              } 
            }
            else { 
              // Free-text fallback - Teklifbul Rule v1.0
              logger.info('[addr] streets empty â†’ free-text', { provinceName, districtName, neighborhoodName });
              invSokSel.style.display='none'; 
              invSokSel.disabled = true;
              if (invSokManual){ 
                invSokManual.style.display=''; 
                invSokManual.required = true;
                invSokManual.placeholder = 'Sokak (elle yazÄ±n)';
              } 
            }
            composeInvoiceAddress();
          } catch { 
            fillSelectLocal(invSokSel, [], 'Sokaklar yok'); 
            invSokSel.disabled = true;
            if (invSokManual) {
              invSokManual.style.display = '';
            }
          }
        });
        
        // TÃ¼m fatura adres alanlarÄ±nda deÄŸiÅŸiklik olduÄŸunda adresi birleÅŸtir
        [invUlkeSel, invIlSel, invIlceSel, invMahSel, invSokSel, invSokManual, invCaddeInp, invKapiInp, invDaireInp, invPostaInp].forEach(el=>{
          el?.addEventListener('input', composeInvoiceAddress);
          el?.addEventListener('change', composeInvoiceAddress);
        });
        
        composeInvoiceAddress();
      } catch (err) {
        logger.warn('Fatura adresi sistemi baÅŸlatÄ±lamadÄ±', err);
      }
    })();
    
    // Save profile
    saveBtn.onclick = async () => {
      // Teklifbul Rule v1.0 - Multi-role sistemi kontrolÃ¼
      if (selectedRoles.size === 0) {
        toast.error(MESSAGES.ERROR_ROLE_REQUIRED);
        return;
      }
      
      // Teklifbul Rule v1.0 - Åirket kurulum modu kontrolÃ¼
      const companyMode = document.querySelector('input[name="companyMode"]:checked')?.value || 'new';
      const companyCodeInput = document.getElementById('companyCode')?.value.trim().toUpperCase();
      const joinRoleSelect = document.getElementById('joinRoleSelect')?.value;
      
      // Mevcut ÅŸirkete katÄ±lma durumu kontrolÃ¼
      if (companyMode === 'join') {
        if (!companyCodeInput || !joinRoleSelect) {
          toast.error(MESSAGES.ERROR_COMPANY_CODE_ROLE_REQUIRED);
          return;
        }
      }
      
      const companyName = document.getElementById("companyName").value.trim();
      const taxNumber = document.getElementById("taxNumber").value.trim();
      const taxNumberTrimmed = taxNumber.trim(); // Teklifbul Rule v1.0 - Vergi numarasÄ± trim edilmiÅŸ hali
      const mersisNo = document.getElementById("mersisNo").value.trim();
      // Ana adres kaldÄ±rÄ±ldÄ± - Sadece fatura adresi kullanÄ±lÄ±yor - Teklifbul Rule v1.0
      const website = document.getElementById("website").value.trim();
      const kvkkConsent = document.getElementById("kvkkConsent").checked;
      const marketingConsent = document.getElementById("marketingConsent").checked;
      
      // Get additional contact info - Teklifbul Rule v1.0
      const companyPhone = document.getElementById("companyPhone")?.value.trim() || null;
      const mobilePhone = document.getElementById("mobilePhone")?.value.trim() || null;
      const whatsappPhone = document.getElementById("whatsappPhone")?.value.trim() || null;
      
      // Get invoice address - Teklifbul Rule v1.0
      const invoiceAddress = document.getElementById("invoiceAddress")?.value.trim() || '';
      const taxOffice = document.getElementById("taxOffice")?.value.trim() || null;
      
      // Get structured invoice address parts - Teklifbul Rule v1.0
      const invUlke = document.getElementById("inv_ulke")?.value?.trim() || 'TÃ¼rkiye';
      const invIl = getSelText(document.getElementById("inv_il")) || null;
      const invIlce = getSelText(document.getElementById("inv_ilce")) || null;
      const invMahalle = getSelText(document.getElementById("inv_mahalle")) || null;
      const invCadde = document.getElementById("inv_cadde")?.value?.trim() || null;
      const invSokakSel = document.getElementById("inv_sokak");
      const invSokakManual = document.getElementById("inv_sokak_manual");
      const invSokak = (invSokakSel && invSokakSel.style.display !== 'none' ? getSelText(invSokakSel) : '') || (invSokakManual?.value?.trim() || null);
      const invKapi = document.getElementById("inv_kapi")?.value?.trim() || null;
      const invDaire = document.getElementById("inv_daire")?.value?.trim() || null;
      const invPostaKodu = document.getElementById("inv_postakodu")?.value?.trim() || null;
      
      const invoiceAddressParts = {
        ulke: invUlke || 'TÃ¼rkiye',
        il: invIl,
        ilce: invIlce,
        mahalle: invMahalle,
        cadde: invCadde,
        sokak: invSokak,
        kapi: invKapi,
        daire: invDaire,
        postaKodu: invPostaKodu
      };
      
      // Get bank accounts - Teklifbul Rule v1.0
      const bankAccountsData = [];
      document.querySelectorAll('#bankAccountsList > div').forEach(row => {
        const bankName = row.querySelector('.bank-name')?.value.trim();
        const iban = row.querySelector('.bank-iban')?.value.trim().replace(/\s/g, '');
        const accountName = row.querySelector('.bank-account-name')?.value.trim();
        const currency = row.querySelector('.bank-currency')?.value || 'TRY';
        
        if (bankName && iban && accountName) {
          bankAccountsData.push({
            bankName,
            iban: iban.toUpperCase(),
            accountName,
            currency
          });
        }
      });
      
      // Ana adres kaldÄ±rÄ±ldÄ± - Sadece fatura adresi kullanÄ±lÄ±yor - Teklifbul Rule v1.0
      
      // Validation - Teklifbul Rule v1.0
      if (selectedRoles.size === 0) {
        toast.error(MESSAGES.ERROR_ROLE_SELECT_REQUIRED);
        return;
      }
      
      if (companyMode === 'new') {
        if (!companyName || !taxNumber) {
          toast.error(MESSAGES.ERROR_COMPANY_NAME_TAX_REQUIRED);
          return;
        }
        
        // Yeni ÅŸirket oluÅŸtururken seÃ§ilen her rol iÃ§in rol seÃ§imi zorunlu
        if (selectedRoles.has("buyer")) {
          const buyerRoleSelect = document.getElementById('newCompanyBuyerRoleSelect');
          const selectedBuyerRole = buyerRoleSelect?.value || '';
          if (!selectedBuyerRole) {
            toast.error(MESSAGES.ERROR_BUYER_ROLE_REQUIRED);
            return;
          }
        }
        
        if (selectedRoles.has("supplier")) {
          const supplierRoleSelect = document.getElementById('newCompanySupplierRoleSelect');
          const selectedSupplierRole = supplierRoleSelect?.value || '';
          if (!selectedSupplierRole) {
            toast.error(MESSAGES.ERROR_SUPPLIER_ROLE_REQUIRED);
            return;
          }
        }
      }
      
      if (companyMode === 'join') {
        const joinRoleSelect = document.getElementById('joinRoleSelect');
        const selectedJoinRole = joinRoleSelect?.value || '';
        if (!selectedJoinRole) {
          toast.error(MESSAGES.ERROR_COMPANY_ROLE_REQUIRED);
          return;
        }
      }
      
      // Fatura adresi zorunlu (adres kÄ±smÄ±nda sadece fatura adresi yeterli)
      if (!invoiceAddress || invoiceAddress.trim() === '') {
        toast.error(MESSAGES.ERROR_INVOICE_ADDRESS_REQUIRED);
        return;
      }
      
      if (selectedRoles.has("supplier")) {
        if (supplierCatChips.size === 0) {
          toast.error(MESSAGES.ERROR_SUPPLIER_CATEGORY_REQUIRED);
          return;
        }
        if (emailChips.size === 0) {
          toast.error(MESSAGES.ERROR_SUPPLIER_EMAIL_REQUIRED);
          return;
        }
      }
      
      if (selectedRoles.has("buyer")) {
        if (buyerCatChips.size === 0) {
          toast.error(MESSAGES.ERROR_BUYER_CATEGORY_REQUIRED);
          return;
        }
      }
      
      if (!kvkkConsent) {
        toast.error(MESSAGES.ERROR_KVKK_CONSENT_REQUIRED);
        return;
      }
      
      try {
        saveBtn.disabled = true;
        saveBtn.textContent = "Kontrol ediliyor...";
        
        const user = auth.currentUser;
        if (!user) {
          toast.error(MESSAGES.ERROR_SESSION);
          location.href = "./index.html";
          return;
        }
        
        // Teklifbul Rule v1.0 - Vergi numarasÄ± benzersizlik kontrolÃ¼
        // Åirket ID'si vergi numarasÄ±na gÃ¶re oluÅŸturulacak: tax-{taxNumber}
        // taxNumberTrimmed zaten yukarida tanimlandi
        const proposedCompanyId = `tax-${taxNumberTrimmed}`;
        
        // Åirket ID'sinin (vergi numarasÄ±) zaten kullanÄ±lÄ±p kullanÄ±lmadÄ±ÄŸÄ±nÄ± kontrol et
        // Bu kontrol hem ID hem de taxNumber field'Ä±nÄ± kontrol eder
        const existingCompanyById = await getDoc(doc(db, "companies", proposedCompanyId));
        
        if (existingCompanyById.exists()) {
          // Vergi numarasÄ± zaten ID olarak kullanÄ±lÄ±yor
          const existingCompanyData = existingCompanyById.data();
          const existingCompanyName = existingCompanyData.name || "Bilinmeyen Åirket";
          saveBtn.disabled = false;
          saveBtn.textContent = "Kaydet ve Devam Et";
          toast.error(MESSAGES.ERROR_TAXNUMBER_IN_USE + ': ' + taxNumberTrimmed + (existingCompanyName ? ' - ' + existingCompanyName : ''));
          return;
        }
        
        // Ek gÃ¼venlik: taxNumber field'Ä±nda da kontrol et (geriye dÃ¶nÃ¼k uyumluluk iÃ§in)
        const taxNumberQuery = query(
          collection(db, "companies"),
          where("taxNumber", "==", taxNumberTrimmed)
        );
        const taxNumberSnapshot = await getDocs(taxNumberQuery);
        
        if (!taxNumberSnapshot.empty) {
          // Vergi numarasÄ± baÅŸka bir ÅŸirkette kullanÄ±lÄ±yor (eski sistem)
          const existingCompany = taxNumberSnapshot.docs[0].data();
          const existingCompanyName = existingCompany.name || "Bilinmeyen Åirket";
          saveBtn.disabled = false;
          saveBtn.textContent = "Kaydet ve Devam Et";
          toast.error(MESSAGES.ERROR_TAXNUMBER_IN_USE + ': ' + taxNumberTrimmed + (existingCompanyName ? ' - ' + existingCompanyName : ''));
          return;
        }
        
        // Teklifbul Rule v1.0 - E-posta benzersizlik kontrolÃ¼
        // Bir e-posta adresi sadece bir ÅŸirkete ait olabilir
        // NOT: Kendi email'imizi kontrol etme (yeni ÅŸirket oluÅŸturuyoruz)
        const emailArray = [...emailChips].map(e => e.trim().toLowerCase());
        if (emailArray.length > 0) {
          for (const email of emailArray) {
            if (!email) continue;
            
            // Kendi email'imizi kontrol etme (primaryEmail kendimiziz)
            if (primaryEmail && email.toLowerCase() === primaryEmail.toLowerCase()) {
              continue; // Kendi email'imizi kontrol etme
            }
            
            const emailQuery = query(
              collection(db, "users"),
              where("contactEmails", "array-contains", email)
            );
            const emailSnapshot = await getDocs(emailQuery);
            
            if (!emailSnapshot.empty) {
              // E-posta zaten baÅŸka bir ÅŸirkette kullanÄ±lÄ±yor
              const existingUser = emailSnapshot.docs[0];
              const existingUserData = existingUser.data();
              const existingCompanyName = existingUserData.companyName || "Bilinmeyen Åirket";
              // Kendi kendimizi kontrol etme
              if (existingUser.id !== user.uid) {
                saveBtn.disabled = false;
                saveBtn.textContent = "Kaydet ve Devam Et";
                toast.error(MESSAGES.ERROR_EMAIL_IN_USE + ': ' + email + (existingCompanyName ? ' - ' + existingCompanyName : ''));
                return;
              }
            }
          }
        }
        
        // Teklifbul Rule v1.0 - Telefon numarasÄ± benzersizlik kontrolÃ¼
        // Bir telefon numarasÄ± sadece bir ÅŸirkete ait olabilir
        const phoneArray = [...phoneChips].map(p => p.trim());
        if (phoneArray.length > 0) {
          for (const phone of phoneArray) {
            if (!phone) continue;
            const phoneQuery = query(
              collection(db, "users"),
              where("contactPhones", "array-contains", phone)
            );
            const phoneSnapshot = await getDocs(phoneQuery);
            
            if (!phoneSnapshot.empty) {
              // Telefon zaten kullanÄ±lÄ±yor
              const existingUser = phoneSnapshot.docs[0].data();
              const existingCompanyName = existingUser.companyName || "Bilinmeyen Åirket";
              saveBtn.disabled = false;
              saveBtn.textContent = "Kaydet ve Devam Et";
              toast.error(MESSAGES.ERROR_PHONE_IN_USE + ': ' + phone + (existingCompanyName ? ' - ' + existingCompanyName : ''));
              return;
            }
          }
        }
        
        saveBtn.textContent = "Kaydediliyor...";
        
        // Teklifbul Rule v1.0 - Mevcut ÅŸirkete katÄ±lma durumu
        if (companyMode === 'join') {
          // Åirket kodunu kontrol et
          const companyQuery = query(
            collection(db, "companies"),
            where("code", "==", companyCodeInput)
          );
          const companySnapshot = await getDocs(companyQuery);
          
          if (companySnapshot.empty) {
            saveBtn.disabled = false;
            saveBtn.textContent = "Kaydet ve Devam Et";
            toast.error(MESSAGES.ERROR_COMPANY_NOT_FOUND + (companyCodeInput ? ' ("' + companyCodeInput + '")' : ''));
            return;
          }
          
          // Mevcut ÅŸirkete katÄ±lÄ±rken de e-posta ve telefon kontrolÃ¼ yapÄ±lmalÄ±
          // NOT: Kendi email'imizi kontrol etme (ÅŸirkete katÄ±lÄ±yoruz, kendi email'imizi kullanabiliriz)
          const emailArray = [...emailChips].map(e => e.trim().toLowerCase());
          if (emailArray.length > 0) {
            for (const email of emailArray) {
              if (!email) continue;
              
              // Kendi email'imizi kontrol etme
              if (primaryEmail && email.toLowerCase() === primaryEmail.toLowerCase()) {
                continue; // Kendi email'imizi kontrol etme
              }
              
              const emailQuery = query(
                collection(db, "users"),
                where("contactEmails", "array-contains", email)
              );
              const emailSnapshot = await getDocs(emailQuery);
              
              if (!emailSnapshot.empty) {
                const existingUser = emailSnapshot.docs[0];
                const existingUserData = existingUser.data();
                const existingCompanyName = existingUserData.companyName || "Bilinmeyen Åirket";
                // Kendi kendimizi kontrol etme
                if (existingUser.id !== user.uid) {
                  saveBtn.disabled = false;
                  saveBtn.textContent = "Kaydet ve Devam Et";
                  toast.error(MESSAGES.ERROR_EMAIL_IN_USE + ': ' + email + (existingCompanyName ? ' - ' + existingCompanyName : ''));
                  return;
                }
              }
            }
          }
          
          const phoneArray = [...phoneChips].map(p => p.trim());
          const companyPhone = document.getElementById("companyPhone")?.value.trim();
          const mobilePhone = document.getElementById("mobilePhone")?.value.trim();
          const whatsappPhone = document.getElementById("whatsappPhone")?.value.trim();
          const allPhoneNumbers = [...phoneArray];
          if (companyPhone) allPhoneNumbers.push(companyPhone);
          if (mobilePhone) allPhoneNumbers.push(mobilePhone);
          if (whatsappPhone) allPhoneNumbers.push(whatsappPhone);
          
          if (allPhoneNumbers.length > 0) {
            for (const phone of allPhoneNumbers) {
              if (!phone) continue;
              const phoneQuery = query(
                collection(db, "users"),
                where("contactPhones", "array-contains", phone)
              );
              const phoneSnapshot = await getDocs(phoneQuery);
              
              if (!phoneSnapshot.empty) {
                const existingUser = phoneSnapshot.docs[0].data();
                const existingCompanyName = existingUser.companyName || "Bilinmeyen Åirket";
                saveBtn.disabled = false;
                saveBtn.textContent = "Kaydet ve Devam Et";
                toast.error(MESSAGES.ERROR_PHONE_IN_USE + ': ' + phone + (existingCompanyName ? ' - ' + existingCompanyName : ''));
                return;
              }
            }
          }
          
          const existingCompany = companySnapshot.docs[0];
          const companyId = existingCompany.id;
          const companyData = existingCompany.data();
          
          // Onay bekleyen kullanÄ±cÄ±lar koleksiyonuna ekle - Teklifbul Rule v1.0
          const pendingRequestRef = doc(collection(db, "companies", companyId, "pendingMembers"));
          await setDoc(pendingRequestRef, {
            userId: user.uid,
            userEmail: user.email || null,
            requestedRole: joinRoleSelect,
            requestedAt: serverTimestamp(),
            status: 'pending'
          });
          
          // Yeni sistem: companyJoinRequests koleksiyonuna da kayÄ±t ekle - Teklifbul Rule v1.0
          const requestedRoleSimple = joinRoleSelect.includes('supplier') ? 'supplier' : 'buyer';
          await addDoc(collection(db, 'companyJoinRequests'), {
            companyCode: companyCodeInput,
            companyId: companyId,
            userId: user.uid,
            userEmail: user.email || null,
            requestedRole: requestedRoleSimple,
            requestedCompanyRole: joinRoleSelect, // Teklifbul Rule v1.0 - DetaylÄ± rol bilgisi
            status: 'pending',
            createdAt: serverTimestamp()
          });
          
          // Upload tax certificate if provided
          let taxCertPath = null;
          const file = taxCertFile.files[0];
          if (file) {
            const path = `suppliers/${user.uid}/${Date.now()}-${file.name}`;
            const storageRef = ref(storage, path);
            await uploadBytes(storageRef, file);
            taxCertPath = path;
          }
          
          // KullanÄ±cÄ± profilini kaydet (onay beklerken bile temel bilgiler kaydedilir)
          // Get invoice address
          const invoiceAddress = document.getElementById("invoiceAddress")?.value.trim() || '';
          const taxOffice = document.getElementById("taxOffice")?.value.trim() || null;
          
          // Get structured invoice address parts
          const invUlke = document.getElementById("inv_ulke")?.value?.trim() || 'TÃ¼rkiye';
          const invIl = getSelText(document.getElementById("inv_il")) || null;
          const invIlce = getSelText(document.getElementById("inv_ilce")) || null;
          const invMahalle = getSelText(document.getElementById("inv_mahalle")) || null;
          const invCadde = document.getElementById("inv_cadde")?.value?.trim() || null;
          const invSokakSel = document.getElementById("inv_sokak");
          const invSokakManual = document.getElementById("inv_sokak_manual");
          const invSokak = (invSokakSel && invSokakSel.style.display !== 'none' ? getSelText(invSokakSel) : '') || (invSokakManual?.value?.trim() || null);
          const invKapi = document.getElementById("inv_kapi")?.value?.trim() || null;
          const invDaire = document.getElementById("inv_daire")?.value?.trim() || null;
          const invPostaKodu = document.getElementById("inv_postakodu")?.value?.trim() || null;
          
          const invoiceAddressParts = {
            ulke: invUlke || 'TÃ¼rkiye',
            il: invIl,
            ilce: invIlce,
            mahalle: invMahalle,
            cadde: invCadde,
            sokak: invSokak,
            kapi: invKapi,
            daire: invDaire,
            postaKodu: invPostaKodu
          };
          
          // Get bank accounts
          const bankAccountsData = [];
          document.querySelectorAll('#bankAccountsList > div').forEach(row => {
            const bankName = row.querySelector('.bank-name')?.value.trim();
            const iban = row.querySelector('.bank-iban')?.value.trim().replace(/\s/g, '');
            const accountName = row.querySelector('.bank-account-name')?.value.trim();
            const currency = row.querySelector('.bank-currency')?.value || 'TRY';
            
            if (bankName && iban && accountName) {
              bankAccountsData.push({
                bankName,
                iban: iban.toUpperCase(),
                accountName,
                currency
              });
            }
          });
          
          // Save user profile (pending status)
          const rolesArray = Array.from(selectedRoles);
          const primaryRole = selectedRoles.has("buyer") ? "buyer" : "supplier";
          
          await setDoc(doc(db, "users", user.uid), {
            role: primaryRole, // Backward compatibility
            roles: rolesArray, // Multi-role support - Teklifbul Rule v1.0
            companyName: companyData.name,
            companyCode: companyCodeInput,
            companyId: companyId,
            companyJoinStatus: 'pending', // Teklifbul Rule v1.0 - Onay bekliyor
            requestedCompanyRole: joinRoleSelect, // Teklifbul Rule v1.0
            contactEmails: [...emailChips],
            contactPhones: allPhoneNumbers, // Teklifbul Rule v1.0 - YukarÄ±da tanÄ±mlÄ±
            companyPhone: companyPhone || null,
            mobilePhone: mobilePhone || null,
            whatsappPhone: whatsappPhone || null,
            invoiceAddress: invoiceAddress || null,
            invoiceAddressParts: invoiceAddressParts, // Teklifbul Rule v1.0 - YukarÄ±da tanÄ±mlÄ±
            taxOffice: taxOffice || null,
            bankAccounts: bankAccountsData, // Teklifbul Rule v1.0 - YukarÄ±da tanÄ±mlÄ±
            buyerCategoryIds: normalizeToIds([...buyerCatChips]),
            supplierCategoryIds: normalizeToIds([...supplierCatChips]),
            buyerCategories: [...buyerCatChips].map(name => {
              const id = getIdByName(name);
              return id ? getNameById(id) : name;
            }),
            supplierCategories: [...supplierCatChips].map(name => {
              const id = getIdByName(name);
              return id ? getNameById(id) : name;
            }),
            taxCertificatePath: taxCertPath,
            kvkkConsent: true,
            marketingConsent,
            consentAt: serverTimestamp(),
            email: user.email || null,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          }, { merge: true });
          
          // Åirket sahiplerine bildirim gÃ¶nder (companies/{id}/notifications alt koleksiyonu)
          const notificationRef = doc(collection(db, "companies", companyId, "notifications"));
          await setDoc(notificationRef, {
            type: 'pending_member_request',
            userId: user.uid,
            userEmail: user.email || null,
            requestedRole: joinRoleSelect,
            message: `${user.email || 'Yeni kullanÄ±cÄ±'} ÅŸirketinize katÄ±lmak iÃ§in onay bekliyor.`,
            createdAt: serverTimestamp(),
            read: false
          });
          
          // KullanÄ±cÄ±yÄ± bekleme sayfasÄ±na yÃ¶nlendir - Teklifbul Rule v1.0
          saveBtn.disabled = false;
          saveBtn.textContent = "Kaydet ve Devam Et";
          location.href = "./company-join-waiting.html";
          return;
        }
        
        // Yeni ÅŸirket oluÅŸturma durumu
        let taxCertPath = null;
        
        // Upload tax certificate if provided
        const file = taxCertFile.files[0];
        if (file) {
          const path = `suppliers/${user.uid}/${Date.now()}-${file.name}`;
          const storageRef = ref(storage, path);
          await uploadBytes(storageRef, file);
          taxCertPath = path;
        }
        
        // Teklifbul Rule v1.0 - Åirket ID'si vergi numarasÄ±na gÃ¶re oluÅŸturulur
        // Vergi numarasÄ± benzersiz olduÄŸu iÃ§in ID olarak kullanÄ±lÄ±r (harf hatasÄ± riskini Ã¶nler)
        // taxNumberTrimmed zaten yukarida tanimlandi
        const companyId = `tax-${taxNumberTrimmed}`; // Vergi numarasÄ±nÄ± ID olarak kullan
        
        // Åirket ID'sinin zaten kullanÄ±lÄ±p kullanÄ±lmadÄ±ÄŸÄ±nÄ± kontrol et
        const existingCompanyCheck = await getDoc(doc(db, "companies", companyId));
        if (existingCompanyCheck.exists()) {
          saveBtn.disabled = false;
          saveBtn.textContent = "Kaydet ve Devam Et";
          toast.error(MESSAGES.ERROR_TAXNUMBER_IN_USE + ': ' + taxNumberTrimmed);
          return;
        }
        
        // Teklifbul Rule v1.0 - Benzersiz ÅŸirket kodu kontrolÃ¼
        let finalCompanyCode = generatedCompanyCode;
        let attempts = 0;
        while (attempts < 10) {
          const codeCheckQuery = query(
            collection(db, "companies"),
            where("code", "==", finalCompanyCode)
          );
          const codeCheckSnapshot = await getDocs(codeCheckQuery);
          
          if (codeCheckSnapshot.empty) {
            break; // Kod benzersiz
          }
          
          // Kod kullanÄ±lÄ±yor, yeni kod oluÅŸtur
          finalCompanyCode = generateCompanyCode();
          attempts++;
        }
        
        if (attempts >= 10) {
          throw new Error("Benzersiz ÅŸirket kodu oluÅŸturulamadÄ±. LÃ¼tfen tekrar deneyin.");
        }
        
        const companyData = {
          name: companyName,
          taxNumber: taxNumber,
          code: finalCompanyCode, // Teklifbul Rule v1.0 - Otomatik oluÅŸturulan ÅŸirket kodu
          mersisNo: mersisNo || null,
          // Ana adres kaldÄ±rÄ±ldÄ± - Sadece fatura adresi kullanÄ±lÄ±yor - Teklifbul Rule v1.0
          invoiceAddress: invoiceAddress || null,
          invoiceAddressParts: invoiceAddressParts, // Teklifbul Rule v1.0 - Structured address parts
          website: website || null,
          ownerId: user.uid,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };
        
        // Referans kodu kontrolÃ¼ - Teklifbul Rule v1.0
        let referralCodeId = null;
        let referralCompanyId = null;
        const urlParams = new URLSearchParams(window.location.search);
        const refCode = urlParams.get('ref');
        
        if (refCode) {
          // Referans kodunu kontrol et ve iÅŸaretle
          try {
            const refCodeQuery = query(
              collection(db, "companies"),
              where("code", "==", refCode)
            );
            const refCodeSnapshot = await getDocs(refCodeQuery);
            
            if (!refCodeSnapshot.empty) {
              // Åirket kodu ile referans bulundu
              const refCompany = refCodeSnapshot.docs[0];
              referralCompanyId = refCompany.id;
              referralCodeId = refCode;
            } else {
              // Referans kod koleksiyonunda ara
              const allCompanies = await getDocs(collection(db, "companies"));
              for (const companyDoc of allCompanies.docs) {
                const refCodesCollection = collection(db, "companies", companyDoc.id, "referralCodes");
                const refCodeDoc = doc(refCodesCollection, refCode);
                const refCodeData = await getDoc(refCodeDoc);
                
                if (refCodeData.exists()) {
                  const codeData = refCodeData.data();
                  // TEK KULLANIM KONTROLÃœ - EÄŸer kod zaten kullanÄ±lmÄ±ÅŸsa, referans kullanma
                  if (!codeData.used) {
                    referralCodeId = refCode;
                    referralCompanyId = companyDoc.id;
                    
                    // Kodu kullanÄ±ldÄ± olarak iÅŸaretle (TEK KULLANIM - role-select'te profil oluÅŸturulurken)
                    // Not: signup.html'de zaten iÅŸaretlenmiÅŸ olabilir, ama yine de kontrol et
                    await updateDoc(refCodeDoc, {
                      used: true,
                      usedBy: user.uid,
                      usedAt: serverTimestamp()
                    });
                    break;
                  } else {
                    // Kod zaten kullanÄ±lmÄ±ÅŸ - referans olmadan devam et
                    logger.warn('Referans kodu zaten kullanÄ±lmÄ±ÅŸ', { refCode });
                    referralCodeId = null;
                    referralCompanyId = null;
                  }
                }
              }
            }
          } catch (refError) {
            logger.warn("Referans kodu kontrolÃ¼ baÅŸarÄ±sÄ±z", refError);
          }
        }
        
        // Save company to Firestore
        await setDoc(doc(db, "companies", companyId), companyData);
        
        // Collect all phone numbers - Teklifbul Rule v1.0
        const allPhones = [...phoneChips];
        if (companyPhone) allPhones.push(companyPhone);
        if (mobilePhone) allPhones.push(mobilePhone);
        if (whatsappPhone) allPhones.push(whatsappPhone);
        
        // Get selected company roles for new company - Teklifbul Rule v1.0
        // Ã‡oklu rol desteÄŸi: Her rol iÃ§in ayrÄ± ÅŸirket rolÃ¼ seÃ§imi
        const rolesArray = Array.from(selectedRoles);
        let buyerCompanyRole = null;
        let buyerCompanyRoleType = null;
        let buyerCompanyRoleKey = null;
        let supplierCompanyRole = null;
        let supplierCompanyRoleType = null;
        let supplierCompanyRoleKey = null;
        
        if (selectedRoles.has("buyer")) {
          const buyerRoleSelect = document.getElementById('newCompanyBuyerRoleSelect');
          const selectedBuyerRoleKey = buyerRoleSelect?.value || 'buyer:isveren';
          [buyerCompanyRoleType, buyerCompanyRole] = selectedBuyerRoleKey.split(':');
          buyerCompanyRoleKey = selectedBuyerRoleKey;
        }
        
        if (selectedRoles.has("supplier")) {
          const supplierRoleSelect = document.getElementById('newCompanySupplierRoleSelect');
          const selectedSupplierRoleKey = supplierRoleSelect?.value || 'supplier:sirket_sahibi';
          [supplierCompanyRoleType, supplierCompanyRole] = selectedSupplierRoleKey.split(':');
          supplierCompanyRoleKey = selectedSupplierRoleKey;
        }
        
        // Primary role: buyer varsa buyer, yoksa supplier
        const primaryRole = selectedRoles.has("buyer") ? "buyer" : "supplier";
        
        // Company role: Ã–ncelik buyer rolÃ¼ne, yoksa supplier rolÃ¼ne
        const companyRole = buyerCompanyRole || supplierCompanyRole;
        const companyRoleType = buyerCompanyRoleType || supplierCompanyRoleType;
        const companyRoleKey = buyerCompanyRoleKey || supplierCompanyRoleKey;
        
        // Save user profile with company reference
        await setDoc(doc(db, "users", user.uid), {
          role: primaryRole, // Backward compatibility
          roles: rolesArray, // Multi-role support - Teklifbul Rule v1.0
          companyName,
          companyCode: finalCompanyCode, // Teklifbul Rule v1.0 - Åirket kodu kullanÄ±cÄ±ya da kaydedilir
          companyId: companyId, // Teklifbul Rule v1.0 - Åirket ID'si
          companyRole: companyRole, // Teklifbul Rule v1.0 - Åirket iÃ§indeki rol (Ã¶r: isveren, satinalma_yetkilisi)
          companyRoleType: companyRoleType, // Teklifbul Rule v1.0 - Rol tipi (buyer veya supplier)
          companyRoleKey: companyRoleKey, // Teklifbul Rule v1.0 - Tam rol anahtarÄ± (buyer:isveren)
          // Multi-role company roles - Teklifbul Rule v1.0
          buyerCompanyRole: buyerCompanyRole,
          buyerCompanyRoleType: buyerCompanyRoleType,
          buyerCompanyRoleKey: buyerCompanyRoleKey,
          supplierCompanyRole: supplierCompanyRole,
          supplierCompanyRoleType: supplierCompanyRoleType,
          supplierCompanyRoleKey: supplierCompanyRoleKey,
          companyJoinStatus: 'approved', // Teklifbul Rule v1.0 - Yeni ÅŸirket oluÅŸtururken otomatik onaylÄ±
          taxNumber,
          mersisNo: mersisNo || null,
          // Ana adres kaldÄ±rÄ±ldÄ± - Sadece fatura adresi kullanÄ±lÄ±yor - Teklifbul Rule v1.0
          website: website || null,
          contactEmails: [...emailChips],
          contactPhones: allPhones, // Teklifbul Rule v1.0 - TÃ¼m telefon numaralarÄ±
          companyPhone: companyPhone || null, // Teklifbul Rule v1.0
          mobilePhone: mobilePhone || null, // Teklifbul Rule v1.0
          whatsappPhone: whatsappPhone || null, // Teklifbul Rule v1.0
          invoiceAddress: invoiceAddress || null, // Teklifbul Rule v1.0 - Fatura adresi
          invoiceAddressParts: invoiceAddressParts, // Teklifbul Rule v1.0 - YapÄ±landÄ±rÄ±lmÄ±ÅŸ fatura adresi
          taxOffice: taxOffice || null, // Teklifbul Rule v1.0 - Vergi dairesi
          bankAccounts: bankAccountsData, // Teklifbul Rule v1.0 - Banka hesaplarÄ±
          // CRITICAL: Convert category names to IDs using new system
          buyerCategoryIds: normalizeToIds([...buyerCatChips]),
          supplierCategoryIds: normalizeToIds([...supplierCatChips]),
          // Backward compatibility: legacy fields
          buyerCategories: [...buyerCatChips].map(name => {
            const id = getIdByName(name);
            return id ? getNameById(id) : name;
          }),
          buyerCategoryKeys: [...buyerCatChips].map(name => {
            const id = getIdByName(name);
            const cat = allCategories.find(c => c.id === id);
            return cat ? cat.slug : null;
          }).filter(Boolean),
          supplierCategories: [...supplierCatChips].map(name => {
            const id = getIdByName(name);
            return id ? getNameById(id) : name;
          }),
          supplierCategoryKeys: [...supplierCatChips].map(name => {
            const id = getIdByName(name);
            const cat = allCategories.find(c => c.id === id);
            return cat ? cat.slug : null;
          }).filter(Boolean),
          taxCertificatePath: taxCertPath,
          kvkkConsent: true,
          marketingConsent,
          consentAt: serverTimestamp(),
          email: user.email || null,
          companies: [companyId], // Add company reference to user
          activeCompanyId: companyId, // Set active company
          // Referans bilgisi - Teklifbul Rule v1.0
          referredBy: referralCompanyId || null,
          referredByCode: referralCodeId || null,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });
        
        // Referans veren ÅŸirkete kaydet - Teklifbul Rule v1.0
        if (referralCompanyId) {
          try {
            const referredCompaniesRef = collection(db, 'companies', referralCompanyId, 'referredCompanies');
            await addDoc(referredCompaniesRef, {
              referredCompanyId: companyId,
              referredCompanyCode: finalCompanyCode,
              referredCompanyName: companyName,
              referredBy: user.uid,
              referredAt: serverTimestamp()
            });
            
            // Åirket verisine de referans sayÄ±sÄ±nÄ± ekle
            const referralCompanyRef = doc(db, 'companies', referralCompanyId);
            const referralCompanyDoc = await getDoc(referralCompanyRef);
            if (referralCompanyDoc.exists()) {
              const currentData = referralCompanyDoc.data();
              const referralCount = (currentData.referralCount || 0) + 1;
              await updateDoc(referralCompanyRef, {
                referralCount: referralCount,
                updatedAt: serverTimestamp()
              });
            }
          } catch (refSaveError) {
            logger.warn("Referans bilgisi kaydedilemedi", refSaveError);
          }
        }
        
        const referralMsg = referralCodeId 
          ? `\n\nğŸ Referans Kodu: ${referralCodeId}\nBu kod ile kayÄ±t oldunuz. Referans veren ÅŸirket bilgileriniz kaydedildi.`
          : '';
        
        // Merkezi mesaj sistemine alÄ±ndÄ± - dinamik kod ve referral mesajÄ± replace ile ekleniyor
        toast.success(
          MESSAGES.SUCCESS_PROFILE_COMPANY_SAVED
            .replace('{code}', finalCompanyCode)
            .replace('{referral}', referralMsg)
        );
        location.href = "./demands.html";
      } catch (e) {
        logger.error("Profile save error", e);
        toast.error(MESSAGES.ERROR_GENERAL + ": " + (e.message || e));
        saveBtn.disabled = false;
        saveBtn.textContent = "Kaydet ve Devam Et";
      }
    };
    
    // Åirket koduna gÃ¶re ÅŸirket bilgilerini yÃ¼kle ve formu doldur - Teklifbul Rule v1.0
    async function loadCompanyInfoByCode(companyCode) {
      if (!companyCode || companyCode.length < 6) return;
      
      try {
        const companyQuery = query(
          collection(db, "companies"),
          where("code", "==", companyCode.toUpperCase())
        );
        const companySnapshot = await getDocs(companyQuery);
        
        if (companySnapshot.empty) {
          logger.warn('Åirket kodu ile eÅŸleÅŸen ÅŸirket bulunamadÄ±');
          return;
        }
        
        const companyDoc = companySnapshot.docs[0];
        const companyData = companyDoc.data();
        
        // Form alanlarÄ±nÄ± doldur (sadece boÅŸ alanlar)
        if (companyData.name && !document.getElementById("companyName")?.value) {
          document.getElementById("companyName").value = companyData.name;
        }
        if (companyData.taxNumber && !document.getElementById("taxNumber")?.value) {
          document.getElementById("taxNumber").value = companyData.taxNumber;
        }
        if (companyData.taxOffice && !document.getElementById("taxOffice")?.value) {
          document.getElementById("taxOffice").value = companyData.taxOffice;
        }
        if (companyData.mersisNo && !document.getElementById("mersisNo")?.value) {
          document.getElementById("mersisNo").value = companyData.mersisNo;
        }
        if (companyData.invoiceAddress && !document.getElementById("invoiceAddress")?.value) {
          document.getElementById("invoiceAddress").value = companyData.invoiceAddress;
        }
        if (companyData.googleBusinessUrl && !document.getElementById("googleBusinessUrl")?.value) {
          document.getElementById("googleBusinessUrl").value = companyData.googleBusinessUrl;
        }
        
        // YapÄ±landÄ±rÄ±lmÄ±ÅŸ adres bilgilerini doldur
        if (companyData.invoiceAddressParts) {
          const parts = companyData.invoiceAddressParts;
          if (parts.ulke && document.getElementById("inv_ulke")) {
            document.getElementById("inv_ulke").value = parts.ulke;
          }
          if (parts.il && document.getElementById("inv_il")) {
            // Ä°l seÃ§imi iÃ§in Ã¶zel iÅŸlem gerekebilir
            const ilSelect = document.getElementById("inv_il");
            if (ilSelect) {
              const options = Array.from(ilSelect.options);
              const matchingOption = options.find(opt => opt.textContent.trim() === parts.il);
              if (matchingOption) {
                ilSelect.value = matchingOption.value;
                ilSelect.dispatchEvent(new Event('change')); // Ä°lÃ§e listesini gÃ¼ncelle
              }
            }
          }
        }
        
        // Banka bilgileri (varsa)
        if (companyData.bankAccounts && Array.isArray(companyData.bankAccounts) && companyData.bankAccounts.length > 0) {
          // Banka bilgileri formu varsa doldur
          const firstBank = companyData.bankAccounts[0];
          if (firstBank.bankName && document.getElementById("bankName")) {
            document.getElementById("bankName").value = firstBank.bankName;
          }
          if (firstBank.accountNumber && document.getElementById("accountNumber")) {
            document.getElementById("accountNumber").value = firstBank.accountNumber;
          }
          if (firstBank.iban && document.getElementById("iban")) {
            document.getElementById("iban").value = firstBank.iban;
          }
        }
        
        // Kategoriler (varsa)
        if (companyData.categories && Array.isArray(companyData.categories) && companyData.categories.length > 0) {
          // Kategorileri chip olarak ekle
          companyData.categories.forEach(cat => {
            if (cat && !buyerCatChips.has(cat)) {
              buyerCatChips.add(cat);
            }
          });
          renderBuyerChips();
        }
        
        logger.info('Åirket bilgileri otomatik dolduruldu', { companyName: companyData.name });
      } catch (e) {
        logger.warn('Åirket bilgileri yÃ¼klenirken hata', e);
      }
    }
    
    // Check if user already has a profile
    auth.onAuthStateChanged(async user => {
      if (!user) {
        location.href = "./index.html";
        return;
      }
      
      // Teklifbul Rule v1.0 - KullanÄ±cÄ±nÄ±n email adresini otomatik olarak doldur
      if (user.email && emailInput) {
        // KayÄ±t olurken kullanÄ±lan email'i primary email olarak iÅŸaretle (silinemez)
        primaryEmail = user.email.toLowerCase();
        // EÄŸer email chips boÅŸsa, kullanÄ±cÄ±nÄ±n email'ini ekle
        if (emailChips.size === 0 || !emailChips.has(user.email)) {
          emailChips.add(user.email);
          renderEmailChips();
        }
      }
      
      // Signup.html'den gelen ÅŸirkete katÄ±lma parametrelerini kontrol et - Teklifbul Rule v1.0
      const urlParams = new URLSearchParams(window.location.search);
      const joinCompany = urlParams.get('joinCompany');
      const companyCodeFromSignup = urlParams.get('companyCode');
      const requestedRoleFromSignup = urlParams.get('requestedRole');
      
      if (joinCompany === 'true' && companyCodeFromSignup && requestedRoleFromSignup) {
        // Åirkete katÄ±lma modunu aktif et
        const companyModeJoin = document.querySelector('input[name="companyMode"][value="join"]');
        const companyModeNew = document.querySelector('input[name="companyMode"][value="new"]');
        const joinCompanySection = document.getElementById('joinCompanySection');
        const companyCodeInput = document.getElementById('companyCode');
        const joinRoleSelect = document.getElementById('joinRoleSelect');
        
        if (companyModeJoin && companyModeNew) {
          // Join modunu seÃ§
          companyModeNew.checked = false;
          companyModeJoin.checked = true;
          
          // Join section'Ä± gÃ¶ster
          if (joinCompanySection) {
            joinCompanySection.style.display = 'block';
          }
          
          // Åirket kodunu ve rolÃ¼ doldur
          if (companyCodeInput) {
            companyCodeInput.value = companyCodeFromSignup;
            // Åirket bilgilerini otomatik doldur - Teklifbul Rule v1.0
            await loadCompanyInfoByCode(companyCodeFromSignup);
          }
          if (joinRoleSelect) {
            joinRoleSelect.value = requestedRoleFromSignup;
          }
          
          // Radio button deÄŸiÅŸikliÄŸini tetikle (gÃ¶rsel gÃ¼ncelleme iÃ§in)
          companyModeJoin.dispatchEvent(new Event('change'));
          
          logger.info('Åirkete katÄ±lma modu aktif edildi', {
            companyCode: companyCodeFromSignup,
            requestedRole: requestedRoleFromSignup
          });
        }
      }
      
      // Åirket kodu input'una event listener ekle - Teklifbul Rule v1.0
      const companyCodeInputField = document.getElementById('companyCode');
      if (companyCodeInputField) {
        // Debounce ile ÅŸirket bilgilerini yÃ¼kle
        let loadTimeout = null;
        companyCodeInputField.addEventListener('input', async (e) => {
          const code = e.target.value.trim().toUpperCase();
          if (code.length >= 6) { // Minimum 6 karakter
            clearTimeout(loadTimeout);
            loadTimeout = setTimeout(async () => {
              await loadCompanyInfoByCode(code);
            }, 500); // 500ms debounce
          }
        });
      }
      
      try {
        const snap = await getDoc(doc(db, "users", user.uid));
        if (snap.exists()) {
          const userData = snap.data();
          
          // Åirket kodlu kayÄ±t durumunda bekleme sayfasÄ±na yÃ¶nlendir - Teklifbul Rule v1.0
          if (userData.companyJoinStatus === 'pending' || userData.companyJoinStatus === 'rejected') {
            location.href = "./company-join-waiting.html";
            return;
          }
          
          // Normal kayÄ±t tamamlanmÄ±ÅŸsa
          if (userData.role || userData.roles) {
            location.href = "./demands.html";
          }
        }
        logger.info("User profile check completed");
      } catch (e) {
        logger.warn("User profile check error", e);
        logger.warn("Error details", { code: e.code, name: e.name, stack: e.stack });
      }
    });
  </script>
</body>
</html>
