<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yeni Talep</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%233b82f6' rx='6'/%3E%3Ctext x='16' y='22' font-family='Arial' font-size='18' font-weight='bold' text-anchor='middle' fill='white'%3ET%3C/text%3E%3C/svg%3E" />
  <script type="importmap">
  {
    "imports": {
      "categories": "/categories.js",
      "address-verify": "./assets/js/address-verify-modal.js",
      "google-maps-loader": "./assets/js/google-maps-loader.js"
    }
  }
  </script>
  <link rel="stylesheet" href="/utils.css" />
  <link rel="stylesheet" href="/assets/css/layout.css" />
  <link rel="stylesheet" href="/css/ui-standard.css" />
  <style>
    .items-table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 13px; table-layout: fixed; }
    .items-table th, .items-table td { border: 1px solid #ddd; padding: 6px; }
    
    /* Tablo sÃ¼tun geniÅŸlikleri */
    .items-table th:nth-child(1), .items-table td:nth-child(1) { width: 5%; }   /* SÄ±ra No */
    .items-table th:nth-child(2), .items-table td:nth-child(2) { width: 8%; }   /* Malzeme Kodu (kÃ¼Ã§Ã¼k) */
    .items-table th:nth-child(3), .items-table td:nth-child(3) { width: 25%; }  /* Malzeme TanÄ±mÄ± (en uzun) */
    .items-table th:nth-child(4), .items-table td:nth-child(4) { width: 12%; }  /* Marka/Model */
    .items-table th:nth-child(5), .items-table td:nth-child(5) { width: 8%; }   /* Miktar */
    .items-table th:nth-child(6), .items-table td:nth-child(6) { width: 7%; }   /* Birim */
    .items-table th:nth-child(7), .items-table td:nth-child(7) { width: 8%; }   /* Ambar */
    .items-table th:nth-child(8), .items-table td:nth-child(8) { width: 8%; }   /* Hedef */
    .items-table th:nth-child(9), .items-table td:nth-child(9) { width: 10%; }  /* Teslim Tarihi */
    .items-table th:nth-child(10), .items-table td:nth-child(10) { width: 9%; } /* Sil */
    .items-table input, .items-table select { width: 100%; padding: 4px; box-sizing: border-box; margin: 0; }
    
    /* Miktar alanÄ± Ã¶zel boyutlarÄ± */
    .items-table .qty {
      width: 100px !important;
      height: 32px !important;
      min-width: 80px;
      max-width: 120px;
    }
    
    /* DiÄŸer input alanlarÄ± iÃ§in boyut ayarlarÄ± */
    .items-table .sku {
      width: 72px !important;  /* %40 kÃ¼Ã§Ã¼ltÃ¼ldÃ¼: 120px * 0.6 = 72px */
      height: 32px !important;
    }
    
    .items-table .itemName {
      width: 200px !important;  /* En uzun alan - Malzeme TanÄ±mÄ± */
      height: 32px !important;
      min-width: 150px;
      max-width: 300px;
    }
    
    .items-table .unit {
      width: 80px !important;
      height: 32px !important;
    }
    
    .items-table .stockQty,
    .items-table .targetPrice {
      width: 90px !important;
      height: 32px !important;
    }
    
    .items-table .itemDueDate {
      width: 110px !important;
      height: 32px !important;
    }
    .btn-sm { padding: 6px 10px; margin: 4px 0; }
    .badge { display:inline-block; margin:4px 6px 0 0; padding:4px 8px; border-radius:12px; background:#eef2ff; font-size:12px; cursor:pointer; }
    
    /* Teklifbul Rule v1.0 - Teslimat adresi textarea'sÄ± her zaman gÃ¶rÃ¼nÃ¼r olmalÄ± */
    #deliveryAddressContainer {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      min-height: 100px !important;
    }
    
    #deliveryAddress {
      min-height: 80px !important;
      width: 100% !important;
    }
    
    /* Teklifbul Rule v1.0 - Disabled textarea'da value gÃ¶rÃ¼nÃ¼r olmalÄ± */
    #deliveryAddress:disabled {
      background: #f9fafb !important;
      color: #1f2937 !important;
      opacity: 1 !important;
      cursor: default !important;
    }
    
    #deliveryAddress:disabled::placeholder {
      color: transparent !important;
    }
    
    /* Teklifbul Rule v1.0 - Buton stilleri */
    #verifyDeliveryAddressBtn {
      flex-shrink: 0;
      align-self: flex-start;
    }
    
    /* SATFK Input Responsive Design */
    #satfk {
      min-width: 294px;
      max-width: 100%;
    }
    
    @media (max-width: 768px) {
      #satfk {
        min-width: 200px;
        width: 100% !important;
      }
      
      /* Mobile iÃ§in input alanlarÄ± */
      .items-table .qty {
        width: 80px !important;
        height: 30px !important;
        min-width: 60px;
        max-width: 100px;
      }
      
      .items-table .sku {
        width: 60px !important;  /* Mobile'da da %40 kÃ¼Ã§Ã¼k */
        height: 30px !important;
      }
      
      .items-table .itemName {
        width: 150px !important;  /* Mobile'da en uzun alan */
        height: 30px !important;
        min-width: 120px;
        max-width: 200px;
      }
      
      .items-table .unit {
        width: 70px !important;
        height: 30px !important;
      }
      
      .items-table .stockQty,
      .items-table .targetPrice {
        width: 80px !important;
        height: 30px !important;
      }
      
      .items-table .itemDueDate {
        width: 100px !important;
        height: 30px !important;
      }
      
      /* Mobile iÃ§in tablo sÃ¼tun geniÅŸlikleri */
      .items-table th:nth-child(1), .items-table td:nth-child(1) { width: 6%; }   /* SÄ±ra No */
      .items-table th:nth-child(2), .items-table td:nth-child(2) { width: 10%; }  /* Malzeme Kodu */
      .items-table th:nth-child(3), .items-table td:nth-child(3) { width: 30%; }  /* Malzeme TanÄ±mÄ± (en uzun) */
      .items-table th:nth-child(4), .items-table td:nth-child(4) { width: 15%; }  /* Marka/Model */
      .items-table th:nth-child(5), .items-table td:nth-child(5) { width: 10%; }  /* Miktar */
      .items-table th:nth-child(6), .items-table td:nth-child(6) { width: 8%; }   /* Birim */
      .items-table th:nth-child(7), .items-table td:nth-child(7) { width: 10%; }  /* Ambar */
      .items-table th:nth-child(8), .items-table td:nth-child(8) { width: 10%; }  /* Hedef */
      .items-table th:nth-child(9), .items-table td:nth-child(9) { width: 12%; }  /* Teslim Tarihi */
      .items-table th:nth-child(10), .items-table td:nth-child(10) { width: 9%; } /* Sil */
    }
    label { font-weight:600; font-size:14px; }
    #catChips { margin-top: 8px; }
    
    /* === AÃ§Ä±klama AlanÄ± (Teknik Åart / AÃ§Ä±klama) === */
    #descriptionsContainer {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .description-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .description-item textarea {
      min-height: 70px !important;
      width: 100% !important;
      padding: 10px !important;
      font-size: 14px !important;
      line-height: 1.4 !important;
      border: 1px solid #ccc !important;
      border-radius: 6px !important;
      background: #fff !important;
      cursor: text !important;
      transition: all 0.2s ease-in-out !important;
      resize: vertical;
    }
    
    .description-number {
      font-weight: 600;
      color: #374151;
      font-size: 14px;
      min-width: 40px;
      padding-top: 0;
      flex-shrink: 0;
    }
    
    .description-item textarea:focus {
      border-color: #007bff !important;  /* OdaklanÄ±nca mavi kenar */
      box-shadow: 0 0 4px rgba(0, 123, 255, 0.3);
      outline: none;
    }
    
    /* === Delete Butonu (Sil Ã—) === */
    .description-item .delete-btn {
      width: 24px !important;
      height: 24px !important;
      font-size: 14px !important;
      line-height: 20px !important;
      border-radius: 50% !important;
      background: #f8d7da !important;
      color: #d32f2f !important;
      border: none !important;
      cursor: pointer !important;
      transition: all 0.2s ease-in-out !important;
      flex-shrink: 0;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
    
    .description-item .delete-btn:hover {
      background: #d32f2f !important;
      color: #fff !important;
      transform: scale(1.1) !important;
    }
    /* ==== TB util styles (framework-free) ==== */
    .tb-card { border:1px solid #e5e7eb; border-radius:10px; padding:12px; background:#fff; }
    .tb-legend { font-weight:700; color:#1f2937; }
    .tb-check-row { display:grid; grid-template-columns:28px 1fr; gap:12px; align-items:start; cursor:pointer; }
    .tb-check-row input[type="checkbox"]{ width:18px; height:18px; margin-top:2px; }
    .tb-check-title { font-weight:600; color:#111827; }
    .tb-check-desc  { display:block; margin-top:2px; color:#4b5563; font-size:12px; }
    .tb-schedule-fields { margin-top:10px; }
    .tb-field { display:grid; gap:6px; }
    .tb-label { font-size:12px; color:#4b5563; }
    .tb-input { border:1px solid #d1d5db; border-radius:8px; padding:8px 10px; width:100%; }
    .tb-vis-option{ display:grid; grid-template-columns:28px 1fr; gap:12px; align-items:start; padding:10px 8px; border-radius:8px; cursor:pointer; border:1px solid #e5e7eb; margin:4px 0; }
    .tb-vis-option + .tb-vis-option{ margin-top:8px; }
    .tb-vis-option input[type="radio"]{ width:18px; height:18px; margin-top:2px; accent-color:#2563eb; }
    .tb-vis-title{ font-weight:600; color:#111827; line-height:1.2; }
    .tb-vis-desc{ margin-top:4px; color:#4b5563; line-height:1.4; font-size:13px; }
    .tb-vis-option:hover{ background:#f9fafb; }
    .tb-vis-option:has(input[type="radio"]:checked){ background:#E0EDFF; border-color:#2563EB; }
    .tb-vis-option:has(input[type="radio"]:checked) .tb-vis-title,
    .tb-vis-option:has(input[type="radio"]:checked) .tb-vis-desc{ color:#1E3A8A; }
    /* Talep Tipi (biddingMode) seÃ§imlerini kolay tÄ±klanÄ±r ve seÃ§ili vurgulu yap */
    label:has(> input[name="biddingMode"]) { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid #e5e7eb; border-radius:8px; cursor:pointer; margin:4px 6px 4px 0; }
    label:has(> input[name="biddingMode"]:checked) { background:#E0EDFF; border-color:#2563EB; color:#1E3A8A; }
    input[name="biddingMode"]{ width:16px; height:16px; accent-color:#2563eb; }
    /* SÃ¼re seÃ§iliyse aynÄ± vurguyu uygula */
    fieldset.tb-card:has(#isTimeBound:checked){ background:#E0EDFF; border-color:#2563EB; }
    fieldset.tb-card:has(#isTimeBound:checked) .tb-legend, 
    fieldset.tb-card:has(#isTimeBound:checked) .tb-check-title,
    fieldset.tb-card:has(#isTimeBound:checked) label { color:#1E3A8A; }
    /* Advanced item editor overrides inside items table */
    .items-table .adv-input{ width:auto !important; }
    .items-table .adv-key{ width:160px !important; }
    .items-table .adv-val{ min-width:180px !important; }
    .items-table .quickCert, .items-table .addPair, .items-table .addCert{ width:auto !important; display:inline-block; }
    .items-table .quickCert{ color:#111827 !important; background:#f9fafb !important; border:1px solid #d1d5db !important; border-radius:12px !important; padding:4px 8px !important; font-size:12px !important; }
    .import-review{background:#fff7ed !important; box-shadow:0 0 0 2px #fb923c inset;}
  </style>
</head>
<body>
  <!-- Common Header -->
  <header id="app-header"></header>

  <div class="container--wide" style="padding:20px 0">
    <h1 id="pageTitle">Yeni Talep OluÅŸtur</h1>
    

    <!-- Import options: Excel / Word / PDF -->
    <div style="margin:8px 0; display:flex; gap:8px; flex-wrap:wrap;">
      <button type="button" id="btnImportXlsx" class="btn btn-primary">ğŸ“¤ Excel'den Ä°Ã§e Aktar</button>
      <button type="button" id="btnImportDocx" class="btn btn-primary">ğŸ“¤ Word'den Ä°Ã§e Aktar</button>
      <button type="button" id="btnImportPdf"  class="btn btn-primary">ğŸ“¤ PDF'den Ä°Ã§e Aktar</button>
      <input id="fileXlsx" type="file" accept=".xlsx" style="display:none" />
      <input id="fileDocx" type="file" accept=".docx" style="display:none" />
      <input id="filePdf"  type="file" accept=".pdf"  style="display:none" />
    </div>

  <h3>BaÅŸlÄ±k Bilgileri</h3>
  <div class="row">
    <div>
      <label for="satfk">SatÄ±n Alma Talep Formu Kodu (SATFK)</label>
      <div style="display: flex; align-items: center; gap: 8px;">
        <input id="satfk" type="text" readonly style="background:#f9fafb; color:#6b7280; flex: 1; width: 294px;" placeholder="Kod oluÅŸturuluyor..." />
        <button id="copySatfkBtn" class="btn-sm" style="padding: 4px 8px; font-size: 11px; display: none;">ğŸ“‹ Kopyala</button>
        <button id="refreshSatfkBtn" class="btn-sm" style="padding: 4px 8px; font-size: 11px; background: #10b981; color: white;">ğŸ”„ Yenile</button>
      </div>
      <div id="satfkPreview" style="font-size: 12px; color: #6b7280; margin-top: 4px;">
        <span id="satfkStatus">Kod oluÅŸturuluyor...</span>
      </div>
    </div>
  </div>

  <div class="row">
    <div>
      <label for="demandDate">Talep Tarihi *</label>
      <input id="demandDate" type="date" autocomplete="off" required />
    </div>
    <div>
      <label for="siteName">Åantiye *</label>
      <input id="siteName" list="siteNameList" placeholder="Åantiye/Saha adÄ±" autocomplete="off" required />
      <datalist id="siteNameList"></datalist>
    </div>
  </div>

  <div class="row">
    <div>
      <label for="purchaseLocation">AlÄ±m Yeri (Ä°l) *</label>
      <input id="purchaseLocation" list="provinceList" placeholder="Ä°l seÃ§iniz" required />
      <datalist id="provinceList">
        <option value="Adana"></option>
        <option value="AdÄ±yaman"></option>
        <option value="Afyonkarahisar"></option>
        <option value="AÄŸrÄ±"></option>
        <option value="Amasya"></option>
        <option value="Ankara"></option>
        <option value="Antalya"></option>
        <option value="Artvin"></option>
        <option value="AydÄ±n"></option>
        <option value="BalÄ±kesir"></option>
        <option value="Bilecik"></option>
        <option value="BingÃ¶l"></option>
        <option value="Bitlis"></option>
        <option value="Bolu"></option>
        <option value="Burdur"></option>
        <option value="Bursa"></option>
        <option value="Ã‡anakkale"></option>
        <option value="Ã‡ankÄ±rÄ±"></option>
        <option value="Ã‡orum"></option>
        <option value="Denizli"></option>
        <option value="DiyarbakÄ±r"></option>
        <option value="Edirne"></option>
        <option value="ElazÄ±ÄŸ"></option>
        <option value="Erzincan"></option>
        <option value="Erzurum"></option>
        <option value="EskiÅŸehir"></option>
        <option value="Gaziantep"></option>
        <option value="Giresun"></option>
        <option value="GÃ¼mÃ¼ÅŸhane"></option>
        <option value="Hakkari"></option>
        <option value="Hatay"></option>
        <option value="Isparta"></option>
        <option value="Mersin"></option>
        <option value="Ä°stanbul"></option>
        <option value="Ä°zmir"></option>
        <option value="Kars"></option>
        <option value="Kastamonu"></option>
        <option value="Kayseri"></option>
        <option value="KÄ±rklareli"></option>
        <option value="KÄ±rÅŸehir"></option>
        <option value="Kocaeli"></option>
        <option value="Konya"></option>
        <option value="KÃ¼tahya"></option>
        <option value="Malatya"></option>
        <option value="Manisa"></option>
        <option value="KahramanmaraÅŸ"></option>
        <option value="Mardin"></option>
        <option value="MuÄŸla"></option>
        <option value="MuÅŸ"></option>
        <option value="NevÅŸehir"></option>
        <option value="NiÄŸde"></option>
        <option value="Ordu"></option>
        <option value="Rize"></option>
        <option value="Sakarya"></option>
        <option value="Samsun"></option>
        <option value="Siirt"></option>
        <option value="Sinop"></option>
        <option value="Sivas"></option>
        <option value="TekirdaÄŸ"></option>
        <option value="Tokat"></option>
        <option value="Trabzon"></option>
        <option value="Tunceli"></option>
        <option value="ÅanlÄ±urfa"></option>
        <option value="UÅŸak"></option>
        <option value="Van"></option>
        <option value="Yozgat"></option>
        <option value="Zonguldak"></option>
        <option value="Aksaray"></option>
        <option value="Bayburt"></option>
        <option value="Karaman"></option>
        <option value="KÄ±rÄ±kkale"></option>
        <option value="Batman"></option>
        <option value="ÅÄ±rnak"></option>
        <option value="BartÄ±n"></option>
        <option value="Ardahan"></option>
        <option value="IÄŸdÄ±r"></option>
        <option value="Yalova"></option>
        <option value="KarabÃ¼k"></option>
        <option value="Kilis"></option>
        <option value="Osmaniye"></option>
        <option value="DÃ¼zce"></option>
      </datalist>
    </div>
    <div>
      <label for="title">BaÅŸlÄ±k *</label>
      <input id="title" placeholder="Talep baÅŸlÄ±ÄŸÄ±" required />
    </div>
  </div>



  <label for="catInput">Kategori(ler)</label>
  <div id="catWrap">
    <!-- Kategori GruplarÄ± -->
    <div id="categoryGroups" style="margin-bottom: 16px;">
      <h4 style="margin: 8px 0; font-size: 14px; color: #374151;">ğŸ“ Kategori GruplarÄ±</h4>
      
      <!-- Group Management -->
      <div style="display: flex; justify-content: flex-end; margin-bottom: 12px;">
        <button id="btnGroupHub" type="button"
          style="display:flex;align-items:center;gap:8px;padding:10px 14px;border:0;border-radius:8px;
                 background:#2563eb;color:#fff;font-weight:600;cursor:pointer;">
          ğŸ—‚ï¸ Yeni Grup OluÅŸtur / ğŸ› ï¸ GruplarÄ± YÃ¶net
        </button>
      </div>
      
      
      <!-- Group Buttons (Legacy) -->
      <div id="groupButtons" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
        <!-- Grup butonlarÄ± buraya eklenecek -->
      </div>
    </div>
    
    
    <!-- SeÃ§ilen Kategoriler -->
    <div id="catChips"></div>
  </div>

  <!-- Talep GÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ kaldÄ±rÄ±ldÄ±: UI gizlendi -->
  <div style="margin-bottom: 16px; display:none;">
    <h4 style="margin: 8px 0; font-size: 18px; color: #111827;">ğŸ‘ï¸ Talep GÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼</h4>
    <div style="display: flex; gap: 16px; margin-bottom: 12px;">
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="demandVisibility" value="genel" checked style="margin: 0;">
        <span>Genel (tÃ¼m kullanÄ±cÄ±lar)</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="demandVisibility" value="ozel" style="margin: 0;">
        <span>Ã–zel (davetli)</span>
      </label>
    </div>

    <!-- Ã–zel gÃ¶rÃ¼nÃ¼rlÃ¼k ayarlarÄ±: Grup seÃ§imi + davet modu -->
    <div id="privateVisibilitySettings" style="display: none; margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 6px;">
      <h5 style="margin: 0 0 8px 0; font-size: 13px; color: #374151;">Davetliler</h5>

      <!-- Grup seÃ§imi (chip/pill Ã§oklu seÃ§im) -->
      <div style="margin-bottom: 8px;">
        <div style="font-size:12px; color:#374151; margin-bottom:4px;">TedarikÃ§i GruplarÄ±</div>
        <div id="inviteGroupPicker" style="display:flex; flex-wrap: wrap; gap:8px;"></div>
        <div style="font-size:12px; color:#6b7280; margin-top:4px;">SeÃ§tiÄŸiniz gruplardaki firmalar otomatik davet edilir.</div>
      </div>

      <!-- Davet modu seÃ§imleri -->
      <div style="display:flex; gap:16px; align-items:center; margin: 8px 0;">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
          <input type="radio" name="inviteMode" value="auto" checked style="margin:0;" />
          <span>Gruba gÃ¶re otomatik</span>
        </label>
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
          <input type="radio" name="inviteMode" value="custom" style="margin:0;" />
          <span>Ã–zelleÅŸtir (firma seÃ§)</span>
        </label>
      </div>

      <!-- Otomatik Ã¶zet (sadece sayÄ±) -->
      <div id="autoInviteSummary" style="display:block; font-size:12px; color:#374151;">
        Otomatik davetli sayÄ±sÄ±: <span id="autoInviteCount">0</span>
        <button type="button" id="loadGroupMembersBtn" class="btn-sm" style="margin-left:8px;">Grup Ãœyelerini YÃ¼kle</button>
      </div>

      <!-- Ã–zelleÅŸtir: mevcut tedarikÃ§i seÃ§imi bileÅŸeni -->
      <div id="customInviteEditor" style="display:none; margin-top:8px;">
        <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">Grup listesini baÅŸlangÄ±Ã§ olarak kullanmak iÃ§in "Grup Ãœyelerini YÃ¼kle" deyip aÅŸaÄŸÄ±dan dÃ¼zenleyin.</div>
        <button type="button" id="selectSuppliersBtn" style="padding: 8px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
          ğŸ‘¥ TedarikÃ§i SeÃ§
        </button>
        <div id="selectedSuppliers" style="margin-top: 8px; font-size: 12px; color: #6b7280;">
          HenÃ¼z tedarikÃ§i seÃ§ilmedi
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div>
      <label for="dueDate">Termin Tarihi *</label>
      <input id="dueDate" type="date" required />
    </div>
    <div>
      <label for="priority">Ã–ncelik *</label>
      <select id="priority" required>
        <option value="price">Fiyat</option>
        <option value="speed">HÄ±z</option>
        <option value="quality">Kalite</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div>
      <label for="currency">Para Birimi *</label>
      <select id="currency" required>
        <option>TRY</option><option>USD</option><option>EUR</option>
      </select>
    </div>
    <div>
      <label for="paymentTerms">Ã–deme ÅartlarÄ±</label>
      <input id="paymentTerms" placeholder="Ã¶rn. %50 peÅŸin" />
    </div>
    <div style="align-self:end;">
      <button id="btnOpenPaymentBuyer" type="button" class="btn btn-primary">Ã–deme SeÃ§enekleriâ€¦</button>
    </div>
  </div>

  <!-- Payment Modal (Buyer) -->
  <div id="paymentModalBuyer" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1100;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:min(900px,96vw); max-height:90vh; overflow:auto; background:#fff; border-radius:8px; padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center; margin-bottom:8px;">
        <h3 style="margin:0;">Ã–deme SeÃ§enekleri</h3>
        <button id="closePaymentBuyer" class="btn" style="padding:6px 10px; background:#ef4444; color:#fff;">Kapat</button>
      </div>
      <section id="payment-section" class="payment">
        <style>
          .hidden{display:none!important}
          #payment-section .row{display:grid;grid-template-columns:180px 1fr;gap:12px;align-items:center;margin:8px 0}
          #payment-section fieldset{border:1px solid #e5e7eb;border-radius:8px;padding:8px;margin:10px 0}
          #payment-section fieldset legend{font-weight:600}
          #payment-section #payment-type{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:8px 12px;align-items:center}
          #payment-section label{font-size:14px;color:#111827}
          #payment-section #payment-type label{display:inline-flex;align-items:center;gap:8px;margin:0;font-size:16px;font-weight:600}
          #payment-section input[type="radio"]{width:16px;height:16px;accent-color:#2563eb}
          #payment-section h4{margin:8px 0 6px 0}
          #payment-section .group{padding:10px;border:1px solid #f3f4f6;border-radius:8px;background:#fafafa;margin-top:8px}
          #payment-section #pesin-group label{display:inline-flex;align-items:center;gap:8px;margin:4px 12px 4px 0;font-weight:600;font-size:15px}
          #payment-section .desc{font-size:12.5px;color:#4b5563;margin-top:6px;line-height:1.4}
          #payment-section .hint{font-size:12px;color:#6b7280}
          @media (max-width:640px){#payment-section #payment-type{grid-template-columns:repeat(2,minmax(140px,1fr))}}
        </style>
        <h3>Ã–deme SeÃ§enekleri</h3>
        <fieldset id="payment-type"><legend>Ã–deme Tipi</legend><label><input type="radio" name="paymentType" value="pesin" /> PeÅŸin</label><label><input type="radio" name="paymentType" value="krediKarti" /> Kredi KartÄ±</label><label><input type="radio" name="paymentType" value="acikHesap" /> AÃ§Ä±k Hesap</label><label><input type="radio" name="paymentType" value="evrak" /> Evrak (Ã§ek/senet)</label></fieldset>
        <div class="row"><label>KDV Dahil Toplam</label><span id="ccBaseIncl">â€”</span></div>
        <div id="pesin-group" class="group hidden"><h4>PeÅŸin Alt Model</h4><label><input type="radio" name="pesinModel" value="escrow"> (a) Escrow</label><label><input type="radio" name="pesinModel" value="onayli"> (b) Teslim & Onay</label><label><input type="radio" name="pesinModel" value="onodeme"> (c) Ã–n Ã–deme</label><div class="desc">(a) Escrow: Ã–deme blokeli hesapta tutulur; alÄ±cÄ± teslim onayÄ± sonrasÄ± serbest kalÄ±r.<br>(b) Teslim & Onay: AlÄ±cÄ± teslimi onayladÄ±ktan sonra Ã¶deme yapÄ±lÄ±r.<br>(c) Ã–n Ã–deme: Belirtilen oran kadar Ã¶n Ã¶deme sonrasÄ± Ã¼retim/sevkiyat baÅŸlar.</div><div id="prepayment-config" class="row hidden"><label>Ã–n Ã–deme OranÄ± (%)</label><input type="number" id="prepaymentRate" min="0" max="100" step="1" value="30"></div></div>
        <div id="kk-group" class="group hidden"><h4>Kredi KartÄ±</h4><div class="row"><label>Taksit SayÄ±sÄ±</label><input id="installments" type="number" min="1" value="1" style="width:100px"><label>Vade FarkÄ± (%)</label><input type="number" id="financeRate" value="0" min="0" step="0.01"><label>Kampanya / AÃ§Ä±klama</label><input id="ccCampaign" placeholder="â€¦"></div><div class="row calc"><div>Vade TutarÄ±: <span id="ccFinanceAmt">â€”</span></div><div>Toplam (KDV Dahil): <span id="ccTotalIncl">â€”</span></div><div>AylÄ±k Taksit: <span id="ccMonthly">â€”</span></div></div></div>
        <div id="ah-group" class="group hidden"><h4>AÃ§Ä±k Hesap</h4><div class="row"><label>Fatura Tarihi</label><input type="date" id="invoiceDate"><label>Vade (GÃ¼n)</label><select id="netDays"><option value="7">+7 gÃ¼n</option><option value="15">+15 gÃ¼n</option><option value="30">+30 gÃ¼n</option><option value="45">+45 gÃ¼n</option><option value="60">+60 gÃ¼n</option></select><input id="netDaysCustom" type="number" min="1" placeholder="Ã–zel vade gÃ¼nÃ¼ (Ã¶rn. 53)" style="width:160px"><span class="hint" style="font-size:13px;">Ã–zel vade gÃ¼nÃ¼ yazÄ±nca tarih otomatik hesaplanÄ±r (hafta sonu Pazartesi).</span></div><div class="row calc"><div>Vade Tarihi: <span id="dueDateHuman">â€”</span></div></div></div>
        <div id="evrak-group" class="group hidden"><h4>Evrak (Ã§ek/senet)</h4><div style="margin-bottom:8px;"><button id="btnAddCheck" class="btn btn-secondary" style="padding:6px 10px;">+ Ã‡ek Ekle</button></div><div id="checksBody"></div></div>
        <hr><div id="summary" class="summary"></div><button id="savePayment" class="btn btn-primary" style="margin-top:8px;">Kaydet</button>
      </section>
    </div>
  </div>

  <script type="module">
    const openBtn = document.getElementById('btnOpenPaymentBuyer');
    const modal = document.getElementById('paymentModalBuyer');
    const closeBtn = document.getElementById('closePaymentBuyer');
    const paymentTermsInput = document.getElementById('paymentTerms');
    let selectedPaymentPrefBuyer = null;
    
    // Helper function to format payment summary text
    function formatPaymentSummary(payload) {
      if (!payload || !payload.paymentType) return '';
      
      const parts = [];
      
      switch (payload.paymentType) {
        case 'pesin':
          parts.push('PeÅŸin');
          if (payload.pesin?.model === 'escrow') parts.push('(Escrow)');
          else if (payload.pesin?.model === 'onayli') parts.push('(Teslim & Onay)');
          else if (payload.pesin?.model === 'onodeme' && payload.pesin?.prepaymentRate) {
            parts.push(`%${payload.pesin.prepaymentRate} Ã¶n Ã¶deme`);
          }
          break;
          
        case 'krediKarti':
          parts.push('Kredi KartÄ±');
          if (payload.krediKarti?.installments > 1) {
            parts.push(`${payload.krediKarti.installments} taksit`);
          }
          if (payload.krediKarti?.financeRate > 0) {
            parts.push(`%${payload.krediKarti.financeRate} vade farkÄ±`);
          }
          if (payload.krediKarti?.campaign) {
            parts.push(`(${payload.krediKarti.campaign})`);
          }
          break;
          
        case 'acikHesap':
          parts.push('AÃ§Ä±k Hesap');
          if (payload.acikHesap?.netDays) {
            parts.push(`+${payload.acikHesap.netDays} gÃ¼n vade`);
          }
          if (payload.acikHesap?.invoiceDate) {
            parts.push(`(Fatura: ${payload.acikHesap.invoiceDate})`);
          }
          break;
          
        case 'evrak':
          parts.push('Evrak (Ã§ek/senet)');
          if (payload.evrak?.checks && Array.isArray(payload.evrak.checks)) {
            const checkCount = payload.evrak.checks.length;
            const totalAmount = payload.evrak.checks.reduce((sum, c) => sum + (Number(c.amount) || 0), 0);
            if (checkCount > 0) {
              parts.push(`${checkCount} Ã§ek`);
              if (totalAmount > 0) {
                parts.push(`Toplam: ${totalAmount.toFixed(2)} â‚º`);
              }
            }
          }
          break;
      }
      
      return parts.filter(Boolean).join(' - ');
    }
    
    openBtn?.addEventListener('click', async ()=>{ 
      modal.style.display = 'block'; 
      if (!window.paymentModule){ 
        try{ 
          await import('/scripts/payment-module.js'); 
        }catch(_){} 
      } 
      if (window.paymentModule){ 
        window.paymentModule.setRole('buyer'); 
        try{ 
          window.paymentModule.setTotals({ totalIncl: 0 }); 
        }catch(_){} 
      } 
    });
    
    closeBtn?.addEventListener('click', ()=> modal.style.display = 'none');
    
    // FIX: Update paymentTerms input when payment is saved
    document.addEventListener('payment:save', (e)=>{
      selectedPaymentPrefBuyer = e.detail;
      modal.style.display = 'none';
      
      // Format payment summary and set to paymentTerms input
      const summaryText = formatPaymentSummary(e.detail);
      if (summaryText && paymentTermsInput) {
        paymentTermsInput.value = summaryText;
      }
    });
    
    // Expose to header builder
    window.__getBuyerPaymentPref = ()=> selectedPaymentPrefBuyer;
  </script>



  <h3>Talep Tipi</h3>
  <div style="margin:16px 0; padding:16px; background:#f9fafb; border-radius:6px;">
    <div style="margin-bottom:12px;">
      <label style="display:block; margin-bottom:8px;">
        <input type="radio" name="biddingMode" value="secret" checked /> 
        <strong>Gizli Teklif (tek tur)</strong>
      </label>
      <p style="margin:0 0 12px 24px; font-size:13px; color:#6b7280;">TedarikÃ§iler yalnÄ±z kendi tekliflerini gÃ¶rebilir. DiÄŸer teklifleri gÃ¶remez.</p>
      
      <label style="display:block; margin-bottom:8px;">
        <input type="radio" name="biddingMode" value="open" /> 
        <strong>AÃ§Ä±k Teklif (tek tur)</strong>
      </label>
      <p style="margin:0 0 12px 24px; font-size:13px; color:#6b7280;">TÃ¼m fiyatlar ve tedarikÃ§i isimleri gÃ¶rÃ¼nÃ¼r. Tam ÅŸeffaflÄ±k saÄŸlar.</p>
      
      <label style="display:block; margin-bottom:8px;">
        <input type="radio" name="biddingMode" value="hybrid" /> 
        <strong>Hibrit (1. tur gizli, 2. tur aÃ§Ä±k)</strong>
      </label>
      <p style="margin:0 0 12px 24px; font-size:13px; color:#6b7280;">Ä°lk turda gizli teklifler alÄ±nÄ±r, ikinci turda aÃ§Ä±k artÄ±rma yapÄ±lÄ±r. En iyi sonuÃ§lar iÃ§in.</p>
      
      <!-- Hibrit mod iÃ§in 1. tur sÃ¼resi -->
      <div id="hybridSettings" style="display:none; margin-left:24px; padding:12px; background:#f0f9ff; border-radius:6px; border:1px solid #0ea5e9;">
        <h4 style="margin:0 0 8px 0; font-size:14px; color:#0c4a6e;">1. Tur AyarlarÄ±</h4>
        <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px;">
          <label style="font-size:13px; color:#0c4a6e;">1. Tur SÃ¼resi:</label>
          <input type="number" id="firstRoundDays" min="1" max="30" value="7" style="width:60px; padding:4px; border:1px solid #0ea5e9; border-radius:4px;" />
          <span style="font-size:13px; color:#0c4a6e;">gÃ¼n</span>
        </div>
        <div style="display:flex; gap:12px; align-items:center;">
          <label style="font-size:13px; color:#0c4a6e;">2. Turda TedarikÃ§i Ä°simleri:</label>
          <select id="secondRoundSupplierVisibility" style="padding:4px; border:1px solid #0ea5e9; border-radius:4px;">
            <option value="visible">GÃ¶rÃ¼nÃ¼r</option>
            <option value="hidden">Gizli</option>
          </select>
        </div>
        <div style="display:flex; gap:12px; align-items:center; margin-top:8px;">
          <label style="font-size:13px; color:#0c4a6e;">2. Tur SÃ¼resi:</label>
          <input type="number" id="secondRoundDays" min="1" max="30" value="7" style="width:60px; padding:4px; border:1px solid #0ea5e9; border-radius:4px;" />
          <span style="font-size:13px; color:#0c4a6e;">gÃ¼n</span>
        </div>
        <p style="margin:8px 0 0 0; font-size:12px; color:#0c4a6e;">1. tur bitince otomatik olarak 2. tur aÃ§Ä±lÄ±r ve aÃ§Ä±k artÄ±rma baÅŸlar.</p>
      </div>
    </div>
    
    <fieldset class="tb-card" style="margin-top:16px;">
      <legend class="tb-legend">SÃ¼re</legend>
      <label class="tb-check-row">
        <input type="checkbox" id="isTimeBound" />
        <span class="tb-check-body">
          <span class="tb-check-title">SÃ¼reli (BaÅŸlangÄ±Ã§ ve BitiÅŸ Tarihi Belirle)</span>
          <span id="scheduleHint" class="tb-check-desc">SeÃ§ilmezse talep ÅŸimdi baÅŸlar ve manuel olarak kapatÄ±lana kadar devam eder.</span>
        </span>
      </label>

      <div id="timeBoundFields" class="tb-schedule-fields" hidden>
        <!-- For secret/open modes -->
        <div id="singlePhaseTime" style="margin-top:12px;">
          <div class="row">
            <div>
              <label for="phaseStart">BaÅŸlangÄ±Ã§</label>
              <input type="datetime-local" id="phaseStart" />
            </div>
            <div>
              <label for="phaseEnd">BitiÅŸ</label>
              <input type="datetime-local" id="phaseEnd" />
            </div>
          </div>
        </div>
        
        <!-- For hybrid mode -->
        <div id="hybridPhaseTime" style="display:none; margin-top:12px;">
          <h4 style="margin:0 0 8px 0; font-size:14px;">1. Tur (Gizli)</h4>
          <div class="row">
            <div>
              <label for="round1Start">BaÅŸlangÄ±Ã§</label>
              <input type="datetime-local" id="round1Start" />
            </div>
            <div>
              <label for="round1End">BitiÅŸ</label>
              <input type="datetime-local" id="round1End" />
            </div>
          </div>
          
          <h4 style="margin:12px 0 8px 0; font-size:14px;">2. Tur (AÃ§Ä±k)</h4>
          <div class="row">
            <div>
              <label for="round2Start">BaÅŸlangÄ±Ã§</label>
              <input type="datetime-local" id="round2Start" />
            </div>
            <div>
              <label for="round2End">BitiÅŸ</label>
              <input type="datetime-local" id="round2End" />
            </div>
          </div>
        </div>
      </div>
    </fieldset>

    <!-- HariÃ§ tut alanÄ± kaldÄ±rÄ±ldÄ± -->

  <fieldset class="tb-card" style="margin-top:12px;">
    <legend class="tb-legend">Ana Talep EkranÄ±nda GÃ¶rÃ¼nÃ¼rlÃ¼k</legend>
    <label class="tb-vis-option">
      <input type="radio" name="mainDemandVisibility" value="private" checked />
      <div class="tb-vis-body">
        <div class="tb-vis-title">Ã–zel Talep: Sadece belirtilen tedarikÃ§iler gÃ¶rebilir</div>
        <p class="tb-vis-desc">Talep sadece size Ã¶zel olarak belirtilen tedarikÃ§ilere gÃ¶nderilir.</p>
      </div>
    </label>
    <label class="tb-vis-option">
      <input type="radio" name="mainDemandVisibility" value="main" />
      <div class="tb-vis-body">
        <div class="tb-vis-title">Ana Ekranda GÃ¶ster: TÃ¼m tedarikÃ§iler ana talep ekranÄ±nda gÃ¶rebilir</div>
        <p class="tb-vis-desc">Talep ana talep ekranÄ±nda gÃ¶rÃ¼nÃ¼r ve tedarikÃ§iler Ã¼rÃ¼n bazlÄ± arama yaparak bulabilir.</p>
      </div>
    </label>
  </fieldset>

  <h3>ÃœrÃ¼n Kalemleri</h3>
  <button type="button" id="addLineBtn" class="btn-sm">+ SatÄ±r Ekle</button>
  <div class="table-responsive">
    <table class="items-table" id="itemsTable">
    <thead>
      <tr>
        <th style="width: 60px;">SÄ±ra No</th>
        <th style="width: 120px;">Malzeme Kodu</th>
        <th style="width: 300px;">Malzeme TanÄ±mÄ± *</th>
        <th style="width: 120px;">Marka/Model</th>
        <th style="width: 108px;">Miktar *</th>
        <th style="width: 136px;">Birim *</th>
        <th style="width: 100px;">Depodaki Miktar</th>
        <th style="width: 100px;">Hedef Fiyat (TL)</th>
        <th style="width: 160px;">ÃœrÃ¼n GÃ¶rseli</th>
        <th style="width: 120px;">Ä°stenilen Teslim Tarihi</th>
        <th style="width: 60px;">Sil</th>
      </tr>
    </thead>
    <tbody id="itemsBody"></tbody>
    </table>
  </div>

  <!-- AÃ§Ä±klama BÃ¶lÃ¼mÃ¼ (ÃœrÃ¼n Kalemlerinin AltÄ±nda) -->
  <h3>AÃ§Ä±klama</h3>
  <div style="margin-bottom: 16px;">
    <label for="spec">Teknik Åart / AÃ§Ä±klama</label>
    <div style="margin-bottom: 12px;">
      <div style="display: flex; gap: 8px; margin-bottom: 8px;">
        <button type="button" id="addDescriptionBtn" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
          â• AÃ§Ä±klama Ekle
        </button>
        <button type="button" id="clearDescriptionsBtn" style="padding: 6px 12px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
          ğŸ—‘ï¸ Temizle
        </button>
      </div>
      <div id="descriptionsContainer">
        <!-- Dinamik aÃ§Ä±klama alanlarÄ± buraya eklenecek -->
      </div>
    </div>
  </div>

  <!-- Onay KiÅŸileri BÃ¶lÃ¼mÃ¼ -->
  <h3>Onay KiÅŸileri</h3>
  <div class="row">
    <div>
      <label for="requester">Talep Eden *</label>
      <input id="requester" placeholder="Åantiye/Depo/Mutfak yetkilisi adÄ± soyadÄ±" required />
    </div>
    <div>
      <label for="purchaseManager">SatÄ±n Alma Yetkilisi</label>
      <input id="purchaseManager" placeholder="SatÄ±n alma yetkilisi adÄ± soyadÄ±" />
    </div>
  </div>
  
  <div class="row">
    <div>
      <label for="generalManager">Genel MÃ¼dÃ¼r</label>
      <input id="generalManager" placeholder="Genel mÃ¼dÃ¼r adÄ± soyadÄ±" />
    </div>
    <div>
      <label for="approver">Onay Veren</label>
      <input id="approver" placeholder="Onay veren kiÅŸinin adÄ± soyadÄ±" />
    </div>
  </div>

  <!-- Teslim Åekli BÃ¶lÃ¼mÃ¼ -->
  <h3>Teslim Åekli *</h3>
  <div style="margin-bottom: 16px;">
    <div style="display: flex; gap: 16px; margin-bottom: 12px; flex-wrap: wrap;">
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="deliveryMethod" value="nakliye_dahil" style="margin: 0;">
        <span>ğŸšš Nakliye Dahil</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="deliveryMethod" value="nakliye_haric" style="margin: 0;">
        <span>ğŸ“¦ Nakliye HariÃ§</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="deliveryMethod" value="custom" style="margin: 0;">
        <span>âœï¸ Ã–zel Teslimat</span>
      </label>
    </div>
    <div id="customDeliveryContainer" style="display: none; margin-top: 12px;">
      <label for="customDelivery">Ã–zel Teslimat AÃ§Ä±klamasÄ± *</label>
      <input id="customDelivery" placeholder="Ã–zel teslimat talebinizi yazÄ±n" />
    </div>
    <div style="margin-top: 12px;">
      <label for="deliveryMethodCustom">Teslim Åekli (Elle Yaz) *</label>
      <input id="deliveryMethodCustom" placeholder="Teslim ÅŸeklini elle yazÄ±n" required />
      <p class="muted" style="margin-top:4px; font-size: 12px; color: #6b7280;">YukarÄ±daki seÃ§eneklerden birini seÃ§in veya elle yazÄ±n</p>
    </div>
  </div>

  <!-- Teslimat Adresi BÃ¶lÃ¼mÃ¼ -->
  <h3>Teslimat Adresi</h3>
  <div style="margin-bottom: 16px;">
    <div style="display: flex; gap: 12px; margin-bottom: 12px; align-items: center; flex-wrap: wrap;">
      <label for="deliveryAddressSelect" style="font-weight: 600; min-width: 120px;">Adres SeÃ§imi:</label>
      <select id="deliveryAddressSelect" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; min-width: 250px; flex: 1;">
        <option value="">BaÅŸlÄ±k seÃ§in</option>
      </select>
      <button type="button" id="refreshAddressesBtn" style="padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
        ğŸ”„ Yenile
      </button>
    </div>
    <div id="deliveryAddressContainer" style="display: block !important; margin-top: 12px; visibility: visible !important; opacity: 1 !important;">
      <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: flex-start; flex-wrap: wrap;">
        <textarea id="deliveryAddress" placeholder="Teslimat adresini yazÄ±n veya yukarÄ±dan seÃ§in" rows="3" style="flex: 1; min-width: 300px; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; max-height: 200px; resize: vertical; overflow-y: auto; font-family: inherit; font-size: 14px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;"></textarea>
        <button type="button" id="verifyDeliveryAddressBtn" style="padding: 10px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; white-space: nowrap; height: fit-content;">
          ğŸ“ Harita ile DoÄŸrula
        </button>
      </div>
      <div id="deliveryAddressVerified" style="display: none; padding: 8px 12px; background: #f0fdf4; border: 1px solid #10b981; border-radius: 6px; font-size: 12px; color: #065f46;">
        <span style="font-weight: 600;">âœ” Adres doÄŸrulandÄ±</span>
        <span id="deliveryAddressCoords" style="margin-left: 8px; color: #6b7280;"></span>
      </div>
      <!-- Gizli alanlar: koordinatlar -->
      <input type="hidden" id="delivery_lat" />
      <input type="hidden" id="delivery_lng" />
    </div>
  </div>

  <!-- Talep OluÅŸtur Butonu -->
  <div style="margin: 32px 0; text-align: center;">
    <button type="button" id="createBtn" class="btn btn-primary" style="padding: 16px 32px; font-size: 18px; font-weight: 600;">
      ğŸ“ Talep OluÅŸtur
    </button>
  </div>


  <!-- Onay Modal -->
  <div id="approvalModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
      <div style="text-align: center; margin-bottom: 20px;">
        <h2 style="margin: 0 0 10px 0; color: #1f2937;">ğŸ‰ Talep BaÅŸarÄ±yla OluÅŸturuldu!</h2>
        <p style="margin: 0; color: #6b7280;">SATFK: <strong id="approvalDemandCode">-</strong></p>
      </div>
      
      <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
        <h3 style="margin: 0 0 12px 0; color: #0c4a6e; font-size: 16px;">ğŸ“‹ Son Kontrol</h3>
        <p style="margin: 0; color: #0c4a6e; font-size: 14px;">
          Talebinizi son kez kontrol edin. OnayladÄ±ktan sonra talep ilgili tedarikÃ§i firmalara gÃ¶nderilecektir.
        </p>
      </div>
      
      <div style="display: flex; gap: 12px; justify-content: center;">
        <button id="approveDemandBtn" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
          âœ… Talebi Onayla ve GÃ¶nder
        </button>
        <button id="saveAsDraftBtn" style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
          ğŸ’¾ Taslak Olarak Kaydet
        </button>
        <button id="editDemandBtn" style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
          âœï¸ DÃ¼zenle
        </button>
      </div>
      
      <div style="margin-top: 16px; text-align: center;">
        <button id="closeApprovalModalBtn" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">
          âœ• Kapat
        </button>
      </div>
    </div>
  </div>

  <!-- Main Script (legacy header setup - can be removed if setupHeader is not needed) -->
  <script type="module">
    import { setupHeader } from "./src/common-company.js";
    
    // Setup common header functionality (logout and company name)
    await setupHeader();

    // Handle main demand visibility radio buttons
    document.querySelectorAll('input[name="mainDemandVisibility"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const mainDemandFields = document.getElementById('mainDemandFields');
        if (!mainDemandFields) return; // Opsiyonel alan yoksa atla
        if (this.value === 'main') {
          mainDemandFields.style.display = 'block';
        } else {
          mainDemandFields.style.display = 'none';
        }
      });
    });
  </script>

  <!-- Import inline script (preview + commit modal) -->
  <script type="module">
    // Teklifbul Rule v1.0 - Structured Logging
    import { logger } from './src/shared/log/logger.js';
    // Teklifbul Rule v1.0 - Toast Notification System
    import { toast } from './src/shared/ui/toast.js';
    // Teklifbul Rule v1.1 - MESSAGES constants (i18n hazÄ±rlÄ±ÄŸÄ±)
    import { MESSAGES } from './src/shared/constants/messages.js';
    
    const $ = (s)=>document.querySelector(s);
    const btnX = $('#btnImportXlsx');
    const btnD = $('#btnImportDocx');
    const btnP = $('#btnImportPdf');
    const fX = $('#fileXlsx');
    const fD = $('#fileDocx');
    const fP = $('#filePdf');

    btnX?.addEventListener('click', (e)=>{ e.preventDefault(); if (fX){ fX.value=''; fX.click(); }});
    btnD?.addEventListener('click', (e)=>{ e.preventDefault(); if (fD){ fD.value=''; fD.click(); }});
    btnP?.addEventListener('click', (e)=>{ e.preventDefault(); if (fP){ fP.value=''; fP.click(); }});

    // Teklifbul Rule v1.0 - Import sistemi iyileÅŸtirmeleri
    async function previewSelected(file, fileType){
      if (!file) return;
      
      try {
        // Dosya boyutu kontrolÃ¼ (10MB limit)
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
        if (file.size > MAX_FILE_SIZE) {
          toast.error(MESSAGES.ERROR_FILE_SIZE_10MB);
          return;
        }
        
        // Dosya format kontrolÃ¼
        const allowedTypes = {
          xlsx: ['.xlsx', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'],
          docx: ['.docx', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'],
          pdf: ['.pdf', 'application/pdf']
        };
        
        if (fileType) {
          const type = allowedTypes[fileType];
          const fileName = file.name.toLowerCase();
          const fileMimeType = file.type;
          
          if (type && !type.some(t => fileName.endsWith(t) || fileMimeType.includes(t))) {
            toast.error(MESSAGES.WARN_FILE_TYPE + ': ' + fileType.toUpperCase());
            return;
          }
        }
        
        // Loading state baÅŸlat
        const allButtons = [btnX, btnD, btnP].filter(Boolean);
        const originalTexts = allButtons.map(btn => btn.textContent);
        allButtons.forEach(btn => {
          btn.disabled = true;
          btn.textContent = 'â³ YÃ¼kleniyor...';
        });
        
        // Dosya bilgisi
        logger.info('Dosya yÃ¼kleniyor', { 
          name: file.name, 
          size: `${(file.size / 1024).toFixed(2)} KB`,
          type: fileType || 'unknown'
        });
        
        const fd = new FormData();
        fd.append('file', file);
        const r = await fetch('/api/import/preview', { method: 'POST', body: fd });
        
        let j = null;
        try {
          j = await r.json();
        } catch (_) {
          j = null;
        }
        
        if (!r.ok) {
          const errorCode = j?.error || 'unknown_error';
          const errorMessages = {
            'file_missing': 'Dosya seÃ§ilmedi. LÃ¼tfen bir dosya seÃ§in.',
            'empty_file': 'Dosya boÅŸ gÃ¶rÃ¼nÃ¼yor. LÃ¼tfen geÃ§erli bir dosya seÃ§in.',
            'unsupported_format': 'Desteklenmeyen dosya formatÄ±. LÃ¼tfen .xlsx, .docx veya .pdf formatÄ±nda bir dosya seÃ§in.',
            'parse_error': 'Dosya okunamadÄ±. LÃ¼tfen dosyanÄ±n bozuk olmadÄ±ÄŸÄ±ndan emin olun.',
            'file_too_large': 'Dosya Ã§ok bÃ¼yÃ¼k. Maksimum boyut: 10MB'
          };
          
          const userMessage = errorMessages[errorCode] || (j?.details || j?.error || 'Ã–nizleme hatasÄ±');
          logger.error('Import hatasÄ±', { errorCode, details: j });
          toast.error(userMessage);
          return;
        }
        
        // BaÅŸarÄ±lÄ± Ã¶nizleme
        logger.info('Dosya baÅŸarÄ±yla yÃ¼klendi', { 
          itemsCount: j?.items?.length || 0,
          confidence: j?.confidence || 0
        });
        
          if (window.applyImportPreview) {
          window.applyImportPreview(j);
          const itemsCount = j?.items?.length || 0;
          toast.success(`${MESSAGES.SUCCESS_FILE_IMPORTED}. ${MESSAGES.SUCCESS_ITEMS_ADDED_COUNT.replace('{n}', String(itemsCount))}.`);
        } else {
          logger.warn('applyImportPreview fonksiyonu bulunamadÄ±');
          toast.warn(MESSAGES.WARN_PREVIEW_DATA);
        }
        
      } catch (e) {
        logger.error('Import hatasÄ±', e);
        toast.error(MESSAGES.ERROR_IMPORT + ': ' + (e.message || e));
      } finally {
        // Loading state bitir
        const allButtons = [btnX, btnD, btnP].filter(Boolean);
        const originalTexts = {
          xlsx: 'ğŸ“¤ Excel\'den Ä°Ã§e Aktar',
          docx: 'ğŸ“¤ Word\'den Ä°Ã§e Aktar',
          pdf: 'ğŸ“¤ PDF\'den Ä°Ã§e Aktar'
        };
        
        allButtons.forEach((btn, idx) => {
          btn.disabled = false;
          if (btn === btnX) btn.textContent = originalTexts.xlsx;
          else if (btn === btnD) btn.textContent = originalTexts.docx;
          else if (btn === btnP) btn.textContent = originalTexts.pdf;
        });
      }
    }

    fX?.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (file) {
        toast.info(`${MESSAGES.INFO_FILE_SELECTED_BY_TYPE.replace('{type}', 'Excel')}: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
        previewSelected(file, 'xlsx');
      }
    });
    
    fD?.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (file) {
        toast.info(`${MESSAGES.INFO_FILE_SELECTED_BY_TYPE.replace('{type}', 'Word')}: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
        previewSelected(file, 'docx');
      }
    });
    
    fP?.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (file) {
        toast.info(`${MESSAGES.INFO_FILE_SELECTED_BY_TYPE.replace('{type}', 'PDF')}: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
        previewSelected(file, 'pdf');
      }
    });
  </script>

  <datalist id="unitList">
    <option>adet</option><option>paket</option><option>kutu</option><option>koli</option>
    <option>set</option><option>Ã§ift</option><option>parÃ§a</option><option>kg</option>
    <option>g</option><option>ton</option><option>lt</option><option>ml</option>
    <option>m</option><option>cm</option><option>mm</option><option>mÂ²</option>
  <option>mÂ³</option><option>rulo</option><option>sac</option><option>tabaka</option>
  <option>sheet</option><option>kangal</option><option>varil</option><option>kova</option>
  <option>bidon</option><option>kase</option><option>torba</option><option>Ã§arÅŸaf</option>
</datalist>

<!-- TedarikÃ§i SeÃ§im ModalÄ± -->
<div id="supplierSelectionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; padding: 24px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0; font-size: 18px; color: #1f2937;">ğŸ‘¥ TedarikÃ§i SeÃ§imi</h3>
      <button type="button" id="closeSupplierModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
    </div>
    
    <div style="margin-bottom: 16px;">
      <input type="text" id="supplierSearch" placeholder="TedarikÃ§i ara..." style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
    </div>
    
    <div id="supplierList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px;">
      <!-- TedarikÃ§i listesi buraya eklenecek -->
    </div>
    
    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span id="selectedCount" style="font-size: 14px; color: #6b7280;">SeÃ§ilen: 0 tedarikÃ§i</span>
        <div style="display: flex; gap: 8px;">
          <button type="button" id="cancelSupplierSelection" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">Ä°ptal</button>
          <button type="button" id="confirmSupplierSelection" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">SeÃ§imi Onayla</button>
        </div>
      </div>
    </div>
  </div>
</div>

  <script type="module">
    import { initGlobalHeader } from './assets/js/ui/header.js';
    import { initAutoResize, reinitAutoResize } from './assets/js/ui/auto-resize.js';
    import { requireAuth, db } from "./firebase.js";
    // Teklifbul Rule v1.0 - Structured Logging
    import { logger } from './src/shared/log/logger.js';
    // Teklifbul Rule v1.0 - Toast Notification System
    import { toast } from './src/shared/ui/toast.js';
    // Teklifbul Rule v1.1 - MESSAGES constants (i18n hazÄ±rlÄ±ÄŸÄ±)
    import { MESSAGES } from './src/shared/constants/messages.js';
    import { slugifyTr } from "./utils/slugify-tr.js";
    // CRITICAL: Import new ID-based category system
    import { 
      normalizeToIds, 
      getNameById, 
      getAllCategories,
      getIdByName,
      getIdBySlug 
    } from "./src/categories/category-service.js";
    
    // Legacy imports (for backward compatibility during transition)
    import { CATEGORIES, getCategoryIdByName, getCategoryNameById, getAllCategoryIds } from "./categories.js";
    import { addDoc, collection, serverTimestamp, updateDoc, doc, query, where, getDocs, getDoc, deleteDoc, orderBy, arrayUnion } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { listGroupsForUser, createGroup, updateGroup, deleteGroup } from "./assets/js/services/category-groups.js";
    // Modal artÄ±k otomatik olarak yÃ¼kleniyor - import gerekmiyor
    // SATFK generation moved to Cloud Functions

    // Initialize global header
    initGlobalHeader({ mount: '#app-header', activeRoute: 'new' });

    // CRITICAL: New ID-based category system
    // Use normalizeToIds from category-service.js for all conversions
    function nameToCategoryId(name) {
      if (!name) return null;
      // Use new normalizeToIds function which handles all formats (ID/name/slug)
      const ids = normalizeToIds([name]);
      return ids.length > 0 ? ids[0] : null;
    }
    
    // Convert category ID to display name (using new system)
    function categoryIdToName(id) {
      if (!id) return id;
      // Try new system first
      const name = getNameById(id);
      if (name && name !== id) return name;
      // Fallback to legacy system
      const legacyName = getCategoryNameById(id);
      return legacyName || id;
    }
    
    // Use unified slugifyTr function from utils
    // Alias for backward compatibility with existing code
    function toSlug(name) {
      return slugifyTr(name);
    }

    const user = await requireAuth();
    // Role-based permission: only specific company roles can open demand
    try {
      const snap = await getDoc(doc(db, "users", user.uid));
      const profile = snap.exists() ? (snap.data()||{}) : {};
      const joinOk = !profile.companyJoinStatus || profile.companyJoinStatus === 'approved';
      const allowedRoles = new Set(['satinalma_yetkilisi','genel_mudur','isveren']);
      const canOpen = joinOk && (profile.companyRole ? allowedRoles.has(profile.companyRole) : true);
      if (!canOpen) {
        const btn = document.getElementById('createBtn');
        if (btn) {
          btn.disabled = true;
          btn.title = 'Bu iÅŸlem iÃ§in yetkili deÄŸilsiniz. (SatÄ±n Alma Yetkilisi / Genel MÃ¼dÃ¼r / Ä°ÅŸveren)';
        }
        logger.warn('Demand create disabled for role', { role: profile.companyRole, status: profile.companyJoinStatus });
      }
    } catch(e) { logger.warn('Role check failed', e); }

    const el = id => {
      const element = document.getElementById(id);
      if (!element) {
        logger.warn(`Element bulunamadÄ±`, { id });
        return null;
      }
      return element;
    };
    const createBtn = el("createBtn");
    const addLineBtn = el("addLineBtn");
    // SATFK field (readonly, auto-generated)
    const satfkField = el("satfk");
    const itemsBody = el("itemsBody");
    const pageTitle = el("pageTitle");

    // Category Groups system
    const btnGroupHub = el("btnGroupHub");
    
    // Dropdown'Ä± tamamen kaldÄ±r (artÄ±k sadece butonlar kullanÄ±lacak)
    // Opsiyonel olduÄŸu iÃ§in uyarÄ± Ã¼retmemek adÄ±na doÄŸrudan native API kullan
    const categoryGroupSelect = document.getElementById("categoryGroupSelect");
    if (categoryGroupSelect) categoryGroupSelect.remove();
    
    // Modal artÄ±k otomatik olarak yÃ¼kleniyor - window.categoryGroupsModal kullan

    let lineCounter = 0;

    // Check for edit mode
    const params = new URLSearchParams(location.search);
    const editId = params.get("id");
    let editing = false;
    let demandRef = null;

    // Set today as default demand date
    el("demandDate").valueAsDate = new Date();

    // Category chip system
    const chips = new Set();

    // Category Groups system
    const categoryGroups = new Map(); // groupName -> Set of categories
    let currentGroupName = null;

    // Private demand system
    let selectedSuppliers = new Set(); // Set of supplier IDs
    let allSuppliers = []; // All available suppliers

    // CRITICAL FIX: Category ID system - chips now store category IDs, not slugs
    // Cache for category ID -> name mapping
    let categoryIdToNameMap = null;
    
    function loadCategoryMapping() {
      if (categoryIdToNameMap) return categoryIdToNameMap;
      
      // Use ID-based system from categories.js
      categoryIdToNameMap = new Map();
      CATEGORIES.forEach(cat => {
        categoryIdToNameMap.set(cat.id, cat.name);
        // Backward compatibility: also support slugs and names
        categoryIdToNameMap.set(toSlug(cat.name), cat.name);
        categoryIdToNameMap.set(cat.name, cat.name);
      });
      
      return categoryIdToNameMap;
    }
    
    function renderChips() {
      const box = el("catChips");
      if (!box) return;
      
      // Load category mapping
      loadCategoryMapping();
      box.innerHTML = "";
      
      [...chips].forEach(categoryIdOrSlug => {
        // CRITICAL FIX: Convert category ID/slug to display name
        const displayName = categoryIdToName(categoryIdOrSlug);
        
        const span = document.createElement("span");
        span.className = "badge";
        span.textContent = displayName + " âœ•";
        // Store category ID for deletion
        span.dataset.value = categoryIdOrSlug;
        span.onclick = () => { 
          chips.delete(categoryIdOrSlug); 
          renderChips(); 
        };
        box.appendChild(span);
      });
    }

    function renderGroupButtons() {
      const container = el("groupButtons");
      container.innerHTML = "";
      
      // VarsayÄ±lan gruplar - 25 kategori mantÄ±klÄ± gruplara ayrÄ±ldÄ±
      const defaultGroups = [
        { name: "Ä°nÅŸaat & YapÄ±", categories: ["Ä°nÅŸaat Malzemeleri", "HÄ±rdavat", "Boya"] },
        { name: "Elektrik & Elektronik", categories: ["Elektrik", "Elektronik", "AydÄ±nlatma", "AlÃ§ak/Orta Gerilim", "Otomasyon (PLC/SCADA)"] },
        { name: "Makine & Ä°malat", categories: ["Makine-Ä°malat", "Sac/Metal", "Kaynak & Sarf", "Rulman & GÃ¼Ã§ AktarÄ±m", "Otomotiv Yan Sanayi"] },
        { name: "Kimya & Plastik", categories: ["Kimyasal", "Plastik", "Ambalaj"] },
        { name: "GÃ¼venlik & SaÄŸlÄ±k", categories: ["Ä°ÅŸ GÃ¼venliÄŸi", "YangÄ±n GÃ¼venliÄŸi", "HVAC"] },
        { name: "Temizlik & BakÄ±m", categories: ["Temizlik"] },
        { name: "Hizmetler & DiÄŸer", categories: ["GÄ±da", "Hizmet", "Lojistik", "Ekipman Kiralama", "Mobilya"] }
      ];

      // VarsayÄ±lan gruplarÄ± ekle
      defaultGroups.forEach(group => {
        if (!categoryGroups.has(group.name)) {
          categoryGroups.set(group.name, new Set(group.categories));
        }
      });

      // Grup butonlarÄ±nÄ± render et
      categoryGroups.forEach((categories, groupName) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "group-btn";
        button.style.cssText = `
          padding: 8px 12px; 
          margin: 4px; 
          background: ${currentGroupName === groupName ? '#10b981' : '#f3f4f6'}; 
          color: ${currentGroupName === groupName ? 'white' : '#374151'}; 
          border: 1px solid #d1d5db; 
          border-radius: 6px; 
          cursor: pointer; 
          font-size: 12px;
          transition: all 0.2s;
        `;
        button.textContent = `${groupName} (${categories.size})`;
        button.title = `Kategoriler: ${[...categories].join(', ')}`;
        
        button.addEventListener("click", () => {
          if (currentGroupName === groupName) {
            // Grup seÃ§imini kaldÄ±r
            currentGroupName = null;
            button.style.background = '#f3f4f6';
            button.style.color = '#374151';
          } else {
            // Grup seÃ§
            currentGroupName = groupName;
            // Ã–nceki seÃ§imi temizle
            container.querySelectorAll('.group-btn').forEach(btn => {
              btn.style.background = '#f3f4f6';
              btn.style.color = '#374151';
            });
            button.style.background = '#10b981';
            button.style.color = 'white';
            
            // Grup kategorilerini ekle - CRITICAL FIX: Convert to category ID before adding
            categories.forEach(cat => {
              // cat can be name, slug, or ID - convert to ID
              const categoryId = nameToCategoryId(cat);
              if (categoryId) {
                chips.add(categoryId);
              } else {
                logger.warn('Unknown category', { category: cat });
              }
            });
            renderChips();
          }
        });
        
        // SaÄŸ tÄ±k menÃ¼sÃ¼ ekle
        button.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          const action = confirm(`"${groupName}" grubunu dÃ¼zenlemek istiyor musunuz?\n\nTamam = DÃ¼zenle\nÄ°ptal = Sil`);
          if (action) {
            editGroup(groupName);
          } else {
            if (confirm(`"${groupName}" grubunu silmek istediÄŸinizden emin misiniz?`)) {
              categoryGroups.delete(groupName);
              if (currentGroupName === groupName) {
                currentGroupName = null;
              }
              renderGroupButtons();
            }
          }
        });
        
        container.appendChild(button);
      });
    }

    // SATFK is auto-generated by Cloud Function

    // Private Demand Functions
    async function loadSuppliers() {
      try {
        const supplierMap = new Map();

        const queriesToRun = [
          // New roles object format: roles.supplier === true
          query(
            collection(db, 'users'),
            where('roles.supplier', '==', true)
          ),
          // Legacy single role field: role === 'supplier'
          query(
            collection(db, 'users'),
            where('role', '==', 'supplier')
          ),
          // Legacy roles array: roles array-contains 'supplier'
          query(
            collection(db, 'users'),
            where('roles', 'array-contains', 'supplier')
          )
        ];

        for (const qRef of queriesToRun) {
          try {
            const snap = await getDocs(qRef);
            snap.docs.forEach(doc => {
              const data = doc.data();
              supplierMap.set(doc.id, { id: doc.id, ...data });
            });
                  } catch (e) {
                    // CRITICAL FIX: Enhanced error logging with code and message
                    logger.error('Supplier query failed', {
                      code: e?.code || 'unknown',
                      message: e?.message || String(e),
                      error: e
                    });
                    // Log Firestore index link if available
                    if (e?.code === 'failed-precondition') {
                      logger.error('This query requires a Firestore composite index. Check the error message for the index creation link.');
                    }
                  }
        }

        // isActive alanÄ± false olanlarÄ± hariÃ§ tut; undefined/true olanlar dahil
        allSuppliers = Array.from(supplierMap.values()).filter(s => s?.isActive !== false);
        logger.info(`${allSuppliers.length} tedarikÃ§i yÃ¼klendi`);
      } catch (error) {
        logger.error('TedarikÃ§i yÃ¼kleme hatasÄ±', error);
        allSuppliers = [];
      }
    }

    function renderSupplierList(searchTerm = '') {
      const supplierList = el('supplierList');
      supplierList.innerHTML = '';
      
      const filteredSuppliers = allSuppliers.filter(supplier => 
        supplier.companyName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        supplier.email?.toLowerCase().includes(searchTerm.toLowerCase())
      );
      
      if (filteredSuppliers.length === 0) {
        supplierList.innerHTML = '<div style="padding: 16px; text-align: center; color: #6b7280;">TedarikÃ§i bulunamadÄ±</div>';
        return;
      }
      
      filteredSuppliers.forEach(supplier => {
        const div = document.createElement('div');
        div.style.cssText = `
          padding: 12px; 
          border-bottom: 1px solid #e5e7eb; 
          display: grid; 
          grid-template-columns: 24px 1fr;
          align-items: start; 
          column-gap: 12px;
          cursor: pointer;
          transition: background-color 0.2s;
        `;
        
        div.innerHTML = `
          <input type="checkbox" ${selectedSuppliers.has(supplier.id) ? 'checked' : ''} style="margin: 0;">
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; color: #1f2937; word-break: break-word;">${supplier.companyName || 'Ä°simsiz Firma'}</div>
            <div style="font-size: 12px; color: #6b7280; word-break: break-word;">${supplier.email || 'E-posta yok'}</div>
            <div style="font-size: 11px; color: #9ca3af; word-break: break-word; white-space: normal;">Kategoriler: ${(supplier.supplierCategories || supplier.categories || []).join(', ') || 'BelirtilmemiÅŸ'}</div>
          </div>
        `;
        
        div.addEventListener('click', (e) => {
          if (e.target.type === 'checkbox') return;
          
          const checkbox = div.querySelector('input[type="checkbox"]');
          checkbox.checked = !checkbox.checked;
          
          if (checkbox.checked) {
            selectedSuppliers.add(supplier.id);
            div.style.backgroundColor = '#f0f9ff';
          } else {
            selectedSuppliers.delete(supplier.id);
            div.style.backgroundColor = '';
          }
          
          updateSelectedCount();
        });
        
        const checkbox = div.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            selectedSuppliers.add(supplier.id);
            div.style.backgroundColor = '#f0f9ff';
          } else {
            selectedSuppliers.delete(supplier.id);
            div.style.backgroundColor = '';
          }
          updateSelectedCount();
        });
        
        supplierList.appendChild(div);
      });
    }

    function updateSelectedCount() {
      const count = selectedSuppliers.size;
      el('selectedCount').textContent = `SeÃ§ilen: ${count} tedarikÃ§i`;
    }

    function updateSelectedSuppliersDisplay() {
      const display = el('selectedSuppliers');
      
      if (selectedSuppliers.size === 0) {
        display.innerHTML = 'HenÃ¼z tedarikÃ§i seÃ§ilmedi';
        return;
      }
      
      const selectedNames = Array.from(selectedSuppliers).map(id => {
        const supplier = allSuppliers.find(s => s.id === id);
        return supplier?.companyName || 'Bilinmeyen';
      });
      
      display.innerHTML = `
        <div style="margin-bottom: 4px;"><strong>SeÃ§ilen TedarikÃ§iler:</strong></div>
        <div style="font-size: 11px;">${selectedNames.join(', ')}</div>
      `;
    }

    function showSupplierModal() {
      el('supplierSelectionModal').style.display = 'block';
      renderSupplierList();
      updateSelectedCount();
    }

    function hideSupplierModal() {
      el('supplierSelectionModal').style.display = 'none';
    }


    function editGroup(groupName) {
      const categories = categoryGroups.get(groupName);
      const currentCategories = [...categories].join(', ');
      
      const newCategories = prompt(
        `"${groupName}" grubu iÃ§in kategorileri girin (virgÃ¼lle ayÄ±rÄ±n):\n\nMevcut: ${currentCategories}`,
        currentCategories
      );
      
      if (newCategories === null) return; // Ä°ptal edildi
      
      // Kategorileri gÃ¼ncelle
      const categoryArray = newCategories.split(',').map(cat => cat.trim()).filter(cat => cat);
      categories.clear();
      categoryArray.forEach(cat => categories.add(cat));
      
      // UI'yi gÃ¼ncelle
      renderGroupButtons();
    }
    

    
    // Termin tarihi deÄŸiÅŸtiÄŸinde tÃ¼m Ã¼rÃ¼n kalemlerine otomatik doldur
    el("dueDate").addEventListener('change', function() {
      const selectedDate = this.value;
      if (selectedDate) {
        // TÃ¼m mevcut Ã¼rÃ¼n kalemlerinin termin tarihlerini gÃ¼ncelle
        const itemDueDates = document.querySelectorAll('.itemDueDate');
        itemDueDates.forEach(input => {
          if (!input.value) { // Sadece boÅŸ olanlarÄ± doldur
            input.value = selectedDate;
          }
        });
        logger.info(`Termin tarihi tÃ¼m Ã¼rÃ¼n kalemlerine uygulandÄ±`, { date: selectedDate });
      }
    });

    
    
    // SATFK will be auto-generated by Cloud Function
    
    // Private demand event listeners (custom invite editor)
    el("selectSuppliersBtn").addEventListener("click", showSupplierModal);
    el("closeSupplierModal").addEventListener("click", hideSupplierModal);
    el("cancelSupplierSelection").addEventListener("click", hideSupplierModal);
    el("confirmSupplierSelection").addEventListener("click", () => {
      updateSelectedSuppliersDisplay();
      hideSupplierModal();
    });
    
    // Supplier search
    el("supplierSearch").addEventListener("input", (e) => {
      renderSupplierList(e.target.value);
    });

    // ====================
    // Demand Visibility + Invite Mode (new)
    // ====================
    let autoInvitees = [];

    const selectedInviteGroups = new Set();

    function renderInviteGroupPicker() {
      const host = el('inviteGroupPicker');
      if (!host) return;
      host.innerHTML = '';
      categoryGroups.forEach((_, groupName) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = groupName;
        btn.style.padding = '6px 10px';
        btn.style.borderRadius = '16px';
        btn.style.border = '1px solid #d1d5db';
        btn.style.background = selectedInviteGroups.has(groupName) ? '#2563eb' : '#ffffff';
        btn.style.color = selectedInviteGroups.has(groupName) ? '#ffffff' : '#111827';
        btn.addEventListener('click', () => {
          if (selectedInviteGroups.has(groupName)) selectedInviteGroups.delete(groupName);
          else selectedInviteGroups.add(groupName);
          renderInviteGroupPicker();
          const mode = document.querySelector('input[name="inviteMode"]:checked')?.value || 'auto';
          if (document.querySelector('input[name="demandVisibility"]:checked')?.value === 'ozel' && mode === 'auto') {
            loadGroupMembers();
          }
        });
        host.appendChild(btn);
      });
    }

    function getSelectedGroupIds() {
      return Array.from(selectedInviteGroups);
    }

    async function loadGroupMembers() {
      const ids = getSelectedGroupIds();
      if (!ids.length) {
        autoInvitees = [];
        el('autoInviteCount').textContent = '0';
        return;
      }
      try {
        const res = await fetch(`/api/groups/members?ids=${ids.join(',')}`);
        const list = await res.json();
        autoInvitees = Array.isArray(list) ? list : [];
        el('autoInviteCount').textContent = String(autoInvitees.length);
      } catch (e) {
        logger.error('Grup Ã¼yeleri alÄ±namadÄ±', e);
        autoInvitees = [];
        el('autoInviteCount').textContent = '0';
      }
    }

    const visibilityRadios = document.querySelectorAll('input[name="demandVisibility"]');
    const inviteModeRadios = document.querySelectorAll('input[name="inviteMode"]');

    function updateVisibilitySections() {
      const v = document.querySelector('input[name="demandVisibility"]:checked')?.value;
      const isPrivate = v === 'ozel';
      const container = el('privateVisibilitySettings');
      container.style.display = isPrivate ? 'block' : 'none';
      if (isPrivate && allSuppliers.length === 0) {
        // preload supplier list for custom editor
        loadSuppliers();
      }
      updateInviteModeSections();
    }

    function updateInviteModeSections() {
      const mode = document.querySelector('input[name="inviteMode"]:checked')?.value || 'auto';
      el('autoInviteSummary').style.display = mode === 'auto' ? 'block' : 'none';
      el('customInviteEditor').style.display = mode === 'custom' ? 'block' : 'none';
    }

    visibilityRadios.forEach(r => r.addEventListener('change', updateVisibilitySections));
    inviteModeRadios.forEach(r => r.addEventListener('change', updateInviteModeSections));
    el('loadGroupMembersBtn').addEventListener('click', loadGroupMembers);
    // group picker events baÄŸlama render sÄ±rasÄ±nda yapÄ±lacak
    // initial (gÃ¶rÃ¼nÃ¼rlÃ¼k alanÄ± kaldÄ±rÄ±ldÄ±)
    
    // SATFK Preview System
    let previewSatfk = null;
    
    function generatePreviewSATFK() {
      const today = new Date();
      const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
      const randomSuffix = Math.random().toString(36).substring(2, 6).toUpperCase().padStart(4, '0');
      return `SATFK-${dateStr}-${randomSuffix}`;
    }
    
    function updateSATFKPreview() {
      previewSatfk = generatePreviewSATFK();
      el("satfk").value = previewSatfk;
      el("satfkStatus").textContent = `Ã–nizleme: ${previewSatfk} (Talep kaydedilene kadar deÄŸiÅŸebilir)`;
      el("copySatfkBtn").style.display = "inline-block";
    }
    
    // SATFK Copy functionality
    el("copySatfkBtn").addEventListener("click", async () => {
      const satfkValue = el("satfk").value;
      if (satfkValue) {
        try {
          await navigator.clipboard.writeText(satfkValue);
          el("satfkStatus").textContent = "âœ… Kod panoya kopyalandÄ±!";
          setTimeout(() => {
            el("satfkStatus").textContent = `Ã–nizleme: ${satfkValue} (Talep kaydedilene kadar deÄŸiÅŸebilir)`;
          }, 2000);
        } catch (error) {
          logger.error('Kopyalama hatasÄ±', error);
          el("satfkStatus").textContent = "âŒ Kopyalama baÅŸarÄ±sÄ±z";
        }
      }
    });
    
    // SATFK Refresh functionality
    el("refreshSatfkBtn").addEventListener("click", () => {
      updateSATFKPreview();
    });
    
    // Initial SATFK preview
    updateSATFKPreview();
    
    // Sayfa yÃ¼klendiÄŸinde grup butonlarÄ±nÄ± render et
    renderGroupButtons();

    // ====================
    // Bidding Mode & Time-Bound Logic
    // ====================
    const isTimeBoundCheckbox = el("isTimeBound");
    const timeBoundFields = el("timeBoundFields");
    const singlePhaseTime = el("singlePhaseTime");
    const hybridPhaseTime = el("hybridPhaseTime");
    const biddingModeRadios = document.getElementsByName("biddingMode");

    // Toggle time-bound fields (hidden + dynamic hint)
    const scheduleHint = document.getElementById('scheduleHint');
    function updateScheduleUI(){
      const on = !!isTimeBoundCheckbox.checked;
      if (timeBoundFields) timeBoundFields.hidden = !on;
      if (on) updateTimeFieldsVisibility();
      if (scheduleHint) scheduleHint.textContent = on
        ? 'SÃ¼reli seÃ§ilirse talep baÅŸlangÄ±Ã§ tarihi ile baÅŸlar, bitiÅŸ tarihi ile kapanÄ±r.'
        : 'SeÃ§ilmezse talep ÅŸimdi baÅŸlar ve manuel olarak kapatÄ±lana kadar devam eder.';
    }
    isTimeBoundCheckbox.addEventListener("change", updateScheduleUI);
    updateScheduleUI();

    // Toggle between single/hybrid time fields based on mode
    biddingModeRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        if (isTimeBoundCheckbox.checked) {
          updateTimeFieldsVisibility();
        }

        // Hibrit mod ayarlarÄ±nÄ± gÃ¶ster/gizle
        updateHybridSettingsVisibility();
      });
    });

    function updateHybridSettingsVisibility() {
      const hybridSettings = el("hybridSettings");
      const selectedMode = document.querySelector('input[name="biddingMode"]:checked').value;
      
      if (selectedMode === 'hybrid') {
        hybridSettings.style.display = 'block';
      } else {
        hybridSettings.style.display = 'none';
      }
    }

    function updateTimeFieldsVisibility() {
      const mode = document.querySelector('input[name="biddingMode"]:checked').value;
      if (mode === "hybrid") {
        singlePhaseTime.style.display = "none";
        hybridPhaseTime.style.display = "";
      } else {
        singlePhaseTime.style.display = "";
        hybridPhaseTime.style.display = "none";
      }
    }

    // ====================
    // Edit Mode: Load Existing Demand
    // ====================
    if (editId) {
      editing = true;
      pageTitle.textContent = "Talebi DÃ¼zenle";
      createBtn.textContent = "DeÄŸiÅŸiklikleri Kaydet";

      try {
        demandRef = doc(db, "demands", editId);
        const snap = await getDoc(demandRef);
        
        if (!snap.exists()) {
          toast.error(MESSAGES.ERROR_DEMAND_NOT_FOUND);
          location.href = "./demands.html";
          throw new Error("NOT_FOUND");
        }

        const d = snap.data();

        // Check ownership
        if (d.createdBy !== user.uid) {
          toast.error(MESSAGES.ERROR_DEMAND_EDIT_PERMISSION);
          location.href = "./demands.html";
          throw new Error("UNAUTHORIZED");
        }

        // Check if published
        if (d.published) {
          toast.warn(MESSAGES.WARN_PUBLISHED_EDIT);
          location.href = `./demand-detail.html?id=${editId}`;
          throw new Error("PUBLISHED");
        }

        // Load header data into form
        el("satfk").value = d.satfk || "";
        el("demandDate").value = d.demandDate || d.createdAt?.toDate?.()?.toISOString?.()?.split('T')[0] || "";
        el("siteName").value = d.siteName || "";
        el("purchaseLocation").value = d.purchaseLocation || "";
        el("title").value = d.title || "";
        const _specEl = document.getElementById("spec"); if (_specEl) _specEl.value = d.spec || "";
        el("dueDate").value = d.dueDate || "";
        el("priority").value = d.priority || "price";
        el("currency").value = d.currency || "TRY";
        el("paymentTerms").value = d.paymentTerms || "";
        // paymentSchedule kaldÄ±rÄ±ldÄ±
        const _deliveryCityEl = document.getElementById("deliveryCity"); if (_deliveryCityEl) _deliveryCityEl.value = d.deliveryCity || "";
        el("deliveryAddress").value = d.deliveryAddress || "";
        // Edit modunda teslimat adresi select'ini eÅŸleÅŸtirmek iÃ§in iÃ§eriÄŸi paylaÅŸ
        window.__desiredDeliveryAddress = d.deliveryAddress || "";
        
        // SATFK is always readonly
        el("satfk").readOnly = true;
        el("satfk").style.background = "#f9fafb";

        // Load categories
        // CRITICAL FIX: Categories from existing demand may be IDs, slugs, or names - convert all to IDs
        (Array.isArray(d.categoryTags) ? d.categoryTags : []).forEach(c => {
          const categoryId = nameToCategoryId(c);
          if (categoryId) {
            chips.add(categoryId);
          } else {
            // Legacy: if ID lookup fails, try to add as-is (might be valid ID we don't recognize)
            logger.warn('Category not found, adding as-is', { category: c });
            chips.add(c);
          }
        });
        if (d.customCategory) el("catInput").value = d.customCategory;
        renderChips();

        // Load bidding mode and time-bound settings
        const mode = d.biddingMode || "secret";
        document.querySelector(`input[name="biddingMode"][value="${mode}"]`).checked = true;

        // Teslim ÅŸekli restore
        const dmVal = d.deliveryMethod || '';
        const dmRadio = document.querySelector(`input[name="deliveryMethod"][value="${dmVal}"]`);
        const dmCustom = document.getElementById('deliveryMethodCustom');
        if (dmRadio) {
          dmRadio.checked = true;
        } else if (dmCustom) {
          dmCustom.value = dmVal;
        }
        
        // Hibrit ayarlarÄ±nÄ± yÃ¼kle
        if (d.hybridSettings) {
          if (d.hybridSettings.firstRoundDays) {
            el("firstRoundDays").value = d.hybridSettings.firstRoundDays;
          }
          if (d.hybridSettings.secondRoundSupplierVisibility) {
            el("secondRoundSupplierVisibility").value = d.hybridSettings.secondRoundSupplierVisibility;
          }
          if (d.hybridSettings.secondRoundDays) {
            el("secondRoundDays").value = d.hybridSettings.secondRoundDays;
          }
        }
        
        // Hibrit ayarlarÄ±nÄ± gÃ¶ster/gizle
        updateHybridSettingsVisibility();
        
        if (d.isTimeBound) {
          isTimeBoundCheckbox.checked = true;
          timeBoundFields.style.display = "";
          
          if (mode === "hybrid") {
            hybridPhaseTime.style.display = "";
            singlePhaseTime.style.display = "none";
            if (d.round1Start) el("round1Start").value = timestampToDatetimeLocal(d.round1Start);
            if (d.round1End) el("round1End").value = timestampToDatetimeLocal(d.round1End);
            if (d.round2Start) el("round2Start").value = timestampToDatetimeLocal(d.round2Start);
            if (d.round2End) el("round2End").value = timestampToDatetimeLocal(d.round2End);
          } else {
            singlePhaseTime.style.display = "";
            hybridPhaseTime.style.display = "none";
            if (d.phaseStartAt) el("phaseStart").value = timestampToDatetimeLocal(d.phaseStartAt);
            if (d.phaseEndAt) el("phaseEnd").value = timestampToDatetimeLocal(d.phaseEndAt);
          }
        }

        // Load items
        const itemsQ = query(collection(db, "demands", editId, "items"), orderBy("lineNo", "asc"));
        const itemsSnap = await getDocs(itemsQ);
        
        itemsSnap.docs.forEach(docSnap => {
          const item = docSnap.data();
          addRow(item);
        });

      } catch (error) {
        logger.error("Yeni talep yÃ¼kleme hatasÄ±", error);
        // Already redirected
      }
    }

    // Helper: Add row with data
    function addRow(data = {}) {
      lineCounter++;
      const tr = document.createElement("tr");
      tr.dataset.lineNo = data.lineNo || lineCounter;
      tr.innerHTML = `
        <td>${data.lineNo || lineCounter}</td>
        <td><input type="text" class="sku" placeholder="SKU" value="${data.sku || ""}" /></td>
        <td><textarea class="itemName auto-resize" placeholder="Malzeme tanÄ±mÄ±" required rows="2" data-min-height="32" data-max-height="120">${data.name || ""}</textarea></td>
        <td><input type="text" class="brandModel" placeholder="Marka/Model" value="${data.brandModel || ""}" /></td>
        <td><input type="number" class="qty" min="1" step="0.01" placeholder="Miktar" required value="${data.qty || ""}" /></td>
        <td><input type="text" class="unit" list="unitList" placeholder="Birim" required value="${data.unit || ""}" /></td>
        <td><input type="number" class="stockQty" min="0" step="0.01" placeholder="Depo" value="${data.stockQty || ""}" /></td>
        <td><input type="number" class="targetPrice" min="0" step="0.01" placeholder="Hedef" value="${data.targetPrice || ""}" /></td>
        <td>
          <input type="file" class="itemImage" accept="image/*" style="max-width:150px;">
          <input type="hidden" class="itemImageData" value="${data.productImage || ""}">
          <div class="itemImagePreview" style="font-size:11px;color:#6b7280;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${data.productImage ? 'SeÃ§ildi' : 'SeÃ§ilmedi'}</div>
        </td>
        <td><input type="date" class="itemDueDate" value="${data.itemDueDate || el("dueDate").value || ""}" /></td>
        <td>
          <button type="button" class="delBtn btn-sm">Ã—</button>
          <input type="hidden" class="featuresJson" value='${JSON.stringify(Array.isArray(data.ozellikler)?data.ozellikler:[])}'>
          <input type="hidden" class="certsJson" value='${JSON.stringify(Array.isArray(data.kaliteSertifika)?data.kaliteSertifika:[])}'>
          <input type="hidden" class="altAcceptVal" value='${typeof data.alternatifKabul === "boolean" ? String(data.alternatifKabul) : ""}'>
        </td>
      `;
      itemsBody.appendChild(tr);

      // Advanced editor row (collapsible) tied to this item row
      const advTr = document.createElement('tr');
      advTr.dataset.parent = tr.dataset.lineNo;
      advTr.innerHTML = `
        <td colspan="11">
          <details style="margin-top:6px;">
            <summary style="cursor:pointer; font-size:13px; font-weight:600;">Varyant / Alternatif / Sertifika</summary>
            <div style="display:grid; grid-template-columns: 1fr 0.6fr 0.6fr; gap:12px; margin-top:8px;">
              <div>
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
                  <label style="font-size:12px; color:#6b7280;">Varyant / Ã–zellikler</label>
                  <button type="button" class="btn-sm addPair">+ SatÄ±r</button>
                </div>
                <div class="pairs"></div>
                <p style="font-size:11px; color:#6b7280; margin-top:4px;">Renk, Ã¶lÃ§Ã¼ gibi teknik/lojistik Ã¶zellikleri anahtarâ€“deÄŸer olarak ekleyin.</p>
              </div>
              <div>
                <label style="font-size:12px; color:#6b7280; display:block; margin-bottom:6px;">Alternatif ÃœrÃ¼n KabulÃ¼?</label>
                <div style="display:flex; align-items:center; gap:12px;">
                  <label style="display:flex; align-items:center; gap:6px; cursor:pointer;"><input type="radio" name="alt-${tr.dataset.lineNo}" class="altYes"> Evet</label>
                  <label style="display:flex; align-items:center; gap:6px; cursor:pointer;"><input type="radio" name="alt-${tr.dataset.lineNo}" class="altNo"> HayÄ±r</label>
                </div>
                <p style="font-size:11px; color:#6b7280; margin-top:4px;">Evet seÃ§ilirse tedarikÃ§i teknik olarak uyumlu alternatif Ã¶nerebilir.</p>
              </div>
              <div>
                <label style="font-size:12px; color:#6b7280; display:block;">Kalite / Sertifika</label>
                <div style="display:flex; gap:6px; margin-top:4px;">
                  <input type="text" class="certInput" placeholder="ISO 9001, CE, RoHSâ€¦ (Enter)" style="border:1px solid #d1d5db; border-radius:4px; padding:4px 8px; flex:1;" />
                  <button type="button" class="btn-sm addCert">Ekle</button>
                </div>
                <div class="certTags" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;"></div>
                <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;">
                  ${["ISO 9001","ISO 14001","CE","RoHS","REACH"].map(s=>`<button type="button" class="btn-sm quickCert" data-cert="${s}" style="display:inline-block;">${s}</button>`).join('')}
                </div>
              </div>
            </div>
          </details>
        </td>`;
      itemsBody.appendChild(advTr);

      // Initialize auto-resize for new textarea
      reinitAutoResize(tr);

      // GÃ¶rsel seÃ§imi
      const fileInput = tr.querySelector('.itemImage');
      const hidden = tr.querySelector('.itemImageData');
      const preview = tr.querySelector('.itemImagePreview');
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        if (!file.type.startsWith('image/')) { toast.error(MESSAGES.ERROR_FILE_IMAGE); e.target.value=''; return; }
        if (file.size > 5*1024*1024) { toast.error(MESSAGES.ERROR_FILE_SIZE_MAX); e.target.value=''; return; }
        const reader = new FileReader();
        reader.onload = () => { hidden.value = reader.result; preview.textContent = file.name; };
        reader.readAsDataURL(file);
      });

      // Delete row
      tr.querySelector(".delBtn").onclick = () => { advTr.remove(); tr.remove(); };

      // Advanced editors bindings
      const featuresHidden = tr.querySelector('.featuresJson');
      const certsHidden = tr.querySelector('.certsJson');
      const altHidden = tr.querySelector('.altAcceptVal');

      let features = Array.isArray(data.ozellikler) ? data.ozellikler.filter(p => (p.key||'').trim() || (p.value||'').trim()) : [];
      let certs = Array.isArray(data.kaliteSertifika) ? Array.from(new Set(data.kaliteSertifika)) : [];
      let alt = typeof data.alternatifKabul === 'boolean' ? data.alternatifKabul : false;
      featuresHidden.value = JSON.stringify(features);
      certsHidden.value = JSON.stringify(certs);
      altHidden.value = String(alt);

      const pairsHost = advTr.querySelector('.pairs');
      const addPairBtn = advTr.querySelector('.addPair');
      const altYes = advTr.querySelector('.altYes');
      const altNo = advTr.querySelector('.altNo');
      const certInput = advTr.querySelector('.certInput');
      const certTagsHost = advTr.querySelector('.certTags');
      const addCertBtn = advTr.querySelector('.addCert');
      const quickCertBtns = advTr.querySelectorAll('.quickCert');

      function syncFeatures() {
        const cleaned = features.filter(p => (p.key||'').trim() || (p.value||'').trim());
        featuresHidden.value = JSON.stringify(cleaned);
      }
      function renderPairs() {
        pairsHost.innerHTML = '';
        features.forEach((r, idx) => {
          const rowDiv = document.createElement('div');
          rowDiv.style.display = 'flex'; rowDiv.style.gap = '6px'; rowDiv.style.marginBottom = '6px';
          rowDiv.innerHTML = `
            <input class="adv-input adv-key pairKey" placeholder="Ã–zellik (renk)" value="${r.key||''}" style="border:1px solid #d1d5db; border-radius:4px; padding:4px 8px;" />
            <input class="adv-input adv-val pairVal" placeholder="DeÄŸer (mavi)" value="${r.value||''}" style="border:1px solid #d1d5db; border-radius:4px; padding:4px 8px; flex:1;" />
            <button type="button" class="btn-sm del" style="display:inline-block;">Sil</button>`;
          const keyEl = rowDiv.querySelector('.pairKey');
          const valEl = rowDiv.querySelector('.pairVal');
          const delEl = rowDiv.querySelector('.del');
          keyEl.addEventListener('input', () => { features[idx].key = keyEl.value; syncFeatures(); });
          valEl.addEventListener('input', () => { features[idx].value = valEl.value; syncFeatures(); });
          delEl.addEventListener('click', () => { features.splice(idx,1); syncFeatures(); renderPairs(); });
          pairsHost.appendChild(rowDiv);
        });
      }
      addPairBtn.addEventListener('click', () => { features.push({key:'', value:''}); renderPairs(); syncFeatures(); });
      renderPairs();

      function syncAlt(val) { alt = val; altHidden.value = String(alt); }
      if (alt) altYes.checked = true; else altNo.checked = true;
      altYes.addEventListener('change', () => syncAlt(true));
      altNo.addEventListener('change', () => syncAlt(false));

      function syncCerts() { certsHidden.value = JSON.stringify(Array.from(new Set(certs))); }
      function renderCerts() {
        certTagsHost.innerHTML = '';
        Array.from(new Set(certs)).forEach(t => {
          const tag = document.createElement('span');
          tag.style.fontSize = '12px'; tag.style.padding = '2px 8px'; tag.style.border = '1px solid #1E40AF'; tag.style.borderRadius = '12px';
          tag.style.display = 'inline-flex'; tag.style.alignItems = 'center'; tag.style.gap = '6px'; tag.style.background = '#2563EB'; tag.style.color = '#fff';
          tag.textContent = t;
          const rm = document.createElement('button'); rm.type = 'button'; rm.textContent = 'Ã—';
          rm.style.color = '#dc2626'; rm.style.fontSize = '14px'; rm.style.marginLeft = '0';
          // beyaz zeminli, kÄ±rmÄ±zÄ± X daha gÃ¶rÃ¼nÃ¼r olsun
          rm.style.background = '#ffffff'; rm.style.border = '1px solid #fca5a5'; rm.style.borderRadius = '50%'; rm.style.width = '18px'; rm.style.height = '18px'; rm.style.display = 'inline-flex'; rm.style.alignItems = 'center'; rm.style.justifyContent = 'center'; rm.style.padding = '0'; rm.style.lineHeight = '1'; rm.style.cursor = 'pointer'; rm.style.fontWeight = '800';
          rm.addEventListener('click', () => { certs = certs.filter(x => x !== t); syncCerts(); renderCerts(); });
          tag.appendChild(rm);
          certTagsHost.appendChild(tag);
        });
      }
      function tryAddCert(v) { const s = (v||'').trim(); if (!s) return; if (!certs.includes(s)) certs.push(s); certInput.value=''; syncCerts(); renderCerts(); }
      certInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); tryAddCert(certInput.value); } });
      addCertBtn.addEventListener('click', () => tryAddCert(certInput.value));
      quickCertBtns.forEach(btn => btn.addEventListener('click', () => tryAddCert(btn.getAttribute('data-cert'))));
      renderCerts();
    }

    // Expose import preview applier for inline script
    window.applyImportPreview = function(preview){
      try{
        const demandValues = preview?.demand || {};
        const demandMeta = preview?.demandMeta || {};
        const itemMeta = Array.isArray(preview?.itemMeta) ? preview.itemMeta : [];
        const warnings = Array.isArray(preview?.warnings) ? preview.warnings : [];

        const normDate = (s)=>{
          if (!s) return '';
          const str = String(s).trim();
          if (/^\d{4}-\d{2}-\d{2}/.test(str)) return str.slice(0,10);
          const m = str.match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})$/);
          if (m){ const dd=m[1].padStart(2,'0'), mm=m[2].padStart(2,'0'); let yy=m[3]; if (yy.length===2) yy='20'+yy; return `${yy}-${mm}-${dd}`; }
          return '';
        };

        const setVal = (id, val)=>{
          const elx = document.getElementById(id);
          if (!elx) return;
          if (elx instanceof HTMLInputElement || elx instanceof HTMLTextAreaElement) {
            elx.value = val != null ? String(val) : '';
          }
        };

        const toggleReview = (id, meta)=>{
          const elx = document.getElementById(id);
          if (!elx) return;
          if (meta?.needsReview) elx.classList.add('import-review'); else elx.classList.remove('import-review');
        };

        setVal('title', demandValues.title || preview?.demand?.title || '');
        setVal('requester', demandValues.requester || '');
        setVal('demandDate', normDate(demandValues.demandDate));
        setVal('dueDate', normDate(demandValues.dueDate));
        setVal('currency', demandValues.currency || 'TRY');
        if (demandValues.note) setVal('note', demandValues.note);

        toggleReview('title', demandMeta.title);
        toggleReview('requester', demandMeta.requester);
        toggleReview('demandDate', demandMeta.demandDate);
        toggleReview('dueDate', demandMeta.dueDate);
        toggleReview('currency', demandMeta.currency);

        if (warnings.length) {
          toast.warn(`${MESSAGES.WARN_IMPORT_WARNINGS_HEADING}\n${warnings.join('\n')}`);
        }

        if (Array.isArray(preview?.items)){
          itemsBody.innerHTML = '';
          lineCounter = 0;
          let addedCount = 0;
          
          preview.items.forEach((it, idx)=>{
            const data = {
              name: it.itemName || it.name || '',
              qty: typeof it.qty === 'number' ? it.qty : (parseFloat(it.qty) || ''),
              unit: it.unit || '',
              brandModel: [it.brand, it.model].filter(Boolean).join(' '),
              targetPrice: typeof it.unitPriceExcl === 'number' ? it.unitPriceExcl : (parseFloat(it.unitPriceExcl)||'')
            };
            if (data.name && (data.qty || data.unit)) {
              const beforeCount = itemsBody.children.length;
              addRow(data);
              const rowsAdded = itemsBody.children.length - beforeCount;
              if (rowsAdded >= 2) {
                addedCount++;
                const detailRow = itemsBody.lastElementChild;
                const mainRow = detailRow?.previousElementSibling;
                const review = itemMeta[idx]?.needsReview;
                if (review) {
                  mainRow?.classList.add('import-review');
                } else {
                  mainRow?.classList.remove('import-review');
                }
              }
            }
          });
          
          logger.info('Kalemler forma eklendi', { 
            totalItems: preview.items.length,
            addedItems: addedCount
          });
        } else {
          logger.warn('Ã–nizleme verilerinde kalem bulunamadÄ±');
        }
      }catch(e){ logger.error('applyImportPreview error', e); toast.error(MESSAGES.ERROR_PREVIEW_APPLY); }
    };

    // HariÃ§ tut alanÄ± kaldÄ±rÄ±ldÄ±

    // Helper: Convert Firestore Timestamp to datetime-local format
    function timestampToDatetimeLocal(timestamp) {
      if (!timestamp) return "";
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // Helper: Convert datetime-local to Firestore Timestamp
    function datetimeLocalToTimestamp(datetimeStr) {
      if (!datetimeStr) return null;
      return new Date(datetimeStr);
    }

    // toSlug already defined above as function for hoisting support

    // SATFK is auto-generated by Cloud Function

    // Category Groups Management - moved to new implementation below

    // === Kategori Grubu OluÅŸtur SihirbazÄ± & Grup Render ===
    
    // Ekranda aÃ§Ä±k tutulan gruplarÄ± hatÄ±rlamak iÃ§in
    const expandedGroups = new Set(); // groupId => aÃ§Ä±k

    // ==== GruplarÄ± ekranda gÃ¶ster ve tÄ±kla-aÃ§/kapat ====

    async function loadCategoryGroups() {
      try {
        const userGroups = await listGroupsForUser(user.uid);
        
        // VarsayÄ±lan gruplar (hard-coded) - 25 kategori mantÄ±klÄ± gruplara ayrÄ±ldÄ±
        const defaultGroups = [
          { 
            name: "Ä°nÅŸaat & YapÄ±", 
            categories: ["Ä°nÅŸaat Malzemeleri", "HÄ±rdavat", "Boya"],
            id: "default-insaat",
            isDefault: true
          },
          { 
            name: "Elektrik & Elektronik", 
            categories: ["Elektrik", "Elektronik", "AydÄ±nlatma", "AlÃ§ak/Orta Gerilim", "Otomasyon (PLC/SCADA)"],
            id: "default-elektrik", 
            isDefault: true
          },
          { 
            name: "Makine & Ä°malat", 
            categories: ["Makine-Ä°malat", "Sac/Metal", "Kaynak & Sarf", "Rulman & GÃ¼Ã§ AktarÄ±m", "Otomotiv Yan Sanayi"],
            id: "default-makine",
            isDefault: true
          },
          { 
            name: "Kimya & Plastik", 
            categories: ["Kimyasal", "Plastik", "Ambalaj"],
            id: "default-kimya",
            isDefault: true
          },
          { 
            name: "GÃ¼venlik & SaÄŸlÄ±k", 
            categories: ["Ä°ÅŸ GÃ¼venliÄŸi", "YangÄ±n GÃ¼venliÄŸi", "HVAC"],
            id: "default-guvenlik",
            isDefault: true
          },
          { 
            name: "Temizlik & BakÄ±m", 
            categories: ["Temizlik"],
            id: "default-temizlik",
            isDefault: true
          },
          { 
            name: "Hizmetler & DiÄŸer", 
            categories: ["GÄ±da", "Hizmet", "Lojistik", "Ekipman Kiralama", "Mobilya"],
            id: "default-hizmet",
            isDefault: true
          }
        ];

        // KullanÄ±cÄ± gruplarÄ± + varsayÄ±lan gruplar
        const allGroups = [...defaultGroups, ...userGroups];

        // Grup butonlarÄ±nÄ± render et
        renderGroupButtonsFromData(allGroups);
      } catch (error) {
        logger.error('Grup listesi yÃ¼klenemedi', error);
      }
    }

    function renderGroupButtonsFromData(groups) {
      const container = document.getElementById('groupButtons');
      container.innerHTML = "";

      groups.forEach(g => {
        const count = (g.categories || []).length;
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "group-btn";
        
        // VarsayÄ±lan gruplar iÃ§in farklÄ± stil
        if (g.isDefault) {
          btn.style.cssText = `
            padding:8px 12px; margin:4px; background:#e0f2fe; color:#0277bd;
            border:1px solid #81d4fa; border-radius:6px; cursor:pointer; font-size:12px;
            font-weight:500;`;
        } else {
          // KullanÄ±cÄ± gruplarÄ± iÃ§in yeÅŸil tema
          btn.style.cssText = `
            padding:8px 12px; margin:4px; background:#ecfdf5; color:#065f46;
            border:1px solid #86efac; border-radius:6px; cursor:pointer; font-size:12px;
            font-weight:500;`;
        }
        
        btn.textContent = `${g.name} (${count})`;
        btn.title = (g.categories || []).join(", ");

        btn.addEventListener("click", () => toggleGroupOnChips(g));

        // SaÄŸ tÄ±k: varsayÄ±lan gruplar iÃ§in farklÄ± mesaj
        btn.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          if (g.isDefault) {
            toast.info(MESSAGES.INFO_DEFAULT_GROUP);
          } else {
            toast.info(MESSAGES.INFO_GROUP_EDIT);
          }
        });

        container.appendChild(btn);
      });
    }

    // TÄ±kla-aÃ§ / tÄ±kla-kapat (chips alanÄ±nda gÃ¶ster/gizle)
    function toggleGroupOnChips(group) {
      const cats = new Set(group.categories || []);
      const isOpen = expandedGroups.has(group.id || group.name);

      if (isOpen) {
        // kapat â†’ bu grubun kategorilerini Ã§iplerden kaldÄ±r
        // CRITICAL FIX: Convert category names/slugs to IDs before deleting (chips store IDs)
        cats.forEach(c => {
          const categoryId = nameToCategoryId(c);
          if (categoryId) {
            chips.delete(categoryId);
          } else {
            // Fallback: try deleting by name/slug if ID conversion fails
            chips.delete(c);
          }
        });
        expandedGroups.delete(group.id || group.name);
      } else {
        // aÃ§ â†’ Ã§iplere ekle (kÃ¼mÃ¼latif) - CRITICAL FIX: Convert to category ID before adding
        cats.forEach(c => {
          const categoryId = nameToCategoryId(c);
          if (categoryId) {
            chips.add(categoryId);
          } else {
            logger.warn('Unknown category in group', { category: c });
          }
        });
        expandedGroups.add(group.id || group.name);
      }
      renderChips();
    }

    // Apply selected group to category chips - dropdown kaldÄ±rÄ±ldÄ±ÄŸÄ± iÃ§in artÄ±k gerekli deÄŸil

    // === Ã‡oklu-Sekmeli Grup Hub Sistemi ===
    
    // GiriÅŸ butonu
    document.getElementById('btnGroupHub')?.addEventListener('click', () => {
      document.getElementById('groupHubModal').style.display = 'block';
      showTab('create'); // varsayÄ±lan OluÅŸtur
      resetCreatePane();
      renderManageList(); // YÃ¶net sekmesi iÃ§in Ã¶nceden yÃ¼kle
    });
    document.getElementById('ghClose')?.addEventListener('click', () => {
      document.getElementById('groupHubModal').style.display = 'none';
    });

    // Sekme geÃ§iÅŸi
    document.getElementById('tabCreate')?.addEventListener('click', () => showTab('create'));
    document.getElementById('tabManage')?.addEventListener('click', () => { showTab('manage'); renderManageList(); });

    function showTab(which){
      const cBtn = document.getElementById('tabCreate');
      const mBtn = document.getElementById('tabManage');
      const cPane= document.getElementById('paneCreate');
      const mPane= document.getElementById('paneManage');
      if(which==='create'){
        cBtn.classList.add('gh-active'); mBtn.classList.remove('gh-active');
        cPane.style.display=''; mPane.style.display='none';
      }else{
        mBtn.classList.add('gh-active'); cBtn.classList.remove('gh-active');
        mPane.style.display=''; cPane.style.display='none';
      }
    }

    // YÃ¶net toolbar'Ä±ndaki boÅŸ/adsÄ±z sol elemanÄ± kaldÄ±r
    (() => {
      const tb = document.querySelector('#paneManage > div'); // toolbar
      if (!tb) return;
      const first = tb.firstElementChild;
      if (first && first.textContent.trim()==='' && first.querySelectorAll('*').length===0) {
        first.remove();
      }
    })();

    // === Normalizasyon (duplicate engelleme)
    function normalizeName(s=''){
      return s.toLocaleLowerCase('tr')
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/\s+/g,' ').trim();
    }
    async function getTakenGroupNames(){
        const groups = await listGroupsForUser(user.uid);
      return { set:new Set(groups.map(g=>normalizeName(g.name))), list:groups };
    }

    // === OluÅŸtur sekmesi
    const ghCreateName   = document.getElementById('ghCreateName');
    const ghCreateStep   = document.getElementById('ghCreateStepCats');
    const ghCreateSearch = document.getElementById('ghCreateSearch');
    const ghCreateCount  = document.getElementById('ghCreateCount');
    const ghCreateCats   = document.getElementById('ghCreateCats');
    
    // CRITICAL: Category selection state for new group creation (declared early)
    let createSelected = new Set();

    function resetCreatePane(){
      ghCreateName.value = '';
      ghCreateStep.style.display = 'none';
      document.getElementById('ghCreateNext').style.display='inline-block';
      document.getElementById('ghCreateSave').style.display='none';
      ghCreateCats.innerHTML = '';
      ghCreateSearch.value = '';
      ghCreateCount.textContent = '';
      // CRITICAL: Clear selection state when resetting form
      createSelected.clear();
    }

    // CRITICAL: Use new ID-based category system (25 categories instead of 17)
    async function renderChecklist(container, countEl, filter='', prechecked=new Set()){
      // Get all categories from new system
      const allCategories = getAllCategories();
      const all = allCategories.map(cat => cat.name).filter(Boolean);
      const list = all.filter(n=>n.toLowerCase().includes(filter.toLowerCase())).sort((a,b)=>a.localeCompare(b,'tr'));
      container.innerHTML = list.map(n=>`
        <label class="gh-grid-row">
          <input type="checkbox" value="${n}" ${prechecked.has(n)?'checked':''}>
          <span>${n}</span>
        </label>`).join('');
      if (countEl) countEl.textContent = `${list.length} kategori`;
    }

    document.getElementById('ghCreateCancel')?.addEventListener('click', ()=>{
      document.getElementById('groupHubModal').style.display='none';
    });

    document.getElementById('ghCreateNext')?.addEventListener('click', async ()=>{
      const raw = ghCreateName.value;
      const key = normalizeName(raw);
  if(!key){ toast.warn(MESSAGES.WARN_GROUP_NAME); return; }
  const {set:taken} = await getTakenGroupNames();
  if(taken.has(key)){ toast.warn(MESSAGES.WARN_GROUP_EXISTS_FORMAT.replace('{name}', raw)); return; }
      ghCreateStep.style.display = '';
      document.getElementById('ghCreateCats').classList.add('gh-grid');
      document.getElementById('ghCreateCats').parentElement.style.maxHeight = '48vh';
      document.getElementById('ghCreateCats').parentElement.style.overflow = 'auto';
      // CRITICAL: Reset selection when starting category selection step
      createSelected.clear();
      // CRITICAL: Use async renderChecklist with empty selection set
      renderChecklist(document.getElementById('ghCreateCats'), document.getElementById('ghCreateCount'), '', createSelected).catch(err => logger.error('Render checklist error', err));
      rebindCreateCheckboxHandlers();
      document.getElementById('ghCreateNext').style.display='none';
      document.getElementById('ghCreateSave').style.display='inline-block';
      ghCreateSearch.focus();
    });
    
    // Helper function to rebind checkbox handlers for create mode
    function rebindCreateCheckboxHandlers() {
      const createCatsBox = document.getElementById('ghCreateCats');
      if (!createCatsBox) return;
      
      createCatsBox.onchange = (ev) => {
        if (ev.target.type === 'checkbox'){
          const v = ev.target.value;
          if (ev.target.checked) createSelected.add(v);
          else createSelected.delete(v);
        }
      };
    }
    
    ghCreateSearch?.addEventListener('input', e=>{
      // CRITICAL: Use async renderChecklist with preselected categories
      renderChecklist(document.getElementById('ghCreateCats'), document.getElementById('ghCreateCount'), e.target.value, createSelected).catch(err => logger.error('Render checklist error', err));
      rebindCreateCheckboxHandlers();
    });
    
    // CRITICAL: TÃ¼mÃ¼nÃ¼ SeÃ§ butonu (Yeni Grup OluÅŸtur)
    const createSelectAllBtn = document.getElementById('ghCreateSelectAll');
    if (createSelectAllBtn) {
      createSelectAllBtn.addEventListener('click', () => {
        const allCategories = getAllCategories();
        const allNames = allCategories.map(cat => cat.name).filter(Boolean);
        allNames.forEach(name => createSelected.add(name));
        // Yeniden render et
        const searchValue = document.getElementById('ghCreateSearch')?.value || '';
        renderChecklist(document.getElementById('ghCreateCats'), document.getElementById('ghCreateCount'), searchValue, createSelected).catch(err => logger.error('Render checklist error', err));
        rebindCreateCheckboxHandlers();
      });
    }
    
    // CRITICAL: Temizle butonu (Yeni Grup OluÅŸtur)
    const createClearBtn = document.getElementById('ghCreateClear');
    if (createClearBtn) {
      createClearBtn.addEventListener('click', () => {
        createSelected.clear();
        // Yeniden render et
        const searchValue = document.getElementById('ghCreateSearch')?.value || '';
        renderChecklist(document.getElementById('ghCreateCats'), document.getElementById('ghCreateCount'), searchValue, createSelected).catch(err => logger.error('Render checklist error', err));
        rebindCreateCheckboxHandlers();
      });
    }

    document.getElementById('ghCreateSave')?.addEventListener('click', async ()=>{
      const raw = ghCreateName.value;
      const key = normalizeName(raw);
      // CRITICAL: Use createSelected set instead of querying DOM
      const selected = createSelected.size > 0 
        ? [...createSelected] 
        : [...ghCreateCats.querySelectorAll('input[type="checkbox"]:checked')].map(i=>i.value);
  if(!key){ toast.warn(MESSAGES.WARN_VALID_GROUP_NAME); return; }
      if(selected.length===0){ toast.warn(MESSAGES.WARN_CATEGORY_SELECT); return; }

      const {set:taken} = await getTakenGroupNames();
  if(taken.has(key)){ toast.warn(MESSAGES.WARN_GROUP_EXISTS_FORMAT.replace('{name}', raw)); return; }

      await createGroup(user.uid, {name: raw.trim(), categories: selected});
      await loadCategoryGroups?.();
      showTab('manage');        // otomatik olarak YÃ¶net sekmesine geÃ§
      renderManageList();       // listeyi tazele
    });

    // === YÃ¶net sekmesi
    const ghManageList   = document.getElementById('ghManageList');

    let ghGroups = []; // {id,name,categories}
    let ghSelectedIds = new Set();

    // --- YÃ¶net liste davranÄ±ÅŸÄ±
    function refreshRowStates(){
      const rows = document.querySelectorAll('#ghManageList .row');
      const single = ghSelectedIds.size === 1 ? [...ghSelectedIds][0] : null;
      rows.forEach(row => {
        const id = row.getAttribute('data-id');
        const btn = row.querySelector('.btn-edit');
        if (!btn) return;
        if (single && id === single){
          btn.classList.add('enabled');
          btn.disabled = false;
        } else {
          btn.classList.remove('enabled');
          btn.disabled = true;
        }
      });

      // Ã¼stteki "DÃ¼zenle" butonu
      const topEdit = document.getElementById('ghEdit');
      if (topEdit){
        const on = ghSelectedIds.size === 1;
        topEdit.disabled = !on;
        topEdit.style.background = on ? '#10b981' : '#f59e0b';
        topEdit.style.color = '#fff';
      }
    }

    async function renderManageList(){
      const {list} = await getTakenGroupNames();
      ghGroups = list;
      ghSelectedIds.clear();
      drawManageList();
      // dÃ¼zenleme panelini kapat
      document.getElementById('ghEditPanel').style.display='none';
    }

    function drawManageList(){
      const searchEl = document.getElementById('ghManageSearch');
      const q = (searchEl?.value||'').toLocaleLowerCase('tr');
      const html = ghGroups
        .filter(g => g.name.toLocaleLowerCase('tr').includes(q))
        .map(g => `
          <div class="row" data-id="${g.id}">
            <input type="checkbox" class="gh-row-check" ${ghSelectedIds.has(g.id)?'checked':''}>
            <div><strong>${g.name}</strong> <small style="color:#6b7280;">(${(g.categories||[]).length})</small></div>
            <button class="btn-edit" disabled>DÃ¼zenle</button>
          </div>`
        ).join('');
      ghManageList.innerHTML = html || `<div style="padding:12px;color:#6b7280;">HenÃ¼z grup yok.</div>`;
      refreshRowStates();
    }
    document.getElementById('ghManageSearch')?.addEventListener('input', drawManageList);

    // satÄ±r checkbox change handler (liste Ã§iziminden sonra baÄŸla)
    document.getElementById('ghManageList')?.addEventListener('change',(e)=>{
      if(!e.target.classList.contains('gh-row-check')) return;
      const row = e.target.closest('.row'); const id = row?.dataset.id;
      if (!id) return;
      if (e.target.checked) ghSelectedIds.add(id); else ghSelectedIds.delete(id);
      refreshRowStates();
    });

    // satÄ±r "DÃ¼zenle" tÄ±k
    document.getElementById('ghManageList')?.addEventListener('click',(e)=>{
      if(!e.target.classList.contains('btn-edit')) return;
      if (e.target.disabled) return;
      const id = e.target.closest('.row')?.dataset.id;
      if (id) openEditPanel(id);
    });

    // Ã‡oklu Sil
    document.getElementById('ghDelete')?.addEventListener('click', async ()=>{
      if(ghSelectedIds.size===0){ toast.warn(MESSAGES.WARN_GROUP_SELECT); return; }
      if(!confirm(`${ghSelectedIds.size} grup silinsin mi?`)) return;
      
      try {
        // Her grup iÃ§in ayrÄ± ayrÄ± silme iÅŸlemi
        for (const groupId of ghSelectedIds) {
          await deleteGroup(user.uid, groupId);
        }
        await loadCategoryGroups?.();
        await renderManageList();
        toast.success(MESSAGES.SUCCESS_GROUPS_DELETED);
      } catch (error) {
        logger.error('Silme hatasÄ±', error);
        toast.error(MESSAGES.ERROR_GROUPS_DELETE + ': ' + error.message);
      }
    });

    // Tekli DÃ¼zenle butonu
    document.getElementById('ghEdit')?.addEventListener('click', ()=>{
      if(ghSelectedIds.size!==1){ toast.warn(MESSAGES.WARN_ONE_GROUP_SELECT); return; }
      const id = [...ghSelectedIds][0];
      openEditPanel(id);
    });

    // --- Ä°sim/kat normalizasyonu
    function normalizeCat(s=''){
      return s
        .toLocaleLowerCase('tr')
        .replace(/Ä±/g,'i')
        .replace(/ÅŸ/g,'s')
        .replace(/ÄŸ/g,'g')
        .replace(/Ã§/g,'c')
        .replace(/Ã¶/g,'o')
        .replace(/Ã¼/g,'u')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9]+/g,'')   // boÅŸluk, tire, eÄŸik Ã§izgi vb. tÃ¼m ayÄ±rÄ±cÄ±larÄ± kaldÄ±r
        .trim();
    }

    // Basit Levenshtein mesafesi: kÃ¼Ã§Ã¼k diziler iÃ§in yeterli
    function editDistance(a, b){
      const m = a.length, n = b.length;
      const dp = Array.from({length:m+1},()=>Array(n+1).fill(0));
      for(let i=0;i<=m;i++) dp[i][0]=i;
      for(let j=0;j<=n;j++) dp[0][j]=j;
      for(let i=1;i<=m;i++){
        for(let j=1;j<=n;j++){
          const cost = a[i-1]===b[j-1]?0:1;
          dp[i][j] = Math.min(
            dp[i-1][j]+1,
            dp[i][j-1]+1,
            dp[i-1][j-1]+cost
          );
        }
      }
      return dp[m][n];
    }

    // CRITICAL: Reusable grid checklist renderer (prechecked korumalÄ±) - Updated to use new ID-based system (25 categories)
    function renderChecklistGrid(container, countEl, { filter='', prechecked=new Set() } = {}){
      // Get all categories from new system
      const allCategories = getAllCategories();
      const all = allCategories.map(cat => cat.name).filter(Boolean);
      const preN = new Set([...prechecked].map(normalizeCat));    // normalize for compare
      const list = all
        .filter(n => n.toLowerCase().includes(filter.toLowerCase()))
        .sort((a,b)=>a.localeCompare(b,'tr'));

      container.innerHTML = list.map(n => {
        const checked = preN.has(normalizeCat(n)) ? 'checked' : '';
        return `
          <label class="gh-grid-row">
            <input type="checkbox" value="${n}" ${checked}>
            <span>${n}</span>
          </label>`;
      }).join('');

      if (countEl) countEl.textContent = `${list.length} kategori`;
    }

    // === DÃ¼zenleme paneli ===
    let editingGroup = null;            // {id,name,categories}
    let editingSelected = new Set();    // canlÄ± seÃ§im (preselected + kullanÄ±cÄ± deÄŸiÅŸiklikleri)

    function openEditPanel(id){
      // grubu bul ve baÅŸlÄ±ÄŸÄ± yaz
      editingGroup = ghGroups.find(g => g.id === id);
      if (!editingGroup) return;

      document.getElementById('ghEditTitle').textContent = `Grup DÃ¼zenle: ${editingGroup.name}`;
      const nameInput = document.getElementById('ghEditName');
      if (nameInput) nameInput.value = editingGroup.name || '';

      // CRITICAL: PRESELECT - Use new ID-based category system (25 categories)
      const allCategories = getAllCategories();
      const allNames = allCategories.map(cat => cat.name).filter(Boolean);
      const nameByNorm = new Map(allNames.map(n => [normalizeCat(n), n]));
      const allNorms = Array.from(nameByNorm.keys());
      const mapped = (editingGroup.categories || [])
        .filter(Boolean)
        .map(c => {
          const norm = normalizeCat(c);
          // Ã–zel alias eÅŸleÅŸmeler (bozuk kayÄ±tlara tolerans)
          const aliasTargets = [
            { match: (n) => n.includes('gvenlik') || n.startsWith('isg') || n.startsWith('isguven'), target: 'isguvenligi' },
          ];
          for (const a of aliasTargets){
            if (a.match(norm) && nameByNorm.has(a.target)){
              return nameByNorm.get(a.target);
            }
          }
          if (nameByNorm.has(norm)) return nameByNorm.get(norm);
          // En yakÄ±n eÅŸi bul (mesafe <= 2 veya uzunluÄŸun %25'i)
          let best = null, bestDist = Infinity;
          for (const candidate of allNorms){
            const d = editDistance(norm, candidate);
            if (d < bestDist){ bestDist = d; best = candidate; }
            if (bestDist === 0) break;
          }
          const threshold = Math.max(3, Math.floor(Math.max(norm.length, (best||'').length)*0.35));
          return (best && bestDist <= threshold) ? nameByNorm.get(best) : c;
        });
      editingSelected = new Set(mapped);

      // ilk Ã§izim
      const catsBox = document.getElementById('ghEditCats');
      catsBox.classList.add('gh-grid'); // dÃ¼zenli grid
      renderChecklistGrid(catsBox, document.getElementById('ghEditCount'), {
        filter: '',
        prechecked: editingSelected
      });

      // checkbox deÄŸiÅŸimlerini canlÄ± olarak editingSelected'a yansÄ±t
      catsBox.onchange = (e) => {
        if (e.target.type === 'checkbox'){
          const val = e.target.value;
          if (e.target.checked) editingSelected.add(val);
          else editingSelected.delete(val);
        }
      };

      // aramada listeyi yeniden Ã§izerken mevcut seÃ§imleri KORU
      const search = document.getElementById('ghEditSearch');
      search.value = '';
      
      // Helper function to rebind event handlers
      function rebindCheckboxHandlers() {
        catsBox.onchange = (ev) => {
          if (ev.target.type === 'checkbox'){
            const v = ev.target.value;
            if (ev.target.checked) editingSelected.add(v);
            else editingSelected.delete(v);
          }
        };
      }
      
      search.oninput = (e) => {
        renderChecklistGrid(catsBox, document.getElementById('ghEditCount'), {
          filter: e.target.value || '',
          prechecked: editingSelected
        });
        rebindCheckboxHandlers();
      };

      // CRITICAL: TÃ¼mÃ¼nÃ¼ SeÃ§ butonu
      const selectAllBtn = document.getElementById('ghEditSelectAll');
      if (selectAllBtn) {
        selectAllBtn.onclick = () => {
          const allCategories = getAllCategories();
          const allNames = allCategories.map(cat => cat.name).filter(Boolean);
          allNames.forEach(name => editingSelected.add(name));
          // Yeniden render et
          renderChecklistGrid(catsBox, document.getElementById('ghEditCount'), {
            filter: search.value || '',
            prechecked: editingSelected
          });
          rebindCheckboxHandlers();
        };
      }

      // CRITICAL: Temizle butonu
      const clearBtn = document.getElementById('ghEditClear');
      if (clearBtn) {
        clearBtn.onclick = () => {
          editingSelected.clear();
          // Yeniden render et
          renderChecklistGrid(catsBox, document.getElementById('ghEditCount'), {
            filter: search.value || '',
            prechecked: editingSelected
          });
          rebindCheckboxHandlers();
        };
      }

      // paneli gÃ¶ster
      document.getElementById('ghEditPanel').style.display = '';
    }

    // Kaydet â†’ editingSelected set'inden gÃ¶nder
    document.getElementById('ghEditSave')?.addEventListener('click', async ()=>{
      if (!editingGroup) return;
      const newCats = [...editingSelected];
      const nameInput = document.getElementById('ghEditName');
      const newNameRaw = (nameInput?.value || '').trim();
      const newNameKey = normalizeName(newNameRaw);
      if (!newNameKey){ toast.warn(MESSAGES.WARN_VALID_GROUP_NAME); return; }

      // Duplicate kontrol (kendi grubu hariÃ§)
      const { list } = await getTakenGroupNames();
      const exists = list.some(g => g.id !== editingGroup.id && normalizeName(g.name) === newNameKey);
  if (exists){ toast.warn(MESSAGES.WARN_GROUP_EXISTS_FORMAT.replace('{name}', newNameRaw)); return; }

      await updateGroup(user.uid, editingGroup.id, { name: newNameRaw, categories: newCats });
      await loadCategoryGroups?.();
      await renderManageList();
      // panel aÃ§Ä±k kalabilir; istersen kapat:
      // document.getElementById('ghEditPanel').style.display = 'none';
    });

    // VazgeÃ§ â†’ paneli kapat
    document.getElementById('ghEditCancel')?.addEventListener('click', ()=>{
      document.getElementById('ghEditPanel').style.display = 'none';
      editingGroup = null;
      editingSelected = new Set();
    });


    // Load category groups on page load
    await loadCategoryGroups();
    // Render invite group picker with same groups
    renderInviteGroupPicker();

    // Add line item (use helper)
    if (addLineBtn) {
      addLineBtn.onclick = () => {
        addRow();
      };
    }

    if (createBtn) {
      logger.info("createBtn bulundu, event listener ekleniyor");
      createBtn.onclick = async () => {
        try {
          // Header validation
          const demandDate = el("demandDate").value;
          const title = el("title").value.trim();
          const dueDate = el("dueDate").value;
          const priority = el("priority").value;
          const currency = el("currency").value;
          // New visibility model
          const demandVisibility = document.querySelector('input[name="demandVisibility"]:checked')?.value || 'genel';
          const inviteMode = document.querySelector('input[name="inviteMode"]:checked')?.value || 'auto';
          const selectedGroupIds = getSelectedGroupIds();

          const siteNameVal = el("siteName").value.trim();
          const purchaseVal = el("purchaseLocation").value.trim();
          if (!demandDate || !title || !dueDate || !siteNameVal || !purchaseVal) {
            throw new Error("Talep Tarihi, Åantiye, AlÄ±m Yeri, BaÅŸlÄ±k ve Termin zorunlu.");
          }

          // Validate purchase city from datalist
          const provinceOptions = Array.from(document.querySelectorAll('#provinceList option')).map(o => (o.value||'').trim());
          if (!provinceOptions.includes(purchaseVal)) {
            throw new Error("LÃ¼tfen AlÄ±m Yeri iÃ§in listeden geÃ§erli bir il seÃ§in.");
          }

          // Ã–zel + custom ise en az bir tedarikÃ§i ÅŸart
          if (demandVisibility === 'ozel' && inviteMode === 'custom' && selectedSuppliers.size === 0) {
            throw new Error("Ã–zel (Ã–zelleÅŸtir) iÃ§in en az bir tedarikÃ§i seÃ§melisiniz.");
          }

          // Get companyId from profile with fallback strategy
          let companyId = null;
          try {
            // Try multiple collections in order of preference
            const collections = ["publicProfiles", "profiles", "users"];
            
            for (const collection of collections) {
              try {
                const profileSnap = await getDoc(doc(db, collection, user.uid));
                if (profileSnap.exists()) {
                  const profile = profileSnap.data();
                  companyId = profile.currentCompanyId || profile.companyId || profile.activeCompanyId || `solo-${user.uid}`;
                  logger.info(`Found companyId from ${collection}`, { companyId });
                  break;
                }
              } catch (collectionError) {
                logger.warn(`Could not read from ${collection}`, collectionError.message);
                continue;
              }
            }
            
            // Fallback if no collection worked
            if (!companyId) {
              companyId = `solo-${user.uid}`;
              logger.info("Using fallback companyId", { companyId });
            }
          } catch (e) {
            logger.warn("Profile read error, using fallback", e);
            companyId = `solo-${user.uid}`;
          }

          // Prepare header data
          // Teklif modu ve hibrit ayarlarÄ±
          const biddingMode = document.querySelector('input[name="biddingMode"]:checked').value;
          const hybridSettings = {
            firstRoundDays: biddingMode === 'hybrid' ? parseInt(el("firstRoundDays").value) || 7 : null,
            secondRoundSupplierVisibility: biddingMode === 'hybrid' ? el("secondRoundSupplierVisibility").value : null,
            secondRoundDays: biddingMode === 'hybrid' ? parseInt(el("secondRoundDays").value) || 7 : null
          };

          const specValue = document.getElementById("spec")?.value?.trim() || null;
          const deliveryCityValue = document.getElementById("deliveryCity")?.value?.trim() || null;

          // Exclude suppliers (chips)
          const excludeSuppliers = Array.from(document.querySelectorAll('#excludeChips span[data-val]')).map(el => ({ nameOrCode: el.getAttribute('data-val') }));

          // Backward compatibility for legacy fields
          const demandType = demandVisibility === 'ozel' ? 'private' : 'public';
          const invitedSupplierIds = (demandVisibility === 'ozel')
            ? (inviteMode === 'custom' ? Array.from(selectedSuppliers) : (autoInvitees.map(s => s.id)))
            : [];

          // CRITICAL FIX: Chips now contain category IDs, not slugs
          // Ensure all chips are valid category IDs
          const categoryIds = [...chips].map(c => {
            // If it's already a valid category ID, use it
            if (CATEGORIES.find(cat => cat.id === c)) return c;
            // Try to convert name/slug to ID
            const id = nameToCategoryId(c);
            return id || c; // Fallback to original if conversion fails
          }).filter(Boolean);
          
          // For backward compatibility, also generate slugs
          const categorySlugs = categoryIds.map(id => {
            const name = categoryIdToName(id);
            return toSlug(name || id);
          });
          
          const headerData = {
            demandDate,
            siteName: siteNameVal,
            purchaseLocation: purchaseVal,
            title,
            spec: specValue,
            categoryIds: categoryIds, // NEW: Store category IDs (primary)
            categoryTags: categorySlugs, // Backward compatibility: also store slugs
            customCategory: document.getElementById("catInput")?.value?.trim() || null,
            dueDate,
            priority,
            currency,
            paymentTerms: el("paymentTerms").value.trim() || null,
            paymentPreference: (window.__getBuyerPaymentPref && window.__getBuyerPaymentPref()) || null,
            deliveryCity: deliveryCityValue,
            deliveryAddress: el("deliveryAddress").value.trim() || null,
            delivery_lat: el("delivery_lat")?.value ? parseFloat(el("delivery_lat").value) : null, // Teklifbul Rule v1.0 - Adres doÄŸrulama koordinatÄ±
            delivery_lng: el("delivery_lng")?.value ? parseFloat(el("delivery_lng").value) : null, // Teklifbul Rule v1.0 - Adres doÄŸrulama koordinatÄ±
            // paymentSchedule kaldÄ±rÄ±ldÄ±
            // SATFK: kalÄ±cÄ± alan (CF henÃ¼z yazmadan taslakta da gÃ¶rÃ¼nsÃ¼n)
            satfk: (document.getElementById('satfk')?.value || (typeof previewSatfk !== 'undefined' ? previewSatfk : null)),
            // YayÄ±n/GÃ¶rÃ¼nÃ¼rlÃ¼k kaldÄ±rÄ±ldÄ± - otomatik gÃ¶nderim
            demandType, // 'public' veya 'private' (uyumluluk)
            selectedSuppliers: null,
            excludeSuppliers,
            biddingMode, // 'secret', 'open', 'hybrid'
            hybridSettings, // Hibrit mod ayarlarÄ±
            updatedAt: serverTimestamp(),
            companyId: companyId, // Set companyId from profile with fallback (backward compatibility)
            // REFACTORED: Yeni alanlar - refactor iÃ§in
            creatorId: user.uid, // Talebi aÃ§an kullanÄ±cÄ±
            creatorCompanyId: companyId, // Talebi aÃ§an kullanÄ±cÄ±nÄ±n ÅŸirketi
            supplierCategoryKeys: categoryIds, // TedarikÃ§i kategori eÅŸleÅŸmesi iÃ§in (ID format - primary)
            // New fields for publish functionality - will be updated when approved via modal
            isPublished: false, // Will be set to true when approved via modal
            visibility: 'private',
            // Yeni eklenen alanlar
            descriptions: getDescriptions(), // 1-2-3-4-5 numaralÄ± aÃ§Ä±klamalar
            requester: el("requester").value.trim() || null, // Talep Eden
            purchaseManager: el("purchaseManager").value.trim() || null, // SatÄ±n Alma MÃ¼dÃ¼rÃ¼
            generalManager: el("generalManager").value.trim() || null, // Genel MÃ¼dÃ¼r
            approver: el("approver").value.trim() || null, // Onay Veren
            deliveryMethod: getDeliveryMethod(), // Teslim Åekli
            deliveryAddress: el("deliveryAddress").value.trim() || null, // Teslimat Adresi
            delivery_lat: el("delivery_lat")?.value ? parseFloat(el("delivery_lat").value) : null, // Teklifbul Rule v1.0 - Adres doÄŸrulama koordinatÄ±
            delivery_lng: el("delivery_lng")?.value ? parseFloat(el("delivery_lng").value) : null // Teklifbul Rule v1.0 - Adres doÄŸrulama koordinatÄ±
          };

          if (!editing) {
            // ====================
            // CREATE MODE
            // ====================
            headerData.createdBy = user.uid; // Backward compatibility
            headerData.createdAt = serverTimestamp();
            headerData.updatedAt = serverTimestamp(); // REFACTORED: updatedAt eklendi
            headerData.viewerIds = [user.uid];
            // Keep published field for backward compatibility (DEPRECATED)
            headerData.published = false; // BaÅŸlangÄ±Ã§ta yayÄ±nlanmamÄ±ÅŸ
            headerData.filesCount = 0;
            
            // REFACTORED: Talep durumu sistemi - sadece status kullanÄ±lÄ±yor
            // FIX: Start as draft, but will be approved via modal
            headerData.status = 'draft'; // BaÅŸlangÄ±Ã§ta taslak (modal'dan onaylanacak)
            headerData.published = false; // Explicitly false until approved
            headerData.statusHistory = [{
              status: 'draft',
              timestamp: Date.now(),
              userId: user.uid,
              note: 'Talep oluÅŸturuldu'
            }];

            // Main demand visibility data
            const mainDemandVisibility = document.querySelector('input[name="mainDemandVisibility"]:checked')?.value || 'normal';
            headerData.isMainDemand = mainDemandVisibility === 'main';
            // Header-level target price is deprecated; keep null (item-level targetPrice is used)
            headerData.targetPrice = null;
            headerData.deliveryLocation = `${deliveryCityValue || ''} ${el("deliveryAddress").value.trim()}`.trim();

            logger.info("Creating new demand", {
              createdBy: user.uid,
              categoryIds: headerData.categoryIds,
              categoryTags: headerData.categoryTags,
              companyId: headerData.companyId,
              isPublished: headerData.isPublished,
              visibility: headerData.visibility
            });

            // Create demand header
            let newDemandRef;
            try {
              newDemandRef = await addDoc(collection(db, "demands"), headerData);
              logger.info("Demand created successfully", { demandId: newDemandRef.id });
            } catch (createError) {
              logger.error("Error creating demand", createError);
              if (createError.message && createError.message.includes("Missing or insufficient permissions")) {
                throw new Error("Yetki reddedildi. Ä°lgili ÅŸirketin sahibi/Ã¼yesi misiniz?");
              } else {
                throw new Error("Talep oluÅŸturulurken hata oluÅŸtu: " + (createError.message || createError));
              }
            }
            const demandId = newDemandRef.id;

            // Find matching suppliers or use selected suppliers
            let supplierUids = [];
            
            if (demandType === 'private') {
              // Ã–zel talep: seÃ§ilen tedarikÃ§ileri kullan
              supplierUids = Array.from(selectedSuppliers);
              logger.info('Ã–zel talep - seÃ§ilen tedarikÃ§iler', { count: supplierUids.length });
            } else {
              // Genel talep: kategorilerdeki tedarikÃ§ileri bul
              if ((headerData.categoryIds && headerData.categoryIds.length) || (headerData.categoryTags && headerData.categoryTags.length)) {
                try {
                  logger.info('Searching suppliers for categories', {
                    categoryIds: headerData.categoryIds,
                    categoryTags: headerData.categoryTags
                  });
                  
                  // CRITICAL: Use match-service.js for supplier matching (same as publishDemandAndMatchSuppliers)
                  try {
                    const { matchSuppliers } = await import('./src/matching/match-service.js');
                    
                    // Prepare legacy formats for backward compatibility
                    const legacySlugs = Array.isArray(headerData.categoryTags) ? headerData.categoryTags : [];
                    const legacyNames = (headerData.categoryIds || []).map(id => {
                      const cat = getAllCategories().find(c => c.id === id);
                      return cat ? cat.name : null;
                    }).filter(Boolean);
                    
                    // Use match service (same logic as publishDemandAndMatchSuppliers)
                    const matchedSuppliers = await matchSuppliers(db, {
                      categoryIds: headerData.categoryIds || [],
                      legacySlugs: legacySlugs,
                      legacyNames: legacyNames
                    });
                    
                    logger.info(`Matched ${matchedSuppliers.length} suppliers using match-service.js`);
                    
                    // CRITICAL: match-service now returns suppliers with uid/id attached
                    // Extract supplier IDs (excluding demand creator)
                    supplierUids = matchedSuppliers
                      .map(supplier => supplier.uid || supplier.id)
                      .filter(uid => uid && uid !== user.uid);
                    
                    logger.info("Supplier query returned", { count: supplierUids.length, supplierIds: supplierUids });
                    
                    // Log unmatched demands for debugging
                    if (supplierUids.length === 0) {
                      logger.warn("No matching suppliers found", {
                        categoryIds: headerData.categoryIds,
                        categoryTags: headerData.categoryTags
                      });
                      // Log to unmatchedDemands collection for analysis
                      try {
                        await addDoc(collection(db, "unmatchedDemands"), {
                          demandId: demandId,
                          categoryIds: headerData.categoryIds,
                          categories: headerData.categoryTags,
                          createdAt: serverTimestamp()
                        });
                      } catch (logError) {
                        logger.warn("Could not log unmatched demand", logError.message);
                      }
                    }
                  } catch (innerError) {
                    logger.warn("Inner supplier matching error", innerError.message);
                  }
                } catch (supplierError) {
                  logger.warn("Could not find suppliers", supplierError.message);
                }
              }
            }

            // Update viewerIds
            if (supplierUids.length) {
              const allViewers = Array.from(new Set([user.uid, ...supplierUids]));
              await updateDoc(newDemandRef, { viewerIds: allViewers });
              logger.info("Updated viewerIds", { count: allViewers.length });
            }

            // Collect items data from form
            const itemsData = [];
            const rows = itemsBody.querySelectorAll("tr");
            rows.forEach((row, index) => {
              const sku = row.querySelector(".sku")?.value?.trim() || "";
              const itemName = row.querySelector(".itemName")?.value?.trim() || "";
              const brandModel = row.querySelector(".brandModel")?.value?.trim() || "";
              const qty = parseFloat(row.querySelector(".qty")?.value) || 0;
              const unit = row.querySelector(".unit")?.value?.trim() || "";
              const itemDueDate = row.querySelector(".itemDueDate")?.value || "";

              if (itemName && qty > 0 && unit) {
                const stockQty = parseFloat(row.querySelector(".stockQty")?.value) || 0;
                const targetPrice = parseFloat(row.querySelector(".targetPrice")?.value) || 0;
                const productImage = row.querySelector('.itemImageData')?.value || '';
                const featuresJson = row.querySelector('.featuresJson')?.value || '[]';
                const certsJson = row.querySelector('.certsJson')?.value || '[]';
                const altVal = row.querySelector('.altAcceptVal')?.value || '';
                let ozellikler = [];
                let kaliteSertifika = [];
                try { ozellikler = JSON.parse(featuresJson).filter(p => (p.key||'').trim() || (p.value||'').trim()); } catch {}
                try { kaliteSertifika = Array.from(new Set(JSON.parse(certsJson) || [])); } catch {}
                const alternatifKabul = altVal === 'true' ? true : (altVal === 'false' ? false : null);
                
                itemsData.push({
                  lineNo: parseInt(row.dataset.lineNo || (itemsData.length + 1)),
                  sku,
                  name: itemName,
                  brandModel,
                  qty,
                  unit,
                  itemDueDate: itemDueDate || null,
                  stockQty: stockQty > 0 ? stockQty : null, // Ambardaki Miktar
                  targetPrice: targetPrice > 0 ? targetPrice : null, // Hedef Fiyat
                  productImage: productImage || null,
                  ozellikler: ozellikler.length ? ozellikler : null,
                  alternatifKabul: typeof alternatifKabul === 'boolean' ? alternatifKabul : null,
                  kaliteSertifika: (kaliteSertifika && kaliteSertifika.length) ? kaliteSertifika : null
                });
              }
            });

            // Add items
            for (const item of itemsData) {
              await addDoc(collection(db, "demands", demandId, "items"), {
                ...item,
                createdAt: serverTimestamp()
              });
            }

            localStorage.setItem("lastDemandId", demandId);
            
            // Onay ekranÄ± gÃ¶ster
            showApprovalModal(demandId);

          } else {
            // ====================
            // EDIT MODE
            // ====================
            logger.info("Updating existing demand", { demandId: editId });
            
            // Add companyId for multi-company support
            headerData.companyId = companyId;
            // Keep published field for backward compatibility
            headerData.published = headerData.isPublished;

            // Update header (keep published=false for safety)
            await updateDoc(demandRef, headerData);

            // Collect items data from form
            const itemsData = [];
            const rows = itemsBody.querySelectorAll("tr");
            rows.forEach((row, index) => {
              const sku = row.querySelector(".sku")?.value?.trim() || "";
              const itemName = row.querySelector(".itemName")?.value?.trim() || "";
              const brandModel = row.querySelector(".brandModel")?.value?.trim() || "";
              const qty = parseFloat(row.querySelector(".qty")?.value) || 0;
              const unit = row.querySelector(".unit")?.value?.trim() || "";
              const itemDueDate = row.querySelector(".itemDueDate")?.value || "";

              if (itemName && qty > 0 && unit) {
                const stockQty = parseFloat(row.querySelector(".stockQty")?.value) || 0;
                const targetPrice = parseFloat(row.querySelector(".targetPrice")?.value) || 0;
                const productImage = row.querySelector('.itemImageData')?.value || '';
                const featuresJson = row.querySelector('.featuresJson')?.value || '[]';
                const certsJson = row.querySelector('.certsJson')?.value || '[]';
                const altVal = row.querySelector('.altAcceptVal')?.value || '';
                let ozellikler = [];
                let kaliteSertifika = [];
                try { ozellikler = JSON.parse(featuresJson).filter(p => (p.key||'').trim() || (p.value||'').trim()); } catch {}
                try { kaliteSertifika = Array.from(new Set(JSON.parse(certsJson) || [])); } catch {}
                const alternatifKabul = altVal === 'true' ? true : (altVal === 'false' ? false : null);
                
                itemsData.push({
                  lineNo: parseInt(row.dataset.lineNo || (itemsData.length + 1)),
                  sku,
                  name: itemName,
                  brandModel,
                  qty,
                  unit,
                  itemDueDate: itemDueDate || null,
                  stockQty: stockQty > 0 ? stockQty : null, // Ambardaki Miktar
                  targetPrice: targetPrice > 0 ? targetPrice : null, // Hedef Fiyat
                  productImage: productImage || null,
                  ozellikler: ozellikler.length ? ozellikler : null,
                  alternatifKabul: typeof alternatifKabul === 'boolean' ? alternatifKabul : null,
                  kaliteSertifika: (kaliteSertifika && kaliteSertifika.length) ? kaliteSertifika : null
                });
              }
            });

            // Delete old items
            const oldItems = await getDocs(collection(db, "demands", editId, "items"));
            await Promise.all(oldItems.docs.map(d => deleteDoc(doc(db, "demands", editId, "items", d.id))));

            // Add new items
            for (const item of itemsData) {
              await addDoc(collection(db, "demands", editId, "items"), {
                ...item,
                createdAt: serverTimestamp()
              });
            }

            toast.success(MESSAGES.SUCCESS_DEMAND_UPDATED);
            location.href = `./demand-detail.html?id=${editId}`;
          }
        } catch (e) {
          logger.error("Demand creation/update error", e);
          const code = e?.code || "";
          if (code === "permission-denied") toast.error(MESSAGES.ERROR_PERMISSION_DENIED);
          else if (code === "not-found") toast.error(MESSAGES.ERROR_NOT_FOUND);
          else toast.error(MESSAGES.ERROR_OPERATION_FAILED + ": " + (e?.message || e));
        }
      };
    }

    // ====================
    // Onay Modal FonksiyonlarÄ±
    // ====================
    function showApprovalModal(demandId) {
      const modal = document.getElementById('approvalModal');
      const demandCodeEl = document.getElementById('approvalDemandCode');
      
      // SATFK'yi gÃ¶ster
      const satfk = document.getElementById('satfk').value;
      demandCodeEl.textContent = satfk || "OluÅŸturulacak...";
      
      // ModalÄ± gÃ¶ster
      modal.style.display = 'block';
      
      // Event listener'larÄ± ekle
      const approveBtn = document.getElementById('approveDemandBtn');
      const saveDraftBtn = document.getElementById('saveAsDraftBtn');
      const editBtn = document.getElementById('editDemandBtn');
      const closeBtn = document.getElementById('closeApprovalModalBtn');
      
      if (approveBtn) approveBtn.onclick = () => approveDemand(demandId);
      if (saveDraftBtn) saveDraftBtn.onclick = () => saveAsDraft(demandId);
      if (editBtn) editBtn.onclick = () => editDemand(demandId);
      if (closeBtn) closeBtn.onclick = () => closeApprovalModal();
    }
    
    function closeApprovalModal() {
      document.getElementById('approvalModal').style.display = 'none';
    }
    
    async function approveDemand(demandId) {
      try {
        // Talep durumunu 'approved' yap ve yayÄ±nla
        // CRITICAL FIX: Set both published and isPublished for compatibility
        await updateDoc(doc(db, 'demands', demandId), {
          status: 'approved',
          published: true,
          isPublished: true, // New system field
          statusHistory: arrayUnion({
            status: 'approved',
            timestamp: Date.now(),
            userId: user.uid,
            note: 'Talep onaylandÄ± ve yayÄ±nlandÄ±'
          }),
          updatedAt: serverTimestamp()
        });
        
        // TedarikÃ§i eÅŸleÅŸtirmesi yap (even if no suppliers found, still publish)
        try {
          await publishDemandAndMatchSuppliers(demandId);
        } catch (matchError) {
          logger.warn('TedarikÃ§i eÅŸleÅŸtirme hatasÄ± (talep yine de yayÄ±nlandÄ±)', matchError);
          // Don't fail the entire approval if supplier matching fails
        }
        
        closeApprovalModal();
        toast.success(MESSAGES.SUCCESS_DEMAND_APPROVED);
        location.href = `./demand-detail.html?id=${demandId}`;
        
      } catch (error) {
        logger.error('Talep onaylama hatasÄ±', error);
        toast.error(MESSAGES.ERROR_DEMAND_APPROVE + ': ' + error.message);
      }
    }
    
    async function saveAsDraft(demandId) {
      try {
        // Talep durumunu 'draft' olarak bÄ±rak
        await updateDoc(doc(db, 'demands', demandId), {
          status: 'draft',
          published: false,
          isPublished: false, // Yeni sistem iÃ§in
          visibility: 'private', // Taslaklar Ã¶zel olmalÄ±
          statusHistory: arrayUnion({
            status: 'draft',
            timestamp: Date.now(),
            userId: user.uid,
            note: 'Talep taslak olarak kaydedildi'
          }),
          updatedAt: serverTimestamp()
        });
        
        closeApprovalModal();
        toast.success(MESSAGES.SUCCESS_DEMAND_DRAFT);
        location.href = `./demand-detail.html?id=${demandId}`;
        
      } catch (error) {
        logger.error('Taslak kaydetme hatasÄ±', error);
        toast.error(MESSAGES.ERROR_DEMAND_DRAFT + ': ' + error.message);
      }
    }
    
    function editDemand(demandId) {
      // ModalÄ± kapat ama sayfada kal - form verileri kaybolmasÄ±n
      closeApprovalModal();
      // SayfayÄ± yenileme veya yÃ¶nlendirme yapma
      // KullanÄ±cÄ± form Ã¼zerinde kalÄ±r ve istediÄŸi deÄŸiÅŸiklikleri yapabilir
    }

    // ====================
    // TedarikÃ§i EÅŸleÅŸtirme Fonksiyonu
    // ====================
    async function publishDemandAndMatchSuppliers(demandId) {
      try {
        logger.info("Publishing demand and matching suppliers", { demandId });
        
        // Talep verilerini al
        const demandDoc = await getDoc(doc(db, 'demands', demandId));
        if (!demandDoc.exists()) {
          throw new Error('Talep bulunamadÄ±');
        }
        
        const demandData = demandDoc.data();
        
        // CRITICAL: Import match service
        const { matchSuppliers } = await import('./src/matching/match-service.js');
        
        // Collect all category tokens and normalize to IDs
        const categoryTokens = [];
        if (Array.isArray(demandData.categoryIds)) {
          categoryTokens.push(...demandData.categoryIds);
        }
        if (Array.isArray(demandData.supplierCategoryKeys)) {
          categoryTokens.push(...demandData.supplierCategoryKeys);
        }
        if (Array.isArray(demandData.categoryTags)) {
          categoryTokens.push(...demandData.categoryTags);
        }
        
        // Normalize all tokens to IDs using new system
        const categoryIds = normalizeToIds(categoryTokens);
        
        const groups = demandData.groupIds || [];
        
        logger.info('Demand category data', {
          categoryIds: demandData.categoryIds,
          categoryTags: demandData.categoryTags,
          supplierCategoryKeys: demandData.supplierCategoryKeys,
          normalizedCategoryIds: categoryIds,
          groups: groups
        });
        
        // Belirlenecek tedarikÃ§iler
        const allSuppliers = new Set();
        
        // CRITICAL: Use new match service for supplier matching
        if (categoryIds.length > 0) {
          // Prepare legacy formats for backward compatibility
          const legacySlugs = Array.isArray(demandData.categoryTags) ? demandData.categoryTags : [];
          const legacyNames = categoryIds.map(id => categoryIdToName(id)).filter(Boolean);
          
          // Use match service
          const matchedSuppliers = await matchSuppliers(db, {
            categoryIds: categoryIds,
            legacySlugs: legacySlugs,
            legacyNames: legacyNames
          });
          
          logger.info(`Matched ${matchedSuppliers.length} suppliers using new ID-based system`);
          
          // Collect supplier IDs (excluding demand creator)
          matchedSuppliers.forEach(supplier => {
            const supplierId = supplier.uid || supplier.id;
            if (supplierId && supplierId !== demandData.createdBy) {
              allSuppliers.add(supplierId);
            }
          });
        }
        
        // Grup bazlÄ± tedarikÃ§i sorgusu (keep for group matching)
        if (groups.length > 0) {
          try {
            const groupQuery = query(
              collection(db, 'users'),
              where('isActive', '==', true),
              where('groupIds', 'array-contains-any', groups)
            );
            const groupSnap = await getDocs(groupQuery);
            groupSnap.docs.forEach(doc => {
              if (doc.id !== demandData.createdBy) {
                allSuppliers.add(doc.id);
              }
            });
            logger.info(`Found ${groupSnap.docs.length} suppliers from groups`);
          } catch (groupError) {
            logger.error('Group query failed', groupError);
          }
        }
        
        logger.info(`Total unique suppliers found`, { count: allSuppliers.size });
        
        if (allSuppliers.size === 0) {
          logger.warn('No matching suppliers found', { categoryIds });
          logger.warn('Tip: Ensure suppliers have supplierCategoryIds populated with matching categories.');
        }


        // Exclude suppliers by name/code if provided (privacy-safe client filter; server can also enforce)
        const excludes = Array.isArray(demandData.excludeSuppliers) ? demandData.excludeSuppliers.map(x => (x?.nameOrCode||'').toLowerCase()).filter(Boolean) : [];
        if (excludes.length) {
          const kept = new Set();
          for (const sid of allSuppliers) {
            try {
              const sDoc = await getDoc(doc(db, 'users', sid));
              const d = sDoc.data() || {};
              const haystack = [d.displayName, d.companyName, d.taxNo, d.code, d.email].filter(Boolean).join(' ').toLowerCase();
              const match = excludes.some(x => haystack.includes(x));
              if (!match) kept.add(sid);
            } catch (e) { kept.add(sid); }
          }
          logger.info(`Excluding ${allSuppliers.size - kept.size} suppliers by user-provided exclude list`);
          allSuppliers.clear(); kept.forEach(id => allSuppliers.add(id));
        }
        
        // demandRecipients kayÄ±tlarÄ± oluÅŸtur
        const recipientPromises = Array.from(allSuppliers).map(supplierId => 
          addDoc(collection(db, 'demandRecipients'), {
            demandId: demandId,
            buyerId: demandData.createdBy,
            supplierId: supplierId,
            matchedAt: serverTimestamp(),
            status: 'pending',
            createdAt: serverTimestamp()
          })
        );
        
        await Promise.all(recipientPromises);
        
        logger.info(`Created ${recipientPromises.length} demandRecipients records`);
        
      } catch (error) {
        logger.error('Error in publishDemandAndMatchSuppliers', error);
        throw error;
      }
    }

    // ====================
    // Yeni Ã–zellikler - JavaScript FonksiyonlarÄ±
    // ====================
    
    // AÃ§Ä±klama yÃ¶netimi
    let descriptionCounter = 0;
    
    function addDescription() {
      const container = document.getElementById("descriptionsContainer");
      const index = container.children.length + 1;
      
      // Create description item row
      const row = document.createElement("div");
      row.className = "description-item";
      row.dataset.descriptionIndex = index;

      // Number label
      const numberLabel = document.createElement("span");
      numberLabel.className = "description-number";
      numberLabel.textContent = `${index}.`;
      row.appendChild(numberLabel);

      // Textarea
      const ta = document.createElement("textarea");
      ta.rows = 3;
      ta.id = `description_${index}`;
      ta.name = `description_${index}`;
      ta.placeholder = `${index}. AÃ§Ä±klama girin...`;
      row.appendChild(ta);

      // Delete button
      const del = document.createElement("button");
      del.className = "delete-btn";
      del.textContent = "Ã—";
      del.title = "Sil";
      del.onclick = () => {
        row.remove();
        // Renumber remaining descriptions
        updateDescriptionNumbers();
      };
      row.appendChild(del);

      container.appendChild(row);
    }
    
    function updateDescriptionNumbers() {
      const container = document.getElementById("descriptionsContainer");
      const items = container.querySelectorAll('.description-item');
      items.forEach((item, index) => {
        const number = index + 1;
        item.dataset.descriptionIndex = number;
        const numberLabel = item.querySelector('.description-number');
        if (numberLabel) {
          numberLabel.textContent = `${number}.`;
        }
        const textarea = item.querySelector('textarea');
        if (textarea) {
          textarea.id = `description_${number}`;
          textarea.name = `description_${number}`;
          textarea.placeholder = `${number}. AÃ§Ä±klama girin...`;
        }
      });
    }
    
    function clearDescriptions() {
      const container = document.getElementById("descriptionsContainer");
      container.innerHTML = "";
    }
    
    
    function getDescriptions() {
      const textareas = document.querySelectorAll('#descriptionsContainer textarea');
      return Array.from(textareas).map(textarea => textarea.value.trim()).filter(val => val);
    }
    
    // Teslim ÅŸekli yÃ¶netimi
    function setupDeliveryMethodHandlers() {
      const radioButtons = document.querySelectorAll('input[name="deliveryMethod"]');
      const customContainer = document.getElementById('customDeliveryContainer');
      const customInput = document.getElementById('customDelivery');
      const customTextInput = document.getElementById('deliveryMethodCustom');
      
      radioButtons.forEach(radio => {
        radio.addEventListener('change', () => {
          if (radio.value === 'custom') {
            customContainer.style.display = 'block';
            customInput.required = true;
          } else {
            customContainer.style.display = 'none';
            customInput.required = false;
            customInput.value = '';
          }
          
          // Radio button seÃ§ildiÄŸinde elle yazma alanÄ±nÄ± gÃ¼ncelle
          if (customTextInput) {
            if (radio.value === 'nakliye_dahil') {
              customTextInput.value = 'Nakliye Dahil';
            } else if (radio.value === 'nakliye_haric') {
              customTextInput.value = 'Nakliye HariÃ§';
            } else if (radio.value === 'custom') {
              customTextInput.value = '';
              customTextInput.placeholder = 'Ã–zel teslimat aÃ§Ä±klamasÄ±nÄ± yazÄ±n';
            }
          }
        });
      });
      
      // Elle yazma alanÄ± deÄŸiÅŸtiÄŸinde radio button'larÄ± temizle
      if (customTextInput) {
        customTextInput.addEventListener('input', () => {
          if (customTextInput.value.trim()) {
            radioButtons.forEach(radio => radio.checked = false);
          }
        });
      }
    }
    
    function getDeliveryMethod() {
      // Ã–nce elle yazÄ±lan deÄŸeri kontrol et
      const customInput = document.getElementById('deliveryMethodCustom');
      if (customInput && customInput.value.trim()) {
        return customInput.value.trim();
      }
      
      // Sonra radio button'larÄ± kontrol et
      const selected = document.querySelector('input[name="deliveryMethod"]:checked');
      if (!selected) return null;
      
      if (selected.value === 'custom') {
        const customValue = document.getElementById('customDelivery').value.trim();
        return customValue || null;
      }
      
      return selected.value;
    }
    
    // Teslimat adresi yÃ¶netimi
    async function setupDeliveryAddressHandlers() {
      const select = document.getElementById('deliveryAddressSelect');
      const textarea = document.getElementById('deliveryAddress');
      const refreshBtn = document.getElementById('refreshAddressesBtn');
      const verifyBtn = document.getElementById('verifyDeliveryAddressBtn');
      const verifiedDiv = document.getElementById('deliveryAddressVerified');
      const coordsSpan = document.getElementById('deliveryAddressCoords');
      const latInput = document.getElementById('delivery_lat');
      const lngInput = document.getElementById('delivery_lng');
      
      // Adres doÄŸrulama butonu
      // Teklifbul Rule v1.0 - Buton event listener'Ä± her zaman baÄŸlanmalÄ±
      if (verifyBtn) {
        // Ã–nceki listener'larÄ± temizle (tekrar baÄŸlanma durumunda)
        verifyBtn.replaceWith(verifyBtn.cloneNode(true));
        const newVerifyBtn = document.getElementById('verifyDeliveryAddressBtn');
        
        newVerifyBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          try {
            logger.info('Adres doÄŸrulama butonu tÄ±klandÄ±');
            const currentAddress = textarea?.value || '';
            
            if (!currentAddress || currentAddress.trim().length < 5) {
              toast.error(MESSAGES.ERROR_ADDRESS_MISSING);
              return;
            }
            
            // Modal'Ä± import et ve gÃ¶ster
            const { showAddressVerifyModal } = await import('./assets/js/address-verify-modal.js');
            
            showAddressVerifyModal({
              defaultAddress: currentAddress,
              onConfirm: (result) => {
                // Teklifbul Rule v1.0 - Adres doÄŸrulama sonucu
                if (textarea) {
                  textarea.value = result.address;
                  textarea.removeAttribute('disabled'); // DoÄŸrulama sonrasÄ± dÃ¼zenlenebilir yap
                }
                if (latInput) latInput.value = result.lat.toString();
                if (lngInput) lngInput.value = result.lng.toString();
                
                // DoÄŸrulama badge'i gÃ¶ster
                if (verifiedDiv) verifiedDiv.style.display = 'block';
                if (coordsSpan) {
                  coordsSpan.textContent = `lat: ${result.lat.toFixed(6)} Â· lng: ${result.lng.toFixed(6)}`;
                }
                
                logger.info('Adres doÄŸrulandÄ±', result);
              },
              onCancel: () => {
                logger.info('Adres doÄŸrulama iptal edildi');
              }
            });
          } catch (err) {
            logger.error('Adres doÄŸrulama modal hatasÄ±', err);
            toast.error(MESSAGES.ERROR_ADDRESS_VERIFY + ': ' + (err.message || err));
          }
        });
        
        logger.info('Adres doÄŸrulama butonu event listener baÄŸlandÄ±');
      } else {
        logger.warn('verifyDeliveryAddressBtn bulunamadÄ±');
      }
      
      // Yenile butonu - Yeni sistem
      refreshBtn.addEventListener('click', async () => {
        try {
          const user = await requireAuth();
          
          // Mevcut seÃ§enekleri temizle
          select.innerHTML = '<option value="">BaÅŸlÄ±k seÃ§in</option>';
          
          // KullanÄ±cÄ± verilerini yÃ¼kle
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists()) {
            const userData = userDoc.data();
            logger.info("KullanÄ±cÄ± verileri", userData);
            
            // Fatura adresini seÃ§enek olarak ekle (varsa)
            if (userData.invoiceAddress) {
              const opt = document.createElement("option");
              opt.value = "invoice";
              opt.textContent = "Fatura Adresi";
              select.appendChild(opt);
              logger.info("Fatura adresi seÃ§eneÄŸi eklendi");
            } else {
              logger.warn("Fatura adresi bulunamadÄ±");
            }
            
            // Ä°lave adresleri baÅŸlÄ±kla listele
            const additionalAddresses = userData.additionalAddresses || [];
            logger.info("Ä°lave adresler", { count: additionalAddresses.length });
            
            additionalAddresses.forEach((a, i) => {
              const opt = document.createElement("option");
              opt.value = `addr:${i}`;
              opt.textContent = a.title || `Adres ${i + 1}`;
              select.appendChild(opt);
              logger.info(`Adres seÃ§eneÄŸi eklendi`, { title: a.title });
            });
            
            logger.info(`${additionalAddresses.length} adet ilave adres yÃ¼klendi`);
          } else {
            logger.error("KullanÄ±cÄ± verisi bulunamadÄ±");
          }
        } catch (error) {
          logger.error("Adresler yÃ¼klenemedi", error);
        }
      });
      
      // Select deÄŸiÅŸikliÄŸi - Yeni sistem
      select.addEventListener('change', async () => {
        if (!select.value) { 
          textarea.value = ""; 
          textarea.disabled = false;
          textarea.placeholder = "Teslimat adresini yazÄ±n veya yukarÄ±dan seÃ§in";
          return; 
        }
        
        if (select.value === "invoice") {
          try {
            const user = await requireAuth();
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
              const userData = userDoc.data();
              const p = userData.invoiceAddressParts || {};
              const taxNo = userData.taxNumber || "";
              const taxOf = userData.taxOffice || "";
              // Compose in requested order: Mahalle - Cadde - Sokak - KapÄ± No - Daire - Ä°lÃ§e/Ä°l - Vergi No - Vergi Dairesi
              const parts = [
                p.mahalle || null,
                p.cadde || null,
                p.sokak || null,
                p.kapiNo ? `KapÄ± No: ${p.kapiNo}` : null,
                p.daire ? `Daire: ${p.daire}` : null,
                (p.ilce && p.il) ? `${p.ilce} / ${p.il}` : (p.il || p.ilce || null),
                taxNo ? `Vergi No: ${taxNo}` : null,
                taxOf ? `Vergi Dairesi: ${taxOf}` : null
              ].filter(Boolean);
              const composed = parts.join(" - ");
              textarea.value = composed || userData.invoiceAddress || "";
              textarea.disabled = true;
              // Placeholder'Ä± kaldÄ±r Ã§Ã¼nkÃ¼ value var
              textarea.removeAttribute('placeholder');
              textarea.style.setProperty('background', '#f9fafb', 'important');
              textarea.style.setProperty('color', '#1f2937', 'important');
            }
          } catch (error) {
            logger.error("Fatura adresi yÃ¼klenemedi", error);
          }
          return;
        }
        
        if (select.value.startsWith("addr:")) {
          try {
            const user = await requireAuth();
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
              const userData = userDoc.data();
              const idx = Number(select.value.split(":")[1]);
              const addr = userData.additionalAddresses?.[idx];
              logger.info("SeÃ§ilen adres", { idx, addr, content: addr?.content });
              
              if (addr) {
                // Teklifbul Rule v1.0 - Adres iÃ§eriÄŸini textarea'ya yaz (content varsa, yoksa structured data'dan oluÅŸtur)
                let addressContent = addr.content;
                
                // EÄŸer content yoksa, structured data'dan oluÅŸtur
                if (!addressContent || addressContent.trim() === '') {
                  const parts = [];
                  if (addr.mahalle) parts.push(`${addr.mahalle}${addr.mahalle.includes('Mahalle') ? '' : ' Mahalle'}`);
                  if (addr.cadde) parts.push(`${addr.cadde}${addr.cadde.includes('Cadde') ? '' : ' Cadde'}`);
                  if (addr.street) parts.push(`${addr.street}${addr.street.includes('Sokak') || addr.street.includes('Cadde') ? '' : ' Sokak'}`);
                  if (addr.building || addr.kapi) parts.push(`KapÄ± No: ${addr.building || addr.kapi}`);
                  if (addr.daire) parts.push(`Daire: ${addr.daire}`);
                  if (addr.district || addr.ilce) parts.push(`Ä°lÃ§e: ${addr.district || addr.ilce}`);
                  if (addr.city || addr.il) parts.push(`Ä°l: ${addr.city || addr.il}`);
                  if (addr.postakodu) parts.push(`Posta Kodu: ${addr.postakodu}`);
                  parts.push('TÃ¼rkiye');
                  addressContent = parts.filter(Boolean).join(' - ');
                }
                
                textarea.value = addressContent || "";
                textarea.disabled = true;
                // Placeholder'Ä± kaldÄ±r Ã§Ã¼nkÃ¼ value var
                textarea.removeAttribute('placeholder');
                textarea.style.setProperty('display', 'block', 'important');
                textarea.style.setProperty('background', '#f9fafb', 'important');
                textarea.style.setProperty('color', '#1f2937', 'important');
                
                logger.info("Adres iÃ§eriÄŸi textarea'ya yazÄ±ldÄ±", { addressContent, length: textarea.value.length });
              } else {
                logger.warn("Adres bulunamadÄ±", { index: idx });
              }
            }
          } catch (error) {
            logger.error("Ä°lave adres yÃ¼klenemedi", error);
          }
          return;
        }
        
        // VarsayÄ±lan durum
        textarea.value = "";
        textarea.disabled = false;
        textarea.placeholder = "Teslimat adresini yazÄ±n veya yukarÄ±dan seÃ§in";
      });
      
      // Ä°lk yÃ¼kleme
      if (refreshBtn) {
        refreshBtn.click();
      }
      
      logger.info('setupDeliveryAddressHandlers tamamlandÄ±');
    }
    
    // Event listener'larÄ± ekle
    function initDemandPageMain() {
      // AÃ§Ä±klama butonlarÄ±
      const addDescBtn = document.getElementById('addDescriptionBtn');
      const clearDescBtn = document.getElementById('clearDescriptionsBtn');
      
      if (addDescBtn) addDescBtn.onclick = addDescription;
      if (clearDescBtn) clearDescBtn.onclick = clearDescriptions;
      
      // Teslim ÅŸekli
      setupDeliveryMethodHandlers();
      
      // Teklifbul Rule v1.0 - Teslimat adresi handler'larÄ±nÄ± baÅŸlat
      setupDeliveryAddressHandlers().catch(err => {
        logger.error("Teslimat adresi handler'larÄ± baÅŸlatÄ±lamadÄ±", err);
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDemandPageMain);
    } else {
      initDemandPageMain();
    }
  </script>

  <!-- DEMAND PAGE: Descriptions + Delivery Address wiring -->
  <script type="module">
    import { auth, db } from "./firebase.js";
    import {
      doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import {
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    // Teklifbul Rule v1.0 - Structured Logging
    import { logger } from './src/shared/log/logger.js';
    // Teklifbul Rule v1.0 - Toast Notification System
    import { toast } from './src/shared/ui/toast.js';
    // Teklifbul Rule v1.1 - MESSAGES constants (i18n hazÄ±rlÄ±ÄŸÄ±)
    import { MESSAGES } from './src/shared/constants/messages.js';

    // ---------- helpers ----------
    async function getCurrentUser() {
      if (auth.currentUser) return auth.currentUser;
      return await new Promise((resolve, reject) => {
        const unsub = onAuthStateChanged(auth, (u) => { unsub(); u ? resolve(u) : reject(new Error("not signed in")); });
      });
    }

    function $(sel) { return document.querySelector(sel); }
    function el(html) { const d = document.createElement("div"); d.innerHTML = html.trim(); return d.firstElementChild; }

    // KullanÄ±cÄ± rolÃ¼ne gÃ¶re Onay KiÅŸileri Ã¶n-doldurma
    async function prefillApprovalFields(){
      try {
        const u = await getCurrentUser();
        const snap = await getDoc(doc(db,'users',u.uid));
        const me = snap.exists() ? snap.data() : {};
        const name = me.displayName || u.displayName || u.email || '';
        const role = me.companyRole || '';

        const $req = $('#requester');
        const $pur = $('#purchaseManager');
        const $gm  = $('#generalManager');
        const $apr = $('#approver');

        // Talep Eden otomatik doldurulmaz; adresi oluÅŸturan ÅŸantiye/depo/mutfak yetkilisi elle yazÄ±lÄ±r

        // Rol bazlÄ± alanlar
        if (role === 'satinalma_yetkilisi' && $pur && !$pur.value) $pur.value = name;
        if (role === 'genel_mudur' && $gm && !$gm.value) $gm.value = name;
        if ((role === 'genel_mudur' || role === 'isveren' || role === 'yonetim_kurulu_baskani' || role === 'ceo') && $apr && !$apr.value) $apr.value = name;
      } catch (e) { logger.warn('prefillApprovalFields failed', e); }
    }

    // ---------- AÃ‡IKLAMA EKLE ----------
    function bindDescriptions() {
      const addBtn = $("#addDescriptionBtn");
      const clearBtn = $("#clearDescriptionsBtn");
      const wrap = $("#descriptionsContainer");

      if (!addBtn || !wrap) return;

      addBtn.onclick = () => {
        const container = document.getElementById("descriptionsContainer");
        const index = container.children.length + 1;
        
        // Create description item row
        const row = document.createElement("div");
        row.className = "description-item";
        row.dataset.descriptionIndex = index;

        // Number label
        const numberLabel = document.createElement("span");
        numberLabel.className = "description-number";
        numberLabel.textContent = `${index}.`;
        row.appendChild(numberLabel);

        // Textarea
        const ta = document.createElement("textarea");
        ta.rows = 3;
        ta.id = `description_${index}`;
        ta.name = `description_${index}`;
        ta.placeholder = `${index}. AÃ§Ä±klama girin...`;
        row.appendChild(ta);
        
        // Teklifbul Rule v1.0 - Kategori Ã¶neri sistemi entegrasyonu
        setupCategorySuggestionForTextarea(ta, index);

        // Delete button
        const del = document.createElement("button");
        del.className = "delete-btn";
        del.textContent = "Ã—";
        del.title = "Sil";
        del.onclick = () => {
          row.remove();
          // Renumber remaining descriptions
          updateDescriptionNumbers();
        };
        row.appendChild(del);

        container.appendChild(row);
      };
      
      if (clearBtn) {
        clearBtn.onclick = () => { 
          wrap.innerHTML = ""; 
          // Ã–neri kartlarÄ±nÄ± da temizle
          document.querySelectorAll('.category-suggestion-card').forEach(card => card.remove());
        };
      }
    }
    
    // Teklifbul Rule v1.0 - Kategori Ã¶neri sistemi: aÃ§Ä±klama alanlarÄ± iÃ§in
    async function setupCategorySuggestionForTextarea(textarea, index) {
      if (!textarea) return;
      
      let suggestionCardId = `categorySuggestion_${index}`;
      let debounceTimeout = null;
      let lastQuery = ''; // Her textarea iÃ§in ayrÄ± lastQuery
      
      // Debounced Ã¶neri fonksiyonu
      textarea.addEventListener('input', (e) => {
        const text = e.target.value.trim();
        
        clearTimeout(debounceTimeout);
        
        // 3 karakterden azsa Ã¶neri kartÄ±nÄ± kaldÄ±r
        if (text.length < 3) {
          removeSuggestionCard(suggestionCardId);
          lastQuery = '';
          return;
        }
        
        // AynÄ± sorguyu tekrar etme
        if (text === lastQuery) return;
        
        debounceTimeout = setTimeout(async () => {
          lastQuery = text;
          await suggestCategoriesForText(text, suggestionCardId, textarea, () => lastQuery);
        }, 300); // 300ms debounce
      });
      
      // Textarea'dan Ã§Ä±kÄ±nca Ã¶neri kartÄ±nÄ± gizle (opsiyonel)
      textarea.addEventListener('blur', () => {
        setTimeout(() => {
          const card = document.getElementById(suggestionCardId);
          if (card) {
            // KullanÄ±cÄ± kart ile etkileÅŸimde deÄŸilse gizle
            if (!card.matches(':hover')) {
              card.style.display = 'none';
            }
          }
        }, 200);
      });
      
      textarea.addEventListener('focus', () => {
        const card = document.getElementById(suggestionCardId);
        if (card && lastQuery.length >= 3) {
          card.style.display = 'block';
        }
      });
    }
    
    async function suggestCategoriesForText(text, cardId, textarea, getLastQuery) {
      try {
        // API Ã§aÄŸrÄ±sÄ±
        const { suggestCategories } = await import('/assets/js/services/category-suggest.js');
        const result = await suggestCategories(text);
        
        if (!result || result.suggestions.length === 0) {
          removeSuggestionCard(cardId);
          return;
        }
        
        // Ã–neri kartÄ±nÄ± gÃ¶ster/gÃ¼ncelle
        showSuggestionCard(result, cardId, textarea);
        
        // Auto-select (skor â‰¥0.70)
        if (result.auto_select) {
          showAutoSelectNotification(result.auto_select, textarea);
        }
        
      } catch (error) {
        logger.warn('Category suggestion failed', error);
      }
    }
    
    function showSuggestionCard(result, cardId, textarea) {
      // Mevcut kartÄ± kaldÄ±r
      removeSuggestionCard(cardId);
      
      // Yeni kart oluÅŸtur
      const card = document.createElement('div');
      card.id = cardId;
      card.className = 'category-suggestion-card';
      card.style.cssText = `
        margin-top: 8px;
        padding: 12px;
        background: #f0f9ff;
        border: 1px solid #3b82f6;
        border-radius: 8px;
        font-size: 13px;
      `;
      
      let content = `<div style="font-weight: 600; margin-bottom: 8px; color: #1e40af;">
        ğŸ’¡ Kategori Ã–nerileri (${result.suggestions.length})
      </div>`;
      
      // Top-3 Ã¶neri gÃ¶ster
      result.suggestions.slice(0, 3).forEach((suggestion, idx) => {
        const scorePercent = Math.round(suggestion.score * 100);
        const isHighConfidence = suggestion.score >= 0.70;
        const badgeColor = isHighConfidence ? '#10b981' : '#f59e0b';
        
        content += `<div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 6px; border-left: 3px solid ${badgeColor};">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 600; color: #1f2937;">${idx + 1}. ${suggestion.name}</span>
            <span style="font-size: 11px; color: ${badgeColor}; font-weight: 600;">${scorePercent}%</span>
          </div>
          ${suggestion.reasons && suggestion.reasons.length > 0 ? `
            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
              EÅŸleÅŸen: ${suggestion.reasons.slice(0, 3).join(', ')}
            </div>
          ` : ''}
          <button class="apply-category-btn" data-category="${suggestion.name}" 
                  style="margin-top: 6px; padding: 4px 10px; background: ${badgeColor}; color: white; 
                         border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
            ${isHighConfidence ? 'âœ… Otomatik Uygula' : 'SeÃ§'}
          </button>
        </div>`;
      });
      
      // Kapat butonu
      content += `<button class="close-suggestion-btn" style="margin-top: 8px; padding: 4px 10px; background: #6b7280; 
                color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
        Kapat
      </button>`;
      
      card.innerHTML = content;
      
      // Textarea'nÄ±n hemen altÄ±na ekle
      const row = textarea.closest('.description-item');
      if (row) {
        row.insertAdjacentElement('afterend', card);
      } else {
        textarea.parentElement.appendChild(card);
      }
      
      // Event listeners
      card.querySelectorAll('.apply-category-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const categoryName = btn.dataset.category;
          const queryText = textarea.value.trim();
          await applyCategorySuggestion(categoryName, queryText);
          removeSuggestionCard(cardId);
        });
      });
      
      card.querySelector('.close-suggestion-btn')?.addEventListener('click', () => {
        removeSuggestionCard(cardId);
      });
    }
    
    function showAutoSelectNotification(categoryName, textarea) {
      // Textarea'nÄ±n yanÄ±nda kÃ¼Ã§Ã¼k bir bildirim gÃ¶ster
      const existingNotif = document.getElementById(`autoSelectNotif_${textarea.id}`);
      if (existingNotif) return;
      
      const notif = document.createElement('div');
      notif.id = `autoSelectNotif_${textarea.id}`;
      notif.style.cssText = `
        position: absolute;
        top: -30px;
        right: 0;
        padding: 6px 10px;
        background: #10b981;
        color: white;
        border-radius: 4px;
        font-size: 11px;
        z-index: 100;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      `;
      notif.innerHTML = `âœ… Ã–nerilen kategori: <strong>${categoryName}</strong>`;
      
      const row = textarea.closest('.description-item');
      if (row) {
        row.style.position = 'relative';
        row.appendChild(notif);
        
        // 5 saniye sonra kaldÄ±r
        setTimeout(() => {
          notif.remove();
        }, 5000);
      }
    }
    
    async function applyCategorySuggestion(categoryName, queryText = '') {
      // Kategori chip sistemine ekle
      if (typeof addCategoryChip === 'function') {
        addCategoryChip(categoryName);
      } else if (window.categoryGroupsModal) {
        // Alternatif: kategori seÃ§im modalÄ±nÄ± aÃ§ ve seÃ§
  toast.info(MESSAGES.INFO_CATEGORY_SUGGESTED_WITH_NAME.replace('{name}', categoryName));
      }
      
      // Feedback kaydet
      try {
        const { saveCategoryFeedback } = await import('/assets/js/services/category-suggest.js');
        await saveCategoryFeedback({
          query: queryText || '',
          suggested_category_id: null, // ID bulunursa eklenecek
          chosen_category_id: null,
          query: queryText || ''
        });
      } catch (error) {
        logger.warn('Save feedback failed', error);
      }
    }
    
    function removeSuggestionCard(cardId) {
      const card = document.getElementById(cardId);
      if (card) {
        card.remove();
      }
    }
    
    // Mevcut aÃ§Ä±klama alanlarÄ± iÃ§in de setup yap (sayfa yÃ¼klendiÄŸinde)
    function setupExistingDescriptionFields() {
      const existingTextareas = document.querySelectorAll('#descriptionsContainer textarea');
      existingTextareas.forEach((ta, idx) => {
        const index = idx + 1;
        setupCategorySuggestionForTextarea(ta, index);
      });
    }

    // ---------- ADRES SEÃ‡Ä°MÄ° ----------
    async function loadAddressesForDemand() {
      const sel = $("#deliveryAddressSelect");
      const ta  = $("#deliveryAddress");
      const siteInput = $("#siteName");
      const siteList = document.getElementById("siteNameList");
      if (!sel || !ta) return;

      // varsayÄ±lan
      sel.innerHTML = `<option value="">BaÅŸlÄ±k seÃ§in</option>`;

      try {
        const user = await getCurrentUser();
        const uref = doc(db, "users", user.uid);
        const data = (await getDoc(uref)).data() || {};

        // list: fatura + ilave adresler
        // Teklifbul Rule v1.0 - Content yoksa structured data'dan oluÅŸtur
        const list = [];
        if (data.invoiceAddress) list.push({ title: "Fatura Adresi", content: data.invoiceAddress, kind: "invoice" });
        const additional = Array.isArray(data.additionalAddresses) ? data.additionalAddresses : [];
        additional.forEach(a => {
          if (a?.title) {
            // Content varsa kullan, yoksa structured data'dan oluÅŸtur
            let content = a.content || "";
            if (!content || content.trim() === '') {
              const parts = [];
              if (a.mahalle) parts.push(`${a.mahalle}${a.mahalle.includes('Mahalle') ? '' : ' Mahalle'}`);
              if (a.cadde) parts.push(`${a.cadde}${a.cadde.includes('Cadde') ? '' : ' Cadde'}`);
              if (a.street) parts.push(`${a.street}${a.street.includes('Sokak') || a.street.includes('Cadde') ? '' : ' Sokak'}`);
              if (a.building || a.kapi) parts.push(`KapÄ± No: ${a.building || a.kapi}`);
              if (a.daire) parts.push(`Daire: ${a.daire}`);
              if (a.district || a.ilce) parts.push(`Ä°lÃ§e: ${a.district || a.ilce}`);
              if (a.city || a.il) parts.push(`Ä°l: ${a.city || a.il}`);
              if (a.postakodu) parts.push(`Posta Kodu: ${a.postakodu}`);
              parts.push('TÃ¼rkiye');
              content = parts.filter(Boolean).join(' - ');
            }
            list.push({ 
              title: a.title, 
              content: content, 
              kind: "addr",
              // Structured data'yÄ± da sakla (geriye dÃ¶nÃ¼k uyumluluk iÃ§in)
              ...a
            });
          }
        });

        // select'i doldur
        // Teklifbul Rule v1.0 - Value formatÄ±: "invoice" veya "addr:0", "addr:1" (yeni sistemle uyumlu)
        sel.innerHTML = `<option value="">BaÅŸlÄ±k seÃ§in</option>` +
          list.map((a, i) => {
            const value = a.kind === "invoice" ? "invoice" : `addr:${i - (list[0]?.kind === "invoice" ? 1 : 0)}`;
            return `<option value="${value}">${a.title}</option>`;
          }).join("");

        // Site adÄ± Ã¶nerileri (yalnÄ±zca ilave adres baÅŸlÄ±klarÄ±)
        if (siteList) {
          siteList.innerHTML = additional
            .filter(a => a?.title)
            .map(a => `<option value="${a.title}"></option>`)
            .join("");
        }

        // baÅŸlÄ±k â†’ index eÅŸlemesi ve global referans
        window.__deliveryTitleIndex = Object.fromEntries(list.map((a, i) => [a.title, String(i)]));
        window.__deliveryList = list;

        // helper: province fill
        const purchaseInput = document.getElementById('purchaseLocation');
        function extractProvince(str){
          const m = /Ä°l:\s*([^\-]+)/i.exec(String(str||''));
          return m ? m[1].trim() : '';
        }

        // change â†’ textarea doldur + AlÄ±m Yeri (Ä°l) doldur
        // Teklifbul Rule v1.0 - Eski sistem handler'Ä±, yeni sistemle uyumlu (invoice veya addr:0 formatÄ±)
        sel.onchange = () => {
          const v = sel.value;
          if (v === "") {
            ta.value = "";
            ta.disabled = false;
            ta.placeholder = "Teslimat adresini yazÄ±n veya yukarÄ±dan seÃ§in";
            ta.style.setProperty('display', 'block', 'important');
            return;
          }
          
          // Value formatÄ±: "invoice" veya "addr:0", "addr:1" gibi
          let selectedAddr = null;
          if (v === "invoice") {
            selectedAddr = list.find(a => a.kind === "invoice");
          } else if (v.startsWith("addr:")) {
            const idx = Number(v.split(":")[1]);
            // Fatura adresi varsa index 1'den baÅŸlar, yoksa 0'dan
            const invoiceCount = list[0]?.kind === "invoice" ? 1 : 0;
            selectedAddr = list[idx + invoiceCount];
          } else {
            // Geriye dÃ¶nÃ¼k uyumluluk: sadece sayÄ± ise
            selectedAddr = list[Number(v)];
          }
          
          if (selectedAddr) {
            let addressContent = selectedAddr.content || "";
            
            // EÄŸer content boÅŸsa, structured data'dan oluÅŸtur (geriye dÃ¶nÃ¼k uyumluluk)
            if (!addressContent || addressContent.trim() === '') {
              const parts = [];
              if (selectedAddr.mahalle) parts.push(`${selectedAddr.mahalle}${selectedAddr.mahalle.includes('Mahalle') ? '' : ' Mahalle'}`);
              if (selectedAddr.cadde) parts.push(`${selectedAddr.cadde}${selectedAddr.cadde.includes('Cadde') ? '' : ' Cadde'}`);
              if (selectedAddr.street) parts.push(`${selectedAddr.street}${selectedAddr.street.includes('Sokak') || selectedAddr.street.includes('Cadde') ? '' : ' Sokak'}`);
              if (selectedAddr.building || selectedAddr.kapi) parts.push(`KapÄ± No: ${selectedAddr.building || selectedAddr.kapi}`);
              if (selectedAddr.daire) parts.push(`Daire: ${selectedAddr.daire}`);
              if (selectedAddr.district || selectedAddr.ilce) parts.push(`Ä°lÃ§e: ${selectedAddr.district || selectedAddr.ilce}`);
              if (selectedAddr.city || selectedAddr.il) parts.push(`Ä°l: ${selectedAddr.city || selectedAddr.il}`);
              if (selectedAddr.postakodu) parts.push(`Posta Kodu: ${selectedAddr.postakodu}`);
              parts.push('TÃ¼rkiye');
              addressContent = parts.filter(Boolean).join(' - ');
            }
            
            ta.value = addressContent;
            ta.disabled = true;
            ta.placeholder = `SeÃ§ilen adres: ${selectedAddr.title || 'Adres'}`;
            ta.style.setProperty('display', 'block', 'important');
            ta.style.setProperty('visibility', 'visible', 'important');
            ta.style.setProperty('opacity', '1', 'important');
            ta.style.setProperty('background', 'white', 'important');
            ta.style.setProperty('color', '#1f2937', 'important');
            ta.style.setProperty('min-height', '80px', 'important');
            
            // Teklifbul Rule v1.0 - Textarea'nÄ±n value'sunu zorla gÃ¼ncelle (disabled olsa bile)
            // Textarea'da textContent deÄŸil value kullanÄ±lmalÄ±
            ta.value = addressContent;
            // Placeholder'Ä± kaldÄ±r Ã§Ã¼nkÃ¼ value var
            ta.removeAttribute('placeholder');
            
            logger.info("Adres iÃ§eriÄŸi yÃ¼klendi (eski sistem)", { addressContent, length: ta.value.length });
          } else {
            ta.value = "";
            ta.disabled = false;
            ta.placeholder = "Teslimat adresini yazÄ±n veya yukarÄ±dan seÃ§in";
          }
          
          // province fill from address text
          if (purchaseInput) {
            const p = extractProvince(ta.value);
            if (p) { purchaseInput.value = p; purchaseInput.dispatchEvent(new Event('change', { bubbles:true })); }
          }
        };

        // Åantiye alanÄ± seÃ§ilince baÅŸlÄ±ÄŸa gÃ¶re adresi otomatik Ã§ek
        if (siteInput) {
          const applySiteBinding = () => {
            const name = siteInput.value.trim();
            if (!name) return;
            // BaÅŸlÄ±ÄŸa gÃ¶re adresi bul
            const addr = list.find(a => a.title === name);
            if (addr) {
              // Value formatÄ±: "invoice" veya "addr:0"
              let value = "";
              if (addr.kind === "invoice") {
                value = "invoice";
              } else {
                const addrIndex = list.filter(a => a.kind !== "invoice").indexOf(addr);
                value = `addr:${addrIndex}`;
              }
              sel.value = value;
              sel.onchange && sel.onchange();
              logger.info("Åantiye adÄ±na gÃ¶re adres seÃ§ildi", { value, name });
            }
          };
          siteInput.addEventListener('change', applySiteBinding);
          siteInput.addEventListener('blur', applySiteBinding);
        }

        // Edit modunda: iÃ§erik eÅŸleÅŸirse select'i set et
        try {
          const desired = (window.__desiredDeliveryAddress || '').trim();
          if (desired) {
            const addr = list.find(a => (a.content||'').trim() === desired);
            if (addr) {
              // Value formatÄ±: "invoice" veya "addr:0"
              let value = "";
              if (addr.kind === "invoice") {
                value = "invoice";
              } else {
                const addrIndex = list.filter(a => a.kind !== "invoice").indexOf(addr);
                value = `addr:${addrIndex}`;
              }
              sel.value = value;
              sel.onchange && sel.onchange();
              logger.info("Edit modunda adres seÃ§ildi", { value });
            }
          }
        } catch {}

        // debug
        logger.info("Teslimat adres listesi yÃ¼klendi", { count: list.length });
      } catch (e) {
        logger.warn("Adresler yÃ¼klenemedi", e);
      }
    }

    function bindRefreshButton() {
      const btn = $("#refreshAddressesBtn");
      if (btn) btn.onclick = loadAddressesForDemand;
    }

    // ---------- init ----------
    function initDemandPageWiring() {
      bindDescriptions();
      bindRefreshButton();
      loadAddressesForDemand(); // sayfa aÃ§Ä±lÄ±ÅŸÄ±nda bir kez yÃ¼kle
      setupExistingDescriptionFields(); // Mevcut aÃ§Ä±klama alanlarÄ± iÃ§in kategori Ã¶nerisi
      
      // Teklifbul Rule v1.0 - Teslimat adresi textarea'sÄ±nÄ±n her zaman gÃ¶rÃ¼nÃ¼r olduÄŸundan emin ol
      const deliveryContainer = document.getElementById('deliveryAddressContainer');
      const deliveryTextarea = document.getElementById('deliveryAddress');
      if (deliveryContainer) {
        deliveryContainer.style.setProperty('display', 'block', 'important');
        deliveryContainer.style.setProperty('visibility', 'visible', 'important');
        deliveryContainer.style.setProperty('opacity', '1', 'important');
        deliveryContainer.style.setProperty('height', 'auto', 'important');
        deliveryContainer.style.setProperty('min-height', '100px', 'important');
      }
      if (deliveryTextarea) {
        deliveryTextarea.style.setProperty('display', 'block', 'important');
        deliveryTextarea.style.setProperty('visibility', 'visible', 'important');
        deliveryTextarea.style.setProperty('opacity', '1', 'important');
        deliveryTextarea.style.setProperty('min-height', '80px', 'important');
        deliveryTextarea.style.setProperty('width', '100%', 'important');
        logger.info('Teslimat adresi textarea gÃ¶rÃ¼nÃ¼r yapÄ±ldÄ±', { height: deliveryTextarea.offsetHeight });
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => { 
        initDemandPageWiring(); 
        prefillApprovalFields();
        // Teklifbul Rule v1.0 - Sayfa yÃ¼klendikten sonra textarea'yÄ± tekrar gÃ¶rÃ¼nÃ¼r yap
        setTimeout(() => {
          const ta = document.getElementById('deliveryAddress');
          const container = document.getElementById('deliveryAddressContainer');
          if (ta) {
            ta.style.setProperty('display', 'block', 'important');
            ta.style.setProperty('visibility', 'visible', 'important');
            ta.style.setProperty('opacity', '1', 'important');
            ta.style.setProperty('min-height', '80px', 'important');
          }
          if (container) {
            container.style.setProperty('display', 'block', 'important');
            container.style.setProperty('visibility', 'visible', 'important');
            container.style.setProperty('opacity', '1', 'important');
          }
        }, 100);
      });
    } else {
      initDemandPageWiring();
      // Teklifbul Rule v1.0 - Sayfa yÃ¼klendikten sonra textarea'yÄ± tekrar gÃ¶rÃ¼nÃ¼r yap
      setTimeout(() => {
        const ta = document.getElementById('deliveryAddress');
        const container = document.getElementById('deliveryAddressContainer');
        if (ta) {
          ta.style.setProperty('display', 'block', 'important');
          ta.style.setProperty('visibility', 'visible', 'important');
          ta.style.setProperty('opacity', '1', 'important');
          ta.style.setProperty('min-height', '80px', 'important');
        }
        if (container) {
          container.style.setProperty('display', 'block', 'important');
          container.style.setProperty('visibility', 'visible', 'important');
          container.style.setProperty('opacity', '1', 'important');
        }
      }, 100);
      prefillApprovalFields();
    }
  </script>

  <!-- Category Groups Modal Script -->
  <script type="module" src="/assets/js/ui/category-groups-modal.js" defer></script>

  <!-- Theme Script -->
  <script type="module" src="/assets/js/theme.js" defer></script>

  <!-- Ã‡oklu-Sekmeli Grup Hub Modal -->
  <div id="groupHubModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1100;">
    <div class="gh-modal" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
                background:#fff;width:95%;max-width:880px;border-radius:12px;padding:20px;">
      <div class="gh-body">
      <div class="gh-header">
        <h3 class="gh-title">Kategori GruplarÄ± â€” OluÅŸtur & YÃ¶net</h3>
        <button id="ghClose" class="gh-close" aria-label="Kapat" title="Kapat">Ã—</button>
      </div>

      <!-- Sekme baÅŸlÄ±klarÄ± -->
      <div style="display:flex;gap:6px;margin-bottom:12px;">
        <button id="tabCreate" class="gh-tab gh-active">ğŸ—‚ï¸ Yeni Grup OluÅŸtur</button>
        <button id="tabManage" class="gh-tab">ğŸ› ï¸ GruplarÄ± YÃ¶net</button>
      </div>

      <!-- Sekme iÃ§erikleri -->
      <div id="paneCreate">
        <label style="font-weight:600;">Grup AdÄ± *</label>
        <input id="ghCreateName" placeholder="Ã–rn: Ä°nÅŸaat Malzemeleri"
          style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;margin:8px 0 12px;">
        <div id="ghCreateStepCats" style="display:none;margin-top:8px;">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap;">
            <input id="ghCreateSearch" placeholder="Kategori ara..."
              style="flex:1;min-width:200px;padding:8px;border:1px solid #d1d5db;border-radius:8px;">
            <button id="ghCreateSelectAll" type="button" style="background:#3b82f6;color:#fff;border:0;border-radius:6px;padding:6px 12px;font-size:12px;cursor:pointer;white-space:nowrap;">âœ… TÃ¼mÃ¼nÃ¼ SeÃ§</button>
            <button id="ghCreateClear" type="button" style="background:#6b7280;color:#fff;border:0;border-radius:6px;padding:6px 12px;font-size:12px;cursor:pointer;white-space:nowrap;">ğŸ—‘ï¸ Temizle</button>
            <small id="ghCreateCount" style="color:#6b7280;min-width:80px;text-align:right;"></small>
          </div>
          <div id="ghCreateCats" style="border:1px solid #e5e7eb;border-radius:8px;max-height:36vh;overflow:auto;padding:8px;"></div>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
          <button id="ghCreateCancel">Ä°ptal</button>
          <button id="ghCreateNext" style="background:#3b82f6;color:#fff;border:0;border-radius:6px;padding:8px 12px;">Ä°lerle</button>
          <button id="ghCreateSave" style="display:none;background:#10b981;color:#fff;border:0;border-radius:6px;padding:8px 12px;">Kaydet</button>
        </div>
      </div>

      <div id="paneManage" style="display:none;">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
          <input id="ghManageSearch" placeholder="Gruplarda ara..." style="flex:1;padding:8px;border:1px solid #d1d5db;border-radius:8px;">
          <button id="ghDelete"  style="background:#ef4444;color:#fff;border:0;border-radius:6px;padding:8px 12px;">SeÃ§ilenleri Sil</button>
          <button id="ghEdit"    style="background:#f59e0b;color:#fff;border:0;border-radius:6px;padding:8px 12px;">DÃ¼zenle</button>
        </div>

        <div id="ghManageList" style="border:1px solid #e5e7eb;border-radius:8px;max-height:40vh;overflow:auto;"></div>

        <!-- DÃ¼zenleme paneli -->
        <div id="ghEditPanel" style="display:none;margin-top:12px;border-top:1px dashed #e5e7eb;">
          <h4 id="ghEditTitle" style="margin:12px 0 8px 0;">Grup DÃ¼zenle</h4>

          <!-- Grup adÄ± dÃ¼zenleme -->
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
            <input id="ghEditName" placeholder="Grup adÄ± (Ã¶rn: TÃ¼m TedarikÃ§i GruplarÄ±m)" style="flex:1;padding:8px;border:1px solid #d1d5db;border-radius:8px;">
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap;">
            <input id="ghEditSearch" placeholder="Kategori ara..." style="flex:1;min-width:200px;padding:8px;border:1px solid #d1d5db;border-radius:8px;">
            <button id="ghEditSelectAll" type="button" style="background:#3b82f6;color:#fff;border:0;border-radius:6px;padding:6px 12px;font-size:12px;cursor:pointer;white-space:nowrap;">âœ… TÃ¼mÃ¼nÃ¼ SeÃ§</button>
            <button id="ghEditClear" type="button" style="background:#6b7280;color:#fff;border:0;border-radius:6px;padding:6px 12px;font-size:12px;cursor:pointer;white-space:nowrap;">ğŸ—‘ï¸ Temizle</button>
            <small id="ghEditCount" style="color:#6b7280;min-width:80px;text-align:right;"></small>
          </div>

          <div id="ghEditScroll" style="max-height:48vh;overflow:auto;border:1px solid #e5e7eb;border-radius:8px;padding:10px;">
            <div id="ghEditCats" class="gh-grid"></div>
          </div>

          <div class="gh-footer" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
            <button id="ghEditCancel">VazgeÃ§</button>
            <button id="ghEditSave" style="background:#10b981;color:#fff;border:0;border-radius:8px;padding:8px 12px;">Kaydet</button>
          </div>
        </div>
      </div>
      <div class="gh-footer">
        <!-- Alt buton barlarÄ± buraya -->
      </div>
    </div>
  </div>

  <style>
    .gh-header{
      position:relative; display:flex; align-items:center; justify-content:center;
      margin-bottom:12px; padding:12px 64px 8px 12px; border-bottom:1px solid #e5e7eb;
      min-height:56px; /* header yÃ¼ksek, X alt Ã§izgiye hiÃ§ yaklaÅŸmaz */
    }
    .gh-title{ margin:0; font-size:18px; font-weight:700; color:#1f2937; letter-spacing:.2px; }

    /* SaÄŸ-Ã¼st X */
    .gh-close{
      position:absolute; top:4px; right:10px; z-index:2; /* sabit konum, hover'da kaymaz */
      width:36px; height:36px; border-radius:9999px;
      background:#ef4444; border:1px solid #d1d5db;
      color:#fff; font-size:22px; line-height:1;
      display:flex; align-items:center; justify-content:center; cursor:pointer;
    }
    .gh-close:hover{ background:#ef4444 }
    .gh-close:focus{ outline:2px solid #2563eb; outline-offset:2px }

    .gh-tab{
      border:1px solid #d1d5db;border-radius:10px;padding:10px 14px;
      background:#e5e7eb;color:#1f2937;font-weight:600;cursor:pointer;opacity:1
    }
    .gh-tab.gh-active{background:#2563eb;color:#fff;border-color:#2563eb}
    /* seÃ§ili deÄŸilken de okunaklÄ± kalsÄ±n */
    .gh-tab:not(.gh-active){background:#e5e7eb;color:#1f2937}

    /* Modal dÃ¼zeni: iÃ§ scroll + sticky footer */
    .gh-modal{display:flex;flex-direction:column;height:86vh}
    .gh-body{flex:1;overflow:auto;padding-bottom:12px}
    .gh-footer{position:sticky;bottom:0;background:#fff;padding-top:8px}

    /* YÃ¶net listesi satÄ±rÄ± */
    #ghManageList .row{display:grid;grid-template-columns:28px 1fr 140px;align-items:center;
      gap:10px;padding:10px;border-bottom:1px solid #f1f5f9}

    /* DÃ¼zenle paneli - basit flex dÃ¼zeni */
    .gh-grid{
      display:flex !important;
      flex-direction:column !important;
      gap:8px !important;
    }
    
    .gh-grid-row{
      display:flex !important;
      align-items:center !important;
      gap:12px !important;
      padding:8px 12px !important;
      border:1px solid #e5e7eb !important;
      border-radius:6px !important;
      background:#f9fafb !important;
      min-height:40px !important;
    }
    
    .gh-grid-row input[type="checkbox"]{
      width:18px !important;
      height:18px !important;
      margin:0 !important;
      flex-shrink:0 !important;
      cursor:pointer !important;
      align-self:center !important; /* Checkbox'Ä± dikey olarak ortala */
    }
    
    .gh-grid-row span{
      flex:1 !important;
      font-size:14px !important;
      color:#374151 !important;
      line-height:1.4 !important;
      align-self:center !important; /* Metni dikey olarak ortala */
    }

    /* DÃ¼zenle butonu renk durumlarÄ± */
    .btn-edit{background:#e5e7eb;border:0;border-radius:8px;padding:8px 10px;color:#6b7280}
    .btn-edit.enabled{background:#10b981;color:#fff;cursor:pointer}
    .btn-edit.enabled:hover{filter:brightness(.95)}
  </style>

  <script type="module" src="/js/ui-standard.js"></script>
  <script type="module">
    // Åantiye adÄ± â†’ AlÄ±m Yeri (Ä°l) baÄŸlama
    const siteInput = document.getElementById('siteName');
    const provinceInput = document.getElementById('purchaseLocation');
    const dataList = document.getElementById('siteNameList');
    let savedSites = Array.isArray(window.__initialSavedSites) ? window.__initialSavedSites : [];

    window.__setSavedSites = (arr) => {
      savedSites = Array.isArray(arr) ? arr : [];
      paintSites();
    };

    function paintSites(){
      if (!dataList) return;
      const cur = siteInput?.value || '';
      dataList.innerHTML = '';
      savedSites.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.title || s.fullAddress || s.id || '';
        dataList.appendChild(opt);
      });
      if (cur) siteInput.value = cur;
    }

    function findSiteByTitle(title){
      const t = String(title || '').trim().toLocaleLowerCase('tr');
      return savedSites.find(s => String(s.title||'').trim().toLocaleLowerCase('tr') === t) || null;
    }

    function applyProvinceFromSite(){
      const sel = findSiteByTitle(siteInput?.value || '');
      if (!sel || !provinceInput) return;
      provinceInput.value = sel.provinceName || sel.provinceId || '';
      provinceInput.dispatchEvent(new Event('change', { bubbles: true }));
    }

    document.addEventListener('DOMContentLoaded', () => {
      paintSites();
      siteInput?.addEventListener('change', applyProvinceFromSite);
      siteInput?.addEventListener('blur', applyProvinceFromSite);
    });
  </script>
</body>
</html>