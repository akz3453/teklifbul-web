<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KayÄ±t Ol</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 420px; margin: 60px auto; padding: 0 12px; }
    h1 { margin-bottom: 16px; }
    input, button { width: 100%; padding: 12px; margin: 8px 0; box-sizing: border-box; }
    button { cursor: pointer; }
    a { color: #1a56db; text-decoration: none; }
    small { color: #666; }
    .referral-info {
      padding: 12px;
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
      border-radius: 6px;
      margin: 16px 0;
      font-size: 14px;
    }
    .referral-info strong {
      color: #1e40af;
    }
  </style>
</head>
<body>
  <h1>KayÄ±t Ol</h1>

  <!-- Referans Bilgisi -->
  <div id="referralInfo" class="referral-info" style="display: none;">
    <strong>ğŸ“ Referans ile KayÄ±t:</strong>
    <div id="referralCompanyName" style="margin-top: 6px; color: #1e40af;"></div>
  </div>

  <label for="displayName">Ad Soyad <span style="color:#ef4444;">*</span></label>
  <input id="displayName" type="text" placeholder="Ad Soyad" autocomplete="name" required />
  <label for="email">E-posta <span style="color:#ef4444;">*</span></label>
  <input id="email" type="email" placeholder="E-posta" autocomplete="username" required />
  <label for="password">Åifre (min 6 karakter) <span style="color:#ef4444;">*</span></label>
  <input id="password" type="password" placeholder="Åifre (min 6 karakter)" autocomplete="new-password" required />
  
  <!-- Åirket KayÄ±t SeÃ§imi - Teklifbul Rule v1.0 -->
  <div style="margin: 16px 0; padding: 12px; background: #f0f9ff; border-radius: 6px; border: 1px solid #3b82f6;">
    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Åirket Ä°ÅŸlemi <span style="color:#ef4444;">*</span></label>
    <div style="display: flex; gap: 8px; flex-direction: column;">
      <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; border-radius: 4px; transition: background 0.2s;">
        <input type="radio" name="companyAction" value="new" checked style="margin-right: 8px;" />
        <div>
          <strong>Yeni Åirket Kur</strong>
          <p style="margin: 4px 0 0 0; font-size: 12px; color: #6b7280;">Sistem otomatik olarak ÅŸirket kodu oluÅŸturur</p>
        </div>
      </label>
      <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; border-radius: 4px; transition: background 0.2s;">
        <input type="radio" name="companyAction" value="join" style="margin-right: 8px;" />
        <div>
          <strong>Mevcut Åirkete KatÄ±l</strong>
          <p style="margin: 4px 0 0 0; font-size: 12px; color: #6b7280;">Åirket kodunu girip rol seÃ§in, ÅŸirket yÃ¶neticileri onaylayacak</p>
        </div>
      </label>
    </div>
    
    <!-- Åirkete KatÄ±lma AlanlarÄ± (gizli) -->
    <div id="joinCompanyFields" style="display: none; margin-top: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #d1d5db;">
      <label for="companyJoinCode" style="display: block; margin-bottom: 4px; font-size: 14px; font-weight: 600;">Åirket Kodu <span style="color:#ef4444;">*</span></label>
      <input type="text" id="companyJoinCode" placeholder="Åirket kodunu girin" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; text-transform: uppercase; box-sizing: border-box;" maxlength="10" />
      <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Åirket yÃ¶neticilerinden aldÄ±ÄŸÄ±nÄ±z kodu girin</p>
      
      <label for="companyJoinRole" style="display: block; margin-top: 12px; margin-bottom: 4px; font-size: 14px; font-weight: 600;">Åirket Ä°Ã§indeki RolÃ¼nÃ¼z <span style="color:#ef4444;">*</span></label>
      <select id="companyJoinRole" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
        <option value="">Rol seÃ§in</option>
        <optgroup label="AlÄ±cÄ± Rolleri">
          <option value="buyer:satinalma_yetkilisi">SatÄ±n Alma Yetkilisi</option>
          <option value="buyer:santiye_yetkilisi">Åantiye Yetkilisi</option>
          <option value="buyer:stok_depo">Stok / Depo Yetkilisi</option>
          <option value="buyer:muhasebe">Muhasebe</option>
          <option value="buyer:alici">AlÄ±cÄ±</option>
          <option value="buyer:genel_mudur">Genel MÃ¼dÃ¼r</option>
          <option value="buyer:genel_mudur_yardimcisi">Genel MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±</option>
          <option value="buyer:yonetim_kurulu_baskani">YÃ¶netim Kurulu BaÅŸkanÄ±</option>
          <option value="buyer:isveren">Ä°ÅŸveren (Åirket Sahibi)</option>
          <option value="buyer:ceo">CEO</option>
        </optgroup>
        <optgroup label="TedarikÃ§i Rolleri">
          <option value="supplier:satis_personeli">SatÄ±ÅŸ Personeli</option>
          <option value="supplier:pazarlama_muduru">Pazarlama MÃ¼dÃ¼rÃ¼</option>
          <option value="supplier:genel_mudur">Genel MÃ¼dÃ¼r</option>
          <option value="supplier:yonetim_kurulu_baskani">YÃ¶netim Kurulu BaÅŸkanÄ±</option>
          <option value="supplier:ceo">CEO</option>
          <option value="supplier:sirket_sahibi">Åirket Sahibi</option>
        </optgroup>
      </select>
      <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Åirket yÃ¶neticileri bu rolÃ¼ onaylayacak veya deÄŸiÅŸtirebilecek</p>
    </div>
  </div>
  
  <button id="signupBtn">KayÄ±t Ol</button>

  <p>Zaten Ã¼ye misin? <a href="./index.html">GiriÅŸ yap</a></p>
  <small>Not: Firebase Console â†’ Authentication â†’ Users ekranÄ±nda yeni kullanÄ±cÄ±yÄ± gÃ¶rebileceksin.</small>

    <script type="module">
    import { register, updateUserProfile } from "./firebase.js";
    import { db } from "./firebase.js";
    // Teklifbul Rule v1.0 - Structured Logging
    import { logger } from './src/shared/log/logger.js';
    // Teklifbul Rule v1.0 - Toast Notification System
    import { toast } from './src/shared/ui/toast.js';
    // Teklifbul Rule v1.1 - MESSAGES constants (i18n hazÄ±rlÄ±ÄŸÄ±)
    import { MESSAGES } from './src/shared/constants/messages.js';
    import { doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const displayNameEl = document.getElementById("displayName");
    const emailEl = document.getElementById("email");
    const passEl  = document.getElementById("password");
    const btn     = document.getElementById("signupBtn");
    const referralInfo = document.getElementById("referralInfo");
    const referralCompanyName = document.getElementById("referralCompanyName");

    // URL parametresinden referans kodunu al
    const urlParams = new URLSearchParams(window.location.search);
    const referralCodeId = urlParams.get('ref');

    // Referans bilgisini yÃ¼kle ve gÃ¶ster
    async function loadReferralInfo() {
      if (!referralCodeId) {
        referralInfo.style.display = 'none';
        return;
      }

      try {
        // TÃ¼m ÅŸirketlerde referans kodunu ara
        // Collection Group Query kullanÄ±labilir ama ÅŸimdilik tÃ¼m ÅŸirketlerde arama yapalÄ±m
        // (Performans sorunu var ama ÅŸimdilik Ã§alÄ±ÅŸÄ±r)
        const { collection, getDocs, query, where } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
        
        // Referans kodunu bul
        let foundCode = null;
        let companyId = null;
        let companyName = null;

        // OPTIMIZED: Ã–nce ÅŸirket kodunu kontrol et (public read izni var)
        // Sonra referral code'u direkt okumaya Ã§alÄ±ÅŸ (public read izni var)
        try {
          // 1. Ã–nce ÅŸirket kodunu kontrol et (daha hÄ±zlÄ±, tek sorgu)
          if (referralCodeId.length >= 8) {
            try {
              const companyQuery = query(
                collection(db, 'companies'),
                where('code', '==', referralCodeId)
              );
              const companyMatch = await getDocs(companyQuery);
              if (!companyMatch.empty) {
                const matchedCompany = companyMatch.docs[0];
                companyId = matchedCompany.id;
                companyName = matchedCompany.data().name;
                foundCode = { id: referralCodeId, code: referralCodeId, used: false }; // Åirket kodu olarak kabul et
                // Åirket bulundu, dÃ¶ngÃ¼ye girmeye gerek yok
              }
            } catch (companyQueryError) {
              logger.warn('Åirket kodu sorgusu hatasÄ±', companyQueryError);
            }
          }
          
          // 2. EÄŸer ÅŸirket kodu ile bulunamadÄ±ysa, referral code'u kontrol et
          // Not: Bu iÃ§in company ID bilmemiz gerekiyor, bu yÃ¼zden backend API kullanmak daha iyi olur
          // Åimdilik basit bir fallback: Referans kodunun kendisi company ID olabilir
          if (!foundCode && referralCodeId) {
            // Referans kodunun direkt bir company ID olup olmadÄ±ÄŸÄ±nÄ± kontrol et
            try {
              const possibleCompanyRef = doc(db, 'companies', referralCodeId);
              const possibleCompanySnap = await getDoc(possibleCompanyRef);
              if (possibleCompanySnap.exists()) {
                companyId = referralCodeId;
                companyName = possibleCompanySnap.data().name;
                foundCode = { id: referralCodeId, code: referralCodeId, used: false };
              }
            } catch (directCompanyError) {
              // Company ID deÄŸilse, referral code olarak kontrol etmeye Ã§alÄ±ÅŸ
              // Bu durumda backend API kullanmak daha iyi olur
              logger.warn('Direkt company kontrolÃ¼ baÅŸarÄ±sÄ±z', directCompanyError);
            }
          }
        } catch (e) {
          logger.warn('Referans kodu arama hatasÄ±', e);
          // Hata olsa bile devam et, referans olmadan da kayÄ±t olunabilir
        }

        // Åirket adÄ±nÄ± al
        if (companyId && !companyName) {
          const companyDoc = await getDoc(doc(db, 'companies', companyId));
          if (companyDoc.exists()) {
            companyName = companyDoc.data().name;
          }
        }

        if (foundCode && !foundCode.used) {
          // Referans kodu geÃ§erli
          referralInfo.style.display = 'block';
          referralCompanyName.textContent = companyName || 'Bir ÅŸirket';
          referralCompanyName.textContent += ` tarafÄ±ndan davet edildiniz.`;
          
          // Referans kodunu localStorage'a kaydet (kayÄ±t sonrasÄ± kullanmak iÃ§in)
          localStorage.setItem('pendingReferralCode', referralCodeId);
          localStorage.setItem('pendingReferralCompanyId', companyId);
          if (companyName) {
            localStorage.setItem('pendingReferralCompanyName', companyName);
          }
        } else if (foundCode && foundCode.used) {
          // Referans kodu kullanÄ±lmÄ±ÅŸ
          referralInfo.style.display = 'block';
          referralInfo.style.background = '#fef2f2';
          referralInfo.style.borderLeftColor = '#ef4444';
          referralCompanyName.textContent = 'âš ï¸ Bu referans kodu daha Ã¶nce kullanÄ±lmÄ±ÅŸ.';
          referralCompanyName.style.color = '#dc2626';
        }
      } catch (e) {
        logger.error('Referans bilgisi yÃ¼klenirken hata', e);
        referralInfo.style.display = 'none';
      }
    }

    // Sayfa yÃ¼klendiÄŸinde referans bilgisini gÃ¶ster
    loadReferralInfo();
    
    // Åirket iÅŸlemi seÃ§imi - Teklifbul Rule v1.0
    const companyActionRadios = document.querySelectorAll('input[name="companyAction"]');
    const joinCompanyFields = document.getElementById('joinCompanyFields');
    const companyJoinCode = document.getElementById('companyJoinCode');
    const companyJoinRole = document.getElementById('companyJoinRole');
    
    companyActionRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        if (radio.value === 'join') {
          joinCompanyFields.style.display = 'block';
          companyJoinCode.required = true;
          companyJoinRole.required = true;
        } else {
          joinCompanyFields.style.display = 'none';
          companyJoinCode.required = false;
          companyJoinRole.required = false;
          companyJoinCode.value = '';
          companyJoinRole.value = '';
        }
      });
    });

    btn.onclick = async () => {
      try {
        if (!displayNameEl.value || !emailEl.value || !passEl.value) {
          throw new Error("Ad Soyad, E-posta ve ÅŸifre gerekli.");
        }
        
        // KayÄ±t iÅŸlemi
        const userCredential = await register(emailEl.value, passEl.value);
        const user = userCredential.user;
        
        // KullanÄ±cÄ± adÄ±nÄ± gÃ¼ncelle - Teklifbul Rule v1.0
        await updateUserProfile(user, {
          displayName: displayNameEl.value.trim()
        });

        // Referans kodunu iÅŸle (varsa) - TEK KULLANIM Ä°Ã‡Ä°N
        let pendingReferralCode = localStorage.getItem('pendingReferralCode');
        let pendingReferralCompanyId = localStorage.getItem('pendingReferralCompanyId');
        const savedCompanyName = localStorage.getItem('pendingReferralCompanyName');
        
        if (pendingReferralCode && pendingReferralCompanyId) {
          try {
            // Referans kodunu iÅŸaretle - TEK KULLANIM Ä°Ã‡Ä°N
            // Ã–nce kodun hala kullanÄ±labilir olduÄŸunu kontrol et (race condition Ã¶nleme)
            const referralCodeRef = doc(db, 'companies', pendingReferralCompanyId, 'referralCodes', pendingReferralCode);
            const codeCheck = await getDoc(referralCodeRef);
            
            if (!codeCheck.exists()) {
              logger.warn('Referans kodu bulunamadÄ±');
              // Devam et, referans olmadan kayÄ±t olabilir
              pendingReferralCode = null;
              pendingReferralCompanyId = null;
            } else {
              const codeData = codeCheck.data();
              // EÄŸer kod zaten kullanÄ±lmÄ±ÅŸsa, hata ver
              if (codeData.used === true) {
                logger.error('Bu referans kodu zaten kullanÄ±lmÄ±ÅŸ');
                toast.error(MESSAGES.ERROR_REF_CODE_USED);
                // localStorage'dan temizle
                localStorage.removeItem('pendingReferralCode');
                localStorage.removeItem('pendingReferralCompanyId');
                localStorage.removeItem('pendingReferralCompanyName');
                // Referans olmadan devam et
                pendingReferralCode = null;
                pendingReferralCompanyId = null;
              } else {
                // Åirket adÄ±nÄ± al (eÄŸer kaydedilmediyse)
                let companyName = savedCompanyName;
                if (!companyName) {
                  const companyDoc = await getDoc(doc(db, 'companies', pendingReferralCompanyId));
                  if (companyDoc.exists()) {
                    companyName = companyDoc.data().name;
                  }
                }
                
                // Kodu kullanÄ±ldÄ± olarak iÅŸaretle (TEK KULLANIM)
                await updateDoc(referralCodeRef, {
                  used: true,
                  usedBy: user.uid,
                  usedAt: serverTimestamp()
                });

                // KullanÄ±cÄ± dokÃ¼manÄ±na referans bilgisini kaydet
                const userRef = doc(db, 'users', user.uid);
                await setDoc(userRef, {
                  displayName: displayNameEl.value.trim(), // Teklifbul Rule v1.0 - Ad Soyad
                  referralCode: pendingReferralCode,
                  referralCompanyId: pendingReferralCompanyId,
                  referralUsedAt: serverTimestamp(),
                  createdAt: serverTimestamp()
                }, { merge: true });

                // Referans ÅŸirketin referralCompanies koleksiyonuna ekle
                const referralCompanyRef = doc(db, 'companies', pendingReferralCompanyId, 'referralCompanies', user.uid);
                await setDoc(referralCompanyRef, {
                  userId: user.uid,
                  userEmail: emailEl.value,
                  referredCompanyId: pendingReferralCompanyId,
                  requestingCompanyId: pendingReferralCompanyId, // Kendi kendine referans
                  requestingCompanyName: companyName || 'Åirket',
                  status: 'pending',
                  requestedAt: serverTimestamp()
                });

                logger.info('Referans kodu kaydedildi', { code: pendingReferralCode });
                
                // localStorage'dan temizle
                localStorage.removeItem('pendingReferralCode');
                localStorage.removeItem('pendingReferralCompanyId');
                localStorage.removeItem('pendingReferralCompanyName');
              }
            }
          } catch (refError) {
            logger.error('Referans kodu kaydedilirken hata', refError);
            // Hata olsa bile kayÄ±t devam etsin
            pendingReferralCode = null;
            pendingReferralCompanyId = null;
          }
        }

        // KullanÄ±cÄ± dokÃ¼manÄ±na temel bilgileri kaydet (referans yoksa bile)
        if (!pendingReferralCode) {
          const userRef = doc(db, 'users', user.uid);
          await setDoc(userRef, {
            displayName: displayNameEl.value.trim(), // Teklifbul Rule v1.0 - Ad Soyad
            email: emailEl.value.trim(),
            createdAt: serverTimestamp()
          }, { merge: true });
        }
        
        // Åirkete katÄ±lma iÅŸlemi - Teklifbul Rule v1.0
        const companyAction = document.querySelector('input[name="companyAction"]:checked')?.value || 'new';
        
        if (companyAction === 'join') {
          // Mevcut ÅŸirkete katÄ±lma - direkt bekleme sayfasÄ±na yÃ¶nlendir
          const joinCode = companyJoinCode.value.trim().toUpperCase();
          const joinRole = companyJoinRole.value;
          
          if (!joinCode || !joinRole) {
            throw new Error("Åirket kodu ve rol seÃ§imi zorunludur.");
          }
          
          // Åirketi kontrol et
          const { collection, query, where, getDocs, addDoc } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
          const companyQuery = query(
            collection(db, 'companies'),
            where('code', '==', joinCode)
          );
          const companySnapshot = await getDocs(companyQuery);
          
          if (companySnapshot.empty) {
            throw new Error(`Åirket kodu "${joinCode}" ile eÅŸleÅŸen bir ÅŸirket bulunamadÄ±.`);
          }
          
          const companyDoc = companySnapshot.docs[0];
          const companyId = companyDoc.id;
          const companyData = companyDoc.data();
          
          // Rol tipini belirle (buyer/supplier)
          const requestedRoleSimple = joinRole.includes('supplier') ? 'supplier' : 'buyer';
          
          // KullanÄ±cÄ± profilini kaydet (pending status)
          const userRef = doc(db, 'users', user.uid);
          await setDoc(userRef, {
            displayName: displayNameEl.value.trim(),
            email: emailEl.value.trim(),
            companyCode: joinCode,
            companyId: companyId,
            companyJoinStatus: 'pending',
            requestedCompanyRole: joinRole,
            roles: [requestedRoleSimple], // GeÃ§ici olarak rol ekle
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          }, { merge: true });
          
          // companyJoinRequests koleksiyonuna istek ekle
          await addDoc(collection(db, 'companyJoinRequests'), {
            companyCode: joinCode,
            companyId: companyId,
            userId: user.uid,
            userEmail: emailEl.value.trim(),
            requestedRole: requestedRoleSimple,
            requestedCompanyRole: joinRole,
            status: 'pending',
            createdAt: serverTimestamp()
          });
          
          // Åirket sahiplerine bildirim gÃ¶nder
          const notificationRef = doc(collection(db, 'companies', companyId, 'notifications'));
          await setDoc(notificationRef, {
            type: 'pending_member_request',
            userId: user.uid,
            userEmail: emailEl.value.trim(),
            requestedRole: joinRole,
            message: `${emailEl.value.trim()} ÅŸirketinize katÄ±lmak iÃ§in onay bekliyor.`,
            createdAt: serverTimestamp(),
            read: false
          });
          
          // pendingMembers koleksiyonuna da ekle (eski sistem uyumluluÄŸu iÃ§in)
          const pendingRequestRef = doc(collection(db, 'companies', companyId, 'pendingMembers'));
          await setDoc(pendingRequestRef, {
            userId: user.uid,
            userEmail: emailEl.value.trim(),
            requestedRole: joinRole,
            requestedAt: serverTimestamp(),
            status: 'pending'
          });
          
          // Direkt bekleme sayfasÄ±na yÃ¶nlendir - Teklifbul Rule v1.0
          // Merkezi mesajlar ile deÄŸiÅŸtirildi - ÅŸirket ismi dinamik olarak yerleÅŸtiriliyor
          toast.success(MESSAGES.SUCCESS_SIGNUP_COMPANY_REQUEST.replace('{name}', companyData.name));
          location.href = './company-join-waiting.html';
          return;
        } else {
          // Yeni ÅŸirket kurulacak - role-select'e yÃ¶nlendir
          let redirectParams = new URLSearchParams();
          if (pendingReferralCode) {
            redirectParams.set('ref', pendingReferralCode);
          }
          
          toast.success(MESSAGES.SUCCESS_SIGNUP);
          
          const redirectUrl = redirectParams.toString() 
            ? `./role-select.html?${redirectParams.toString()}`
            : './role-select.html';
          location.href = redirectUrl;
        }
      } catch (e) {
        logger.error("KayÄ±t hatasÄ±", e);
        toast.error(MESSAGES.ERROR_SIGNUP + ": " + (e.message || e));
      }
    };
  </script>
</body>
</html>
