<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AlÄ±cÄ± KayÄ±t - Teklifbul</title>
  <link rel="stylesheet" href="./utils.css" />
  <style>
    body { margin: 0; font-family: system-ui, Arial; background: #f9fafb; }
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    .header { background: white; padding: 16px 20px; border-bottom: 1px solid #e5e7eb; margin-bottom: 24px; }
    .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .card h2 { margin: 0 0 20px 0; font-size: 20px; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 12px; }
    .card h3 { margin: 0 0 16px 0; font-size: 16px; color: #374151; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .full { grid-column: 1 / -1; }
    label { font-weight: 600; font-size: 14px; color: #374151; display: block; margin-bottom: 6px; }
    label.required::after { content: " *"; color: #dc2626; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="url"], textarea {
      width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; 
      font-size: 14px; box-sizing: border-box; transition: border-color 0.2s;
    }
    input:focus, textarea:focus { outline: none; border-color: #3b82f6; }
    input:disabled { background: #f3f4f6; color: #6b7280; cursor: not-allowed; }
    textarea { resize: vertical; font-family: inherit; }
    .chip-wrap { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; min-height: 32px; }
    .badge { display: inline-block; padding: 6px 12px; border-radius: 16px; background: #dbeafe; 
             color: #1e40af; font-size: 13px; cursor: pointer; transition: all 0.2s; }
    .badge:hover { background: #bfdbfe; }
    .checkbox-group { display: flex; align-items: start; gap: 10px; margin: 12px 0; }
    .checkbox-group input[type="checkbox"] { margin-top: 3px; width: 18px; height: 18px; cursor: pointer; }
    .checkbox-group label { margin: 0; font-weight: 400; font-size: 14px; line-height: 1.5; cursor: pointer; }
    .info-box { background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 12px; 
                margin: 16px 0; border-radius: 4px; font-size: 14px; color: #1e40af; line-height: 1.6; }
    .info-box a { color: #1d4ed8; text-decoration: underline; }
    .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; 
           font-size: 14px; transition: all 0.2s; text-decoration: none; display: inline-block; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; }
    .btn-secondary { background: #6b7280; color: white; }
    .btn-secondary:hover { background: #4b5563; }
    .btn-group { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
    .muted { opacity: 0.7; font-size: 13px; color: #6b7280; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="header">
    <div style="max-width:900px; margin:0 auto; display:flex; justify-content:space-between; align-items:center;">
      <strong style="font-size:18px; color:#1f2937;">Teklifbul - AlÄ±cÄ± KaydÄ±</strong>
      <span id="userEmail" style="font-size:13px; color:#6b7280;"></span>
    </div>
  </div>

  <div class="container">
    <div class="info-box">
      <strong>â„¹ï¸ HoÅŸ Geldiniz!</strong> AlÄ±cÄ± olarak kayÄ±t oluyorsunuz. Formun tamamÄ±nÄ± doldurun ve talepnizi oluÅŸturmaya baÅŸlayÄ±n.
    </div>

    <!-- Company Info -->
    <div class="card">
      <h2>ğŸ“‹ Firma Bilgileri</h2>
      <div class="info-box">
        Bir ÅŸirkete katÄ±labilir veya yeni ÅŸirket oluÅŸturabilirsiniz. VarsayÄ±lan: Yeni ÅŸirket oluÅŸtur.
      </div>
      <div class="row">
        <div>
          <label for="companyMode">Åirket Ä°ÅŸlemi</label>
          <select id="companyMode">
            <option value="create" selected>Yeni Åirket OluÅŸtur</option>
            <option value="join">Mevcut Åirkete KatÄ±l (Åirket Kodu ile)</option>
          </select>
        </div>
        <div id="joinCompanyWrap" style="display:none">
          <label for="companyJoinCode">Åirket Kodu</label>
          <input type="text" id="companyJoinCode" placeholder="Kurucu tarafÄ±ndan paylaÅŸÄ±lan kod" />
          <p class="muted">Kurucu onayladÄ±ktan sonra Ã¼yeliÄŸiniz aktif olur.</p>
        </div>
      </div>

      <div class="row" id="companyRoleRow" style="display:none">
        <div class="full">
          <label for="desiredCompanyRole">Åirket RolÃ¼ Talebi</label>
          <select id="desiredCompanyRole">
            <optgroup label="AlÄ±cÄ± Åirket Rolleri">
              <option value="buyer:satinalma_yetkilisi" data-role-type="buyer">SatÄ±n Alma Yetkilisi</option>
              <option value="buyer:santiye_yetkilisi" data-role-type="buyer">Åantiye Yetkilisi</option>
              <option value="buyer:stok_depo" data-role-type="buyer">Stok / Depo Yetkilisi</option>
              <option value="buyer:muhasebe" data-role-type="buyer">Muhasebe</option>
              <option value="buyer:alici" data-role-type="buyer">AlÄ±cÄ±</option>
              <option value="buyer:genel_mudur" data-role-type="buyer">Genel MÃ¼dÃ¼r</option>
              <option value="buyer:genel_mudur_yardimcisi" data-role-type="buyer">Genel MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±</option>
              <option value="buyer:yonetim_kurulu_baskani" data-role-type="buyer">YÃ¶netim Kurulu BaÅŸkanÄ±</option>
              <option value="buyer:isveren" data-role-type="buyer">Ä°ÅŸveren (Åirket Sahibi)</option>
              <option value="buyer:ceo" data-role-type="buyer">CEO</option>
            </optgroup>
            <optgroup label="TedarikÃ§i Åirket Rolleri">
              <option value="supplier:satis_personeli" data-role-type="supplier">SatÄ±ÅŸ Personeli</option>
              <option value="supplier:pazarlama_muduru" data-role-type="supplier">Pazarlama MÃ¼dÃ¼rÃ¼</option>
              <option value="supplier:genel_mudur" data-role-type="supplier">Genel MÃ¼dÃ¼r</option>
              <option value="supplier:yonetim_kurulu_baskani" data-role-type="supplier">YÃ¶netim Kurulu BaÅŸkanÄ±</option>
              <option value="supplier:ceo" data-role-type="supplier">CEO</option>
              <option value="supplier:sirket_sahibi" data-role-type="supplier">Åirket Sahibi</option>
            </optgroup>
          </select>
          <p class="muted">Kurucu onayÄ± sonrasÄ± rolÃ¼nÃ¼z atanÄ±r. TedarikÃ§i rolleri iÃ§in "TedarikÃ§i" seÃ§eneÄŸini iÅŸaretleyin.</p>
        </div>
      </div>
      
      <div class="row">
        <div>
          <label for="companyName" class="required">Firma ÃœnvanÄ±</label>
          <input type="text" id="companyName" placeholder="Ã–rn. ABC Ä°nÅŸaat A.Å." autocomplete="organization" />
        </div>
        <div>
          <label for="website">Web Sitesi</label>
          <input type="url" id="website" placeholder="https://www.sirketim.com" autocomplete="url" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="taxNumber" class="required">Vergi No</label>
          <input type="text" id="taxNumber" placeholder="10 veya 11 hane" maxlength="11" autocomplete="off" />
          <p class="muted">10 veya 11 haneli vergi numaranÄ±z</p>
        </div>
        <div>
          <label for="taxOffice">Vergi Dairesi</label>
          <input type="text" id="taxOffice" placeholder="Ã–rn. AtaÅŸehir" autocomplete="off" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="mersisNo">MERSÄ°S No</label>
          <input type="text" id="mersisNo" placeholder="16 haneli MERSÄ°S numarasÄ±" maxlength="16" autocomplete="off" />
        </div>
        <div>
          <label for="inv_il">Ä°l</label>
          <select id="inv_il">
            <option value="">Ä°l seÃ§in</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="inv_ilce">Ä°lÃ§e</label>
          <select id="inv_ilce" disabled>
            <option value="">Ã–nce il seÃ§in</option>
          </select>
        </div>
        <div>
          <label for="inv_mahalle">Mahalle</label>
          <select id="inv_mahalle" disabled>
            <option value="">Ã–nce ilÃ§e seÃ§in</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="postalCode">Posta Kodu</label>
          <input type="text" id="postalCode" placeholder="Posta kodu" autocomplete="postal-code" />
        </div>
        <div>
          <label for="country">Ãœlke</label>
          <input type="text" id="country" value="TÃ¼rkiye" autocomplete="country" />
        </div>
      </div>

      <div class="row">
        <div class="full">
          <label for="address" class="required">Adres</label>
          <textarea id="address" rows="3" placeholder="SeÃ§imlere gÃ¶re otomatik doldurulur" readonly></textarea>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="country">Ãœlke</label>
          <input type="text" id="country" value="TÃ¼rkiye" autocomplete="country" />
        </div>
      </div>
    </div>

    <!-- Contact Info -->
    <div class="card">
      <h2>ğŸ“ Ä°letiÅŸim Bilgileri</h2>
      
      <div class="row">
        <div>
          <label for="email">E-posta (KayÄ±t E-postasÄ±)</label>
          <input type="email" id="email" disabled autocomplete="username" />
          <p class="muted">GiriÅŸ yaptÄ±ÄŸÄ±nÄ±z e-posta adresi</p>
        </div>
        <div>
          <label for="phone">Telefon</label>
          <input type="tel" id="phone" placeholder="+90 5xx xxx xx xx" autocomplete="tel" />
        </div>
      </div>

      <div class="row">
        <div class="full">
          <label for="emailInput">Ek E-posta Adresleri</label>
          <input type="email" id="emailInput" placeholder="E-posta ekleyin ve Enter'a basÄ±n" autocomplete="email" />
          <div id="emailChips" class="chip-wrap"></div>
          <p class="muted">Teklif bildirimleri iÃ§in ek e-posta adresleri ekleyebilirsiniz</p>
        </div>
      </div>

      <div class="row">
        <div class="full">
          <label for="phoneInput">Ek Telefon NumaralarÄ±</label>
          <input type="tel" id="phoneInput" placeholder="+90 5xx xxx xx xx ekle ve Enter'a basÄ±n" autocomplete="tel" />
          <div id="phoneChips" class="chip-wrap"></div>
          <p class="muted">WhatsApp dahil ek iletiÅŸim numaralarÄ±</p>
        </div>
      </div>
    </div>

    <!-- Categories -->
    <div class="card">
      <h2>ğŸ·ï¸ Faaliyet Kategorileri</h2>
      <p style="color:#6b7280; margin-bottom:16px; font-size:14px;">
        Hangi alanlarda talep oluÅŸturacaksÄ±nÄ±z? Bu kategoriler taleplerinizi organize etmek iÃ§in kullanÄ±lÄ±r.
      </p>
      
      <div style="margin-bottom:16px;">
        <button type="button" id="selectAllCategories" style="padding:8px 16px; background:#e5e7eb; border:none; border-radius:6px; cursor:pointer; font-size:13px; margin-right:8px;">TÃ¼mÃ¼nÃ¼ SeÃ§</button>
        <button type="button" id="clearAllCategories" style="padding:8px 16px; background:#fee2e2; border:none; border-radius:6px; cursor:pointer; font-size:13px;">TÃ¼mÃ¼nÃ¼ Temizle</button>
      </div>
      
      <label for="catInput">AlÄ±cÄ± Kategorileri</label>
      <input type="text" id="catInput" list="catDatalist" placeholder="Kategori ara/ekle ve Enter'a basÄ±n" autocomplete="off" />
      <datalist id="catDatalist"></datalist>
      <div id="catChips" class="chip-wrap" style="min-height:40px; max-height:120px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:6px; padding:8px;"></div>
    </div>

    <!-- Roles -->
    <div class="card">
      <h2>ğŸ‘¤ Roller</h2>
      
      <div class="checkbox-group">
        <input type="checkbox" id="roleBuyer" checked disabled />
        <label for="roleBuyer">
          <strong>AlÄ±cÄ±</strong> - Talep oluÅŸturur ve teklif alÄ±r (VarsayÄ±lan)
        </label>
      </div>
      
      <div class="checkbox-group">
        <input type="checkbox" id="roleSupplier" />
        <label for="roleSupplier">
          <strong>TedarikÃ§i</strong> - Taleplere teklif verir (Opsiyonel)
        </label>
      </div>
      
      <div id="supplierNote" style="display:none; margin-top:12px; padding:12px; background:#fef3c7; border-left:4px solid #f59e0b; border-radius:4px;">
        <p style="margin:0; font-size:13px; color:#92400e;">
          âš ï¸ <strong>Not:</strong> TedarikÃ§i rolÃ¼nÃ¼ de seÃ§erseniz, kategorilerinize uygun talepleri gÃ¶rebilir ve teklif verebilirsiniz. 
          DetaylÄ± tedarikÃ§i bilgilerini daha sonra Ayarlar sayfasÄ±ndan ekleyebilirsiniz.
        </p>
      </div>
    </div>

    <!-- KVKK Consents -->
    <div class="card">
      <h2>âœ… Onaylar</h2>
      
      <div class="info-box">
        <strong>KVKK AydÄ±nlatma ve AÃ§Ä±k RÄ±za Metni:</strong><br/>
        Teklifbul platformu tarafÄ±ndan sunulan hizmetler kapsamÄ±nda, kimlik ve iletiÅŸim bilgilerim ile firma bilgilerimin; 
        tedarikÃ§i eÅŸleÅŸtirme, talep iletimi, teklif sÃ¼reÃ§ yÃ¶netimi ve yasal yÃ¼kÃ¼mlÃ¼lÃ¼klerin yerine getirilmesi amaÃ§larÄ±yla 
        iÅŸlenmesini; yurt iÃ§i/yurt dÄ±ÅŸÄ± hizmet saÄŸlayÄ±cÄ±larÄ±na aktarÄ±lmasÄ±nÄ± kabul ediyorum.
        <a href="#" target="_blank">DetaylÄ± AydÄ±nlatma Metni</a>
      </div>
      
      <div class="checkbox-group">
        <input type="checkbox" id="kvkkConsent" />
        <label for="kvkkConsent" class="required">
          KVKK AydÄ±nlatma Metni'ni okudum ve AÃ§Ä±k RÄ±za veriyorum.
        </label>
      </div>
      
      <div class="checkbox-group">
        <input type="checkbox" id="contractConsent" />
        <label for="contractConsent" class="required">
          KullanÄ±cÄ± SÃ¶zleÅŸmesi ve Gizlilik PolitikasÄ±nÄ± kabul ediyorum.
        </label>
      </div>
      
      <div class="checkbox-group">
        <input type="checkbox" id="marketingConsent" />
        <label for="marketingConsent">
          Ticari elektronik ileti (e-posta, SMS) almayÄ± kabul ediyorum.
        </label>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="btn-group">
      <a href="./index.html" class="btn btn-secondary">Ä°ptal</a>
      <button id="btnSave" class="btn btn-primary">Kaydet ve Devam Et</button>
    </div>
  </div>

  <script type="module">
    // ==== Firebase modules ====
    import { requireAuth, db } from "./firebase.js";
    // Teklifbul Rule v1.0 - Structured Logging
    import { logger } from './src/shared/log/logger.js';
    // Teklifbul Rule v1.0 - Toast Notification System
    import { toast } from './src/shared/ui/toast.js';
    // Teklifbul Rule v1.1 - MESSAGES constants (i18n hazÄ±rlÄ±ÄŸÄ±)
    import { MESSAGES } from './src/shared/constants/messages.js';
    import {
      doc, setDoc, getDoc, serverTimestamp, collection, addDoc, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    // CRITICAL: Import new ID-based category system
    import { 
      getAllCategories, 
      getIdByName, 
      getNameById,
      normalizeToIds 
    } from "./src/categories/category-service.js";

    // ==== Populate category datalist ====
    // Company mode UI toggle
    const modeSel = document.getElementById('companyMode');
    const joinWrap = document.getElementById('joinCompanyWrap');
    const companyRoleRow = document.getElementById('companyRoleRow');
    const desiredRoleSelect = document.getElementById('desiredCompanyRole');
    const DEFAULT_BUYER_ROLE_KEY = 'buyer:satinalma_yetkilisi';

    function ensureRoleSelection() {
      if (!desiredRoleSelect) return;
      if (!desiredRoleSelect.value || desiredRoleSelect.disabled) {
        desiredRoleSelect.value = DEFAULT_BUYER_ROLE_KEY;
      }
    }

    function getDesiredRoleMeta() {
      if (!desiredRoleSelect) return null;
      const key = desiredRoleSelect.value;
      return ROLE_LOOKUP[key] || null;
    }

    modeSel.addEventListener('change', () => {
      const mode = modeSel.value;
      joinWrap.style.display = mode === 'join' ? '' : 'none';
      companyRoleRow.style.display = mode === 'join' ? '' : 'none';
      const companyNameInput = document.getElementById('companyName');
      if (companyNameInput) {
        companyNameInput.disabled = (mode === 'join');
        if (mode === 'join') companyNameInput.value = companyNameInput.value || '';
      }
      if (mode === 'create') {
        if (desiredRoleSelect) desiredRoleSelect.value = DEFAULT_BUYER_ROLE_KEY;
      } else {
        ensureRoleSelection();
      }
    });
    ensureRoleSelection();

    function genCompanyCode() {
      const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let out = '';
      for (let i=0;i<8;i++) out += alphabet[Math.floor(Math.random()*alphabet.length)];
      return out;
    }

    async function findCompanyByCode(code){
      const qref = query(collection(db, 'companies'), where('code','==', code));
      const snap = await getDocs(qref);
      let found = null;
      snap.forEach(d => { if (!found) found = { id: d.id, ...d.data() }; });
      return found;
    }
    const dataList = document.getElementById("catDatalist");
    const allCategories = getAllCategories();
    allCategories.forEach(cat => {
      const o = document.createElement("option"); 
      o.value = cat.name; // Display name
      o.dataset.categoryId = cat.id; // Store ID
      dataList.appendChild(o); 
    });

    // ==== Chip state ====
    const emailChips = new Set();
    const phoneChips = new Set();
    const catChips = new Set();

    const TR_PROVINCES = [
      "Adana","AdÄ±yaman","Afyonkarahisar","AÄŸrÄ±","Amasya","Ankara","Antalya","Artvin","AydÄ±n","BalÄ±kesir","Bilecik","BingÃ¶l","Bitlis","Bolu","Burdur","Bursa","Ã‡anakkale","Ã‡ankÄ±rÄ±","Ã‡orum","Denizli","DiyarbakÄ±r","Edirne","ElazÄ±ÄŸ","Erzincan","Erzurum","EskiÅŸehir","Gaziantep","Giresun","GÃ¼mÃ¼ÅŸhane","Hakkari","Hatay","Isparta","Mersin","Ä°stanbul","Ä°zmir","Kars","Kastamonu","Kayseri","KÄ±rklareli","KÄ±rÅŸehir","Kocaeli","Konya","KÃ¼tahya","Malatya","Manisa","KahramanmaraÅŸ","Mardin","MuÄŸla","MuÅŸ","NevÅŸehir","NiÄŸde","Ordu","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas","TekirdaÄŸ","Tokat","Trabzon","Tunceli","ÅanlÄ±urfa","UÅŸak","Van","Yozgat","Zonguldak","Aksaray","Bayburt","Karaman","KÄ±rÄ±kkale","Batman","ÅÄ±rnak","BartÄ±n","Ardahan","IÄŸdÄ±r","Yalova","KarabÃ¼k","Kilis","Osmaniye","DÃ¼zce"
    ];

    const ROLE_OPTIONS = {
      buyer: [
        { key: 'buyer:satinalma_yetkilisi', value: 'satinalma_yetkilisi', label: 'SatÄ±n Alma Yetkilisi', multi: true },
        { key: 'buyer:santiye_yetkilisi', value: 'santiye_yetkilisi', label: 'Åantiye Yetkilisi', multi: true },
        { key: 'buyer:stok_depo', value: 'stok_depo', label: 'Stok / Depo Yetkilisi', multi: true },
        { key: 'buyer:muhasebe', value: 'muhasebe', label: 'Muhasebe', multi: true },
        { key: 'buyer:alici', value: 'alici', label: 'AlÄ±cÄ±', multi: true },
        { key: 'buyer:genel_mudur', value: 'genel_mudur', label: 'Genel MÃ¼dÃ¼r', multi: false },
        { key: 'buyer:genel_mudur_yardimcisi', value: 'genel_mudur_yardimcisi', label: 'Genel MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±', multi: false },
        { key: 'buyer:yonetim_kurulu_baskani', value: 'yonetim_kurulu_baskani', label: 'YÃ¶netim Kurulu BaÅŸkanÄ±', multi: false },
        { key: 'buyer:isveren', value: 'isveren', label: 'Ä°ÅŸveren (Åirket Sahibi)', multi: false },
        { key: 'buyer:ceo', value: 'ceo', label: 'CEO', multi: false }
      ],
      supplier: [
        { key: 'supplier:satis_personeli', value: 'satis_personeli', label: 'SatÄ±ÅŸ Personeli', multi: true },
        { key: 'supplier:pazarlama_muduru', value: 'pazarlama_muduru', label: 'Pazarlama MÃ¼dÃ¼rÃ¼', multi: false },
        { key: 'supplier:genel_mudur', value: 'genel_mudur', label: 'Genel MÃ¼dÃ¼r', multi: false },
        { key: 'supplier:yonetim_kurulu_baskani', value: 'yonetim_kurulu_baskani', label: 'YÃ¶netim Kurulu BaÅŸkanÄ±', multi: false },
        { key: 'supplier:ceo', value: 'ceo', label: 'CEO', multi: false },
        { key: 'supplier:sirket_sahibi', value: 'sirket_sahibi', label: 'Åirket Sahibi', multi: false }
      ]
    };

    const ROLE_LOOKUP = {};
    Object.values(ROLE_OPTIONS).flat().forEach((opt) => {
      ROLE_LOOKUP[opt.key] = { ...opt, type: opt.key.split(':')[0] };
    });

    let districtFallbackCache = null;
    async function loadDistrictFallback() {
      if (districtFallbackCache) return districtFallbackCache;
      try {
        const res = await fetch('https://raw.githubusercontent.com/muhammederdem/il-ilce-json/master/il-ilce.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const map = {};
        data.forEach((rec) => {
          const province = (rec?.il || '').trim();
          if (!province) return;
          const districts = Array.isArray(rec?.ilceleri) ? rec.ilceleri.map((d) => String(d || '').trim()).filter(Boolean) : [];
          map[province] = districts;
        });
        districtFallbackCache = map;
      } catch (e) {
        logger.warn('Ä°lÃ§e fallback verisi yÃ¼klenemedi', e);
        districtFallbackCache = {};
      }
      return districtFallbackCache;
    }

    const DUMMY_NEIGHBORHOODS = {
      "Ä°stanbul": {
        "KadÄ±kÃ¶y": ["KozyataÄŸÄ±", "FenerbahÃ§e", "BostancÄ±"],
        "BeÅŸiktaÅŸ": ["Levent", "Etiler", "Akatlar"]
      }
    };

    function resetSelect(selectElement, placeholder) {
      if (!selectElement) return;
      selectElement.innerHTML = '';
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = placeholder;
      selectElement.appendChild(opt);
      selectElement.disabled = true;
    }

    function fillSelect(selectElement, dataArray, placeholder) {
      resetSelect(selectElement, placeholder);
      if (!selectElement || !Array.isArray(dataArray) || !dataArray.length) return;
      dataArray.forEach((item) => {
        const value = typeof item === 'string' ? item : item?.name;
        if (!value) return;
        const opt = document.createElement('option');
        opt.value = value;
        opt.textContent = value;
        selectElement.appendChild(opt);
      });
      selectElement.disabled = false;
    }

    async function fetchDistricts(province) {
      if (!province) return [];
      try {
        const snap = await getDoc(doc(db, 'trDistricts', province));
        const data = snap.data();
        if (data && Array.isArray(data.districts) && data.districts.length) return data.districts;
      } catch (e) {
        logger.warn('Firestore ilÃ§e verisi alÄ±namadÄ±', e);
      }
      const fallback = await loadDistrictFallback();
      return fallback[province] || [];
    }

    async function fetchNeighborhoods(province, district) {
      if (!province || !district) return [];
      const map = DUMMY_NEIGHBORHOODS[province];
      if (map && Array.isArray(map[district])) return map[district];
      logger.warn('Mahalle verisi bulunamadÄ±, manuel giriÅŸ yapabilirsiniz');
      return [];
    }

    const ilSelect = document.getElementById('inv_il');
    const ilceSelect = document.getElementById('inv_ilce');
    const mahalleSelect = document.getElementById('inv_mahalle');
    const postalInput = document.getElementById('postalCode');
    const addressTextarea = document.getElementById('address');

    resetSelect(ilceSelect, 'Ä°lÃ§e seÃ§in');
    resetSelect(mahalleSelect, 'Mahalle seÃ§in');

    if (ilSelect) {
      const provincesSorted = [...TR_PROVINCES].sort((a, b) => a.localeCompare(b, 'tr'));
      provincesSorted.forEach((province) => {
        const opt = document.createElement('option');
        opt.value = province;
        opt.textContent = province;
        ilSelect.appendChild(opt);
      });
    }

    function composeAddress() {
      const parts = [];
      if (mahalleSelect && mahalleSelect.value) parts.push(mahalleSelect.value);
      if (ilceSelect && ilceSelect.value) parts.push(ilceSelect.value);
      if (ilSelect && ilSelect.value) parts.push(ilSelect.value);
      if (postalInput && postalInput.value.trim()) parts.push(`PK: ${postalInput.value.trim()}`);
      const composed = parts.join(' - ');
      if (addressTextarea) addressTextarea.value = composed;
    }

    if (ilSelect) {
      ilSelect.addEventListener('change', async () => {
        const province = ilSelect.value;
        resetSelect(ilceSelect, 'Ä°lÃ§e seÃ§in');
        resetSelect(mahalleSelect, 'Mahalle seÃ§in');
        if (!province) { composeAddress(); return; }
        const districts = await fetchDistricts(province);
        fillSelect(ilceSelect, districts, 'Ä°lÃ§e seÃ§in');
        composeAddress();
      });
    }

    if (ilceSelect) {
      ilceSelect.addEventListener('change', async () => {
        const province = ilSelect?.value;
        const district = ilceSelect.value;
        resetSelect(mahalleSelect, 'Mahalle seÃ§in');
        if (!province || !district) { composeAddress(); return; }
        const neighborhoods = await fetchNeighborhoods(province, district);
        fillSelect(mahalleSelect, neighborhoods, neighborhoods.length ? 'Mahalle seÃ§in' : 'Veri bulunamadÄ±');
        composeAddress();
      });
    }

    if (mahalleSelect) {
      mahalleSelect.addEventListener('change', () => {
        if (mahalleSelect.value) logger.info('SeÃ§ilen mahalle', { mahalle: mahalleSelect.value });
        composeAddress();
      });
    }

    postalInput?.addEventListener('input', composeAddress);

    composeAddress();



    function renderChips(wrapId, set) {
      const box = document.getElementById(wrapId);
      box.innerHTML = "";
      [...set].forEach(v => {
        const span = document.createElement("span");
        span.className = "badge";
        span.textContent = v + " âœ•";
        span.title = "KaldÄ±r";
        span.onclick = () => { set.delete(v); renderChips(wrapId, set); };
        box.appendChild(span);
      });
    }

    // Email chip input
    document.getElementById("emailInput").addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        const v = e.target.value.trim();
        if (v && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)) {
          emailChips.add(v);
          renderChips("emailChips", emailChips);
          e.target.value = "";
        } else if (v) {
          toast.error(MESSAGES.ERROR_EMAIL_INVALID);
        }
      }
    });

    // Phone chip input
    document.getElementById("phoneInput").addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        const v = e.target.value.trim();
        if (v) {
          phoneChips.add(v);
          renderChips("phoneChips", phoneChips);
          e.target.value = "";
        }
      }
    });

    // Category chip input
    document.getElementById("catInput").addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        const v = e.target.value.trim();
        if (v) {
          catChips.add(v);
          renderChips("catChips", catChips);
          e.target.value = "";
        }
      }
    });

    // ==== Bulk selection buttons ====
    document.getElementById("selectAllCategories").onclick = () => {
      const allCategories = getAllCategories();
      allCategories.forEach(cat => catChips.add(cat.name)); // Store display names
      renderChips("catChips", catChips);
    };
    
    document.getElementById("clearAllCategories").onclick = () => {
      catChips.clear();
      renderChips("catChips", catChips);
    };

    // ==== Supplier role toggle ====
    const supplierCheckbox = document.getElementById("roleSupplier");
    supplierCheckbox.addEventListener("change", e => {
      document.getElementById("supplierNote").style.display = e.target.checked ? "block" : "none";
      if (!e.target.checked && desiredRoleSelect && ROLE_LOOKUP[desiredRoleSelect.value]?.type === 'supplier') {
        desiredRoleSelect.value = DEFAULT_BUYER_ROLE_KEY;
      }
    });

    desiredRoleSelect?.addEventListener('change', () => {
      const meta = getDesiredRoleMeta();
      if (meta?.type === 'supplier' && !supplierCheckbox.checked) {
        supplierCheckbox.checked = true;
        document.getElementById("supplierNote").style.display = "block";
      }
    });
    

    // ==== Get authenticated user and prefill ====
    const user = await requireAuth();
    document.getElementById("userEmail").textContent = user.email || "";
    document.getElementById("email").value = user.email || "";

    // Try to load existing profile if available
    try {
      const userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);
      if (snap.exists()) {
        const data = snap.data();
        
        // Prefill form
        document.getElementById("companyName").value = data.companyName || "";
        document.getElementById("website").value = data.website || "";
        document.getElementById("taxNumber").value = data.taxNumber || "";
        document.getElementById("taxOffice").value = data.taxOffice || "";
        document.getElementById("mersisNo").value = data.mersisNo || "";
        document.getElementById("country").value = data.country || "TÃ¼rkiye";
        document.getElementById("phone").value = data.contactPhones?.[0] || "";

        const provinceVal = data.province || data.city || '';
        if (provinceVal && ilSelect) {
          ilSelect.value = provinceVal;
          const districts = await fetchDistricts(provinceVal);
          fillSelect(ilceSelect, districts, 'Ä°lÃ§e seÃ§in');
          const districtVal = data.district && districts.includes(data.district) ? data.district : '';
          if (districtVal) {
            ilceSelect.value = districtVal;
            const neighborhoods = await fetchNeighborhoods(provinceVal, districtVal);
            fillSelect(mahalleSelect, neighborhoods, neighborhoods.length ? 'Mahalle seÃ§in' : 'Mahalle (opsiyonel)');
            if (data.neighborhood && neighborhoods.includes(data.neighborhood)) {
              mahalleSelect.value = data.neighborhood;
            }
          }
        }
        if (postalInput) postalInput.value = data.postalCode || '';
        if (addressTextarea && data.address) addressTextarea.value = data.address;
        composeAddress();
        
        // Load chips
        (data.contactEmails || []).forEach(v => emailChips.add(v));
        renderChips("emailChips", emailChips);
        
        (data.contactPhones?.slice(1) || []).forEach(v => phoneChips.add(v));
        renderChips("phoneChips", phoneChips);
        
        (data.buyerCategories || []).forEach(v => catChips.add(v));
        renderChips("catChips", catChips);
        
        // Check roles
        if (Array.isArray(data.roles) && data.roles.includes("supplier")) {
          document.getElementById("roleSupplier").checked = true;
          document.getElementById("supplierNote").style.display = "block";
        }
      }
      logger.info("Profile loaded successfully");
    } catch (e) {
      logger.warn("Profile preload error", e);
      logger.warn("Error details", { code: e.code, name: e.name, stack: e.stack });
    }

    // ==== Validation ====
    function validate() {
      const companyName = document.getElementById("companyName").value.trim();
      const taxNumber = document.getElementById("taxNumber").value.trim();
      const address = document.getElementById("address").value.trim();
      const mode = document.getElementById('companyMode').value;
      const joinCode = document.getElementById('companyJoinCode').value.trim();
      
      if (mode === 'create' && !companyName) return "Firma Ã¼nvanÄ± zorunludur.";
      if (mode === 'join' && !joinCode) return "Åirket kodu zorunludur.";
      if (!(taxNumber.length === 10 || taxNumber.length === 11)) {
        return "Vergi No 10 veya 11 hane olmalÄ±dÄ±r.";
      }
      if (!address) return "Adres zorunludur.";
      if (!document.getElementById("kvkkConsent").checked) {
        return "KVKK onayÄ±nÄ± iÅŸaretlemeniz gerekmektedir.";
      }
      if (!document.getElementById("contractConsent").checked) {
        return "KullanÄ±cÄ± SÃ¶zleÅŸmesi onayÄ±nÄ± iÅŸaretlemeniz gerekmektedir.";
      }
      
      return null;
    }

    // ==== Save ====
    document.getElementById("btnSave").onclick = async () => {
      const err = validate();
      if (err) {
        toast.error(err);
        return;
      }

      const btnSave = document.getElementById("btnSave");
      btnSave.disabled = true;
      btnSave.textContent = "Kaydediliyor...";

      try {
        // Determine roles
        const roles = ["buyer"];
        if (document.getElementById("roleSupplier").checked) {
          roles.push("supplier");
        }

        // Collect all contact info
        const allEmails = [user.email];
        emailChips.forEach(e => allEmails.push(e));
        
        const allPhones = [];
        const mainPhone = document.getElementById("phone").value.trim();
        if (mainPhone) allPhones.push(mainPhone);
        phoneChips.forEach(p => allPhones.push(p));

        // Prepare payload (compatible with multi-role system)
        const payload = {
          roles,
          isPremium: false,

          companyName: document.getElementById("companyName").value.trim(),
          taxNumber: document.getElementById("taxNumber").value.trim(),
          taxOffice: document.getElementById("taxOffice").value.trim() || null,
          mersisNo: document.getElementById("mersisNo").value.trim() || null,
          website: document.getElementById("website").value.trim() || null,
          address: document.getElementById("address").value.trim(),
          province: ilSelect?.value || null,
          district: ilceSelect?.value || null,
          neighborhood: mahalleSelect?.value || null,
          postalCode: postalInput?.value.trim() || null,
          country: document.getElementById("country").value.trim() || "TÃ¼rkiye",

          // Contact info
          contactEmails: allEmails.filter(e => e),
          contactPhones: allPhones.filter(p => p),
          
          // CRITICAL: Convert category names to IDs using new system
          buyerCategoryIds: normalizeToIds([...catChips]),
          // Backward compatibility: legacy fields
          buyerCategories: [...catChips].map(name => {
            const id = getIdByName(name);
            return id ? getNameById(id) : name;
          }),
          buyerCategoryKeys: normalizeToIds([...catChips]).map(id => {
            const cat = allCategories.find(c => c.id === id);
            return cat ? cat.slug : null;
          }).filter(Boolean),
          supplierCategories: [], // Will be filled in settings if supplier role active
          supplierCategoryIds: [] // Will be filled in settings if supplier role active
          
          // KVKK consents
          kvkkConsent: true,
          contractConsent: true,
          marketingConsent: document.getElementById("marketingConsent").checked || false,
          consentAt: serverTimestamp(),
          
          // Timestamps
          updatedAt: serverTimestamp()
        };

        // Company create/join
        const mode = document.getElementById('companyMode').value;
        let companyId = null;
        let companyRole = null;
        let companyJoinStatus = null;

        if (mode === 'create') {
          const code = genCompanyCode();
          const cdoc = await addDoc(collection(db, 'companies'), {
            name: payload.companyName,
            taxNumber: payload.taxNumber,
            createdAt: serverTimestamp(),
            ownerUid: user.uid,
            code
          });
          companyId = cdoc.id;
          companyRole = 'isveren';
          companyJoinStatus = 'approved';
          payload.companyId = companyId;
          payload.companyRole = companyRole;
          payload.companyJoinStatus = companyJoinStatus;
          payload.companyCode = code;
          payload.companyRoleType = 'buyer';
          payload.companyRoleKey = 'buyer:isveren';
        } else if (mode === 'join') {
          const codeRaw = (document.getElementById('companyJoinCode').value || '').trim().toUpperCase();
          if (!codeRaw) throw new Error('Åirket kodu zorunludur.');
          const company = await findCompanyByCode(codeRaw);
          if (!company) throw new Error('GeÃ§ersiz ÅŸirket kodu.');
          companyId = company.id;
          const roleMeta = getDesiredRoleMeta();
          if (!roleMeta) throw new Error('LÃ¼tfen geÃ§erli bir rol seÃ§in.');
          companyJoinStatus = 'pending';
          payload.companyId = companyId;
          payload.companyName = company.name || payload.companyName || '';
          payload.companyCode = company.code || codeRaw;
          payload.companyRole = null;
          payload.companyRoleType = null;
          payload.companyRoleKey = null;
          payload.companyJoinStatus = companyJoinStatus;
          payload.requestedCompanyRoleKey = roleMeta.key;
          payload.requestedCompanyRole = roleMeta.value;
          payload.requestedRoleType = roleMeta.type;
          if (roleMeta.type === 'supplier' && !roles.includes('supplier')) {
            roles.push('supplier');
          }
          ['companyName','taxNumber','taxOffice','mersisNo','website'].forEach((field) => {
            if (!payload[field]) delete payload[field];
          });
        }

        // Add createdAt only if new user
        const userRef = doc(db, "users", user.uid);
        const existingSnap = await getDoc(userRef);
        if (!existingSnap.exists()) {
          payload.createdAt = serverTimestamp();
        }

        // Save to Firestore
        await setDoc(userRef, payload, { merge: true });

        logger.info("User profile saved", { uid: user.uid });
        
        toast.success(MESSAGES.SUCCESS_REGISTER);
        
        // Redirect based on role
        if (roles.includes("supplier")) {
          // If supplier role selected, go to settings to complete supplier info
          toast.info(MESSAGES.INFO_SUPPLIER_REDIRECT);
          location.href = "./settings.html";
        } else {
          // Go to dashboard
          location.href = "./dashboard.html";
        }
        
      } catch (e) {
        logger.error("Save error", e);
        toast.error(MESSAGES.ERROR_SAVE + ": " + (e.message || e));
        btnSave.disabled = false;
        btnSave.textContent = "Kaydet ve Devam Et";
      }
    };
  </script>
</body>
</html>
