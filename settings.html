<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Ayarlar â€” Teklifbul</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%233b82f6' rx='6'/%3E%3Ctext x='16' y='22' font-family='Arial' font-size='18' font-weight='bold' text-anchor='middle' fill='white'%3ET%3C/text%3E%3C/svg%3E" />
  <link rel="stylesheet" href="/utils.css" />
  <link rel="stylesheet" href="/assets/css/layout.css" />
  <!-- OpenStreetMap (Leaflet.js) - $0 maliyet, sÄ±nÄ±rsÄ±z kullanÄ±m -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin: 0; font-family: system-ui, Arial; background: #f9fafb; }
    .container { max-width: none; margin: 0; padding: 20px; width: 100%; }
    .section { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .section h3 { margin: 0 0 16px 0; font-size: 18px; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .full { grid-column: 1 / -1; }
    label { font-weight: 600; font-size: 14px; color: #374151; display: block; margin-bottom: 6px; }
    label.required::after { content: " *"; color: #dc2626; }
    input[type="text"], input[type="email"], input[type="url"], textarea, select {
      width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; 
      font-size: 14px; box-sizing: border-box; transition: border-color 0.2s;
    }
    input:focus, textarea:focus, select:focus { outline: none; border-color: #3b82f6; }
    textarea { resize: vertical; font-family: inherit; }
    .radio-group { display: flex; gap: 20px; align-items: center; margin-top: 6px; }
    .radio-group label { font-weight: 400; display: flex; align-items: center; gap: 6px; margin: 0; }
    .chip-wrap { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; min-height: 32px; }
    .chip { display: inline-block; padding: 6px 12px; border-radius: 16px; background: #e0e7ff; 
            color: #3730a3; font-size: 13px; cursor: pointer; transition: all 0.2s; }
    .chip:hover { background: #c7d2fe; }
    .table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .table th, .table td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; }
    .table th { background: #f9fafb; font-weight: 600; font-size: 13px; color: #6b7280; }
    .table input, .table select { margin: 0; }
    .table button { padding: 6px 12px; font-size: 13px; }
    .btn { padding: 12px 24px; border: none; border-radius: 6px; font-weight: 600; 
           cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-secondary { background: #6b7280; color: white; }
    .btn-secondary:hover { background: #4b5563; }
    .btn-danger { background: #ef4444; color: white; padding: 6px 12px; font-size: 13px; }
    .btn-danger:hover { background: #dc2626; }
    .muted { opacity: 0.7; font-size: 13px; color: #6b7280; }
    .info-box { background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 12px; 
                margin: 16px 0; border-radius: 4px; font-size: 14px; color: #1e40af; }
    .file-upload { display: flex; flex-direction: column; gap: 8px; }
    .file-info { font-size: 13px; color: #059669; font-weight: 500; }
    
    /* Teklifbul Rule v1.0 - Alt Sayfa YapÄ±sÄ± */
    .settings-page { 
      display: none !important; 
    }
    .settings-page.active { 
      display: block !important; 
    }
    .settings-nav-btn.active { 
      background: #eff6ff !important; 
      color: #1e40af !important; 
      border-left: 3px solid #3b82f6;
    }
    .settings-nav-btn:hover { 
      background: #f3f4f6; 
    }
    @media (max-width: 768px) {
      .container--wide > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
      }
      .container--wide > div[style*="grid-template-columns"] > div:first-child {
        position: static !important;
        margin-bottom: 20px;
      }
      .container--wide > div[style*="grid-template-columns"] > div:first-child nav {
        flex-direction: row !important;
        flex-wrap: wrap;
      }
    }
    
    /* Teklifbul Rule v2.0 - Vergi dairesi buton hover efekti */
    #mainAddr_refreshTaxOfficesBtn:hover:not(:disabled) {
      background: #059669 !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }
    #mainAddr_refreshTaxOfficesBtn:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(16, 185, 129, 0.2);
    }
    #mainAddr_refreshTaxOfficesBtn:disabled {
      background: #9ca3af !important;
      cursor: not-allowed !important;
      opacity: 0.6;
    }
    /* Select hover efekti */
    #mainAddr_taxOfficeSelect:hover {
      border-color: #9ca3af;
    }
    #mainAddr_taxOfficeSelect:focus {
      border-color: #3b82f6;
      outline: 2px solid rgba(59, 130, 246, 0.2);
      outline-offset: 2px;
    }
  </style>
  <style>
    /* Theme-aware overrides using CSS variables */
    html, body { background: var(--surface) !important; color: var(--text) !important; }
    .section { background: var(--surface) !important; border-color: var(--border) !important; }
    .section h3 { color: var(--text) !important; border-bottom-color: var(--border) !important; }
    input[type="text"], input[type="email"], input[type="url"], textarea, select {
      background: var(--surface) !important; color: var(--text) !important; border-color: var(--border) !important;
    }
    .muted { color: var(--text-muted) !important; }
    .table th, .table td { border-bottom-color: var(--border) !important; }
    .table th { background: var(--surface) !important; color: var(--text-muted) !important; }
  </style>
</head>
<body>
  <!-- Common Header -->
  <header id="app-header"></header>

  <div class="container--wide" style="padding:20px 0">
    <h1 style="margin: 20px 0;">Hesap AyarlarÄ±</h1>
    <p class="muted">Profil bilgilerinizi gÃ¼ncelleyin. Bu bilgiler talep ve teklif sÃ¼reÃ§lerinde kullanÄ±lÄ±r.</p>

    <!-- Teklifbul Rule v1.0 - Alt Sayfa YapÄ±sÄ± -->
    <div style="display:grid; grid-template-columns: 240px 1fr; gap:24px; margin-top:24px;">
      <!-- Sol Sidebar - Alt Sayfa MenÃ¼sÃ¼ -->
      <div style="background:white; border-radius:8px; padding:16px; box-shadow:0 1px 3px rgba(0,0,0,0.1); height:fit-content; position:sticky; top:20px;">
        <nav style="display:flex; flex-direction:column; gap:4px;">
          <button class="settings-nav-btn active" data-page="general" 
                  style="width:100%; padding:12px 16px; text-align:left; background:none; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; color:#1f2937; transition:all 0.2s;">
            âš™ï¸ Genel Ayarlar
          </button>
          <button class="settings-nav-btn" data-page="company-users" 
                  style="width:100%; padding:12px 16px; text-align:left; background:none; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; color:#6b7280; transition:all 0.2s;">
            ğŸ‘¥ Åirket KullanÄ±cÄ±larÄ±
          </button>
          <button class="settings-nav-btn" data-page="approval-settings" 
                  style="width:100%; padding:12px 16px; text-align:left; background:none; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; color:#6b7280; transition:all 0.2s;">
            ğŸ” Teklif Onay AyarlarÄ±
          </button>
          <button class="settings-nav-btn" data-page="company-profile" 
                  style="width:100%; padding:12px 16px; text-align:left; background:none; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; color:#6b7280; transition:all 0.2s;">
            ğŸ¢ Åirket Profili
          </button>
          <button class="settings-nav-btn" data-page="premium" 
                  style="width:100%; padding:12px 16px; text-align:left; background:none; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; color:#6b7280; transition:all 0.2s;">
            â­ Premium Hesap
          </button>
          <button class="settings-nav-btn" data-page="addresses" 
                  style="width:100%; padding:12px 16px; text-align:left; background:none; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; color:#6b7280; transition:all 0.2s;">
            ğŸ“ Adres YÃ¶netimi
          </button>
        </nav>
      </div>

      <!-- SaÄŸ Ä°Ã§erik AlanÄ± -->
      <div style="flex:1;">
        <!-- Genel Ayarlar SayfasÄ± -->
        <div id="page-general" class="settings-page active">
          <div class="section">
            <h3>Firma Bilgileri</h3>
      
      <div class="row">
        <div>
          <label>Roller</label>
          <div class="radio-group">
            <label><input type="checkbox" id="roleBuyer" value="buyer"> AlÄ±cÄ±</label>
            <label><input type="checkbox" id="roleSupplier" value="supplier"> TedarikÃ§i</label>
          </div>
          <p class="muted" style="margin-top:4px; font-size:12px;">AlÄ±cÄ± â†’ kendi taleplerini aÃ§ar. TedarikÃ§i â†’ kategorisine uygun talepleri gÃ¶rÃ¼r.</p>

          <!-- KullanÄ±cÄ± RolÃ¼ Bilgi AlanÄ± (Sadece okunur chip ve aÃ§Ä±klama) -->
          <div id="userRoleDisplay" style="margin-top:10px;display:flex;gap:12px;align-items:center;">
            <span id="userRoleChip" style="background:#e0e7ff;color:#3730a3;font-weight:600;padding:6px 14px;border-radius:28px;font-size:13px;display:none;"></span>
            <span id="userRoleDesc" class="muted" style="font-size:12px;display:none;line-height:1.4;"></span>
          </div>
        </div>
        <div>
          <label for="displayName">GÃ¶rÃ¼nen Ad</label>
          <input type="text" id="displayName" placeholder="Ad Soyad / Yetkili kiÅŸi" />
        </div>
      </div>


          <!-- Åirket YÃ¶netimi -->
          <div class="row">
            <div class="full">
              <label>Åirket YÃ¶netimi</label>
              <div id="companyAdminBox" style="padding:12px; border:1px solid #e5e7eb; border-radius:8px;">
                <div id="companyInfoRow" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:8px;"></div>
                
                <!-- Referans Ä°stekleri - Teklifbul Rule v1.0 -->
                <div id="referralRequestsBox" style="display:none; margin-top:16px; padding:16px; background:#fff7ed; border-radius:8px; border:1px solid #f59e0b;">
                  <h4 style="margin:0 0 12px 0; font-size:16px; color:#92400e;">ğŸ”” Referans Ä°stekleri</h4>
                  <div id="referralRequestsList" style="display:flex; flex-direction:column; gap:12px;">
                    <!-- Referans istekleri buraya eklenecek -->
                  </div>
                </div>
                
                <!-- Referans Kodu Sistemi - Teklifbul Rule v1.0 -->
                <div id="referralCodeSection" style="display:none; margin-top:16px; padding:16px; background:#f0f9ff; border-radius:8px; border:1px solid #3b82f6;">
                  <h4 style="margin:0 0 12px 0; font-size:16px; color:#1e40af;">ğŸ“ Referans Kodu Sistemi</h4>
                  <p style="margin:0 0 16px 0; font-size:13px; color:#6b7280;">
                    Referans kodunuz ile kayÄ±t olan ÅŸirketler size referans olarak kaydedilir ve Ã¶dÃ¼l kazanma ÅŸansÄ±nÄ±z artar.
                  </p>
                  
                  <div style="margin-bottom:16px;">
                    <button type="button" id="generateReferralCodeBtn" style="padding:10px 16px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">
                      â• Yeni Referans Kodu OluÅŸtur
                    </button>
                  </div>
                  
                  <div id="referralCodesList" style="display:flex; flex-direction:column; gap:12px;">
                    <!-- Referans kodlarÄ± buraya dinamik olarak eklenecek -->
                  </div>
                </div>
              </div>
            </div>
          </div>

      <div class="row">
        <div>
          <label for="companyName" class="required">Åirket AdÄ±</label>
          <input type="text" id="companyName" required />
        </div>
        <div>
          <label for="taxNumber" class="required">Vergi No</label>
          <input type="text" id="taxNumber" required placeholder="10 haneli vergi numarasÄ±" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="mersisNo">MERSÄ°S No</label>
          <input type="text" id="mersisNo" placeholder="16 haneli MERSÄ°S numarasÄ±" />
        </div>
        <div>
          <label for="website">Web Sitesi</label>
          <input type="url" id="website" placeholder="https://www.sirketim.com" />
        </div>
        <div>
          <label for="googleBusinessUrl">Google Business Profil Linki (Ä°steÄŸe BaÄŸlÄ±)</label>
          <input type="url" id="googleBusinessUrl" placeholder="https://www.google.com/maps/place/..." />
          <p class="muted" style="margin-top:4px; font-size:12px;">
            ğŸ’¡ Google Maps'te ÅŸirketinizi bulun â†’ "PaylaÅŸ" â†’ "Link'i kopyala" yapÄ±n
          </p>
        </div>
      </div>

      <!-- Teklifbul Rule v1.0 - Structured Address Parts kaldÄ±rÄ±ldÄ± -->
      <!-- Adresler artÄ±k "Adres YÃ¶netimi" sekmesinden yÃ¶netiliyor -->
      <!-- Bu alanlar kaldÄ±rÄ±ldÄ±: Ãœlke, Ä°l, Ä°lÃ§e, Mahalle, Cadde, Sokak, KapÄ± No, Daire, Posta Kodu -->

      <div class="row">
        <div class="full">
          <label for="taxOffice">Vergi Dairesi</label>
          <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items:center; flex-wrap: nowrap;">
            <select id="taxOfficeSelect" style="flex: 1 1 auto; min-width: 220px;">
              <option value="">Vergi dairesi seÃ§in</option>
              <option value="custom">Elle yaz</option>
            </select>
            <button type="button" id="refreshTaxOfficesBtn" style="flex:0 0 auto; padding: 6px 10px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">
              ğŸ”„ Yenile
            </button>
          </div>
          <input type="text" id="taxOffice" placeholder="Vergi dairesi adÄ±" />
        </div>
      </div>

    </div>

    <!-- Contact Info -->
    <div class="section">
      <h3>Ä°letiÅŸim Bilgileri</h3>
      
      <div class="row">
        <div>
          <label for="emailInput">E-posta Adresleri</label>
          <input type="email" id="emailInput" placeholder="E-posta ekleyin ve Enter'a basÄ±n" />
          <div id="emailChips" class="chip-wrap"></div>
          <p class="muted" style="margin-top:4px">Birden fazla e-posta ekleyebilirsiniz</p>
        </div>
        <div>
          <label for="companyPhone">Åirket Sabit Telefon</label>
          <input type="text" id="companyPhone" placeholder="Ã–rn: 0 (212) 555 00 00" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="mobilePhone">Cep Telefonu</label>
          <input type="text" id="mobilePhone" placeholder="Ã–rn: 0 (5XX) 555 00 00" />
        </div>
        <div>
          <label for="whatsappPhone">WhatsApp HattÄ±</label>
          <input type="text" id="whatsappPhone" placeholder="Varsa Ã¶zel WhatsApp hattÄ±" />
        </div>
      </div>
      <div class="row">
        <div class="full">
          <label for="phoneInput">DiÄŸer Telefonlar</label>
          <input type="text" id="phoneInput" placeholder="DiÄŸer numaralarÄ± ekleyin ve Enter'a basÄ±n" />
          <div id="phoneChips" class="chip-wrap"></div>
          <p class="muted" style="margin-top:4px">Ek numaralarÄ± serbestÃ§e ekleyebilirsiniz</p>
        </div>
      </div>
    </div>

    <!-- Supplier Categories -->
    <div class="section" id="secSupplierCats" style="display:block;">
      <section class="category-section">
        <div class="category-header">
          <h3>TedarikÃ§i Kategorileri</h3>
          <input id="catSearch" class="category-search" type="search" placeholder="Ara..." aria-label="Kategori ara">
        </div>
        
        <div class="info-box">
          <strong>â„¹ï¸ Ã–nemli:</strong> SeÃ§tiÄŸiniz kategoriler, size yÃ¶nlendirilecek talepleri belirler. 
          En az bir kategori seÃ§melisiniz.
        </div>
        
        <div id="catList" class="category-list">
          <!-- Kategoriler JavaScript ile doldurulacak -->
        </div>
        
        <div class="category-actions">
          <button type="button" id="btnSelectAll" class="btn btn-secondary">TÃ¼mÃ¼nÃ¼ SeÃ§</button>
          <button type="button" id="btnClear" class="btn btn-secondary">Temizle</button>
        </div>
        
        <div id="catChips" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px"></div>
        <small class="muted">Ä°pucu: ArayÄ±p kutucuklarÄ± iÅŸaretleyin. "TÃ¼mÃ¼nÃ¼ SeÃ§" ile tÃ¼m tedarikÃ§i gruplarÄ±nÄ± tek tuÅŸla seÃ§ebilirsiniz.</small>
      </section>
    </div>
    <!-- Buyer Categories -->
    <div class="section" id="secBuyerCats" style="display:none;">
      <section class="category-section">
        <div class="category-header">
          <h3>AlÄ±cÄ± Kategorileri</h3>
          <input id="buyerCatSearch" class="category-search" type="search" placeholder="Ara..." aria-label="Kategori ara">
        </div>
        
        <div class="info-box">
          <strong>â„¹ï¸ Bilgi:</strong> Kendi taleplerinizi kategorize etmek iÃ§in kullanÄ±lÄ±r. Sadece etiketleme amaÃ§lÄ±dÄ±r.
        </div>
        
        <div id="buyerCatList" class="category-list">
          <!-- Kategoriler JavaScript ile doldurulacak -->
        </div>
        
        <div class="category-actions">
          <button type="button" id="btnSelectAllBuyer" class="btn btn-secondary">TÃ¼mÃ¼nÃ¼ SeÃ§</button>
          <button type="button" id="btnClearBuyer" class="btn btn-secondary">Temizle</button>
        </div>
        
        <div id="buyerCatChips" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px"></div>
        <small class="muted">Ä°pucu: ArayÄ±p kutucuklarÄ± iÅŸaretleyin. "TÃ¼mÃ¼nÃ¼ SeÃ§" ile tÃ¼m alÄ±cÄ± kategorilerini tek tuÅŸla seÃ§ebilirsiniz.</small>
      </section>
    </div>

    <!-- Tax Certificate -->
    <div class="section">
      <h3>Vergi LevhasÄ±</h3>
      
      <div class="file-upload">
        <label for="taxFile">Vergi LevhasÄ± DosyasÄ±</label>
        <input type="file" id="taxFile" accept=".pdf,.png,.jpg,.jpeg" />
        <p class="muted">PDF, PNG veya JPG formatÄ±nda yÃ¼kleyebilirsiniz (Maks. 5MB)</p>
        <div id="taxInfo" class="file-info" style="margin-top:8px;"></div>
      </div>
    </div>

    <!-- Bank Accounts -->
    <div class="section">
      <h3>Banka HesaplarÄ±</h3>
      <p class="muted">Ã–deme alacaÄŸÄ±nÄ±z banka hesaplarÄ±nÄ±zÄ± ekleyin</p>
      
      <table class="table">
        <thead>
          <tr>
            <th>Banka AdÄ±</th>
            <th>IBAN</th>
            <th>Hesap AdÄ±</th>
            <th>Para Birimi</th>
            <th style="width:80px"></th>
          </tr>
        </thead>
        <tbody id="bankBody"></tbody>
      </table>
      
      <button id="addBank" class="btn btn-secondary" style="margin-top:12px">+ Hesap Ekle</button>
    </div>

            <!-- KVKK Info -->
            <div class="section">
              <h3>KVKK & Onaylar</h3>
              <p id="kvkkInfo" class="muted"></p>
            </div>

            <!-- Save Button -->
            <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px">
              <button type="button" class="btn btn-secondary" id="cancelBtn">Ä°ptal</button>
              <button id="btnSave" type="button" class="btn btn-primary">DeÄŸiÅŸiklikleri Kaydet</button>
            </div>
          </div>

          <!-- Åirket KullanÄ±cÄ±larÄ± YÃ¶netimi SayfasÄ± -->
          <div id="page-company-users" class="settings-page">
            <div class="section">
              <h3>ğŸ‘¥ Åirket KullanÄ±cÄ±larÄ± YÃ¶netimi</h3>
              <p class="muted" style="margin-bottom:16px; font-size:13px;">
                Åirketinizdeki tÃ¼m kullanÄ±cÄ±larÄ± gÃ¶rÃ¼ntÃ¼leyebilir, rollerini deÄŸiÅŸtirebilir veya ÅŸirketten Ã§Ä±karabilirsiniz. Bekleyen katÄ±lÄ±m isteklerini de buradan yÃ¶netebilirsiniz.
              </p>
              
              <!-- Tabs -->
              <div style="display:flex; gap:8px; margin-bottom:20px; border-bottom:2px solid #e5e7eb;">
                <button id="tabActiveUsers" class="tab-btn active" style="padding:10px 16px; background:none; border:none; border-bottom:2px solid transparent; cursor:pointer; font-weight:600; color:#6b7280; transition:all 0.2s;">
                  âœ… Aktif KullanÄ±cÄ±lar
                </button>
                <button id="tabPendingRequests" class="tab-btn" style="padding:10px 16px; background:none; border:none; border-bottom:2px solid transparent; cursor:pointer; font-weight:600; color:#6b7280; transition:all 0.2s;">
                  ğŸ”” Bekleyen Ä°stekler
                </button>
              </div>
              
              <!-- Aktif KullanÄ±cÄ±lar Listesi -->
              <div id="activeUsersTab" class="tab-content">
                <div id="activeUsersList" style="display:flex; flex-direction:column; gap:12px;">
                  <div style="text-align:center; padding:20px; color:#6b7280;">
                    <p>YÃ¼kleniyor...</p>
                  </div>
                </div>
              </div>
              
              <!-- Bekleyen Ä°stekler Listesi -->
              <div id="pendingRequestsTab" class="tab-content" style="display:none;">
                <div style="margin-bottom:16px; padding:12px; background:#fef3c7; border:1px solid #fbbf24; border-radius:6px;">
                  <p style="margin:0 0 8px 0; font-size:13px; color:#92400e; font-weight:600;">ğŸ”§ Eksik Bilgili KayÄ±tlarÄ± DÃ¼zelt</p>
                  <p style="margin:0 0 8px 0; font-size:12px; color:#78350f;">Bekleyen isteklerde eksik bilgileri (userId, email, rol) otomatik olarak dÃ¼zeltir.</p>
                  <button 
                    id="btnFixJoinRequests" 
                    style="padding:8px 16px; background:#f59e0b; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600;"
                    onmouseover="this.style.background='#d97706'"
                    onmouseout="this.style.background='#f59e0b'"
                  >
                    ğŸ”§ Eksik Bilgileri DÃ¼zelt
                  </button>
                </div>
                <div id="companyJoinRequestsList" style="display:flex; flex-direction:column; gap:12px;">
                  <div style="text-align:center; padding:20px; color:#6b7280;">
                    <p>YÃ¼kleniyor...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Teklif Onay AyarlarÄ± SayfasÄ± -->
          <div id="page-approval-settings" class="settings-page">
            <div class="section">
              <h3>ğŸ” Teklif Onay AyarlarÄ±</h3>
              <p class="muted" style="margin-bottom:16px; font-size:13px;">
                Åirketinizin teklif onay mekanizmasÄ±nÄ± yÃ¶netebilirsiniz. Bu ayarlar PO (sipariÅŸ) oluÅŸturma ve e-imza onay iÅŸlemlerini etkiler.
              </p>
              
              <div style="display:grid; gap:20px;">
                <!-- Temel Onay PolitikasÄ± -->
                <div style="padding:16px; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb;">
                  <h4 style="margin:0 0 12px 0; font-size:16px; color:#1f2937;">Temel Onay PolitikasÄ±</h4>
                  
                  <div style="display:flex; flex-direction:column; gap:12px;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                      <input type="checkbox" id="approvalPolicy_require_at_least_one_top_approver" style="width:18px; height:18px; cursor:pointer;">
                      <span style="font-weight:600; color:#1f2937;">En az bir Ã¼st onaycÄ± zorunlu</span>
                    </label>
                    <p class="muted" style="margin:0 0 0 26px; font-size:12px;">
                      PO oluÅŸturma ve e-imza onay iÅŸlemleri iÃ§in ÅŸirkette en az bir Ã¼st onaycÄ± rolÃ¼ne sahip aktif kullanÄ±cÄ± bulunmalÄ±dÄ±r.
                    </p>
                  </div>
                  
                  <div style="margin-top:16px; display:flex; flex-direction:column; gap:12px;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                      <input type="checkbox" id="approvalPolicy_strict_top_required" style="width:18px; height:18px; cursor:pointer;">
                      <span style="font-weight:600; color:#1f2937;">SÄ±kÄ± Ã¼st onay zorunluluÄŸu</span>
                    </label>
                    <p class="muted" style="margin:0 0 0 26px; font-size:12px;">
                      Ãœst onaycÄ± olmadan hiÃ§bir iÅŸlem tamamlanamaz (opsiyonel - varsayÄ±lan: kapalÄ±).
                    </p>
                  </div>
                </div>
                
                <!-- Ãœst OnaycÄ± Rolleri -->
                <div style="padding:16px; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb;">
                  <h4 style="margin:0 0 12px 0; font-size:16px; color:#1f2937;">Ãœst OnaycÄ± Rolleri</h4>
                  <p class="muted" style="margin:0 0 16px 0; font-size:12px;">
                    AÅŸaÄŸÄ±daki rollere sahip kullanÄ±cÄ±lar e-imza ile teklif onaylama yetkisine sahiptir:
                  </p>
                  
                  <div id="approvalPolicy_top_approver_roles" style="display:grid; gap:8px;">
                    <!-- Ãœst onaycÄ± rolleri checkbox'larÄ± buraya dinamik olarak eklenecek -->
                  </div>
                </div>
                
                <!-- Son OnaycÄ± Rolleri -->
                <div style="padding:16px; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb;">
                  <h4 style="margin:0 0 12px 0; font-size:16px; color:#1f2937;">Son OnaycÄ± Rolleri (Opsiyonel)</h4>
                  <p class="muted" style="margin:0 0 16px 0; font-size:12px;">
                    Belirli iÅŸlemler iÃ§in sadece bu rollere sahip kullanÄ±cÄ±lar son onay verebilir:
                  </p>
                  
                  <div id="approvalPolicy_allowed_final_approver_roles" style="display:grid; gap:8px;">
                    <!-- Son onaycÄ± rolleri checkbox'larÄ± buraya dinamik olarak eklenecek -->
                  </div>
                </div>
                
                <!-- Miktar Belirleme ve Onay Sistemi -->
                <div style="padding:16px; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb;">
                  <h4 style="margin:0 0 12px 0; font-size:16px; color:#1f2937;">Miktar BazlÄ± Onay Sistemi</h4>
                  <div style="margin:0 0 16px 0; padding:12px; background:#eff6ff; border-left:4px solid #3b82f6; border-radius:4px;">
                    <p style="margin:0 0 8px 0; font-size:13px; font-weight:600; color:#1e40af;">ğŸ“‹ NasÄ±l Ã‡alÄ±ÅŸÄ±r?</p>
                    <p style="margin:0 0 8px 0; font-size:12px; color:#1f2937; line-height:1.6;">
                      <strong>Maksimum Tutar:</strong> Bu rolÃ¼n onaylayabileceÄŸi en yÃ¼ksek teklif tutarÄ± (TL cinsinden).<br>
                      <strong>Onay RolÃ¼:</strong> Bu tutara kadar onay yetkisi olan rol.<br>
                      <strong>AÃ§Ä±klama:</strong> Bu kuralÄ±n kÄ±sa aÃ§Ä±klamasÄ± (opsiyonel).
                    </p>
                    <div style="margin:8px 0; padding:10px; background:#fef3c7; border-left:3px solid #f59e0b; border-radius:4px;">
                      <p style="margin:0 0 4px 0; font-size:12px; font-weight:600; color:#78350f;">âš ï¸ Ã–zel Durum:</p>
                      <p style="margin:0; font-size:11px; color:#78350f; line-height:1.5;">
                        <strong>CEO, Ä°ÅŸveren, YÃ¶netim Kurulu BaÅŸkanÄ± ve Genel MÃ¼dÃ¼r</strong> rollerinin sÄ±nÄ±rsÄ±z onay yetkisi vardÄ±r. Bu roller iÃ§in limit belirlemenize gerek yoktur - her tutarda teklif onaylayabilirler.
                      </p>
                    </div>
                    <p style="margin:8px 0 0 0; font-size:12px; color:#1f2937; line-height:1.6;">
                      <strong>Ã–rnek Senaryo:</strong><br>
                      â€¢ SÄ±nÄ±rsÄ±z - Genel MÃ¼dÃ¼r â†’ Her tutarda teklif onaylayabilir<br>
                      â€¢ 50.000â‚º - Genel MÃ¼dÃ¼r YardÄ±mcÄ±sÄ± â†’ 50.000â‚º'ye kadar teklifleri onaylayabilir<br>
                      â€¢ 25.000â‚º - SatÄ±n Alma MÃ¼dÃ¼rÃ¼ â†’ 25.000â‚º'ye kadar teklifleri onaylayabilir<br>
                      â€¢ 10.000â‚º - SatÄ±n Alma UzmanÄ± â†’ 10.000â‚º'ye kadar teklifleri onaylayabilir
                    </p>
                    <p style="margin:8px 0 0 0; font-size:11px; color:#6b7280; font-style:italic;">
                      ğŸ’¡ Sistem, teklif tutarÄ±na bakarak hangi rolÃ¼n onay vermesi gerektiÄŸini otomatik belirler. Ãœst dÃ¼zey yÃ¶neticiler (CEO, Ä°ÅŸveren, YÃ¶netim Kurulu BaÅŸkanÄ±, Genel MÃ¼dÃ¼r) her zaman onay verebilir.
                    </p>
                  </div>
                  
                  <div id="approvalLimitsList" style="display:flex; flex-direction:column; gap:12px;">
                    <!-- Miktar limitleri buraya dinamik olarak eklenecek -->
                  </div>
                  
                  <button type="button" id="btnAddApprovalLimit" style="margin-top:12px; padding:10px 16px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">
                    â• Yeni Limit Ekle
                  </button>
                  <p class="muted" style="margin:8px 0 0 0; font-size:12px; color:#6b7280;">
                    ğŸ’¡ Her limit satÄ±rÄ± iÃ§in maksimum tutar, onay rolÃ¼ ve aÃ§Ä±klama belirleyebilirsiniz. Ã–rnek: 10.000â‚º'ye kadar Genel MÃ¼dÃ¼r onayÄ± gerekir.
                  </p>
                </div>
                
                <!-- HatÄ±rlatma Saatleri -->
                <div style="padding:16px; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb;">
                  <h4 style="margin:0 0 12px 0; font-size:16px; color:#1f2937;">HatÄ±rlatma Saatleri (Saat Cinsinden)</h4>
                  <p class="muted" style="margin:0 0 16px 0; font-size:12px;">
                    Onay bekleyen iÅŸlemler iÃ§in hatÄ±rlatma gÃ¶nderilecek saatleri belirleyin (virgÃ¼lle ayÄ±rÄ±n):
                  </p>
                  
                  <input type="text" id="approvalPolicy_reminder_hours" placeholder="Ã–rn: 24, 48, 72" 
                         style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
                  <p class="muted" style="margin:8px 0 0 0; font-size:12px;">
                    Ã–rnek: 24, 48 â†’ 24 saat ve 48 saat sonra hatÄ±rlatma gÃ¶nderilir
                  </p>
                </div>
                
                <!-- Kaydet Butonu -->
                <div style="display:flex; justify-content:flex-end; gap:12px;">
                  <button type="button" id="btnSaveApprovalPolicy" 
                          style="padding:10px 24px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">
                    ğŸ’¾ Onay PolitikasÄ±nÄ± Kaydet
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Åirket Profili SayfasÄ± -->
          <div id="page-company-profile" class="settings-page">
            <div class="section">
              <h3>ğŸ¢ Åirket Profili</h3>
              <p class="muted" style="margin-bottom:16px; font-size:13px;">
                Åirketinizin profil bilgilerini, web sitesini ve iÅŸ ortaklarÄ±nÄ±zÄ± yÃ¶netin. Yorumlar ve deÄŸerlendirmeleri gÃ¶rÃ¼ntÃ¼leyin.
              </p>
              
              <!-- Google Business ve Web Sitesi -->
              <div class="row" style="margin-bottom:24px;">
                <div>
                  <label for="companyProfile_website">Web Sitesi</label>
                  <input type="url" id="companyProfile_website" placeholder="https://www.sirketim.com" />
                </div>
                <div>
                  <label for="companyProfile_googleBusiness">Google Business Profil Linki (Ä°steÄŸe BaÄŸlÄ±)</label>
                  <input type="url" id="companyProfile_googleBusiness" placeholder="https://www.google.com/maps/place/..." />
                  <p class="muted" style="margin-top:4px; font-size:12px;">
                    ğŸ’¡ Google Maps'te ÅŸirketinizi bulun â†’ "PaylaÅŸ" â†’ "Link'i kopyala" yapÄ±n
                  </p>
                </div>
              </div>

              <!-- Ä°ÅŸlem YaptÄ±ÄŸÄ± Firmalar -->
              <div style="margin-bottom:24px; padding:16px; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb;">
                <h4 style="margin:0 0 12px 0; font-size:16px; color:#1f2937;">Ä°ÅŸlem YaptÄ±ÄŸÄ± Firmalar</h4>
                <p class="muted" style="margin:0 0 16px 0; font-size:12px;">
                  BaÅŸarÄ±lÄ± ticaret yaptÄ±ÄŸÄ±nÄ±z firmalarÄ±n listesi:
                </p>
                <div id="successfulTradePartners" style="display:flex; flex-direction:column; gap:12px;">
                  <div style="text-align:center; padding:20px; color:#6b7280;">
                    <p>YÃ¼kleniyor...</p>
                  </div>
                </div>
              </div>

              <!-- Yorumlar ve DeÄŸerlendirmeler -->
              <div style="padding:16px; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb;">
                <h4 style="margin:0 0 12px 0; font-size:16px; color:#1f2937;">Yorumlar ve DeÄŸerlendirmeler</h4>
                <p class="muted" style="margin:0 0 16px 0; font-size:12px;">
                  Åirketiniz hakkÄ±nda yapÄ±lan yorumlarÄ± gÃ¶rÃ¼ntÃ¼leyin ve yanÄ±tlayÄ±n:
                </p>
                
                <!-- YÄ±ldÄ±z PuanÄ± -->
                <div style="margin-bottom:16px; padding:16px; background:white; border-radius:6px; border:1px solid #e5e7eb;">
                  <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                    <span style="font-size:32px; font-weight:700; color:#1f2937;">4.8</span>
                    <div style="display:flex; gap:4px;">
                      <span style="font-size:20px; color:#fbbf24;">â˜…â˜…â˜…â˜…â˜…</span>
                    </div>
                    <span style="font-size:14px; color:#6b7280;">(24 deÄŸerlendirme)</span>
                  </div>
                </div>
                
                <!-- Yorumlar Listesi -->
                <div id="companyReviewsList" style="display:flex; flex-direction:column; gap:16px; margin-top:16px;">
                  <div style="padding:16px; background:white; border-radius:8px; border:1px solid #e5e7eb;">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                      <div>
                        <div style="font-weight:600; color:#1f2937; margin-bottom:4px;">Firma AdÄ±</div>
                        <div style="font-size:12px; color:#6b7280;">2 gÃ¼n Ã¶nce</div>
                      </div>
                      <div style="color:#fbbf24;">â˜…â˜…â˜…â˜…â˜…</div>
                    </div>
                    <p style="margin:8px 0; color:#374151; line-height:1.6;">
                      Ã‡ok hÄ±zlÄ± ve gÃ¼venilir bir firma. Ä°ÅŸlerini zamanÄ±nda teslim ettiler.
                    </p>
                    <div style="margin-top:12px; padding-top:12px; border-top:1px solid #e5e7eb;">
                      <button type="button" class="btn btn-secondary" style="padding:6px 12px; font-size:13px;">
                        ğŸ’¬ YanÄ±tla
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Kaydet Butonu -->
              <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:24px;">
                <button type="button" id="btnSaveCompanyProfile" class="btn btn-primary">
                  ğŸ’¾ Profil Bilgilerini Kaydet
                </button>
              </div>
            </div>
          </div>
          <!-- Premium Hesap SayfasÄ± -->
          <div id="page-premium" class="settings-page">
            <div class="section">
              <h3>â­ Premium Hesap</h3>
              <p class="muted" style="margin-bottom:16px; font-size:13px;">
                Premium hesap Ã¶zelliklerinizi yÃ¶netin, Ã¶deme geÃ§miÅŸinizi gÃ¶rÃ¼ntÃ¼leyin ve firmalardan Ã¶deme talep edin.
              </p>
              
              <!-- Premium Durum -->
              <div style="padding:20px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:12px; color:white; margin-bottom:24px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                  <div>
                    <h4 style="margin:0; font-size:20px; font-weight:700;">Premium Hesap Durumu</h4>
                    <p style="margin:8px 0 0 0; font-size:14px; opacity:0.9;" id="premiumStatusText">Aktif</p>
                  </div>
                  <div style="text-align:right;">
                    <div style="font-size:32px; font-weight:700;" id="premiumBadge">â­</div>
                  </div>
                </div>
                <div style="margin-top:16px; padding-top:16px; border-top:1px solid rgba(255,255,255,0.2);">
                  <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                    <input type="checkbox" id="isPremium" style="width:20px; height:20px; cursor:pointer;">
                    <span style="font-weight:600;">Premium hesap aktif</span>
                  </label>
                </div>
              </div>

              <!-- Premium Ã–zellikler -->
              <div style="margin-bottom:24px; padding:20px; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb;">
                <h4 style="margin:0 0 16px 0; font-size:18px; color:#1f2937;">Premium Ã–zellikler</h4>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:16px;">
                  <div style="padding:16px; background:white; border-radius:8px; border:1px solid #e5e7eb;">
                    <div style="font-size:24px; margin-bottom:8px;">ğŸš€</div>
                    <div style="font-weight:600; color:#1f2937; margin-bottom:4px;">SÄ±nÄ±rsÄ±z Talep</div>
                    <div style="font-size:13px; color:#6b7280;">SÄ±nÄ±rsÄ±z sayÄ±da talep oluÅŸturabilirsiniz</div>
                  </div>
                  <div style="padding:16px; background:white; border-radius:8px; border:1px solid #e5e7eb;">
                    <div style="font-size:24px; margin-bottom:8px;">ğŸ“Š</div>
                    <div style="font-weight:600; color:#1f2937; margin-bottom:4px;">GeliÅŸmiÅŸ Raporlama</div>
                    <div style="font-size:13px; color:#6b7280;">DetaylÄ± analiz ve raporlama Ã¶zellikleri</div>
                  </div>
                  <div style="padding:16px; background:white; border-radius:8px; border:1px solid #e5e7eb;">
                    <div style="font-size:24px; margin-bottom:8px;">ğŸ¯</div>
                    <div style="font-weight:600; color:#1f2937; margin-bottom:4px;">Ã–ncelikli Destek</div>
                    <div style="font-size:13px; color:#6b7280;">7/24 Ã¶ncelikli mÃ¼ÅŸteri desteÄŸi</div>
                  </div>
                  <div style="padding:16px; background:white; border-radius:8px; border:1px solid #e5e7eb;">
                    <div style="font-size:24px; margin-bottom:8px;">ğŸ’¼</div>
                    <div style="font-weight:600; color:#1f2937; margin-bottom:4px;">Ã–zel Ã–zellikler</div>
                    <div style="font-size:13px; color:#6b7280;">Exclusive premium Ã¶zellikler</div>
                  </div>
                </div>
              </div>

              <!-- Ã–deme Talep Etme -->
              <div style="margin-bottom:24px; padding:20px; background:#fef3c7; border-radius:8px; border:1px solid #f59e0b;">
                <h4 style="margin:0 0 12px 0; font-size:18px; color:#92400e;">ğŸ’° Firmalardan Ã–deme Talep Et</h4>
                <p class="muted" style="margin:0 0 16px 0; font-size:13px; color:#78350f;">
                  OnaylanmÄ±ÅŸ teklifleriniz iÃ§in firmalardan Ã¶deme talep edebilirsiniz. OnaylanmÄ±ÅŸ tekliflerden otomatik doldurma yapabilirsiniz.
                </p>
                
                <!-- OnaylanmÄ±ÅŸ Tekliflerden SeÃ§ -->
                <div style="margin-bottom:16px; padding:12px; background:white; border-radius:6px; border:1px solid #e5e7eb;">
                  <label style="font-size:12px; color:#78350f; margin-bottom:8px; display:block; font-weight:600;">âš¡ OnaylanmÄ±ÅŸ Tekliflerden Otomatik Doldur</label>
                  <select id="paymentRequest_approvedBidId" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
                    <option value="">OnaylanmÄ±ÅŸ teklif seÃ§in (otomatik doldurma iÃ§in)...</option>
                  </select>
                  <p class="muted" style="margin:8px 0 0 0; font-size:11px; color:#78350f;">
                    Bir teklif seÃ§tiÄŸinizde firma, tutar ve aÃ§Ä±klama otomatik doldurulacaktÄ±r.
                  </p>
                </div>
                
                <div style="display:grid; gap:12px;">
                  <div style="display:grid; grid-template-columns: 2fr 1fr 1fr auto; gap:12px; align-items:end;">
                    <div>
                      <label style="font-size:12px; color:#78350f; margin-bottom:4px; display:block;">Firma SeÃ§in</label>
                      <select id="paymentRequest_companyId" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
                        <option value="">Firma seÃ§in...</option>
                      </select>
                    </div>
                    <div>
                      <label style="font-size:12px; color:#78350f; margin-bottom:4px; display:block;">Tutar (â‚º)</label>
                      <input type="number" id="paymentRequest_amount" placeholder="0.00" step="0.01" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
                    </div>
                    <div>
                      <label style="font-size:12px; color:#78350f; margin-bottom:4px; display:block;">Termin</label>
                      <input type="date" id="paymentRequest_dueDate" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
                    </div>
                    <button type="button" id="btnRequestPayment" style="padding:10px 20px; background:#f59e0b; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; white-space:nowrap;">
                      ğŸ“¤ Talep Et
                    </button>
                  </div>
                  <div>
                    <label style="font-size:12px; color:#78350f; margin-bottom:4px; display:block;">AÃ§Ä±klama (Ä°steÄŸe BaÄŸlÄ±)</label>
                    <textarea id="paymentRequest_description" placeholder="Ã–deme talebi iÃ§in aÃ§Ä±klama..." rows="2" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; resize:vertical;"></textarea>
                  </div>
                </div>
              </div>
              
              <!-- Plan KarÅŸÄ±laÅŸtÄ±rma -->
              <div style="margin-bottom:24px; padding:20px; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb;">
                <h4 style="margin:0 0 16px 0; font-size:18px; color:#1f2937;">ğŸ“Š Plan KarÅŸÄ±laÅŸtÄ±rmasÄ±</h4>
                <div style="overflow-x:auto;">
                  <table style="width:100%; border-collapse:collapse;">
                    <thead>
                      <tr style="background:#f3f4f6;">
                        <th style="padding:12px; text-align:left; border-bottom:2px solid #e5e7eb; font-size:14px; color:#374151;">Ã–zellik</th>
                        <th style="padding:12px; text-align:center; border-bottom:2px solid #e5e7eb; font-size:14px; color:#374151;">Free</th>
                        <th style="padding:12px; text-align:center; border-bottom:2px solid #e5e7eb; font-size:14px; color:#374151; background:#fef3c7;">
                          â­ Premium
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td style="padding:12px; border-bottom:1px solid #e5e7eb; font-size:13px;">Talep OluÅŸturma</td>
                        <td style="padding:12px; text-align:center; border-bottom:1px solid #e5e7eb; font-size:13px;">AylÄ±k 10 talep</td>
                        <td style="padding:12px; text-align:center; border-bottom:1px solid #e5e7eb; font-size:13px; font-weight:600; color:#10b981;">SÄ±nÄ±rsÄ±z</td>
                      </tr>
                      <tr>
                        <td style="padding:12px; border-bottom:1px solid #e5e7eb; font-size:13px;">Teklif GÃ¶rÃ¼ntÃ¼leme</td>
                        <td style="padding:12px; text-align:center; border-bottom:1px solid #e5e7eb; font-size:13px;">âœ“</td>
                        <td style="padding:12px; text-align:center; border-bottom:1px solid #e5e7eb; font-size:13px; font-weight:600; color:#10b981;">âœ“</td>
                      </tr>
                      <tr>
                        <td style="padding:12px; border-bottom:1px solid #e5e7eb; font-size:13px;">GeliÅŸmiÅŸ Raporlama</td>
                        <td style="padding:12px; text-align:center; border-bottom:1px solid #e5e7eb; font-size:13px;">âœ—</td>
                        <td style="padding:12px; text-align:center; border-bottom:1px solid #e5e7eb; font-size:13px; font-weight:600; color:#10b981;">âœ“</td>
                      </tr>
                      <tr>
                        <td style="padding:12px; border-bottom:1px solid #e5e7eb; font-size:13px;">Ã–ncelikli Destek</td>
                        <td style="padding:12px; text-align:center; border-bottom:1px solid #e5e7eb; font-size:13px;">âœ—</td>
                        <td style="padding:12px; text-align:center; border-bottom:1px solid #e5e7eb; font-size:13px; font-weight:600; color:#10b981;">âœ“</td>
                      </tr>
                      <tr>
                        <td style="padding:12px; border-bottom:1px solid #e5e7eb; font-size:13px;">Ã–deme Talep Etme</td>
                        <td style="padding:12px; text-align:center; border-bottom:1px solid #e5e7eb; font-size:13px;">âœ—</td>
                        <td style="padding:12px; text-align:center; border-bottom:1px solid #e5e7eb; font-size:13px; font-weight:600; color:#10b981;">âœ“</td>
                      </tr>
                      <tr>
                        <td style="padding:12px; border-bottom:1px solid #e5e7eb; font-size:13px;">Fatura Ä°ndirme</td>
                        <td style="padding:12px; text-align:center; border-bottom:1px solid #e5e7eb; font-size:13px;">âœ—</td>
                        <td style="padding:12px; text-align:center; border-bottom:1px solid #e5e7eb; font-size:13px; font-weight:600; color:#10b981;">âœ“</td>
                      </tr>
                      <tr>
                        <td style="padding:12px; font-size:13px; font-weight:600;">AylÄ±k Ãœcret</td>
                        <td style="padding:12px; text-align:center; font-size:13px; font-weight:600;">â‚º0</td>
                        <td style="padding:12px; text-align:center; font-size:13px; font-weight:700; color:#f59e0b;">â‚º299</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              
              <!-- Ã–deme YÃ¶ntemleri -->
              <div style="margin-bottom:24px; padding:20px; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                  <h4 style="margin:0; font-size:18px; color:#1f2937;">ğŸ’³ Ã–deme YÃ¶ntemleri</h4>
                  <button type="button" id="btnAddPaymentMethod" class="btn btn-primary" style="padding:8px 16px; font-size:13px;">
                    â• Yeni Ã–deme YÃ¶ntemi Ekle
                  </button>
                </div>
                <div id="paymentMethodsList" style="display:flex; flex-direction:column; gap:12px;">
                  <div style="padding:16px; background:white; border-radius:8px; border:1px solid #e5e7eb;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                      <div>
                        <div style="font-weight:600; color:#1f2937; margin-bottom:4px;">ğŸ’³ Kredi KartÄ±</div>
                        <div style="font-size:13px; color:#6b7280;">**** **** **** 1234</div>
                        <div style="font-size:12px; color:#6b7280; margin-top:4px;">Son Kullanma: 12/25</div>
                      </div>
                      <div style="display:flex; gap:8px;">
                        <button type="button" class="btn btn-secondary" style="padding:6px 12px; font-size:12px;">
                          âœï¸ DÃ¼zenle
                        </button>
                        <button type="button" class="btn btn-danger" style="padding:6px 12px; font-size:12px;">
                          ğŸ—‘ï¸ Sil
                        </button>
                      </div>
                    </div>
                  </div>
                  <div style="padding:16px; background:white; border-radius:8px; border:1px solid #e5e7eb;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                      <div>
                        <div style="font-weight:600; color:#1f2937; margin-bottom:4px;">ğŸ¦ Banka Havalesi</div>
                        <div style="font-size:13px; color:#6b7280;">TR12 3456 7890 1234 5678 9012 34</div>
                        <div style="font-size:12px; color:#6b7280; margin-top:4px;">Ziraat BankasÄ±</div>
                      </div>
                      <div style="display:flex; gap:8px;">
                        <button type="button" class="btn btn-secondary" style="padding:6px 12px; font-size:12px;">
                          âœï¸ DÃ¼zenle
                        </button>
                        <button type="button" class="btn btn-danger" style="padding:6px 12px; font-size:12px;">
                          ğŸ—‘ï¸ Sil
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>


              <!-- Abonelik Bilgileri -->
              <div style="padding:20px; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb;">
                <h4 style="margin:0 0 16px 0; font-size:18px; color:#1f2937;">ğŸ“… Abonelik Bilgileri</h4>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
                  <div>
                    <div style="font-size:12px; color:#6b7280; margin-bottom:4px;">BaÅŸlangÄ±Ã§ Tarihi</div>
                    <div style="font-weight:600; color:#1f2937;" id="subscriptionStartDate">-</div>
                  </div>
                  <div>
                    <div style="font-size:12px; color:#6b7280; margin-bottom:4px;">BitiÅŸ Tarihi</div>
                    <div style="font-weight:600; color:#1f2937;" id="subscriptionEndDate">-</div>
                  </div>
                  <div>
                    <div style="font-size:12px; color:#6b7280; margin-bottom:4px;">Sonraki Ã–deme</div>
                    <div style="font-weight:600; color:#1f2937;" id="nextPaymentDate">-</div>
                  </div>
                  <div>
                    <div style="font-size:12px; color:#6b7280; margin-bottom:4px;">AylÄ±k Ãœcret</div>
                    <div style="font-weight:600; color:#1f2937;" id="monthlyFee">-</div>
                  </div>
                </div>
                <div style="margin-top:16px; display:flex; gap:12px;">
                  <button type="button" id="btnUpgradePlan" class="btn btn-primary" style="padding:10px 20px;">
                    ğŸš€ PlanÄ± YÃ¼kselt
                  </button>
                  <button type="button" id="btnCancelSubscription" class="btn btn-secondary" style="padding:10px 20px;">
                    âŒ AboneliÄŸi Ä°ptal Et
                  </button>
                </div>
              </div>
              
              <!-- Kaydet Butonu - Premium ayarlarÄ± iÃ§in -->
              <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:24px;">
                <button type="button" id="btnSavePremiumSettings" class="btn btn-primary">
                  ğŸ’¾ Premium AyarlarÄ±nÄ± Kaydet
                </button>
              </div>
            </div>
          </div>

          <!-- Adres YÃ¶netimi SayfasÄ± -->
          <div id="page-addresses" class="settings-page">
            <div class="section">
              <h3>ğŸ“ Adres YÃ¶netimi</h3>
              <p class="muted" style="margin-bottom:16px; font-size:13px;">
                Fatura adresi, teslimat adresi ve diÄŸer adreslerinizi buradan yÃ¶netebilirsiniz.
              </p>
              
              <!-- Ana Adres (Fatura Adresi) -->
              <div style="margin-bottom:24px; padding:20px; background:#f0f9ff; border-radius:8px; border:1px solid #3b82f6;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                  <h4 style="margin:0; font-size:16px; color:#1e40af; font-weight:600;">ğŸ  Ana Adres (Fatura Adresi)</h4>
                  <span style="padding:4px 12px; background:#3b82f6; color:white; border-radius:12px; font-size:12px; font-weight:600;">VarsayÄ±lan</span>
                </div>
                <div id="mainAddressDisplay" style="padding:16px; background:white; border-radius:6px; border:1px solid #e5e7eb;">
                  <p style="margin:0; color:#6b7280; font-size:14px;">YÃ¼kleniyor...</p>
                </div>
                <button type="button" id="btnEditMainAddress" style="margin-top:12px; padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600;">
                  âœï¸ DÃ¼zenle
                </button>
              </div>

              <!-- Ä°lave Adresler -->
              <div style="margin-bottom:24px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                  <h4 style="margin:0; font-size:16px; color:#1f2937; font-weight:600;">ğŸ“¦ Ä°lave Adresler</h4>
                  <div style="display:flex; gap:8px;">
                    <button type="button" id="btnBulkEditAddresses" class="btn btn-secondary" style="padding:8px 16px; font-size:13px; display:none;">
                      âœï¸ Toplu DÃ¼zenle
                    </button>
                    <button type="button" id="addAddressBtn" onclick="addAddress()" style="padding:10px 20px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">
                      â• Yeni Adres Ekle
                    </button>
                  </div>
                </div>
                
                <!-- Toplu Ä°ÅŸlem Kontrolleri -->
                <div id="bulkActionsAddresses" style="display:none; margin-bottom:12px; padding:12px; background:#fef3c7; border-radius:6px; border:1px solid #f59e0b;">
                  <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:13px; color:#78350f; font-weight:600;" id="selectedAddressCount">0 adres seÃ§ildi</span>
                    <div style="display:flex; gap:8px;">
                      <button type="button" id="btnBulkDeleteAddresses" class="btn btn-danger" style="padding:6px 12px; font-size:12px;">
                        ğŸ—‘ï¸ SeÃ§ilenleri Sil
                      </button>
                      <button type="button" id="btnCancelBulkEdit" class="btn btn-secondary" style="padding:6px 12px; font-size:12px;">
                        Ä°ptal
                      </button>
                    </div>
                  </div>
                </div>
                
                <div id="additionalAddresses" style="display:flex; flex-direction:column; gap:12px;">
                  <div style="text-align:center; padding:20px; color:#6b7280;">
                    <p>HenÃ¼z ilave adres eklenmemiÅŸ.</p>
                  </div>
                </div>
              </div>
              
              <!-- VarsayÄ±lan Adres SeÃ§imi -->
              <div style="margin-bottom:24px; padding:20px; background:#f0f9ff; border-radius:8px; border:1px solid #3b82f6;">
                <h4 style="margin:0 0 12px 0; font-size:16px; color:#1e40af; font-weight:600;">âš™ï¸ VarsayÄ±lan Teslimat Adresi</h4>
                <p class="muted" style="margin:0 0 16px 0; font-size:13px; color:#1e40af;">
                  Talep oluÅŸtururken otomatik olarak seÃ§ilecek teslimat adresini belirleyin. 
                  <strong>Not:</strong> Fatura adresi her zaman "Ana Adres (Fatura Adresi)" bÃ¶lÃ¼mÃ¼nden belirlenir.
                </p>
                  <div>
                    <label style="font-size:12px; color:#1e40af; margin-bottom:4px; display:block;">VarsayÄ±lan Teslimat Adresi</label>
                    <select id="defaultDeliveryAddress" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
                    <option value="main">ğŸ  Ana Adres (Fatura Adresi)</option>
                    </select>
                </div>
              </div>
              
              <!-- OpenStreetMap Entegrasyonu (Leaflet.js) -->
              <div style="margin-bottom:24px; padding:20px; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb;">
                <h4 style="margin:0 0 12px 0; font-size:16px; color:#1f2937; font-weight:600;">ğŸ—ºï¸ Harita ile Adres DoÄŸrulama</h4>
                <p class="muted" style="margin:0 0 8px 0; font-size:13px;">
                  SeÃ§ili adresinizi OpenStreetMap'te gÃ¶rÃ¼ntÃ¼leyin ve doÄŸruluÄŸunu kontrol edin.
                </p>
                <p class="muted" style="margin:0 0 16px 0; font-size:12px; color:#6b7280;">
                  ğŸ’¡ Harita, <strong>"VarsayÄ±lan Teslimat Adresi"</strong> dropdown'Ä±nda seÃ§ili olan adresi gÃ¶sterir. EÄŸer "Ana Adres" seÃ§iliyse, fatura adresi gÃ¶sterilir.
                </p>
                <div id="addressMapContainer" style="width:100%; height:300px; background:#e5e7eb; border-radius:6px; display:flex; align-items:center; justify-content:center; color:#6b7280;">
                  <p>Harita yÃ¼kleniyor...</p>
                </div>
                <button type="button" id="btnVerifyAddress" style="margin-top:12px; padding:10px 20px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">
                  âœ… Adresi DoÄŸrula
                </button>
              </div>
              <!-- Adres TÃ¼rleri Ä°statistikleri -->
              <div style="padding:20px; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb;">
                <h4 style="margin:0 0 16px 0; font-size:16px; color:#1f2937;">ğŸ“Š Adres Ä°statistikleri</h4>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:16px;">
                  <div style="text-align:center; padding:16px; background:white; border-radius:6px; border:1px solid #e5e7eb;">
                    <div style="font-size:32px; font-weight:700; color:#3b82f6;" id="addressCount_total">0</div>
                    <div style="font-size:13px; color:#6b7280; margin-top:4px;">Toplam Adres</div>
                  </div>
                  <div style="text-align:center; padding:16px; background:white; border-radius:6px; border:1px solid #e5e7eb;">
                    <div style="font-size:32px; font-weight:700; color:#10b981;" id="addressCount_invoice">0</div>
                    <div style="font-size:13px; color:#6b7280; margin-top:4px;">Fatura Adresi</div>
                  </div>
                  <div style="text-align:center; padding:16px; background:white; border-radius:6px; border:1px solid #e5e7eb;">
                    <div style="font-size:32px; font-weight:700; color:#f59e0b;" id="addressCount_delivery">0</div>
                    <div style="font-size:13px; color:#6b7280; margin-top:4px;">Teslimat Adresi</div>
                  </div>
                  <div style="text-align:center; padding:16px; background:white; border-radius:6px; border:1px solid #e5e7eb;">
                    <div style="font-size:32px; font-weight:700; color:#8b5cf6;" id="addressCount_other">0</div>
                    <div style="font-size:13px; color:#6b7280; margin-top:4px;">DiÄŸer</div>
                  </div>
                </div>
              </div>
              
              <!-- Kaydet Butonu - VarsayÄ±lan Adres AyarlarÄ± iÃ§in -->
              <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:24px;">
                <button type="button" id="btnSaveAddressSettings" class="btn btn-primary">
                  ğŸ’¾ VarsayÄ±lan Adres AyarlarÄ±nÄ± Kaydet
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Settings Script -->
  <script type="module">
    import { initGlobalHeader } from './assets/js/ui/header.js';
    import { initAuthGuard } from './assets/js/auth-guard.js';
    import { db, auth, logout } from "./firebase.js";
    // signOut is imported dynamically from Firebase Auth modules when needed
    import { showToastNotification } from './assets/js/ui/errors.js';
    // Teklifbul Rule v1.0 - Structured Logging
    import { logger } from './src/shared/log/logger.js';
    // Teklifbul Rule v1.0 - Toast Notification System
    import { toast } from './src/shared/ui/toast.js';
    // Teklifbul Rule v1.1 - MESSAGES constants (i18n hazÄ±rlÄ±ÄŸÄ±)
    import { MESSAGES } from './src/shared/constants/messages.js';
    
    // Teklifbul Rule v1.0 - Global scope'a ekle (loadAndSetupApprovalPolicyManagement'dan eriÅŸilebilir olmasÄ± iÃ§in)
    // ArtÄ±k toast kullanÄ±yoruz, showToastNotification'Ä± da tutuyoruz geriye dÃ¶nÃ¼k uyumluluk iÃ§in
    window.showToastNotification = showToastNotification;
    window.toast = toast;
    
    // Teklifbul Rule v1.0 - Auth guard baÅŸlat (giriÅŸ kontrolÃ¼)
    initAuthGuard().catch(err => {
      logger.warn("Auth guard baÅŸlatÄ±lamadÄ±", err);
    });
    
    // Initialize global header
    initGlobalHeader({ mount: '#app-header', activeRoute: 'settings' });
    
    // Teklifbul Rule v1.0 - Firebase Module Caching (Performance optimization)
    // Cache Firebase modules after first import to avoid repeated dynamic imports
    const firebaseModuleCache = {
      firestore: null,
      auth: null
    };
    
    async function getFirestoreModules() {
      if (!firebaseModuleCache.firestore) {
        firebaseModuleCache.firestore = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
      }
      return firebaseModuleCache.firestore;
    }
    
    // Teklifbul Rule v1.0 - Global scope'a ekle (loadAndSetupApprovalPolicyManagement'dan eriÅŸilebilir olmasÄ± iÃ§in)
    window.getFirestoreModules = getFirestoreModules;
    
    async function getAuthModules() {
      if (!firebaseModuleCache.auth) {
        firebaseModuleCache.auth = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js");
      }
      return firebaseModuleCache.auth;
    }
    
    // Teklifbul Rule v1.0 - Safe Event Binding Helper (Prevents duplicate listeners)
    function safeBindEventListener(elementId, eventType, handler) {
      const element = document.getElementById(elementId);
      if (!element) {
        logger.warn(`Element ${elementId} not found`);
        return null;
      }
      
      // Clone to remove old listeners
      const newElement = element.cloneNode(true);
      element.parentNode.replaceChild(newElement, element);
      
      // Add new listener
      newElement.addEventListener(eventType, handler);
      
      return newElement;
    }
    
    // Teklifbul Rule v1.0 - Approval Limit Validation Helper
    function validateApprovalLimit(maxAmount, role) {
      if (role && !maxAmount && maxAmount !== 0) {
        return { valid: false, error: 'Maksimum tutar belirtilmelidir' };
      }
      if (maxAmount !== null && maxAmount !== undefined && isNaN(parseFloat(maxAmount))) {
        return { valid: false, error: 'Maksimum tutar sayÄ± olmalÄ±dÄ±r' };
      }
      if (maxAmount !== null && maxAmount !== undefined && parseFloat(maxAmount) < 0) {
        return { valid: false, error: 'Maksimum tutar negatif olamaz' };
      }
      return { valid: true };
    }
    // Make globally accessible for saveApprovalPolicy
    window.validateApprovalLimit = validateApprovalLimit;
    
    // Teklifbul Rule v1.0 - Role Priority for Sorting Approval Limits
    // SÄ±ralama: 1) Ä°ÅŸveren, 2) YÃ¶netim Kurulu BaÅŸkanÄ± (1 ve 2 eÅŸit), 3) YKB Ãœyesi, 4) CEO, 5) Genel MÃ¼dÃ¼r, 6) GM YardÄ±mcÄ±sÄ±, sonrasÄ± dinamik
    const ROLE_PRIORITY = {
      'buyer:isveren': 1,
      'supplier:isveren': 1,
      'buyer:yonetim_kurulu_baskani': 2,
      'supplier:yonetim_kurulu_baskani': 2,
      'buyer:yonetim_kurulu_uyesi': 3,
      'supplier:yonetim_kurulu_uyesi': 3,
      'buyer:ceo': 4,
      'supplier:ceo': 4,
      'buyer:genel_mudur': 5,
      'supplier:genel_mudur': 5,
      'buyer:genel_mudur_yardimcisi': 6,
      'supplier:genel_mudur_yardimcisi': 6
      // SonrasÄ± dinamik (alÄ±cÄ±/tedarikÃ§i rolleri) - 7'den baÅŸlar
    };
    // Make globally accessible for saveApprovalPolicy
    window.ROLE_PRIORITY = ROLE_PRIORITY;
    
    // Teklifbul Rule v1.0 - Safe Firestore Operation Wrapper
    async function safeFirestoreOperation(operation, errorMessage) {
      try {
        return await operation();
      } catch (error) {
        logger.error('Firestore operation failed', error);
        const toastFn = window.showToastNotification || showToastNotification;
        if (toastFn && typeof toastFn === 'function') {
          toastFn(errorMessage || 'Bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.', 'error');
        }
        throw error;
      }
    }
    
    // Teklifbul Rule v1.0 - Global scope'a ekle (saveApprovalPolicy'dan eriÅŸilebilir olmasÄ± iÃ§in)
    window.safeFirestoreOperation = safeFirestoreOperation;
    
    // Teklifbul Rule v1.0 - Approval Limit Button Setup (Using safeBindEventListener)
    // Global scope'a ekle (loadAndSetupApprovalPolicyManagement'dan eriÅŸilebilir olmasÄ± iÃ§in)
    window.setupApprovalLimitButton = function setupApprovalLimitButton() {
      // Element sadece "Teklif Onay AyarlarÄ±" sayfasÄ±nda var, kontrol et
      const btnElement = document.getElementById('btnAddApprovalLimit');
      if (!btnElement) {
        // Element yoksa, sayfa henÃ¼z yÃ¼klenmemiÅŸ veya farklÄ± sayfada
        return;
      }
      
      // Use safeBindEventListener helper to prevent duplicate listeners
      const newBtn = safeBindEventListener('btnAddApprovalLimit', 'click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        logger.info('Yeni limit ekle butonu tÄ±klandÄ±');
        if (typeof window.addApprovalLimitRow === 'function') {
          window.addApprovalLimitRow();
        }
      });
      
      if (newBtn) {
        logger.info('btnAddApprovalLimit event listener baÄŸlandÄ±');
      }
    }
    
    // Teklifbul Rule v1.0 - Mevcut kullanÄ±lmÄ±ÅŸ rolleri bul (helper fonksiyon)
    // Global scope'a ekle (addApprovalLimitRow'dan eriÅŸilebilir olmasÄ± iÃ§in)
    window.getUsedRoles = function getUsedRoles(excludeSelect = null) {
      const container = document.getElementById('approvalLimitsList');
      if (!container) return new Set();
      
      const usedRoles = new Set();
      const allSelects = container.querySelectorAll('select');
      
      allSelects.forEach(select => {
        // excludeSelect hariÃ§ diÄŸer select'lerden kullanÄ±lmÄ±ÅŸ rolleri topla
        if (select !== excludeSelect && select.value && select.value.trim() !== '') {
          usedRoles.add(select.value);
        }
      });
      
      return usedRoles;
    };
    
    // Teklifbul Rule v1.0 - TÃ¼m role select'lerini gÃ¼ncelle (kullanÄ±lmÄ±ÅŸ rolleri disabled yap)
    // Global scope'a ekle (addApprovalLimitRow ve removeBtn'dan eriÅŸilebilir olmasÄ± iÃ§in)
    window.updateRoleSelects = function updateRoleSelects() {
      const container = document.getElementById('approvalLimitsList');
      if (!container) return;
      
      const allSelects = container.querySelectorAll('select');
      const allUsedRoles = window.getUsedRoles();
      
      allSelects.forEach(select => {
        const currentValue = select.value;
        const options = select.querySelectorAll('option');
        
        options.forEach(option => {
          const optionValue = option.value;
          if (optionValue === '') {
            // "SeÃ§iniz..." seÃ§eneÄŸi her zaman enabled
            option.disabled = false;
          } else if (allUsedRoles.has(optionValue)) {
            // KullanÄ±lmÄ±ÅŸ rol, ama bu select'in mevcut seÃ§imi ise enabled kalmalÄ±
            option.disabled = (optionValue !== currentValue);
            // Orijinal label'Ä± kullan (getRoleLabel fonksiyonundan)
            const getRoleLabelFn = window.getRoleLabel || function(r) { return r; };
            const originalLabel = getRoleLabelFn(optionValue);
            if (option.disabled) {
              option.textContent = originalLabel + ' (Zaten kullanÄ±lÄ±yor)';
            } else {
              option.textContent = originalLabel;
            }
          } else {
            // KullanÄ±lmamÄ±ÅŸ rol
            option.disabled = false;
            // Orijinal label'Ä± kullan (getRoleLabel fonksiyonundan)
            const getRoleLabelFn = window.getRoleLabel || function(r) { return r; };
            const originalLabel = getRoleLabelFn(optionValue);
            option.textContent = originalLabel;
          }
        });
      });
    };
    
    // Teklifbul Rule v1.0 - Åirket kullanÄ±cÄ± rollerini al (dinamik rol listesi iÃ§in)
    // Global scope'a ekle (addApprovalLimitRow'dan eriÅŸilebilir olmasÄ± iÃ§in)
    window.getCompanyUserRoles = async function getCompanyUserRoles(companyId) {
      try {
        const db = window.__db;
        if (!db || !companyId) return { buyerRoles: [], supplierRoles: [], hasBuyer: false, hasSupplier: false };
        
        const getFirestoreModulesFn = window.getFirestoreModules || getFirestoreModules;
        const { collection, query, where, getDocs, doc, getDoc } = await getFirestoreModulesFn();
        
        // Åirket bilgilerini al
        const companyDoc = await getDoc(doc(db, 'companies', companyId));
        if (!companyDoc.exists()) return { buyerRoles: [], supplierRoles: [], hasBuyer: false, hasSupplier: false };
        
        const companyData = companyDoc.data();
        const companyRolesArray = companyData.roles || [];
        const hasBuyer = companyRolesArray.includes('buyer') || companyRolesArray.includes('both');
        const hasSupplier = companyRolesArray.includes('supplier') || companyRolesArray.includes('both');
        
        // Åirket kullanÄ±cÄ±larÄ±nÄ± al
        const usersQuery = query(
          collection(db, 'users'),
          where('companyId', '==', companyId)
        );
        const usersSnapshot = await getDocs(usersQuery);
        
        // Teklifbul Rule v1.0 - KullanÄ±cÄ± rollerini topla (geniÅŸletilmiÅŸ kapsam)
        const buyerRolesSet = new Set();
        const supplierRolesSet = new Set();
        
        // Åirket belgesindeki buyerRoles ve supplierRoles array'lerini de kontrol et
        const companyBuyerRoles = companyData.buyerRoles || [];
        const companySupplierRoles = companyData.supplierRoles || [];
        
        // Åirket belgesindeki rolleri ekle
        if (hasBuyer && Array.isArray(companyBuyerRoles)) {
          companyBuyerRoles.forEach(role => {
            if (typeof role === 'string' && role.startsWith('buyer:')) {
              buyerRolesSet.add(role);
            } else if (typeof role === 'object' && role.value && role.value.startsWith('buyer:')) {
              buyerRolesSet.add(role.value);
            }
          });
        }
        
        if (hasSupplier && Array.isArray(companySupplierRoles)) {
          companySupplierRoles.forEach(role => {
            if (typeof role === 'string' && role.startsWith('supplier:')) {
              supplierRolesSet.add(role);
            } else if (typeof role === 'object' && role.value && role.value.startsWith('supplier:')) {
              supplierRolesSet.add(role.value);
            }
          });
        }
        
        // KullanÄ±cÄ± rollerini topla
        usersSnapshot.docs.forEach(userDoc => {
          const userData = userDoc.data();
          const userRoles = userData.roles || [];
          // Teklifbul Rule v1.0 - GeniÅŸletilmiÅŸ rol toplama: companyRole, requestedCompanyRole, companyRoleKey
          const companyRole = userData.companyRole || userData.requestedCompanyRole || userData.companyRoleKey || '';
          
          // Buyer rolleri
          if (hasBuyer && (userRoles.includes('buyer') || userRoles.includes('both') || companyRole.startsWith('buyer:'))) {
            if (companyRole && companyRole.startsWith('buyer:')) {
              buyerRolesSet.add(companyRole);
            }
          }
          
          // Supplier rolleri
          if (hasSupplier && (userRoles.includes('supplier') || userRoles.includes('both') || companyRole.startsWith('supplier:'))) {
            if (companyRole && companyRole.startsWith('supplier:')) {
              supplierRolesSet.add(companyRole);
            }
          }
        });
        
        // Teklifbul Rule v1.0 - VarsayÄ±lan roller (eÄŸer kullanÄ±cÄ± rolleri yoksa)
        // TÃ¼m sistemde tanÄ±mlÄ± buyer rolleri
        const defaultBuyerRoles = [
          'buyer:satinalma_uzman_yardimcisi',
          'buyer:satinalma_uzmani',
          'buyer:satinalma_yetkilisi',
          'buyer:satinalma_muduru',
          'buyer:santiye_yetkilisi',
          'buyer:stok_depo',
          'buyer:muhasebe',
          'buyer:alici',
          'buyer:proje_yoneticisi'
        ];
        // TÃ¼m sistemde tanÄ±mlÄ± supplier rolleri
        const defaultSupplierRoles = [
          'supplier:satici',
          'supplier:satis_muduru',
          'supplier:satis_yoneticisi',
          'supplier:pazarlama_muduru',
          'supplier:satis_personeli',
          'supplier:sirket_sahibi'
        ];
        
        // EÄŸer kullanÄ±cÄ± rolleri yoksa varsayÄ±lanlarÄ± kullan
        if (buyerRolesSet.size === 0 && hasBuyer) {
          defaultBuyerRoles.forEach(role => buyerRolesSet.add(role));
        }
        if (supplierRolesSet.size === 0 && hasSupplier) {
          defaultSupplierRoles.forEach(role => supplierRolesSet.add(role));
        }
        
        return {
          buyerRoles: Array.from(buyerRolesSet),
          supplierRoles: Array.from(supplierRolesSet),
          hasBuyer,
          hasSupplier
        };
      } catch (error) {
        logger.error('getCompanyUserRoles hatasÄ±', error);
        return { buyerRoles: [], supplierRoles: [], hasBuyer: false, hasSupplier: false };
      }
    };
    
    // Teklifbul Rule v1.0 - Rol label'Ä±nÄ± al (helper fonksiyon)
    // TÃ¼m sistemde tanÄ±mlÄ± rolleri iÃ§erir
    window.getRoleLabel = function getRoleLabel(roleValue) {
      const roleLabels = {
        // YÃ¶netim Rolleri (Buyer)
        'buyer:isveren': 'Ä°ÅŸveren (Åirket Sahibi)',
        'buyer:yonetim_kurulu_baskani': 'YÃ¶netim Kurulu BaÅŸkanÄ±',
        'buyer:yonetim_kurulu_uyesi': 'YÃ¶netim Kurulu Ãœyesi',
        'buyer:ceo': 'CEO',
        'buyer:genel_mudur': 'Genel MÃ¼dÃ¼r',
        'buyer:genel_mudur_yardimcisi': 'Genel MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±',
        // Buyer Ã–zel Rolleri
        'buyer:satinalma_muduru': 'SatÄ±n Alma MÃ¼dÃ¼rÃ¼',
        'buyer:satinalma_yetkilisi': 'SatÄ±n Alma Yetkilisi',
        'buyer:satinalma_uzmani': 'SatÄ±n Alma UzmanÄ±',
        'buyer:satinalma_uzman_yardimcisi': 'SatÄ±n Alma Uzman YardÄ±mcÄ±sÄ±',
        'buyer:santiye_yetkilisi': 'Åantiye Yetkilisi',
        'buyer:stok_depo': 'Stok / Depo Yetkilisi',
        'buyer:muhasebe': 'Muhasebe',
        'buyer:alici': 'AlÄ±cÄ±',
        'buyer:proje_yoneticisi': 'Proje YÃ¶neticisi',
        // YÃ¶netim Rolleri (Supplier)
        'supplier:isveren': 'Ä°ÅŸveren (Åirket Sahibi)',
        'supplier:yonetim_kurulu_baskani': 'YÃ¶netim Kurulu BaÅŸkanÄ±',
        'supplier:yonetim_kurulu_uyesi': 'YÃ¶netim Kurulu Ãœyesi',
        'supplier:ceo': 'CEO',
        'supplier:genel_mudur': 'Genel MÃ¼dÃ¼r',
        'supplier:genel_mudur_yardimcisi': 'Genel MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±',
        // Supplier Ã–zel Rolleri
        'supplier:satici': 'SatÄ±cÄ±',
        'supplier:satis_muduru': 'SatÄ±ÅŸ MÃ¼dÃ¼rÃ¼',
        'supplier:satis_yoneticisi': 'SatÄ±ÅŸ YÃ¶neticisi',
        'supplier:pazarlama_muduru': 'Pazarlama MÃ¼dÃ¼rÃ¼',
        'supplier:satis_personeli': 'SatÄ±ÅŸ Personeli',
        'supplier:sirket_sahibi': 'Åirket Sahibi'
      };
      return roleLabels[roleValue] || roleValue;
    };
    
    // Approval limit satÄ±rÄ± ekle (global fonksiyon)
    // Global scope'a ekle (setupApprovalLimitButton'dan eriÅŸilebilir olmasÄ± iÃ§in)
    window.addApprovalLimitRow = async function addApprovalLimitRow(limitData = null) {
      const container = document.getElementById('approvalLimitsList');
      if (!container) {
        logger.error('approvalLimitsList container bulunamadÄ±');
        return;
      }
      
      logger.info('Yeni approval limit satÄ±rÄ± ekleniyor', limitData);
      
      const row = document.createElement('div');
      row.style.cssText = 'padding:12px; background:white; border-radius:6px; border:1px solid #e5e7eb;';
      
      // Teklifbul Rule v1.0 - Dinamik rol listesi: Åirket kullanÄ±cÄ± rollerini al
      const db = window.__db;
      const companyId = window.__currentCompanyId || null;
      
      // Sabit yÃ¶netim rolleri (her zaman gÃ¶sterilir)
      const fixedManagementRoles = [
        { value: 'buyer:isveren', label: 'Ä°ÅŸveren (Åirket Sahibi)' },
        { value: 'buyer:yonetim_kurulu_baskani', label: 'YÃ¶netim Kurulu BaÅŸkanÄ±' },
        { value: 'buyer:yonetim_kurulu_uyesi', label: 'YÃ¶netim Kurulu Ãœyesi' },
        { value: 'buyer:ceo', label: 'CEO' },
        { value: 'buyer:genel_mudur', label: 'Genel MÃ¼dÃ¼r' },
        { value: 'buyer:genel_mudur_yardimcisi', label: 'Genel MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±' }
      ];
      
      let allRoles = [...fixedManagementRoles];
      
      // Åirket kullanÄ±cÄ± rollerini al
      if (db && companyId && typeof window.getCompanyUserRoles === 'function') {
        try {
          const companyRoles = await window.getCompanyUserRoles(companyId);
          
          // Buyer rolleri ekle
          if (companyRoles.hasBuyer) {
            companyRoles.buyerRoles.forEach(role => {
              if (!allRoles.find(r => r.value === role)) {
                allRoles.push({ value: role, label: window.getRoleLabel(role) || role });
              }
            });
          }
          
          // Supplier rolleri ekle (hem alÄ±cÄ± hem tedarikÃ§i ise)
          if (companyRoles.hasSupplier && companyRoles.hasBuyer) {
            companyRoles.supplierRoles.forEach(role => {
              if (!allRoles.find(r => r.value === role)) {
                allRoles.push({ value: role, label: window.getRoleLabel(role) || role });
              }
            });
          } else if (companyRoles.hasSupplier && !companyRoles.hasBuyer) {
            // Sadece tedarikÃ§i ise sadece tedarikÃ§i rolleri
            companyRoles.supplierRoles.forEach(role => {
              if (!allRoles.find(r => r.value === role)) {
                allRoles.push({ value: role, label: window.getRoleLabel(role) || role });
              }
            });
          }
        } catch (error) {
          logger.warn('Åirket kullanÄ±cÄ± rolleri alÄ±nÄ±rken hata', error);
        }
      }
      
      // Mevcut kullanÄ±lmÄ±ÅŸ rolleri al (yeni select hariÃ§)
      const usedRoles = window.getUsedRoles();
      
      const roleSelect = document.createElement('select');
      roleSelect.className = 'approval-limit-role-select'; // Class ekle (event listener iÃ§in)
      roleSelect.style.cssText = 'width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;';
      roleSelect.innerHTML = '<option value="">SeÃ§iniz...</option>';
      
      // Teklifbul Rule v1.0 - Dinamik rol listesini kullan
      allRoles.forEach(role => {
        const option = document.createElement('option');
        option.value = role.value;
        option.textContent = role.label;
        
        // EÄŸer bu rol zaten kullanÄ±lmÄ±ÅŸsa ve limitData ile gelen rol deÄŸilse disabled yap
        if (usedRoles.has(role.value) && (!limitData || limitData.role !== role.value)) {
          option.disabled = true;
          option.textContent = role.label + ' (Zaten kullanÄ±lÄ±yor)';
        }
        
        if (limitData && limitData.role === role.value) {
          option.selected = true;
        }
        
        roleSelect.appendChild(option);
      });
      
      row.innerHTML = `
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:12px; align-items:end;">
          <div>
            <label style="font-size:12px; color:#6b7280; margin-bottom:4px; display:block;">Maksimum Tutar (â‚º)</label>
            <input type="number" class="approval-limit-amount" placeholder="Ã–rn: 10000" value="${limitData?.maxAmount || ''}" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
          </div>
          <div>
            <label style="font-size:12px; color:#6b7280; margin-bottom:4px; display:block;">Onay RolÃ¼</label>
          </div>
          <div>
            <label style="font-size:12px; color:#6b7280; margin-bottom:4px; display:block;">AÃ§Ä±klama</label>
            <input type="text" class="approval-limit-description" placeholder="Ã–rn: 10.000â‚º'ye kadar" value="${limitData?.description || ''}" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
          </div>
          <button type="button" class="btn-remove-limit btn btn-danger" style="padding:8px 12px; font-size:13px;">Sil</button>
        </div>
      `;
      
      // Role select'i ikinci div'e ekle
      const roleDiv = row.querySelector('div:nth-child(2)');
      roleDiv.appendChild(roleSelect);
      
      // Teklifbul Rule v1.0 - Rol seÃ§ildiÄŸinde kontrol et
      roleSelect.addEventListener('change', function() {
        const selectedRole = this.value;
        if (!selectedRole || selectedRole === '') return;
        
        // Mevcut kullanÄ±lmÄ±ÅŸ rolleri kontrol et (bu select hariÃ§)
        const usedRoles = window.getUsedRoles(this);
        
        if (usedRoles.has(selectedRole)) {
          // Bu rol zaten kullanÄ±lÄ±yor, uyarÄ± ver ve seÃ§imi geri al
          const toastFn = window.showToastNotification || showToastNotification;
          if (toastFn && typeof toastFn === 'function') {
            toastFn(`âŒ "${selectedRole}" rolÃ¼ iÃ§in zaten bir limit tanÄ±mlanmÄ±ÅŸ. Her rol iÃ§in sadece 1 limit belirlenebilir.`, 'error');
          }
          // SeÃ§imi geri al
          this.value = '';
          return;
        }
        
        // Rol seÃ§ildi, diÄŸer select'leri gÃ¼ncelle
        window.updateRoleSelects();
      });
      
      // Sil butonuna event listener ekle
      const removeBtn = row.querySelector('.btn-remove-limit');
      removeBtn.onclick = () => {
        row.remove();
        // SatÄ±r silindi, tÃ¼m select'leri gÃ¼ncelle
        window.updateRoleSelects();
      };
      
      container.appendChild(row);
      logger.info('Approval limit satÄ±rÄ± eklendi', { toplamSatir: container.children.length });
      
      // Yeni satÄ±r eklendi, tÃ¼m select'leri gÃ¼ncelle
      window.updateRoleSelects();
    }
    
    // Teklifbul Rule v1.0 - Alt Sayfa Navigasyonu
    function initSettingsNavigation() {
      const navButtons = document.querySelectorAll('.settings-nav-btn');
      const pages = document.querySelectorAll('.settings-page');
      
      // Ä°lk yÃ¼klemede tÃ¼m sayfalarÄ± gizle (sadece active olanÄ± gÃ¶ster)
      pages.forEach(p => {
        if (!p.classList.contains('active')) {
          p.style.display = 'none';
        }
      });
      
      navButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const targetPage = btn.getAttribute('data-page');
          
          // TÃ¼m butonlarÄ± pasif yap
          navButtons.forEach(b => {
            b.classList.remove('active');
            b.style.color = '#6b7280';
            b.style.background = 'none';
            b.style.borderLeft = 'none';
          });
          
          // Aktif butonu aktif yap
          btn.classList.add('active');
          btn.style.color = '#1e40af';
          btn.style.background = '#eff6ff';
          btn.style.borderLeft = '3px solid #3b82f6';
          
          // TÃ¼m sayfalarÄ± gizle
          pages.forEach(p => {
            p.classList.remove('active');
            p.style.display = 'none';
          });
          
          // Hedef sayfayÄ± gÃ¶ster
          const targetPageEl = document.getElementById(`page-${targetPage}`);
          if (targetPageEl) {
            targetPageEl.classList.add('active');
            targetPageEl.style.display = 'block';
            
            // Approval settings sayfasÄ± gÃ¶sterildiÄŸinde verileri yÃ¼kle
            if (targetPage === 'approval-settings') {
              // Teklifbul Rule v1.0 - Fonksiyonun tanÄ±mlanmasÄ±nÄ± bekle (retry mekanizmasÄ±)
              const loadApprovalSettings = async (retryCount = 0, maxRetries = 10) => {
                try {
                  const auth = window.__auth;
                  const db = window.__db;
                  
                  if (!auth || !db) {
                    logger.error('Auth veya DB bulunamadÄ±');
                    return;
                  }
                  
                  const { getDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
                  
                  if (auth?.currentUser) {
                    const userDoc = await getDoc(doc(db, 'users', auth.currentUser.uid));
                    const userData = userDoc.exists() ? userDoc.data() : {};
                    const myCompanyId = userData.companyId || userData.companies?.[0];
                    
                    // Fonksiyon tanÄ±mlÄ± mÄ± kontrol et
                    if (myCompanyId && typeof window.loadAndSetupApprovalPolicyManagement === 'function') {
                      await window.loadAndSetupApprovalPolicyManagement(myCompanyId, userData);
                      if (typeof window.setupApprovalLimitButton === 'function') {
                        window.setupApprovalLimitButton();
                      }
                    } else if (retryCount < maxRetries) {
                      // HenÃ¼z tanÄ±mlÄ± deÄŸilse, biraz bekleyip tekrar dene
                      setTimeout(() => {
                        loadApprovalSettings(retryCount + 1, maxRetries);
                      }, 300);
                    } else {
                      logger.error('loadAndSetupApprovalPolicyManagement fonksiyonu yÃ¼klenemedi (maksimum deneme sayÄ±sÄ±na ulaÅŸÄ±ldÄ±)');
                    }
                  }
                } catch (e) {
                  logger.error('Approval settings yÃ¼klenirken hata', e);
                }
              };
              
              // Ä°lk Ã§aÄŸrÄ±yÄ± yap (DOM hazÄ±r olmasÄ± iÃ§in kÄ±sa bir gecikme)
              setTimeout(() => {
                loadApprovalSettings();
              }, 100);
            }
            
            // Sayfa Ã¶zel yÃ¼kleme fonksiyonlarÄ±nÄ± Ã§aÄŸÄ±r
            if (targetPage === 'company-users') {
              loadCompanyUsersPage();
            } else if (targetPage === 'approval-settings') {
              // Approval settings yÃ¼kleme yukarÄ±da yapÄ±ldÄ±
            } else if (targetPage === 'company-profile') {
              loadCompanyProfilePage();
            } else if (targetPage === 'premium') {
              loadPremiumPage();
            } else if (targetPage === 'addresses') {
              loadAddressesPage();
            }
          }
        });
      });
    }
    
    // Åirket KullanÄ±cÄ±larÄ± SayfasÄ± YÃ¼kleme
    async function loadCompanyUsersPage() {
      try {
        const user = await getCurrentUser();
        const { doc, getDoc } = await getFirestoreModules();
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (!userDoc.exists()) return;
        
        const userData = userDoc.data();
        const companyId = userData.companyId || (userData.companies && userData.companies[0]);
        if (!companyId) return;
        
        // Teklifbul Rule v1.0 - Tab event listener'larÄ±nÄ± baÄŸla
        const tabActiveUsers = document.getElementById('tabActiveUsers');
        const tabPendingRequests = document.getElementById('tabPendingRequests');
        const activeUsersTab = document.getElementById('activeUsersTab');
        const pendingRequestsTab = document.getElementById('pendingRequestsTab');
        
        // Ã–nceki event listener'larÄ± temizle (duplicate Ã¶nlemek iÃ§in)
        if (tabActiveUsers) {
          const newTabActiveUsers = tabActiveUsers.cloneNode(true);
          tabActiveUsers.parentNode.replaceChild(newTabActiveUsers, tabActiveUsers);
        }
        if (tabPendingRequests) {
          const newTabPendingRequests = tabPendingRequests.cloneNode(true);
          tabPendingRequests.parentNode.replaceChild(newTabPendingRequests, tabPendingRequests);
        }
        
        // Yeni elementleri al
        const newTabActiveUsers = document.getElementById('tabActiveUsers');
        const newTabPendingRequests = document.getElementById('tabPendingRequests');
        
        // Tab click handlers
        newTabActiveUsers?.addEventListener('click', () => {
          newTabActiveUsers.classList.add('active');
          newTabActiveUsers.style.color = '#1f2937';
          newTabActiveUsers.style.borderBottomColor = '#3b82f6';
          newTabPendingRequests?.classList.remove('active');
          newTabPendingRequests.style.color = '#6b7280';
          newTabPendingRequests.style.borderBottomColor = 'transparent';
          if (activeUsersTab) activeUsersTab.style.display = 'block';
          if (pendingRequestsTab) pendingRequestsTab.style.display = 'none';
        });
        
        newTabPendingRequests?.addEventListener('click', () => {
          newTabPendingRequests.classList.add('active');
          newTabPendingRequests.style.color = '#1f2937';
          newTabPendingRequests.style.borderBottomColor = '#3b82f6';
          newTabActiveUsers?.classList.remove('active');
          newTabActiveUsers.style.color = '#6b7280';
          newTabActiveUsers.style.borderBottomColor = 'transparent';
          if (activeUsersTab) activeUsersTab.style.display = 'none';
          if (pendingRequestsTab) pendingRequestsTab.style.display = 'block';
        });
        
        // Ä°lk tab'Ä± aktif et
        if (newTabActiveUsers) {
          newTabActiveUsers.classList.add('active');
          newTabActiveUsers.style.color = '#1f2937';
          newTabActiveUsers.style.borderBottomColor = '#3b82f6';
        }
        if (newTabPendingRequests) {
          newTabPendingRequests.classList.remove('active');
          newTabPendingRequests.style.color = '#6b7280';
          newTabPendingRequests.style.borderBottomColor = 'transparent';
        }
        if (activeUsersTab) activeUsersTab.style.display = 'block';
        if (pendingRequestsTab) pendingRequestsTab.style.display = 'none';
        
        // Mevcut loadActiveCompanyUsers ve loadCompanyJoinRequests fonksiyonlarÄ± Ã§aÄŸrÄ±lacak
        // Bu fonksiyonlar sayfanÄ±n sonunda tanÄ±mlanacak
        // Ã–nce fonksiyonlarÄ±n tanÄ±mlÄ± olup olmadÄ±ÄŸÄ±nÄ± kontrol et
        if (window.loadActiveCompanyUsers) {
          await window.loadActiveCompanyUsers(companyId);
        } else if (typeof loadActiveCompanyUsers === 'function') {
          await loadActiveCompanyUsers(companyId);
        }
        
        // Bekleyen istekleri yÃ¼kle (ÅŸirket kodu gerekli)
        try {
          const companyDoc = await getDoc(doc(db, 'companies', companyId));
          if (companyDoc.exists()) {
            const companyData = companyDoc.data();
            const companyCode = companyData.code;
            if (companyCode) {
        if (window.loadCompanyJoinRequests) {
                await window.loadCompanyJoinRequests(companyCode, companyId);
        } else if (typeof loadCompanyJoinRequests === 'function') {
                await loadCompanyJoinRequests(companyCode, companyId);
              }
            }
          }
        } catch (e) {
          logger.warn('Bekleyen istekler yÃ¼klenirken hata', e);
        }
      } catch (e) {
        logger.error('Åirket kullanÄ±cÄ±larÄ± sayfasÄ± yÃ¼kleme hatasÄ±', e);
      }
    }
    
    // Teklif Onay AyarlarÄ± SayfasÄ± YÃ¼kleme
    async function loadApprovalSettingsPage() {
      // Mevcut approval policy yÃ¼kleme fonksiyonlarÄ± Ã§aÄŸrÄ±lacak
      // Bu fonksiyonlar zaten mevcut kodda var
    }
    // Premium Hesap SayfasÄ± YÃ¼kleme
    async function loadPremiumPage() {
      try {
        const user = await getCurrentUser();
        const { doc, getDoc, updateDoc, serverTimestamp } = await getFirestoreModules();
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (!userDoc.exists()) return;
        
        const userData = userDoc.data();
        
        // Premium durumunu yÃ¼kle
        const isPremium = userData.isPremium === true;
        const premiumCheckbox = document.getElementById('isPremium');
        if (premiumCheckbox) {
          premiumCheckbox.checked = isPremium;
          premiumCheckbox.addEventListener('change', async (e) => {
            try {
              await updateDoc(doc(db, 'users', user.uid), {
                isPremium: e.target.checked,
                updatedAt: serverTimestamp()
              });
              toast.success(MESSAGES.SUCCESS_PREMIUM_UPDATED);
            } catch (err) {
              logger.error('Premium durum gÃ¼ncelleme hatasÄ±', err);
              toast.error(MESSAGES.ERROR_UPDATE + ': ' + err.message);
              e.target.checked = !e.target.checked; // Revert
            }
          });
        }
        
        const statusText = document.getElementById('premiumStatusText');
        if (statusText) {
          statusText.textContent = isPremium ? 'Aktif' : 'Pasif';
        }
        
        await loadPaymentHistory(user.uid);
        await loadSubscriptionInfo(user.uid);
        await loadCompaniesForPaymentRequest(user.uid);
        await loadApprovedBidsForPaymentRequest(user.uid);
      } catch (e) {
        logger.error('Premium sayfasÄ± yÃ¼kleme hatasÄ±', e);
      }
    }
    // Ã–deme GeÃ§miÅŸini YÃ¼kle
    async function loadPaymentHistory(userId) {
      try {
        const historyContainer = document.getElementById('paymentHistoryList');
        if (!historyContainer) return;
        
        // Filtre deÄŸerlerini al
        const startDate = document.getElementById('paymentFilter_startDate')?.value || '';
        const endDate = document.getElementById('paymentFilter_endDate')?.value || '';
        const status = document.getElementById('paymentFilter_status')?.value || '';
        const minAmount = parseFloat(document.getElementById('paymentFilter_minAmount')?.value || 0);
        const maxAmount = parseFloat(document.getElementById('paymentFilter_maxAmount')?.value || 999999);
        
        // Firestore'dan Ã¶deme geÃ§miÅŸini Ã§ek
        const { collection, query, where, orderBy, getDocs } = await getFirestoreModules();
        const paymentRequestsRef = collection(db, 'paymentRequests');
        let paymentQuery = query(
          paymentRequestsRef,
          where('requesterUserId', '==', userId),
          orderBy('createdAt', 'desc')
        );
        
        const paymentSnapshot = await getDocs(paymentQuery);
        let payments = paymentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Filtreleri uygula
        if (startDate) {
          payments = payments.filter(p => {
            const createdAt = p.createdAt?.toDate();
            return createdAt && createdAt >= new Date(startDate);
          });
        }
        
        if (endDate) {
          payments = payments.filter(p => {
            const createdAt = p.createdAt?.toDate();
            return createdAt && createdAt <= new Date(endDate + 'T23:59:59');
          });
        }
        
        if (status) {
          payments = payments.filter(p => p.status === status);
        }
        
        payments = payments.filter(p => {
          const amount = parseFloat(p.amount || 0);
          return amount >= minAmount && amount <= maxAmount;
        });
        
        // UI'Ä± gÃ¼ncelle
        if (payments.length === 0) {
          historyContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#6b7280;"><p>Ã–deme geÃ§miÅŸi bulunmamaktadÄ±r.</p></div>';
          return;
        }
        
        historyContainer.innerHTML = payments.map(payment => {
          const statusColors = {
            'pending': '#f59e0b',
            'paid': '#10b981',
            'cancelled': '#ef4444',
            'overdue': '#dc2626'
          };
          const statusLabels = {
            'pending': 'Beklemede',
            'paid': 'Ã–dendi',
            'cancelled': 'Ä°ptal',
            'overdue': 'GecikmiÅŸ'
          };
          
          const createdAt = payment.createdAt?.toDate();
          const dueDate = payment.dueDate ? new Date(payment.dueDate) : null;
          
          return `
            <div style="padding:16px; background:white; border-radius:8px; border:1px solid #e5e7eb;">
              <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                <div>
                  <div style="font-weight:600; color:#1f2937; margin-bottom:4px;">${payment.companyName || 'Firma Bilgisi Yok'}</div>
                  <div style="font-size:13px; color:#6b7280; margin-bottom:4px;">Tutar: <strong>â‚º${parseFloat(payment.amount || 0).toFixed(2)}</strong></div>
                  ${payment.description ? `<div style="font-size:12px; color:#6b7280; margin-top:4px;">${payment.description}</div>` : ''}
                </div>
                <div style="text-align:right;">
                  <span style="padding:4px 12px; background:${statusColors[payment.status] || '#6b7280'}; color:white; border-radius:12px; font-size:11px; font-weight:600;">
                    ${statusLabels[payment.status] || payment.status}
                  </span>
                </div>
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px; padding-top:8px; border-top:1px solid #e5e7eb; font-size:12px; color:#6b7280;">
                <span>OluÅŸturulma: ${createdAt ? createdAt.toLocaleDateString('tr-TR') : '-'}</span>
                ${dueDate ? `<span>Termin: ${dueDate.toLocaleDateString('tr-TR')}</span>` : ''}
              </div>
            </div>
          `;
        }).join('');
        
        // Filtre butonlarÄ±
        const applyFilterBtn = document.getElementById('btnApplyPaymentFilter');
        const resetFilterBtn = document.getElementById('btnResetPaymentFilter');
        const downloadBtn = document.getElementById('btnDownloadPaymentHistory');
        
        if (applyFilterBtn) {
          applyFilterBtn.addEventListener('click', () => loadPaymentHistory(userId));
        }
        
        if (resetFilterBtn) {
          resetFilterBtn.addEventListener('click', () => {
            document.getElementById('paymentFilter_startDate').value = '';
            document.getElementById('paymentFilter_endDate').value = '';
            document.getElementById('paymentFilter_status').value = '';
            document.getElementById('paymentFilter_minAmount').value = '';
            document.getElementById('paymentFilter_maxAmount').value = '';
            loadPaymentHistory(userId);
          });
        }
        
        if (downloadBtn) {
          downloadBtn.addEventListener('click', () => {
            // PDF indirme fonksiyonu (gelecekte jsPDF ile implement edilecek)
            toast.info(MESSAGES.INFO_PDF_DOWNLOAD_SOON);
          });
        }
      } catch (e) {
        logger.error('Ã–deme geÃ§miÅŸi yÃ¼kleme hatasÄ±', e);
        const historyContainer = document.getElementById('paymentHistoryList');
        if (historyContainer) {
          historyContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#dc2626;"><p>YÃ¼kleme sÄ±rasÄ±nda bir hata oluÅŸtu.</p></div>';
        }
      }
    }
    
    // Abonelik Bilgilerini YÃ¼kle
    async function loadSubscriptionInfo(userId) {
      try {
        const { doc, getDoc } = await getFirestoreModules();
        const userDoc = await getDoc(doc(db, 'users', userId));
        if (!userDoc.exists()) return;
        
        const userData = userDoc.data();
        
        // Abonelik bilgilerini gÃ¶ster (gelecekte eklenecek)
        // Åimdilik placeholder
        const subscriptionStartDate = document.getElementById('subscriptionStartDate');
        const subscriptionEndDate = document.getElementById('subscriptionEndDate');
        const nextPaymentDate = document.getElementById('nextPaymentDate');
        const monthlyFee = document.getElementById('monthlyFee');
        
        if (subscriptionStartDate) subscriptionStartDate.textContent = '-';
        if (subscriptionEndDate) subscriptionEndDate.textContent = '-';
        if (nextPaymentDate) nextPaymentDate.textContent = '-';
        if (monthlyFee) monthlyFee.textContent = '-';
      } catch (e) {
        logger.error('Abonelik bilgileri yÃ¼kleme hatasÄ±', e);
      }
    }
    
    // Ã–deme Talep Formu iÃ§in FirmalarÄ± YÃ¼kle
    async function loadCompaniesForPaymentRequest(userId) {
      try {
        const companySelect = document.getElementById('paymentRequest_companyId');
        if (!companySelect) return;
        
        // BaÅŸarÄ±lÄ± ticaret yapÄ±lan firmalarÄ± yÃ¼kle
        const { doc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp } = await getFirestoreModules();
        const userDoc = await getDoc(doc(db, 'users', userId));
        if (!userDoc.exists()) return;
        
        const userData = userDoc.data();
        const companyId = userData.companyId || (userData.companies && userData.companies[0]);
        if (!companyId) return;
        
        // Bu ÅŸirketin tedarikÃ§i olduÄŸu onaylanmÄ±ÅŸ teklifleri bul
        const bidsRef = collection(db, 'bids');
        const bidsQuery = query(
          bidsRef,
          where('supplierCompanyId', '==', companyId),
          where('status', 'in', ['accepted', 'approved'])
        );
        const bidsSnapshot = await getDocs(bidsQuery);
        
        // Partner ÅŸirketleri topla
        const partnerCompanyIds = new Set();
        for (const bidDoc of bidsSnapshot.docs) {
          const bidData = bidDoc.data();
          if (bidData.demandId) {
            const demandDoc = await getDoc(doc(db, 'demands', bidData.demandId));
            if (demandDoc.exists()) {
              const demandData = demandDoc.data();
              if (demandData.companyId && demandData.companyId !== companyId) {
                partnerCompanyIds.add(demandData.companyId);
              }
            }
          }
        }
        
        // Partner ÅŸirket bilgilerini yÃ¼kle
        companySelect.innerHTML = '<option value="">Firma seÃ§in...</option>';
        for (const partnerCompanyId of partnerCompanyIds) {
          const partnerCompanyDoc = await getDoc(doc(db, 'companies', partnerCompanyId));
          if (partnerCompanyDoc.exists()) {
            const partnerData = partnerCompanyDoc.data();
            const option = document.createElement('option');
            option.value = partnerCompanyId;
            option.textContent = partnerData.companyName || partnerData.name || 'Bilinmeyen Åirket';
            companySelect.appendChild(option);
          }
        }
        
        // Ã–deme talep butonu event listener
        const btnRequestPayment = document.getElementById('btnRequestPayment');
        if (btnRequestPayment) {
          btnRequestPayment.addEventListener('click', async () => {
            const companyId = companySelect.value;
            const amount = parseFloat(document.getElementById('paymentRequest_amount')?.value || 0);
            const dueDate = document.getElementById('paymentRequest_dueDate')?.value;
            const description = document.getElementById('paymentRequest_description')?.value || '';
            
            if (!companyId || !amount || !dueDate) {
              toast.error(MESSAGES.ERROR_REQUIRED_FIELDS);
              return;
            }
            
            try {
              // Åirket bilgisini al
              const companyDoc = await getDoc(doc(db, 'companies', companyId));
              const companyName = companyDoc.exists() ? (companyDoc.data().companyName || companyDoc.data().name) : 'Bilinmeyen Åirket';
              
              // Ã–deme talebi oluÅŸtur
              await addDoc(collection(db, 'paymentRequests'), {
                requesterUserId: userId,
                companyId: companyId,
                companyName: companyName,
                amount: amount,
                dueDate: dueDate,
                description: description,
                status: 'pending',
                createdAt: serverTimestamp()
              });
              
              toast.success(MESSAGES.SUCCESS_PAYMENT_REQUEST_CREATED);
              
              // Formu temizle
              companySelect.value = '';
              document.getElementById('paymentRequest_amount').value = '';
              document.getElementById('paymentRequest_dueDate').value = '';
              document.getElementById('paymentRequest_description').value = '';
              document.getElementById('paymentRequest_approvedBidId').value = '';
              
              // Ã–deme geÃ§miÅŸini yenile
              await loadPaymentHistory(userId);
            } catch (err) {
              logger.error('Ã–deme talebi oluÅŸturma hatasÄ±', err);
              toast.error(MESSAGES.ERROR_PAYMENT_REQUEST_CREATE + ': ' + err.message);
            }
          });
        }
      } catch (e) {
        logger.error('Firmalar yÃ¼kleme hatasÄ±', e);
      }
    }
    // OnaylanmÄ±ÅŸ Tekliflerden Otomatik Doldurma
    async function loadApprovedBidsForPaymentRequest(userId) {
      try {
        const approvedBidSelect = document.getElementById('paymentRequest_approvedBidId');
        if (!approvedBidSelect) return;
        
        const { doc, getDoc, collection, query, where, getDocs } = await getFirestoreModules();
        const userDoc = await getDoc(doc(db, 'users', userId));
        if (!userDoc.exists()) return;
        
        const userData = userDoc.data();
        const companyId = userData.companyId || (userData.companies && userData.companies[0]);
        if (!companyId) return;
        
        // Bu ÅŸirketin tedarikÃ§i olduÄŸu onaylanmÄ±ÅŸ teklifleri bul
        // Teklifbul Rule v1.0 - Index hatasÄ± Ã¶nleme: orderBy kaldÄ±rÄ±ldÄ±, client-side sorting yapÄ±lacak
        const bidsRef = collection(db, 'bids');
        const bidsQuery = query(
          bidsRef,
          where('supplierCompanyId', '==', companyId),
          where('status', 'in', ['accepted', 'approved'])
          // orderBy kaldÄ±rÄ±ldÄ± - client-side sorting yapÄ±lacak
        );
        const bidsSnapshot = await getDocs(bidsQuery);
        
        // Client-side sorting - createdAt'e gÃ¶re sÄ±rala
        const bidsArray = bidsSnapshot.docs.map(doc => ({ 
          id: doc.id, 
          data: doc.data(), 
          createdAt: doc.data().createdAt 
        }));
        bidsArray.sort((a, b) => {
          const aTime = a.createdAt?.toMillis ? a.createdAt.toMillis() : (a.createdAt?.seconds ? a.createdAt.seconds * 1000 : 0);
          const bTime = b.createdAt?.toMillis ? b.createdAt.toMillis() : (b.createdAt?.seconds ? b.createdAt.seconds * 1000 : 0);
          return bTime - aTime; // Descending order
        });
        
        // Ä°lk 50'yi al
        const sortedBids = bidsArray.slice(0, 50);
        
        approvedBidSelect.innerHTML = '<option value="">OnaylanmÄ±ÅŸ teklif seÃ§in (otomatik doldurma iÃ§in)...</option>';
        
        // SÄ±ralanmÄ±ÅŸ bids'leri kullan
        for (const bidItem of sortedBids) {
          const bidData = bidItem.data;
          const bidDocId = bidItem.id;
          const demandDoc = await getDoc(doc(db, 'demands', bidData.demandId)).catch(() => null);
          if (!demandDoc || !demandDoc.exists()) continue;
          
          const demandData = demandDoc.data();
          const buyerCompanyDoc = await getDoc(doc(db, 'companies', demandData.companyId)).catch(() => null);
          const buyerCompanyName = buyerCompanyDoc && buyerCompanyDoc.exists() 
            ? (buyerCompanyDoc.data().companyName || buyerCompanyDoc.data().name) 
            : 'Bilinmeyen Åirket';
          
          const totalAmount = bidData.items?.reduce((sum, item) => {
            return sum + (parseFloat(item.quantity || 0) * parseFloat(item.unitPrice || 0));
          }, 0) || parseFloat(bidData.totalAmount || 0);
          
          const option = document.createElement('option');
          option.value = bidDocId;
          option.textContent = `${buyerCompanyName} - ${demandData.title || 'Talep'} - â‚º${totalAmount.toFixed(2)}`;
          option.dataset.companyId = demandData.companyId;
          option.dataset.amount = totalAmount;
          option.dataset.description = `Talep: ${demandData.title || ''} - Teklif No: ${bidDocId}`;
          approvedBidSelect.appendChild(option);
        }
        
        // Otomatik doldurma event listener
        approvedBidSelect.addEventListener('change', (e) => {
          const selectedOption = e.target.options[e.target.selectedIndex];
          if (selectedOption.value) {
            const companySelect = document.getElementById('paymentRequest_companyId');
            const amountInput = document.getElementById('paymentRequest_amount');
            const descriptionTextarea = document.getElementById('paymentRequest_description');
            
            if (companySelect) companySelect.value = selectedOption.dataset.companyId || '';
            if (amountInput) amountInput.value = parseFloat(selectedOption.dataset.amount || 0).toFixed(2);
            if (descriptionTextarea) descriptionTextarea.value = selectedOption.dataset.description || '';
            
            // Termin tarihini varsayÄ±lan olarak 30 gÃ¼n sonrasÄ±na ayarla
            const dueDateInput = document.getElementById('paymentRequest_dueDate');
            if (dueDateInput && !dueDateInput.value) {
              const futureDate = new Date();
              futureDate.setDate(futureDate.getDate() + 30);
              dueDateInput.value = futureDate.toISOString().split('T')[0];
            }
          }
        });
      } catch (e) {
        logger.error('OnaylanmÄ±ÅŸ teklifler yÃ¼kleme hatasÄ±', e);
      }
    }
    
    // Adres YÃ¶netimi SayfasÄ± YÃ¼kleme
    async function loadAddressesPage() {
      try {
        const user = await getCurrentUser();
        const { doc, getDoc } = await getFirestoreModules();
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (!userDoc.exists()) return;
        
        const userData = userDoc.data();
        
        // Ana adresi gÃ¶ster
        await displayMainAddress(userData);
        
        // Ä°lave adresleri yÃ¼kle
        await loadAdditionalAddressesForManagement(userData);
        
        // Adres istatistiklerini gÃ¼ncelle
        updateAddressStatistics(userData);
      } catch (e) {
        logger.error('Adres yÃ¶netimi sayfasÄ± yÃ¼kleme hatasÄ±', e);
      }
    }
    // Teklifbul Rule v1.0 - Ana Adres GÃ¶ster ve DÃ¼zenle
    let mainAddressEditMode = false;
    
    async function displayMainAddress(userData) {
      const mainAddressDisplay = document.getElementById('mainAddressDisplay');
      const editBtn = document.getElementById('btnEditMainAddress');
      if (!mainAddressDisplay) return;
      
      // Edit mode kontrolÃ¼
      if (mainAddressEditMode) {
        // DÃ¼zenleme modunda structured address formu gÃ¶ster
        const addressPartsData = userData.invoiceAddressParts || {};
        mainAddressDisplay.innerHTML = `
          <div style="display:grid; gap:16px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
              <div>
                <label style="font-size:13px; font-weight:600; color:#1f2937; margin-bottom:6px; display:block;">Ãœlke</label>
                <select id="mainAddr_ulke" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
                  <option value="TÃ¼rkiye" ${(addressPartsData.ulke || 'TÃ¼rkiye') === 'TÃ¼rkiye' ? 'selected' : ''}>TÃ¼rkiye</option>
                  <option value="Almanya">Almanya</option>
                  <option value="Amerika BirleÅŸik Devletleri">Amerika BirleÅŸik Devletleri</option>
                  <option value="BirleÅŸik KrallÄ±k">BirleÅŸik KrallÄ±k</option>
                  <option value="Fransa">Fransa</option>
                  <option value="Hollanda">Hollanda</option>
                  <option value="Ä°spanya">Ä°spanya</option>
                  <option value="Ä°talya">Ä°talya</option>
                  <option value="DiÄŸer">DiÄŸer</option>
                </select>
              </div>
              <div>
                <label style="font-size:13px; font-weight:600; color:#1f2937; margin-bottom:6px; display:block;">Ä°l *</label>
                <select id="mainAddr_il" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;" required>
                  <option value="">Ä°l seÃ§in</option>
                </select>
              </div>
              <div>
                <label style="font-size:13px; font-weight:600; color:#1f2937; margin-bottom:6px; display:block;">Ä°lÃ§e *</label>
                <select id="mainAddr_ilce" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;" required>
                  <option value="">Ã–nce il seÃ§in</option>
                </select>
              </div>
              <div>
                <label style="font-size:13px; font-weight:600; color:#1f2937; margin-bottom:6px; display:block;">Mahalle (Opsiyonel)</label>
                <select id="mainAddr_mahalle" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;" disabled>
                  <option value="">Ã–nce ilÃ§e seÃ§in (opsiyonel)</option>
                </select>
                <p style="margin:4px 0 0 0; font-size:11px; color:#6b7280;">ğŸ’¡ Mahalle seÃ§ilince sokak listesi otomatik yÃ¼klenir</p>
              </div>
              <div>
                <label style="font-size:13px; font-weight:600; color:#1f2937; margin-bottom:6px; display:block;">Cadde</label>
                <input type="text" id="mainAddr_cadde" placeholder="Cadde" value="${addressPartsData.cadde || ''}" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
              </div>
              <div>
                <label style="font-size:13px; font-weight:600; color:#1f2937; margin-bottom:6px; display:block;">Sokak (Opsiyonel)</label>
                <input type="text" id="mainAddr_sokak_manual" placeholder="Sokak adÄ±nÄ± yazÄ±n (opsiyonel)" value="${addressPartsData.sokak || ''}" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
                <select id="mainAddr_sokak" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-top:6px; display:none;" disabled>
                  <option value="">Sokak seÃ§in (opsiyonel)</option>
                </select>
                <p style="margin:4px 0 0 0; font-size:11px; color:#6b7280;">ğŸ’¡ Sokak adÄ±nÄ± elle yazabilir veya mahalle seÃ§ince otomatik yÃ¼klenen listeden seÃ§ebilirsiniz (opsiyonel)</p>
              </div>
              <div>
                <label style="font-size:13px; font-weight:600; color:#1f2937; margin-bottom:6px; display:block;">KapÄ± No</label>
                <input type="text" id="mainAddr_kapi" placeholder="KapÄ± No" value="${addressPartsData.kapiNo || ''}" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
              </div>
              <div>
                <label style="font-size:13px; font-weight:600; color:#1f2937; margin-bottom:6px; display:block;">Daire</label>
                <input type="text" id="mainAddr_daire" placeholder="Daire (varsa)" value="${addressPartsData.daire || ''}" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
              </div>
              <div>
                <label style="font-size:13px; font-weight:600; color:#1f2937; margin-bottom:6px; display:block;">Posta Kodu</label>
                <input type="text" id="mainAddr_postakodu" placeholder="Posta Kodu" value="${addressPartsData.postaKodu || ''}" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
              </div>
            </div>
            
            <!-- Vergi Dairesi -->
            <div style="margin-top:8px;">
              <label style="font-size:13px; font-weight:600; color:#1f2937; margin-bottom:6px; display:block;">
                Vergi Dairesi
                <span style="font-size:11px; color:#6b7280; font-weight:400; margin-left:4px;">(Ä°l seÃ§ince o ile ait vergi daireleri gÃ¶sterilir)</span>
              </label>
              <div style="display:flex; gap:8px; align-items:stretch;">
                <select id="mainAddr_taxOfficeSelect" style="flex:1; padding:12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; min-height:44px; background:white; cursor:pointer; min-width:300px;">
                  <option value="">Vergi dairesi seÃ§in</option>
                  <option value="custom">Elle yaz</option>
                </select>
                <button type="button" id="mainAddr_refreshTaxOfficesBtn" title="Vergi dairesi listesini Firestore'dan yeniden yÃ¼kle" style="padding:8px 14px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; white-space:nowrap; font-weight:500; width:80px; height:44px; display:flex; align-items:center; justify-content:center; transition:background 0.2s; flex-shrink:0;">
                  ğŸ”„
                </button>
              </div>
              <input type="text" id="mainAddr_taxOffice" placeholder="Vergi dairesi adÄ±" value="${userData.taxOffice || ''}" style="width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-top:8px;">
              <p style="margin:4px 0 0 0; font-size:11px; color:#6b7280;">ğŸ’¡ Ä°l seÃ§tiÄŸinizde o ile ait vergi daireleri otomatik yÃ¼klenir. GÃ¼ncel liste iÃ§in "Yenile" butonuna tÄ±klayÄ±n.</p>
            </div>
            
            <!-- Teklifbul Rule v1.0 - Adres Ã–nizleme (CanlÄ± GÃ¼ncelleme) -->
            <div style="margin-top:16px; padding:12px; background:#f8fafc; border:1px dashed #3b82f6; border-radius:6px;">
              <label style="font-size:12px; font-weight:600; color:#3b82f6; margin-bottom:6px; display:block;">ğŸ“‹ Adres Ã–nizleme</label>
              <div id="mainAddressPreview" style="font-size:13px; color:#1f2937; line-height:1.6; min-height:40px;">
                <span style="color:#9ca3af;">Adres bilgilerini doldurun...</span>
              </div>
            </div>
            
            <div style="display:flex; gap:8px; margin-top:12px;">
              <button type="button" id="btnSaveMainAddress" style="flex:1; padding:10px 20px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">
                ğŸ’¾ Kaydet
              </button>
              <button type="button" id="btnCancelMainAddress" style="flex:1; padding:10px 20px; background:#6b7280; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">
                âŒ Ä°ptal
              </button>
            </div>
          </div>
        `;
        
        // Structured address sistemini baÅŸlat
        await initMainAddressFields(userData);
        
        // Teklifbul Rule v2.0 - Yeni vergi dairesi sistemi
        await initTaxUI();
        
        // Teklifbul Rule v1.0 - Adres Ã¶nizleme canlÄ± gÃ¼ncelleme (dÃ¼zenleme modunda da Ã§alÄ±ÅŸÄ±r)
        // Ã–nizleme alanÄ± formun altÄ±nda gÃ¶sterilecek
        initMainAddressPreview();
        
        // Kaydet ve Ä°ptal butonlarÄ±
        document.getElementById('btnSaveMainAddress')?.addEventListener('click', async () => {
          await saveMainAddress();
        });
        document.getElementById('btnCancelMainAddress')?.addEventListener('click', () => {
          mainAddressEditMode = false;
          displayMainAddress(userData);
        });
        
        if (editBtn) editBtn.textContent = 'âŒ Ä°ptal';
        return;
      }
      
      // GÃ¶rÃ¼ntÃ¼leme modu - structured address parts kullan
      const addressPartsData = userData.invoiceAddressParts || {};
      const addressParts = [];
      
      if (addressPartsData.sokak) {
        addressParts.push(`${addressPartsData.sokak}${addressPartsData.sokak.includes('Sokak') || addressPartsData.sokak.includes('Cadde') ? '' : ' Sokak'}`);
      }
      if (addressPartsData.cadde) {
        addressParts.push(`${addressPartsData.cadde}${addressPartsData.cadde.includes('Cadde') ? '' : ' Cadde'}`);
      }
      if (addressPartsData.kapiNo) addressParts.push(`No: ${addressPartsData.kapiNo}`);
      if (addressPartsData.daire) addressParts.push(`Daire: ${addressPartsData.daire}`);
      if (addressPartsData.mahalle) addressParts.push(`${addressPartsData.mahalle}${addressPartsData.mahalle.includes('Mahalle') ? '' : ' Mahalle'}`);
      if (addressPartsData.ilce) addressParts.push(addressPartsData.ilce);
      if (addressPartsData.il) addressParts.push(addressPartsData.il);
      if (addressPartsData.postaKodu) addressParts.push(`PK: ${addressPartsData.postaKodu}`);
      if (userData.taxOffice) addressParts.push(`Vergi Dairesi: ${userData.taxOffice}`);
      
      // Fallback: eski format
      if (addressParts.length === 0) {
        if (userData.inv_street) addressParts.push(userData.inv_street);
        if (userData.inv_building) addressParts.push('No: ' + userData.inv_building);
        if (userData.inv_kapi) addressParts.push('KapÄ±: ' + userData.inv_kapi);
        if (userData.inv_daire) addressParts.push('Daire: ' + userData.inv_daire);
        if (userData.inv_district) addressParts.push(userData.inv_district);
        if (userData.inv_city) addressParts.push(userData.inv_city);
        if (userData.inv_postakodu) addressParts.push('PK: ' + userData.inv_postakodu);
        if (userData.taxOffice) addressParts.push(`Vergi Dairesi: ${userData.taxOffice}`);
      }
      
      if (addressParts.length > 0) {
        // Teklifbul Rule v1.0 - Adres bilgileri yan yana gÃ¶steriliyor (flexbox wrap)
        mainAddressDisplay.innerHTML = `
          <div style="display:flex; flex-wrap:wrap; gap:8px 16px; align-items:center;">
            ${addressParts.map(p => `<span style="color:#1f2937; font-size:14px; white-space:nowrap;">${p}</span>`).join('')}
          </div>
        `;
      } else {
        mainAddressDisplay.innerHTML = '<p style="margin:0; color:#6b7280; font-size:14px;">Ana adres bilgisi bulunmamaktadÄ±r. DÃ¼zenle butonuna tÄ±klayarak ekleyebilirsiniz.</p>';
      }
      
      if (editBtn) {
        editBtn.textContent = 'âœï¸ DÃ¼zenle';
        editBtn.onclick = async () => {
          mainAddressEditMode = true;
          // Teklifbul Rule v1.0 - GÃ¼ncel userData ile yeniden yÃ¼kle
          const currentUser = await getCurrentUser();
          if (currentUser) {
            const freshUserData = await getUserData(currentUser.uid);
            await displayMainAddress(freshUserData);
          } else {
            await displayMainAddress(userData);
          }
        };
      }
    }
    // Teklifbul Rule v1.0 - Ana adres Ã¶nizleme canlÄ± gÃ¼ncelleme (hem gÃ¶rÃ¼ntÃ¼leme hem dÃ¼zenleme modunda)
    function initMainAddressPreview() {
      // GÃ¶rÃ¼ntÃ¼leme modu iÃ§in
      const elDisplay = document.getElementById('mainAddressDisplay');
      // DÃ¼zenleme modu iÃ§in
      const previewEl = document.getElementById('mainAddressPreview');
      
      const sokak = document.getElementById('mainAddr_sokak_manual');
      const cadde = document.getElementById('mainAddr_cadde');
      const kapi = document.getElementById('mainAddr_kapi');
      const daire = document.getElementById('mainAddr_daire');
      const ilce = document.getElementById('mainAddr_ilce');
      const il = document.getElementById('mainAddr_il');
      const postakodu = document.getElementById('mainAddr_postakodu');
      const mahalle = document.getElementById('mainAddr_mahalle');
      const taxOffice = document.getElementById('mainAddr_taxOffice');

      // DÃ¼zenleme modunda Ã§alÄ±ÅŸ
      if (!previewEl && !elDisplay) return;

      const state = {};

      const apply = () => {
        state.sokak = sokak?.value?.trim() || '';
        state.cadde = cadde?.value?.trim() || '';
        state.kapiNo = kapi?.value?.trim() || '';
        state.daire = daire?.value?.trim() || '';
        state.ilce = pickTextOrValue(ilce);
        state.il = pickTextOrValue(il);
        state.postaKodu = postakodu?.value?.trim() || '';
        state.mahalle = pickTextOrValue(mahalle);
        state.taxOffice = taxOffice?.value?.trim() || '';
        state.ulke = 'TÃ¼rkiye';

        // Adres compose - kompakt format (tek satÄ±rda, virgÃ¼lle ayrÄ±lmÄ±ÅŸ)
        const parts = [
          state.mahalle && `${state.mahalle}${state.mahalle.includes('Mahalle') ? '' : ' Mahalle'}`,
          state.sokak && (/(sokak|cadde)$/i.test(state.sokak) ? state.sokak : `${state.sokak} Sokak`),
          state.cadde && (/(cadde)$/i.test(state.cadde) ? state.cadde : `${state.cadde} Cadde`),
          state.kapiNo && `No: ${state.kapiNo}`,
          state.daire && `Daire: ${state.daire}`,
          state.ilce,
          state.il,
          state.postaKodu && `PK: ${state.postaKodu}`,
          state.taxOffice && `Vergi Dairesi: ${state.taxOffice}`,
        ].filter(Boolean);

        const composed = parts.join(' - '); 
        // DÃ¼zenleme modunda preview gÃ¶ster (kompakt)
        if (previewEl) {
          previewEl.innerHTML = composed 
            ? `<div style="color:#1f2937; font-size:13px; line-height:1.6;">${composed}</div>` 
            : '<span style="color:#9ca3af;">Adres bilgilerini doldurun...</span>';
        }
        
        // GÃ¶rÃ¼ntÃ¼leme modunda display gÃ¶ster (alt alta)
        if (elDisplay && !previewEl) {
          elDisplay.innerHTML = composed 
            ? composed.split(' - ').map(p => `<div style="margin-bottom:4px; color:#1f2937; font-size:14px;">${p}</div>`).join('') 
            : '<p style="margin:0; color:#6b7280; font-size:14px;">Adres bilgilerini doldurun.</p>';
        }
        
        document.dispatchEvent(new CustomEvent('address:main:changed', { detail: state }));
      };

      // Event listener'larÄ± ekle
      [sokak, cadde, kapi, daire, postakodu, taxOffice].forEach(i => {
        if (i) i.addEventListener('input', apply);
      });
      [ilce, il, mahalle].forEach(i => {
        if (i) i.addEventListener('change', apply);
      });
      apply(); // ilk Ã§izim
    }
    
    // Teklifbul Rule v1.0 - Ana Adres iÃ§in structured address fields baÅŸlat
    async function initMainAddressFields(userData) {
      const addressPartsData = userData.invoiceAddressParts || {};
      
      // Ä°l-Ä°lÃ§e dropdown'larÄ±nÄ± baÅŸlat
      const ilSel = document.getElementById('mainAddr_il');
      const ilceSel = document.getElementById('mainAddr_ilce');
      const mahalleSel = document.getElementById('mainAddr_mahalle');
      const sokakSel = document.getElementById('mainAddr_sokak');
      const sokakManualEl = document.getElementById('mainAddr_sokak_manual');
      const ulkeSel = document.getElementById('mainAddr_ulke');
      
      if (!ilSel || !ilceSel) return;
      
      // Teklifbul Rule v1.0 - Sokak input her zaman gÃ¶rÃ¼nÃ¼r ve aktif (opsiyonel)
      if (sokakManualEl) {
        sokakManualEl.style.display = '';
        sokakManualEl.removeAttribute('disabled');
        sokakManualEl.removeAttribute('required'); // Opsiyonel
      }
      // Sokak dropdown baÅŸlangÄ±Ã§ta gizli
      if (sokakSel) {
        sokakSel.style.display = 'none';
      }
      
      // Ä°l dropdown'unu doldur
      // Teklifbul Rule v1.0 - __loadProvinceDistrictData object dÃ¶ndÃ¼rebilir (data property'si iÃ§inde array)
      const rawProvinceData = await __loadProvinceDistrictData();
      const provinceData = Array.isArray(rawProvinceData) ? rawProvinceData : (rawProvinceData?.data || []);
      
      // Province listesini formatla (initProvinceDistrictLocal ile aynÄ± format)
      const provinces = provinceData.map(p => ({ 
        id: p.id ?? p.code ?? p.plaka_kodu ?? p.il, 
        name: p.name ?? p.il ?? String(p), 
        raw: p 
      })).sort((a, b) => a.name.localeCompare(b.name, 'tr'));
      
      __fillSelect(ilSel, provinces, 'Ä°l seÃ§in');
      
      // KaydedilmiÅŸ il deÄŸerini geri yÃ¼kle
      if (addressPartsData.il) {
        const savedIl = addressPartsData.il;
        const ilOption = Array.from(ilSel.options).find(opt => 
          opt.textContent.trim() === savedIl || opt.value === savedIl
        );
        if (ilOption) {
          ilSel.value = ilOption.value;
          ilSel.dispatchEvent(new Event('change'));
        }
      }
      
      // Ä°l deÄŸiÅŸtiÄŸinde ilÃ§e ve vergi dairesi gÃ¼ncelle
      ilSel.addEventListener('change', async () => {
        const selectedIl = pickTextOrValue(ilSel);
        if (!selectedIl) {
          __fillSelect(ilceSel, [], 'Ã–nce il seÃ§in');
          mahalleSel.disabled = true;
          mahalleSel.innerHTML = '<option value="">Ã–nce ilÃ§e seÃ§in</option>';
            // Teklifbul Rule v2.0 - Vergi dairesi sistemi artÄ±k initTaxUI() tarafÄ±ndan yÃ¶netiliyor
          return;
        }
        
        // Ä°lÃ§eleri yÃ¼kle
        const selectedProvince = __findByNameOrCode(provinces, selectedIl);
        if (selectedProvince) {
          const districts = __mapDistricts(selectedProvince.raw || selectedProvince);
          __fillSelect(ilceSel, districts, 'Ä°lÃ§e seÃ§in');
          ilceSel.removeAttribute('disabled');
          
          // KaydedilmiÅŸ ilÃ§e deÄŸerini geri yÃ¼kle
          if (addressPartsData.ilce) {
            const savedIlce = addressPartsData.ilce;
            setTimeout(() => {
              const ilceOption = Array.from(ilceSel.options).find(opt => 
                opt.textContent.trim() === savedIlce || opt.value === savedIlce
              );
              if (ilceOption) {
                ilceSel.value = ilceOption.value;
                ilceSel.dispatchEvent(new Event('change'));
              }
            }, 100);
          }
          
          // Teklifbul Rule v2.0 - Vergi dairesi sistemi artÄ±k initTaxUI() tarafÄ±ndan yÃ¶netiliyor
          // Ä°l/ilÃ§e deÄŸiÅŸikliÄŸinde otomatik gÃ¼ncellenecek
        }
      });
      
      // Ä°lÃ§e deÄŸiÅŸtiÄŸinde mahalle, sokak ve vergi dairesi gÃ¼ncelle
      ilceSel.addEventListener('change', async () => {
        const selectedIl = pickTextOrValue(ilSel);
        const selectedIlce = pickTextOrValue(ilceSel);
        if (!selectedIl || !selectedIlce) {
          mahalleSel.disabled = true;
          mahalleSel.innerHTML = '<option value="">Ã–nce ilÃ§e seÃ§in</option>';
          return;
        }
        
        // Teklifbul Rule v2.0 - Vergi dairesi sistemi artÄ±k initTaxUI() tarafÄ±ndan yÃ¶netiliyor
        
        // Mahalleleri yÃ¼kle
        const neighborhoods = await __loadNeighborhoods(selectedIl, selectedIlce);
        if (neighborhoods.neighborhoods && neighborhoods.neighborhoods.length > 0) {
          __fillSelect(mahalleSel, neighborhoods.neighborhoods.map(n => ({ name: n.name || n })), 'Mahalle seÃ§in');
          mahalleSel.removeAttribute('disabled');
          
          // KaydedilmiÅŸ mahalle deÄŸerini geri yÃ¼kle
          if (addressPartsData.mahalle) {
            const savedMahalle = addressPartsData.mahalle;
            setTimeout(() => {
              const mahalleOption = Array.from(mahalleSel.options).find(opt => 
                opt.textContent.trim() === savedMahalle || opt.value === savedMahalle
              );
              if (mahalleOption) {
                mahalleSel.value = mahalleOption.value;
                mahalleSel.dispatchEvent(new Event('change'));
              }
            }, 100);
          }
        } else {
          mahalleSel.disabled = true;
          mahalleSel.innerHTML = '<option value="">Mahalle bulunamadÄ±</option>';
        }
      });
      
      // Mahalle deÄŸiÅŸtiÄŸinde sokak yÃ¼kle (opsiyonel - sokak her zaman elle yazÄ±labilir)
      mahalleSel.addEventListener('change', async () => {
        const selectedIl = pickTextOrValue(ilSel);
        const selectedIlce = pickTextOrValue(ilceSel);
        const selectedMahalle = pickTextOrValue(mahalleSel);
        
        // Sokak input her zaman gÃ¶rÃ¼nÃ¼r - elle yazÄ±labilir
        sokakManualEl.style.display = '';
        sokakManualEl.removeAttribute('disabled');
        
        // Mahalle seÃ§ilmiÅŸse sokaklarÄ± da yÃ¼kle (dropdown olarak opsiyonel)
        if (selectedIl && selectedIlce && selectedMahalle) {
          try {
            // Teklifbul Rule v2.0 - SokaklarÄ± yÃ¼kle (404 hatalarÄ± sessizce handle edilir)
            const streets = await __loadStreets(selectedIl, selectedIlce, selectedMahalle);
            if (streets.streets && streets.streets.length > 0) {
              // Sokak dropdown'u gÃ¶ster ve doldur
              sokakSel.style.display = '';
              sokakSel.removeAttribute('disabled');
              __fillSelect(sokakSel, streets.streets.map(s => ({ name: s.name || s })), 'Sokak seÃ§in (opsiyonel)');
              
              // KaydedilmiÅŸ sokak deÄŸerini geri yÃ¼kle
              if (addressPartsData.sokak) {
                const savedSokak = addressPartsData.sokak;
                setTimeout(() => {
                  // Ã–nce dropdown'da ara
                  const sokakOption = Array.from(sokakSel.options).find(opt => 
                    opt.textContent.trim() === savedSokak || opt.value === savedSokak
                  );
                  if (sokakOption) {
                    sokakSel.value = sokakOption.value;
                    // Dropdown'dan seÃ§ildiyse manuel input'a da yaz
                    sokakManualEl.value = savedSokak;
                  } else {
                    // Dropdown'da yoksa manuel input'ta kal
                    sokakManualEl.value = savedSokak;
                  }
                }, 100);
              }
            } else {
              // Sokak bulunamadÄ± - sadece manuel input gÃ¶ster
              sokakSel.style.display = 'none';
              sokakSel.disabled = true;
              sokakSel.innerHTML = '<option value="">Sokak bulunamadÄ±</option>';
            }
          } catch (error) {
            logger.error('Sokak yÃ¼kleme hatasÄ±', error);
            // Hata durumunda sadece manuel input gÃ¶ster
            sokakSel.style.display = 'none';
            sokakSel.disabled = true;
          }
        } else {
          // Mahalle seÃ§ilmemiÅŸse dropdown'u gizle
          sokakSel.style.display = 'none';
          sokakSel.disabled = true;
          sokakSel.innerHTML = '<option value="">Mahalle seÃ§in (opsiyonel)</option>';
        }
      });
      
      // Sokak dropdown'dan seÃ§ildiÄŸinde manuel input'a da yaz
      sokakSel.addEventListener('change', () => {
        if (sokakSel.value) {
          const selectedOption = sokakSel.options[sokakSel.selectedIndex];
          if (selectedOption) {
            sokakManualEl.value = selectedOption.textContent.trim();
          }
        }
      });
      
      // Teklifbul Rule v2.0 - Yeni vergi dairesi sistemi (modÃ¼ler)
      // initTaxUI() Ã§aÄŸrÄ±lacak - initMainTaxOfficeSystem() kaldÄ±rÄ±ldÄ±
    }
    // Teklifbul Rule v2.0 - Yeni Vergi Dairesi ModÃ¼lÃ¼ (inline implementation)
    // Eski sistem kaldÄ±rÄ±ldÄ±, yeni modÃ¼ler sistem kullanÄ±lÄ±yor
    const MANUAL_TOKEN = 'custom';
    // TaxService sÄ±nÄ±fÄ± (inline)
    class TaxService {
      constructor(initial = []) {
        this.offices = initial.slice();
      }
      setOffices(next) {
        this.offices = next.slice();
      }
      splitByScope({ cityCode, districtCode, cityName, districtName }) {
        // Teklifbul Rule v2.0 - Ä°l adÄ± eÅŸleÅŸtirmesi: cityCode ve cityName normalize edilmiÅŸ karÅŸÄ±laÅŸtÄ±rma
        const inCity = this.offices.filter(o => {
          if (!cityCode && !cityName) return true; // HiÃ§biri yoksa tÃ¼mÃ¼nÃ¼ gÃ¶ster
          
          // cityName ile eÅŸleÅŸtirme (Ã–NCELÄ°K - ana mantÄ±k)
          if (cityName) {
            const cityNorm = __trNorm(cityName);
            
            // 1. o.cityCode ile cityName karÅŸÄ±laÅŸtÄ±r (normalize edilmiÅŸ) - EN Ã–NEMLÄ°
            if (o.cityCode) {
              const officeCityNorm = __trNorm(o.cityCode);
              
              // Tam eÅŸleÅŸme (en Ã¶nemli)
              if (officeCityNorm === cityNorm) return true;
              
              // KÄ±smi eÅŸleÅŸme: cityCode iÃ§inde cityName geÃ§iyorsa veya tam tersi
              if (officeCityNorm.includes(cityNorm) || cityNorm.includes(officeCityNorm)) return true;
              
              // BaÅŸlangÄ±Ã§ eÅŸleÅŸmesi: "ardahan" -> "ardahan vergi dairesi" gibi
              if (officeCityNorm.startsWith(cityNorm) || cityNorm.startsWith(officeCityNorm)) return true;
              
              // Trim ve boÅŸluk kontrolÃ¼: "artvin" === " artvin " gibi
              if (officeCityNorm.trim() === cityNorm.trim()) return true;
            }
            
            // 2. Vergi dairesi adÄ±nda ÅŸehir adÄ± geÃ§iyorsa (fallback - cityCode yoksa veya eÅŸleÅŸme bulunamadÄ±ysa)
            const officeNorm = __trNorm(o.name);
            if (officeNorm.includes(cityNorm)) return true;
            
            // 3. Ters eÅŸleÅŸtirme: ÅŸehir adÄ± ilk kelimeyi iÃ§eriyorsa (fallback)
            const firstWord = officeNorm.split(' ')[0];
            if (cityNorm.includes(firstWord) || firstWord.includes(cityNorm)) return true;
            
            // 4. Ä°l adÄ± vergi dairesi adÄ±nÄ±n herhangi bir kelimesinde geÃ§iyorsa
            const officeWords = officeNorm.split(' ');
            if (officeWords.some(word => word === cityNorm || cityNorm.includes(word) || word.includes(cityNorm))) return true;
          }
          
          // cityCode ile eÅŸleÅŸtirme (cityName yoksa veya cityName ile eÅŸleÅŸme bulunamadÄ±ysa)
          if (cityCode && o.cityCode) {
            const cityCodeNorm = __trNorm(cityCode);
            const officeCityCodeNorm = __trNorm(o.cityCode);
            if (cityCodeNorm === officeCityCodeNorm) return true;
            // Trim kontrolÃ¼
            if (cityCodeNorm.trim() === officeCityCodeNorm.trim()) return true;
          }
          
          // cityCode boÅŸsa ama cityName yoksa, tÃ¼mÃ¼nÃ¼ gÃ¶ster (nationwide/citywide iÃ§in)
          if (!cityCode && !cityName && (o.scope === 'nationwide' || o.scope === 'citywide')) return true;
          
          return false;
        });
        // Ä°lÃ§e bazlÄ± filtreleme
        const districtList = (districtCode || districtName)
          ? inCity.filter(o => {
              if (o.scope !== 'district') return false;
              if (districtCode && o.districtCode && o.districtCode === districtCode) return true;
              if (districtName && (!o.districtCode || o.districtCode === '')) {
                // districtCode boÅŸsa, isim ile eÅŸleÅŸtir
                const officeNorm = __trNorm(o.name);
                const districtNorm = __trNorm(districtName);
                return officeNorm.includes(districtNorm);
              }
              return false;
            })
          : [];
        
        // Citywide ve nationwide her zaman gÃ¶ster (il seÃ§ilmiÅŸ olsa bile)
        const citywideList = inCity.filter(o => o.scope === 'citywide');
        const nationwideList = inCity.filter(o => o.scope === 'nationwide');
        
        // Teklifbul Rule v2.0 - Ä°l seÃ§iliyse ve o il iÃ§in vergi dairesi yoksa, sadece nationwide gÃ¶ster
        // (TÃ¼m listeyi gÃ¶sterme - sadece genel vergi daireleri)
        if (districtList.length === 0 && citywideList.length === 0 && (cityName || cityCode)) {
          // Ä°l seÃ§ilmiÅŸ ama eÅŸleÅŸen vergi dairesi yok â†’ daha esnek eÅŸleÅŸtirme yap
          const cityNorm = cityName ? __trNorm(cityName) : '';
          
          // Daha esnek eÅŸleÅŸtirme: tÃ¼m olasÄ± eÅŸleÅŸmeleri bul
          const matchingOffices = this.offices.filter(o => {
            if (!o.cityCode) {
              // cityCode yoksa, vergi dairesi adÄ±nda il adÄ±nÄ± ara
              if (cityNorm) {
                const officeNameNorm = __trNorm(o.name);
                return officeNameNorm.includes(cityNorm);
              }
              return false;
            }
            
            const officeCityNorm = __trNorm(o.cityCode);
            
            // Tam eÅŸleÅŸme
            if (officeCityNorm === cityNorm) return true;
            
            // KÄ±smi eÅŸleÅŸme (her iki yÃ¶nde)
            if (officeCityNorm.includes(cityNorm) || cityNorm.includes(officeCityNorm)) return true;
            
            // BaÅŸlangÄ±Ã§ eÅŸleÅŸmesi
            if (officeCityNorm.startsWith(cityNorm) || cityNorm.startsWith(officeCityNorm)) return true;
            
            // Trim ile eÅŸleÅŸme
            if (officeCityNorm.trim() === cityNorm.trim()) return true;
            
            // Karakter bazlÄ± benzerlik (TÃ¼rkÃ§e karakter farklarÄ± iÃ§in)
            const cityNormClean = cityNorm.replace(/[Ä±i]/g, '').replace(/[ÄŸg]/g, '').replace(/[Ã¼u]/g, '').replace(/[ÅŸs]/g, '').replace(/[Ã¶o]/g, '').replace(/[Ã§c]/g, '');
            const officeNormClean = officeCityNorm.replace(/[Ä±i]/g, '').replace(/[ÄŸg]/g, '').replace(/[Ã¼u]/g, '').replace(/[ÅŸs]/g, '').replace(/[Ã¶o]/g, '').replace(/[Ã§c]/g, '');
            if (cityNormClean === officeNormClean && cityNormClean.length > 3) return true;
            
            // Vergi dairesi adÄ±nda il adÄ± geÃ§iyorsa
            const officeNameNorm = __trNorm(o.name);
            if (officeNameNorm.includes(cityNorm)) return true;
            
            return false;
          });
          
          if (matchingOffices.length > 0) {
            // EÅŸleÅŸenleri scope'a gÃ¶re ayÄ±r
            const existingNationwide = this.offices.filter(o => o.scope === 'nationwide');
            const matchingNationwide = matchingOffices.filter(o => o.scope === 'nationwide');
            const otherNationwide = existingNationwide.filter(o => !matchingNationwide.includes(o));
            
            return {
              districtList: matchingOffices.filter(o => o.scope === 'district'),
              citywideList: matchingOffices.filter(o => o.scope === 'citywide'),
              nationwideList: [...matchingNationwide, ...otherNationwide]
            };
          }
          
          // HiÃ§ eÅŸleÅŸme yoksa sadece nationwide gÃ¶ster
          const allNationwide = this.offices.filter(o => o.scope === 'nationwide');
          return { 
            districtList: [],
            citywideList: [],
            nationwideList: allNationwide
          };
        }
        
        return { districtList, citywideList, nationwideList };
      }
      findById(id) {
        return this.offices.find(o => o.id === id);
      }
    }
    
    // Veri yÃ¼kleme
    async function loadTaxOffices() {
      try {
        // Firestore'dan yÃ¼kle
        const list = await fetchTaxOfficesFromFirestore();
        if (Array.isArray(list) && list.length > 0) {
          // String array'i TaxOffice[]'e dÃ¶nÃ¼ÅŸtÃ¼r
          return list.map((name, idx) => {
            const nameStr = String(name);
            const nameNorm = __trNorm(nameStr);
            // Ä°l adÄ±nÄ± bul (bÃ¼yÃ¼k ÅŸehirler + tÃ¼m iller iÃ§in text-based matching)
            let cityCode = '';
            // TÃ¼rkiye'nin tÃ¼m illeri (normalize edilmiÅŸ)
            const cityNames = ['istanbul', 'ankara', 'izmir', 'antalya', 'bursa', 'adana', 'gaziantep', 'konya', 'denizli', 'trabzon',
              'balikesir', 'balÄ±kesir', 'eskisehir', 'eskiÅŸehir', 'sakarya', 'kocaeli', 'manisa', 'mugla', 'muÄŸla', 'aydin', 'aydÄ±n',
              'tekirdag', 'tekirdaÄŸ', 'hatay', 'mardin', 'sanliurfa', 'ÅŸanlÄ±urfa', 'van', 'elazig', 'elazÄ±ÄŸ', 'samsun', 'malatya',
              'erzurum', 'kahramanmaras', 'kahramanmaraÅŸ', 'afyon', 'afyonkarahisar', 'antalya', 'bursa', 'izmir', 'ankara', 'istanbul'];
            for (const city of cityNames) {
              if (nameNorm.includes(city)) {
                cityCode = city;
                break;
              }
            }
            
            return {
              id: `tax-${idx}`,
              name: nameStr,
              cityCode: cityCode,
              scope: nameNorm.includes('bÃ¼yÃ¼k mÃ¼kellef') ? 'nationwide' :
                     nameNorm.includes('kurumlar') ? 'citywide' : 'district'
            };
          });
        }
      } catch (e) {
        logger.warn('Firestore\'dan vergi dairesi yÃ¼klenemedi');
      }
      
      // Teklifbul Rule v2.0 - PDF'den Ã§Ä±karÄ±lan verileri kullan
      try {
        const pdfResponse = await fetch('/data/tax-offices-from-pdf.json');
        if (pdfResponse.ok) {
          const pdfData = await pdfResponse.json();
          if (Array.isArray(pdfData) && pdfData.length > 0) {
            // Teklifbul Rule v2.0 - GeÃ§ersiz il adlarÄ±nÄ± filtrele
            const invalidCities = ['genel', 'sira', 'no.', 'il', 'defterdarlik', 'ilce'];
            
            return pdfData
              .filter(office => {
                // GeÃ§ersiz kayÄ±tlarÄ± filtrele
                const city = office.city || '';
                const cityNorm = __trNorm(city.replace(/^\d{1,2}\s+/, '').trim());
                return cityNorm && cityNorm.length >= 3 && !invalidCities.includes(cityNorm);
              })
              .map((office, idx) => {
                // Ä°l adÄ±nÄ± temizle (plaka numaralarÄ±nÄ± kaldÄ±r)
                // Ã–rnek: "13 BITLIS" -> "BITLIS", "10 BALIKESIR" -> "BALIKESIR"
                let cityName = office.city || '';
                cityName = cityName.replace(/^\d{1,2}\s+/, '').trim(); // BaÅŸtaki 1-2 haneli plaka numarasÄ±nÄ± kaldÄ±r
                // Teklifbul Rule v2.0 - Ä°l adÄ±nÄ± normalize et (TÃ¼rkÃ§e karakterleri dÃ¼zelt)
                const cityNorm = __trNorm(cityName);
                
                // GeÃ§ersiz il adlarÄ±nÄ± atla
                if (!cityNorm || cityNorm.length < 3 || invalidCities.includes(cityNorm)) {
                  return null;
                }
                
                // Vergi dairesi adÄ±nÄ± temizle
                let officeName = office.name || '';
                // "MÃ¼dÃ¼rlÃ¼ÄŸÃ¼" kÄ±smÄ±nÄ± kaldÄ±r, sadece "Vergi Dairesi" kalacak
                officeName = officeName.replace(/\s+MÃ¼dÃ¼rlÃ¼ÄŸÃ¼$/i, '').trim();
                // Ä°lÃ§e adÄ± tekrarÄ± varsa kaldÄ±r (Ã¶rn: "Tatvan Tatvan" -> "Tatvan")
                const parts = officeName.split(' ');
                if (parts.length >= 2 && __trNorm(parts[0]) === __trNorm(parts[1])) {
                  officeName = parts.slice(1).join(' ');
                }
                
                return {
                  id: `pdf-${idx}`,
                  name: officeName,
                  cityCode: cityNorm, // Normalize edilmiÅŸ il adÄ± (plaka numarasÄ± olmadan, lowercase)
                  scope: office.scope || 'district'
                };
              })
              .filter(Boolean); // null deÄŸerleri kaldÄ±r
          }
        }
      } catch (e) {
        logger.warn('PDF\'den vergi dairesi yÃ¼klenemedi, yerel liste kullanÄ±lacak');
      }
      
      // Fallback: LOCAL_TAX_OFFICES
      if (typeof LOCAL_TAX_OFFICES !== 'undefined' && Array.isArray(LOCAL_TAX_OFFICES)) {
        // Ä°simden il/ilÃ§e bilgisini Ã§Ä±kar (text-based)
        return LOCAL_TAX_OFFICES.map((name, idx) => {
          const nameStr = String(name);
          const nameNorm = __trNorm(nameStr);
          // Ä°l adÄ±nÄ± bul (bÃ¼yÃ¼k ÅŸehirler)
          let cityCode = '';
          const cityNames = ['istanbul', 'ankara', 'izmir', 'antalya', 'bursa', 'adana', 'gaziantep', 'konya', 'denizli', 'trabzon'];
          for (const city of cityNames) {
            if (nameNorm.includes(city)) {
              cityCode = city; // Ä°lk aÅŸamada ÅŸehir adÄ±, sonra kod olacak
              break;
            }
          }
          
          return {
            id: `local-${idx}`,
            name: nameStr,
            cityCode: cityCode,
            scope: nameNorm.includes('bÃ¼yÃ¼k mÃ¼kellef') ? 'nationwide' :
                   nameNorm.includes('kurumlar') ? 'citywide' : 'district'
          };
        });
      }
      
      return [];
    }
    
    // Render fonksiyonu
    function renderTaxSelect(selectEl, inputEl, lists, currentName = '') {
      const { districtList, citywideList, nationwideList } = lists;
      const makeOpt = (o) => {
        const opt = document.createElement('option');
        opt.value = o.id;
        opt.textContent = o.name;
        return opt;
      };

      selectEl.innerHTML = '';
      selectEl.appendChild(new Option('Vergi dairesi seÃ§in', ''));
      selectEl.appendChild(new Option('Elle yaz', MANUAL_TOKEN));

      const addGroup = (label, arr) => {
        if (!arr?.length) return;
        const og = document.createElement('optgroup');
        og.label = label;
        arr.forEach(o => og.appendChild(makeOpt(o)));
        selectEl.appendChild(og);
      };

      addGroup('Ä°lÃ§ene Uygun', districtList);
      addGroup('Ä°l Genelinde GeÃ§erli', citywideList);
      addGroup('Ã–zel/KapsamlÄ±', nationwideList);

      if (currentName) inputEl.value = currentName;
    }
    
    // Bind fonksiyonu
    function bindTaxSelect(selectEl, inputEl, idToName) {
      selectEl.addEventListener('change', (e) => {
        const v = e.target.value;
        if (!v || v === MANUAL_TOKEN) {
          inputEl.removeAttribute('disabled');
          if (v === MANUAL_TOKEN) inputEl.value = '';
          inputEl.placeholder = 'Vergi dairesi adÄ±nÄ± elle yazÄ±n';
          inputEl.focus();
        } else {
          const name = idToName(v) || '';
          inputEl.value = name;
          inputEl.setAttribute('disabled', 'disabled');
          inputEl.placeholder = 'SeÃ§ilen vergi dairesi';
        }
      });
    }
    
    // Yeni init fonksiyonu
    async function initTaxUI() {
      const selCity = document.getElementById('mainAddr_il');
      const selDist = document.getElementById('mainAddr_ilce');
      const selVD = document.getElementById('mainAddr_taxOfficeSelect');
      const inpVD = document.getElementById('mainAddr_taxOffice');

      if (!selVD || !inpVD) {
        logger.warn('Tax office select/input elements not found');
        return;
      }

      const data = await loadTaxOffices();
      const svc = new TaxService(data);

      const idToName = (id) => svc.findById(id)?.name;

      bindTaxSelect(selVD, inpVD, idToName);

      const build = () => {
        // Ä°l/ilÃ§e dropdown'larÄ±ndan cityCode/districtCode al
        // value = code/id, text = name
        const cityCode = selCity?.value || '';
        const districtCode = selDist?.value || '';
        const cityName = selCity ? pickTextOrValue(selCity) : '';
        const districtName = selDist ? pickTextOrValue(selDist) : '';
        
        // Teklifbul Rule v2.0 - Mevcut vergi dairesi adÄ±nÄ± koru (sadece il deÄŸiÅŸmediyse)
        const currentName = inpVD.value || '';

        // Teklifbul Rule v2.0 - Ä°l adÄ±nÄ± normalize et (TÃ¼rkÃ§e karakterleri dÃ¼zelt)
        const cityNameNorm = cityName ? __trNorm(cityName) : '';
        
        // Debug: Ä°l adÄ± eÅŸleÅŸtirmesi
        if (cityName && cityNameNorm) {
          console.debug(`ğŸ” Ä°l eÅŸleÅŸtirmesi: "${cityName}" -> normalize: "${cityNameNorm}"`);
          // Debug: SeÃ§ili il ile eÅŸleÅŸen vergi dairelerinin cityCode'larÄ±nÄ± gÃ¶ster
          const matching = svc.offices.filter(o => {
            if (!o.cityCode) return false;
            const officeCityNorm = __trNorm(o.cityCode);
            return officeCityNorm === cityNameNorm || officeCityNorm.includes(cityNameNorm) || cityNameNorm.includes(officeCityNorm);
          });
          if (matching.length > 0) {
            console.debug(`ğŸ” "${cityName}" ile eÅŸleÅŸen ${matching.length} vergi dairesi bulundu (ilk 5):`, matching.slice(0, 5).map(o => `${o.name.substring(0, 30)}: cityCode="${o.cityCode}" (norm: "${__trNorm(o.cityCode)}")`));
          } else {
            // EÅŸleÅŸmeyen ama il adÄ±na benzer olanlarÄ± gÃ¶ster
            const similar = svc.offices.filter(o => {
              if (!o.cityCode) return false;
              const officeCityNorm = __trNorm(o.cityCode);
              return officeCityNorm.length > 0 && officeCityNorm.length < 15;
            }).slice(0, 10);
            console.debug(`ğŸ” Ã–rnek vergi dairesi cityCode'larÄ± (eÅŸleÅŸme yok):`, similar.map(o => `${o.name.substring(0, 30)}: cityCode="${o.cityCode}" (norm: "${__trNorm(o.cityCode)}")`));
          }
        }

        // Teklifbul Rule v2.0 - Ä°lk aÅŸamada text-based matching (cityCode boÅŸsa)
        const lists = svc.splitByScope({ 
          cityCode: cityCode || '', 
          districtCode: districtCode || '',
          cityName: cityNameNorm || cityName || '', // Normalize edilmiÅŸ il adÄ±nÄ± kullan
          districtName: districtName || ''
        });
        // Debug: Bulunan vergi daireleri
        const total = lists.districtList.length + lists.citywideList.length + lists.nationwideList.length;
        if (cityName && total === 0) {
          logger.warn(`"${cityName}" iÃ§in vergi dairesi bulunamadÄ±`, { toplamVergiDairesi: svc.offices.length });
          logger.info('Debug bilgileri', { cityName, cityNameNorm, cityCode });
          
          // Debug: SeÃ§ili il ile eÅŸleÅŸmesi gereken vergi dairelerini bul (tÃ¼m yÃ¶ntemlerle)
          const allMatches = svc.offices.filter(o => {
            if (!cityNameNorm) return false;
            
            // cityCode ile eÅŸleÅŸme
            if (o.cityCode) {
              const officeCityNorm = __trNorm(o.cityCode);
              if (officeCityNorm === cityNameNorm) return true;
              if (officeCityNorm.includes(cityNameNorm) || cityNameNorm.includes(officeCityNorm)) return true;
            }
            
            // Vergi dairesi adÄ±nda il adÄ±
            const officeNameNorm = __trNorm(o.name);
            if (officeNameNorm.includes(cityNameNorm)) return true;
            
            return false;
          });
          
          logger.info(`"${cityName}" ile eÅŸleÅŸen ${allMatches.length} vergi dairesi bulundu`, { matches: allMatches.slice(0, 10) });
          
          // EÄŸer eÅŸleÅŸme varsa ama splitByScope bulamadÄ±ysa, bunlarÄ± gÃ¶ster
          if (allMatches.length > 0) {
            logger.warn('EÅŸleÅŸen vergi daireleri var ama filtreleme baÅŸarÄ±sÄ±z! Bu vergi daireleri gÃ¶sterilmeli');
            // Bu durumda fallback olarak eÅŸleÅŸenleri gÃ¶ster
            const fallbackLists = {
              districtList: allMatches.filter(o => o.scope === 'district'),
              citywideList: allMatches.filter(o => o.scope === 'citywide'),
              nationwideList: [...allMatches.filter(o => o.scope === 'nationwide'), ...svc.offices.filter(o => o.scope === 'nationwide' && !allMatches.includes(o))]
            };
            renderTaxSelect(selVD, inpVD, fallbackLists, currentName);
            return;
          }
        } else if (cityName) {
          console.debug(`âœ… "${cityName}" iÃ§in ${total} vergi dairesi bulundu (district: ${lists.districtList.length}, citywide: ${lists.citywideList.length}, nationwide: ${lists.nationwideList.length})`);
        }
        
        renderTaxSelect(selVD, inpVD, lists, currentName);
      };

      build();
      
      // Teklifbul Rule v2.0 - Ä°l deÄŸiÅŸtiÄŸinde vergi dairesi seÃ§imini sÄ±fÄ±rla
      selCity?.addEventListener('change', () => {
        // Ä°l deÄŸiÅŸti â†’ vergi dairesi seÃ§imini temizle
        inpVD.value = '';
        selVD.value = '';
        build(); // Yeni il iÃ§in listeyi yeniden oluÅŸtur
      });
      
      selDist?.addEventListener('change', build);
      
      const refreshBtn = document.getElementById('mainAddr_refreshTaxOfficesBtn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', async () => {
          try {
            refreshBtn.setAttribute('disabled', 'disabled');
            refreshBtn.textContent = 'â³ YÃ¼kleniyor...';
            const fresh = await loadTaxOffices();
            svc.setOffices(fresh);
            build();
            logger.info("Vergi dairesi listesi yenilendi");
      } catch (error) {
            logger.error("Liste yenilenemedi", error);
          } finally {
            refreshBtn.removeAttribute('disabled');
            refreshBtn.textContent = 'ğŸ”„ Yenile';
          }
        });
      }
    }
    // Teklifbul Rule v1.0 - Ana Adres kaydet
    async function saveMainAddress() {
      try {
        const user = await getCurrentUser();
        
        // Structured address parts topla
        const ulke = document.getElementById('mainAddr_ulke')?.value || 'TÃ¼rkiye';
        const ilSel = document.getElementById('mainAddr_il');
        const ilceSel = document.getElementById('mainAddr_ilce');
        const mahalleSel = document.getElementById('mainAddr_mahalle');
        const sokakSel = document.getElementById('mainAddr_sokak');
        const sokakManualEl = document.getElementById('mainAddr_sokak_manual');
        const cadde = document.getElementById('mainAddr_cadde')?.value || '';
        const kapiNo = document.getElementById('mainAddr_kapi')?.value || '';
        const daire = document.getElementById('mainAddr_daire')?.value || '';
        const postakodu = document.getElementById('mainAddr_postakodu')?.value || '';
        
        const il = pickTextOrValue(ilSel);
        const ilce = pickTextOrValue(ilceSel);
        const mahalle = pickTextOrValue(mahalleSel);
        
        // Teklifbul Rule v1.0 - Sokak her zaman manuel input'tan alÄ±nÄ±r (opsiyonel)
        let sokak = '';
        if (sokakManualEl && sokakManualEl.value) {
          sokak = sokakManualEl.value.trim();
        } else if (sokakSel && sokakSel.value && sokakSel.style.display !== 'none') {
          // Dropdown'dan seÃ§ilmiÅŸse onu kullan
          const selectedOption = sokakSel.options[sokakSel.selectedIndex];
          sokak = selectedOption ? selectedOption.textContent.trim() : '';
        }
        
        // Teklifbul Rule v2.0 - Vergi dairesi kaydetme (ID + Name)
        const taxOfficeSelect = document.getElementById('mainAddr_taxOfficeSelect');
        const taxOfficeInput = document.getElementById('mainAddr_taxOffice');
        const taxOfficeId = taxOfficeSelect?.value && taxOfficeSelect.value !== MANUAL_TOKEN ? taxOfficeSelect.value : null;
        const taxOfficeName = (taxOfficeInput?.value || '').trim();
        
        // Validation
        if (!il || !ilce) {
          toast.error(MESSAGES.ERROR_CITY_DISTRICT_REQUIRED);
          return;
        }
        
        // Teklifbul Rule v1.0 - Sokak opsiyonel (boÅŸ bÄ±rakÄ±labilir)
        
        // Firestore'a kaydet
        const invoiceAddressParts = {
          ulke: ulke.trim() || null,
          il: il.trim() || null,
          ilce: ilce.trim() || null,
          mahalle: mahalle.trim() || null,
          cadde: cadde.trim() || null,
          sokak: sokak.trim() || null,
          kapiNo: kapiNo.trim() || null,
          daire: daire.trim() || null,
          postaKodu: postakodu.trim() || null
        };
        
        // Teklifbul Rule v2.0 - Vergi dairesi ID ve Name ayrÄ± kaydediliyor
        const { doc, getDoc, updateDoc, serverTimestamp } = await getFirestoreModules();
        await updateDoc(doc(db, 'users', user.uid), {
          invoiceAddressParts,
          taxOffice: taxOfficeName || null, // Name (geriye dÃ¶nÃ¼k uyumluluk)
          taxOfficeId: taxOfficeId || null, // ID (yeni sistem)
          taxOfficeName: taxOfficeName || null, // Name (yeni sistem)
          updatedAt: serverTimestamp()
        });
        
        toast.success(MESSAGES.SUCCESS_MAIN_ADDRESS_SAVED);
        mainAddressEditMode = false;
        
        // SayfayÄ± yenile
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists()) {
          await displayMainAddress(userDoc.data());
        }
      } catch (error) {
        logger.error('Ana adres kaydetme hatasÄ±', error);
        toast.error(MESSAGES.ERROR_ADDRESS_SAVE + ': ' + error.message);
      }
    }
    
    // Ä°lave Adresleri YÃ¼kle (Adres YÃ¶netimi SayfasÄ± iÃ§in)
    async function loadAdditionalAddressesForManagement(userData) {
      const additionalAddressesContainer = document.getElementById('additionalAddresses');
      if (!additionalAddressesContainer) return;
      
      const additionalAddresses = userData.additionalAddresses || [];
      const defaultDeliveryAddress = userData.defaultDeliveryAddress || 'main';
      
      // Teklifbul Rule v1.0 - VarsayÄ±lan teslimat adresi seÃ§imini gÃ¼ncelle (sadece teslimat adresleri)
      const defaultDeliverySelect = document.getElementById('defaultDeliveryAddress');
      
      if (defaultDeliverySelect) {
        // Sadece teslimat adreslerini gÃ¶ster (fatura adresleri hariÃ§)
        const deliveryAddresses = additionalAddresses.filter((addr, idx) => {
          const type = addr.type || '';
          return type !== 'invoice' && type !== 'Fatura';
        });
        
        defaultDeliverySelect.innerHTML = '<option value="main">ğŸ  Ana Adres (Fatura Adresi)</option>' + 
          deliveryAddresses.map((addr, originalIdx) => {
            // Orijinal index'i bul (filtrelemeden Ã¶nce)
            const originalIndex = additionalAddresses.findIndex(a => a === addr);
            const displayTitle = addr.title || getAddressTypeLabel(addr.type) || 'Adres';
            return `<option value="addr_${originalIndex}" ${defaultDeliveryAddress === `addr_${originalIndex}` ? 'selected' : ''}>${displayTitle}</option>`;
          }).join('');
        
        // Teklifbul Rule v1.0 - Event listener'Ä± sadece bir kez ekle (Ã§ift ekleme Ã¶nleme)
        const existingHandler = defaultDeliverySelect.dataset.handlerAttached;
        if (!existingHandler) {
          defaultDeliverySelect.dataset.handlerAttached = 'true';
        defaultDeliverySelect.addEventListener('change', async (e) => {
          try {
            const { doc, updateDoc, serverTimestamp } = await getFirestoreModules();
            await updateDoc(doc(db, 'users', (await getCurrentUser()).uid), {
              defaultDeliveryAddress: e.target.value,
              updatedAt: serverTimestamp()
            });
            toast.success(MESSAGES.SUCCESS_DEFAULT_DELIVERY_ADDRESS_UPDATED);
              // Teklifbul Rule v1.0 - HaritayÄ± seÃ§ili adresle yeniden yÃ¼kle
              const user = await getCurrentUser();
              if (user) {
                const updatedUserData = await getUserData(user.uid);
                initializeAddressMap(updatedUserData);
              }
            await loadAddressesPage(); // SayfayÄ± yenile
          } catch (err) {
            logger.error('VarsayÄ±lan adres gÃ¼ncelleme hatasÄ±', err);
            toast.error(MESSAGES.ERROR_UPDATE + ': ' + err.message);
          }
        });
        }
      }
      
      if (additionalAddresses.length === 0) {
        additionalAddressesContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#6b7280;"><p>HenÃ¼z ilave adres eklenmemiÅŸ.</p></div>';
        return;
      }
      
      additionalAddressesContainer.innerHTML = additionalAddresses.map((addr, index) => {
        const isDefaultDelivery = defaultDeliveryAddress === `addr_${index}`;
        // Teklifbul Rule v1.0 - Fatura adresi baÅŸlÄ±ÄŸÄ± her zaman "Fatura Adresi", diÄŸerleri title veya type label
        const displayTitle = (addr.type === 'invoice' || addr.type === 'Fatura') ? 'Fatura Adresi' : (addr.title || getAddressTypeLabel(addr.type) || 'Adres');
        return `
        <div style="padding:16px; background:white; border-radius:8px; border:1px solid #e5e7eb;">
          <div style="display:flex; gap:12px; align-items:start;">
            <input type="checkbox" class="address-checkbox" data-index="${index}" style="margin-top:4px; width:18px; height:18px; cursor:pointer;" />
            <div style="flex:1;">
              <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                <div>
                  <div style="font-weight:600; color:#1f2937; margin-bottom:4px;">
                    ${displayTitle}
                    ${isDefaultDelivery ? '<span style="padding:2px 8px; background:#3b82f6; color:white; border-radius:12px; font-size:10px; margin-left:8px;">VarsayÄ±lan Teslimat</span>' : ''}
                  </div>
                  <div style="font-size:13px; color:#6b7280; line-height:1.6; white-space:pre-wrap;">
                    ${addr.content || (addr.street && `${addr.street}${addr.street.includes('Sokak') || addr.street.includes('Cadde') ? '' : ' Sokak'}`) || 'Adres bilgisi bulunmuyor'}
                  </div>
                </div>
                <div style="display:flex; gap:8px;">
                  <button type="button" class="addr-edit" data-index="${index}" style="padding:6px 12px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600;">
                    âœï¸ DÃ¼zenle
                  </button>
                  <button type="button" class="addr-remove" data-index="${index}" style="padding:6px 12px; background:#ef4444; color:white; border:none; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600;">
                    ğŸ—‘ï¸ Sil
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      }).join('');
      
      // Toplu iÅŸlem event listener'larÄ±
      setupBulkAddressActions();
      
      // Teklifbul Rule v1.0 - DÃ¼zenle ve Sil butonlarÄ±na event listener ekle
      setupAddressActionButtons();
    }
    
    // Adres dÃ¼zenleme ve silme butonlarÄ± iÃ§in event listener'lar
    function setupAddressActionButtons() {
      // Teklifbul Rule v1.0 - Yeni class isimleri: .addr-edit ve .addr-remove
      // DÃ¼zenle butonlarÄ±
      document.querySelectorAll('.addr-edit').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const index = parseInt(e.target.getAttribute('data-index') || e.target.closest('.addr-edit')?.getAttribute('data-index'));
          if (isNaN(index)) {
            logger.error('GeÃ§ersiz adres indeksi', { index });
            return;
          }
          // DÃ¼zenleme moduna geÃ§
          const user = await getCurrentUser();
          if (user) {
            const userData = await getUserData(user.uid);
            const addr = userData.additionalAddresses?.[index];
            if (addr) {
              addAddressRow({ 
                title: addr.title || '', 
                content: addr.content || '', 
                type: addr.type || '',
                isSaved: false 
              });
              btn.closest('.addr-row')?.remove();
            }
          }
        });
      });
      
      // Sil butonlarÄ±
      document.querySelectorAll('.addr-remove').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const index = parseInt(e.target.getAttribute('data-index') || e.target.closest('.addr-remove')?.getAttribute('data-index'));
          if (isNaN(index)) {
            logger.error('GeÃ§ersiz adres indeksi', { index });
            return;
          }
          await deleteAddress(index);
        });
      });
    }
    
    // Adres TÃ¼rÃ¼ Etiketini Getir
    function getAddressTypeLabel(type) {
      const labels = {
        'invoice': 'Fatura Adresi',
        'Fatura': 'Fatura Adresi',
        'delivery': 'Teslimat Adresi',
        'Teslimat': 'Teslimat Adresi',
        'other': 'DiÄŸer',
        'DiÄŸer': 'DiÄŸer'
      };
      return labels[type] || type || 'Adres';
    }
    // Toplu Adres Ä°ÅŸlemleri
    function setupBulkAddressActions() {
      const checkboxes = document.querySelectorAll('.address-checkbox');
      const bulkActions = document.getElementById('bulkActionsAddresses');
      const bulkEditBtn = document.getElementById('btnBulkEditAddresses');
      const cancelBulkBtn = document.getElementById('btnCancelBulkEdit');
      const bulkDeleteBtn = document.getElementById('btnBulkDeleteAddresses');
      const selectedCount = document.getElementById('selectedAddressCount');
      
      if (!checkboxes.length || !bulkActions || !bulkDeleteBtn) return;
      
      let selectedAddresses = new Set();
      
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const index = parseInt(e.target.getAttribute('data-index'));
          if (e.target.checked) {
            selectedAddresses.add(index);
          } else {
            selectedAddresses.delete(index);
          }
          
          if (selectedAddresses.size > 0) {
            bulkActions.style.display = 'block';
            if (bulkEditBtn) bulkEditBtn.style.display = 'none';
            if (selectedCount) selectedCount.textContent = `${selectedAddresses.size} adres seÃ§ildi`;
          } else {
            bulkActions.style.display = 'none';
            if (bulkEditBtn) bulkEditBtn.style.display = 'block';
          }
        });
      });
      
      if (cancelBulkBtn) {
        cancelBulkBtn.addEventListener('click', () => {
          checkboxes.forEach(cb => cb.checked = false);
          selectedAddresses.clear();
          bulkActions.style.display = 'none';
          if (bulkEditBtn) bulkEditBtn.style.display = 'block';
        });
      }
      
      if (bulkDeleteBtn) {
        bulkDeleteBtn.addEventListener('click', async () => {
          if (selectedAddresses.size === 0) {
            toast.error(MESSAGES.ERROR_ADDRESS_SELECT_REQUIRED);
            return;
          }
          
          if (!confirm(`âš ï¸ ${selectedAddresses.size} adres silinecek. Emin misiniz?`)) {
            return;
          }
          
          try {
            const user = await getCurrentUser();
            const { doc, getDoc, updateDoc, serverTimestamp } = await getFirestoreModules();
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (!userDoc.exists()) return;
            
            const userData = userDoc.data();
            const additionalAddresses = userData.additionalAddresses || [];
            
            // SeÃ§ilen adresleri kaldÄ±r
            const newAddresses = additionalAddresses.filter((_, idx) => !selectedAddresses.has(idx));
            
            await updateDoc(doc(db, 'users', user.uid), {
              additionalAddresses: newAddresses,
              updatedAt: serverTimestamp()
            });
            
            toast.success(MESSAGES.SUCCESS_ADDRESSES_DELETED.replace('{n}', String(selectedAddresses.size)));
            selectedAddresses.clear();
            await loadAddressesPage(); // SayfayÄ± yenile
          } catch (err) {
            logger.error('Toplu silme hatasÄ±', err);
            toast.error(MESSAGES.ERROR_ADDRESS_DELETE + ': ' + err.message);
          }
        });
      }
    }
    
    // Adres Ä°statistiklerini GÃ¼ncelle
    function updateAddressStatistics(userData) {
      const additionalAddresses = userData.additionalAddresses || [];
      const totalAddresses = 1 + additionalAddresses.length; // Ana adres + ilave adresler
      
      // Teklifbul Rule v1.0 - Ana adres (fatura adresi) varsa fatura sayÄ±sÄ±na dahil et
      // Ana adres kontrolÃ¼: invoiceAddressParts veya eski format (inv_*) alanlarÄ±ndan herhangi biri varsa
      const hasMainAddress = !!(
        (userData.invoiceAddressParts && (userData.invoiceAddressParts.il || userData.invoiceAddressParts.ilce)) ||
        (userData.inv_city || userData.inv_district)
      );
      
      const additionalInvoiceCount = additionalAddresses.filter(addr => addr.type === 'invoice' || addr.type === 'Fatura').length;
      const invoiceCount = (hasMainAddress ? 1 : 0) + additionalInvoiceCount; // Ana adres + ilave fatura adresleri
      
      const deliveryCount = additionalAddresses.filter(addr => addr.type === 'delivery' || addr.type === 'Teslimat').length;
      const otherCount = additionalAddresses.filter(addr => !['invoice', 'Fatura', 'delivery', 'Teslimat'].includes(addr.type)).length;
      
      const totalEl = document.getElementById('addressCount_total');
      const invoiceEl = document.getElementById('addressCount_invoice');
      const deliveryEl = document.getElementById('addressCount_delivery');
      const otherEl = document.getElementById('addressCount_other');
      
      if (totalEl) totalEl.textContent = totalAddresses;
      if (invoiceEl) invoiceEl.textContent = invoiceCount;
      if (deliveryEl) deliveryEl.textContent = deliveryCount;
      if (otherEl) otherEl.textContent = otherCount;
      
      // Teklifbul Rule v1.0 - OpenStreetMap entegrasyonu (Leaflet.js - seÃ§ili adresi gÃ¶ster)
      initializeAddressMap(userData);
    }
    // OpenStreetMap Harita BaÅŸlatma (Leaflet.js) - $0 maliyet
    let addressMapInstance = null;
    
    // OpenStreetMap helper fonksiyonlarÄ±
    async function geocodeAddress(address) {
      try {
        // Cache kontrolÃ¼ (session storage)
        const cacheKey = `geocode:${encodeURIComponent(address)}`;
        const cached = sessionStorage.getItem(cacheKey);
        if (cached) {
          return JSON.parse(cached);
        }
        
        // Nominatim API Ã§aÄŸrÄ±sÄ±
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`,
          {
            headers: {
              'User-Agent': 'Teklifbul/1.0' // Nominatim policy gereÄŸi
            }
          }
        );
        
        if (!response.ok) {
          throw new Error(`Geocoding failed: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.length === 0) {
          return null;
        }
        
        const result = {
          lat: parseFloat(data[0].lat),
          lng: parseFloat(data[0].lon),
          display_name: data[0].display_name
        };
        
        // Cache'e kaydet (session storage - sayfa kapanana kadar)
        sessionStorage.setItem(cacheKey, JSON.stringify(result));
        
        // Rate limiting iÃ§in bekle (1 saniye)
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        return result;
      } catch (error) {
        logger.error('Geocoding error', error);
        return null;
      }
    }
    
    function initializeAddressMap(userData) {
      const mapContainer = document.getElementById('addressMapContainer');
      const verifyBtn = document.getElementById('btnVerifyAddress');
      const defaultDeliverySelect = document.getElementById('defaultDeliveryAddress');
      
      if (!mapContainer) return;
      
      // Teklifbul Rule v1.0 - SeÃ§ili adresi belirle (varsayÄ±lan teslimat adresi veya ana adres)
      const getSelectedAddress = () => {
        const defaultDeliveryAddress = userData.defaultDeliveryAddress || 'main';
        
        // EÄŸer varsayÄ±lan teslimat adresi bir ilave adres ise, onu gÃ¶ster
        if (defaultDeliveryAddress.startsWith('addr_')) {
          const addrIndex = parseInt(defaultDeliveryAddress.replace('addr_', ''));
          const additionalAddresses = userData.additionalAddresses || [];
          if (additionalAddresses[addrIndex] && additionalAddresses[addrIndex].content) {
            // Ä°lave adresin content'ini kullan (zaten formatlanmÄ±ÅŸ adres string'i)
            return additionalAddresses[addrIndex].content;
          }
        }
        
        // Ana adresi kullan (fatura adresi) - structured address parts'ten oluÅŸtur
      const addressPartsData = userData.invoiceAddressParts || {};
      const addressParts = [];
      
      // Structured data varsa onu kullan, yoksa eski formatÄ± kullan
      if (addressPartsData.sokak) {
        addressParts.push(addressPartsData.sokak + (addressPartsData.sokak.includes('Sokak') || addressPartsData.sokak.includes('Cadde') ? '' : ' Sokak'));
      } else if (userData.inv_street) {
        addressParts.push(userData.inv_street);
      }
      
      if (addressPartsData.cadde) {
        addressParts.push(addressPartsData.cadde + (addressPartsData.cadde.includes('Cadde') ? '' : ' Cadde'));
      }
      
      if (addressPartsData.kapiNo) {
        addressParts.push('No: ' + addressPartsData.kapiNo);
      } else if (userData.inv_building) {
        addressParts.push('No: ' + userData.inv_building);
      }
      
      if (addressPartsData.daire) {
        addressParts.push('Daire: ' + addressPartsData.daire);
      } else if (userData.inv_daire) {
        addressParts.push('Daire: ' + userData.inv_daire);
      }
      
      if (addressPartsData.mahalle) {
        addressParts.push(addressPartsData.mahalle + (addressPartsData.mahalle.includes('Mahalle') ? '' : ' Mahalle'));
      }
      
      if (addressPartsData.ilce) {
        addressParts.push(addressPartsData.ilce);
      } else if (userData.inv_district) {
        addressParts.push(userData.inv_district);
      }
      
      if (addressPartsData.il) {
        addressParts.push(addressPartsData.il);
      } else if (userData.inv_city) {
        addressParts.push(userData.inv_city);
      }
      
      if (addressPartsData.postakodu) {
        addressParts.push('PK: ' + addressPartsData.postakodu);
      } else if (userData.inv_postakodu) {
        addressParts.push('PK: ' + userData.inv_postakodu);
      }
      
      // TÃ¼rkiye ekle
      if (addressPartsData.ulke) {
        addressParts.push(addressPartsData.ulke);
      } else {
        addressParts.push('TÃ¼rkiye');
      }
      
        return addressParts.filter(Boolean).join(', ');
      };
      
      const addressString = getSelectedAddress();
      
      // EÄŸer adres Ã§ok eksikse geocoding yapma
      if (!addressString || addressString.trim().length < 5) {
        mapContainer.innerHTML = `
          <div style="padding:20px; text-align:center;">
            <p style="margin:0 0 8px 0; color:#6b7280;">ğŸ“ Adres bilgisi eksik</p>
            <p style="margin:0; font-size:12px; color:#9ca3af;">LÃ¼tfen adres bilgilerini doldurun.</p>
          </div>
        `;
        return;
      }
      
      // Teklifbul Rule v1.0 - Kaydedilen koordinatlarÄ± kontrol et (Ã¶ncelik: kaydedilen koordinatlar)
      const savedCoordinates = (() => {
        const defaultDeliveryAddress = userData.defaultDeliveryAddress || 'main';
        if (defaultDeliveryAddress === 'main') {
          const addressParts = userData.invoiceAddressParts || {};
          if (addressParts.lat && addressParts.lng) {
            return {
              lat: typeof addressParts.lat === 'number' ? addressParts.lat : parseFloat(addressParts.lat),
              lng: typeof addressParts.lng === 'number' ? addressParts.lng : parseFloat(addressParts.lng)
            };
          }
        }
        return null;
      })();
      
      // OpenStreetMap (Leaflet.js) harita yÃ¼kle - kaydedilen koordinatlarÄ± geÃ§
      loadAddressMap(addressString, mapContainer, savedCoordinates);
      
      // Adres doÄŸrulama butonu
      if (verifyBtn) {
        verifyBtn.addEventListener('click', async () => {
          try {
            // Teklifbul Rule v1.0 - SeÃ§ili adresi tekrar al (dropdown deÄŸiÅŸmiÅŸ olabilir)
            const user = await getCurrentUser();
            const updatedUserData = user ? await getUserData(user.uid) : userData;
            const currentSelectedAddress = (() => {
              const defaultDeliveryAddress = updatedUserData.defaultDeliveryAddress || 'main';
              if (defaultDeliveryAddress.startsWith('addr_')) {
                const addrIndex = parseInt(defaultDeliveryAddress.replace('addr_', ''));
                const additionalAddresses = updatedUserData.additionalAddresses || [];
                if (additionalAddresses[addrIndex] && additionalAddresses[addrIndex].content) {
                  return additionalAddresses[addrIndex].content;
                }
              }
              // Ana adresi oluÅŸtur
              const addressPartsData = updatedUserData.invoiceAddressParts || {};
              const parts = [];
              if (addressPartsData.sokak) parts.push(addressPartsData.sokak + (addressPartsData.sokak.includes('Sokak') || addressPartsData.sokak.includes('Cadde') ? '' : ' Sokak'));
              if (addressPartsData.cadde) parts.push(addressPartsData.cadde + (addressPartsData.cadde.includes('Cadde') ? '' : ' Cadde'));
              if (addressPartsData.kapiNo) parts.push('No: ' + addressPartsData.kapiNo);
              if (addressPartsData.daire) parts.push('Daire: ' + addressPartsData.daire);
              if (addressPartsData.mahalle) parts.push(addressPartsData.mahalle + (addressPartsData.mahalle.includes('Mahalle') ? '' : ' Mahalle'));
              if (addressPartsData.ilce) parts.push(addressPartsData.ilce);
              if (addressPartsData.il) parts.push(addressPartsData.il);
              if (addressPartsData.postakodu) parts.push('PK: ' + addressPartsData.postakodu);
              parts.push(addressPartsData.ulke || 'TÃ¼rkiye');
              return parts.filter(Boolean).join(', ');
            })();
            
            // Teklifbul Rule v1.0 - Adres string kontrolÃ¼
            if (!currentSelectedAddress || currentSelectedAddress.trim().length < 5) {
              toast.error(MESSAGES.ERROR_ADDRESS_MISSING);
              return;
            }
            
            // OpenStreetMap geocoding
            const result = await geocodeAddress(currentSelectedAddress);
            
            // Teklifbul Rule v1.0 - EÄŸer geocoding baÅŸarÄ±sÄ±z ama marker varsa, marker konumunu kullan
            if (!result) {
              // Marker varsa ve konumu varsa, onu kullan
              if (addressMapInstance && addressMapInstance.marker) {
                const markerPosition = addressMapInstance.marker.getLatLng();
                if (markerPosition) {
                  // Reverse geocoding yap (marker konumundan adres bul)
                  if (window.reverseGeocode) {
                    const reverseAddress = await window.reverseGeocode(markerPosition.lat, markerPosition.lng);
                    if (reverseAddress) {
                      addressMapInstance.marker.setPopupContent(`<strong>ğŸ“ ${currentSelectedAddress}</strong><br><small>${reverseAddress}</small>`);
                      addressMapInstance.marker.openPopup();
                      toast.success(MESSAGES.SUCCESS_ADDRESS_VERIFIED + ': ' + reverseAddress);
                      return;
                    }
                  }
                  // Reverse geocoding baÅŸarÄ±sÄ±z, sadece koordinat gÃ¶ster
                  addressMapInstance.marker.setPopupContent(`<strong>ğŸ“ ${currentSelectedAddress}</strong><br><small>Koordinat: ${markerPosition.lat.toFixed(6)}, ${markerPosition.lng.toFixed(6)}</small>`);
                  addressMapInstance.marker.openPopup();
                  toast.success(MESSAGES.SUCCESS_ADDRESS_VERIFIED);
                  return;
                }
              }
              
              // Marker yoksa veya konumu yoksa uyarÄ± gÃ¶ster
              toast.warn(MESSAGES.WARN_ADDRESS_NOT_FOUND);
              // Harita yoksa yeniden yÃ¼kle (manuel marker koyma imkanÄ± ile) - kaydedilen koordinatlarÄ± kontrol et
              if (!addressMapInstance || !addressMapInstance.map) {
                const user = await getCurrentUser();
                if (user) {
                  const userData = await getUserData(user.uid);
                  const savedCoords = userData.invoiceAddressParts?.lat && userData.invoiceAddressParts?.lng
                    ? { lat: userData.invoiceAddressParts.lat, lng: userData.invoiceAddressParts.lng }
                    : null;
                  loadAddressMap(currentSelectedAddress, mapContainer, savedCoords);
                } else {
                  loadAddressMap(currentSelectedAddress, mapContainer);
                }
              }
              return;
            }
            
            // HaritayÄ± bulunan konuma kaydÄ±r
            if (addressMapInstance && addressMapInstance.map) {
              addressMapInstance.map.setView([result.lat, result.lng], 15);
              
              // Marker'Ä± gÃ¼ncelle veya oluÅŸtur (draggable)
              if (addressMapInstance.marker) {
                addressMapInstance.marker.setLatLng([result.lat, result.lng]);
                addressMapInstance.marker.setPopupContent(`<strong>ğŸ“ ${currentSelectedAddress}</strong><br><small>${result.display_name}</small>`);
                addressMapInstance.marker.openPopup();
              } else {
                // Yeni marker oluÅŸtur (draggable)
                addressMapInstance.marker = L.marker([result.lat, result.lng], { draggable: true })
                  .addTo(addressMapInstance.map)
                  .bindPopup(`<strong>ğŸ“ ${currentSelectedAddress}</strong><br><small>${result.display_name}</small>`)
                  .openPopup();
                
                // Marker sÃ¼rÃ¼klendiÄŸinde reverse geocoding
                addressMapInstance.marker.on('dragend', async function(e) {
                  const position = addressMapInstance.marker.getLatLng();
                  if (window.reverseGeocode) {
                    const reverseAddress = await window.reverseGeocode(position.lat, position.lng);
                    if (reverseAddress) {
                      addressMapInstance.marker.setPopupContent(`<strong>ğŸ“ Konum</strong><br><small>${reverseAddress}</small>`);
                      addressMapInstance.marker.openPopup();
                      toast.success(MESSAGES.SUCCESS_LOCATION_UPDATED + ': ' + reverseAddress);
                    }
                  }
                });
              }
              
              toast.success(MESSAGES.SUCCESS_ADDRESS_VERIFIED_ALT);
            } else {
              // Harita yoksa yeniden yÃ¼kle - kaydedilen koordinatlarÄ± kontrol et
              const user = await getCurrentUser();
              if (user) {
                const userData = await getUserData(user.uid);
                const savedCoords = userData.invoiceAddressParts?.lat && userData.invoiceAddressParts?.lng
                  ? { lat: userData.invoiceAddressParts.lat, lng: userData.invoiceAddressParts.lng }
                  : null;
                loadAddressMap(currentSelectedAddress, mapContainer, savedCoords);
              } else {
                loadAddressMap(currentSelectedAddress, mapContainer);
              }
            }
          } catch (err) {
            logger.error('Adres doÄŸrulama hatasÄ±', err);
            toast.error(MESSAGES.ERROR_ADDRESS_VERIFY + ': ' + (err.message || 'Bilinmeyen hata'));
          }
        });
      }
    }
    // Harita YÃ¼kleme Fonksiyonu (OpenStreetMap - Leaflet.js)
    // savedCoordinates: {lat, lng} - Kaydedilen koordinatlar (Ã¶ncelikli)
    async function loadAddressMap(addressString, mapContainer, savedCoordinates = null) {
      try {
        // Teklifbul Rule v1.0 - Adres string'i boÅŸsa geocoding yapma
        if (!addressString || addressString.trim().length < 5) {
          mapContainer.innerHTML = `
            <div style="padding:20px; text-align:center;">
              <p style="margin:0 0 8px 0; color:#6b7280;">ğŸ“ Adres bilgisi eksik</p>
              <p style="margin:0; font-size:12px; color:#9ca3af;">LÃ¼tfen adres bilgilerini doldurun.</p>
            </div>
          `;
          return;
        }
        
        // Leaflet.js kontrolÃ¼
        if (typeof L === 'undefined') {
          mapContainer.innerHTML = `
            <div style="padding:20px; text-align:center;">
              <p style="margin:0 0 8px 0; color:#6b7280;">ğŸ“ Adres: ${addressString}</p>
              <p style="margin:0; font-size:12px; color:#dc2626;">âš ï¸ Leaflet.js yÃ¼klenemedi. LÃ¼tfen sayfayÄ± yenileyin.</p>
            </div>
          `;
          return;
        }
        
        // Teklifbul Rule v1.0 - Mevcut harita instance'Ä±nÄ± temizle (Map container is already initialized hatasÄ±nÄ± Ã¶nlemek iÃ§in)
        if (addressMapInstance && addressMapInstance.map) {
          try {
            addressMapInstance.map.remove();
            addressMapInstance = null;
          } catch (removeErr) {
            logger.warn('Mevcut harita temizlenirken hata', removeErr);
          }
        }
        
        // Container'Ä± tamamen temizle (Leaflet'in DOM'da bÄ±raktÄ±ÄŸÄ± elementleri de temizle)
        mapContainer.innerHTML = '';
        
        // Container'Ä± loading gÃ¶ster
        mapContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#6b7280;">ğŸ“ Harita yÃ¼kleniyor...</div>';
        
        // Teklifbul Rule v1.0 - Ã–ncelik: Kaydedilen koordinatlar, yoksa geocoding
        let geocodeResult = null;
        
        if (savedCoordinates && savedCoordinates.lat && savedCoordinates.lng) {
          // Kaydedilen koordinatlarÄ± kullan (geocoding yapma)
          logger.info('Kaydedilen koordinatlar kullanÄ±lÄ±yor', savedCoordinates);
          geocodeResult = {
            lat: savedCoordinates.lat,
            lng: savedCoordinates.lng,
            display_name: addressString // Adres string'ini display name olarak kullan
          };
        } else {
          // Geocoding yap (kaydedilen koordinat yoksa)
          try {
            geocodeResult = await geocodeAddress(addressString);
          } catch (err) {
            logger.warn('Geocoding hatasÄ± (harita yine de gÃ¶sterilecek)', err);
          }
        }
        
        // Container'Ä± temizle (harita iÃ§in hazÄ±r)
        mapContainer.innerHTML = '';
        
        // Harita oluÅŸtur
        const defaultLat = geocodeResult ? geocodeResult.lat : 41.0082; // Ä°stanbul default
        const defaultLng = geocodeResult ? geocodeResult.lng : 28.9784;
        const defaultZoom = geocodeResult ? 15 : 13;
        
        const map = L.map(mapContainer).setView([defaultLat, defaultLng], defaultZoom);
        
        // OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }).addTo(map);
        
        let marker = null;
        
        // Reverse geocoding fonksiyonu (koordinattan adres bulma) - global eriÅŸim iÃ§in
        // Google Maps benzeri doÄŸruluk iÃ§in detaylÄ± adres bilgisi dÃ¶ndÃ¼rÃ¼r
        window.reverseGeocode = async function(lat, lng) {
          try {
            // Rate limiting iÃ§in bekle (1 saniye)
            await new Promise(resolve => setTimeout(resolve, 1000));
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=tr`,
              {
                headers: {
                  'User-Agent': 'Teklifbul/1.0'
                }
              }
            );
            if (!response.ok) return null;
            const data = await response.json();
            
            if (!data || !data.address) {
              return data.display_name || null;
            }
            
            // DetaylÄ± adres bilgisi oluÅŸtur (Google Maps benzeri)
            const addr = data.address;
            const parts = [];
            
            // Sokak/Cadde
            if (addr.road) parts.push(addr.road);
            else if (addr.pedestrian) parts.push(addr.pedestrian);
            else if (addr.path) parts.push(addr.path);
            
            // Bina numarasÄ±
            if (addr.house_number) parts.push('No: ' + addr.house_number);
            
            // Mahalle
            if (addr.suburb) parts.push(addr.suburb);
            else if (addr.neighbourhood) parts.push(addr.neighbourhood);
            else if (addr.quarter) parts.push(addr.quarter);
            
            // Ä°lÃ§e
            if (addr.city_district) parts.push(addr.city_district);
            else if (addr.district) parts.push(addr.district);
            
            // Ä°lÃ§e (alternatif)
            if (addr.municipality && !parts.includes(addr.municipality)) {
              parts.push(addr.municipality);
            }
            
            // Ä°l
            if (addr.state) parts.push(addr.state);
            else if (addr.region) parts.push(addr.region);
            
            // Posta kodu
            if (addr.postcode) parts.push('PK: ' + addr.postcode);
            
            // Ãœlke
            if (addr.country) {
              const countryName = addr.country === 'Turkey' ? 'TÃ¼rkiye' : addr.country;
              parts.push(countryName);
            }
            
            // EÄŸer detaylÄ± adres oluÅŸturulamadÄ±ysa, display_name kullan
            const detailedAddress = parts.length > 0 ? parts.join(', ') : data.display_name;
            
            return detailedAddress || data.display_name || null;
          } catch (error) {
            logger.error('Reverse geocoding error', error);
            return null;
          }
        };
        
        const reverseGeocode = window.reverseGeocode;
        
        // Marker oluÅŸturma fonksiyonu (draggable)
        function createOrUpdateMarker(lat, lng, addressText = null) {
          if (marker) {
            marker.setLatLng([lat, lng]);
            if (addressText) {
              marker.setPopupContent(`<strong>ğŸ“ Konum</strong><br><span style="font-size:12px; color:#6b7280;">${addressText}</span>`);
            }
            marker.openPopup();
          } else {
            marker = L.marker([lat, lng], { draggable: true })
              .addTo(map)
              .bindPopup(`<strong>ğŸ“ Konum</strong><br><span style="font-size:12px; color:#6b7280;">${addressText || 'Konum seÃ§ildi'}</span>`)
              .openPopup();
            
            // Marker sÃ¼rÃ¼klendiÄŸinde reverse geocoding yap
            marker.on('dragstart', function() {
              marker.setPopupContent(`<strong>ğŸ“ Konum</strong><br><span style="font-size:12px; color:#6b7280;">ğŸ“ SÃ¼rÃ¼kleniyor...</span>`);
              marker.openPopup();
            });
            
            marker.on('dragend', async function(e) {
              const position = marker.getLatLng();
              marker.setPopupContent(`<strong>ğŸ“ Konum</strong><br><span style="font-size:12px; color:#6b7280;">ğŸ“ Adres bulunuyor...</span>`);
              marker.openPopup();
              
              const reverseAddress = await reverseGeocode(position.lat, position.lng);
              if (reverseAddress) {
                marker.setPopupContent(`<strong>ğŸ“ Konum</strong><br><span style="font-size:12px; color:#6b7280;">${reverseAddress}</span>`);
                marker.openPopup();
                toast.success(MESSAGES.SUCCESS_LOCATION_UPDATED + ': ' + reverseAddress);
          } else {
                marker.setPopupContent(`<strong>ğŸ“ Konum</strong><br><span style="font-size:12px; color:#6b7280;">Lat: ${position.lat.toFixed(6)}, Lng: ${position.lng.toFixed(6)}</span>`);
                marker.openPopup();
                toast.success(MESSAGES.SUCCESS_LOCATION_UPDATED + ' (Koordinat: ' + position.lat.toFixed(6) + ', ' + position.lng.toFixed(6) + ')');
              }
            });
          }
        }
        
        if (geocodeResult) {
          // Geocoding baÅŸarÄ±lÄ± veya kaydedilen koordinat kullanÄ±ldÄ± - marker ekle
          // Kaydedilen koordinat kullanÄ±ldÄ±ysa sadece adres gÃ¶ster, geocoding sonucu varsa detaylÄ± gÃ¶ster
          const displayText = savedCoordinates && savedCoordinates.lat && savedCoordinates.lng
            ? `${addressString}` // Kaydedilen koordinat kullanÄ±ldÄ±ysa sadece adres gÃ¶ster
            : (geocodeResult.display_name && geocodeResult.display_name !== addressString
                ? `${addressString}<br><small>${geocodeResult.display_name}</small>` // Geocoding sonucu varsa detaylÄ± gÃ¶ster
                : `${addressString}`); // Display name yoksa sadece adres
          createOrUpdateMarker(geocodeResult.lat, geocodeResult.lng, displayText);
        } else {
          // Adres bulunamadÄ± - haritayÄ± gÃ¶ster ve manuel marker koyma imkanÄ± ver
          const infoDiv = document.createElement('div');
          infoDiv.style.cssText = 'position:absolute; top:10px; left:10px; z-index:1000; background:white; padding:12px; border-radius:6px; box-shadow:0 2px 4px rgba(0,0,0,0.2); max-width:320px;';
          infoDiv.innerHTML = `
            <p style="margin:0 0 8px 0; color:#6b7280; font-weight:600;">ğŸ“ Adres: ${addressString}</p>
            <p style="margin:0 0 8px 0; font-size:12px; color:#9ca3af;">Adres otomatik bulunamadÄ±. Haritaya tÄ±klayarak konumu manuel seÃ§ebilirsiniz.</p>
            <p style="margin:0; font-size:11px; color:#3b82f6; font-weight:600;">ğŸ’¡ Haritaya tÄ±klayÄ±n veya marker'Ä± sÃ¼rÃ¼kleyin</p>
          `;
          mapContainer.appendChild(infoDiv);
          
          // VarsayÄ±lan konumda marker oluÅŸtur (draggable)
          createOrUpdateMarker(defaultLat, defaultLng, addressString);
        }
        
        // Haritaya tÄ±klayÄ±nca marker koy
        map.on('click', async function(e) {
          const { lat, lng } = e.latlng;
          // Loading gÃ¶ster
          toast.info(MESSAGES.INFO_LOCATION_FOUND);
          
          const reverseAddress = await reverseGeocode(lat, lng);
          createOrUpdateMarker(lat, lng, reverseAddress || `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`);
          
          if (reverseAddress) {
            toast.success(MESSAGES.SUCCESS_LOCATION_SELECTED + ': ' + reverseAddress);
          } else {
            toast.success(MESSAGES.SUCCESS_LOCATION_SELECTED + ' (Koordinat: ' + lat.toFixed(6) + ', ' + lng.toFixed(6) + ')');
          }
        });
        
        // Instance'Ä± sakla
        addressMapInstance = { map, marker, getMarkerPosition: () => marker ? marker.getLatLng() : null };
      } catch (err) {
        logger.error('Harita yÃ¼kleme hatasÄ±', err);
        toast.error(MESSAGES.ERROR_MAP_LOAD + ': ' + (err.message || 'Bilinmeyen hata'));
        mapContainer.innerHTML = `
          <div style="padding:20px; text-align:center;">
            <p style="margin:0; font-size:12px; color:#dc2626;">âŒ Harita yÃ¼klenirken hata oluÅŸtu: ${err.message || 'Bilinmeyen hata'}</p>
          </div>
        `;
      }
    }
    
    
    // Adres DÃ¼zenleme Fonksiyonu
    // Teklifbul Rule v1.0 - KullanÄ±cÄ± dostu adres dÃ¼zenleme
    async function editAddress(index) {
      try {
        const user = await getCurrentUser();
        const { doc, getDoc, updateDoc, serverTimestamp } = await getFirestoreModules();
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (!userDoc.exists()) return;
        
        const userData = userDoc.data();
        const additionalAddresses = userData.additionalAddresses || [];
        
        if (index < 0 || index >= additionalAddresses.length) {
          toast.error(MESSAGES.ERROR_INVALID_ADDRESS_INDEX);
          return;
        }
        
        const address = additionalAddresses[index];
        
        // Modal ile dÃ¼zenleme (basit form)
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:10000; display:flex; align-items:center; justify-content:center;';
        
        modal.innerHTML = `
          <div style="background:white; padding:24px; border-radius:12px; max-width:500px; width:90%; max-height:90vh; overflow-y:auto;">
            <h3 style="margin:0 0 20px 0; font-size:18px; color:#1f2937;">âœï¸ Adres DÃ¼zenle</h3>
            <div style="display:flex; flex-direction:column; gap:12px;">
              <div>
                <label style="display:block; margin-bottom:6px; font-weight:600; color:#374151;">Adres BaÅŸlÄ±ÄŸÄ± *</label>
                <input type="text" id="editTitle" value="${address.title || getAddressTypeLabel(address.type) || 'Adres'}" placeholder="Ã–rn: Merkez Ofis, Åube, Depo" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;" required>
                <p style="margin:4px 0 0 0; font-size:11px; color:#6b7280;">Bu baÅŸlÄ±k adres listesinde gÃ¶rÃ¼necektir</p>
              </div>
              <div>
                <label style="display:block; margin-bottom:6px; font-weight:600; color:#374151;">Sokak/Cadde *</label>
                <input type="text" id="editStreet" value="${address.street || ''}" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;" required>
              </div>
              <div>
                <label style="display:block; margin-bottom:6px; font-weight:600; color:#374151;">Bina No</label>
                <input type="text" id="editBuilding" value="${address.building || ''}" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
              </div>
              <div>
                <label style="display:block; margin-bottom:6px; font-weight:600; color:#374151;">KapÄ± No</label>
                <input type="text" id="editKapi" value="${address.kapi || ''}" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
              </div>
              <div>
                <label style="display:block; margin-bottom:6px; font-weight:600; color:#374151;">Daire</label>
                <input type="text" id="editDaire" value="${address.daire || ''}" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
              </div>
              <div>
                <label style="display:block; margin-bottom:6px; font-weight:600; color:#374151;">Ä°lÃ§e *</label>
                <input type="text" id="editDistrict" value="${address.district || ''}" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;" required>
              </div>
              <div>
                <label style="display:block; margin-bottom:6px; font-weight:600; color:#374151;">Åehir *</label>
                <input type="text" id="editCity" value="${address.city || ''}" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;" required>
              </div>
              <div>
                <label style="display:block; margin-bottom:6px; font-weight:600; color:#374151;">Posta Kodu</label>
                <input type="text" id="editPostakodu" value="${address.postakodu || ''}" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
              </div>
              <div>
                <label style="display:block; margin-bottom:6px; font-weight:600; color:#374151;">Adres TÃ¼rÃ¼</label>
                <select id="editType" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
                  <option value="invoice" ${address.type === 'invoice' ? 'selected' : ''}>Fatura Adresi</option>
                  <option value="delivery" ${address.type === 'delivery' ? 'selected' : ''}>Teslimat Adresi</option>
                  <option value="other" ${address.type === 'other' ? 'selected' : ''}>DiÄŸer</option>
                </select>
              </div>
            </div>
            <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">
              <button type="button" id="cancelEditBtn" style="padding:10px 20px; background:#e5e7eb; color:#374151; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Ä°ptal</button>
              <button type="button" id="saveEditBtn" style="padding:10px 20px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Kaydet</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Ä°ptal butonu
        modal.querySelector('#cancelEditBtn').addEventListener('click', () => {
          document.body.removeChild(modal);
        });
        
        // Modal dÄ±ÅŸÄ±na tÄ±klama ile kapat
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
          }
        });
        
        // Kaydet butonu
        modal.querySelector('#saveEditBtn').addEventListener('click', async () => {
          const street = modal.querySelector('#editStreet').value.trim();
          const city = modal.querySelector('#editCity').value.trim();
          const district = modal.querySelector('#editDistrict').value.trim();
          
          if (!street || !city || !district) {
            toast.error(MESSAGES.ERROR_REQUIRED_FIELDS_ADDRESS);
            return;
          }
          
          try {
            const title = modal.querySelector('#editTitle').value.trim();
            if (!title) {
              toast.error(MESSAGES.ERROR_ADDRESS_TITLE_REQUIRED);
              return;
            }
            
            // Adresi gÃ¼ncelle - title ve structured fields dahil
            additionalAddresses[index] = {
              ...address,
              title: title,
              street: street,
              building: modal.querySelector('#editBuilding').value.trim() || undefined,
              kapi: modal.querySelector('#editKapi').value.trim() || undefined,
              daire: modal.querySelector('#editDaire').value.trim() || undefined,
              district: district,
              city: city,
              postakodu: modal.querySelector('#editPostakodu').value.trim() || undefined,
              type: modal.querySelector('#editType').value
            };
            
            await updateDoc(doc(db, 'users', user.uid), {
              additionalAddresses: additionalAddresses,
              updatedAt: serverTimestamp()
            });
            
            document.body.removeChild(modal);
            toast.success(MESSAGES.SUCCESS_ADDRESS_UPDATED);
            await loadAddressesPage(); // SayfayÄ± yenile
          } catch (err) {
            logger.error('Adres gÃ¼ncelleme hatasÄ±', err);
            toast.error(MESSAGES.ERROR_ADDRESS_UPDATE + ': ' + err.message);
          }
        });
      } catch (err) {
        logger.error('Adres dÃ¼zenleme hatasÄ±', err);
        toast.error(MESSAGES.ERROR_ADDRESS_EDIT + ': ' + err.message);
      }
    }
    
    // Adres Silme Fonksiyonu
    async function deleteAddress(index) {
      try {
        if (!confirm('âš ï¸ Bu adresi silmek istediÄŸinizden emin misiniz?')) {
          return;
        }
        
        const user = await getCurrentUser();
        const { doc, getDoc, updateDoc, serverTimestamp } = await getFirestoreModules();
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (!userDoc.exists()) return;
        
        const userData = userDoc.data();
        const additionalAddresses = userData.additionalAddresses || [];
        
        if (index < 0 || index >= additionalAddresses.length) {
          toast.error(MESSAGES.ERROR_INVALID_ADDRESS_INDEX);
          return;
        }
        
        // Adresi kaldÄ±r
        additionalAddresses.splice(index, 1);
        
        await updateDoc(doc(db, 'users', user.uid), {
          additionalAddresses: additionalAddresses,
          updatedAt: serverTimestamp()
        });
        
        toast.success(MESSAGES.SUCCESS_ADDRESS_DELETED);
        await loadAddressesPage(); // SayfayÄ± yenile
      } catch (err) {
        logger.error('Adres silme hatasÄ±', err);
        toast.error(MESSAGES.ERROR_ADDRESS_DELETE + ': ' + err.message);
      }
    }
    // Åirket Profili SayfasÄ± YÃ¼kleme
    async function loadCompanyProfilePage() {
      try {
        const user = await getCurrentUser();
        const { doc, getDoc, collection, query, where, getDocs } = await getFirestoreModules();
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (!userDoc.exists()) return;
        
        const userData = userDoc.data();
        const companyId = userData.companyId || (userData.companies && userData.companies[0]);
        if (!companyId) return;
        
        // Åirket bilgilerini yÃ¼kle
        const companyDoc = await getDoc(doc(db, 'companies', companyId));
        if (companyDoc.exists()) {
          const companyData = companyDoc.data();
          
          // Web sitesi ve Google Business bilgilerini yÃ¼kle
          if (companyData.website) {
            document.getElementById('companyProfile_website').value = companyData.website;
          }
          if (companyData.googleBusinessUrl) {
            document.getElementById('companyProfile_googleBusiness').value = companyData.googleBusinessUrl;
          }
        }
        
        // BaÅŸarÄ±lÄ± ticaret geÃ§miÅŸini yÃ¼kle
        await loadSuccessfulTradePartners(companyId);
        
        // YorumlarÄ± yÃ¼kle (gelecekte implement edilecek)
        // await loadCompanyReviews(companyId);
      } catch (e) {
        logger.error('Åirket profili yÃ¼kleme hatasÄ±', e);
      }
    }
    
    // BaÅŸarÄ±lÄ± Ticaret OrtaklarÄ±nÄ± YÃ¼kle
    async function loadSuccessfulTradePartners(companyId) {
      try {
        const partnersContainer = document.getElementById('successfulTradePartners');
        if (!partnersContainer) return;
        
        partnersContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#6b7280;"><p>YÃ¼kleniyor...</p></div>';
        
        // KullanÄ±cÄ±larÄ± sorgula (hem companies array hem de companyId field)
        const { collection, query, where, getDocs, doc, getDoc } = await getFirestoreModules();
        const usersRef = collection(db, 'users');
        const usersQuery1 = query(usersRef, where('companies', 'array-contains', companyId));
        const usersQuery2 = query(usersRef, where('companyId', '==', companyId));
        
        const [usersSnapshot1, usersSnapshot2] = await Promise.all([
          getDocs(usersQuery1).catch(() => ({ docs: [] })),
          getDocs(usersQuery2).catch(() => ({ docs: [] }))
        ]);
        
        const allUserIds = new Set();
        [...usersSnapshot1.docs, ...usersSnapshot2.docs].forEach(doc => {
          allUserIds.add(doc.id);
        });
        
        // Bu ÅŸirketin alÄ±cÄ± olduÄŸu talepleri bul
        const demandsRef = collection(db, 'demands');
        const demandsQuery = query(
          demandsRef,
          where('companyId', '==', companyId),
          where('status', 'in', ['completed', 'accepted'])
        );
        const demandsSnapshot = await getDocs(demandsQuery);
        
        // Bu ÅŸirketin tedarikÃ§i olduÄŸu teklifleri bul
        const bidsRef = collection(db, 'bids');
        const bidsQuery = query(
          bidsRef,
          where('supplierCompanyId', '==', companyId),
          where('status', 'in', ['accepted', 'approved'])
        );
        const bidsSnapshot = await getDocs(bidsQuery);
        // Partner ÅŸirketleri topla
        const partnerCompanyIds = new Set();
        
        // Taleplerden tedarikÃ§i ÅŸirketleri al
        demandsSnapshot.docs.forEach(demandDoc => {
          const demandData = demandDoc.data();
          if (demandData.acceptedBidId) {
            // Accepted bid'i bulup supplier company ID'sini al
            bidsSnapshot.docs.forEach(bidDoc => {
              if (bidDoc.id === demandData.acceptedBidId) {
                const bidData = bidDoc.data();
                if (bidData.supplierCompanyId && bidData.supplierCompanyId !== companyId) {
                  partnerCompanyIds.add(bidData.supplierCompanyId);
                }
              }
            });
          }
        });
        
        // Tekliflerden alÄ±cÄ± ÅŸirketleri al
        for (const bidDoc of bidsSnapshot.docs) {
          const bidData = bidDoc.data();
          if (bidData.demandId) {
            const demandDoc = await getDoc(doc(db, 'demands', bidData.demandId));
            if (demandDoc.exists()) {
              const demandData = demandDoc.data();
              if (demandData.companyId && demandData.companyId !== companyId) {
                partnerCompanyIds.add(demandData.companyId);
              }
            }
          }
        }
        
        // Partner ÅŸirket bilgilerini yÃ¼kle
        const partners = [];
        for (const partnerCompanyId of partnerCompanyIds) {
          const partnerCompanyDoc = await getDoc(doc(db, 'companies', partnerCompanyId));
          if (partnerCompanyDoc.exists()) {
            partners.push({
              id: partnerCompanyId,
              name: partnerCompanyDoc.data().companyName || 'Bilinmeyen Åirket',
              data: partnerCompanyDoc.data()
            });
          }
        }
        
        // UI'Ä± gÃ¼ncelle
        if (partners.length === 0) {
          partnersContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#6b7280;"><p>HenÃ¼z baÅŸarÄ±lÄ± ticaret yapÄ±lan firma bulunmamaktadÄ±r.</p></div>';
        } else {
          partnersContainer.innerHTML = partners.map(partner => `
            <div style="padding:16px; background:white; border-radius:8px; border:1px solid #e5e7eb; cursor:pointer; transition:all 0.2s;" 
                 onclick="location.href='./company-profile.html?companyId=${partner.id}'">
              <div style="font-weight:600; color:#1f2937; margin-bottom:4px;">${partner.name}</div>
              <div style="font-size:12px; color:#6b7280;">Firma profiline git â†’</div>
            </div>
          `).join('');
        }
      } catch (e) {
        logger.error('BaÅŸarÄ±lÄ± ticaret ortaklarÄ± yÃ¼kleme hatasÄ±', e);
        const partnersContainer = document.getElementById('successfulTradePartners');
        if (partnersContainer) {
          partnersContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#dc2626;"><p>YÃ¼kleme sÄ±rasÄ±nda bir hata oluÅŸtu.</p></div>';
        }
      }
    }
    
    // Åirket Profili Kaydetme Fonksiyonu
    async function saveCompanyProfile() {
      const btn = document.getElementById('btnSaveCompanyProfile');
      if (!btn) return;
      
      btn.addEventListener('click', async () => {
        try {
          const user = await getCurrentUser();
          const { doc, getDoc, updateDoc, serverTimestamp } = await getFirestoreModules();
          const userDoc = await getDoc(doc(db, 'users', user.uid));
          if (!userDoc.exists()) {
            toast.error(MESSAGES.ERROR_USER_INFO_NOT_FOUND);
            return;
          }
          
          const userData = userDoc.data();
          const companyId = userData.companyId || (userData.companies && userData.companies[0]);
          if (!companyId) {
            toast.error(MESSAGES.ERROR_COMPANY_INFO_NOT_FOUND);
            return;
          }
          
          const website = document.getElementById('companyProfile_website')?.value?.trim() || null;
          const googleBusinessUrl = document.getElementById('companyProfile_googleBusiness')?.value?.trim() || null;
          
          // Åirket bilgilerini gÃ¼ncelle
          const companyRef = doc(db, 'companies', companyId);
          await updateDoc(companyRef, {
            website: website,
            googleBusinessUrl: googleBusinessUrl,
            updatedAt: serverTimestamp()
          });
          
          logger.info('Åirket profili kaydedildi');
          toast.success(MESSAGES.SUCCESS_PROFILE_SAVED);
        } catch (e) {
          logger.error('Åirket profili kaydetme hatasÄ±', e);
          toast.error(MESSAGES.ERROR_SAVE + ': ' + (e.message || e));
        }
      });
    }
    
    // Sayfa yÃ¼klendiÄŸinde navigasyonu baÅŸlat
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initSettingsNavigation();
        saveCompanyProfile();
      });
    } else {
      initSettingsNavigation();
      saveCompanyProfile();
    }
    
    // Onay PolitikasÄ± KonfigÃ¼rasyonu - Teklifbul Rol & Onay Sistemi
    const approvalPolicy = {
      require_at_least_one_top_approver: true,
      top_approver_roles: [
        'buyer:genel_mudur',
        'buyer:genel_mudur_yardimcisi',
        'buyer:ceo',
        'buyer:isveren',
        'buyer:yonetim_kurulu_baskani',
        'buyer:yonetim_kurulu_uyesi'
      ],
      reminder_hours: [24, 48],
      strict_top_required: false,
      allowed_final_approver_roles: ['buyer:genel_mudur']
    };
    
    // CRITICAL: Import new ID-based category system
    import { getAllCategories, getNameById, normalizeToIds } from "./src/categories/category-service.js";
    
    // Legacy import (for backward compatibility)
    import { CATEGORIES } from "./categories.js";

    // === Auth helper: requireAuth yerine ===
    // Teklifbul Rule v1.0 - Auth ready olana kadar bekle
    async function waitAuthReady() {
      // Mevcut kullanÄ±cÄ± varsa direkt dÃ¶n
      if (auth.currentUser) return auth.currentUser;
      
      // Auth state zaten hazÄ±rsa (ama currentUser henÃ¼z set edilmemiÅŸ olabilir)
      // KÄ±sa bir sÃ¼re bekle
      await new Promise(resolve => setTimeout(resolve, 100));
      if (auth.currentUser) return auth.currentUser;
      
      // Auth state deÄŸiÅŸikliÄŸini bekle - use cached Firebase modules
      const { onAuthStateChanged } = await getAuthModules();
      return await new Promise((resolve) => {
        let resolved = false;
        const unsub = onAuthStateChanged(auth, (user) => {
          if (resolved) return;
          resolved = true;
          unsub();
          resolve(user); // null olabilir, hata fÄ±rlatma
        });
        // 3 saniye timeout (daha kÄ±sa)
        setTimeout(() => {
          if (!resolved) {
            resolved = true;
            unsub();
            resolve(null);
          }
        }, 3000);
      });
    }
    
    async function getCurrentUser() {
      if (auth.currentUser) return auth.currentUser;
      // Auth ready olana kadar bekle
      const user = await waitAuthReady();
      if (!user) {
        throw new Error("not signed in");
      }
      return user;
    }
    
    // Teklifbul Rule v1.0 - Global scope'a ekle (loadAndSetupApprovalPolicyManagement'dan eriÅŸilebilir olmasÄ± iÃ§in)
    window.getCurrentUser = getCurrentUser;

    // Global deÄŸiÅŸkenler
    let emails = new Set();
    let phones = new Set();
    let additionalAddresses = [];

    // === Additional Addresses System ===
    // --- TR provinces (minimal local list; can be extended or loaded from Firestore) ---
    const TR_PROVINCES = [
      "Adana","AdÄ±yaman","Afyonkarahisar","AÄŸrÄ±","Amasya","Ankara","Antalya","Artvin","AydÄ±n","BalÄ±kesir","Bilecik","BingÃ¶l","Bitlis","Bolu","Burdur","Bursa","Ã‡anakkale","Ã‡ankÄ±rÄ±","Ã‡orum","Denizli","DiyarbakÄ±r","Edirne","ElazÄ±ÄŸ","Erzincan","Erzurum","EskiÅŸehir","Gaziantep","Giresun","GÃ¼mÃ¼ÅŸhane","Hakkari","Hatay","Isparta","Mersin","Ä°stanbul","Ä°zmir","Kars","Kastamonu","Kayseri","KÄ±rklareli","KÄ±rÅŸehir","Kocaeli","Konya","KÃ¼tahya","Malatya","Manisa","KahramanmaraÅŸ","Mardin","MuÄŸla","MuÅŸ","NevÅŸehir","NiÄŸde","Ordu","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas","TekirdaÄŸ","Tokat","Trabzon","Tunceli","ÅanlÄ±urfa","UÅŸak","Van","Yozgat","Zonguldak","Aksaray","Bayburt","Karaman","KÄ±rÄ±kkale","Batman","ÅÄ±rnak","BartÄ±n","Ardahan","IÄŸdÄ±r","Yalova","KarabÃ¼k","Kilis","Osmaniye","DÃ¼zce"
    ];

const BUYER_ROLE_OPTIONS = [
  // YÃ¶netim Rolleri
  { key: 'buyer:genel_mudur', value: 'genel_mudur', label: 'Genel MÃ¼dÃ¼r', multi: false },
  { key: 'buyer:genel_mudur_yardimcisi', value: 'genel_mudur_yardimcisi', label: 'Genel MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±', multi: false },
  { key: 'buyer:ceo', value: 'ceo', label: 'CEO', multi: false },
  { key: 'buyer:isveren', value: 'isveren', label: 'Ä°ÅŸveren (Åirket Sahibi)', multi: false },
  { key: 'buyer:yonetim_kurulu_baskani', value: 'yonetim_kurulu_baskani', label: 'YÃ¶netim Kurulu BaÅŸkanÄ±', multi: false },
  { key: 'buyer:yonetim_kurulu_uyesi', value: 'yonetim_kurulu_uyesi', label: 'YÃ¶netim Kurulu Ãœyesi', multi: false },
  // SatÄ±n Alma Rolleri
  { key: 'buyer:satinalma_muduru', value: 'satinalma_muduru', label: 'SatÄ±n Alma MÃ¼dÃ¼rÃ¼', multi: false },
  { key: 'buyer:satinalma_yetkilisi', value: 'satinalma_yetkilisi', label: 'SatÄ±n Alma Yetkilisi', multi: true },
  { key: 'buyer:satinalma_uzmani', value: 'satinalma_uzmani', label: 'SatÄ±n Alma UzmanÄ±', multi: true },
  { key: 'buyer:satinalma_uzman_yardimcisi', value: 'satinalma_uzman_yardimcisi', label: 'SatÄ±n Alma Uzman YardÄ±mcÄ±sÄ±', multi: true },
  // DiÄŸer Roller
  { key: 'buyer:santiye_yetkilisi', value: 'santiye_yetkilisi', label: 'Åantiye Yetkilisi', multi: true },
  { key: 'buyer:stok_depo', value: 'stok_depo', label: 'Stok / Depo Yetkilisi', multi: true },
  { key: 'buyer:muhasebe', value: 'muhasebe', label: 'Muhasebe', multi: true },
  { key: 'buyer:alici', value: 'alici', label: 'AlÄ±cÄ±', multi: true }
];

const SUPPLIER_ROLE_OPTIONS = [
  { key: 'supplier:satis_personeli', value: 'satis_personeli', label: 'SatÄ±ÅŸ Personeli', multi: true },
  { key: 'supplier:pazarlama_muduru', value: 'pazarlama_muduru', label: 'Pazarlama MÃ¼dÃ¼rÃ¼', multi: false },
  { key: 'supplier:genel_mudur', value: 'genel_mudur', label: 'Genel MÃ¼dÃ¼r', multi: false },
  { key: 'supplier:yonetim_kurulu_baskani', value: 'yonetim_kurulu_baskani', label: 'YÃ¶netim Kurulu BaÅŸkanÄ±', multi: false },
  { key: 'supplier:ceo', value: 'ceo', label: 'CEO', multi: false },
  { key: 'supplier:sirket_sahibi', value: 'sirket_sahibi', label: 'Åirket Sahibi', multi: false }
];

const ROLE_LOOKUP = {};
[...BUYER_ROLE_OPTIONS, ...SUPPLIER_ROLE_OPTIONS].forEach((item) => {
  ROLE_LOOKUP[item.key] = { ...item, type: item.key.split(':')[0] };
});

function generateCompanyCode() {
  const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let out = '';
  for (let i = 0; i < 8; i++) {
    out += alphabet[Math.floor(Math.random() * alphabet.length)];
  }
  return out;
}

async function ensureCompanyRecordForUser(user, profile) {
  if (!profile) return null;
  if (!profile.companyName) return null;

  const { doc, getDoc, updateDoc, collection, addDoc, serverTimestamp } = await getFirestoreModules();
  const userRef = doc(db, 'users', user.uid);
  let companyId = profile.companyId || null;
  let companyDoc = null;
  let updatedUser = false;

  const assignOwnerFields = {
    companyRole: 'isveren',
    companyRoleType: 'buyer',
    companyRoleKey: 'buyer:isveren',
    companyJoinStatus: 'approved'
  };

  async function ensureUserOwnerFields(code) {
    const updates = { ...assignOwnerFields };
    if (code) updates.companyCode = code;
    await updateDoc(userRef, updates);
    updatedUser = true;
  }

  if (companyId) {
    const companyRef = doc(db, 'companies', companyId);
    const companySnap = await getDoc(companyRef);
    if (companySnap.exists()) {
      companyDoc = { id: companyRef.id, ...companySnap.data() };
        if (!companyDoc.taxNumber && profile.taxNumber) {
          await updateDoc(companyRef, { taxNumber: profile.taxNumber });
          companyDoc.taxNumber = profile.taxNumber;
        }
      if (!companyDoc.code) {
        const newCode = profile.companyCode || generateCompanyCode();
        await updateDoc(companyRef, { code: newCode });
        companyDoc.code = newCode;
        if (!profile.companyCode) {
          await updateDoc(userRef, { companyCode: newCode });
          updatedUser = true;
        }
      } else if (!profile.companyCode) {
        await updateDoc(userRef, { companyCode: companyDoc.code });
        updatedUser = true;
      }
    } else {
      const code = profile.companyCode || generateCompanyCode();
      await setDoc(companyRef, {
        name: profile.companyName,
        code,
        ownerUid: user.uid,
        taxNumber: profile.taxNumber || null,
        createdAt: serverTimestamp()
      }, { merge: true });
      companyDoc = { id: companyRef.id, name: profile.companyName, code, ownerUid: user.uid, taxNumber: profile.taxNumber || null };
      await ensureUserOwnerFields(code);
    }
    if (!profile.companyRole || !profile.companyJoinStatus || profile.companyJoinStatus === 'pending') {
      await ensureUserOwnerFields(companyDoc?.code || profile.companyCode || generateCompanyCode());
    }
  } else {
    // Teklifbul Rule v1.0 - Åirket ID'si vergi numarasÄ±na gÃ¶re oluÅŸturulur
    // Vergi numarasÄ± varsa onu kullan, yoksa solo-{uid} pattern'Ä±nÄ± kullan (geriye dÃ¶nÃ¼k uyumluluk)
    let newCompanyId = null;
    let companyRef = null;
    
    if (profile.taxNumber) {
      const taxNumberTrimmed = profile.taxNumber.trim();
      newCompanyId = `tax-${taxNumberTrimmed}`;
      
      // Vergi numarasÄ± ile ID zaten var mÄ± kontrol et
      companyRef = doc(db, 'companies', newCompanyId);
      const existingCheck = await getDoc(companyRef);
      
      if (existingCheck.exists()) {
        // Vergi numarasÄ± zaten kullanÄ±lÄ±yor, mevcut ÅŸirketi kullan
        companyId = newCompanyId;
        companyDoc = { id: newCompanyId, ...existingCheck.data() };
      } else {
        // Yeni ÅŸirket oluÅŸtur
        companyId = newCompanyId;
      }
    } else {
      // Vergi numarasÄ± yoksa eski sistem: solo-{uid}
      newCompanyId = `solo-${user.uid}`;
      companyRef = doc(db, 'companies', newCompanyId);
      companyId = newCompanyId;
    }
    const code = profile.companyCode || generateCompanyCode();
    
    // Åirket yoksa oluÅŸtur
    if (!companyDoc) {
      if (newCompanyId.startsWith('tax-')) {
        // Vergi numarasÄ± bazlÄ± ID ile oluÅŸtur
        await setDoc(companyRef, {
          name: profile.companyName,
          ownerUid: user.uid,
          ownerId: user.uid, // Backward compatibility
          code,
          taxNumber: profile.taxNumber || null,
          createdAt: serverTimestamp()
        });
      } else {
        // solo-{uid} pattern ile oluÅŸtur
        await setDoc(companyRef, {
          name: profile.companyName,
          ownerUid: user.uid,
          ownerId: user.uid, // Backward compatibility
          code,
          taxNumber: profile.taxNumber || null,
          createdAt: serverTimestamp()
        });
      }
      
      companyId = newCompanyId;
      companyDoc = { id: companyId, name: profile.companyName, ownerUid: user.uid, code, taxNumber: profile.taxNumber || null };
      await updateDoc(userRef, {
        companyId,
        companyCode: code,
        ...assignOwnerFields
      });
      updatedUser = true;
    }
  }

  return { companyId, companyDoc, updatedUser };
}
    async function fetchDistrictsTR(il) {
      if (!il) return [];
      try {
        const { doc, getDoc } = await getFirestoreModules();
        const snap = await getDoc(doc(db, "trDistricts", il));
        const data = snap.data();
        if (data && Array.isArray(data.districts) && data.districts.length) return data.districts;
      } catch (e) {
        logger.warn("Ä°lÃ§e listesi Firestore'dan alÄ±namadÄ±", e);
      }
      return [];
    }

    async function fetchCountriesFromFirestore(){
      try {
        const { collection, getDocs } = await getFirestoreModules();
        const snap = await getDocs(collection(db,'countries'));
        const out = [];
        snap.forEach(d=>{ const n=d.data()?.name; if(n) out.push(n); });
        return out;
      } catch(e){ logger.warn('countries fetch failed', e); return null; }
    }

    function populateCountrySelect(sel, list){
      if (!sel) return;
      sel.innerHTML = '';
      const preferred = (list||[]).filter(n=>n==='TÃ¼rkiye');
      const others = (list||[]).filter(n=>n!=='TÃ¼rkiye');
      const all = [...preferred, ...others];
      all.forEach(name=>{
        const op = document.createElement('option');
        op.value = name; op.textContent = name; sel.appendChild(op);
      });
      // Ensure TÃ¼rkiye exists
      if (!all.length){
        ['TÃ¼rkiye','Almanya','Amerika BirleÅŸik Devletleri','BirleÅŸik KrallÄ±k','Fransa','Ä°talya','Ä°spanya','Hollanda']
          .forEach(n=>{ const op=document.createElement('option'); op.value=n; op.textContent=n; sel.appendChild(op); });
      }
      // Default select TÃ¼rkiye
      const hasTR = Array.from(sel.options).some(o=>o.value==='TÃ¼rkiye');
      sel.value = hasTR ? 'TÃ¼rkiye' : (sel.options[0]?.value || 'TÃ¼rkiye');
    }

    // === Local Provinceâ€“District loader (from /assets/tr-il-ilce.json) ===
    // Teklifbul Rule v1.0 - 404 hatalarÄ±nÄ± sessizce handle et
    async function __fetchJSON(url){
      try {
        // Teklifbul Rule v2.0 - 404 hatalarÄ±nÄ± sessizce handle et (console'a yazma)
        const r = await fetch(url, { 
          headers: { 'accept': 'application/json' }
        });
        if (!r.ok) {
          // 404 veya diÄŸer hatalar sessizce handle edilir - konsola yazÄ±lmaz
          if (r.status === 404) {
            // 404 hatasÄ± normal (sokak JSON dosyasÄ± olmayabilir), sessizce handle et
            const notFoundError = new Error(`FILE_NOT_FOUND`);
            notFoundError.name = 'FileNotFoundError';
            throw notFoundError;
          }
          const error = new Error(`HTTP_ERROR_${r.status}`);
          error.name = 'HttpError';
          throw error;
        }
        return await r.json();
      } catch (e) {
        // Network hatalarÄ± da sessizce handle edilir
        if (e.name === 'TypeError' && (e.message.includes('fetch') || e.message.includes('Failed to fetch'))) {
          const networkError = new Error(`NETWORK_ERROR`);
          networkError.name = 'NetworkError';
          throw networkError;
        }
        // FileNotFoundError zaten sessizce handle ediliyor, diÄŸer hatalarÄ± da aynÄ± ÅŸekilde
        throw e;
      }
    }

    function __trNorm(s){ return (s ?? '').toString().trim().toLocaleLowerCase('tr').replace(/\s+/g,' '); }
    function __findByNameOrCode(list, val){
      if (val == null) return null;
      if (!isNaN(Number(val))) {
        const code = Number(val);
        return list.find(x => Number(x.id ?? x.code ?? x.plaka_kodu) === code) || null;
      }
      const needle = __trNorm(val);
      return list.find(x => __trNorm(x.name ?? x.il ?? x.text) === needle) || null;
    }
    function __fillSelect(sel, items, placeholder){
      if (!sel) return;
      sel.innerHTML = '';
      const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent = placeholder; sel.appendChild(opt0);
      (items||[]).sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'tr')).forEach(it=>{
        const o = document.createElement('option');
        o.value = String(it.id ?? it.code ?? it.value ?? it.name ?? '');
        o.textContent = it.name ?? it.label ?? String(it);
        if (it.id ?? it.code) o.dataset.code = String(it.id ?? it.code);
        sel.appendChild(o);
      });
      sel.disabled = (sel.options.length <= 1);
    }
    async function __loadProvinceDistrictData(){
      const sources = [
        '/public/assets/tr-il-ilce.json',
        './assets/tr-il-ilce.json',
        '/assets/tr-il-ilce.json',
        'https://raw.githubusercontent.com/muhammederdem/il-ilce-json/main/il-ilce.json',
        'https://cdn.jsdelivr.net/gh/muhammederdem/il-ilce-json@main/il-ilce.json'
      ];
      for (const u of sources){
        try { return await __fetchJSON(u); }
        catch(e){ logger.info('Ä°l-ilÃ§e datasÄ± bu kaynaktan okunamadÄ±', { url: u }); }
      }
      // Fallback: TR_PROVINCES as plain list
      return TR_PROVINCES.map(name => ({ il: name, ilceleri: [] }));
    }
    function __mapDistricts(p){
      const raw = p?.districts ?? p?.ilceleri ?? [];
      return raw.map(d => ({ id: d.id ?? d.code ?? d.ilce_kodu ?? d, name: d.name ?? d.ilce ?? String(d) }));
    }
    function __asciiSlug(s){
      s = String(s ?? '').trim();
      const map = { 'Ä±':'i','Ä°':'i','ÅŸ':'s','Å':'s','ÄŸ':'g','Ä':'g','Ã¼':'u','Ãœ':'u','Ã¶':'o','Ã–':'o','Ã§':'c','Ã‡':'c' };
      s = s.replace(/[Ä±Ä°ÅŸÅÄŸÄÃ¼ÃœÃ¶Ã–Ã§Ã‡]/g, ch => map[ch] || ch);
      s = s.normalize('NFKD').replace(/[^\p{L}\p{N}\s]/gu, '');
      return s.toUpperCase().replace(/\s+/g, '_');
    }
    function slugTR(s){
      const map = { 'Ä±':'i','Ä°':'i','ÅŸ':'s','Å':'s','ÄŸ':'g','Ä':'g','Ã¼':'u','Ãœ':'u','Ã¶':'o','Ã–':'o','Ã§':'c','Ã‡':'c' };
      s = String(s ?? '').trim();
      s = s.replace(/[Ä±Ä°ÅŸÅÄŸÄÃ¼ÃœÃ¶Ã–Ã§Ã‡]/g, ch => map[ch]);
      s = s.replace(/\s+/g, '_').replace(/[^\w]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g,'');
      return s.toUpperCase();
    }
    function districtId(il, ilce){
      return slugTR(il) + '__' + slugTR(ilce);
    }
    function cleanIlceValue(val) {
      if (typeof val !== 'string') return val;
      if (val.includes('__')) return val.split('__').pop();
      if (val.includes('_')) return val.split('_').pop();
      return val;
    }

    function pickTextOrValue(sel){
      if (!sel) return '';
      // element with options
      if (sel && sel.options && typeof sel.selectedIndex === 'number') {
        return sel.options[sel.selectedIndex]?.text || sel.value || '';
      }
      // plain string
      if (typeof sel === 'string') return sel;
      return String(sel || '');
    }

    async function __loadNeighborhoods(selectedIlSel, selectedIlceSel){
      const il   = pickTextOrValue(selectedIlSel);
      let ilce = pickTextOrValue(selectedIlceSel);
      // ilceyi sadeleÅŸtir
      ilce = cleanIlceValue(ilce);
      if (!il || !ilce) return { neighborhoods: [] };
      const dId = districtId(il, ilce);
      const urls = [ `/assets/mahalle/${dId}.json` ];
      for (const u of urls){
        try { return await __fetchJSON(u); } catch { /* sessizce boÅŸ dÃ¶n */ }
      }
      // API fallback (TÃ¼rkiyeAPI)
      try {
        const api = await fetch(`https://api.turkiyeapi.dev/v1/neighborhoods?district=${encodeURIComponent(ilce)}`, { headers: { 'accept':'application/json' } });
        if (api.ok) {
          const { data } = await api.json();
          const neighborhoods = (Array.isArray(data)? data:[]).map(n => ({ id: slugTR(n.name), name: n.name }));
          if (neighborhoods.length) {
            // cache'e kaydet
            try {
              await fetch(`${location.origin}/save-mahalle-json`, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ districtId: dId, districtName: ilce, neighborhoods }) });
            } catch {}
            return { districtId: dId, districtName: ilce, neighborhoods };
          }
        }
      } catch {}
      return { neighborhoods: [] };
    }

    async function __loadStreets(selectedIlSel, selectedIlceSel, neighborhoodId){
      // Teklifbul Rule v2.0 - Ä°l/ilÃ§e deÄŸerlerini doÄŸru al
      const il   = pickTextOrValue(selectedIlSel)?.trim();
      let ilce = pickTextOrValue(selectedIlceSel)?.trim();
      
      // Ä°l/ilÃ§e/mahalle boÅŸsa veya geÃ§ersizse boÅŸ dÃ¶n
      if (!il || !ilce || !neighborhoodId) {
        return { streets: [] };
      }
      
      ilce = cleanIlceValue(ilce);
      if (!ilce) return { streets: [] };
      
      const dId = districtId(il, ilce);
      const nId = slugTR(neighborhoodId);
      const urls = [ `/assets/sokak/${dId}_mah-${nId}.json` ];
      
      for (const u of urls){
        try { 
          return await __fetchJSON(u); 
        } catch (e) { 
          // Teklifbul Rule v2.0 - 404 hatalarÄ± normal (sokak JSON dosyasÄ± olmayabilir)
          // TÃ¼m hatalarÄ± sessizce handle et - konsola hiÃ§bir ÅŸey yazma
          // 404, network veya diÄŸer hatalar iÃ§in sessizce boÅŸ array dÃ¶n
          if (e.name === 'FileNotFoundError' || e.message === 'FILE_NOT_FOUND') {
            // 404 hatasÄ± - dosya yok, bu normal, sessizce devam et
            return { streets: [] };
          }
          // DiÄŸer hatalar iÃ§in de sessizce boÅŸ dÃ¶n
          return { streets: [] };
        }
      }
      return { streets: [] };
    }

    async function initProvinceDistrictLocal({ restoreIl = null, restoreIlce = null } = {}){
      if (window.__provinceInitDone) {
        // Already initialized, just restore values if provided
        if (restoreIl) {
          const selIl = document.getElementById('inv_il');
          const selIlce = document.getElementById('inv_ilce');
          if (selIl) {
            selIl.value = restoreIl;
            selIl.dispatchEvent(new Event('change'));
            setTimeout(() => {
              if (selIlce && restoreIlce) {
                selIlce.value = restoreIlce;
                selIlce.dispatchEvent(new Event('change'));
              }
            }, 300);
          }
        }
        return;
      }
      const selIl = document.getElementById('inv_il');
      const selIlce = document.getElementById('inv_ilce');
      if (!selIl || !selIlce) return;
      try {
        const raw = await __loadProvinceDistrictData();
        const provinces = (Array.isArray(raw) ? raw : raw?.data || []).map(p=>({ id: p.id ?? p.code ?? p.plaka_kodu ?? p.il, name: p.name ?? p.il ?? String(p), raw:p }))
          .sort((a,b)=> a.name.localeCompare(b.name,'tr'));
        __fillSelect(selIl, provinces, 'Ä°l seÃ§iniz');
        
        // Restore saved value if provided, otherwise try current value
        const preIlVal = restoreIl || selIl.value;
        const preIl = __findByNameOrCode(provinces, preIlVal);
        if (preIl){ 
          selIl.value = String(preIl.id); 
          const dlist = __mapDistricts(preIl.raw); 
          __fillSelect(selIlce, dlist, 'Ä°lÃ§e seÃ§iniz');
          // Restore ilce value if provided
          if (restoreIlce) {
            selIlce.value = restoreIlce;
          }
        }
        selIl.addEventListener('change', async ()=>{
          const chosen = __findByNameOrCode(provinces, selIl.value);
          if (!chosen){ __fillSelect(selIlce, [], 'Ä°lÃ§e seÃ§iniz'); return; }
          const dlist = __mapDistricts(chosen.raw); __fillSelect(selIlce, dlist, 'Ä°lÃ§e seÃ§iniz');
          window.__composeInvoiceAddress && window.__composeInvoiceAddress();
          
          // Teklifbul Rule v1.0 - Ä°l seÃ§imine gÃ¶re vergi dairesi gÃ¼ncelle
          const selectedIl = pickTextOrValue(selIl);
          if (selectedIl) {
            try {
              let taxOfficesList = await fetchTaxOfficesFromFirestore();
              if (!taxOfficesList || taxOfficesList.length === 0) {
                taxOfficesList = LOCAL_TAX_OFFICES;
              }
              
              const provinceNorm = __trNorm(selectedIl);
              const filtered = taxOfficesList.filter(office => {
                const officeNorm = __trNorm(office);
                return officeNorm.includes(provinceNorm) || officeNorm.includes(provinceNorm.split(' ')[0]);
              });
              
              const taxOfficeSelect = document.getElementById('taxOfficeSelect');
              if (taxOfficeSelect) {
                const currentValue = taxOfficeSelect.value;
                taxOfficeSelect.innerHTML = '<option value="">Vergi dairesi seÃ§in</option><option value="custom">Elle yaz</option>';
                filtered.forEach(office => {
                  const option = document.createElement('option');
                  option.value = office;
                  option.textContent = office;
                  if (office === currentValue) option.selected = true;
                  taxOfficeSelect.appendChild(option);
                });
                
                if (filtered.length === 0) {
                  taxOfficesList.forEach(office => {
                    const option = document.createElement('option');
                    option.value = office;
                    option.textContent = office;
                    if (office === currentValue) option.selected = true;
                    taxOfficeSelect.appendChild(option);
                  });
                }
              }
            } catch (error) {
              logger.error('Vergi dairesi gÃ¼ncelleme hatasÄ±', error);
            }
          }
        });
        selIlce.addEventListener('change', async ()=>{
          window.__composeInvoiceAddress && window.__composeInvoiceAddress();
          const districtId = selIlce.value;
          const selMah = document.getElementById('inv_mahalle');
          const selSok = document.getElementById('inv_sokak');
          const sokManual = document.getElementById('inv_sokak_manual');
          if (!selMah || !districtId){ if (selMah) __fillSelect(selMah, [], 'Mahalle seÃ§iniz'); if (selSok) __fillSelect(selSok, [], 'Sokak seÃ§iniz'); return; }
          try {
            selMah.disabled = true; selMah.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
            const data = await __loadNeighborhoods(selIl.value, selIlce.value);
            const neighborhoods = (data?.neighborhoods || []).map(n=>({ id: n.id ?? n.code ?? n.name, name: n.name }));
            __fillSelect(selMah, neighborhoods, 'Mahalle seÃ§iniz');
            if (selSok) { __fillSelect(selSok, [], 'Sokak seÃ§iniz'); selSok.style.display=''; }
            if (sokManual) { sokManual.style.display='none'; }
          } catch(err){ logger.error('Mahalle yÃ¼kleme hatasÄ±', err); __fillSelect(selMah, [], 'Mahalleler yok'); }
        });
        const selMah2 = document.getElementById('inv_mahalle');
        const selSok2 = document.getElementById('inv_sokak');
        selMah2?.addEventListener('change', async ()=>{
          window.__composeInvoiceAddress && window.__composeInvoiceAddress();
          if (!selSok2) return;
          const districtId = selIlce.value; const neighborhoodId = selMah2.value;
          __fillSelect(selSok2, [], 'Sokak seÃ§iniz');
          if (!districtId || !neighborhoodId) return;
          try {
            const manual = document.getElementById('inv_sokak_manual');
            selSok2.disabled = true; selSok2.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
            const data = await __loadStreets(selIl.value, selIlce.value, neighborhoodId);
            const streets = (data?.streets || []).map(s=>({ id: s.id ?? s.code ?? s.name, name: s.name }));
            __fillSelect(selSok2, streets, 'Sokak seÃ§iniz');
            if (streets.length > 0){ selSok2.style.display=''; if (manual){ manual.style.display='none'; manual.value=''; } }
            else { selSok2.style.display='none'; if (manual){ manual.style.display=''; } }
          } catch(err){
            logger.error('Sokak yÃ¼kleme hatasÄ±', err);
            __fillSelect(selSok2, [], 'Sokaklar yok');
            selSok2.style.display='none';
            const manual = document.getElementById('inv_sokak_manual');
            if (manual){ manual.style.display=''; }
          }
        });
        window.__provinceInitDone = true;
      } catch(e){ logger.warn('Ä°lâ€“ilÃ§e local init hata', e); }
    }
    function populateSelect(sel, values, placeholder) {
      if (!sel) return;
      sel.innerHTML = "";
      const first = document.createElement('option');
      first.value = "";
      first.textContent = placeholder || "SeÃ§iniz";
      sel.appendChild(first);
      (values || []).forEach(v => {
        const op = document.createElement('option');
        op.value = v; op.textContent = v; sel.appendChild(op);
      });
    }

    // Teklifbul Rule v1.0 - Genel Ayarlar iÃ§in structured address controls KALDIRILDI
    // Adresler artÄ±k "Adres YÃ¶netimi" sekmesinden yÃ¶netiliyor
    async function bindStructuredAddressControls() {
      // Teklifbul Rule v1.0 - Structured address fields Genel Ayarlar'dan kaldÄ±rÄ±ldÄ±
      // Bu fonksiyon artÄ±k Ã§alÄ±ÅŸmÄ±yor - sadece vergi dairesi kontrolÃ¼ yapÄ±lÄ±yor
      const taxNoInp = document.getElementById('taxNumber');
      const taxOffInp = document.getElementById('taxOffice');
      
      // Structured address fields yok - direkt return
      const ilSel = document.getElementById('inv_il');
      const ilceSel = document.getElementById('inv_ilce');
      if (!ilSel || !ilceSel) {
        // Normal - Genel Ayarlar'da structured address fields yok
        return;
      }

      function composeInvoiceFromParts(){
        const ulke = (countrySel?.value || '').trim();
        const ilText = ilSel ? (ilSel.options[ilSel.selectedIndex]?.text || ilSel.value || '').trim() : '';
        const ilceText = ilceSel ? (ilceSel.options[ilceSel.selectedIndex]?.text || ilceSel.value || '').trim() : '';
        const mahalle = (document.querySelector('#inv_mahalle option:checked')?.textContent || mahalleInp?.value || '').trim();
        const cadde = caddeInp?.value?.trim() || '';
        
        // FIX: Check both dropdown and manual input, prioritize manual if it's visible and has value
        const sokakSelEl = document.getElementById('inv_sokak');
        const sokakManualEl = document.getElementById('inv_sokak_manual');
        let sokakSelText = '';
        let sokakManual = '';
        
        // Get dropdown text only if dropdown is visible and has a selected option (not placeholder)
        if (sokakSelEl && sokakSelEl.style.display !== 'none') {
          const selectedOption = sokakSelEl.options[sokakSelEl.selectedIndex];
          if (selectedOption && selectedOption.value && selectedOption.value !== '') {
            sokakSelText = selectedOption.textContent.trim();
          }
        }
        
        // Get manual input if it's visible and has value
        if (sokakManualEl && sokakManualEl.style.display !== 'none') {
          sokakManual = (sokakManualEl.value || '').trim();
        }
        
        // Use manual input if available, otherwise use dropdown
        const sokak = sokakManual || sokakSelText;
        const kapiNo = kapiInp?.value?.trim() || '';
        const daire = daireInp?.value?.trim() || '';
        const postaKodu = postaInp?.value?.trim() || '';
        const vergiNo = taxNoInp?.value?.trim() || '';
        const vergiDairesi = taxOffInp?.value?.trim() || '';

        // Teklifbul Rule v1.0 - Fatura adresi formatÄ±: Ä°l, Ä°lÃ§e, Mahalle Ã¶nce, sonra detaylar
        const parts = [
          ilText ? ilText : null,
          ilceText ? ilceText : null,
          mahalle ? `${mahalle} Mahalle` : null,
          cadde ? `${cadde} Cadde` : null,
          sokak ? `${sokak} Sokak` : null,
          kapiNo ? `No: ${kapiNo}` : null,
          daire ? `Daire: ${daire}` : null,
          postaKodu ? `Posta Kodu: ${postaKodu}` : null,
          vergiNo ? `Vergi No: ${vergiNo}` : null,
          vergiDairesi ? `Vergi Dairesi: ${vergiDairesi}` : null,
        ].filter(Boolean);

        const composed = parts.join(' - ');
        // Teklifbul Rule v1.0 - invoiceAddress textarea kaldÄ±rÄ±ldÄ±
        // Composed address artÄ±k structured address parts olarak kaydediliyor
        // GÃ¶rÃ¼ntÃ¼leme iÃ§in Adres YÃ¶netimi sekmesi kullanÄ±lÄ±yor
      }

      // Expose for other handlers
      window.__composeInvoiceAddress = composeInvoiceFromParts;

      const applyCountry = async () => {
        const c = (countrySel?.value || '').trim();
        if (c === 'TÃ¼rkiye' || c === 'Turkey') {
          populateSelect(ilSel, TR_PROVINCES, 'Ä°l seÃ§in');
          ilSel.removeAttribute('disabled');
          ilceSel.removeAttribute('disabled');
        } else {
          populateSelect(ilSel, [], 'Ä°l (serbest giriÅŸ)');
          ilSel.setAttribute('disabled','disabled');
          populateSelect(ilceSel, [], 'Ä°lÃ§e (serbest giriÅŸ)');
          ilceSel.setAttribute('disabled','disabled');
        }
      };

      const applyProvince = async () => {
        const il = ilSel ? ilSel.value : '';
        if (!il) { if (ilceSel && ilceSel.tagName === 'SELECT') populateSelect(ilceSel, [], 'Ã–nce il seÃ§in'); composeInvoiceFromParts(); return; }
        // JSON'dan districts object dizisini bul
        let root;
        try { root = await fetch('/public/assets/tr-il-ilce.json').then(r=>r.json()); } catch(e){ 
          try { root = await fetch('./assets/tr-il-ilce.json').then(r=>r.json()); } catch(e2){ root = null; }
        }
        let province = null, districts = [];
        if (root && Array.isArray(root.data)) {
          province = root.data.find(p => p.id === il || p.name === il);
          districts = province?.districts || [];
        }
        // Daima select gÃ¶ster
        if (ilceSel && ilceSel.tagName !== 'SELECT' && ilceSel.parentElement) {
          const sel = document.createElement('select');
          sel.id = 'inv_ilce';
          ilceSel.parentElement.replaceChild(sel, ilceSel);
          ilceSel = sel;
        }
        if (ilceSel && ilceSel.tagName === 'SELECT') {
          ilceSel.innerHTML = '<option value="">Ä°lÃ§e seÃ§in</option>';
          districts.forEach(d=>{
            const op = document.createElement('option');
            op.value = d.id;
            op.textContent = d.name;
            ilceSel.appendChild(op);
          });
        }
        composeInvoiceFromParts();
      };

      // Load countries from Firestore then bind
      try {
        const cList = await fetchCountriesFromFirestore();
        if (cList && cList.length) populateCountrySelect(countrySel, cList);
      } catch(e){ logger.warn('countries load failed', e); }

      countrySel?.addEventListener('change', ()=>{ applyCountry(); composeInvoiceFromParts(); });
      ilSel?.addEventListener('change', applyProvince);
      // Parts change events
      [mahalleInp,caddeInp,sokakInp,sokakManualInp,kapiInp,daireInp,postaInp,taxNoInp,taxOffInp].forEach(el=>{
        el?.addEventListener('input', composeInvoiceFromParts);
        el?.addEventListener('change', composeInvoiceFromParts);
      });

      await applyCountry();
      await applyProvince();
      composeInvoiceFromParts();
    }
    function loadAdditionalAddresses(list = []) {
      // Loading additional addresses silently
      const container = document.getElementById("additionalAddresses");
      if (!container) {
        logger.warn("additionalAddresses container bulunamadÄ±");
        return;
      }
      
      // Mevcut iÃ§eriÄŸi temizle
      container.innerHTML = "";
      
      // Her adres iÃ§in satÄ±r oluÅŸtur
      list.forEach((addr, index) => {
        addAddressRow({ 
          title: addr.title || "", 
          content: addr.content || "", 
          isSaved: true 
        });
      });
      
      // Addresses loaded silently
    }

    function addAddressRow({ title = "", content = "", type = "", isSaved = false } = {}) {
      // Address row added silently
      
      const container = document.getElementById("additionalAddresses");
      if (!container) {
        logger.warn("additionalAddresses container bulunamadÄ±");
        return;
      }

      const row = document.createElement("div");
      row.className = "addr-row";
      row.style.cssText = 'margin: 16px 0; padding: 16px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';

      if (isSaved) {
        // KaydedilmiÅŸ adres - okunur mod
        row.innerHTML = `
          <div style="display: flex; gap: 16px; align-items: flex-start; margin-bottom: 12px;">
            <div style="flex: 0 0 250px;">
              <label style="font-size: 14px; font-weight: 600; color: #0c4a6e; margin-bottom: 6px; display: block;">ğŸ“ Adres BaÅŸlÄ±ÄŸÄ±</label>
              <div class="addr-title-display" style="padding: 10px; background: #e0f2fe; border: 1px solid #0ea5e9; border-radius: 6px; font-size: 14px; color: #0c4a6e; font-weight: 600;">${title}</div>
            </div>
            <div style="flex: 1;">
              <label style="font-size: 14px; font-weight: 600; color: #0c4a6e; margin-bottom: 6px; display: block;">ğŸ“ Adres Ä°Ã§eriÄŸi</label>
              <div class="addr-content-display" style="padding: 10px; background: #e0f2fe; border: 1px solid #0ea5e9; border-radius: 6px; font-size: 14px; color: #0c4a6e; white-space: pre-wrap;">${content}</div>
            </div>
            <div style="flex: 0 0 auto; align-self:flex-end; display: flex; gap: 8px;">
              <button type="button" class="addr-edit" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">âœï¸ DÃ¼zenle</button>
              <button type="button" class="addr-remove" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">ğŸ—‘ï¸ Sil</button>
            </div>
          </div>
          <div style="font-size: 12px; color: #10b981; font-style: italic; display: flex; align-items: center; gap: 4px;">
            âœ… Kaydedildi - Bu adres baÅŸlÄ±ÄŸÄ±nÄ± talep oluÅŸtururken teslimat adresi olarak seÃ§ebilirsiniz.
          </div>
        `;
      } else {
        // Yeni adres - yapÄ±landÄ±rÄ±lmÄ±ÅŸ dÃ¼zenleme modu
        const idx = Date.now();
        row.innerHTML = `
          <div style="display: flex; gap: 16px; align-items: flex-start; margin-bottom: 12px; flex-wrap:wrap;">
            <div style="flex: 0 0 260px; min-width:260px;">
              <label style="font-size: 14px; font-weight: 600; color: #0c4a6e; margin-bottom: 6px; display: block;">ğŸ“ Adres BaÅŸlÄ±ÄŸÄ±</label>
              <input type="text" class="addr-title" placeholder="Ã–rn: Beykoz Depo, Merkez Ofis, Fabrika" value="${title}"
                     style="width: 100%; padding: 10px; border: 2px solid #0ea5e9; border-radius: 6px; font-size: 14px; background: white; margin-bottom: 8px;">
              <label style="font-size: 13px; font-weight: 600; color: #0c4a6e; margin-bottom: 4px; display: block;">ğŸ·ï¸ Adres TÃ¼rÃ¼</label>
              <select class="addr-type" data-idx="${idx}" style="width: 100%; padding: 10px; border: 2px solid #0ea5e9; border-radius: 6px; font-size: 14px; background: white;">
                <option value="delivery" ${type === 'delivery' || type === 'Teslimat' ? 'selected' : ''}>Teslimat Adresi</option>
                <option value="invoice" ${type === 'invoice' || type === 'Fatura' ? 'selected' : ''}>Fatura Adresi</option>
                <option value="other" ${(!type || (type !== 'delivery' && type !== 'Teslimat' && type !== 'invoice' && type !== 'Fatura')) ? 'selected' : ''}>DiÄŸer</option>
              </select>
            </div>
            <div style="flex:1; min-width:320px;">
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <div>
                  <label style="font-weight:600; font-size:13px;">Ãœlke</label>
                  <select class="addr-ulke" data-idx="${idx}"><option value="TÃ¼rkiye" selected>TÃ¼rkiye</option></select>
                </div>
                <div>
                  <label style="font-weight:600; font-size:13px;">Ä°l</label>
                  <select class="addr-il" data-idx="${idx}"><option value="">Ä°l seÃ§iniz</option></select>
                </div>
                <div>
                  <label style="font-weight:600; font-size:13px;">Ä°lÃ§e</label>
                  <select class="addr-ilce" data-idx="${idx}"><option value="">Ã–nce il seÃ§in</option></select>
                </div>
                <div>
                  <label style="font-weight:600; font-size:13px;">Mahalle</label>
                  <select class="addr-mahalle" data-idx="${idx}" disabled><option value="">Ã–nce ilÃ§e seÃ§in</option></select>
                </div>
                <div>
                  <label style="font-weight:600; font-size:13px;">Cadde</label>
                  <input type="text" class="addr-cadde" data-idx="${idx}" placeholder="Cadde">
                </div>
                <div>
                  <label style="font-weight:600; font-size:13px;">Sokak (Opsiyonel)</label>
                  <input type="text" class="addr-sokak-manual" data-idx="${idx}" placeholder="Sokak (elle yazÄ±n, opsiyonel)" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
                  <select class="addr-sokak" data-idx="${idx}" disabled style="margin-top:6px; display:none;"><option value="">(Opsiyonel) Mahalle seÃ§ince otomatik yÃ¼klenir</option></select>
                </div>
                <div>
                  <label style="font-weight:600; font-size:13px;">KapÄ± No</label>
                  <input type="text" class="addr-kapi" data-idx="${idx}" placeholder="KapÄ± No">
                </div>
                <div>
                  <label style="font-weight:600; font-size:13px;">Daire</label>
                  <input type="text" class="addr-daire" data-idx="${idx}" placeholder="Daire (varsa)">
                </div>
                <div>
                  <label style="font-weight:600; font-size:13px;">Posta Kodu</label>
                  <input type="text" class="addr-posta" data-idx="${idx}" placeholder="Posta Kodu">
                </div>
              </div>
            </div>
            <div style="flex: 0 0 auto; align-self:flex-end; display: flex; gap: 8px;">
              <button type="button" class="addr-save" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">ğŸ’¾ Kaydet</button>
              <button type="button" class="addr-remove" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">ğŸ—‘ï¸ Sil</button>
            </div>
          </div>
          <div>
            <label style="font-size: 13px; font-weight: 600; color: #0c4a6e; margin-bottom: 6px; display: block;">ğŸ§¾ OluÅŸturulan Adres</label>
            <textarea rows="3" class="addr-composed" readonly style="width: 100%; padding: 10px; border: 1px dashed #0ea5e9; border-radius: 6px; font-size: 14px; background: #f8fafc;"></textarea>
          </div>
          <div style="font-size: 12px; color: #64748b; font-style: italic; margin-top:6px;">
            ğŸ’¡ AlanlarÄ± doldurdukÃ§a adres otomatik oluÅŸturulur; kaydettiÄŸinizde bu metin saklanÄ±r.
          </div>
        `;
        // SatÄ±r iÃ§i structured adres baÄŸlama
        (async () => {
          const ulkeSel = row.querySelector('.addr-ulke');
          const ilSel = row.querySelector('.addr-il');
          const ilceSel = row.querySelector('.addr-ilce');
          const mahSel = row.querySelector('.addr-mahalle');
          const sokSel = row.querySelector('.addr-sokak');
          const sokManual = row.querySelector('.addr-sokak-manual');
          const caddeInp = row.querySelector('.addr-cadde');
          const kapiInp = row.querySelector('.addr-kapi');
          const daireInp = row.querySelector('.addr-daire');
          const postaInp = row.querySelector('.addr-posta');
          const outTa = row.querySelector('.addr-composed');

          function fillSelectLocal(sel, items, placeholder){
            if (!sel) return;
            sel.innerHTML = '';
            const o0=document.createElement('option'); o0.value=''; o0.textContent=placeholder; sel.appendChild(o0);
            (items||[]).forEach(it=>{ const o=document.createElement('option'); o.value=String(it.id ?? it.value ?? it.name ?? ''); o.textContent=it.name ?? String(it); sel.appendChild(o); });
            sel.disabled = sel.options.length<=1;
          }
          function getSelText(sel){ return sel?.options?.[sel.selectedIndex]?.text || ''; }
          function compose(){
            const ulke = ulkeSel?.value || '';
            const il = getSelText(ilSel);
            const ilce = getSelText(ilceSel);
            const mah = getSelText(mahSel);
            const cad = caddeInp?.value?.trim() || '';
            // Teklifbul Rule v1.0 - Sokak her zaman manuel input'tan alÄ±nÄ±r (gizli/gÃ¶rÃ¼nÃ¼r fark etmeksizin)
            const sokManualValue = sokManual?.value?.trim() || '';
            const sokSelValue = sokSel && sokSel.style.display !== 'none' ? getSelText(sokSel) : '';
            const sok = sokManualValue || sokSelValue;
            const kap = kapiInp?.value?.trim() || '';
            const dai = daireInp?.value?.trim() || '';
            const pk = postaInp?.value?.trim() || '';
            const parts = [
              mah ? `${mah} Mahalle` : null,
              cad ? `${cad} Cadde` : null,
              sok ? `${sok}${sok.includes('Sokak') || sok.includes('Cadde') ? '' : ' Sokak'}` : null,
              kap ? `KapÄ± No: ${kap}` : null,
              dai ? `Daire: ${dai}` : null,
              ilce ? `Ä°lÃ§e: ${ilce}` : null,
              il ? `Ä°l: ${il}` : null,
              pk ? `Posta Kodu: ${pk}` : null,
              ulke ? `${ulke}` : null,
            ].filter(Boolean);
            if (outTa) outTa.value = parts.join(' - ');
          }

          // Ãœlkeler
          try {
            const list = await fetchCountriesFromFirestore();
            if (Array.isArray(list) && list.length) {
              fillSelectLocal(ulkeSel, list.map(n=>({id:n,name:n})), 'Ãœlke seÃ§iniz');
              ulkeSel.value = 'TÃ¼rkiye';
            }
          } catch {}

          // Ä°l/Ä°lÃ§e - Fatura adresi sistemindeki mantÄ±ÄŸÄ± kullan
          try {
            const raw = await __loadProvinceDistrictData();
            const provinces = (Array.isArray(raw)? raw : raw?.data || []).map(p=>({ id: p.id ?? p.code ?? p.plaka_kodu ?? p.il, name: p.name ?? p.il ?? String(p), raw:p }))
              .sort((a,b)=> a.name.localeCompare(b.name,'tr'));
            fillSelectLocal(ilSel, provinces, 'Ä°l seÃ§iniz');

            // Ä°l deÄŸiÅŸtiÄŸinde ilÃ§eleri yÃ¼kle (fatura adresi sistemindeki mantÄ±k)
            ilSel?.addEventListener('change', async ()=>{
              const chosen = __findByNameOrCode(provinces, ilSel.value);
              if (!chosen || !chosen.raw) {
                fillSelectLocal(ilceSel, [], 'Ä°lÃ§e seÃ§iniz');
                ilceSel.disabled = true;
                fillSelectLocal(mahSel, [], 'Mahalle seÃ§iniz'); 
                mahSel.disabled = true;
                fillSelectLocal(sokSel, [], 'Sokak/Cadde seÃ§iniz'); 
                sokSel.disabled = true;
                sokSel.style.display = 'none';
                // Teklifbul Rule v1.0 - Manuel input her zaman gÃ¶rÃ¼nÃ¼r
                if (sokManual) {
                  sokManual.style.display = '';
                  sokManual.removeAttribute('disabled');
                }
                compose();
                return;
              }
              
              const dlist = __mapDistricts(chosen.raw);
              fillSelectLocal(ilceSel, dlist, 'Ä°lÃ§e seÃ§iniz');
              ilceSel.disabled = dlist.length === 0;
              
              // Ä°l deÄŸiÅŸtiÄŸinde mahalle ve sokaklarÄ± temizle
              fillSelectLocal(mahSel, [], 'Mahalle seÃ§iniz'); 
              mahSel.disabled = true;
              fillSelectLocal(sokSel, [], 'Sokak/Cadde seÃ§iniz'); 
              sokSel.disabled = true;
                sokSel.style.display = 'none';
                // Teklifbul Rule v1.0 - Manuel input her zaman gÃ¶rÃ¼nÃ¼r
              if (sokManual) {
                  sokManual.style.display = '';
                  sokManual.removeAttribute('disabled');
              }
              
              compose();
            });
            ilceSel?.addEventListener('change', async ()=>{
              compose();
              const districtId = ilceSel.value;
              const districtName = getSelText(ilceSel);
              
              if (!districtId || !ilSel.value){ 
                fillSelectLocal(mahSel, [], 'Mahalle seÃ§iniz'); 
                mahSel.disabled = true; 
                fillSelectLocal(sokSel, [], 'Sokak/Cadde seÃ§iniz'); 
                sokSel.disabled = true;
                if (sokManual) {
                  sokManual.style.display = 'none';
                  sokManual.value = '';
                }
                return; 
              }
              
              mahSel.disabled = true; 
              mahSel.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
              
              try {
                const data = await __loadNeighborhoods(ilSel.value, ilceSel.value);
                const neighborhoods = (data?.neighborhoods||[]).map(n=>({id:n.id ?? n.code ?? n.name, name:n.name}));
                fillSelectLocal(mahSel, neighborhoods, 'Mahalle seÃ§iniz');
                mahSel.disabled = neighborhoods.length === 0;
                
                // Sokak dropdown'unu temizle
                fillSelectLocal(sokSel, [], 'Sokak/Cadde seÃ§iniz'); 
                sokSel.disabled = true;
                sokSel.style.display = 'none';
                // Teklifbul Rule v1.0 - Manuel input her zaman gÃ¶rÃ¼nÃ¼r
                if (sokManual) {
                  sokManual.style.display = '';
                  sokManual.removeAttribute('disabled');
                }
                compose();
              } catch (err) { 
                logger.error('Mahalle yÃ¼kleme hatasÄ±', err);
                fillSelectLocal(mahSel, [], 'Mahalleler yok'); 
                mahSel.disabled = true;
              }
            });
            mahSel?.addEventListener('change', async ()=>{
              compose();
              const districtId = ilceSel.value; const neighborhoodId = mahSel.value;
              const districtName = getSelText(ilceSel); const neighborhoodName = getSelText(mahSel);
              fillSelectLocal(sokSel, [], 'Sokak/Cadde seÃ§iniz'); if(!districtId||!neighborhoodId){ sokSel.disabled=true; return; }
              sokSel.disabled = true; sokSel.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
              try {
              const data = await __loadStreets(ilSel.value, ilceSel.value, neighborhoodId);
                const streets = (data?.streets||[]).map(s=>({id:s.id ?? s.code ?? s.name, name:s.name}));
              fillSelectLocal(sokSel, streets, 'Sokak/Cadde seÃ§iniz');
              // Teklifbul Rule v1.0 - Sokak manuel input her zaman gÃ¶rÃ¼nÃ¼r, dropdown opsiyonel
              if (streets.length > 0){ 
                sokSel.style.display=''; 
                sokSel.removeAttribute('disabled');
                // Sokak dropdown'dan seÃ§ildiÄŸinde manuel input'a da yaz
                sokSel.addEventListener('change', () => {
                  if (sokSel.value && sokManual) {
                    const selectedOption = sokSel.options[sokSel.selectedIndex];
                    if (selectedOption) {
                      sokManual.value = selectedOption.textContent.trim();
                    }
                    compose();
                  }
                }, { once: false });
              } else { 
                sokSel.style.display='none'; 
                sokSel.disabled = true;
              }
              // Manuel input her zaman gÃ¶rÃ¼nÃ¼r ve aktif
              if (sokManual) {
                sokManual.style.display = '';
                sokManual.removeAttribute('disabled');
              }
              compose();
              } catch { fillSelectLocal(sokSel, [], 'Sokaklar yok'); }
            });
          } catch {}

          [ulkeSel, ilSel, ilceSel, mahSel, sokSel, sokManual, caddeInp, kapiInp, daireInp, postaInp].forEach(el=>{
            el?.addEventListener('input', compose);
            el?.addEventListener('change', compose);
          });
          // EÄŸer dÃ¼zenleme modunda mevcut iÃ§erik (content) varsa, alanlarÄ± hemen bozmayalÄ±m; kullanÄ±cÄ± deÄŸiÅŸtirdikÃ§e compose edelim
          if (typeof content === 'string' && content.trim()) {
            if (outTa && !outTa.value) outTa.value = content.trim();
          } else {
            compose();
          }
          // DÃ¼zenleme modunda mevcut iÃ§erik parametresi geldiyse koru
          try { if (outTa && (content || '').trim() && !outTa.value) outTa.value = content; } catch {}
        })();
      }
      
      // Event listener'larÄ± ekle
      const saveBtn = row.querySelector(".addr-save");
      const editBtn = row.querySelector(".addr-edit");
      const removeBtn = row.querySelector(".addr-remove");
      
      if (saveBtn) {
        saveBtn.onclick = async function() {
          const titleInput = row.querySelector(".addr-title");
          const contentInput = row.querySelector(".addr-content");
          const composedInput = row.querySelector(".addr-composed");
          const typeSelect = row.querySelector(".addr-type");
          
          const contentValue = (composedInput?.value || contentInput?.value || '').trim();

          if (!titleInput.value.trim() || !contentValue) {
            toast.error(MESSAGES.ERROR_ADDRESS_TITLE_CONTENT_REQUIRED);
            return;
          }
          
          // Teklifbul Rule v1.0 - Firestore'a kaydet
          try {
            const user = await getCurrentUser();
            if (!user) {
              toast.error(MESSAGES.ERROR_AUTH);
              return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'â³ Kaydediliyor...';
            
            // Teklifbul Rule v1.0 - Mevcut adresleri Firestore'dan al (DOM'dan deÄŸil, duplication Ã¶nlemek iÃ§in)
            const userData = await getUserData(user.uid);
            const currentAddresses = userData.additionalAddresses || [];
            
            const newAddress = {
              title: titleInput.value.trim(),
              content: contentValue,
              type: (typeSelect?.value || 'delivery') // KullanÄ±cÄ±nÄ±n seÃ§tiÄŸi tip veya varsayÄ±lan teslimat adresi
            };
            
            // Yeni adresi listeye ekle
            const updatedAddresses = [...currentAddresses, newAddress];
            
            // Firestore'a kaydet
            const { doc, updateDoc, serverTimestamp } = await getFirestoreModules();
            await updateDoc(doc(db, 'users', user.uid), {
              additionalAddresses: updatedAddresses,
              updatedAt: serverTimestamp()
            });
            
            logger.info("Adres Firestore'a kaydedildi");
            
            // SayfayÄ± yenile - tÃ¼m ilave adresleri gÃ¶ster
            const freshUserData = await getUserData(user.uid);
            await loadAdditionalAddressesForManagement(freshUserData);
            
            // Kaydedilen adres satÄ±rÄ±nÄ± DOM'dan kaldÄ±r (duplication Ã¶nlemek iÃ§in)
                row.remove();
            
            // Toast mesajÄ± gÃ¶ster (varsa)
            if (window.toast && typeof window.toast.success === 'function') {
              window.toast.success(MESSAGES.SUCCESS_ADDRESS_SAVED);
            } else {
              toast.success(MESSAGES.SUCCESS_ADDRESS_SAVED);
            }
          } catch (error) {
            logger.error('Adres kaydetme hatasÄ±', error);
            toast.error(MESSAGES.ERROR_ADDRESS_SAVE + ': ' + (error.message || error));
            saveBtn.disabled = false;
            saveBtn.textContent = 'ğŸ’¾ Kaydet';
          }
        };
      }
      
      if (editBtn) {
        editBtn.onclick = function() {
          // DÃ¼zenleme moduna geÃ§
          const titleDisplay = row.querySelector(".addr-title-display");
          const contentDisplay = row.querySelector(".addr-content-display");
          
          // DÃ¼zenleme modunda tip bilgisini de al (eÄŸer varsa)
          const addrType = row.getAttribute('data-type') || '';
          addAddressRow({ 
            title: titleDisplay.textContent, 
            content: contentDisplay.textContent, 
            type: addrType,
            isSaved: false 
          });
          row.remove();
        };
      }
      
      if (removeBtn) {
        removeBtn.onclick = function() {
          if (confirm('Bu adresi silmek istediÄŸinizden emin misiniz?')) {
            row.remove();
            logger.info("Adres satÄ±rÄ± silindi");
          }
        };
      }
      
      container.appendChild(row);
      // Address row added silently
      
      // Scroll to the new element
      row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    function addAddress() {
      // Address function called silently
      addAddressRow();
    }
    // Teklifbul Rule v1.0 - Structured adres bilgilerini kaydet
    function getAdditionalAddresses() {
      const rows = [...document.querySelectorAll("#additionalAddresses .addr-row")];
      logger.info("Bulunan adres satÄ±rlarÄ±", { count: rows.length });
      
      const addresses = rows.map((r, index) => {
        logger.info(`Adres satÄ±rÄ± ${index + 1} iÅŸleniyor`, r);
        
        // DÃ¼zenleme modundaki adresler - structured alanlarÄ± oku
        const titleInput = r.querySelector(".addr-title");
        const contentInput = r.querySelector(".addr-content");
        const composedInput = r.querySelector('.addr-composed');
        
        // Structured adres alanlarÄ±nÄ± oku
        const sokSel = r.querySelector('.addr-sokak');
        const sokManual = r.querySelector('.addr-sokak-manual');
        const caddeInp = r.querySelector('.addr-cadde');
        const ilSel = r.querySelector('.addr-il');
        const ilceSel = r.querySelector('.addr-ilce');
        const mahSel = r.querySelector('.addr-mahalle');
        const kapiInp = r.querySelector('.addr-kapi');
        const daireInp = r.querySelector('.addr-daire');
        const postaInp = r.querySelector('.addr-posta');
        const typeSel = r.querySelector('.addr-type');
        
        // Sokak bilgisini al (dropdown text veya manual input)
        const getSokakText = (sel) => {
          if (!sel) return '';
          const selectedOption = sel.options?.[sel.selectedIndex];
          return selectedOption && selectedOption.value ? selectedOption.textContent.trim() : '';
        };
        
        // Teklifbul Rule v1.0 - Manuel sokak deÄŸeri her zaman Ã¶ncelikli (gizli/gÃ¶rÃ¼nÃ¼r fark etmeksizin)
        const sokakSelText = sokSel ? getSokakText(sokSel) : '';
        const sokakManualText = sokManual ? (sokManual.value || '').trim() : '';
        const sokak = sokakManualText || sokakSelText;
        
        // Ä°l ve ilÃ§e text'lerini al
        const getSelText = (sel) => {
          if (!sel) return '';
          const selectedOption = sel.options?.[sel.selectedIndex];
          return selectedOption && selectedOption.value ? selectedOption.textContent.trim() : '';
        };
        
        const il = ilSel ? getSelText(ilSel) : '';
        const ilce = ilceSel ? getSelText(ilceSel) : '';
        const mahalle = mahSel ? getSelText(mahSel) : '';
        
        if (titleInput && (contentInput || composedInput)) {
          const result = {
            title: titleInput.value?.trim() || "",
            content: (composedInput?.value || contentInput?.value || '')?.trim() || "",
            // Structured adres bilgileri
            street: sokak || null,
            cadde: caddeInp?.value?.trim() || null,
            city: il || null,
            district: ilce || null,
            mahalle: mahalle || null,
            building: kapiInp?.value?.trim() || null,
            kapi: kapiInp?.value?.trim() || null,
            daire: daireInp?.value?.trim() || null,
            postakodu: postaInp?.value?.trim() || null,
            type: typeSel?.value || 'other'
          };
          logger.info(`DÃ¼zenleme modu - Adres ${index + 1}`, result);
          return result;
        }
        
        // Okunur moddaki adresler - content'ten parse etmeye Ã§alÄ±ÅŸ (eÄŸer structured data yoksa)
        const titleDisplay = r.querySelector(".addr-title-display");
        const contentDisplay = r.querySelector(".addr-content-display");
        
        if (titleDisplay && contentDisplay) {
          // EÄŸer structured data varsa (Ã¶rneÄŸin data attribute'larÄ±ndan), onlarÄ± kullan
          // Yoksa sadece title ve content kaydet
          const result = {
            title: titleDisplay.textContent?.trim() || "",
            content: contentDisplay.textContent?.trim() || ""
          };
          logger.info(`Okunur mod - Adres ${index + 1}`, result);
          return result;
        }
        
        logger.warn(`Adres satÄ±rÄ± ${index + 1} iÅŸlenemedi`);
        return { title: "", content: "" };
      }).filter(x => x.title || x.content);
      
      logger.info("FiltrelenmiÅŸ adresler", addresses);
      return addresses;
    }

    // === Chip Management ===
    function renderChips(containerId, chips) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      container.innerHTML = "";
      [...chips].forEach(chip => {
        const chipEl = document.createElement("span");
        chipEl.className = "chip";
        chipEl.textContent = chip + " âœ•";
        chipEl.style.cssText = "display: inline-block; background: #007bff; color: white; padding: 4px 8px; margin: 2px; border-radius: 12px; font-size: 12px; cursor: pointer;";
        chipEl.addEventListener("click", () => {
          chips.delete(chip);
          renderChips(containerId, chips);
        });
        container.appendChild(chipEl);
      });
    }

    // === Bank Account Management ===
    function addBankRow(data = {}) {
      const tbody = document.getElementById("bankBody");
      if (!tbody) return;
      
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="text" value="${data.bankName || ''}" placeholder="Banka AdÄ±"></td>
        <td><input type="text" value="${data.iban || ''}" placeholder="IBAN"></td>
        <td><input type="text" value="${data.accountName || ''}" placeholder="Hesap AdÄ±"></td>
        <td>
          <select>
            <option value="TRY" ${data.currency === 'TRY' ? 'selected' : ''}>TRY</option>
            <option value="USD" ${data.currency === 'USD' ? 'selected' : ''}>USD</option>
            <option value="EUR" ${data.currency === 'EUR' ? 'selected' : ''}>EUR</option>
          </select>
        </td>
        <td><button type="button" onclick="this.closest('tr').remove()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Sil</button></td>
      `;
      tbody.appendChild(row);
    }

    // === Tax Office Management ===
    const LOCAL_TAX_OFFICES = [
      // Ä°stanbul
      "Beykoz Vergi Dairesi","Ãœmraniye Vergi Dairesi","ÃœskÃ¼dar Vergi Dairesi",
      "KadÄ±kÃ¶y Vergi Dairesi","Maltepe Vergi Dairesi","Kartal Vergi Dairesi",
      "BeÅŸiktaÅŸ Vergi Dairesi","ÅiÅŸli Vergi Dairesi","BeyoÄŸlu Vergi Dairesi",
      "BakÄ±rkÃ¶y Vergi Dairesi","Pendik Vergi Dairesi","AtaÅŸehir Vergi Dairesi",
      // Ankara
      "Ã‡ankaya Vergi Dairesi","KeÃ§iÃ¶ren Vergi Dairesi","Yenimahalle Vergi Dairesi",
      "Mamak Vergi Dairesi","Sincan Vergi Dairesi",
      // Ä°zmir
      "Konak Vergi Dairesi","Bornova Vergi Dairesi","KarÅŸÄ±yaka Vergi Dairesi",
      // BalÄ±kesir
      "BalÄ±kesir Vergi Dairesi","BandÄ±rma Vergi Dairesi","Edremit Vergi Dairesi",
      "Burhaniye Vergi Dairesi","AyvalÄ±k Vergi Dairesi","GÃ¶nen Vergi Dairesi",
      // Antalya
      "Antalya Vergi Dairesi","Alanya Vergi Dairesi","Manavgat Vergi Dairesi",
      "Kemer Vergi Dairesi","KaÅŸ Vergi Dairesi",
      // Denizli
      "Denizli Vergi Dairesi","Pamukkale Vergi Dairesi","Ã‡ivril Vergi Dairesi",
      // Genel
      "Kurumlar Vergi Dairesi","BÃ¼yÃ¼k MÃ¼kellefler Vergi Dairesi"
    ];

    async function fetchTaxOfficesFromFirestore() {
      try {
        console.debug("ğŸ”„ Vergi dairesi listesi yÃ¼kleniyor...");
        const { getDocs, collection } = await getFirestoreModules();
        const snap = await getDocs(collection(db, "taxOffices"));
        const list = [];
        snap.forEach(d => {
          const name = d.data()?.name;
          if (name) list.push(name);
        });
        return list.filter(Boolean);
      } catch (e) {
        // Teklifbul Rule v1.0 - Firestore izin hatasÄ± normal (public collection yoksa local list kullanÄ±lÄ±r)
        if (e.code === 'permission-denied' || e.message?.includes('permissions')) {
          logger.info("Tax offices Firestore eriÅŸimi yok (normal), yerel liste kullanÄ±lacak");
        } else {
        logger.error("Tax offices Firestore fetch failed", e);
        }
        return null;
      }
    }

    // === Company Admin (code + pending users) ===
    async function setupCompanyAdminUI(){
      const box = document.getElementById('companyAdminBox');
      const infoRow = document.getElementById('companyInfoRow');
      const pendingBox = document.getElementById('pendingUsersBox');
      const listEl = document.getElementById('pendingUsersList');
      if (!box || !infoRow) return;

      try {
        const user = await getCurrentUser();
        const { doc, getDoc } = await getFirestoreModules();
        const uref = doc(db, 'users', user.uid);
        const usnap = await getDoc(uref);
        let me = usnap.data() || {};
        let myCompanyId = me.companyId || null;
        let company = null;

        try {
          const result = await ensureCompanyRecordForUser(user, me);
          if (result) {
            if (result.updatedUser) {
              const refreshed = await getDoc(uref);
              me = refreshed.data() || me;
            }
            if (result.companyId) myCompanyId = result.companyId;
            if (result.companyDoc) company = result.companyDoc;
          }
        } catch (ensureError) {
          logger.warn('Company ensure failed', ensureError);
        }

        if (!myCompanyId){
          infoRow.innerHTML = '<span class="muted">HenÃ¼z bir ÅŸirkete baÄŸlÄ± deÄŸilsiniz. KayÄ±t aÅŸamasÄ±nda ÅŸirket oluÅŸturabilir veya koda gÃ¶re katÄ±labilirsiniz.</span>';
          pendingBox.style.display = 'none';
          return;
        }

        if (!company){
          try {
            const cref = doc(db, 'companies', myCompanyId);
            const csnap = await getDoc(cref);
            company = csnap.exists() ? { id: cref.id, ...csnap.data() } : null;
          } catch(e) { logger.warn('Company fetch failed', e); }
        }

        if (!company){
          infoRow.innerHTML = '<span class="muted">Åirket kaydÄ± tamamlanmamÄ±ÅŸ. LÃ¼tfen ÅŸirket bilgilerinizi gÃ¼ncelleyin.</span>';
          pendingBox.style.display = 'none';
          return;
        }

        infoRow.innerHTML = '';
        if (company.name) {
          const nameEl = document.createElement('div');
          nameEl.style.cssText = 'font-weight:600; font-size:14px;';
          nameEl.textContent = `Åirket: ${company.name}`;
          infoRow.appendChild(nameEl);
        }
        const code = company.code || me.companyCode || 'â€”';
        const chip = document.createElement('div');
        chip.style.cssText = 'display:flex;gap:8px;align-items:center;';
        chip.innerHTML = `
          <div style="font-size:13px;color:#6b7280;">Åirket Kodu:</div>
          <div style="padding:6px 10px;border:1px dashed #94a3b8;border-radius:6px;font-weight:600;">${code}</div>
          <button id="copyCompanyCode" class="btn btn-secondary" style="padding:6px 10px;font-size:12px;">Kopyala</button>
        `;
        infoRow.appendChild(chip);
        document.getElementById('copyCompanyCode')?.addEventListener('click', ()=>{
          navigator.clipboard?.writeText(code).then(()=> toast.success(MESSAGES.SUCCESS_COPIED)); 
        });

        const privilegedRoles = new Set(['isveren','genel_mudur','yonetim_kurulu_baskani','sirket_sahibi']);
        const isOwner = (company?.ownerUid && company.ownerUid === user.uid) || privilegedRoles.has(me.companyRole || '');
        
        // Åirket bilgilerini sadece tam yetkili kullanÄ±cÄ±lar dÃ¼zenleyebilir - Teklifbul Rule v1.0
        const companyInfoFields = [
          'companyName', 'taxNumber', 'mersisNo', 'website', 'googleBusinessUrl',
          'taxOffice', 'taxOfficeSelect', 'invoiceAddress', 'inv_ulke', 'inv_il',
          'inv_ilce', 'inv_mahalle', 'inv_cadde', 'inv_sokak', 'inv_kapi', 'inv_daire', 'inv_postakodu'
        ];
        
        companyInfoFields.forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field) {
            if (!isOwner) {
              field.readOnly = true;
              field.disabled = true;
              field.style.background = '#f9fafb';
              field.style.cursor = 'not-allowed';
              field.title = 'Bu bilgileri sadece ÅŸirket sahibi dÃ¼zenleyebilir';
            }
          }
        });
        
        // Referans isteklerini yÃ¼kle - Teklifbul Rule v1.0
        if (isOwner) {
          await loadReferralRequests(myCompanyId);
        }
        
        // Åirket kullanÄ±cÄ±larÄ± yÃ¶netimi bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¶ster/gizle - Teklifbul Rule v1.0
        const usersManagementSection = document.getElementById('companyUsersManagementSection');
        if (isOwner) {
          if (usersManagementSection) {
            usersManagementSection.style.display = 'block';
            
            // Tab yÃ¶netimi
            const tabActiveUsers = document.getElementById('tabActiveUsers');
            const tabPendingRequests = document.getElementById('tabPendingRequests');
            const activeUsersTab = document.getElementById('activeUsersTab');
            const pendingRequestsTab = document.getElementById('pendingRequestsTab');
            
            // Tab click handlers
            tabActiveUsers?.addEventListener('click', () => {
              tabActiveUsers.classList.add('active');
              tabActiveUsers.style.color = '#1f2937';
              tabActiveUsers.style.borderBottomColor = '#3b82f6';
              tabPendingRequests?.classList.remove('active');
              tabPendingRequests.style.color = '#6b7280';
              tabPendingRequests.style.borderBottomColor = 'transparent';
              activeUsersTab.style.display = 'block';
              pendingRequestsTab.style.display = 'none';
            });
            
            tabPendingRequests?.addEventListener('click', () => {
              tabPendingRequests.classList.add('active');
              tabPendingRequests.style.color = '#1f2937';
              tabPendingRequests.style.borderBottomColor = '#3b82f6';
              tabActiveUsers?.classList.remove('active');
              tabActiveUsers.style.color = '#6b7280';
              tabActiveUsers.style.borderBottomColor = 'transparent';
              activeUsersTab.style.display = 'none';
              pendingRequestsTab.style.display = 'block';
            });
            
            // Ä°lk tab'Ä± aktif et
            if (tabActiveUsers) {
              tabActiveUsers.style.color = '#1f2937';
              tabActiveUsers.style.borderBottomColor = '#3b82f6';
            }
            
            // Aktif kullanÄ±cÄ±larÄ± yÃ¼kle
            await loadActiveCompanyUsers(myCompanyId);
            
            // Teklifbul Rol & Onay Sistemi - Onay MekanizmasÄ± YÃ¶netimi
            if (typeof window.loadAndSetupApprovalPolicyManagement === 'function') {
              await window.loadAndSetupApprovalPolicyManagement(myCompanyId, me);
            }
            
            // Bekleyen istekleri yÃ¼kle
            if (company.code) {
              logger.info('Åirket sahibi - KayÄ±t istekleri yÃ¼kleniyor', { companyCode: company.code, companyId: myCompanyId });
              await loadCompanyJoinRequests(company.code, myCompanyId);
            } else {
              logger.warn('Åirket kodu bulunamadÄ±', company);
              const requestsList = document.getElementById('companyJoinRequestsList');
              if (requestsList) {
                requestsList.innerHTML = '<div style="text-align:center; padding:20px; color:#6b7280;"><p>âš ï¸ Åirket kodu bulunamadÄ±. LÃ¼tfen ÅŸirket bilgilerinizi kontrol edin.</p></div>';
              }
            }
          }
        } else {
          // Åirket sahibi deÄŸilse bÃ¶lÃ¼mÃ¼ gizle
          if (usersManagementSection) {
            usersManagementSection.style.display = 'none';
          }
        }
        // Referans kodu bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¶ster/gizle - Teklifbul Rule v1.0
        const referralCodeSection = document.getElementById('referralCodeSection');
        if (referralCodeSection) {
          if (isOwner) {
            referralCodeSection.style.display = 'block';
            setupReferralCodeSystem(myCompanyId, company.code);
          } else {
            referralCodeSection.style.display = 'none';
          }
        }
      } catch(e) {
        logger.warn('Company admin UI setup failed', e);
      }
    }
    
    // === Referans Kodu Sistemi - Teklifbul Rule v1.0 ===
    function generateReferralCode() {
      const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // I, O, Q, 0, 1 hariÃ§
      let code = '';
      for (let i = 0; i < 10; i++) {
        code += alphabet[Math.floor(Math.random() * alphabet.length)];
      }
      return code;
    }
    // Teklifbul Rule v1.0 - Referans isteklerini yÃ¼kle
    async function loadReferralRequests(companyId) {
      const requestsBox = document.getElementById('referralRequestsBox');
      const requestsList = document.getElementById('referralRequestsList');
      
      if (!requestsBox || !requestsList) return;
      
      try {
        // Beklemede olan referans isteklerini bul
        // Ä°stekler diÄŸer ÅŸirketlerin referralCompanies koleksiyonunda bizim ÅŸirket ID'mizle oluÅŸturulmuÅŸ olanlar
        // Ancak direkt sorgu yapamayÄ±z, bu yÃ¼zden notifications koleksiyonunu kontrol edelim
        const { collection, query, where, orderBy, getDocs } = await getFirestoreModules();
        const notificationsRef = collection(db, 'companies', companyId, 'notifications');
        const notificationsQuery = query(
          notificationsRef,
          where('type', '==', 'referral_request'),
          where('read', '==', false),
          orderBy('createdAt', 'desc')
        );
        const notificationsSnapshot = await getDocs(notificationsQuery);
        
        // OPTIMIZED: Collection Group Query kullanarak tÃ¼m referralCompanies koleksiyonlarÄ±nda tek sorgu ile arama
        // Bu, tÃ¼m ÅŸirketleri Ã§ekmeye gerek kalmadan direkt referans isteklerini bulur
        const pendingReferrals = [];
        
        try {
          const { collectionGroup } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
          const referralsQuery = query(
            collectionGroup(db, 'referralCompanies'),
            where('referredCompanyId', '==', companyId),
            where('status', '==', 'pending')
          );
          const referralsSnapshot = await getDocs(referralsQuery);
          
          // Åirket bilgilerini topla (toplu sorgu iÃ§in)
          const companyIds = new Set();
          referralsSnapshot.forEach(refDoc => {
            const refData = refDoc.data();
            const requestingCompanyId = refData.requestingCompanyId;
            if (requestingCompanyId) companyIds.add(requestingCompanyId);
            
            pendingReferrals.push({
              id: refDoc.id,
              requestingCompanyId: requestingCompanyId,
              requestingCompanyName: refData.requestingCompanyName || 'Åirket',
              requestingCompanyCode: refData.requestingCompanyCode || '',
              requestedAt: refData.requestedAt,
              ...refData
            });
          });
          
          // Åirket adlarÄ±nÄ± toplu olarak yÃ¼kle (performans iÃ§in)
          if (companyIds.size > 0) {
            const companyPromises = Array.from(companyIds).map(async (cid) => {
              try {
                const { doc, getDoc } = await getFirestoreModules();
                const companyDoc = await getDoc(doc(db, 'companies', cid));
                if (companyDoc.exists()) {
                  const companyData = companyDoc.data();
                  // Referans isteklerinde ÅŸirket adÄ±nÄ± gÃ¼ncelle
                  pendingReferrals.forEach(ref => {
                    if (ref.requestingCompanyId === cid && (!ref.requestingCompanyName || ref.requestingCompanyName === 'Åirket')) {
                      ref.requestingCompanyName = companyData.name || 'Åirket';
                      ref.requestingCompanyCode = companyData.code || ref.requestingCompanyCode || '';
                    }
                  });
                }
              } catch (e) {
                logger.warn(`Company ${cid} yÃ¼klenemedi`, e);
              }
            });
            await Promise.all(companyPromises);
          }
        } catch (collectionGroupError) {
          logger.error('Collection Group Query failed, falling back to notification system', collectionGroupError);
          // Fallback: Sadece notification'larÄ± kullan
        }
        
        if (pendingReferrals.length === 0) {
          requestsBox.style.display = 'none';
          return;
        }
        
        requestsBox.style.display = 'block';
        requestsList.innerHTML = '';
        
        // Ä°stekleri gÃ¶ster
        for (const referral of pendingReferrals) {
          const requestCard = document.createElement('div');
          requestCard.style.cssText = 'padding:12px; background:white; border:1px solid #f59e0b; border-radius:8px;';
          
          const requestedDate = referral.requestedAt?.toDate 
            ? new Date(referral.requestedAt.toDate()).toLocaleDateString('tr-TR')
            : 'Tarih bilgisi yok';
          
          requestCard.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
              <div style="flex:1;">
                <strong style="font-size:14px; color:#1f2937;">${referral.requestingCompanyName}</strong>
                <div style="font-size:12px; color:#6b7280; margin-top:4px;">
                  Åirket Kodu: ${referral.requestingCompanyCode || '-'}
                </div>
                <div style="font-size:11px; color:#9ca3af; margin-top:4px;">
                  Ä°stek Tarihi: ${requestedDate}
                </div>
              </div>
              <div style="display:flex; gap:8px;">
                <button class="approve-referral-btn" data-referral-id="${referral.id}" 
                        data-requesting-company-id="${referral.requestingCompanyId}"
                        style="padding:6px 12px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600;">
                  âœ“ Onayla
                </button>
                <button class="reject-referral-btn" data-referral-id="${referral.id}" 
                        data-requesting-company-id="${referral.requestingCompanyId}"
                        style="padding:6px 12px; background:#ef4444; color:white; border:none; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600;">
                  âœ• Reddet
                </button>
              </div>
            </div>
          `;
          
          requestsList.appendChild(requestCard);
        }
        
        // Event listeners
        document.querySelectorAll('.approve-referral-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const referralId = btn.dataset.referralId;
            const requestingCompanyId = btn.dataset.requestingCompanyId;
            await approveReferralRequest(companyId, requestingCompanyId, referralId);
          });
        });
        
        document.querySelectorAll('.reject-referral-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const referralId = btn.dataset.referralId;
            const requestingCompanyId = btn.dataset.requestingCompanyId;
            await rejectReferralRequest(companyId, requestingCompanyId, referralId);
          });
        });
        
      } catch (e) {
        logger.error("Load referral requests failed", e);
        requestsBox.style.display = 'none';
      }
    }
    
    // Referans isteÄŸini onayla
    async function approveReferralRequest(myCompanyId, requestingCompanyId, referralId) {
      if (!confirm('Bu referans isteÄŸini onaylamak istediÄŸinizden emin misiniz?')) return;
      
      try {
        // Ä°stekÃ§i ÅŸirketin referralCompanies koleksiyonunda durumu gÃ¼ncelle
        const { doc, updateDoc, serverTimestamp } = await getFirestoreModules();
        const referralRef = doc(db, 'companies', requestingCompanyId, 'referralCompanies', referralId);
        await updateDoc(referralRef, {
          status: 'approved',
          approvedAt: serverTimestamp(),
          approvedBy: auth.currentUser?.uid || null
        });
        
        // Bildirimleri iÅŸaretle (okundu olarak)
        const notificationsRef = collection(db, 'companies', myCompanyId, 'notifications');
        const notificationsQuery = query(
          notificationsRef,
          where('type', '==', 'referral_request'),
          where('companyId', '==', requestingCompanyId)
        );
        const notificationsSnapshot = await getDocs(notificationsQuery);
        
        const updatePromises = notificationsSnapshot.docs.map(notifDoc => 
          updateDoc(doc(db, 'companies', myCompanyId, 'notifications', notifDoc.id), { read: true })
        );
        await Promise.all(updatePromises);
        
        toast.success(MESSAGES.SUCCESS_REFERENCE_REQUEST_APPROVED);
        await loadReferralRequests(myCompanyId);
      } catch (e) {
        logger.error("Approve referral request failed", e);
        toast.error(MESSAGES.ERROR_REFERENCE_REQUEST_APPROVE + ': ' + (e?.message || e));
      }
    }
    
    // Referans isteÄŸini reddet
    async function rejectReferralRequest(myCompanyId, requestingCompanyId, referralId) {
      if (!confirm('Bu referans isteÄŸini reddetmek istediÄŸinizden emin misiniz?')) return;
      
      try {
        // Ä°stekÃ§i ÅŸirketin referralCompanies koleksiyonunda durumu gÃ¼ncelle
        const { doc, updateDoc, serverTimestamp } = await getFirestoreModules();
        const referralRef = doc(db, 'companies', requestingCompanyId, 'referralCompanies', referralId);
        await updateDoc(referralRef, {
          status: 'rejected',
          approvedAt: serverTimestamp(),
          approvedBy: auth.currentUser?.uid || null
        });
        
        // Bildirimleri iÅŸaretle (okundu olarak)
        const notificationsRef = collection(db, 'companies', myCompanyId, 'notifications');
        const notificationsQuery = query(
          notificationsRef,
          where('type', '==', 'referral_request'),
          where('companyId', '==', requestingCompanyId)
        );
        const notificationsSnapshot = await getDocs(notificationsQuery);
        
        const updatePromises = notificationsSnapshot.docs.map(notifDoc => 
          updateDoc(doc(db, 'companies', myCompanyId, 'notifications', notifDoc.id), { read: true })
        );
        await Promise.all(updatePromises);
        
        toast.success(MESSAGES.SUCCESS_REFERENCE_REQUEST_REJECTED);
        await loadReferralRequests(myCompanyId);
      } catch (e) {
        logger.error("Reject referral request failed", e);
        toast.error(MESSAGES.ERROR_REFERENCE_REQUEST_REJECT + ': ' + (e?.message || e));
      }
    }
    
    // Aktif ÅŸirket kullanÄ±cÄ±larÄ±nÄ± yÃ¼kle - Teklifbul Rule v1.0
    async function loadActiveCompanyUsers(companyId) {
      const activeUsersList = document.getElementById('activeUsersList');
      
      if (!activeUsersList) {
        logger.warn('Aktif kullanÄ±cÄ±lar listesi bulunamadÄ±');
        return;
      }
      
      activeUsersList.innerHTML = '<div style="text-align:center; padding:20px; color:#6b7280;"><p>YÃ¼kleniyor...</p></div>';
      
      try {
        // Åirkete ait tÃ¼m kullanÄ±cÄ±larÄ± bul
        const { collection, query, where, getDocs, doc, getDoc } = await getFirestoreModules();
        const usersQuery = query(
          collection(db, 'users'),
          where('companyId', '==', companyId)
        );
        
        const usersSnapshot = await getDocs(usersQuery);
        
        if (usersSnapshot.empty) {
          activeUsersList.innerHTML = '<div style="text-align:center; padding:20px; color:#6b7280;"><p>HenÃ¼z ÅŸirkete kayÄ±tlÄ± kullanÄ±cÄ± yok.</p></div>';
          return;
        }
        
        activeUsersList.innerHTML = '';
        
        // Åirket belgesini al (roller iÃ§in)
        let companyRoles = { buyerRoles: [], supplierRoles: [] };
        try {
          const companyDoc = await getDoc(doc(db, 'companies', companyId));
          if (companyDoc.exists()) {
            const companyData = companyDoc.data();
            companyRoles.buyerRoles = companyData.buyerRoles || [];
            companyRoles.supplierRoles = companyData.supplierRoles || [];
          }
        } catch (e) {
          logger.warn('Åirket rolleri yÃ¼klenirken hata', e);
        }
        
        // VarsayÄ±lan roller - Teklifbul Rol & Onay Sistemi
        const defaultBuyerRoles = [
          { value: 'buyer:satinalma_uzman_yardimcisi', label: 'SatÄ±n Alma Uzman YardÄ±mcÄ±sÄ±' },
          { value: 'buyer:satinalma_uzmani', label: 'SatÄ±n Alma UzmanÄ±' },
          { value: 'buyer:satinalma_yetkilisi', label: 'SatÄ±n Alma Yetkilisi' },
          { value: 'buyer:satinalma_muduru', label: 'SatÄ±n Alma MÃ¼dÃ¼rÃ¼' },
          { value: 'buyer:genel_mudur', label: 'Genel MÃ¼dÃ¼r' },
          { value: 'buyer:genel_mudur_yardimcisi', label: 'Genel MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±' },
          { value: 'buyer:ceo', label: 'CEO' },
          { value: 'buyer:isveren', label: 'Ä°ÅŸveren (Åirket Sahibi)' },
          { value: 'buyer:yonetim_kurulu_baskani', label: 'YÃ¶netim Kurulu BaÅŸkanÄ±' },
          { value: 'buyer:yonetim_kurulu_uyesi', label: 'YÃ¶netim Kurulu Ãœyesi' },
          { value: 'buyer:proje_yoneticisi', label: 'Proje YÃ¶neticisi' }
        ];
        const defaultSupplierRoles = [
          { value: 'supplier:satici', label: 'SatÄ±cÄ±' },
          { value: 'supplier:satis_muduru', label: 'SatÄ±ÅŸ MÃ¼dÃ¼rÃ¼' },
          { value: 'supplier:satis_yoneticisi', label: 'SatÄ±ÅŸ YÃ¶neticisi' },
          { value: 'supplier:genel_mudur', label: 'Genel MÃ¼dÃ¼r' }
        ];
        
        // Åirket rollerini kontrol et (buyer/supplier)
        const companyDoc = await getDoc(doc(db, 'companies', companyId));
        let hasBuyerRole = false;
        let hasSupplierRole = false;
        if (companyDoc.exists()) {
          const companyData = companyDoc.data();
          // Åirketin roles array'ini kontrol et
          const companyRolesArray = companyData.roles || [];
          hasBuyerRole = companyRolesArray.includes('buyer') || companyRolesArray.includes('both');
          hasSupplierRole = companyRolesArray.includes('supplier') || companyRolesArray.includes('both');
          
          // EÄŸer roles yoksa, varsayÄ±lan olarak buyer kabul et
          if (companyRolesArray.length === 0) {
            hasBuyerRole = true;
          }
        }
        
        for (const userDoc of usersSnapshot.docs) {
          const userData = userDoc.data();
          const userId = userDoc.id;
          
          // KullanÄ±cÄ± bilgileri - Teklifbul Rule v1.0
          const userName = userData.displayName || userData.email || 'Bilinmeyen KullanÄ±cÄ±';
          const userEmail = userData.email || '';
          const currentRoles = userData.companyRoles || [];
          const currentRole = userData.companyRole || userData.requestedCompanyRole || 'buyer:satinalma_yetkilisi';
          const roleType = userData.companyRoleType || (currentRole.includes('buyer') ? 'buyer' : 'supplier');
          const joinDate = userData.approvedAt?.toDate?.() || userData.createdAt?.toDate?.() || new Date();
          
          // KullanÄ±cÄ±nÄ±n mevcut rolleri (buyer/supplier)
          const userRoles = userData.roles || [];
          const userHasBuyer = userRoles.includes('buyer') || userRoles.includes('both') || roleType === 'buyer';
          const userHasSupplier = userRoles.includes('supplier') || userRoles.includes('both') || roleType === 'supplier';
          
          // TÃ¼m mevcut roller (buyer + supplier)
          const allBuyerRoles = companyRoles.buyerRoles.length > 0 ? companyRoles.buyerRoles : defaultBuyerRoles;
          const allSupplierRoles = companyRoles.supplierRoles.length > 0 ? companyRoles.supplierRoles : defaultSupplierRoles;
          
          // KullanÄ±cÄ± kartÄ±nÄ± oluÅŸtur - Teklifbul Rule v1.0
          const userCard = document.createElement('div');
          userCard.style.cssText = 'padding:16px; border:1px solid #e5e7eb; border-radius:8px; background:#f9fafb; margin-bottom:16px;';
          userCard.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:start; gap:16px; flex-wrap:wrap;">
              <!-- KullanÄ±cÄ± Bilgileri -->
              <div style="flex:1; min-width:250px;">
                <div style="margin-bottom:12px;">
                  <label style="font-size:11px; color:#6b7280; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px; display:block;">KullanÄ±cÄ± AdÄ±</label>
                  <div style="font-weight:600; font-size:15px; color:#1f2937;">${userName}</div>
                </div>
                <div style="margin-bottom:12px;">
                  <label style="font-size:11px; color:#6b7280; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px; display:block;">E-posta Adresi</label>
                  <div style="font-size:13px; color:#374151;">${userEmail}</div>
                </div>
                <div style="display:flex; gap:8px; align-items:center; margin-top:12px; flex-wrap:wrap;">
                  <span style="padding:4px 10px; background:#d1fae5; color:#065f46; border-radius:12px; font-size:12px; font-weight:500;">
                    âœ… Aktif
                  </span>
                  <span style="font-size:12px; color:#6b7280;">KatÄ±lÄ±m: ${joinDate.toLocaleDateString('tr-TR', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                </div>
              </div>
              
              <!-- Rol SeÃ§imi -->
              <div style="flex:1; min-width:300px;">
                <label style="font-size:11px; color:#6b7280; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; display:block;">Åirket Ä°Ã§i Rol</label>
                ${hasBuyerRole && hasSupplierRole ? `
                  <!-- Ã‡oklu Rol SeÃ§imi (Buyer + Supplier) -->
                  <div style="display:flex; gap:12px; flex-direction:column; margin-bottom:12px;">
                    ${hasBuyerRole ? `
                      <div>
                        <label style="font-size:12px; color:#374151; font-weight:600; margin-bottom:4px; display:block;">ğŸ“‹ AlÄ±cÄ± Rolleri</label>
                        <select id="buyerRoleSelect_${userId}" style="width:100%; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;">
                          ${allBuyerRoles.map(role => {
                            const roleValue = typeof role === 'string' ? role : role.value || role;
                            const roleLabel = typeof role === 'string' ? role.split(':')[1] || role : role.label || role.value || role;
                            const isSelected = currentRoles.includes(roleValue) || currentRole === roleValue;
                            return `<option value="${roleValue}" ${isSelected ? 'selected' : ''}>${roleLabel}</option>`;
                          }).join('')}
                        </select>
                      </div>
                    ` : ''}
                    ${hasSupplierRole ? `
                      <div>
                        <label style="font-size:12px; color:#374151; font-weight:600; margin-bottom:4px; display:block;">ğŸ“¦ TedarikÃ§i Rolleri</label>
                        <select id="supplierRoleSelect_${userId}" style="width:100%; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;">
                          ${allSupplierRoles.map(role => {
                            const roleValue = typeof role === 'string' ? role : role.value || role;
                            const roleLabel = typeof role === 'string' ? role.split(':')[1] || role : role.label || role.value || role;
                            const isSelected = currentRoles.includes(roleValue) || currentRole === roleValue;
                            return `<option value="${roleValue}" ${isSelected ? 'selected' : ''}>${roleLabel}</option>`;
                          }).join('')}
                        </select>
                      </div>
                    ` : ''}
                  </div>
                ` : `
                  <!-- Tekli Rol SeÃ§imi -->
                  <select id="roleSelectUser_${userId}" style="width:100%; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:13px; margin-bottom:12px;">
                    ${(hasBuyerRole ? allBuyerRoles : allSupplierRoles).map(role => {
                      const roleValue = typeof role === 'string' ? role : role.value || role;
                      const roleLabel = typeof role === 'string' ? role.split(':')[1] || role : role.label || role.value || role;
                      const isSelected = currentRole === roleValue || currentRoles.includes(roleValue);
                      return `<option value="${roleValue}" ${isSelected ? 'selected' : ''}>${roleLabel}</option>`;
                    }).join('')}
                  </select>
                `}
                
                <!-- Yetki Tablosu Butonu -->
                <button id="viewPermissionsBtn_${userId}" class="btn btn-secondary" style="width:100%; padding:8px 12px; font-size:12px; margin-bottom:8px; background:#f3f4f6; color:#374151; border:1px solid #d1d5db;">
                  ğŸ“Š Yetki Durumunu GÃ¶rÃ¼ntÃ¼le
                </button>
                
                <!-- Aksiyon ButonlarÄ± -->
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <button id="updateRoleBtn_${userId}" class="btn btn-primary" style="flex:1; padding:8px 16px; font-size:13px; min-width:120px;">
                    ğŸ”„ RolÃ¼ GÃ¼ncelle
                  </button>
                  <button id="removeUserBtn_${userId}" class="btn btn-danger" style="padding:8px 16px; font-size:13px;">
                    ğŸš« Ã‡Ä±kar
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Yetki Tablosu (BaÅŸlangÄ±Ã§ta gizli) -->
            <div id="permissionsTable_${userId}" style="display:none; margin-top:16px; padding:16px; background:#fff; border:1px solid #e5e7eb; border-radius:8px;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h4 style="margin:0; font-size:14px; color:#1f2937; font-weight:600;">ğŸ“Š Rol Yetkileri</h4>
                <button id="closePermissionsBtn_${userId}" style="background:none; border:none; color:#6b7280; cursor:pointer; font-size:18px;">Ã—</button>
              </div>
              <div id="permissionsContent_${userId}">
                <!-- Yetki tablosu buraya dinamik olarak eklenecek -->
              </div>
            </div>
          `;
          
          activeUsersList.appendChild(userCard);
          
          // Event listener'larÄ± ekle - Teklifbul Rule v1.0
          document.getElementById(`updateRoleBtn_${userId}`)?.addEventListener('click', async () => {
            let selectedRoles = [];
            
            // Ã‡oklu rol kontrolÃ¼
            const buyerSelect = document.getElementById(`buyerRoleSelect_${userId}`);
            const supplierSelect = document.getElementById(`supplierRoleSelect_${userId}`);
            const singleSelect = document.getElementById(`roleSelectUser_${userId}`);
            
            if (buyerSelect && supplierSelect) {
              // Ã‡oklu rol seÃ§imi
              if (buyerSelect.value) selectedRoles.push(buyerSelect.value);
              if (supplierSelect.value) selectedRoles.push(supplierSelect.value);
            } else if (singleSelect) {
              // Tekli rol seÃ§imi
              selectedRoles = [singleSelect.value];
            }
            
            if (selectedRoles.length === 0) {
              toast.warn(MESSAGES.WARN_ROLE_SELECT_REQUIRED);
              return;
            }
            
            await updateUserRole(userId, companyId, selectedRoles);
          });
          
          document.getElementById(`removeUserBtn_${userId}`)?.addEventListener('click', async () => {
            if (confirm(`${userName} kullanÄ±cÄ±sÄ±nÄ± ÅŸirketten Ã§Ä±karmak istediÄŸinizden emin misiniz?`)) {
              await removeUserFromCompany(userId, companyId);
            }
          });
          
          // Yetki tablosu gÃ¶ster/gizle
          document.getElementById(`viewPermissionsBtn_${userId}`)?.addEventListener('click', () => {
            const permissionsTable = document.getElementById(`permissionsTable_${userId}`);
            const permissionsContent = document.getElementById(`permissionsContent_${userId}`);
            const buyerSelect = document.getElementById(`buyerRoleSelect_${userId}`);
            const supplierSelect = document.getElementById(`supplierRoleSelect_${userId}`);
            const singleSelect = document.getElementById(`roleSelectUser_${userId}`);
            
            if (permissionsTable.style.display === 'none') {
              // Yetki tablosunu gÃ¶ster
              const buyerRole = buyerSelect?.value || (singleSelect?.value?.includes('buyer') ? singleSelect.value : null);
              const supplierRole = supplierSelect?.value || (singleSelect?.value?.includes('supplier') ? singleSelect.value : null);
              
              const permissionsHtml = generatePermissionsTable(buyerRole, supplierRole, allBuyerRoles, allSupplierRoles);
              permissionsContent.innerHTML = permissionsHtml;
              permissionsTable.style.display = 'block';
            } else {
              permissionsTable.style.display = 'none';
            }
          });
          
          document.getElementById(`closePermissionsBtn_${userId}`)?.addEventListener('click', () => {
            document.getElementById(`permissionsTable_${userId}`).style.display = 'none';
          });
        }
        // Yetki tablosu oluÅŸturma fonksiyonu - Teklifbul Rule v1.0
        function generatePermissionsTable(buyerRole, supplierRole, buyerRoles, supplierRoles) {
          // Rol yetkileri tanÄ±mlarÄ± - Teklifbul Rol & Onay Sistemi
          const rolePermissions = {
            // === SatÄ±n alma hiyerarÅŸisi (e-imza onay YOK) ===
            'buyer:satinalma_uzman_yardimcisi': {
              'Talep OluÅŸturma': true,
              'Talep DÃ¼zenleme': true,
              'Talep Silme': true,
              'Teklif GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onaylama': false,
              'Åirket Bilgileri DÃ¼zenleme': true,
              'KullanÄ±cÄ± YÃ¶netimi': true,
              'TÃ¼m Talepleri GÃ¶rÃ¼ntÃ¼leme': true,
              'Talep Atama/Delege': true,
              'Talep TedarikÃ§iye Ä°letme': true,
              'Mukayese GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onay (Ä°mza)': false,
              'Islak Ä°mza YÃ¼kleme': true,
              'Onay PolitikasÄ± YÃ¶netimi': false,
              'Onay Limiti YÃ¶netimi': false,
              'Onay Yetkilisi Atama': false
            },
            'buyer:satinalma_uzmani': {
              'Talep OluÅŸturma': true,
              'Talep DÃ¼zenleme': true,
              'Talep Silme': true,
              'Teklif GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onaylama': false,
              'Åirket Bilgileri DÃ¼zenleme': true,
              'KullanÄ±cÄ± YÃ¶netimi': true,
              'TÃ¼m Talepleri GÃ¶rÃ¼ntÃ¼leme': true,
              'Talep Atama/Delege': true,
              'Talep TedarikÃ§iye Ä°letme': true,
              'Mukayese GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onay (Ä°mza)': false,
              'Islak Ä°mza YÃ¼kleme': true,
              'Onay PolitikasÄ± YÃ¶netimi': false,
              'Onay Limiti YÃ¶netimi': false,
              'Onay Yetkilisi Atama': false
            },
            'buyer:satinalma_yetkilisi': {
              'Talep OluÅŸturma': true,
              'Talep DÃ¼zenleme': true,
              'Talep Silme': true,
              'Teklif GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onaylama': false,
              'Åirket Bilgileri DÃ¼zenleme': true,
              'KullanÄ±cÄ± YÃ¶netimi': true,
              'TÃ¼m Talepleri GÃ¶rÃ¼ntÃ¼leme': true,
              'Talep Atama/Delege': true,
              'Talep TedarikÃ§iye Ä°letme': true,
              'Mukayese GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onay (Ä°mza)': false,
              'Islak Ä°mza YÃ¼kleme': true,
              'Onay PolitikasÄ± YÃ¶netimi': false,
              'Onay Limiti YÃ¶netimi': false,
              'Onay Yetkilisi Atama': false
            },
            'buyer:satinalma_muduru': {
              'Talep OluÅŸturma': true,
              'Talep DÃ¼zenleme': true,
              'Talep Silme': true,
              'Teklif GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onaylama': false,
              'Åirket Bilgileri DÃ¼zenleme': true,
              'KullanÄ±cÄ± YÃ¶netimi': true,
              'TÃ¼m Talepleri GÃ¶rÃ¼ntÃ¼leme': true,
              'Talep Atama/Delege': true,
              'Talep TedarikÃ§iye Ä°letme': true,
              'Mukayese GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onay (Ä°mza)': false,
              'Islak Ä°mza YÃ¼kleme': true,
              'Onay PolitikasÄ± YÃ¶netimi': false,
              'Onay Limiti YÃ¶netimi': false,
              'Onay Yetkilisi Atama': false
            },
            // === Ãœst yÃ¶netim (e-imza onay VAR) ===
            'buyer:genel_mudur': {
              'Talep OluÅŸturma': true,
              'Talep DÃ¼zenleme': true,
              'Talep Silme': true,
              'Teklif GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onaylama': true,
              'Åirket Bilgileri DÃ¼zenleme': true,
              'KullanÄ±cÄ± YÃ¶netimi': true,
              'TÃ¼m Talepleri GÃ¶rÃ¼ntÃ¼leme': true,
              'Talep Atama/Delege': true,
              'Talep TedarikÃ§iye Ä°letme': true,
              'Mukayese GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onay (Ä°mza)': true,
              'Islak Ä°mza YÃ¼kleme': true,
              'Onay PolitikasÄ± YÃ¶netimi': true,
              'Onay Limiti YÃ¶netimi': true,
              'Onay Yetkilisi Atama': true
            },
            'buyer:genel_mudur_yardimcisi': {
              'Talep OluÅŸturma': true,
              'Talep DÃ¼zenleme': true,
              'Talep Silme': true,
              'Teklif GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onaylama': true,
              'Åirket Bilgileri DÃ¼zenleme': true,
              'KullanÄ±cÄ± YÃ¶netimi': false,
              'TÃ¼m Talepleri GÃ¶rÃ¼ntÃ¼leme': true,
              'Talep Atama/Delege': true,
              'Talep TedarikÃ§iye Ä°letme': true,
              'Mukayese GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onay (Ä°mza)': true,
              'Islak Ä°mza YÃ¼kleme': true,
              'Onay PolitikasÄ± YÃ¶netimi': false,
              'Onay Limiti YÃ¶netimi': false,
              'Onay Yetkilisi Atama': false
            },
            'buyer:ceo': {
              'Talep OluÅŸturma': true,
              'Talep DÃ¼zenleme': true,
              'Talep Silme': true,
              'Teklif GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onaylama': true,
              'Åirket Bilgileri DÃ¼zenleme': true,
              'KullanÄ±cÄ± YÃ¶netimi': true,
              'TÃ¼m Talepleri GÃ¶rÃ¼ntÃ¼leme': true,
              'Talep Atama/Delege': true,
              'Talep TedarikÃ§iye Ä°letme': true,
              'Mukayese GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onay (Ä°mza)': true,
              'Islak Ä°mza YÃ¼kleme': true,
              'Onay PolitikasÄ± YÃ¶netimi': true,
              'Onay Limiti YÃ¶netimi': true,
              'Onay Yetkilisi Atama': true
            },
            'buyer:isveren': {
              'Talep OluÅŸturma': true,
              'Talep DÃ¼zenleme': true,
              'Talep Silme': true,
              'Teklif GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onaylama': true,
              'Åirket Bilgileri DÃ¼zenleme': true,
              'KullanÄ±cÄ± YÃ¶netimi': true,
              'TÃ¼m Talepleri GÃ¶rÃ¼ntÃ¼leme': true,
              'Talep Atama/Delege': true,
              'Talep TedarikÃ§iye Ä°letme': true,
              'Mukayese GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onay (Ä°mza)': true,
              'Islak Ä°mza YÃ¼kleme': true,
              'Onay PolitikasÄ± YÃ¶netimi': true,
              'Onay Limiti YÃ¶netimi': true,
              'Onay Yetkilisi Atama': true
            },
            'buyer:yonetim_kurulu_baskani': {
              'Talep OluÅŸturma': true,
              'Talep DÃ¼zenleme': true,
              'Talep Silme': true,
              'Teklif GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onaylama': true,
              'Åirket Bilgileri DÃ¼zenleme': true,
              'KullanÄ±cÄ± YÃ¶netimi': true,
              'TÃ¼m Talepleri GÃ¶rÃ¼ntÃ¼leme': true,
              'Talep Atama/Delege': true,
              'Talep TedarikÃ§iye Ä°letme': true,
              'Mukayese GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onay (Ä°mza)': true,
              'Islak Ä°mza YÃ¼kleme': true,
              'Onay PolitikasÄ± YÃ¶netimi': true,
              'Onay Limiti YÃ¶netimi': true,
              'Onay Yetkilisi Atama': true
            },
            'buyer:yonetim_kurulu_uyesi': {
              'Talep OluÅŸturma': true,
              'Talep DÃ¼zenleme': true,
              'Talep Silme': true,
              'Teklif GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onaylama': true,
              'Åirket Bilgileri DÃ¼zenleme': true,
              'KullanÄ±cÄ± YÃ¶netimi': false,
              'TÃ¼m Talepleri GÃ¶rÃ¼ntÃ¼leme': true,
              'Talep Atama/Delege': true,
              'Talep TedarikÃ§iye Ä°letme': true,
              'Mukayese GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onay (Ä°mza)': true,
              'Islak Ä°mza YÃ¼kleme': true,
              'Onay PolitikasÄ± YÃ¶netimi': true,
              'Onay Limiti YÃ¶netimi': true,
              'Onay Yetkilisi Atama': true
            },
            // === DiÄŸer buyer rolleri ===
            'buyer:proje_yoneticisi': {
              'Talep OluÅŸturma': true,
              'Talep DÃ¼zenleme': true,
              'Talep Silme': false,
              'Teklif GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onaylama': false,
              'Åirket Bilgileri DÃ¼zenleme': false,
              'KullanÄ±cÄ± YÃ¶netimi': false,
              'TÃ¼m Talepleri GÃ¶rÃ¼ntÃ¼leme': false,
              'Talep Atama/Delege': false,
              'Talep TedarikÃ§iye Ä°letme': false,
              'Mukayese GÃ¶rÃ¼ntÃ¼leme': true,
              'Teklif Onay (Ä°mza)': false,
              'Islak Ä°mza YÃ¼kleme': false,
              'Onay PolitikasÄ± YÃ¶netimi': false,
              'Onay Limiti YÃ¶netimi': false,
              'Onay Yetkilisi Atama': false
            },
            // === TedarikÃ§i rolleri ===
            'supplier:satici': {
              'Teklif Verme': true,
              'Teklif DÃ¼zenleme': true,
              'Teklif Silme': false,
              'Talep GÃ¶rÃ¼ntÃ¼leme': true,
              'Talep Detay GÃ¶rÃ¼ntÃ¼leme': true,
              'Åirket Bilgileri DÃ¼zenleme': false,
              'KullanÄ±cÄ± YÃ¶netimi': false
            },
            'supplier:satis_muduru': {
              'Teklif Verme': true,
              'Teklif DÃ¼zenleme': true,
              'Teklif Silme': true,
              'Talep GÃ¶rÃ¼ntÃ¼leme': true,
              'Talep Detay GÃ¶rÃ¼ntÃ¼leme': true,
              'Åirket Bilgileri DÃ¼zenleme': false,
              'KullanÄ±cÄ± YÃ¶netimi': false
            },
            'supplier:satis_yoneticisi': {
              'Teklif Verme': true,
              'Teklif DÃ¼zenleme': true,
              'Teklif Silme': true,
              'Talep GÃ¶rÃ¼ntÃ¼leme': true,
              'Talep Detay GÃ¶rÃ¼ntÃ¼leme': true,
              'Åirket Bilgileri DÃ¼zenleme': true,
              'KullanÄ±cÄ± YÃ¶netimi': false
            },
            'supplier:genel_mudur': {
              'Teklif Verme': true,
              'Teklif DÃ¼zenleme': true,
              'Teklif Silme': true,
              'Talep GÃ¶rÃ¼ntÃ¼leme': true,
              'Talep Detay GÃ¶rÃ¼ntÃ¼leme': true,
              'Åirket Bilgileri DÃ¼zenleme': true,
              'KullanÄ±cÄ± YÃ¶netimi': true
            }
          };
          
          let html = '';
          
          // AlÄ±cÄ± rolÃ¼ varsa
          if (buyerRole && buyerRole.includes('buyer')) {
            const permissions = rolePermissions[buyerRole] || {};
            const roleLabel = buyerRoles.find(r => (typeof r === 'string' ? r : r.value) === buyerRole)?.label || buyerRole.split(':')[1] || buyerRole;
            html += `
              <div style="margin-bottom:20px;">
                <h5 style="margin:0 0 12px 0; font-size:13px; color:#1f2937; font-weight:600; padding-bottom:8px; border-bottom:1px solid #e5e7eb;">
                  ğŸ“‹ AlÄ±cÄ± RolÃ¼: ${roleLabel}
                </h5>
                <table style="width:100%; border-collapse:collapse; font-size:12px;">
                  <thead>
                    <tr style="background:#f9fafb;">
                      <th style="padding:8px; text-align:left; border-bottom:1px solid #e5e7eb; font-weight:600; color:#374151;">Yetki</th>
                      <th style="padding:8px; text-align:center; border-bottom:1px solid #e5e7eb; font-weight:600; color:#374151; width:100px;">Durum</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${Object.entries(permissions).map(([perm, hasAccess]) => `
                      <tr>
                        <td style="padding:8px; border-bottom:1px solid #f3f4f6; color:#1f2937;">${perm}</td>
                        <td style="padding:8px; text-align:center; border-bottom:1px solid #f3f4f6;">
                          ${hasAccess ? '<span style="padding:2px 8px; background:#d1fae5; color:#065f46; border-radius:4px; font-size:11px; font-weight:600;">âœ… Var</span>' : '<span style="padding:2px 8px; background:#fee2e2; color:#dc2626; border-radius:4px; font-size:11px; font-weight:600;">âŒ Yok</span>'}
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `;
          }
          
          // TedarikÃ§i rolÃ¼ varsa
          if (supplierRole && supplierRole.includes('supplier')) {
            const permissions = rolePermissions[supplierRole] || {};
            const roleLabel = supplierRoles.find(r => (typeof r === 'string' ? r : r.value) === supplierRole)?.label || supplierRole.split(':')[1] || supplierRole;
            html += `
              <div style="margin-top:20px;">
                <h5 style="margin:0 0 12px 0; font-size:13px; color:#1f2937; font-weight:600; padding-bottom:8px; border-bottom:1px solid #e5e7eb;">
                  ğŸ“¦ TedarikÃ§i RolÃ¼: ${roleLabel}
                </h5>
                <table style="width:100%; border-collapse:collapse; font-size:12px;">
                  <thead>
                    <tr style="background:#f9fafb;">
                      <th style="padding:8px; text-align:left; border-bottom:1px solid #e5e7eb; font-weight:600; color:#374151;">Yetki</th>
                      <th style="padding:8px; text-align:center; border-bottom:1px solid #e5e7eb; font-weight:600; color:#374151; width:100px;">Durum</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${Object.entries(permissions).map(([perm, hasAccess]) => `
                      <tr>
                        <td style="padding:8px; border-bottom:1px solid #f3f4f6; color:#1f2937;">${perm}</td>
                        <td style="padding:8px; text-align:center; border-bottom:1px solid #f3f4f6;">
                          ${hasAccess ? '<span style="padding:2px 8px; background:#d1fae5; color:#065f46; border-radius:4px; font-size:11px; font-weight:600;">âœ… Var</span>' : '<span style="padding:2px 8px; background:#fee2e2; color:#dc2626; border-radius:4px; font-size:11px; font-weight:600;">âŒ Yok</span>'}
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `;
          }
          
          if (!html) {
            html = '<p style="color:#6b7280; text-align:center; padding:20px;">Rol yetkileri yÃ¼kleniyor...</p>';
          }
          
          return html;
        }
      } catch (e) {
        logger.error('Aktif kullanÄ±cÄ±lar yÃ¼klenirken hata', e);
        activeUsersList.innerHTML = `<div style="text-align:center; padding:20px; color:#ef4444;"><p>âŒ Hata: ${e.message || e}</p></div>`;
      }
    }
    // Åirket kodu ile kayÄ±t isteÄŸini onayla - Teklifbul Rule v1.0
    window.approveCompanyJoinRequest = async function(requestId, userId, companyId, role) {
      if (!confirm('Bu kullanÄ±cÄ±yÄ± seÃ§tiÄŸiniz rol ile ÅŸirkete eklemek istediÄŸinizden emin misiniz?')) return;
      
      try {
        const { doc, getDoc, updateDoc, serverTimestamp } = await getFirestoreModules();
        const requestRef = doc(db, 'companyJoinRequests', requestId);
        const requestDoc = await getDoc(requestRef);
        
        if (!requestDoc.exists()) {
          toast.error(MESSAGES.ERROR_REQUEST_NOT_FOUND);
          return;
        }
        
        const requestData = requestDoc.data();
        
        // Rol dizisini oluÅŸtur
        const roles = [];
        if (role === 'buyer' || role === 'both') roles.push('buyer');
        if (role === 'supplier' || role === 'both') roles.push('supplier');
        
        // KullanÄ±cÄ±yÄ± ÅŸirkete ekle
        const userRef = doc(db, 'users', userId);
        const userDoc = await getDoc(userRef);
        
        if (userDoc.exists()) {
          const userData = userDoc.data();
          const companies = userData.companies || [];
          
          // Åirket zaten eklenmiÅŸ mi kontrol et
          if (!companies.includes(companyId)) {
            companies.push(companyId);
          }
          
          await updateDoc(userRef, {
            companies: companies,
            activeCompanyId: companyId,
            companyId: companyId,
            roles: roles,
            companyJoinStatus: 'accepted', // Teklifbul Rule v1.0 - Bekleme sayfasÄ± iÃ§in
            updatedAt: serverTimestamp()
          });
        }
        
        // Ä°steÄŸi onaylandÄ± olarak iÅŸaretle
        await updateDoc(requestRef, {
          status: 'accepted',
          approvedRole: role,
          approvedAt: serverTimestamp(),
          approvedBy: auth.currentUser?.uid || null
        });
        
        // Åirket bilgilerini kullanÄ±cÄ±ya otomatik doldur (eÄŸer ÅŸirket bilgileri varsa)
        try {
          const companyRef = doc(db, 'companies', companyId);
          const companyDoc = await getDoc(companyRef);
          
          if (companyDoc.exists()) {
            const companyData = companyDoc.data();
            
            // Åirket bilgilerini kullanÄ±cÄ±ya kopyala (sadece boÅŸ alanlar)
            const updateFields = {};
            if (companyData.name && !userDoc.data()?.companyName) updateFields.companyName = companyData.name;
            if (companyData.taxNumber && !userDoc.data()?.taxNumber) updateFields.taxNumber = companyData.taxNumber;
            if (companyData.taxOffice && !userDoc.data()?.taxOffice) updateFields.taxOffice = companyData.taxOffice;
            if (companyData.invoiceAddress && !userDoc.data()?.invoiceAddress) updateFields.invoiceAddress = companyData.invoiceAddress;
            if (companyData.bankDetails && !userDoc.data()?.bankDetails) updateFields.bankDetails = companyData.bankDetails;
            if (companyData.categories && !userDoc.data()?.buyerCategories) updateFields.buyerCategories = companyData.categories;
            if (companyData.mersisNo && !userDoc.data()?.mersisNo) updateFields.mersisNo = companyData.mersisNo;
            if (companyData.taxPlate && !userDoc.data()?.taxPlate) updateFields.taxPlate = companyData.taxPlate;
            if (companyData.googleBusinessUrl && !userDoc.data()?.googleBusinessUrl) updateFields.googleBusinessUrl = companyData.googleBusinessUrl;
            
            if (Object.keys(updateFields).length > 0) {
              updateFields.updatedAt = serverTimestamp();
              await updateDoc(userRef, updateFields);
            }
          }
        } catch (e) {
          logger.warn('Åirket bilgileri kopyalanÄ±rken hata', e);
        }
        
        // Ä°stekleri yeniden yÃ¼kle
        const companyCode = requestData.companyCode;
        await loadCompanyJoinRequests(companyCode, companyId);
        
        // Aktif kullanÄ±cÄ±lar listesini de gÃ¼ncelle
        await loadActiveCompanyUsers(companyId);
        
        toast.success(MESSAGES.SUCCESS_USER_ADDED_TO_COMPANY);
      } catch (e) {
        logger.error('Åirket kodu ile kayÄ±t isteÄŸi onaylanÄ±rken hata', e);
        toast.error(MESSAGES.ERROR_REQUEST_APPROVE + ': ' + (e?.message || e));
      }
    };
    
    // Åirket kodu ile kayÄ±t isteÄŸini reddet - Teklifbul Rule v1.0
    window.rejectCompanyJoinRequest = async function(requestId) {
      if (!confirm('Bu isteÄŸi reddetmek istediÄŸinizden emin misiniz? KullanÄ±cÄ±nÄ±n kaydÄ± silinecek ve bekleme sayfasÄ±nda reddedildi mesajÄ± gÃ¶recek.')) return;
      
      try {
        const { doc, getDoc, updateDoc, serverTimestamp } = await getFirestoreModules();
        const requestRef = doc(db, 'companyJoinRequests', requestId);
        const requestDoc = await getDoc(requestRef);
        
        if (!requestDoc.exists()) {
          toast.error(MESSAGES.ERROR_REQUEST_NOT_FOUND);
          return;
        }
        
        const requestData = requestDoc.data();
        const userId = requestData.userId;
        
        // KullanÄ±cÄ±nÄ±n durumunu 'rejected' olarak iÅŸaretle (bekleme sayfasÄ± reddedildi gÃ¶sterecek)
        try {
          const userRef = doc(db, 'users', userId);
          const userDoc = await getDoc(userRef);
          
          if (userDoc.exists()) {
            await updateDoc(userRef, {
              companyJoinStatus: 'rejected', // Teklifbul Rule v1.0 - Bekleme sayfasÄ± iÃ§in
              updatedAt: serverTimestamp()
            });
          }
        } catch (userUpdateError) {
          logger.warn('KullanÄ±cÄ± durumu gÃ¼ncellenirken hata', userUpdateError);
        }
        
        // Ä°steÄŸi reddedildi olarak iÅŸaretle
        await updateDoc(requestRef, {
          status: 'rejected',
          rejectedAt: serverTimestamp(),
          rejectedBy: auth.currentUser?.uid || null
        });
        
        // Ä°stekleri yeniden yÃ¼kle
        const companyCode = requestData.companyCode;
        const companyId = requestData.companyId;
        if (companyCode) {
          await loadCompanyJoinRequests(companyCode, companyId);
        }
        
        toast.success(MESSAGES.SUCCESS_REQUEST_REJECTED);
      } catch (e) {
        logger.error('Åirket kodu ile kayÄ±t isteÄŸi reddedilirken hata', e);
        toast.error(MESSAGES.ERROR_REQUEST_REJECT + ': ' + (e?.message || e));
      }
    };
    
    // Bekleyen ÅŸirket katÄ±lÄ±m isteklerini yÃ¼kle - Teklifbul Rule v1.0
    async function loadCompanyJoinRequests(companyCode, companyId) {
      const requestsList = document.getElementById('companyJoinRequestsList');
      
      if (!requestsList) {
        logger.warn('Bekleyen istekler listesi bulunamadÄ±');
        return;
      }
      
      requestsList.innerHTML = '<div style="text-align:center; padding:20px; color:#6b7280;"><p>YÃ¼kleniyor...</p></div>';
      
      try {
        const { collection, query, where, orderBy, getDocs, doc, getDoc } = await getFirestoreModules();
        
        // companyJoinRequests koleksiyonundan bekleyen istekleri bul
        const requestsQuery = query(
          collection(db, 'companyJoinRequests'),
          where('companyCode', '==', companyCode),
          where('status', '==', 'pending'),
          orderBy('createdAt', 'desc')
        );
        
        const requestsSnapshot = await getDocs(requestsQuery);
        
        if (requestsSnapshot.empty) {
          requestsList.innerHTML = '<div style="text-align:center; padding:20px; color:#6b7280;"><p>HenÃ¼z bekleyen istek yok.</p></div>';
          return;
        }
        
        requestsList.innerHTML = '';
        
        // Her istek iÃ§in kart oluÅŸtur
        for (const requestDoc of requestsSnapshot.docs) {
          const requestData = requestDoc.data();
          const requestId = requestDoc.id;
          let userId = requestData.userId;
          
          // Teklifbul Rule v1.0 - userId kontrolÃ¼ (undefined ise requesterUserId'yi dene)
          if (!userId || typeof userId !== 'string' || userId.trim() === '') {
            // requesterUserId varsa onu kullan
            if (requestData.requesterUserId && typeof requestData.requesterUserId === 'string') {
              userId = requestData.requesterUserId;
              // Otomatik olarak dÃ¼zelt (kaydet)
              try {
                const { doc: docFn, updateDoc } = await getFirestoreModules();
                await updateDoc(docFn(db, 'companyJoinRequests', requestId), { userId: userId });
                logger.info(`${requestId}: requesterUserId â†’ userId otomatik dÃ¼zeltildi`, { userId });
              } catch (autoFixError) {
                logger.warn(`${requestId}: Otomatik dÃ¼zeltme hatasÄ±`, autoFixError);
              }
            } else {
              logger.warn('GeÃ§ersiz userId', { requestId, requestData });
              continue; // Bu isteÄŸi atla
            }
          }
          
          const userEmail = requestData.userEmail || 'E-posta bulunamadÄ±';
          const requestedRole = requestData.requestedRole || requestData.requestedCompanyRole || 'Rol belirtilmemiÅŸ';
          const createdAt = requestData.createdAt?.toDate?.() || new Date();
          
          // KullanÄ±cÄ± bilgilerini al
          let userDisplayName = userEmail;
          let userEmailFinal = userEmail;
          try {
            // userId geÃ§erli olduÄŸundan emin ol
            if (userId && typeof userId === 'string' && userId.trim() !== '') {
              const userDoc = await getDoc(doc(db, 'users', userId));
              if (userDoc.exists()) {
                const userInfo = userDoc.data();
                userDisplayName = userInfo.displayName || userInfo.name || userInfo.email || userEmail;
                userEmailFinal = userInfo.email || userEmail;
              }
            }
          } catch (e) {
            logger.warn('KullanÄ±cÄ± bilgileri alÄ±nÄ±rken hata', e, { userId, requestId });
            // Hata olsa bile devam et, mevcut bilgileri kullan
          }
          
          // Rol etiketini oluÅŸtur
          let roleLabel = 'Rol belirtilmemiÅŸ';
          if (requestedRole && requestedRole !== 'Rol belirtilmemiÅŸ') {
            if (requestedRole.includes(':')) {
              roleLabel = requestedRole.split(':')[1];
            } else if (requestedRole.includes('supplier') || requestedRole.includes('buyer')) {
              // Basit rol formatÄ± (supplier/buyer)
              roleLabel = requestedRole === 'supplier' ? 'TedarikÃ§i' : requestedRole === 'buyer' ? 'AlÄ±cÄ±' : requestedRole;
            } else {
              roleLabel = requestedRole;
            }
          }
          
          const requestCard = document.createElement('div');
          requestCard.style.cssText = 'padding:16px; border:1px solid #e5e7eb; border-radius:8px; background:white; margin-bottom:12px;';
          
          requestCard.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px; flex-wrap:wrap; gap:12px;">
              <div style="flex:1; min-width:200px;">
                <h4 style="margin:0 0 4px 0; font-size:15px; font-weight:600; color:#1f2937;">${userDisplayName || 'KullanÄ±cÄ± adÄ± bulunamadÄ±'}</h4>
                <p style="margin:0 0 4px 0; font-size:13px; color:#6b7280;">${userEmailFinal || 'E-posta bulunamadÄ±'}</p>
                <p style="margin:0; font-size:12px; color:#9ca3af;">
                  Ä°stek Tarihi: ${createdAt.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}
                </p>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <span style="padding:4px 12px; background:#f3f4f6; color:#374151; border-radius:6px; font-size:12px; font-weight:600;">
                  ğŸ“‹ ${roleLabel}
                </span>
              </div>
            </div>
            <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
              <button 
                onclick="approveCompanyJoinRequest('${requestId}', '${userId}', '${companyId}', '${requestedRole}')"
                style="padding:8px 16px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600; transition:background 0.2s;"
                onmouseover="this.style.background='#059669'"
                onmouseout="this.style.background='#10b981'"
              >
                âœ… Onayla
              </button>
              <button 
                onclick="rejectCompanyJoinRequest('${requestId}')"
                style="padding:8px 16px; background:#ef4444; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600; transition:background 0.2s;"
                onmouseover="this.style.background='#dc2626'"
                onmouseout="this.style.background='#ef4444'"
              >
                âŒ Reddet
              </button>
            </div>
          `;
          
          requestsList.appendChild(requestCard);
        }
      } catch (e) {
        logger.error('Bekleyen istekler yÃ¼klenirken hata', e);
        requestsList.innerHTML = `<div style="text-align:center; padding:20px; color:#ef4444;"><p>âŒ Hata: ${e.message || e}</p></div>`;
      }
    }
    
    // Bekleyen istekleri dÃ¼zelt - Teklifbul Rule v1.0
    window.fixCompanyJoinRequests = async function() {
      const btnFix = document.getElementById('btnFixJoinRequests');
      if (btnFix) {
        btnFix.disabled = true;
        btnFix.textContent = 'â³ DÃ¼zeltiliyor...';
      }
      
      try {
        const { collection, getDocs, updateDoc, doc: docFn, getDoc, query, where } = await getFirestoreModules();
        
        // KullanÄ±cÄ± ve ÅŸirket bilgilerini al
        const currentUser = await getCurrentUser();
        const userDoc = await getDoc(docFn(db, 'users', currentUser.uid));
        if (!userDoc.exists()) {
          toast.error(MESSAGES.ERROR_USER_INFO_LOAD);
          return;
        }
        
        const userData = userDoc.data();
        const companyId = userData.companyId || (userData.companies && userData.companies[0]);
        if (!companyId) {
          toast.error(MESSAGES.ERROR_COMPANY_INFO_NOT_FOUND);
          return;
        }
        
        // Åirket bilgilerini al
        const companyDoc = await getDoc(docFn(db, 'companies', companyId));
        if (!companyDoc.exists()) {
          toast.error(MESSAGES.ERROR_COMPANY_NOT_FOUND);
          return;
        }
        
        const companyData = companyDoc.data();
        const companyCode = companyData.code;
        if (!companyCode) {
          toast.error(MESSAGES.ERROR_COMPANY_CODE_NOT_FOUND);
          return;
        }
        
        // Bu ÅŸirkete ait bekleyen istekleri bul
        const requestsQuery = query(
          collection(db, 'companyJoinRequests'),
          where('companyCode', '==', companyCode),
          where('status', '==', 'pending')
        );
        
        const requestsSnapshot = await getDocs(requestsQuery);
        
        if (requestsSnapshot.empty) {
          toast.success(MESSAGES.SUCCESS_NO_PENDING_REQUESTS);
          if (btnFix) {
            btnFix.disabled = false;
            btnFix.textContent = 'ğŸ”§ Eksik Bilgileri DÃ¼zelt';
          }
          return;
        }
        
        let fixedCount = 0;
        let skippedCount = 0;
        
        for (const requestDoc of requestsSnapshot.docs) {
          const requestId = requestDoc.id;
          const requestData = requestDoc.data();
          
          try {
            let userId = requestData.userId;
            let needsUpdate = false;
            const updateData = {};
            
            // EÄŸer userId yoksa, requesterUserId'yi kullan
            if (!userId || typeof userId !== 'string' || userId.trim() === '') {
              if (requestData.requesterUserId && typeof requestData.requesterUserId === 'string') {
                userId = requestData.requesterUserId;
                updateData.userId = userId;
                needsUpdate = true;
                logger.info(`${requestId}: requesterUserId â†’ userId kopyalandÄ±`);
              } else {
                logger.warn(`${requestId}: userId ve requesterUserId bulunamadÄ±`);
                skippedCount++;
                continue;
              }
            }
            
            // KullanÄ±cÄ± bilgilerini kontrol et
            let userEmail = requestData.userEmail;
            
            if (userId) {
              try {
                const userDocForRequest = await getDoc(docFn(db, 'users', userId));
                if (userDocForRequest.exists()) {
                  const userDataForRequest = userDocForRequest.data();
                  
                  // Email eksikse kullanÄ±cÄ±dan al
                  if (!userEmail || userEmail === 'E-posta bulunamadÄ±') {
                    const userEmailFromDoc = userDataForRequest.email || userDataForRequest.userEmail;
                    if (userEmailFromDoc) {
                      updateData.userEmail = userEmailFromDoc;
                      needsUpdate = true;
                    }
                  }
                }
              } catch (userError) {
                logger.warn(`${requestId}: KullanÄ±cÄ± bilgileri alÄ±nÄ±rken hata`, userError);
              }
            }
            
            // Rol bilgilerini kontrol et
            let requestedRole = requestData.requestedRole;
            
            // EÄŸer requestedRole yoksa, role objesinden Ã§Ä±kar
            if (!requestedRole && requestData.role) {
              if (typeof requestData.role === 'string') {
                requestedRole = requestData.role;
                updateData.requestedRole = requestedRole;
                needsUpdate = true;
              } else if (typeof requestData.role === 'object') {
                const roleObj = requestData.role;
                if (roleObj.supplier) {
                  requestedRole = 'supplier';
                } else if (roleObj.buyer) {
                  requestedRole = 'buyer';
                } else {
                  requestedRole = 'buyer';
                }
                updateData.requestedRole = requestedRole;
                needsUpdate = true;
              }
            }
            
            // requestedCompanyRole eksikse oluÅŸtur
            if (!requestData.requestedCompanyRole && requestedRole) {
              if (requestedRole === 'supplier') {
                updateData.requestedCompanyRole = 'supplier:tedarikci';
              } else if (requestedRole === 'buyer') {
                updateData.requestedCompanyRole = 'buyer:satinalma_yetkilisi';
              } else {
                updateData.requestedCompanyRole = requestedRole;
              }
              needsUpdate = true;
            }
            
            // companyCode eksikse, companyId'den ÅŸirket bilgilerini al
            if (!requestData.companyCode && requestData.companyId) {
              try {
                const companyDocForRequest = await getDoc(docFn(db, 'companies', requestData.companyId));
                if (companyDocForRequest.exists()) {
                  const companyDataForRequest = companyDocForRequest.data();
                  if (companyDataForRequest.code) {
                    updateData.companyCode = companyDataForRequest.code;
                    needsUpdate = true;
                  }
                }
              } catch (companyError) {
                logger.warn(`${requestId}: Åirket bilgileri alÄ±nÄ±rken hata`, companyError);
              }
            }
            
            // GÃ¼ncelleme yap
            if (needsUpdate) {
              await updateDoc(docFn(db, 'companyJoinRequests', requestId), updateData);
              fixedCount++;
            }
            
          } catch (error) {
            logger.error(`${requestId}: Hata`, error);
          }
        }
        
        showToastNotification(`âœ… ${fixedCount} kayÄ±t dÃ¼zeltildi. ${skippedCount} kayÄ±t atlandÄ±.`, 'success');
        
        // Ä°stekleri yeniden yÃ¼kle (zaten companyCode ve companyId mevcut)
        await loadCompanyJoinRequests(companyCode, companyId);
        
      } catch (e) {
        logger.error('Ä°stekler dÃ¼zeltilirken hata', e);
        toast.error(MESSAGES.ERROR_GENERAL + ': ' + (e.message || e));
      } finally {
        if (btnFix) {
          btnFix.disabled = false;
          btnFix.textContent = 'ğŸ”§ Eksik Bilgileri DÃ¼zelt';
        }
      }
    };
    
    // DÃ¼zeltme butonu event listener
    document.addEventListener('DOMContentLoaded', () => {
      const btnFix = document.getElementById('btnFixJoinRequests');
      if (btnFix) {
        btnFix.addEventListener('click', () => {
          if (confirm('Bekleyen isteklerdeki eksik bilgileri dÃ¼zeltmek istediÄŸinizden emin misiniz?')) {
            window.fixCompanyJoinRequests();
          }
        });
      }
    });
    
    // KullanÄ±cÄ± rolÃ¼nÃ¼ gÃ¼ncelle - Teklifbul Rule v1.0
    async function updateUserRole(userId, companyId, newRoles) {
      // newRoles bir array veya string olabilir - Teklifbul Rule v1.0
      const rolesArray = Array.isArray(newRoles) ? newRoles : [newRoles];
      
      if (rolesArray.length === 0) {
        toast.warn(MESSAGES.WARN_ROLE_SELECT_REQUIRED);
        return;
      }
      
      if (!confirm('KullanÄ±cÄ±nÄ±n rolÃ¼nÃ¼ gÃ¼ncellemek istediÄŸinizden emin misiniz?')) return;
      
      try {
        const { doc, getDoc, updateDoc, serverTimestamp } = await getFirestoreModules();
        // Ä°lk rolÃ¼ ana rol olarak kullan (geriye dÃ¶nÃ¼k uyumluluk iÃ§in)
        const primaryRole = rolesArray[0];
        const roleParts = primaryRole.split(':');
        const roleType = roleParts[0] || 'buyer';
        const roleValue = roleParts[1] || roleParts[0] || 'satinalma_yetkilisi';
        
        // KullanÄ±cÄ± belgesini gÃ¼ncelle
        const updateData = {
          companyRole: roleValue,
          companyRoleType: roleType,
          companyRoleKey: primaryRole,
          companyRoles: rolesArray, // Ã‡oklu rol desteÄŸi
          updatedAt: serverTimestamp()
        };
        
        // KullanÄ±cÄ±nÄ±n genel rollerini de gÃ¼ncelle (buyer/supplier)
        const userDoc = await getDoc(doc(db, 'users', userId));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          const currentUserRoles = userData.roles || [];
          
          // Buyer/Supplier rollerini belirle
          const hasBuyer = rolesArray.some(r => r.includes('buyer'));
          const hasSupplier = rolesArray.some(r => r.includes('supplier'));
          
          let updatedUserRoles = [...currentUserRoles];
          if (hasBuyer && !updatedUserRoles.includes('buyer') && !updatedUserRoles.includes('both')) {
            if (updatedUserRoles.includes('supplier')) {
              updatedUserRoles = ['both'];
            } else {
              updatedUserRoles.push('buyer');
            }
          }
          if (hasSupplier && !updatedUserRoles.includes('supplier') && !updatedUserRoles.includes('both')) {
            if (updatedUserRoles.includes('buyer')) {
              updatedUserRoles = ['both'];
            } else {
              updatedUserRoles.push('supplier');
            }
          }
          
          updateData.roles = updatedUserRoles;
        }
        
        await updateDoc(doc(db, 'users', userId), updateData);
        
        const roleNames = rolesArray.map(r => {
          const parts = r.split(':');
          return parts[1] || parts[0] || r;
        }).join(', ');
        
  toast.success(MESSAGES.SUCCESS_USER_ROLES_UPDATED.replace('{roles}', roleNames));
        await loadActiveCompanyUsers(companyId);
      } catch (e) {
        logger.error('KullanÄ±cÄ± rolÃ¼ gÃ¼ncellenirken hata', e);
        toast.error(MESSAGES.ERROR_ROLE_UPDATE + ': ' + (e?.message || e));
      }
    }
    
    // KullanÄ±cÄ±yÄ± ÅŸirketten Ã§Ä±kar - Teklifbul Rule v1.0
    async function removeUserFromCompany(userId, companyId) {
      try {
        const { doc, getDoc, updateDoc, serverTimestamp } = await getFirestoreModules();
        // KullanÄ±cÄ± bilgilerini al
        const userDoc = await getDoc(doc(db, 'users', userId));
        if (!userDoc.exists()) {
          toast.error(MESSAGES.ERROR_USER_NOT_FOUND);
          return;
        }
        
        const userData = userDoc.data();
        
        // KullanÄ±cÄ±yÄ± ÅŸirketten Ã§Ä±kar
        await updateDoc(doc(db, 'users', userId), {
          companyId: null,
          companyRole: null,
          companyRoleType: null,
          companyRoleKey: null,
          companyJoinStatus: 'removed',
          removedAt: serverTimestamp(),
          removedBy: auth.currentUser?.uid || null
        });
        
        toast.success(MESSAGES.SUCCESS_USER_REMOVED);
        await loadActiveCompanyUsers(companyId);
      } catch (e) {
        logger.error('KullanÄ±cÄ± ÅŸirketten Ã§Ä±karÄ±lÄ±rken hata', e);
        toast.error(MESSAGES.ERROR_USER_REMOVE + ': ' + (e?.message || e));
      }
    }
    
    async function setupReferralCodeSystem(companyId, companyCode) {
      const generateBtn = document.getElementById('generateReferralCodeBtn');
      const codesList = document.getElementById('referralCodesList');
      
      if (!generateBtn || !codesList) return;
      
      // Mevcut referans kodlarÄ±nÄ± yÃ¼kle
      async function loadReferralCodes() {
        try {
          const { collection, getDocs } = await getFirestoreModules();
          const codesRef = collection(db, 'companies', companyId, 'referralCodes');
          const codesSnapshot = await getDocs(codesRef);
          codesList.innerHTML = '';
          
          if (codesSnapshot.empty) {
            codesList.innerHTML = '<p style="color:#6b7280; font-size:13px; margin:0;">HenÃ¼z referans kodu oluÅŸturulmamÄ±ÅŸ.</p>';
            return;
          }
          
          codesSnapshot.forEach((docSnap) => {
            const codeData = docSnap.data();
            const codeId = docSnap.id;
            const isUsed = codeData.used || false;
            const usedBy = codeData.usedBy || null;
            const usedAt = codeData.usedAt || null;
            const createdAt = codeData.createdAt?.toDate?.() || new Date();
            
            const codeCard = document.createElement('div');
            codeCard.style.cssText = 'padding:12px; border:1px solid #e5e7eb; border-radius:6px; background:white;';
            
            const statusBadge = isUsed 
              ? '<span style="padding:4px 8px; background:#ef4444; color:white; border-radius:4px; font-size:11px; font-weight:600;">KULLANILDI</span>'
              : '<span style="padding:4px 8px; background:#10b981; color:white; border-radius:4px; font-size:11px; font-weight:600;">AKTÄ°F</span>';
            
            const referralLink = `${window.location.origin}${window.location.pathname.split('/').slice(0, -1).join('/')}/signup.html?ref=${codeId}`;
            
            codeCard.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; flex-wrap:wrap; gap:8px;">
                <div style="display:flex; align-items:center; gap:8px;">
                  <strong style="font-family:monospace; font-size:16px; color:#1e40af;">${codeId}</strong>
                  ${statusBadge}
                </div>
                ${!isUsed ? `<button class="deleteCodeBtn" data-code-id="${codeId}" style="padding:6px 10px; background:#ef4444; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;">ğŸ—‘ï¸ Sil</button>` : ''}
              </div>
              <div style="font-size:12px; color:#6b7280; margin-bottom:8px;">
                OluÅŸturulma: ${createdAt.toLocaleDateString('tr-TR')} ${createdAt.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
              </div>
              ${isUsed && usedBy ? `
                <div style="font-size:12px; color:#6b7280; margin-bottom:8px;">
                  KullanÄ±ldÄ±: ${usedAt ? new Date(usedAt.toDate?.() || usedAt).toLocaleDateString('tr-TR') : 'Bilinmiyor'} - KullanÄ±cÄ± ID: ${usedBy}
                </div>
              ` : ''}
              <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
                <button class="copyLinkBtn" data-link="${referralLink}" title="Davet linkini panoya kopyala" aria-label="Davet linkini panoya kopyala" style="flex:1; min-width:200px; padding:12px 16px; background:#3b82f6; color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:500; white-space:nowrap; transition:all 0.2s; box-shadow:0 2px 4px rgba(59,130,246,0.2);" onmouseover="this.style.background='#2563eb'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(59,130,246,0.3)'" onmouseout="this.style.background='#3b82f6'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(59,130,246,0.2)'">ğŸ“‹ Davet Linkini Kopyala</button>
                <button class="copyCodeBtn" data-code="${codeId}" title="Referans kodunu panoya kopyala" aria-label="Referans kodunu panoya kopyala" style="flex:1; min-width:200px; padding:12px 16px; background:#10b981; color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:500; white-space:nowrap; transition:all 0.2s; box-shadow:0 2px 4px rgba(16,185,129,0.2);" onmouseover="this.style.background='#059669'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(16,185,129,0.3)'" onmouseout="this.style.background='#10b981'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(16,185,129,0.2)'">ğŸ“‹ Referans Kodunu Kopyala</button>
              </div>
            `;
            
            codesList.appendChild(codeCard);
          });
          
          // Copy button handlers
          document.querySelectorAll('.copyLinkBtn').forEach(btn => {
            btn.addEventListener('click', () => {
              const link = btn.dataset.link;
              navigator.clipboard?.writeText(link).then(() => {
                btn.textContent = 'âœ“';
                setTimeout(() => { btn.textContent = 'ğŸ“‹'; }, 2000);
              });
            });
          });
          
          document.querySelectorAll('.copyCodeBtn').forEach(btn => {
            btn.addEventListener('click', () => {
              const code = btn.dataset.code;
              navigator.clipboard?.writeText(code).then(() => {
                btn.textContent = 'âœ“';
                setTimeout(() => { btn.textContent = 'ğŸ“‹'; }, 2000);
              });
            });
          });
          
          // Delete button handlers
          document.querySelectorAll('.deleteCodeBtn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const codeId = btn.dataset.codeId;
              if (!confirm(`Referans kodunu "${codeId}" silmek istediÄŸinize emin misiniz?`)) return;
              
              try {
                const { doc, deleteDoc } = await getFirestoreModules();
                await deleteDoc(doc(db, 'companies', companyId, 'referralCodes', codeId));
                await loadReferralCodes();
              } catch (e) {
                toast.error(MESSAGES.ERROR_CODE_DELETE + ': ' + (e.message || e));
              }
            });
          });
          
        } catch (e) {
          logger.error('Referans kodlarÄ± yÃ¼klenirken hata', e);
          codesList.innerHTML = '<p style="color:#ef4444; font-size:13px;">Kodlar yÃ¼klenirken hata oluÅŸtu.</p>';
        }
      }
      // Yeni kod oluÅŸtur
      generateBtn.addEventListener('click', async () => {
        try {
          generateBtn.disabled = true;
          generateBtn.textContent = 'â³ OluÅŸturuluyor...';
          
          const newCode = generateReferralCode();
          const codeRef = doc(db, 'companies', companyId, 'referralCodes', newCode);
          
          await setDoc(codeRef, {
            code: newCode,
            companyId: companyId,
            companyCode: companyCode,
            createdBy: (await getCurrentUser()).uid,
            createdAt: serverTimestamp(),
            used: false,
            usedBy: null,
            usedAt: null
          });
          
          await loadReferralCodes();
          toast.success(MESSAGES.SUCCESS_REF_CODE_CREATED.replace('{code}', newCode));
        } catch (e) {
          toast.error(MESSAGES.ERROR_CODE_CREATE + ': ' + (e.message || e));
        } finally {
          generateBtn.disabled = false;
          generateBtn.textContent = 'â• Yeni Referans Kodu OluÅŸtur';
        }
      });
      
      // Ä°lk yÃ¼kleme
      await loadReferralCodes();
    }

    function populateTaxOfficeSelect(list) {
      const sel = document.getElementById("taxOfficeSelect");
      if (!sel) return;

      sel.innerHTML = "";
      const opts = [
        { v: "", t: "Vergi Dairesi SeÃ§in" },
        ...list.map(n => ({ v: n, t: n })),
        { v: "custom", t: "Elle yaz" }
      ];

      for (const o of opts) {
        const op = document.createElement('option');
        op.value = o.v;
        op.textContent = o.t;
        sel.appendChild(op);
      }
      
      // Tax offices loaded silently
    }

    async function buildTaxOfficeSelect() {
      let list = await fetchTaxOfficesFromFirestore();
      if (!list || list.length === 0) {
        logger.warn("Firestore'dan veri alÄ±namadÄ±, yerel liste kullanÄ±lÄ±yor");
        list = LOCAL_TAX_OFFICES;
      }
      populateTaxOfficeSelect(list);
    }

    function bindTaxOfficeHandlers() {
      const sel = document.getElementById('taxOfficeSelect');
      const inp = document.getElementById('taxOffice');
      const btn = document.getElementById('refreshTaxOfficesBtn');

      if (!sel || !inp) {
        logger.warn("Vergi dairesi elementleri bulunamadÄ±");
        return;
      }

      sel.addEventListener('change', () => {
        if (sel.value === 'custom' || sel.value === '') {
          inp.removeAttribute('disabled');
          inp.placeholder = 'Vergi dairesi adÄ±nÄ± elle yazÄ±n';
          if (sel.value === 'custom') inp.value = '';
          logger.info("Elle yazma modu aktif");
        } else {
          inp.value = sel.value;
          inp.setAttribute('disabled', 'disabled');
          inp.placeholder = 'SeÃ§ilen vergi dairesi';
          logger.info("SeÃ§ilen vergi dairesi", { value: sel.value });
        }
        window.__composeInvoiceAddress && window.__composeInvoiceAddress();
      });

      if (btn) {
        btn.addEventListener('click', async () => {
          btn.disabled = true;
          btn.textContent = 'â³ YÃ¼kleniyor...';
          try {
            await buildTaxOfficeSelect();
            logger.info("Vergi dairesi listesi yenilendi");
          } catch (error) {
            logger.error("Liste yenilenemedi", error);
          } finally {
            btn.disabled = false;
            btn.textContent = 'ğŸ”„ Yenile';
          }
        });
      }
    }

    // === Category Management ===
    const $cat = (s, r=document) => r.querySelector(s);
    const $$cat = (s, r=document) => Array.from(r.querySelectorAll(s));
    const chip = (text) => {
      const span = document.createElement("span");
      span.className = "chip";
      span.textContent = text;
      return span;
    };
    function uniq(arr){ return Array.from(new Set(arr)); }

    // ---- fetch categories with fallback (UPDATED: Use new ID-based system)
    async function fetchCategories() {
      try {
        // CRITICAL: Use new ID-based category system
        const allCategories = getAllCategories();
        if (allCategories && allCategories.length > 0) {
          const categoryNames = allCategories
            .filter(cat => cat.isActive !== false) // Only active categories
            .map(cat => cat.name)
            .sort((a, b) => a.localeCompare(b, "tr"));
          
          logger.info(`Yeni sistemden ${categoryNames.length} kategori yÃ¼klendi`);
          return categoryNames;
        }
      } catch(e) {
        logger.warn("Yeni kategori sistemi yÃ¼klenemedi, fallback kullanÄ±lacak", e?.message || e);
      }
      
      // Fallback: Try Firestore categories collection (legacy)
      try {
        const { collection, getDocs } = await getFirestoreModules();
        const snap = await getDocs(collection(db, "categories"));
        const list = [];
        snap.forEach(d => {
          const name = d.data()?.name || d.id;
          if (name) list.push(name);
        });
        if (list.length) {
          logger.warn(`Legacy Firestore'dan ${list.length} kategori yÃ¼klendi`);
          return uniq(list).sort((a,b)=>a.localeCompare(b,"tr"));
        }
      } catch(e) {
        logger.warn("Firestore categories collection okunamadÄ±", e?.message || e);
      }
      
      // Final fallback: Hardcoded 17-lik liste (if all else fails)
      logger.warn("Hardcoded fallback kategori listesi kullanÄ±lÄ±yor (17 kategori)");
      return [
        "Sac/Metal","Elektrik","Elektronik","Makine-Ä°malat","HÄ±rdavat","Ambalaj",
        "Kimyasal","Ä°nÅŸaat Malzemeleri","Mobilya","Boya","Plastik",
        "Otomotiv Yan Sanayi","Ä°ÅŸ GÃ¼venliÄŸi","Temizlik","GÄ±da","Hizmet","Lojistik"
      ];
    }

    // ---- render list
    function renderList({rootList, searchInput, selectAllBtn, clearBtn, chipsRoot, allItems, selected, prefix}) {
      const state = { filtered: allItems.slice() };

      function paintList() {
        rootList.innerHTML = "";
        state.filtered.forEach(name=>{
          const id = `${prefix}-${name}`.replace(/\s+/g,"_");
          
          // Yeni markup: label iÃ§inde checkbox ve span
          const label = document.createElement("label");
          label.className = "category-item";
          label.htmlFor = id;

          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.id = id;
          cb.name = "categories";
          cb.value = name;
          cb.checked = selected.has(name);
          cb.onchange = () => {
            if (cb.checked) selected.add(name);
            else selected.delete(name);
            paintChips();
          };

          const span = document.createElement("span");
          span.className = "label";
          span.textContent = name;

          label.append(cb, span);
          rootList.appendChild(label);
        });
      }

      function paintChips() {
        chipsRoot.innerHTML = "";
        [...selected].sort((a,b)=>a.localeCompare(b,"tr")).forEach(n => chipsRoot.appendChild(chip(n)));
      }

      // events
      searchInput?.addEventListener("input", ()=>{
        const q = (searchInput.value || "").toLowerCase();
        state.filtered = allItems.filter(n => n.toLowerCase().includes(q));
        paintList();
      });

      selectAllBtn?.addEventListener("click", ()=>{
        state.filtered.forEach(n => selected.add(n));
        paintList(); paintChips();
      });

      clearBtn?.addEventListener("click", ()=>{
        selected.clear();
        paintList(); paintChips();
      });

      // initial paint
      paintList();
      paintChips();

      // public api
      return {
        getValues: ()=>[...selected]
      };
    }

    // === Role Management ===
    function currentRoles() {
      const r = [];
      if (document.getElementById("roleBuyer")?.checked) r.push("buyer");
      if (document.getElementById("roleSupplier")?.checked) r.push("supplier");
      return r.length ? r : ["buyer"];
    }
    
    function toggleRoleSections() {
      const roles = currentRoles();
      const hasBuyer = roles.includes("buyer");
      const hasSupplier = roles.includes("supplier");
      logger.info("Toggle role sections", { roles, hasBuyer, hasSupplier });
      document.getElementById("secSupplierCats").style.display = hasSupplier ? "block" : "none";
      document.getElementById("secBuyerCats").style.display = hasBuyer ? "block" : "none";
    }

    // Teklifbul Rule v1.0 - User data getter (Firestore'dan kullanÄ±cÄ± verilerini al)
    async function getUserData(uid) {
      try {
        const { doc, getDoc } = await getFirestoreModules();
        const ref = doc(db, "users", uid);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          logger.warn("KullanÄ±cÄ± dokÃ¼manÄ± bulunamadÄ±", { uid });
          return null;
        }
        return snap.data();
      } catch (error) {
        logger.error("getUserData hatasÄ±", error);
        return null;
      }
    }
    // === User Profile Loading ===
    async function loadUserProfile() {
      try {
        console.debug("ğŸ”§ loadUserProfile fonksiyonu baÅŸladÄ±");
        const user = await getCurrentUser();
        const { doc, getDoc } = await getFirestoreModules();
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          logger.warn("KullanÄ±cÄ± dokÃ¼manÄ± bulunamadÄ±, boÅŸ aÃ§Ä±lacak");
          return;
        }
        const x = snap.data();
        
        // Temel alanlar - gÃ¼venli atama
        const safeSetValue = (id, value) => {
          // input/textarea/select destekle
          let el = document.querySelector(`input[id="${id}"], textarea[id="${id}"], select[id="${id}"]`);
          if (el) {
            el.value = value || "";
            return true;
          } else {
            logger.warn(`Input element bulunamadÄ±`, { id });
            return false;
          }
        };
        
        const safeSetChecked = (id, checked) => {
          const el = document.getElementById(id);
          if (el) {
            el.checked = !!checked;
            return true;
          } else {
            logger.warn(`Checkbox element bulunamadÄ±`, { id });
            return false;
          }
        };

        safeSetValue("displayName", x.displayName);
        safeSetValue("companyName", x.companyName);
        safeSetValue("taxNumber", x.taxNumber);
        safeSetValue("mersisNo", x.mersisNo);
        safeSetValue("website", x.website);
        // Teklifbul Rule v1.0 - invoiceAddress textarea kaldÄ±rÄ±ldÄ±, artÄ±k structured address parts kullanÄ±lÄ±yor
        // safeSetValue("invoiceAddress", x.invoiceAddress); // KaldÄ±rÄ±ldÄ±
        safeSetValue("taxOffice", x.taxOffice);
        // Teklifbul Rule v1.0 - Structured address parts Genel Ayarlar'dan kaldÄ±rÄ±ldÄ±
        // Adresler artÄ±k "Adres YÃ¶netimi" sekmesinden yÃ¶netiliyor
        // Burada sadece vergi dairesi yÃ¼kleniyor
        // Phones
        safeSetValue("companyPhone", x.companyPhone);
        safeSetValue("mobilePhone", x.mobilePhone);
        safeSetValue("whatsappPhone", x.whatsappPhone);
        
        // Roller - gÃ¼venli checkbox atama
        let roles = Array.isArray(x.roles) ? x.roles.slice() : (x.role ? [x.role] : ["buyer"]);
        safeSetChecked("roleBuyer", roles.includes("buyer"));
        safeSetChecked("roleSupplier", roles.includes("supplier"));
        // Roles loaded silently
        
        // Teklifbul Rule v1.0 - Roller yÃ¼klendikten sonra kategori bÃ¶lÃ¼mlerini gÃ¶ster/gizle
        toggleRoleSections();
        
        // Premium durumu - gÃ¼venli checkbox atama
        safeSetChecked("isPremium", x.isPremium);
        // Premium status loaded silently
        
        // Ä°letiÅŸim bilgileri
        if (x.contactEmails && Array.isArray(x.contactEmails)) {
          x.contactEmails.forEach(v => emails.add(v));
          renderChips("emailChips", emails);
          // Contact emails loaded silently
        }
        
        if (x.contactPhones && Array.isArray(x.contactPhones)) {
          x.contactPhones.forEach(v => phones.add(v));
          renderChips("phoneChips", phones);
          // Contact phones loaded silently
        }
        
        // Banka hesaplarÄ±
        if (x.bankAccounts && Array.isArray(x.bankAccounts)) {
          x.bankAccounts.forEach(b => addBankRow(b));
          // Bank accounts loaded silently
        }
        if (!(x.bankAccounts || []).length) addBankRow();
        // Ä°lave adresler
        // Additional addresses loaded silently
        loadAdditionalAddresses(x.additionalAddresses || []);
      }
      catch (e) {
        logger.error('Profil verileri yÃ¼klenirken hata', e);
        if (typeof showToastNotification === 'function') {
          toast.error(MESSAGES.ERROR_PROFILE_DATA_LOAD);
        }
      }
    }

    // === Event Listeners ===
    // Teklifbul Rule v1.0 - user deÄŸiÅŸkeni module scope'ta tanÄ±mlÄ±, event listener iÃ§inde tekrar tanÄ±mlanmamalÄ±
    // const user = await getCurrentUser(); // Bu satÄ±r kaldÄ±rÄ±ldÄ± - user her fonksiyon iÃ§inde alÄ±nacak
    
    // Evrensel logout
    function wireLogoutButtons() {
      document.querySelectorAll(".btn-logout, .logout-btn, #logoutBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          try {
            const { signOut } = await getAuthModules();
            await signOut(auth);
            window.location.href = "/login.html";
          } catch (e) {
            toast.error(MESSAGES.ERROR_LOGOUT_FAILED + ": " + (e?.message || e));
          }
        });
      });
    }

    // Get input elements
    const emailInput = document.getElementById("emailInput");
    const phoneInput = document.getElementById("phoneInput");

    emailInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        const v = e.target.value.trim();
        if (v && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)) {
          emails.add(v);
          renderChips("emailChips", emails);
          e.target.value = "";
        } else if (v) {
          toast.error(MESSAGES.ERROR_EMAIL_INVALID);
        }
      }
    });

    phoneInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        const v = e.target.value.trim();
        if (v) {
          phones.add(v);
          renderChips("phoneChips", phones);
          e.target.value = "";
        }
      }
    });

    // Bank rows management
    const bankBody = document.getElementById("bankBody");
    document.getElementById("addBank").onclick = () => addBankRow();

    // Role management
    ["roleBuyer", "roleSupplier"].forEach(id => {
      document.getElementById(id).addEventListener("change", toggleRoleSections);
    });

    // Add address button
    document.getElementById("addAddressBtn").onclick = addAddress;

    // === Global Save Button ===
    function initSaveButton() {
      const btnSave = document.getElementById("btnSave");
      if (!btnSave) {
        logger.warn("[settings] btnSave bulunamadÄ±, 100ms sonra tekrar denenecek");
        setTimeout(initSaveButton, 100);
        return;
      }

      logger.info("Garantili save handler baÄŸlandÄ±", { element: btnSave });

      // Remove any existing listeners by cloning the button
      const newBtn = btnSave.cloneNode(true);
      btnSave.parentNode.replaceChild(newBtn, btnSave);
      const btn = newBtn;

      btn.addEventListener("click", async (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const originalText = btn.textContent;
        try {
          logger.info("[SAVE] Kaydet butonu tÄ±klandÄ±");

          const user = await getCurrentUser();
          if (!user) { 
            toast.error(MESSAGES.ERROR_AUTH); 
            return; 
          }

          logger.info("User authenticated", { uid: user.uid });

          // Roller
          const roleBuyer = document.getElementById("roleBuyer")?.checked;
          const roleSupplier = document.getElementById("roleSupplier")?.checked;
          const roles = [];
          if (roleBuyer) roles.push("buyer");
          if (roleSupplier) roles.push("supplier");
          if (roles.length === 0) roles.push("buyer");

          // DiÄŸer alanlar
          const companyName = (document.getElementById("companyName")?.value || "").trim();
          const taxNumber = (document.getElementById("taxNumber")?.value || "").trim();
          const displayName = (document.getElementById("displayName")?.value || "").trim();
          const mersisNo = (document.getElementById("mersisNo")?.value || "").trim();
          const website = (document.getElementById("website")?.value || "").trim();
          const googleBusinessUrl = (document.getElementById("googleBusinessUrl")?.value || "").trim();
          const isPremium = document.getElementById("isPremium")?.checked || false;

          // Ä°letiÅŸim bilgileri
          const emailChips = document.querySelectorAll("#emailChips .chip");
          const contactEmails = [...emailChips].map(chip => chip.textContent.replace(" âœ•", "").trim());
          const phoneChips = document.querySelectorAll("#phoneChips .chip");
          const contactPhones = [...phoneChips].map(chip => chip.textContent.replace(" âœ•", "").trim());
          
          // Teklifbul Rule v1.0 - Structured address parts Genel Ayarlar'dan kaldÄ±rÄ±ldÄ±
          // Adresler artÄ±k "Adres YÃ¶netimi" sekmesinden yÃ¶netiliyor
          const taxOfficeEl = document.getElementById("taxOffice");
          const taxOffice = (taxOfficeEl?.value || "").trim();

          // invoiceAddressParts artÄ±k sadece "Adres YÃ¶netimi" sekmesinden gÃ¼ncelleniyor
          // Mevcut invoiceAddressParts'i koru (sadece vergi dairesi gÃ¼ncelleniyor)
          // Firestore'dan mevcut invoiceAddressParts'i al
          // Teklifbul Rule v1.0 - user deÄŸiÅŸkeni bu scope'ta zaten tanÄ±mlÄ± (line 6379)
          const { doc, getDoc } = await getFirestoreModules();
          const currentUserDoc = await getDoc(doc(db, 'users', user.uid));
          const currentUserData = currentUserDoc.exists() ? currentUserDoc.data() : {};
          const invoiceAddressParts = currentUserData.invoiceAddressParts || {};

          // Phone fields
          const companyPhone = (document.getElementById("companyPhone")?.value || "").trim();
          const mobilePhone = (document.getElementById("mobilePhone")?.value || "").trim();
          const whatsappPhone = (document.getElementById("whatsappPhone")?.value || "").trim();
          
          // Ä°lave adresler
          const additionalAddresses = getAdditionalAddresses();
          logger.info("Kaydedilecek ilave adresler", additionalAddresses);

          // Banka hesaplarÄ±
          const bankRows = document.querySelectorAll("#bankBody tr");
          const bankAccounts = [...bankRows].map(tr => {
            const inputs = tr.querySelectorAll("input, select");
            return {
              bankName: inputs[0]?.value || "",
              iban: inputs[1]?.value || "",
              accountName: inputs[2]?.value || "",
              currency: inputs[3]?.value || "TRY"
            };
          }).filter(b => b.bankName || b.iban);

          logger.info("Toplanan veriler", {
            roles,
            companyName,
            taxNumber,
            displayName,
            contactEmailsCount: contactEmails.length,
            contactPhonesCount: contactPhones.length,
            bankAccountsCount: bankAccounts.length,
            additionalAddressesCount: additionalAddresses.length,
            additionalAddresses: additionalAddresses
          });

          // Basit validasyon
          if (!companyName) {
            toast.error(MESSAGES.ERROR_COMPANY_NAME_REQUIRED);
            return;
          }

          // butonu kilitle
          btn.disabled = true;
          btn.textContent = "Kaydediliyor...";

          logger.info("Firestore'a kaydediliyor");

          // Update user document
          const uid = user.uid;
          const ref = doc(db, "users", uid);
          
          // Belge yoksa oluÅŸtur
          const { setDoc, serverTimestamp } = await getFirestoreModules();
          await setDoc(ref, { createdAt: serverTimestamp() }, { merge: true });
          
          // Update with all the user data
          const updateData = {
            roles,
            companyName,
            taxNumber,
            mersisNo,
            website,
            googleBusinessUrl: googleBusinessUrl || null, // Teklifbul Rule v1.0 - Ãœcretsiz Google Business linki
            displayName,
            isPremium,
            contactEmails,
            contactPhones,
            bankAccounts,
            // invoiceAddress kaldÄ±rÄ±ldÄ± - artÄ±k structured address parts kullanÄ±lÄ±yor
            taxOffice,
            invoiceAddressParts,
            companyPhone,
            mobilePhone,
            whatsappPhone,
            additionalAddresses,
            updatedAt: serverTimestamp()
          };

          // CRITICAL: Kategoriler - Yeni ID tabanlÄ± sistem
          if (supplierAPI && buyerAPI) {
            // Import category service for normalization
            const { normalizeToIds, getNameById } = await import('./src/categories/category-service.js');
            const { slugifyTr } = await import('./utils/slugify-tr.js');
            
            const supplierCatsRaw = supplierAPI.getValues(); // Original category names
            // CRITICAL: Normalize to IDs using new system
            const supplierCategoryIds = normalizeToIds(supplierCatsRaw);
            
            // For backward compatibility, also generate slugs and names
            const supplierCategorySlugs = supplierCategoryIds.map(id => {
              const name = getNameById(id);
              return name ? slugifyTr(name) : null;
            }).filter(Boolean);
            const supplierCategoryNames = supplierCategoryIds.map(id => getNameById(id)).filter(Boolean);
            
            // Save primary field (IDs) and legacy fields for backward compatibility
            updateData.supplierCategoryIds = supplierCategoryIds; // PRIMARY: New ID-based system
            updateData.supplierCategoryKeys = supplierCategorySlugs; // Legacy: Slug format
            updateData.supplierCategories = supplierCategoryNames; // Legacy: Name format
            
            const buyerCatsRaw = buyerAPI.getValues();
            // Buyer categories - currently only names, but can be normalized if needed
            const buyerCategoryIds = normalizeToIds(buyerCatsRaw);
            const buyerCategoryNames = buyerCategoryIds.map(id => getNameById(id)).filter(Boolean);
            updateData.buyerCategories = buyerCategoryNames;
            
            logger.group("Kategoriler kaydediliyor (ID tabanlÄ± sistem)");
            logger.info("Supplier (orijinal)", supplierCatsRaw);
            logger.info("Supplier (ID'ler)", supplierCategoryIds);
            logger.info("Supplier (isimler)", supplierCategoryNames);
            logger.info("Supplier (slug'lar - legacy)", supplierCategorySlugs);
            logger.info("Buyer (orijinal)", buyerCatsRaw);
            logger.info("Buyer (ID'ler)", buyerCategoryIds);
            logger.end();
          }
          
          logger.info("Firestore'a gÃ¶nderilecek veri", updateData);
          const { updateDoc } = await getFirestoreModules();
          await updateDoc(ref, updateData);
          
          // Teklifbul Rule v1.0 - Åirket dokÃ¼manÄ±nÄ± da gÃ¼ncelle (googleBusinessUrl iÃ§in)
          try {
            const userData = (await getDoc(ref)).data();
            const userCompanyId = userData?.companyId || userData?.activeCompanyId;
            if (userCompanyId) {
              const companyRef = doc(db, 'companies', userCompanyId);
              await updateDoc(companyRef, {
                googleBusinessUrl: googleBusinessUrl || null,
                website: website || null,
                updatedAt: serverTimestamp()
              });
            }
          } catch (e) {
            logger.warn("Åirket dokÃ¼manÄ± gÃ¼ncellenemedi (opsiyonel)", e);
          }

          logger.info("User data saved successfully");
          toast.success(MESSAGES.SUCCESS_SAVED);

          // SayfayÄ± yenile ki gÃ¼ncel veriler gÃ¶rÃ¼nsÃ¼n
          setTimeout(() => {
            location.reload();
          }, 1000);

        } catch (e) {
          logger.error('[SAVE ERROR]', e);
          toast.error(MESSAGES.ERROR_SAVE + ": " + (e.code || e.message || e));
        } finally {
          btn.disabled = false;
          btn.textContent = originalText || "Kaydet";
        }
      });

        // Save handler ready
    }
    // === Category Management Initialization ===
    let supplierAPI, buyerAPI;
    
    async function initializeCategoryManagement() {
      try {
        logger.info("Kategori yÃ¶netimi baÅŸlatÄ±lÄ±yor");
        
        const user = await getCurrentUser();
        const { doc, getDoc } = await getFirestoreModules();
        const profileRef = doc(db, "users", user.uid);
        const profileSnap = await getDoc(profileRef);
        const profile = profileSnap.data() || {};

        const allCats = await fetchCategories();
        // Categories loaded silently

        // FIX: Convert slug categories back to original names for display
        // Helper function: slug normalize (same as used when saving)
        function toSlug(name) {
          if (!name) return '';
          // CRITICAL FIX: Turkish character normalization BEFORE normalize('NFD')
          // This prevents Ä°/Ä± characters from being lost or incorrectly transformed
          return String(name)
            // Step 1: Replace Turkish characters FIRST (before normalize to avoid Ä°/Ä± issues)
            .replace(/[ÅŸÅ]/g, 's')                     // ÅŸ -> s
            .replace(/[ÄŸÄ]/g, 'g')                     // ÄŸ -> g
            .replace(/[Ã§Ã‡]/g, 'c')                     // Ã§ -> c
            .replace(/[Ã¶Ã–]/g, 'o')                     // Ã¶ -> o
            .replace(/[Ã¼Ãœ]/g, 'u')                     // Ã¼ -> u
            // Step 2: Handle Ä° and Ä± separately (critical for Turkish)
            .replace(/Ä°/g, 'i')                         // Ä° (uppercase dotted i) -> i
            .replace(/Ä±/g, 'i')                         // Ä± (lowercase dotless i) -> i
            .replace(/I/g, 'i')                        // I (uppercase dotless i) -> i
            // Step 3: Normalize remaining accents (after Turkish chars handled)
            .normalize('NFD')                           // split remaining accents
            .replace(/[\u0300-\u036f]/g, '')           // remove accent marks
            .toLowerCase()
            .trim()
            // Step 4: Replace ALL non-alphanumeric characters (including /, space, etc.) with dash
            .replace(/[^a-z0-9]+/g, '-')                // non-alnum -> - (includes /, space, etc.)
            .replace(/-+/g, '-')                         // Multiple dashes -> single dash
            .replace(/^-+|-+$/g, '');                    // trim dashes
        }
        
        // Create mapping: slug -> original name
        const slugToOriginalMap = new Map();
        allCats.forEach(originalName => {
          const slug = toSlug(originalName);
          slugToOriginalMap.set(slug, originalName);
        });
        
        // CRITICAL: Load categories from profile - support both ID and legacy formats
        // Priority: supplierCategoryIds (new) > supplierCategoryKeys (slug) > supplierCategories (name)
        const supplierCatsFromProfile = [];
        
        // New ID format
        if (Array.isArray(profile.supplierCategoryIds)) {
          profile.supplierCategoryIds.forEach(id => {
            const name = getNameById(id);
            if (name && name !== id && allCats.includes(name)) {
              supplierCatsFromProfile.push(name);
            }
          });
        }
        
        // Legacy formats (if IDs not found)
        if (supplierCatsFromProfile.length === 0) {
          // Try slug format
          if (Array.isArray(profile.supplierCategoryKeys)) {
            profile.supplierCategoryKeys.forEach(slug => {
              const name = slugToOriginalMap.get(slug) || slug;
              if (allCats.includes(name)) {
                supplierCatsFromProfile.push(name);
              }
            });
          }
          // Try name format
          if (supplierCatsFromProfile.length === 0 && Array.isArray(profile.supplierCategories)) {
            profile.supplierCategories.forEach(name => {
              if (allCats.includes(name)) {
                supplierCatsFromProfile.push(name);
              }
            });
          }
        }
        
        const buyerCatsFromProfile = [];
        // Buyer categories - try IDs first, then names
        if (Array.isArray(profile.buyerCategoryIds)) {
          profile.buyerCategoryIds.forEach(id => {
            const name = getNameById(id);
            if (name && name !== id && allCats.includes(name)) {
              buyerCatsFromProfile.push(name);
            }
          });
        }
        // Fallback to legacy name format
        if (buyerCatsFromProfile.length === 0 && Array.isArray(profile.buyerCategories)) {
          profile.buyerCategories.forEach(name => {
            if (allCats.includes(name)) {
              buyerCatsFromProfile.push(name);
            }
          });
        }
        
        const supplierCatsOriginal = [...new Set(supplierCatsFromProfile)]; // Remove duplicates
        const buyerCatsOriginal = [...new Set(buyerCatsFromProfile)]; // Remove duplicates

        // supplier
        supplierAPI = renderList({
          rootList: $cat("#catList"),
          searchInput: $cat("#catSearch"),
          selectAllBtn: $cat("#btnSelectAll"),
          clearBtn: $cat("#btnClear"),
          chipsRoot: $cat("#catChips"),
          allItems: allCats,
          selected: new Set(supplierCatsOriginal), // Use original names for matching
          prefix: "sup"
        });

        // buyer
        buyerAPI = renderList({
          rootList: $cat("#buyerCatList"),
          searchInput: $cat("#buyerCatSearch"),
          selectAllBtn: $cat("#btnSelectAllBuyer"),
          clearBtn: $cat("#btnClearBuyer"),
          chipsRoot: $cat("#buyerCatChips"),
          allItems: allCats,
          selected: new Set(buyerCatsOriginal), // Use original names for matching
          prefix: "buy"
        });

        // Category components ready
      } catch (e) {
        logger.error("Kategori yÃ¶netimi baÅŸlatma hatasÄ±", e);
      }
    }

    // === Initialization ===
    async function initialize() {
      try {
        // Settings page initializing silently
        
        // Header setup
        wireLogoutButtons();
        
        // Tax office system
        await buildTaxOfficeSelect();
        bindTaxOfficeHandlers();
        
        // Load user profile (auth gerektirir)
        await bindStructuredAddressControls();
        // initProvinceDistrictLocal will be called inside loadUserProfile if needed
        try {
        await loadUserProfile();
        } catch (e) {
          logger.warn("Profil yÃ¼klenemedi (auth gerekli)", e.message);
        }
        
        try {
        await setupCompanyAdminUI();
        } catch (e) {
          logger.warn("Company admin UI setup failed (auth gerekli)", e.message);
        }
        
        // Initialize category management (auth gerektirir)
        try {
        await initializeCategoryManagement();
        } catch (e) {
          logger.warn("Kategori yÃ¶netimi baÅŸlatÄ±lamadÄ± (auth gerekli)", e.message);
        }
        
        // Initialize save button (Genel Ayarlar iÃ§in)
        initSaveButton();
        
        // Teklifbul Rule v1.0 - Her ayar sekmesi iÃ§in kaydet butonu event listener'larÄ±
        // Onay PolitikasÄ± Kaydet
        const btnSaveApprovalPolicy = document.getElementById('btnSaveApprovalPolicy');
        if (btnSaveApprovalPolicy) {
          btnSaveApprovalPolicy.addEventListener('click', async () => {
            try {
              const user = await getCurrentUser();
              if (!user) {
                toast.error(MESSAGES.ERROR_AUTH);
                return;
              }
              
              // Onay politikasÄ± verilerini topla ve kaydet
              const getFirestoreModulesFn = window.getFirestoreModules || getFirestoreModules;
              const { updateDoc, doc, serverTimestamp } = await getFirestoreModulesFn();
              
              const approvalPolicy = {
                require_at_least_one_top_approver: document.getElementById('approvalPolicy_require_at_least_one_top_approver')?.checked || false,
                strict_top_required: document.getElementById('approvalPolicy_strict_top_required')?.checked || false,
                reminder_hours: document.getElementById('approvalPolicy_reminder_hours')?.value || '',
                updatedAt: serverTimestamp()
              };
              await updateDoc(doc(db, 'users', user.uid), {
                approvalPolicy,
                updatedAt: serverTimestamp()
              });
              
              toast.success(MESSAGES.SUCCESS_APPROVAL_POLICY_SAVED);
            } catch (err) {
              logger.error('Onay politikasÄ± kaydetme hatasÄ±', err);
              toast.error(MESSAGES.ERROR_SAVE + ': ' + err.message);
            }
          });
        }
        
        // Åirket Profili Kaydet
        const btnSaveCompanyProfile = document.getElementById('btnSaveCompanyProfile');
        if (btnSaveCompanyProfile) {
          btnSaveCompanyProfile.addEventListener('click', async () => {
            try {
              const user = await getCurrentUser();
              if (!user) {
                toast.error(MESSAGES.ERROR_AUTH);
                return;
              }
              
              const website = document.getElementById('companyProfile_website')?.value?.trim() || '';
              const googleBusiness = document.getElementById('companyProfile_googleBusiness')?.value?.trim() || '';
              
              const { updateDoc, doc, serverTimestamp } = await getFirestoreModules();
              await updateDoc(doc(db, 'users', user.uid), {
                website: website || null,
                googleBusinessUrl: googleBusiness || null,
                updatedAt: serverTimestamp()
              });
              
              toast.success(MESSAGES.SUCCESS_PROFILE_SAVED);
            } catch (err) {
              logger.error('Profil kaydetme hatasÄ±', err);
              toast.error(MESSAGES.ERROR_SAVE + ': ' + err.message);
            }
          });
        }
        
        // Premium AyarlarÄ± Kaydet
        const btnSavePremiumSettings = document.getElementById('btnSavePremiumSettings');
        if (btnSavePremiumSettings) {
          btnSavePremiumSettings.addEventListener('click', async () => {
            try {
              const user = await getCurrentUser();
              if (!user) {
                toast.error(MESSAGES.ERROR_AUTH);
                return;
              }
              
              const isPremium = document.getElementById('isPremium')?.checked || false;
              
              const { updateDoc, doc, serverTimestamp } = await getFirestoreModules();
              await updateDoc(doc(db, 'users', user.uid), {
                isPremium: isPremium,
                updatedAt: serverTimestamp()
              });
              
              toast.success(MESSAGES.SUCCESS_PREMIUM_SETTINGS_SAVED);
              // SayfayÄ± yenile
              await loadPremiumPage();
            } catch (err) {
              logger.error('Premium ayarlarÄ± kaydetme hatasÄ±', err);
              toast.error(MESSAGES.ERROR_SAVE + ': ' + err.message);
            }
          });
        }
        
        // VarsayÄ±lan Adres AyarlarÄ± Kaydet
        const btnSaveAddressSettings = document.getElementById('btnSaveAddressSettings');
        if (btnSaveAddressSettings) {
          btnSaveAddressSettings.addEventListener('click', async () => {
            try {
              const user = await getCurrentUser();
              if (!user) {
                toast.error(MESSAGES.ERROR_AUTH);
                return;
              }
              
              const defaultDeliveryAddress = document.getElementById('defaultDeliveryAddress')?.value || 'main';
              
              const { updateDoc, doc, serverTimestamp } = await getFirestoreModules();
              
              // Teklifbul Rule v1.0 - Haritada marker varsa konum bilgisini de kaydet
              const updateData = {
                defaultDeliveryAddress: defaultDeliveryAddress,
                updatedAt: serverTimestamp()
              };
              
              // Marker konumunu kaydet (eÄŸer varsa)
              if (addressMapInstance && addressMapInstance.marker) {
                try {
                  const markerPosition = addressMapInstance.marker.getLatLng();
                  if (markerPosition) {
                    // Ana adres iÃ§in konum bilgisini kaydet
                    if (defaultDeliveryAddress === 'main') {
                      const userData = await getUserData(user.uid);
                      updateData.invoiceAddressParts = {
                        ...(userData.invoiceAddressParts || {}),
                        lat: markerPosition.lat,
                        lng: markerPosition.lng
                      };
                    }
                  }
                } catch (markerErr) {
                  logger.warn('Marker konumu kaydedilemedi', markerErr);
                  // Marker hatasÄ± kaydetmeyi engellemez
                }
              }
              
              await updateDoc(doc(db, 'users', user.uid), updateData);
              
              toast.success(MESSAGES.SUCCESS_DEFAULT_ADDRESS_SETTINGS_SAVED);
              // SayfayÄ± yenile
              await loadAddressesPage();
            } catch (err) {
              logger.error('VarsayÄ±lan adres ayarlarÄ± kaydetme hatasÄ±', err);
              toast.error(MESSAGES.ERROR_SAVE + ': ' + err.message);
            }
          });
        }
        
        // Cancel button
        document.getElementById("cancelBtn").addEventListener("click", () => {
          location.href = "./dashboard.html";
        });
        
        logger.info("Settings page initialized");
      } catch (e) {
        logger.error("Settings baÅŸlatma hatasÄ±", e);
      }
    }

    // Teklifbul Rule v1.0 - Auth ready olduktan sonra initialize et
    async function waitAndInitialize() {
      // DOM ready olana kadar bekle
    if (document.readyState === "loading") {
        await new Promise(resolve => document.addEventListener("DOMContentLoaded", resolve));
      }
      
      // Auth ready olana kadar bekle (guard zaten yÃ¶nlendirmeyi yapacak)
      const user = await waitAuthReady();
      
      // KullanÄ±cÄ± yoksa guard zaten yÃ¶nlendirmiÅŸ olmalÄ±, ama yine de kontrol et
      if (!user) {
        logger.warn("KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸ, guard yÃ¶nlendirecek");
        // Guard'Ä±n yÃ¶nlendirmesini bekle (guard zaten Ã§alÄ±ÅŸÄ±yor)
        return;
      }
      
      // Initialize
      await initialize();
    }
    
    // Initialize when DOM and Auth are ready
    waitAndInitialize().catch(err => {
      logger.error("Settings page initialization failed", err);
    });
  </script>

  <script type="module">
  const byId = id => document.getElementById(id);
  function trNorm(s){return (s??'').toString().trim().toLocaleLowerCase('tr').replace(/\s+/g,' ');}  
  function fillSelect(sel, items, placeholder){
    if (!sel) return;
    sel.innerHTML=''; const o0=document.createElement('option'); o0.value=''; o0.textContent=placeholder; sel.appendChild(o0);
    (items||[]).sort((a,b)=>(a.name??'').localeCompare(b.name??'','tr')).forEach(it=>{ const o=document.createElement('option'); o.value=String(it.id ?? it.code ?? ''); o.textContent=it.name ?? String(it); sel.appendChild(o); });
    sel.disabled = sel.options.length <= 1;
  }
  async function fetchJSON(u){ const r=await fetch(u,{headers:{'accept':'application/json'}}); if(!r.ok) throw new Error(`HTTP ${r.status} for ${u}`); return r.json(); }
  function findByNameOrId(list, v){ if(!v) return null; const byId=list.find(x=>String(x.id)===String(v)); if(byId) return byId; const needle=trNorm(v); return list.find(x=>trNorm(x.name)===needle) || null; }
  async function initProvinceDistrict({ ilSel=byId('inv_il'), ilceSel=byId('inv_ilce'), jsonUrl='/public/assets/tr-il-ilce.json', prefilled={ il: ilSel?.value, ilce: ilceSel?.value } }={}){
    let root; 
    try { root = await fetchJSON(jsonUrl); } 
    catch(e){ 
      logger.warn('Ä°lâ€“ilÃ§e JSON bulunamadÄ±', { jsonUrl, error: e }); 
      try { root = await fetchJSON('./assets/tr-il-ilce.json'); } 
      catch(e2) {
        try { root = await fetchJSON('/assets/tr-il-ilce.json'); }
        catch(e3) { 
          logger.warn('TÃ¼m kaynaklar baÅŸarÄ±sÄ±z'); 
          return; 
        }
      }
    }
    const provinces = (Array.isArray(root)? root : root.data || []).map(p=>({ id:p.id, name:p.name, districts:p.districts||[] })).sort((a,b)=>a.name.localeCompare(b.name,'tr'));
    fillSelect(ilSel, provinces, 'Ä°l seÃ§iniz');
    const preIl = findByNameOrId(provinces, prefilled.il); if (preIl) ilSel.value = preIl.id;
    fillSelect(ilceSel, [], 'Ä°lÃ§e seÃ§iniz');
    ilSel?.addEventListener('change', ()=>{ const chosen = findByNameOrId(provinces, ilSel.value); fillSelect(ilceSel, chosen?.districts||[], 'Ä°lÃ§e seÃ§iniz'); });
    if (preIl) { fillSelect(ilceSel, preIl.districts, 'Ä°lÃ§e seÃ§iniz'); const preIlce = findByNameOrId(preIl.districts, prefilled.ilce); if (preIlce) ilceSel.value = preIlce.id; }
  }
  document.addEventListener('DOMContentLoaded', ()=>{ const ilSel=byId('inv_il'); const ilceSel=byId('inv_ilce'); if (ilSel && ilceSel) initProvinceDistrict().catch(e=>logger.error('Ä°lâ€“ilÃ§e init hatasÄ±', e)); });
  </script>

  <!-- Theme Script -->
  <script type="module" src="/assets/js/theme.js" defer></script>

  <script type="module">
  const API_BASE = location.origin;
  function slugTR(s){
    s = String(s ?? '').trim();
    const map = { 'Ä±':'I','i':'Ä°','ÅŸ':'Å','ÄŸ':'Ä','Ã¼':'Ãœ','Ã¶':'Ã–','Ã§':'Ã‡' };
    s = s.replace(/[Ä±iÅŸÄŸÃ¼Ã¶Ã§]/g, ch => map[ch]);
    s = s.toLocaleUpperCase('tr').replace(/\s+/g,'_').replace(/[^\wÃ‡ÄÄ°Ã–ÅÃœ]/g,'_').replace(/_+/g,'_');
    return s;
  }
  async function saveMahalleCache(payload){
    try { await fetch(`${API_BASE}/save-mahalle-json`, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload) }); } catch {}
  }
  async function loadNeighborhoodsByDistrictId(districtId, districtName){
    // 1) local
    try {
      const r = await fetch(`/assets/mahalle/${districtId}.json`);
      if(r.ok){ const j = await r.json(); return j.neighborhoods || []; }
    } catch (e) {
      // 404 veya diÄŸer hatalar sessizce handle edilir - konsola yazÄ±lmaz
    }
    // 2) TÃ¼rkiyeAPI fallback
    try {
      const api = await fetch(`https://api.turkiyeapi.dev/v1/neighborhoods?district=${encodeURIComponent(districtName)}`);
      if (!api.ok) return [];
      const { data } = await api.json();
      const neighborhoods = (Array.isArray(data)? data:[]).map(n=>({ id: slugTR(n.name), name: n.name }));
      if (neighborhoods.length){ 
        await saveMahalleCache({ districtId, districtName, neighborhoods });
        // console.log silindi - sessizce kaydet
      }
      return neighborhoods;
    } catch (e) {
      // API hatalarÄ± sessizce handle edilir - konsola yazÄ±lmaz
      return [];
    }
  }

  function fillSelect(sel, items, ph){
    sel.innerHTML = '';
    const o0 = document.createElement('option'); o0.value=''; o0.textContent=ph; sel.appendChild(o0);
    items.forEach(it=>{
      const o=document.createElement('option');
      o.value=it.id||it.value||it.name;
      o.textContent=it.name||String(it);
      sel.appendChild(o);
    });
    sel.disabled = sel.options.length<=1;
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const selIlce = document.getElementById('inv_ilce');
    const selMah = document.getElementById('inv_mahalle');
    if (selIlce && selMah) {
      selIlce.addEventListener('change', async ()=>{
        const districtId = selIlce.value;
        const districtName = selIlce.options[selIlce.selectedIndex]?.text || '';
        selMah.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
        selMah.disabled = true;
        if(districtId){
          const mahalleList = await loadNeighborhoodsByDistrictId(districtId, districtName);
          fillSelect(selMah, mahalleList, 'Mahalle seÃ§iniz');
        } else {
          fillSelect(selMah, [], 'Mahalle seÃ§iniz');
        }
      });
    }
  });
  </script>

  <script type="module">
  // === SOKAK/CADDE ZÄ°NCÄ°RÄ° - ID TabanlÄ± Sistem ===
  // Teklifbul Rule v1.0 - ID tabanlÄ±, saÄŸlam fallback, free-text yedeÄŸi
  import { loadStreets, onStreetSelected } from '/assets/js/address-service.js';
  // Teklifbul Rule v1.0 - Structured Logging
  import { logger } from './src/shared/log/logger.js';
  
  const $sokak = id => /** @type {HTMLSelectElement} */(document.getElementById(id));
  
  function fillSelect(sel, items, ph){
    sel.innerHTML=''; 
    const o0=document.createElement('option'); 
    o0.value=''; 
    o0.textContent=ph; 
    sel.appendChild(o0);
    items.forEach(it=>{ 
      const o=document.createElement('option'); 
      o.value=String(it.id ?? it.value ?? ''); 
      o.textContent=it.name ?? String(it); 
      sel.appendChild(o); 
    });
    sel.disabled = sel.options.length<=1;
  }
  // State: SeÃ§ili ID'ler (ID tabanlÄ± sistem iÃ§in)
  let selectedProvinceId = null;
  let selectedDistrictId = null;
  let selectedNeighborhoodId = null;
  let selectedNeighborhoodData = null; // { id, name, defaultPostalCode }
  
  export function bindNeighborhoodToStreets({ilceSelId='inv_ilce', mahSelId='inv_mahalle', sokSelId='inv_sokak', sokManualId='inv_sokak_manual', postalCodeId='inv_postakodu'}={}) {
    const ilceSel = $sokak(ilceSelId); 
    const mahSel = $sokak(mahSelId); 
    const sokSel = $sokak(sokSelId);
    const sokManual = document.getElementById(sokManualId);
    const postalCodeInput = document.getElementById(postalCodeId);
    
    if (!ilceSel || !mahSel || !sokSel) return;
    
    const getText = sel => sel.options[sel.selectedIndex]?.text ?? '';
    const getValue = sel => sel.value || '';
    
    // Ä°l/Ä°lÃ§e seÃ§iminde reset
    const ilSel = document.getElementById('inv_il');
    if (ilSel) {
      ilSel.addEventListener('change', () => {
        selectedProvinceId = null;
        selectedDistrictId = null;
        selectedNeighborhoodId = null;
        selectedNeighborhoodData = null;
        fillSelect(sokSel, [], 'Sokak/Cadde seÃ§iniz');
        sokSel.style.display = '';
        if (sokManual) sokManual.style.display = 'none';
        if (postalCodeInput) postalCodeInput.value = '';
      });
    }
    
    ilceSel.addEventListener('change', () => {
      selectedDistrictId = null;
      selectedNeighborhoodId = null;
      selectedNeighborhoodData = null;
      fillSelect(sokSel, [], 'Sokak/Cadde seÃ§iniz');
      sokSel.style.display = '';
      if (sokManual) sokManual.style.display = 'none';
      if (postalCodeInput) postalCodeInput.value = '';
    });
    
    // Mahalle seÃ§iminde sokak yÃ¼kle
    mahSel.addEventListener('change', async () => {
      const provinceName = getText(ilSel) || '';
      const districtName = getText(ilceSel);
      const neighborhoodName = getText(mahSel);
      const neighborhoodIdValue = getValue(mahSel);
      
      fillSelect(sokSel, [], 'Sokak/Cadde seÃ§iniz');
      sokSel.style.display = '';
      if (sokManual) {
        sokManual.style.display = 'none';
        sokManual.value = '';
        sokManual.required = false;
      }
      
      if (!districtName || !neighborhoodName) {
        sokSel.disabled = true;
        return;
      }
      
      sokSel.disabled = true;
      sokSel.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
      
      try {
        // ID tabanlÄ± sokak yÃ¼kleme
        const streets = await loadStreets({
          provinceName,
          districtName,
          neighborhoodName,
          neighborhoodIdFromState: neighborhoodIdValue ? Number(neighborhoodIdValue) : undefined,
          districtIdFromState: selectedDistrictId || undefined
        });
        
        if (streets.length > 0) {
          // Sokak listesi var â†’ dropdown gÃ¶ster
          fillSelect(sokSel, streets, 'Sokak/Cadde seÃ§iniz');
          sokSel.style.display = '';
          sokSel.disabled = false;
          if (sokManual) {
            sokManual.style.display = 'none';
            sokManual.required = false;
          }
          
          // Sokak seÃ§ilince posta kodunu otomatik doldur
          sokSel.addEventListener('change', function onStreetChange() {
            const selectedStreetId = sokSel.value;
            const selectedStreet = streets.find(s => String(s.id) === selectedStreetId);
            
            if (selectedStreet && postalCodeInput && selectedNeighborhoodData) {
              onStreetSelected(selectedStreet, selectedNeighborhoodData, (pk) => {
                postalCodeInput.value = pk;
              });
            }
            
            // Tek seferlik event (change sonrasÄ± temizle)
            sokSel.removeEventListener('change', onStreetChange);
          });
        } else {
          // Sokak listesi boÅŸ â†’ free-text input gÃ¶ster
          logger.info('[addr] streets empty â†’ free-text', { 
            provinceName, 
            districtName, 
            neighborhoodName 
          });
          
          sokSel.style.display = 'none';
          sokSel.disabled = true;
          if (sokManual) {
            sokManual.style.display = 'block';
            sokManual.required = true;
            sokManual.placeholder = 'Sokak (elle yazÄ±n)';
          }
          
          // Mahalle varsayÄ±lan posta kodunu doldur
          if (selectedNeighborhoodData?.defaultPostalCode && postalCodeInput && !postalCodeInput.value) {
            postalCodeInput.value = selectedNeighborhoodData.defaultPostalCode;
          }
        }
      } catch (e) {
        logger.warn('[addr] streets load error', e);
        // Hata durumunda free-text'e dÃ¼ÅŸ
        sokSel.style.display = 'none';
        sokSel.disabled = true;
        if (sokManual) {
          sokManual.style.display = 'block';
          sokManual.required = true;
          sokManual.placeholder = 'Sokak (elle yazÄ±n)';
        }
      }
    });
  }
  
  document.addEventListener('DOMContentLoaded', () => { bindNeighborhoodToStreets(); });
  
  // Approval limits'leri yÃ¼kle (global fonksiyon)
  // Global scope'a ekle (loadAndSetupApprovalPolicyManagement'dan eriÅŸilebilir olmasÄ± iÃ§in)
  window.loadApprovalLimits = async function loadApprovalLimits(companyId, currentPolicy) {
    const container = document.getElementById('approvalLimitsList');
    if (!container) {
      logger.warn('approvalLimitsList container bulunamadÄ±');
      return;
    }
    
    // Mevcut iÃ§eriÄŸi temizle
    container.innerHTML = '';
    
    logger.info('Approval limits yÃ¼kleniyor', { companyId, currentPolicy, limits: currentPolicy?.approval_limits });
    
    const limits = currentPolicy?.approval_limits || [];
    
    if (limits.length === 0) {
      // HiÃ§ limit yoksa, varsayÄ±lan boÅŸ bir satÄ±r ekle
      logger.info('HiÃ§ limit yok, boÅŸ satÄ±r ekleniyor');
      if (typeof window.addApprovalLimitRow === 'function') {
        window.addApprovalLimitRow();
      }
    } else {
      // KaydedilmiÅŸ limitleri yÃ¼kle
      logger.info(`${limits.length} adet limit yÃ¼kleniyor`);
      limits.forEach((limit, index) => {
        logger.info(`${index + 1}. Limit`, limit);
        if (typeof window.addApprovalLimitRow === 'function') {
          window.addApprovalLimitRow(limit);
        }
      });
    }
    
    logger.info('Approval limits yÃ¼kleme tamamlandÄ±', { toplamSatir: container.children.length });
    
    // Teklifbul Rule v1.0 - Limitler yÃ¼klendi, tÃ¼m select'leri gÃ¼ncelle
    if (typeof window.updateRoleSelects === 'function') {
      window.updateRoleSelects();
    }
  }
  
  // Teklifbul Rol & Onay Sistemi - Onay MekanizmasÄ± YÃ¶netimi
  // Global scope'a ekle (initSettingsNavigation'dan eriÅŸilebilir olmasÄ± iÃ§in)
  window.loadAndSetupApprovalPolicyManagement = async function loadAndSetupApprovalPolicyManagement(companyId, userData) {
    try {
      logger.info('loadAndSetupApprovalPolicyManagement Ã§aÄŸrÄ±ldÄ±', { companyId, userData });
      
      // page-approval-settings sayfasÄ±nÄ± kontrol et
      const approvalPage = document.getElementById('page-approval-settings');
      if (!approvalPage) {
        logger.warn('page-approval-settings bulunamadÄ±');
        return;
      }
      
      // Teklifbul Rule v1.0 - Sadece CEO, Ä°ÅŸveren, YÃ¶netim Kurulu BaÅŸkanÄ±, Genel MÃ¼dÃ¼r belirleyebilir
      // Rol kontrolÃ¼: companyRoleKey (prefix'li), companyRole (prefix'siz), veya requestedCompanyRole
      const userRoleKey = userData.companyRoleKey || userData.companyRole || userData.requestedCompanyRole || '';
      const userRoleSimple = userData.companyRole || userData.requestedCompanyRole || '';
      
      const unlimitedApprovalRoles = [
        'buyer:ceo',
        'buyer:isveren',
        'buyer:yonetim_kurulu_baskani',
        'buyer:genel_mudur',
        // Prefix'siz versiyonlar (geriye dÃ¶nÃ¼k uyumluluk)
        'ceo',
        'isveren',
        'yonetim_kurulu_baskani',
        'genel_mudur'
      ];
      
      // Åirket bilgilerini al (ownerUid kontrolÃ¼ iÃ§in)
      const db = window.__db;
      let companyData = {};
      let currentUserUid = null;
      
      if (db && companyId) {
        try {
          const getFirestoreModulesFn = window.getFirestoreModules || getFirestoreModules;
          const { getDoc, doc } = await getFirestoreModulesFn();
          const companyDoc = await getDoc(doc(db, 'companies', companyId));
          if (companyDoc.exists()) {
            companyData = companyDoc.data();
          }
          
          // KullanÄ±cÄ± UID'sini al
          // Teklifbul Rule v1.0 - getCurrentUser fonksiyonunu kontrol et
          let currentUser = null;
          const authInstance = window.__auth || auth;
          if (typeof getCurrentUser === 'function') {
            currentUser = await getCurrentUser();
          } else if (window.getCurrentUser && typeof window.getCurrentUser === 'function') {
            currentUser = await window.getCurrentUser();
          } else if (authInstance && authInstance.currentUser) {
            currentUser = authInstance.currentUser;
          }
          if (currentUser) {
            currentUserUid = currentUser.uid;
          }
        } catch (e) {
          logger.warn('Åirket/kullanÄ±cÄ± bilgileri alÄ±nÄ±rken hata', e);
        }
      }
      
      // Hem prefix'li hem prefix'siz kontrol et + ÅŸirket sahibi kontrolÃ¼
      const hasPermission = unlimitedApprovalRoles.includes(userRoleKey) || 
                            unlimitedApprovalRoles.includes(userRoleSimple) ||
                            // Åirket sahibi kontrolÃ¼ (ownerUid)
                            (currentUserUid && companyData?.ownerUid === currentUserUid);
      
      logger.info('Onay politikasÄ± yetkisi kontrolÃ¼', { 
        userRoleKey, 
        userRoleSimple, 
        hasPermission, 
        unlimitedApprovalRoles,
        isOwner: currentUserUid && companyData?.ownerUid === currentUserUid,
        ownerUid: companyData?.ownerUid,
        currentUserUid
      });
      
      if (!hasPermission) {
        // SayfayÄ± gizle ve uyarÄ± mesajÄ± gÃ¶ster
        approvalPage.style.display = 'none';
        approvalPage.innerHTML = `
          <div style="padding:40px; text-align:center; background:#fee2e2; border-radius:8px; border:2px solid #ef4444;">
            <h3 style="color:#dc2626; margin:0 0 16px 0;">âš ï¸ Yetki Gerekli</h3>
            <p style="color:#991b1b; margin:0; font-size:14px;">
              Onay politikasÄ± ayarlarÄ±nÄ± yalnÄ±zca <strong>CEO</strong>, <strong>Ä°ÅŸveren</strong>, 
              <strong>YÃ¶netim Kurulu BaÅŸkanÄ±</strong> veya <strong>Genel MÃ¼dÃ¼r</strong> rolleri yÃ¶netebilir.
            </p>
            <p style="color:#991b1b; margin:12px 0 0 0; font-size:12px;">
              Mevcut rolÃ¼nÃ¼z: <strong>${userRoleKey || userRoleSimple || 'TanÄ±mlanmamÄ±ÅŸ'}</strong>
            </p>
          </div>
        `;
        logger.warn('Onay politikasÄ± yetkisi yok, sayfa gizlendi');
        return;
      }
      
      // BÃ¶lÃ¼mÃ¼ gÃ¶ster
      approvalPage.style.display = 'block';
      logger.info('Onay politikasÄ± bÃ¶lÃ¼mÃ¼ gÃ¶sterildi');
      
      // Mevcut ayarlarÄ± Firestore'dan yÃ¼kle (companyData zaten yukarÄ±da alÄ±ndÄ±, tekrar almayalÄ±m)
      if (!db) {
        logger.error('DB bulunamadÄ±');
        const toastFn = window.showToastNotification || showToastNotification;
        if (toastFn && typeof toastFn === 'function') {
          toastFn('âŒ VeritabanÄ± baÄŸlantÄ±sÄ± bulunamadÄ±.', 'error');
        }
        return;
      }
      
      // Use cached Firestore modules
      const getFirestoreModulesFn = window.getFirestoreModules || getFirestoreModules;
      const { getDoc, doc, serverTimestamp } = await getFirestoreModulesFn();
      
      // EÄŸer companyData boÅŸsa tekrar yÃ¼kle
      if (!companyData || Object.keys(companyData).length === 0) {
        const companyDoc = await safeFirestoreOperation(
          () => getDoc(doc(db, 'companies', companyId)),
          'Åirket bilgileri yÃ¼klenemedi'
        );
        companyData = companyDoc.exists() ? companyDoc.data() : {};
      }
      
      // Teklifbul Rule v1.0 - Fallback defaults with complete structure
      const defaultPolicy = {
        require_at_least_one_top_approver: true,
        top_approver_roles: [
          'buyer:genel_mudur',
          'buyer:genel_mudur_yardimcisi',
          'buyer:ceo',
          'buyer:isveren',
          'buyer:yonetim_kurulu_baskani',
          'buyer:yonetim_kurulu_uyesi'
        ],
        reminder_hours: [24, 48],
        strict_top_required: false,
        allowed_final_approver_roles: ['buyer:genel_mudur'],
        approval_limits: [],
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };
      
      // Use company policy if exists, otherwise use defaults
      const currentPolicy = companyData.approvalPolicy || defaultPolicy;
      
      // Ensure all required fields exist
      if (!currentPolicy.approval_limits) {
        currentPolicy.approval_limits = [];
      }
      
      // Teklifbul Rule v1.0 - companyId'yi global scope'a ekle (addApprovalLimitRow iÃ§in)
      window.__currentCompanyId = companyId;
      
      logger.info('YÃ¼klenen approval policy', {
        hasCompanyPolicy: !!companyData.approvalPolicy,
        limitsCount: currentPolicy.approval_limits?.length || 0,
        limits: currentPolicy.approval_limits
      });
      
      // UI'Ä± doldur
      const requireAtLeastOneCheckbox = document.getElementById('approvalPolicy_require_at_least_one_top_approver');
      const strictTopRequiredCheckbox = document.getElementById('approvalPolicy_strict_top_required');
      const reminderHoursInput = document.getElementById('approvalPolicy_reminder_hours');
      
      if (requireAtLeastOneCheckbox) {
        requireAtLeastOneCheckbox.checked = currentPolicy.require_at_least_one_top_approver !== false;
      }
      if (strictTopRequiredCheckbox) {
        strictTopRequiredCheckbox.checked = currentPolicy.strict_top_required === true;
      }
      if (reminderHoursInput) {
        reminderHoursInput.value = currentPolicy.reminder_hours?.join(', ') || '24, 48';
      }
      
      // Ãœst onaycÄ± rolleri checkbox'larÄ±nÄ± oluÅŸtur
      const topApproverRolesContainer = document.getElementById('approvalPolicy_top_approver_roles');
      topApproverRolesContainer.innerHTML = '';
      
      const allBuyerRoles = [
        // YÃ¶netim Rolleri
        { value: 'buyer:genel_mudur', label: 'Genel MÃ¼dÃ¼r' },
        { value: 'buyer:genel_mudur_yardimcisi', label: 'Genel MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±' },
        { value: 'buyer:ceo', label: 'CEO' },
        { value: 'buyer:isveren', label: 'Ä°ÅŸveren (Åirket Sahibi)' },
        { value: 'buyer:yonetim_kurulu_baskani', label: 'YÃ¶netim Kurulu BaÅŸkanÄ±' },
        { value: 'buyer:yonetim_kurulu_uyesi', label: 'YÃ¶netim Kurulu Ãœyesi' },
        // SatÄ±n Alma Rolleri
        { value: 'buyer:satinalma_muduru', label: 'SatÄ±n Alma MÃ¼dÃ¼rÃ¼' },
        { value: 'buyer:satinalma_yetkilisi', label: 'SatÄ±n Alma Yetkilisi' },
        { value: 'buyer:satinalma_uzmani', label: 'SatÄ±n Alma UzmanÄ±' },
        { value: 'buyer:satinalma_uzman_yardimcisi', label: 'SatÄ±n Alma Uzman YardÄ±mcÄ±sÄ±' }
      ];
      
      allBuyerRoles.forEach(role => {
        const label = document.createElement('label');
        label.style.cssText = 'display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; background:white; border-radius:6px; border:1px solid #e5e7eb;';
        label.innerHTML = `
          <input type="checkbox" value="${role.value}" 
                 ${currentPolicy.top_approver_roles?.includes(role.value) ? 'checked' : ''}
                 style="width:18px; height:18px; cursor:pointer;">
          <span style="font-size:14px; color:#1f2937;">${role.label}</span>
        `;
        topApproverRolesContainer.appendChild(label);
      });
      
      // Son onaycÄ± rolleri checkbox'larÄ±nÄ± oluÅŸtur
      const finalApproverRolesContainer = document.getElementById('approvalPolicy_allowed_final_approver_roles');
      finalApproverRolesContainer.innerHTML = '';
      
      allBuyerRoles.forEach(role => {
        const label = document.createElement('label');
        label.style.cssText = 'display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; background:white; border-radius:6px; border:1px solid #e5e7eb;';
        label.innerHTML = `
          <input type="checkbox" value="${role.value}" 
                 ${currentPolicy.allowed_final_approver_roles?.includes(role.value) ? 'checked' : ''}
                 style="width:18px; height:18px; cursor:pointer;">
          <span style="font-size:14px; color:#1f2937;">${role.label}</span>
        `;
        finalApproverRolesContainer.appendChild(label);
      });
      
      // Kaydet butonuna event listener ekle
      const saveBtn = document.getElementById('btnSaveApprovalPolicy');
      if (saveBtn) {
        saveBtn.onclick = async () => {
          const saveFn = window.saveApprovalPolicy || saveApprovalPolicy;
          if (saveFn && typeof saveFn === 'function') {
            await saveFn(companyId);
          } else {
            logger.error('saveApprovalPolicy fonksiyonu bulunamadÄ±');
            const toastFn = window.showToastNotification || showToastNotification;
            if (toastFn && typeof toastFn === 'function') {
              toastFn('âŒ Onay politikasÄ± kaydetme fonksiyonu bulunamadÄ±.', 'error');
            }
          }
        };
      }
      
      // Approval limits'leri yÃ¼kle (Ã¶nceden yÃ¼kle ki buton Ã§alÄ±ÅŸsÄ±n)
      if (typeof window.loadApprovalLimits === 'function') {
        await window.loadApprovalLimits(companyId, currentPolicy);
      }
      
      // Ä°lk yÃ¼klemede buton event listener'Ä±nÄ± baÄŸla (sadece bir kez)
      if (typeof window.setupApprovalLimitButton === 'function') {
        window.setupApprovalLimitButton();
      }
      
    } catch (e) {
      logger.error('Onay mekanizmasÄ± yÃ¶netimi yÃ¼klenirken hata', e);
      toast.warn(MESSAGES.WARN_APPROVAL_SETTINGS_LOAD);
    }
  }
  // Onay politikasÄ±nÄ± kaydet
  // Teklifbul Rule v1.0 - Global scope'a ekle (loadAndSetupApprovalPolicyManagement'dan eriÅŸilebilir olmasÄ± iÃ§in)
  window.saveApprovalPolicy = async function saveApprovalPolicy(companyId) {
    try {
      // Teklifbul Rule v1.0 - Yetki kontrolÃ¼
      const auth = window.__auth;
      const toastFn = window.showToastNotification || showToastNotification;
      if (!auth?.currentUser) {
        if (toastFn && typeof toastFn === 'function') {
          toastFn('âŒ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!', 'error');
        }
        return;
      }
      
      const db = window.__db;
      if (!db) {
        if (toastFn && typeof toastFn === 'function') {
          toastFn('âŒ VeritabanÄ± baÄŸlantÄ±sÄ± bulunamadÄ±!', 'error');
        }
        return;
      }
      
      // Use cached Firestore modules
      const getFirestoreModulesFn = window.getFirestoreModules || getFirestoreModules;
      const { getDoc, doc, updateDoc, collection, addDoc, serverTimestamp } = await getFirestoreModulesFn();
      
      // Get old policy for audit diff
      const safeFirestoreOperationFn = window.safeFirestoreOperation || safeFirestoreOperation;
      const oldPolicyDoc = await safeFirestoreOperationFn(
        () => getDoc(doc(db, 'companies', companyId)),
        'Åirket bilgileri yÃ¼klenemedi'
      );
      const oldPolicy = oldPolicyDoc.exists() ? oldPolicyDoc.data()?.approvalPolicy : null;
      
      const userDoc = await safeFirestoreOperationFn(
        () => getDoc(doc(db, 'users', auth.currentUser.uid)),
        'KullanÄ±cÄ± bilgileri yÃ¼klenemedi'
      );
      const userData = userDoc.exists() ? userDoc.data() : {};
      // Teklifbul Rule v1.0 - Rol kontrolÃ¼: companyRoleKey (prefix'li), companyRole (prefix'siz), veya requestedCompanyRole
      const userRoleKey = userData.companyRoleKey || userData.companyRole || userData.requestedCompanyRole || '';
      const userRoleSimple = userData.companyRole || userData.requestedCompanyRole || '';
      
      // Åirket sahibi kontrolÃ¼ iÃ§in companyData'yÄ± al
      let companyData = {};
      if (oldPolicyDoc.exists()) {
        companyData = oldPolicyDoc.data();
      }
      
      // KullanÄ±cÄ± UID'sini al
      const currentUserUid = auth.currentUser?.uid || null;
      
      const unlimitedApprovalRoles = [
        'buyer:ceo',
        'buyer:isveren',
        'buyer:yonetim_kurulu_baskani',
        'buyer:genel_mudur',
        // Prefix'siz versiyonlar (geriye dÃ¶nÃ¼k uyumluluk)
        'ceo',
        'isveren',
        'yonetim_kurulu_baskani',
        'genel_mudur'
      ];
      
      // Hem prefix'li hem prefix'siz kontrol et + ÅŸirket sahibi kontrolÃ¼
      const hasPermission = unlimitedApprovalRoles.includes(userRoleKey) || 
                            unlimitedApprovalRoles.includes(userRoleSimple) ||
                            // Åirket sahibi kontrolÃ¼ (ownerUid)
                            (currentUserUid && companyData?.ownerUid === currentUserUid);
      
      logger.info('saveApprovalPolicy yetki kontrolÃ¼', { 
        userRoleKey, 
        userRoleSimple, 
        hasPermission, 
        unlimitedApprovalRoles,
        isOwner: currentUserUid && companyData?.ownerUid === currentUserUid,
        ownerUid: companyData?.ownerUid,
        currentUserUid
      });
      
      if (!hasPermission) {
        if (toastFn && typeof toastFn === 'function') {
          toastFn('âŒ Onay politikasÄ± ayarlarÄ±nÄ± yalnÄ±zca CEO, Ä°ÅŸveren, YÃ¶netim Kurulu BaÅŸkanÄ± veya Genel MÃ¼dÃ¼r rolleri kaydedebilir.', 'error');
        }
        return;
      }
      
      const saveBtn = document.getElementById('btnSaveApprovalPolicy');
      const originalText = saveBtn?.textContent || 'ğŸ’¾ Onay PolitikasÄ±nÄ± Kaydet';
      
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = 'â³ Kaydediliyor...';
      }
      
      logger.info('Approval policy kaydediliyor', { companyId, userRoleKey, userRoleSimple, hasPermission });
      
      // Form deÄŸerlerini topla
      const requireAtLeastOne = document.getElementById('approvalPolicy_require_at_least_one_top_approver').checked;
      const strictTopRequired = document.getElementById('approvalPolicy_strict_top_required').checked;
      const reminderHoursText = document.getElementById('approvalPolicy_reminder_hours').value.trim();
      
      // HatÄ±rlatma saatlerini parse et
      const reminderHours = reminderHoursText
        ? reminderHoursText.split(',').map(h => parseInt(h.trim())).filter(h => !isNaN(h))
        : [24, 48];
      
      // Ãœst onaycÄ± rolleri
      const topApproverRoles = Array.from(
        document.querySelectorAll('#approvalPolicy_top_approver_roles input[type="checkbox"]:checked')
      ).map(cb => cb.value);
      
      // Son onaycÄ± rolleri
      const allowedFinalApproverRoles = Array.from(
        document.querySelectorAll('#approvalPolicy_allowed_final_approver_roles input[type="checkbox"]:checked')
      ).map(cb => cb.value);
      
      // Teklifbul Rule v1.0 - Collect and validate approval limits
      const approvalLimits = [];
      const limitRows = document.querySelectorAll('#approvalLimitsList > div');
      const validationErrors = [];
      // Teklifbul Rule v1.0 - Her rol iÃ§in sadece 1 limit olabilir kontrolÃ¼ iÃ§in rol-satÄ±r mapping
      const roleRowMap = new Map(); // role -> [satÄ±r numaralarÄ±]
      
      limitRows.forEach((row, index) => {
        const amountInput = row.querySelector('.approval-limit-amount');
        const roleSelect = row.querySelector('select');
        const descriptionInput = row.querySelector('.approval-limit-description');
        
        const maxAmount = amountInput?.value ? parseFloat(amountInput.value) : null;
        const role = roleSelect?.value || null;
        const rowNumber = index + 1;
        
        // Validate if role is selected
        if (role) {
          const validateFn = window.validateApprovalLimit || validateApprovalLimit;
          const validation = validateFn(maxAmount, role);
          if (!validation.valid) {
            validationErrors.push(`SatÄ±r ${rowNumber}: ${validation.error}`);
            return; // Skip invalid rows
          }
          
          // Teklifbul Rule v1.0 - Rol-satÄ±r mapping'i gÃ¼ncelle
          if (!roleRowMap.has(role)) {
            roleRowMap.set(role, []);
          }
          roleRowMap.get(role).push(rowNumber);
        }
        
        // Save if at least one field is filled
        if (maxAmount !== null && !isNaN(maxAmount) || role) {
          approvalLimits.push({
            maxAmount: maxAmount !== null && !isNaN(maxAmount) ? maxAmount : null,
            role: role || null,
            description: descriptionInput?.value?.trim() || null
          });
        }
      });
      
      // Teklifbul Rule v1.0 - AynÄ± rol iÃ§in birden fazla limit varsa hata ekle
      roleRowMap.forEach((rowNumbers, role) => {
        if (rowNumbers.length > 1) {
          const roleLabel = role || 'Bilinmeyen rol';
          validationErrors.push(`âŒ "${roleLabel}" rolÃ¼ iÃ§in birden fazla limit tanÄ±mlanmÄ±ÅŸ. Her rol iÃ§in sadece 1 limit belirlenebilir. (SatÄ±rlar: ${rowNumbers.join(', ')})`);
        }
      });
      
      // Show validation errors if any
      if (validationErrors.length > 0) {
        if (toastFn && typeof toastFn === 'function') {
          toastFn(validationErrors.join('\n'), 'error');
        }
        return;
      }
      
      // Teklifbul Rule v1.0 - Sort approval limits by role priority
      // SÄ±ralama: 1) Ä°ÅŸveren, 2) YKB BaÅŸkanÄ±, 3) YKB Ãœyesi, 4) CEO, 5) GM, 6) GM YardÄ±mcÄ±sÄ±, sonrasÄ± dinamik
      const rolePriority = window.ROLE_PRIORITY || ROLE_PRIORITY || {};
      approvalLimits.sort((a, b) => {
        // Sabit Ã¶ncelikler (1-6)
        let priorityA = rolePriority[a.role];
        let priorityB = rolePriority[b.role];
        
        // EÄŸer sabit Ã¶ncelik yoksa, dinamik Ã¶ncelik hesapla (7'den baÅŸlar)
        if (priorityA === undefined) {
          priorityA = 7; // Dinamik roller 7'den baÅŸlar
        }
        if (priorityB === undefined) {
          priorityB = 7; // Dinamik roller 7'den baÅŸlar
        }
        
        // AynÄ± Ã¶ncelik seviyesindeyse alfabetik sÄ±rala
        if (priorityA === priorityB) {
          return (a.role || '').localeCompare(b.role || '');
        }
        
        return priorityA - priorityB;
      });
      
      // Firestore'a kaydet
      const approvalPolicy = {
        require_at_least_one_top_approver: requireAtLeastOne,
        top_approver_roles: topApproverRoles,
        reminder_hours: reminderHours,
        strict_top_required: strictTopRequired,
        allowed_final_approver_roles: allowedFinalApproverRoles,
        approval_limits: approvalLimits,
        updatedAt: serverTimestamp(),
        updatedBy: auth.currentUser?.uid || null
      };
      
      // Save to Firestore with error handling
      await safeFirestoreOperationFn(
        () => updateDoc(doc(db, 'companies', companyId), {
          approvalPolicy: approvalPolicy
        }),
        'Onay politikasÄ± kaydedilemedi'
      );
      
      logger.info('Approval policy Firestore\'a kaydedildi', {
        companyId,
        limitsCount: approvalLimits.length,
        limits: approvalLimits
      });
      
      // Teklifbul Rule v1.0 - Enhanced Audit Logging with policyDiff
      const policyDiff = {
        limitsAdded: approvalLimits.length - (oldPolicy?.approval_limits?.length || 0),
        limitsRemoved: (oldPolicy?.approval_limits?.length || 0) - approvalLimits.length,
        limitsCount: approvalLimits.length,
        oldLimitsCount: oldPolicy?.approval_limits?.length || 0,
        topApproverRolesChanged: JSON.stringify(oldPolicy?.top_approver_roles || []) !== JSON.stringify(topApproverRoles),
        reminderHoursChanged: JSON.stringify(oldPolicy?.reminder_hours || []) !== JSON.stringify(reminderHours)
      };
      
      try {
        const auditRef = collection(db, 'audit');
        await safeFirestoreOperationFn(
          () => addDoc(auditRef, {
            entity_type: 'company',
            entity_id: companyId,
            action: 'APPROVAL_POLICY_UPDATED',
            actor_user_id: auth.currentUser?.uid || null,
            actor_role_key: userRoleKey || userRoleSimple || '',
            result: 'success',
            policyDiff: policyDiff,
            metadata: { approvalPolicy },
            created_at: serverTimestamp()
          }),
          'Audit log kaydedilemedi'
        );
        logger.info('Audit log kaydedildi', policyDiff);
      } catch (auditError) {
        logger.warn('Audit log kaydedilemedi', auditError);
        // Don't fail the whole operation if audit fails
      }
      
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
      }
      
      // Success message with toast
      if (toastFn && typeof toastFn === 'function') {
        toastFn(`âœ… Onay politikasÄ± baÅŸarÄ±yla kaydedildi! (${approvalLimits.length} limit)`, 'success');
      }
      
      // SayfayÄ± yeniden yÃ¼kle (kaydedilmiÅŸ limitleri gÃ¶rmek iÃ§in)
      setTimeout(async () => {
        logger.info('Sayfa yeniden yÃ¼kleniyor');
        if (typeof window.loadAndSetupApprovalPolicyManagement === 'function') {
          await window.loadAndSetupApprovalPolicyManagement(companyId, userData);
        }
        logger.info('Sayfa yeniden yÃ¼klendi');
      }, 500);
      
    } catch (e) {
      logger.error('Onay politikasÄ± kaydedilirken hata', e);
      const toastFn = window.showToastNotification || showToastNotification;
      if (toastFn && typeof toastFn === 'function') {
        toastFn('âŒ Onay politikasÄ± kaydedilirken hata oluÅŸtu: ' + (e.message || 'Bilinmeyen hata'), 'error');
      }
      
      const saveBtn = document.getElementById('btnSaveApprovalPolicy');
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = 'ğŸ’¾ Onay PolitikasÄ±nÄ± Kaydet';
      }
    }
  }
  </script>

</body>
</html>