rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function: Get user document from users collection
    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    // Helper function: Get user's company ID
    function userCompany() {
      let userDoc = getUserDoc();
      return userDoc != null && userDoc.data.companyId != null ? userDoc.data.companyId : null;
    }
    
    // Helper function: Check if user has supplier role
    function isSupplier() {
      let userDoc = getUserDoc();
      return userDoc != null && ((userDoc.data.roles != null && userDoc.data.roles.hasAny(['supplier'])) || userDoc.data.role == 'supplier');
    }
    
    // Helper function: Get user's supplier category keys (slug format)
    function userSupplierCats() {
      let userDoc = getUserDoc();
      return userDoc != null && userDoc.data.supplierCategoryKeys != null ? userDoc.data.supplierCategoryKeys : (userDoc != null && userDoc.data.supplierCategories != null ? userDoc.data.supplierCategories : (userDoc != null && userDoc.data.categories != null ? userDoc.data.categories : []));
    }
    
    // Users collection: users can read/write their own profile
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isSupplier());
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Demands collection
    match /demands/{id} {
      allow read: if request.auth != null && (
        resource.data.creatorCompanyId == userCompany()
        || (resource.data.isPublished == true && resource.data.status == 'published' && isSupplier() && resource.data.supplierCategoryKeys.hasAny(userSupplierCats()))
      );
      
      allow create, update, delete: if request.auth != null && request.resource.data.creatorCompanyId == userCompany();
    }
    
    // Şantiye/Adres defteri: /companies/{companyId}/sites/{siteId}
    match /companies/{companyId}/sites/{siteId} {
      allow read, write: if request.auth != null && userCompany() == companyId;
    }
    
    // Stok kartları: /companies/{companyId}/inventory/{sku}
    match /companies/{companyId}/inventory/{sku} {
      allow read: if request.auth != null && userCompany() == companyId;
      allow write: if request.auth != null && userCompany() == companyId;
    }
    
    // Bids collection: Users can read/write their own bids or bids for their company's demands
    match /bids/{bidId} {
      allow read: if request.auth != null && (
        resource.data.supplierId == request.auth.uid
        || (resource.data.demandId != null && exists(/databases/$(database)/documents/demands/$(resource.data.demandId)) && get(/databases/$(database)/documents/demands/$(resource.data.demandId)).data.creatorCompanyId == userCompany())
      );
      allow create: if request.auth != null && request.resource.data.supplierId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.supplierId == request.auth.uid;
    }
    
    // Demand recipients collection
    match /demandRecipients/{recipientId} {
      allow read: if request.auth != null && (resource.data.supplierId == request.auth.uid || resource.data.buyerId == request.auth.uid);
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.buyerId == request.auth.uid;
    }
    
    // Companies collection - public read for referral codes lookup
    match /companies/{companyId} {
      // Public read for basic company info (needed for referral code lookup)
      allow read: if true; // Anyone can read company info (name, code, etc.)
      
      // Write requires authentication
      allow create, update, delete: if request.auth != null;
      
      // Referral Codes subcollection - public read for signup flow
      match /referralCodes/{codeId} {
        // Anyone can read referral codes (needed for signup page)
        allow read: if true;
        // Only authenticated users can create/update (company owners)
        allow create, update: if request.auth != null;
        allow delete: if request.auth != null;
      }
      
      // Referral Companies subcollection - authenticated only
      match /referralCompanies/{referralId} {
        allow read: if request.auth != null && userCompany() == companyId;
        allow create: if request.auth != null;
        allow update, delete: if request.auth != null && userCompany() == companyId;
      }
      
      // Other company subcollections require authentication
      match /{subcollection}/{docId} {
        allow read, write: if request.auth != null && userCompany() == companyId;
      }
    }
    
    // Categories collection - Firestore migration
    match /categories/{categoryId} {
      allow read: if true; // Herkes okuyabilir (public kategori listesi)
      allow write: if request.auth != null; // Authenticated users can write (admin kontrolü API'de)
    }
    
    // Category Keywords collection
    match /category_keywords/{keywordId} {
      allow read: if true; // Herkes okuyabilir
      allow write: if request.auth != null; // Authenticated users can write
    }
    
    // Category Feedback collection
    match /category_feedback/{feedbackId} {
      allow read: if request.auth != null; // Sadece authenticated users
      allow create: if request.auth != null; // Herkes feedback gönderebilir
      allow update, delete: if request.auth != null; // Admin kontrolü API'de
    }
    
    // Tax Offices collection
    match /tax_offices/{officeId} {
      allow read: if true; // Herkes okuyabilir (public vergi daireleri listesi)
      allow write: if request.auth != null; // Authenticated users can write (admin kontrolü API'de)
    }
    
    // Other collections - existing rules (backward compatibility)
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
