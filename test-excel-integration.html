<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Entegrasyon Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .btn { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        input[type="file"] { margin: 10px 0; }
        .result { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>🚀 Teklifbul Excel Entegrasyon Test</h1>
    
    <!-- 1. Satın Alma Formu İçe Aktarma -->
    <div class="section">
        <h2>📥 Satın Alma Formu İçe Aktarma</h2>
        <input type="file" id="purchaseXlsx" accept=".xlsx,.xls">
        <button class="btn" onclick="importPurchaseForm()">Excel'i İçe Aktar</button>
        <div id="purchaseResult" class="result" style="display: none;"></div>
    </div>
    
    <!-- 2. Teklif Formu İçe Aktarma -->
    <div class="section">
        <h2>📥 Teklif Formu İçe Aktarma</h2>
        <input type="file" id="bidXlsx" accept=".xlsx,.xls">
        <button class="btn" onclick="importBidForm()">Teklif Excel'i İçe Aktar</button>
        <div id="bidResult" class="result" style="display: none;"></div>
    </div>
    
    <!-- 3. Teklif Tablosu -->
    <div class="section">
        <h2>📊 Teklif Tablosu</h2>
        <table id="bidTable" class="table">
            <thead>
                <tr>
                    <th>No</th><th>Malzeme Kodu</th><th>Tanım</th><th>Marka/Model</th>
                    <th>Miktar</th><th>Birim</th><th>Birim Fiyat</th><th>KDV %</th>
                    <th>Toplam (KDV Hariç)</th><th>KDV</th><th>Toplam (KDV Dahil)</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr>
                    <th colspan="8" style="text-align:right">Ara Toplam:</th>
                    <th id="sumNet">0</th><th id="sumVat">0</th><th id="sumGross">0</th>
                </tr>
            </tfoot>
        </table>
        <button class="btn btn-success" onclick="exportComparison()">Excel Mukayese İndir</button>
    </div>
    
    <!-- 4. Test Verisi -->
    <div class="section">
        <h2>🧪 Test Verisi</h2>
        <button class="btn" onclick="loadTestData()">Test Verisi Yükle</button>
        <button class="btn" onclick="clearTable()">Tabloyu Temizle</button>
    </div>

    <script type="module">
        import {renderBidTable, collectBidPayload, exportComparisonExcel} from "/assets/bid-form.js";
        import {importPurchaseExcel, fillFormFromDemand} from "/assets/purchase-form.js";
        import {importBidExcel, applyBidToTable, fillBidFormFromExcel} from "/assets/bid-form-import.js";
        
        // Global fonksiyonlar
        window.importPurchaseForm = async () => {
            const fileInput = document.getElementById("purchaseXlsx");
            const resultDiv = document.getElementById("purchaseResult");
            
            try {
                const demand = await importPurchaseExcel(fileInput, (demand) => {
                    console.log("📋 Talep verisi:", demand);
                    
                    // Sonucu göster
                    resultDiv.innerHTML = `
                        <h3>✅ Excel Başarıyla Okundu!</h3>
                        <p><strong>STF No:</strong> ${demand.stf_no}</p>
                        <p><strong>Talep Kodu:</strong> ${demand.talep_kodu}</p>
                        <p><strong>Konu:</strong> ${demand.talep_konusu}</p>
                        <p><strong>Ürün Sayısı:</strong> ${demand.items.length}</p>
                        <pre>${JSON.stringify(demand, null, 2)}</pre>
                    `;
                    resultDiv.style.display = "block";
                    
                    // Tabloyu güncelle
                    renderBidTable(demand);
                });
            } catch (error) {
                resultDiv.innerHTML = `<h3>❌ Hata:</h3><p>${error.message}</p>`;
                resultDiv.style.display = "block";
            }
        };
        
        window.importBidForm = async () => {
            const fileInput = document.getElementById("bidXlsx");
            const resultDiv = document.getElementById("bidResult");
            
            try {
                const bid = await importBidExcel(fileInput, (bid) => {
                    console.log("💰 Teklif verisi:", bid);
                    
                    // Sonucu göster
                    resultDiv.innerHTML = `
                        <h3>✅ Teklif Excel Başarıyla Okundu!</h3>
                        <p><strong>Firma:</strong> ${bid.firma_adi}</p>
                        <p><strong>Talep Kodu:</strong> ${bid.talep_kodu}</p>
                        <p><strong>STF No:</strong> ${bid.stf_no}</p>
                        <p><strong>Fiyat Sayısı:</strong> ${bid.fiyatlar.length}</p>
                        <pre>${JSON.stringify(bid, null, 2)}</pre>
                    `;
                    resultDiv.style.display = "block";
                    
                    // Tabloyu güncelle ve fiyatları uygula
                    const demand = { items: bid.items, stf_no: bid.stf_no, talep_kodu: bid.talep_kodu };
                    renderBidTable(demand);
                    applyBidToTable(bid);
                });
            } catch (error) {
                resultDiv.innerHTML = `<h3>❌ Hata:</h3><p>${error.message}</p>`;
                resultDiv.style.display = "block";
            }
        };
        
        window.loadTestData = () => {
            const testDemand = {
                stf_no: "STF-2025-0001",
                talep_kodu: "TEST001",
                talep_konusu: "Test Talep",
                santiye: "Test Şantiye",
                usd_try: 34.85,
                items: [
                    { no: 1, name: "Çimento", qty: 100, unit: "Torba", sku: "CEM001", brand: "Akçansa" },
                    { no: 2, name: "Demir", qty: 50, unit: "Ton", sku: "DEM001", brand: "Erdemir" },
                    { no: 3, name: "Tuğla", qty: 1000, unit: "Adet", sku: "TUG001", brand: "Bims" }
                ]
            };
            
            renderBidTable(testDemand);
            console.log("✅ Test verisi yüklendi");
        };
        
        window.clearTable = () => {
            const tbody = document.querySelector("#bidTable tbody");
            if (tbody) tbody.innerHTML = "";
            
            document.getElementById("sumNet").textContent = "0";
            document.getElementById("sumVat").textContent = "0";
            document.getElementById("sumGross").textContent = "0";
            
            console.log("✅ Tablo temizlendi");
        };
        
        window.exportComparison = async () => {
            try {
                // Mevcut tablodan veri topla
                const tbody = document.querySelector("#bidTable tbody");
                if (!tbody || tbody.children.length === 0) {
                    alert("Önce tabloya veri ekleyin!");
                    return;
                }
                
                // Test verisi oluştur
                const testDemand = {
                    stf_no: "STF-2025-0001",
                    talep_kodu: "TEST001",
                    talep_konusu: "Test Talep",
                    santiye: "Test Şantiye",
                    usd_try: 34.85,
                    items: [
                        { no: 1, name: "Çimento", qty: 100, unit: "Torba" },
                        { no: 2, name: "Demir", qty: 50, unit: "Ton" },
                        { no: 3, name: "Tuğla", qty: 1000, unit: "Adet" }
                    ],
                    firms: [{
                        firma_adi: "Test Firma",
                        tel: "05001234567",
                        odeme: "%50 Peşin",
                        termin: "25.10.2025",
                        fiyatlar: [250, 400, 15]
                    }]
                };
                
                await exportComparisonExcel(testDemand);
            } catch (error) {
                console.error("❌ Export hatası:", error);
                alert("Excel export hatası: " + error.message);
            }
        };
        
        // Sayfa yüklendiğinde test verisi yükle
        window.addEventListener("load", () => {
            console.log("🚀 Excel Entegrasyon Test sayfası yüklendi");
        });
    </script>
</body>
</html>
