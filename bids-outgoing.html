<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gönderdiğim Teklifler</title>
  <style>
    :root { --border:#e5e7eb; --muted:#f8fafc; --c1:#2563eb; }
    body{font-family:system-ui,Arial;margin:0;color:#0f172a;background:#fff;}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#fff;z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .filters{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-bottom:12px}
    select,input{padding:10px;border:1px solid var(--border);border-radius:8px}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f9fafb}
    .badge{padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600}
    .b-secret{background:#dbeafe;color:#1e40af}
    .b-open{background:#dcfce7;color:#166534}
    .b-hybrid{background:#f3e8ff;color:#6b21a8}
    .muted{color:#64748b}
    .btn-link{background:none;border:0;color:var(--c1);cursor:pointer;font-weight:600}
    .empty{padding:24px;text-align:center;color:#64748b}
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="bids-incoming.html" class="btn-link">← Gelen Teklifler</a>
    </nav>
    <div><strong>Gönderdiğim Teklifler</strong></div>
    <div></div>
  </header>
  <div class="container">
    <div class="filters">
      <select id="f-demand"><option value="">Tüm Talepler</option></select>
      <select id="f-mode">
        <option value="">Talep Tipi (Tümü)</option>
        <option value="secret">Gizli</option>
        <option value="open">Açık</option>
        <option value="hybrid">Hibrit</option>
      </select>
      <select id="f-status">
        <option value="">Durum (Tümü)</option>
        <option value="sent">Gönderildi</option>
        <option value="responded">Yanıtlandı</option>
        <option value="accepted">Kabul</option>
        <option value="rejected">Red</option>
        <option value="completed">Tamamlandı</option>
      </select>
      <input id="f-buyer" placeholder="Alıcı firma ara..." />
    </div>

    <table>
      <thead>
        <tr>
          <th>Talep</th>
          <th>Alıcı Firma</th>
          <th>Fiyat</th>
          <th>Termin</th>
          <th>Marka</th>
          <th>Ödeme</th>
          <th>Durum</th>
          <th>Tip</th>
          <th>Tarih</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
    <div id="empty" class="empty hidden">Gönderdiğiniz teklif yok.</div>
  </div>

  <script type="module">
    import { auth, db } from './firebase.js';
    import {
      collection, query, where, getDocs, getDoc, doc, orderBy, limit
    } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
    import { getStatusLabel, getPaymentMethodLabel } from './bid-management.js';

    const $ = (s)=>document.querySelector(s);
    const fmt = (n)=> typeof n==='number' ? new Intl.NumberFormat('tr-TR').format(n) : '—';
    const fmtDate = (ts)=>{ try{ const d = ts?.toDate ? ts.toDate() : (ts? new Date(ts): null); return d? d.toLocaleDateString('tr-TR'): '—'; }catch{return '—'} };
    const badge=(mode)=>{
      const m=(mode||'').toLowerCase();
      if(m==='open') return '<span class="badge b-open">Açık</span>';
      if(m==='hybrid') return '<span class="badge b-hybrid">Hibrit</span>';
      return '<span class="badge b-secret">Gizli</span>';
    };

    const CACHE_DEMANDS=new Map();
    async function preloadDemandsForSupplier(user){
      // Get unique demandIds from my bids to fill demand filter quickly
      const q=query(collection(db,'bids'), where('supplierId','==', user.uid), orderBy('createdAt','desc'), limit(200));
      const snap=await getDocs(q);
      const demandIds=[...new Set(snap.docs.map(d=>d.data().demandId))];
      const sel=$('#f-demand');
      for(const id of demandIds){
        const ds=await getDoc(doc(db,'demands', id));
        if(ds.exists()){
          const data=ds.data(); CACHE_DEMANDS.set(id,{id, ...data});
          const opt=document.createElement('option'); opt.value=id; opt.textContent=data.title||id; sel.appendChild(opt);
        }
      }
    }
    async function joinBuyerCompanyName(demand){
      try{
        const u = await getDoc(doc(db,'users', demand.createdBy));
        return u.exists()? (u.data().companyName || '—') : '—';
      }catch{return '—'}
    }
    function matchesFilters(r){
      const demandFilter=$('#f-demand').value;
      const modeFilter=$('#f-mode').value;
      const statusFilter=$('#f-status').value;
      const buyerSearch=$('#f-buyer').value.trim().toLowerCase();
      if(demandFilter && r.demandId!==demandFilter) return false;
      if(modeFilter && (r.biddingMode||'')!==modeFilter) return false;
      if(statusFilter && (r.status||'')!==statusFilter) return false;
      if(buyerSearch && !(r.buyerCompanyName||'').toLowerCase().includes(buyerSearch)) return false;
      return true;
    }
    function render(rows){
      const body=$('#rows'); body.innerHTML='';
      const filtered=rows.filter(matchesFilters);
      if(filtered.length===0){ $('#empty').classList.remove('hidden'); return } else { $('#empty').classList.add('hidden'); }
      filtered.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${r.demandTitle||r.demandId}</td>
          <td>${r.buyerCompanyName||'—'}</td>
          <td>₺ ${fmt(r.netPrice ?? r.price)}</td>
          <td>${r.leadTimeDays ?? '—'}</td>
          <td>${r.brand||'—'}</td>
          <td>${getPaymentMethodLabel(r.paymentMethod||'unknown')}</td>
          <td>${getStatusLabel(r.status||'pending')}</td>
          <td>${badge(r.biddingMode)}</td>
          <td>${fmtDate(r.createdAt)}</td>
          <td><button class="btn-link" data-demand="${r.demandId}">Görüntüle →</button></td>`;
        body.appendChild(tr);
      });
      body.querySelectorAll('button[data-demand]').forEach(b=>{
        b.addEventListener('click', (e)=>{
          const id=e.currentTarget.dataset.demand;
          window.location.href=`demand-detail.html?id=${encodeURIComponent(id)}#bids`;
        });
      });
    }

    async function loadOutgoing(user){
      const q=query(collection(db,'bids'), where('supplierId','==', user.uid), orderBy('createdAt','desc'), limit(200));
      const snap=await getDocs(q);
      const rows=[];
      for(const b of snap.docs){
        const data={id:b.id, ...b.data()};
        const dSnap=await getDoc(doc(db,'demands', data.demandId));
        if(dSnap.exists()){
          const dem={id:dSnap.id, ...dSnap.data()}; CACHE_DEMANDS.set(dem.id, dem);
          data.demandTitle=dem.title; data.biddingMode=dem.biddingMode || 'secret';
          data.buyerCompanyName=await joinBuyerCompanyName(dem);
        }
        rows.push(data);
      }
      return rows;
    }

    async function init(){
      const user=auth.currentUser;
      await preloadDemandsForSupplier(user);
      const data=await loadOutgoing(user);
      render(data);
      ['#f-demand','#f-mode','#f-status','#f-buyer'].forEach(sel=> $(sel).addEventListener('input', ()=> render(data)));
    }

    onAuthStateChanged(auth, (u)=>{ if(!u){ window.location.href='login.html'; } else { init(); } });
  </script>
</body>
</html>
