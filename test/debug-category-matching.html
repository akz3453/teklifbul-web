<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kategori EÅŸleÅŸtirme Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .category-list { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .category-item { padding: 4px 8px; background: #e9ecef; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸ” Kategori EÅŸleÅŸtirme Debug</h1>
    
    <div class="debug-section info">
        <h3>ğŸ“‹ Debug Senaryosu</h3>
        <p>Bu sayfa kategori eÅŸleÅŸtirmelerini test eder.</p>
        <ol>
            <li>Talep oluÅŸtururkenki kategorileri kontrol et</li>
            <li>Ãœyelik oluÅŸtururkenki kategorileri kontrol et</li>
            <li>Kategori eÅŸleÅŸtirme mantÄ±ÄŸÄ±nÄ± test et</li>
            <li>publishDemandAndMatchSuppliers fonksiyonunu test et</li>
        </ol>
    </div>
    
    <div class="debug-section">
        <h3>ğŸ§ª Debug ButonlarÄ±</h3>
        <button onclick="debugCategories()">Kategorileri KarÅŸÄ±laÅŸtÄ±r</button>
        <button onclick="debugUserCategories()">KullanÄ±cÄ± Kategorilerini Kontrol Et</button>
        <button onclick="debugDemandCategories()">Talep Kategorilerini Kontrol Et</button>
        <button onclick="debugMatchingLogic()">EÅŸleÅŸtirme MantÄ±ÄŸÄ±nÄ± Test Et</button>
    </div>
    
    <div id="debug-results"></div>
    
    <script type="module">
        import { db, auth, requireAuth } from "./firebase.js";
        import { CATEGORIES } from "./categories.js";
        import {
          collection, getDocs, query, where, orderBy, limit, doc, getDoc
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        
        let currentUser = null;
        
        // Talep oluÅŸtururkenki varsayÄ±lan kategoriler
        const demandDefaultGroups = [
          { name: "Ä°nÅŸaat Malzemeleri", categories: ["Ä°nÅŸaat Malzemeleri", "HÄ±rdavat", "Boya"] },
          { name: "Elektrik", categories: ["Elektrik", "Elektronik"] },
          { name: "Makine-Ä°malat", categories: ["Makine-Ä°malat", "Sac/Metal", "Otomotiv Yan Sanayi"] },
          { name: "DiÄŸer", categories: ["Ambalaj", "Kimyasal", "Mobilya", "Plastik", "Ä°ÅŸ GÃ¼venliÄŸi", "Temizlik", "GÄ±da", "Hizmet", "Lojistik"] }
        ];
        
        async function init() {
            try {
                currentUser = await requireAuth();
                console.log('User authenticated:', currentUser.email);
                addResult(`âœ… KullanÄ±cÄ± giriÅŸi baÅŸarÄ±lÄ±: ${currentUser.email}`, 'success');
            } catch (error) {
                console.error('Auth error:', error);
                addResult('âŒ KullanÄ±cÄ± giriÅŸi baÅŸarÄ±sÄ±z: ' + error.message, 'error');
            }
        }
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `debug-section ${type}`;
            div.innerHTML = message;
            document.getElementById('debug-results').appendChild(div);
        }
        
        function clearResults() {
            document.getElementById('debug-results').innerHTML = '';
        }
        
        function debugCategories() {
            clearResults();
            addResult('<h3>ğŸ” Kategori KarÅŸÄ±laÅŸtÄ±rmasÄ±</h3>', 'info');
            
            // categories.js'den gelen kategoriler
            addResult(`
                <h4>ğŸ“‹ categories.js Kategorileri (${CATEGORIES.length} adet)</h4>
                <div class="category-list">
                    ${CATEGORIES.map(cat => `<span class="category-item">${cat}</span>`).join('')}
                </div>
            `, 'info');
            
            // Talep oluÅŸtururkenki varsayÄ±lan kategoriler
            const demandCategories = demandDefaultGroups.flatMap(group => group.categories);
            addResult(`
                <h4>ğŸ“‹ Talep OluÅŸtururkenki VarsayÄ±lan Kategoriler (${demandCategories.length} adet)</h4>
                <div class="category-list">
                    ${demandCategories.map(cat => `<span class="category-item">${cat}</span>`).join('')}
                </div>
            `, 'info');
            
            // EÅŸleÅŸmeyen kategorileri bul
            const unmatchedDemand = demandCategories.filter(cat => !CATEGORIES.includes(cat));
            const unmatchedCategories = CATEGORIES.filter(cat => !demandCategories.includes(cat));
            
            if (unmatchedDemand.length > 0) {
                addResult(`
                    <h4>âŒ Talep kategorilerinde eÅŸleÅŸmeyenler</h4>
                    <div class="category-list">
                        ${unmatchedDemand.map(cat => `<span class="category-item" style="background: #f8d7da;">${cat}</span>`).join('')}
                    </div>
                `, 'error');
            }
            
            if (unmatchedCategories.length > 0) {
                addResult(`
                    <h4>âš ï¸ categories.js'de olan ama talep kategorilerinde olmayanlar</h4>
                    <div class="category-list">
                        ${unmatchedCategories.map(cat => `<span class="category-item" style="background: #fff3cd;">${cat}</span>`).join('')}
                    </div>
                `, 'warning');
            }
            
            if (unmatchedDemand.length === 0 && unmatchedCategories.length === 0) {
                addResult('âœ… TÃ¼m kategoriler eÅŸleÅŸiyor!', 'success');
            }
        }
        
        async function debugUserCategories() {
            clearResults();
            addResult('<h3>ğŸ” KullanÄ±cÄ± Kategorileri</h3>', 'info');
            
            if (!currentUser) {
                addResult('âŒ KullanÄ±cÄ± giriÅŸi gerekli', 'error');
                return;
            }
            
            try {
                // KullanÄ±cÄ±nÄ±n kategorilerini al
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (!userDoc.exists()) {
                    addResult('âŒ KullanÄ±cÄ± profili bulunamadÄ±', 'error');
                    return;
                }
                
                const userData = userDoc.data();
                const userCategories = userData.categories || [];
                
                addResult(`
                    <h4>ğŸ‘¤ KullanÄ±cÄ± Kategorileri (${userCategories.length} adet)</h4>
                    <div class="category-list">
                        ${userCategories.map(cat => `<span class="category-item">${cat}</span>`).join('')}
                    </div>
                `, 'info');
                
                // KullanÄ±cÄ±nÄ±n kategorilerinin categories.js'de olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                const invalidCategories = userCategories.filter(cat => !CATEGORIES.includes(cat));
                if (invalidCategories.length > 0) {
                    addResult(`
                        <h4>âŒ GeÃ§ersiz kategoriler</h4>
                        <div class="category-list">
                            ${invalidCategories.map(cat => `<span class="category-item" style="background: #f8d7da;">${cat}</span>`).join('')}
                        </div>
                    `, 'error');
                } else {
                    addResult('âœ… TÃ¼m kullanÄ±cÄ± kategorileri geÃ§erli', 'success');
                }
                
            } catch (error) {
                addResult(`âŒ KullanÄ±cÄ± kategorileri yÃ¼klenemedi: ${error.message}`, 'error');
            }
        }
        
        async function debugDemandCategories() {
            clearResults();
            addResult('<h3>ğŸ” Talep Kategorileri</h3>', 'info');
            
            if (!currentUser) {
                addResult('âŒ KullanÄ±cÄ± giriÅŸi gerekli', 'error');
                return;
            }
            
            try {
                // KullanÄ±cÄ±nÄ±n taleplerini al
                const q = query(collection(db, 'demands'), where('createdBy', '==', currentUser.uid), orderBy('createdAt', 'desc'), limit(5));
                const snap = await getDocs(q);
                
                if (snap.empty) {
                    addResult('âš ï¸ KullanÄ±cÄ±nÄ±n hiÃ§ talebi yok', 'warning');
                    return;
                }
                
                addResult(`ğŸ“Š KullanÄ±cÄ±nÄ±n son ${snap.docs.length} talebi:`, 'info');
                
                snap.docs.forEach((doc, index) => {
                    const data = doc.data();
                    const categories = data.categories || [];
                    
                    addResult(`
                        <h4>Talep ${index + 1}: ${data.title || 'BaÅŸlÄ±ksÄ±z'}</h4>
                        <p><strong>Kategoriler:</strong> ${categories.length} adet</p>
                        <div class="category-list">
                            ${categories.map(cat => `<span class="category-item">${cat}</span>`).join('')}
                        </div>
                        <p><strong>Durum:</strong> ${data.published ? 'YayÄ±nlandÄ±' : 'Taslak'}</p>
                    `, 'info');
                    
                    // Kategorilerin geÃ§erliliÄŸini kontrol et
                    const invalidCategories = categories.filter(cat => !CATEGORIES.includes(cat));
                    if (invalidCategories.length > 0) {
                        addResult(`
                            <h4>âŒ GeÃ§ersiz kategoriler</h4>
                            <div class="category-list">
                                ${invalidCategories.map(cat => `<span class="category-item" style="background: #f8d7da;">${cat}</span>`).join('')}
                            </div>
                        `, 'error');
                    }
                });
                
            } catch (error) {
                addResult(`âŒ Talep kategorileri yÃ¼klenemedi: ${error.message}`, 'error');
            }
        }
        
        async function debugMatchingLogic() {
            clearResults();
            addResult('<h3>ğŸ” EÅŸleÅŸtirme MantÄ±ÄŸÄ± Testi</h3>', 'info');
            
            if (!currentUser) {
                addResult('âŒ KullanÄ±cÄ± giriÅŸi gerekli', 'error');
                return;
            }
            
            try {
                // Test kategorileri
                const testCategories = ['Elektrik', 'Makine-Ä°malat'];
                
                addResult(`ğŸ§ª Test kategorileri: ${testCategories.join(', ')}`, 'info');
                
                // Bu kategorilerdeki tedarikÃ§ileri bul
                const q = query(
                    collection(db, 'users'),
                    where('isActive', '==', true),
                    where('categories', 'array-contains-any', testCategories),
                    where('roles.supplier', '==', true)
                );
                
                const snap = await getDocs(q);
                
                addResult(`ğŸ“Š Bulunan tedarikÃ§i sayÄ±sÄ±: ${snap.docs.length}`, 'info');
                
                if (snap.docs.length === 0) {
                    addResult('âš ï¸ HiÃ§ tedarikÃ§i bulunamadÄ±!', 'warning');
                    
                    // TÃ¼m aktif tedarikÃ§ileri kontrol et
                    const allSuppliersQ = query(
                        collection(db, 'users'),
                        where('isActive', '==', true),
                        where('roles.supplier', '==', true)
                    );
                    
                    const allSuppliersSnap = await getDocs(allSuppliersQ);
                    addResult(`ğŸ“Š Toplam aktif tedarikÃ§i sayÄ±sÄ±: ${allSuppliersSnap.docs.length}`, 'info');
                    
                    if (allSuppliersSnap.docs.length > 0) {
                        addResult('ğŸ” TedarikÃ§i kategorileri:', 'info');
                        allSuppliersSnap.docs.forEach((doc, index) => {
                            const data = doc.data();
                            const categories = data.categories || [];
                            addResult(`
                                <h4>TedarikÃ§i ${index + 1}: ${data.companyName || 'Ä°simsiz'}</h4>
                                <div class="category-list">
                                    ${categories.map(cat => `<span class="category-item">${cat}</span>`).join('')}
                                </div>
                            `, 'info');
                        });
                    }
                } else {
                    snap.docs.forEach((doc, index) => {
                        const data = doc.data();
                        const categories = data.categories || [];
                        addResult(`
                            <h4>TedarikÃ§i ${index + 1}: ${data.companyName || 'Ä°simsiz'}</h4>
                            <div class="category-list">
                                ${categories.map(cat => `<span class="category-item">${cat}</span>`).join('')}
                            </div>
                        `, 'success');
                    });
                }
                
            } catch (error) {
                addResult(`âŒ EÅŸleÅŸtirme mantÄ±ÄŸÄ± testi baÅŸarÄ±sÄ±z: ${error.message}`, 'error');
            }
        }
        
        // Initialize
        init();
    </script>
</body>
</html>
