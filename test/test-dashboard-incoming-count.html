<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Test - Gelen Talepler SayÄ±sÄ±</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>ğŸ” Dashboard Test - Gelen Talepler SayÄ±sÄ±</h1>
    
    <div class="test-section">
        <h3>1. Firebase BaÄŸlantÄ±sÄ±</h3>
        <button onclick="testFirebaseConnection()">Firebase BaÄŸlantÄ±sÄ±nÄ± Test Et</button>
        <div id="firebase-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>2. Gelen Talepler SayÄ±sÄ± (Dashboard MantÄ±ÄŸÄ±)</h3>
        <button onclick="testIncomingDemandsCount()">Gelen Talepler SayÄ±sÄ±nÄ± Test Et</button>
        <div id="incoming-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. TÃ¼m YayÄ±nlanmÄ±ÅŸ Talepler</h3>
        <button onclick="testAllPublishedDemands()">TÃ¼m YayÄ±nlanmÄ±ÅŸ Talepleri Listele</button>
        <div id="published-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>4. Dashboard'a Git</h3>
        <button onclick="window.open('./dashboard.html', '_blank')">Dashboard'Ä± AÃ§</button>
        <p>Dashboard'da "Gelen Talepler" sayÄ±sÄ±nÄ±n doÄŸru gÃ¶sterilip gÃ¶sterilmediÄŸini kontrol edin.</p>
    </div>

    <script type="module">
        // Teklifbul Rule v1.0 - Root firebase.js kullan (duplicate app hatasÄ± Ã¶nleme)
        import { db, auth } from './firebase.js';
        import { collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

        window.testFirebaseConnection = function() {
            const resultDiv = document.getElementById('firebase-result');
            try {
                resultDiv.innerHTML = '<div class="success">âœ… Firebase baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±!</div>';
                resultDiv.innerHTML += `<div>Database: ${db ? 'BaÄŸlÄ±' : 'BaÄŸlÄ± deÄŸil'}</div>`;
                resultDiv.innerHTML += `<div>Auth: ${auth ? 'BaÄŸlÄ±' : 'BaÄŸlÄ± deÄŸil'}</div>`;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ Firebase baÄŸlantÄ± hatasÄ±: ${error.message}</div>`;
            }
        };

        window.testIncomingDemandsCount = async function() {
            const resultDiv = document.getElementById('incoming-result');
            resultDiv.innerHTML = 'â³ YÃ¼kleniyor...';
            
            try {
                // Dashboard mantÄ±ÄŸÄ± ile aynÄ± sorgu
                const qIncomingDemands = query(
                    collection(db, "demands"),
                    where("published", "==", true),
                    where("demandCode", "!=", null),
                    orderBy("createdAt", "desc"),
                    limit(100)
                );
                
                const incomingSnap = await getDocs(qIncomingDemands);
                const incomingDemands = incomingSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                resultDiv.innerHTML = `
                    <div class="success">âœ… Gelen Talepler SayÄ±sÄ±: ${incomingDemands.length}</div>
                    <div>Toplam yayÄ±nlanmÄ±ÅŸ talep: ${incomingSnap.size}</div>
                    <div>Ä°ÅŸlenen talep: ${incomingDemands.length}</div>
                `;
                
                if (incomingDemands.length > 0) {
                    resultDiv.innerHTML += '<div><strong>Ä°lk 3 talep:</strong></div>';
                    incomingDemands.slice(0, 3).forEach((demand, index) => {
                        resultDiv.innerHTML += `
                            <div style="margin-left: 20px; font-size: 12px;">
                                ${index + 1}. ${demand.title || 'BaÅŸlÄ±k yok'} - Kod: ${demand.demandCode || 'Kod yok'}
                            </div>
                        `;
                    });
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ Hata: ${error.message}</div>`;
                if (error.message.includes('index')) {
                    resultDiv.innerHTML += '<div>ğŸ’¡ Firestore index hatasÄ±. Konsoldaki "Create index" linkine tÄ±klayÄ±n.</div>';
                }
            }
        };

        window.testAllPublishedDemands = async function() {
            const resultDiv = document.getElementById('published-result');
            resultDiv.innerHTML = 'â³ YÃ¼kleniyor...';
            
            try {
                // TÃ¼m yayÄ±nlanmÄ±ÅŸ talepleri al
                const qAllPublished = query(
                    collection(db, "demands"),
                    where("published", "==", true),
                    orderBy("createdAt", "desc"),
                    limit(50)
                );
                
                const allPublishedSnap = await getDocs(qAllPublished);
                const allPublished = allPublishedSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const withCodes = allPublished.filter(d => d.demandCode);
                const withoutCodes = allPublished.filter(d => !d.demandCode);
                
                resultDiv.innerHTML = `
                    <div class="success">âœ… TÃ¼m YayÄ±nlanmÄ±ÅŸ Talepler Analizi</div>
                    <div>Toplam yayÄ±nlanmÄ±ÅŸ talep: ${allPublished.length}</div>
                    <div>Kodlu talepler: ${withCodes.length}</div>
                    <div>Kodsuz talepler: ${withoutCodes.length}</div>
                `;
                
                if (withCodes.length > 0) {
                    resultDiv.innerHTML += '<div><strong>Kodlu talepler:</strong></div>';
                    withCodes.slice(0, 5).forEach((demand, index) => {
                        resultDiv.innerHTML += `
                            <div style="margin-left: 20px; font-size: 12px;">
                                ${index + 1}. ${demand.title || 'BaÅŸlÄ±k yok'} - Kod: ${demand.demandCode}
                            </div>
                        `;
                    });
                }
                
                if (withoutCodes.length > 0) {
                    resultDiv.innerHTML += '<div><strong>Kodsuz talepler:</strong></div>';
                    withoutCodes.slice(0, 3).forEach((demand, index) => {
                        resultDiv.innerHTML += `
                            <div style="margin-left: 20px; font-size: 12px;">
                                ${index + 1}. ${demand.title || 'BaÅŸlÄ±k yok'} - Kod: Yok
                            </div>
                        `;
                    });
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ Hata: ${error.message}</div>`;
            }
        };

        // Sayfa yÃ¼klendiÄŸinde otomatik test
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('KullanÄ±cÄ± giriÅŸ yapmÄ±ÅŸ:', user.email);
                document.getElementById('firebase-result').innerHTML = `
                    <div class="success">âœ… KullanÄ±cÄ± giriÅŸ yapmÄ±ÅŸ: ${user.email}</div>
                `;
            } else {
                console.log('KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸ');
                document.getElementById('firebase-result').innerHTML = `
                    <div class="error">âŒ KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸ. LÃ¼tfen giriÅŸ yapÄ±n.</div>
                `;
            }
        });
    </script>
</body>
</html>
