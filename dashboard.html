<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Teklifbul â€” Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%233b82f6' rx='6'/%3E%3Ctext x='16' y='22' font-family='Arial' font-size='18' font-weight='bold' text-anchor='middle' fill='white'%3ET%3C/text%3E%3C/svg%3E" />
  <link rel="stylesheet" href="/utils.css" />
  <link rel="stylesheet" href="/assets/css/layout.css" />
  <style>
    body { margin: 0; font-family: system-ui, Arial; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin: 16px 0; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; background: white; }
    .card h2 { margin: 8px 0 0 0; font-size: 32px; color: #1f2937; }
    .card-title { font-size: 14px; color: #6b7280; font-weight: 500; }
    .metric-card { cursor: pointer; transition: all 0.2s; }
    .metric-card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.1); transform: translateY(-2px); }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 12px; background: #e5e7eb; font-size: 12px; }
    .badge.success { background: #d1fae5; color: #065f46; }
    .badge.warn { background: #fef3c7; color: #92400e; }
    .table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .table th, .table td { border-bottom: 1px solid #e5e7eb; padding: 10px; text-align: left; }
    .table th { background: #f9fafb; font-weight: 600; font-size: 13px; color: #374151; }
    .table td { font-size: 14px; }
    .fx-row { display: flex; justify-content: space-between; align-items: center; margin: 6px 0; }
    .fx-label { font-size: 13px; color: #6b7280; }
    .fx-value { font-size: 18px; font-weight: 600; color: #1f2937; }
    .quick-links { display: flex; gap: 12px; margin-top: 12px; }
    .quick-links a { text-decoration: none; color: #3b82f6; font-weight: 500; }
    
    /* Navigation Cards */
    .nav-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      text-decoration: none;
      color: inherit;
      transition: all 0.2s;
    }
    .nav-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: #3b82f6;
    }
    .nav-icon {
      font-size: 24px;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8fafc;
      border-radius: 8px;
    }
    .nav-content h4 {
      margin: 0 0 4px 0;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }
    .nav-content p {
      margin: 0;
      font-size: 13px;
      color: #6b7280;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <!-- Common Header -->
  <header id="app-header"></header>

  <main class="container--wide" style="padding:20px 0">
    <h1 style="margin:0 0 20px 0">Dashboard</h1>
    
    <!-- Quick Navigation -->
    <div class="card" style="margin-bottom:24px">
      <h3 style="margin:0 0 16px 0">ğŸ“‹ Sayfa Navigasyonu</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px">
        <a href="./demands.html" class="nav-card">
          <div class="nav-icon">ğŸ“‹</div>
          <div class="nav-content">
            <h4>Taleplerim</h4>
            <p>OluÅŸturduÄŸum ve aldÄ±ÄŸÄ±m talepleri gÃ¶rÃ¼ntÃ¼le</p>
          </div>
        </a>
        <a href="./bids.html" class="nav-card">
          <div class="nav-icon">ğŸ’°</div>
          <div class="nav-content">
            <h4>Teklifler</h4>
            <p>Gelen ve gÃ¶nderdiÄŸim teklifleri yÃ¶net</p>
          </div>
        </a>
        <a href="./main-demands.html" class="nav-card">
          <div class="nav-icon">ğŸ›ï¸</div>
          <div class="nav-content">
            <h4>Ana Talep EkranÄ±</h4>
            <p>TedarikÃ§iler iÃ§in genel talep listesi</p>
          </div>
        </a>
        <a href="./demand-new.html" class="nav-card">
          <div class="nav-icon">â•</div>
          <div class="nav-content">
            <h4>Yeni Talep OluÅŸtur</h4>
            <p>Yeni bir talep oluÅŸtur ve yayÄ±nla</p>
          </div>
        </a>
        <a href="./settings.html" class="nav-card">
          <div class="nav-icon">âš™ï¸</div>
          <div class="nav-content">
            <h4>Ayarlar</h4>
            <p>Hesap ve firma bilgilerini dÃ¼zenle</p>
          </div>
        </a>
        <!-- Diagnostic Tools -->
        <a href="./debug-info.html" class="nav-card" style="border-color: #ff9800;">
          <div class="nav-icon">ğŸ”§</div>
          <div class="nav-content">
            <h4>Sistem TeÅŸhisi</h4>
            <p>Sistem durumunu kontrol et</p>
          </div>
        </a>
        <a href="./test-data-loading.html" class="nav-card" style="border-color: #ff9800;">
          <div class="nav-icon">ğŸ§ª</div>
          <div class="nav-content">
            <h4>Veri Testi</h4>
            <p>Veri yÃ¼kleme iÅŸlemlerini test et</p>
          </div>
        </a>
      </div>
    </div>
    
    <!-- Metrics Cards -->
    <div class="cards">
      <div class="card metric-card clickable-card" id="inbox-card" onclick="location.href='./demands.html?filter=inbox'">
        <div class="card-title">Gelen Talepler</div>
        <h2 id="metric-inbox">0</h2>
      </div>
      <div class="card metric-card clickable-card" id="sent-card" onclick="location.href='./demands.html?filter=sent'">
        <div class="card-title">GÃ¶nderdiÄŸim Talepler</div>
        <h2 id="metric-sent">0</h2>
      </div>
      <div class="card metric-card clickable-card" id="draft-card" onclick="location.href='./demands.html?filter=draft'">
        <div class="card-title">Taslak Talepler</div>
        <h2 id="metric-draft">0</h2>
      </div>
      <!-- FCM Test Card -->
      <div class="card" id="fcm-test-card" style="border-color: #3b82f6;">
        <div class="card-title">ğŸ”” Push Bildirimleri</div>
        <div id="fcm-status" style="margin-top:8px; font-size:13px; color:#6b7280;">YÃ¼kleniyor...</div>
        <div id="fcm-token-info" style="margin-top:8px; font-size:11px; color:#9ca3af; word-break:break-all; display:none;"></div>
        <button id="test-notification-btn" style="margin-top:12px; padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600; width:100%;" disabled>
          ğŸ“¤ Test Bildirimi GÃ¶nder
        </button>
      </div>
      <div class="card metric-card clickable-card" id="incoming-bids-card" onclick="location.href='./bids.html?tab=incoming'">
        <div class="card-title">Gelen Teklifler</div>
        <h2 id="metric-incoming-bids">0</h2>
      </div>
      <div class="card metric-card clickable-card" id="outgoing-bids-card" onclick="location.href='./bids.html?tab=outgoing'">
        <div class="card-title">GÃ¶nderdiÄŸim Teklifler</div>
        <h2 id="metric-outgoing-bids">0</h2>
      </div>
      <div class="card">
        <div class="card-title">TCMB KurlarÄ±</div>
        <div class="fx-row">
          <span class="fx-label">USD/TRY:</span>
          <strong class="fx-value" id="fx-usd">-</strong>
        </div>
        <div class="fx-row">
          <span class="fx-label">EUR/TRY:</span>
          <strong class="fx-value" id="fx-eur">-</strong>
        </div>
        <small id="fx-time" style="opacity:0.7;font-size:11px;color:#6b7280"></small>
      </div>
    </div>

    <!-- Recent Demands -->
    <div class="card" style="margin-top:24px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Son Taleplerim</h3>
        <div class="quick-links">
          <a href="./demand-new.html">+ Yeni Talep</a>
          <a href="./demands.html">TÃ¼m Talepler</a>
        </div>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>SATFK</th>
            <th>BaÅŸlÄ±k</th>
            <th>Kategoriler</th>
            <th>Durum</th>
            <th>Teklif SayÄ±sÄ±</th>
            <th>Tarih</th>
          </tr>
        </thead>
        <tbody id="last-demands"></tbody>
      </table>
    </div>
  </main>

  <!-- Theme Script -->
  <script type="module" src="/assets/js/theme.js" defer></script>

  <!-- FCM VAPID Key - Teklifbul Rule v1.0 -->
  <script>
    // VAPID Public Key - Firebase Console â†’ Project Settings â†’ Cloud Messaging â†’ Web Push certificates
    // Public Key: BGb_aJH4wkibTze33NjHJVTUUS8PtSIVW76QPsxi2_BNNqf3lezoE_nHjl8FgJS4G2l59LL7Cs1sLDfjRr_qAsM
    window.FCM_VAPID_KEY = 'BGb_aJH4wkibTze33NjHJVTUUS8PtSIVW76QPsxi2_BNNqf3lezoE_nHjl8FgJS4G2l59LL7Cs1sLDfjRr_qAsM';
  </script>

  <!-- Main Script -->
  <script type="module">
    // Teklifbul Rule v1.0 - Tek kaynaktan auth guard yÃ¶netimi
    import { initAuthGuard } from './assets/js/auth-guard.js';
    import { initGlobalHeader } from './assets/js/ui/header.js';
    import { db, auth, requireAuth } from "./firebase.js";
    import { initFCM, getCurrentToken } from "./assets/js/fcm.js";
    // Teklifbul Rule v1.0 - Structured Logging
    import { logger } from './src/shared/log/logger.js';
    // Teklifbul Rule v1.0 - Toast Notification System
    import { toast } from './src/shared/ui/toast.js';
    // Teklifbul Rule v1.1 - MESSAGES constants (i18n hazÄ±rlÄ±ÄŸÄ±)
    import { MESSAGES } from './src/shared/constants/messages.js';
    
    // Guard'Ä± baÅŸlat - tÃ¼m yÃ¶nlendirmeler guard Ã¼zerinden yapÄ±lacak
    initAuthGuard().catch(err => logger.error('Auth guard init failed', err));
    
    // Initialize global header
    initGlobalHeader({ mount: '#app-header', activeRoute: 'dashboard' });
    
    // FCM baÅŸlat ve UI gÃ¼ncelle
    // Teklifbul Rule v1.0 - Push notification setup
    (async () => {
      const statusEl = document.getElementById('fcm-status');
      const tokenInfoEl = document.getElementById('fcm-token-info');
      const testBtn = document.getElementById('test-notification-btn');
      
      // Teklifbul Rule v1.0 - user deÄŸiÅŸkenini geniÅŸ scope'da tut
      let currentUser = null;
      
      try {
        currentUser = await requireAuth();
        if (currentUser) {
          statusEl.textContent = 'â³ FCM baÅŸlatÄ±lÄ±yor...';
          
          const token = await initFCM();
          if (token) {
            statusEl.innerHTML = '<span style="color:#10b981;">âœ… FCM aktif</span>';
            tokenInfoEl.textContent = `Token: ${token.substring(0, 30)}...`;
            tokenInfoEl.style.display = 'block';
            testBtn.disabled = false;
            
            logger.info('FCM baÅŸarÄ±yla baÅŸlatÄ±ldÄ±');
            
            // FCM mesajlarÄ±nÄ± dinle
            window.addEventListener('fcm-message', (event) => {
              const payload = event.detail;
              logger.info('FCM mesajÄ± alÄ±ndÄ±', payload);
              
              // Toast gÃ¶ster (eÄŸer varsa)
              if (window.showToast) {
                window.showToast(
                  payload.notification?.title || payload.data?.title || 'Bildirim',
                  payload.notification?.body || payload.data?.body || 'Yeni mesaj',
                  'info'
                );
              }
            });
          } else {
            statusEl.innerHTML = '<span style="color:#ef4444;">âŒ FCM baÅŸlatÄ±lamadÄ±</span>';
            tokenInfoEl.textContent = 'Token alÄ±namadÄ±. TarayÄ±cÄ± ayarlarÄ±ndan bildirim izni verin.';
            tokenInfoEl.style.display = 'block';
          }
        }
      } catch (error) {
        logger.warn('FCM baÅŸlatÄ±lamadÄ±', error);
        statusEl.innerHTML = `<span style="color:#ef4444;">âŒ Hata: ${error.message}</span>`;
        tokenInfoEl.textContent = error.message;
        tokenInfoEl.style.display = 'block';
      }
      
      // Test bildirimi butonu
      if (testBtn) {
        testBtn.addEventListener('click', async () => {
          try {
            testBtn.disabled = true;
            testBtn.textContent = 'â³ GÃ¶nderiliyor...';
            
            const token = getCurrentToken();
            if (!token) {
              toast.error(MESSAGES.ERROR_FCM_TOKEN);
              testBtn.disabled = false;
              testBtn.textContent = 'ğŸ“¤ Test Bildirimi GÃ¶nder';
              return;
            }
            
            // Cloud Function'a test bildirimi isteÄŸi gÃ¶nder
            const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js');
            
            // Teklifbul Rule v1.0 - user deÄŸiÅŸkenini auth.currentUser'dan al
            const user = auth.currentUser || currentUser;
            if (!user) {
              toast.error(MESSAGES.ERROR_USER_NOT_AUTH);
              testBtn.disabled = false;
              testBtn.textContent = 'ğŸ“¤ Test Bildirimi GÃ¶nder';
              return;
            }
            
            // Test bildirimi iÃ§in Firestore'a kayÄ±t oluÅŸtur (Cloud Function dinleyecek)
            await addDoc(collection(db, 'notification_tests'), {
              userId: user.uid,
              token: token,
              type: 'test',
              title: 'Test Bildirimi',
              body: 'Bu bir test bildirimidir. FCM Ã§alÄ±ÅŸÄ±yor! ğŸ‰',
              createdAt: serverTimestamp(),
              status: 'pending'
            });
            
            testBtn.textContent = 'âœ… GÃ¶nderildi!';
            setTimeout(() => {
              testBtn.disabled = false;
              testBtn.textContent = 'ğŸ“¤ Test Bildirimi GÃ¶nder';
            }, 2000);
            
          } catch (error) {
            logger.error('Test bildirimi hatasÄ±', error);
            toast.error(MESSAGES.ERROR_SEND + ': ' + error.message);
            testBtn.disabled = false;
            testBtn.textContent = 'ğŸ“¤ Test Bildirimi GÃ¶nder';
          }
        });
      }
    })();
  </script>

  <!-- Dashboard Data Script -->
  <script type="module">
    import { db, requireAuth } from "./firebase.js";
    // Teklifbul Rule v1.0 - Structured Logging
    import { logger } from './src/shared/log/logger.js';
    // Teklifbul Rule v1.0 - Toast Notification System
    import { toast } from './src/shared/ui/toast.js';
    // Teklifbul Rule v1.1 - MESSAGES constants (i18n hazÄ±rlÄ±ÄŸÄ±)
    import { MESSAGES } from './src/shared/constants/messages.js';
    import {
      collection, getDocs, getDoc, query, where, orderBy, limit, doc
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    // CRITICAL: Import new ID-based category system
    import { 
      getAllCategories, 
      getNameById,
      normalizeToIds 
    } from "./src/categories/category-service.js";

    // Async IIFE - Teklifbul Rule v1.0
    (async function() {
      const dashUser = await requireAuth();
      
      // Åirket kodlu kayÄ±t durumunu kontrol et - Teklifbul Rule v1.0
      try {
        const userDoc = await getDoc(doc(db, 'users', dashUser.uid));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          if (userData.companyJoinStatus === 'pending' || userData.companyJoinStatus === 'rejected') {
            location.href = "./company-join-waiting.html";
            return; // Bu return artÄ±k async fonksiyon iÃ§inde olduÄŸu iÃ§in geÃ§erli
          }
        }
      } catch (e) {
        logger.warn('User status check failed', e);
        // Hata olsa bile devam et, normal kullanÄ±cÄ±lar iÃ§in sorun olmaz
      }
      
      const uid = dashUser.uid;

    // Durum Ã§evirisi fonksiyonu
    function translateStatus(status) {
      const statusMap = {
        'draft': 'Taslak',
        'approved': 'OnaylandÄ±',
        'published': 'YayÄ±nlandÄ±',
        'sent': 'GÃ¶nderildi',
        'pending': 'Bekleyen',
        'viewed': 'GÃ¶rÃ¼ldÃ¼',
        'responded': 'YanÄ±tlandÄ±',
        'rejected': 'Reddedildi',
        'cancelled': 'Ä°ptal Edildi',
        'completed': 'TamamlandÄ±',
        'in_progress': 'Devam Ediyor',
        'closed': 'KapatÄ±ldÄ±'
      };
      return statusMap[status] || status || 'Bilinmeyen';
    }

    // Helper: slug normalize (tr-friendly) - same as demands.html
    function toSlug(name){
      if (!name) return '';
      return String(name)
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[ÅŸÅ]/g,'s').replace(/[Ä±Ä°]/g,'i').replace(/[ÄŸÄ]/g,'g')
        .replace(/[Ã§Ã‡]/g,'c').replace(/[Ã¶Ã–]/g,'o').replace(/[Ã¼Ãœ]/g,'u')
        .toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    }

    try {
      // Get user's company ID and supplier categories (same as demands.html)
      const userDoc = await getDoc(doc(db, 'users', uid));
      const userData = userDoc.exists() ? userDoc.data() : {};
      const userCompanyId = userData.companyId;
      // CRITICAL: Get supplier categories in ID format (new system)
      // Priority: supplierCategoryIds > supplierCategoryKeys (slugs) > supplierCategories (names)
      let mySupplierCategoryTokens = [];
      if (Array.isArray(userData.supplierCategoryIds) && userData.supplierCategoryIds.length > 0) {
        mySupplierCategoryTokens = userData.supplierCategoryIds;
      } else if (Array.isArray(userData.supplierCategoryKeys) && userData.supplierCategoryKeys.length > 0) {
        mySupplierCategoryTokens = userData.supplierCategoryKeys;
      } else if (Array.isArray(userData.supplierCategories) && userData.supplierCategories.length > 0) {
        mySupplierCategoryTokens = userData.supplierCategories;
      }
      
      // Normalize all tokens to IDs
      const mySupplierCategoryIds = normalizeToIds(mySupplierCategoryTokens).slice(0, 10); // Firestore limit
      
      // Reduced logging: Only log summary
      if (mySupplierCategoryIds.length === 0) {
        logger.warn("Dashboard: No supplier categories found for user.");
      }
      
      // DEBUG queries removed for performance
      
      // Load incoming demands - same logic as demands.html
      let incomingDemands = [];
      try {
        if (mySupplierCategoryIds.length > 0) {
          // Use category filtering (same as demands.html)
          // Note: Published demands have status='published' or 'approved' and isPublished=true
          // CRITICAL: Try categoryIds first (new system), then fallback to legacy fields
          let incomingSnap;
          try {
            // Primary: Use categoryIds (new ID-based system)
            const qIncomingDemands = query(
              collection(db, "demands"),
              where("isPublished", "==", true),
              where("categoryIds", "array-contains-any", mySupplierCategoryIds),
              orderBy("createdAt", "desc"),
              limit(100)
            );
            incomingSnap = await getDocs(qIncomingDemands);
            logger.info(`Dashboard: Found ${incomingSnap.docs.length} demands with categoryIds match`);
          } catch (err) {
            // Fallback 1: Try supplierCategoryIds if categoryIds query fails
            try {
              const qIncomingDemands = query(
                collection(db, "demands"),
                where("isPublished", "==", true),
                where("supplierCategoryIds", "array-contains-any", mySupplierCategoryIds),
                orderBy("createdAt", "desc"),
                limit(100)
              );
              incomingSnap = await getDocs(qIncomingDemands);
              logger.info(`Dashboard: Found ${incomingSnap.docs.length} demands with supplierCategoryIds match`);
            } catch (err2) {
              // Fallback 2: Try legacy categoryTags (slugs) if ID queries fail
              const allCategories = getAllCategories();
              const legacySlugs = mySupplierCategoryIds.map(id => {
                const cat = allCategories.find(c => c.id === id);
                return cat ? cat.slug : null;
              }).filter(Boolean);
              
              if (legacySlugs.length > 0) {
                logger.warn("ID queries failed, trying legacy categoryTags fallback", err2.message);
                try {
                  const qIncomingDemands = query(
                    collection(db, "demands"),
                    where("isPublished", "==", true),
                    where("categoryTags", "array-contains-any", legacySlugs.slice(0, 10)),
                    orderBy("createdAt", "desc"),
                    limit(100)
                  );
                  incomingSnap = await getDocs(qIncomingDemands);
                  logger.info(`Dashboard: Found ${incomingSnap.docs.length} demands with categoryTags match (fallback)`);
                } catch (err3) {
                  logger.error("Dashboard: All category query attempts failed");
                  if (err3.code === 'failed-precondition') {
                    logger.error("Firestore index required. Please:");
                    logger.error("   1. Click the link in the error message above to create the index manually");
                    logger.error("   2. Or run: firebase deploy --only firestore:indexes");
                    logger.error("   3. Wait a few minutes for the index to build, then refresh the page.");
                  }
                  incomingSnap = { docs: [] };
                }
              } else {
                logger.error("Dashboard: All category query attempts failed - no legacy slugs available");
                incomingSnap = { docs: [] };
              }
            }
          }
          
          incomingDemands = incomingSnap.docs
            .filter(d => {
              const data = d.data();
              // Kendi ÅŸirketinin taleplerini filtrele (silent filter)
              if (data.creatorCompanyId && userCompanyId && data.creatorCompanyId === userCompanyId) {
                return false;
              }
              return true;
            })
            .map(d => ({ id: d.id, ...d.data() }));
          logger.info(`Dashboard: Found ${incomingDemands.length} incoming demands`, { filtered: incomingSnap.docs.length - incomingDemands.length });
          
          // DEBUG: If no matches, check why
          if (incomingSnap.docs.length > 0 && incomingDemands.length === 0) {
            logger.warn("WARNING: Published demands exist but none match user categories!");
            logger.info("Sample demand from query");
            const sample = incomingSnap.docs[0];
            const sampleData = sample.data();
            const demandCats = sampleData.categoryIds || sampleData.supplierCategoryIds || sampleData.categoryTags || [];
            const demandCategoryIds = normalizeToIds(demandCats);
            const matchedCats = demandCategoryIds.filter(id => mySupplierCategoryIds.includes(id));
            logger.info("Sample demand debug", {
              demandId: sample.id,
              categoryIds: sampleData.categoryIds,
              supplierCategoryIds: sampleData.supplierCategoryIds,
              categoryTags: sampleData.categoryTags,
              creatorCompanyId: sampleData.creatorCompanyId,
              userCompanyId: userCompanyId,
              isOwnCompany: sampleData.creatorCompanyId === userCompanyId,
              userCategoryIds: mySupplierCategoryIds,
              demandCategoryIds: demandCategoryIds,
              matchedCategoryIds: matchedCats,
              hasMatch: matchedCats.length > 0
            });
          }
        } else {
          // Fallback: if no supplier categories, show all published (excluding own)
          // Note: Published demands have status='published' and isPublished=true
          const qIncomingDemands = query(
            collection(db, "demands"),
            where("isPublished", "==", true),
            orderBy("createdAt", "desc"),
            limit(100)
          );
          const incomingSnap = await getDocs(qIncomingDemands);
          incomingDemands = incomingSnap.docs
            .filter(d => {
              const data = d.data();
              // Kendi ÅŸirketinin taleplerini filtrele
              if (data.creatorCompanyId && userCompanyId && data.creatorCompanyId === userCompanyId) {
                return false;
              }
              if (data.createdBy === uid) return false;
              return true;
            })
            .map(d => ({ id: d.id, ...d.data() }));
          // Silent: all published demands shown (no categories filter)
        }
      } catch (error) {
        logger.error('Error loading incoming demands', error);
        if (error.code === 'failed-precondition') {
          logger.error("Firestore index required. Please:");
          logger.error("   1. Click the link in the error message above to create the index manually");
          logger.error("   2. Or run: firebase deploy --only firestore:indexes");
          logger.error("   3. Wait a few minutes for the index to build, then refresh the page.");
        }
      }
      
      // OPTIMIZED: Load incoming bids using batch whereIn (same as bids.html)
      let incomingBids = [];
      try {
        const ds = await getDocs(query(collection(db,'demands'), where('createdBy','==', uid)));
        const demandIds = ds.docs.map(d=>d.id);
        
        if (demandIds.length > 0) {
          // Batch load bids using whereIn (10 at a time)
          for (let i = 0; i < demandIds.length; i += 10) {
            const batchIds = demandIds.slice(i, i + 10);
            try {
              const q = query(
                collection(db,'bids'), 
                where('demandId','in', batchIds),
                orderBy('createdAt','desc'),
                limit(100)
              );
              const snap = await getDocs(q);
              snap.docs.forEach(b => incomingBids.push({ id:b.id, ...b.data() }));
            } catch (e) {
              // Fallback: query individually if whereIn+orderBy fails
              logger.warn('whereIn+orderBy failed, using fallback', e);
              for (const demandId of batchIds) {
                const q = query(
                  collection(db,'bids'), 
                  where('demandId','==', demandId),
                  orderBy('createdAt','desc'),
                  limit(50)
                );
                const snap = await getDocs(q);
                snap.docs.forEach(b => incomingBids.push({ id:b.id, ...b.data() }));
              }
            }
          }
        }
      } catch (error) {
        logger.error('Error loading incoming bids', error);
      }
      
      // Load outgoing bids (bids I sent)
      const qOutgoingBids = query(
        collection(db, "bids"),
        where("supplierId", "==", uid)
      );

      // Load all user demands (for "Son Taleplerim" table) - creatorCompanyId or createdBy
      let allUserDemands = [];
      try {
        if (userCompanyId) {
          const qAllDemands = query(
            collection(db, "demands"),
            where("creatorCompanyId", "==", userCompanyId),
            orderBy("createdAt", "desc"),
            limit(100)
          );
          const allDemandsSnap = await getDocs(qAllDemands);
          allUserDemands = allDemandsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        } else {
          // Fallback: use createdBy if no companyId
          const qAllDemands = query(
            collection(db, "demands"),
            where("createdBy", "==", uid),
            orderBy("createdAt", "desc"),
            limit(100)
          );
          const allDemandsSnap = await getDocs(qAllDemands);
          allUserDemands = allDemandsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        }
      } catch (error) {
        logger.error('Error loading all user demands', error);
      }

      // Load outgoing demands - same logic as demands.html (creatorCompanyId + status published)
      let outgoingDemands = [];
      try {
        if (userCompanyId) {
          // Note: Published demands have status='approved' and isPublished=true
          const qOutgoing = query(
            collection(db, "demands"),
            where("creatorCompanyId", "==", userCompanyId),
            where("isPublished", "==", true),
            orderBy("createdAt", "desc"),
            limit(100)
          );
          const outgoingSnap = await getDocs(qOutgoing);
          outgoingDemands = outgoingSnap.docs.map(d => ({ id: d.id, ...d.data() }));
          // Silent: outgoing demands loaded
        } else {
          // Fallback: use createdBy if no companyId
          // Note: Published demands have status='published' and isPublished=true
          const qOutgoing = query(
            collection(db, "demands"),
            where("createdBy", "==", uid),
            where("isPublished", "==", true),
            orderBy("createdAt", "desc"),
            limit(100)
          );
          const outgoingSnap = await getDocs(qOutgoing);
          outgoingDemands = outgoingSnap.docs.map(d => ({ id: d.id, ...d.data() }));
          // Silent: outgoing demands loaded (createdBy fallback)
        }
      } catch (error) {
        logger.error('Error loading outgoing demands', error);
      }
      
      // Load draft demands - same logic as demands.html (creatorCompanyId + status IN ['draft', 'withdrawn'])
      let drafts = [];
      try {
        if (userCompanyId) {
          const qDrafts = query(
            collection(db, "demands"),
            where("creatorCompanyId", "==", userCompanyId),
            where("status", "in", ["draft", "withdrawn"]),
            orderBy("updatedAt", "desc"),
            limit(100)
          );
          const draftsSnap = await getDocs(qDrafts);
          drafts = draftsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
          // Silent: draft demands loaded
        } else {
          // Fallback: use createdBy if no companyId
          const qDrafts = query(
            collection(db, "demands"),
            where("createdBy", "==", uid),
            where("status", "in", ["draft", "withdrawn"]),
            orderBy("updatedAt", "desc"),
            limit(100)
          );
          const draftsSnap = await getDocs(qDrafts);
          drafts = draftsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
          // Silent: draft demands loaded (createdBy fallback)
        }
      } catch (error) {
        logger.error('Error loading draft demands', error);
      }

      const [outgoingBidsSnap] = await Promise.all([
        getDocs(qOutgoingBids)
      ]);

      const outgoingBids = outgoingBidsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      // Use allUserDemands for "Son Taleplerim" table
      const sent = allUserDemands;

      // Update metrics - use outgoingDemands instead of sent for consistency
      document.getElementById("metric-inbox").textContent = String(incomingDemands.length);
      document.getElementById("metric-sent").textContent = String(outgoingDemands.length);
      document.getElementById("metric-draft").textContent = String(drafts.length);
      document.getElementById("metric-incoming-bids").textContent = String(incomingBids.length);
      document.getElementById("metric-outgoing-bids").textContent = String(outgoingBids.length);

      // Sort and display last 5 demands
      sent.sort((a, b) => {
        const aTime = a.createdAt?.toMillis?.() || 0;
        const bTime = b.createdAt?.toMillis?.() || 0;
        return bTime - aTime;
      });

      const lastBody = document.getElementById("last-demands");
      lastBody.innerHTML = "";
      
      const last5 = sent.slice(0, 5);
      if (last5.length === 0) {
        lastBody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#6b7280;padding:20px">HenÃ¼z talep yok</td></tr>';
      } else {
        // OPTIMIZED: Batch load bid counts for all 5 demands at once
        const demandIdsForBidCount = last5.map(x => x.id);
        const bidCountsMap = new Map();
        
        if (demandIdsForBidCount.length > 0) {
          try {
            // Batch query with whereIn (10 max, but we have max 5)
            const bidQuery = query(
              collection(db, 'bids'), 
              where('demandId', 'in', demandIdsForBidCount)
            );
            const bidSnap = await getDocs(bidQuery);
            
            // Count bids per demand
            bidSnap.docs.forEach(b => {
              const demandId = b.data().demandId;
              bidCountsMap.set(demandId, (bidCountsMap.get(demandId) || 0) + 1);
            });
          } catch (error) {
            logger.warn('Batch bid count error', error);
          }
        }
        
        // Render rows with cached bid counts
        for (const x of last5) {
          const bidCount = bidCountsMap.get(x.id) || 0;
          
          const cats = [
            ...(Array.isArray(x.categoryTags) ? x.categoryTags : []),
            ...(x.customCategory ? [x.customCategory] : [])
          ];
          const catDisplay = cats.length > 0
            ? cats.slice(0, 3).join(", ") + (cats.length > 3 ? ` +${cats.length - 3}` : "")
            : "-";
          
          const statusText = translateStatus(x.status || (x.isPublished ? 'published' : 'draft'));
          const statusBadge = x.isPublished 
            ? `<span class="badge success">${statusText}</span>` 
            : `<span class="badge warn">${statusText}</span>`;
          
          const bidDisplay = bidCount > 0 
            ? `<span class="badge success">${bidCount} teklif</span>`
            : '<span style="color:#6b7280">HenÃ¼z teklif yok</span>';
          
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${x.satfk || "-"}</td>
            <td><a href="./demand-detail.html?id=${x.id}" style="color:#3b82f6;text-decoration:none">${x.title || "-"}</a></td>
            <td>${catDisplay}</td>
            <td>${statusBadge}</td>
            <td>${bidDisplay}</td>
            <td>${x.createdAt?.toDate?.()?.toLocaleDateString?.("tr-TR") || "-"}</td>
          `;
          lastBody.appendChild(tr);
        }
      }
    } catch (e) {
      logger.error("Dashboard data load error", e);
      // Show detailed error information to help diagnose the issue
      const errorMessage = `
        <div style="text-align: center; padding: 40px; color: #6b7280; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; margin: 20px;">
          <h3>Dashboard verileri yÃ¼klenemedi</h3>
          <p>Hata detayÄ±: ${e.message || e}</p>
          <p>LÃ¼tfen aÅŸaÄŸÄ±daki kontrol listesini inceleyin:</p>
          <ul style="text-align: left; max-width: 500px; margin: 20px auto;">
            <li>Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin</li>
            <li>Firebase authentication'Ä±n doÄŸru Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olun</li>
            <li>Åirket bilgilerinizin doÄŸru ayarlandÄ±ÄŸÄ±ndan emin olun</li>
            <li>TedarikÃ§i kategorilerinizin seÃ§ili olduÄŸundan emin olun</li>
            <li>Ayarlar sayfasÄ±ndan profil bilgilerinizi kontrol edin</li>
          </ul>
          <p style="font-size: 14px; margin-top: 20px;">
            <a href="./settings.html" style="color: #3b82f6;">Ayarlar</a> | 
            <a href="./demands.html" style="color: #3b82f6;">Talepler</a> | 
            <a href="./bids.html" style="color: #3b82f6;">Teklifler</a>
          </p>
        </div>
      `;
      
      // Try to insert the error message in a visible place
      const mainContent = document.querySelector("main");
      if (mainContent) {
        const errorDiv = document.createElement("div");
        errorDiv.innerHTML = errorMessage;
        mainContent.insertBefore(errorDiv, mainContent.firstChild);
      }
      
      if (e.message && e.message.includes("Missing or insufficient permissions")) {
        logger.warn("Permission denied for dashboard data - Firestore rules may need updating");
      }
    }
    
    // Async IIFE kapatma - Teklifbul Rule v1.0
    })();
  </script>

  <!-- TCMB FX Widget -->
  <script type="module">
    // Using a public FX API since /fx endpoint is not working
    const FX_URL = "https://api.exchangerate-api.com/v4/latest/TRY";

    async function loadFx() {
      try {
        const r = await fetch(FX_URL);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        
        const data = await r.json();
        
        // Convert to expected format (USD and EUR rates against TRY)
        const usdRate = (1 / data.rates.USD).toFixed(4);
        const eurRate = (1 / data.rates.EUR).toFixed(4);
        const asOf = new Date().toLocaleDateString("tr-TR");
        
        document.getElementById("fx-usd").textContent = usdRate;
        document.getElementById("fx-eur").textContent = eurRate;
        document.getElementById("fx-time").textContent = `Tarih: ${asOf}`;
      } catch (e) {
        logger.error("FX load error", e);
        document.getElementById("fx-usd").textContent = "-";
        document.getElementById("fx-eur").textContent = "-";
        document.getElementById("fx-time").textContent = "Kur bilgisi yÃ¼klenemedi";
      }
    }
    
    loadFx();
    setInterval(loadFx, 60000); // Refresh every minute
  </script>

</body>
</html>